\documentclass{article}
\usepackage{amsthm,hyperref,mathtools,mathpartir,cleveref,mathrsfs,amssymb,url,paralist,xspace,braket,ifmtarg}
\usepackage[status=draft]{fixme}
\newtheorem{thm}{Theorem}[section]
\crefname{thm}{Theorem}{Theorems}
\newtheorem{lem}[thm]{Lemma}
\crefname{lem}{Lemma}{Lemmas}
\newtheorem{cor}[thm]{Corollary}
\crefname{cor}{Corollary}{Corollaries}
\newtheorem{conj}[thm]{Corollary}
\crefname{conj}{Conjecture}{Conjectures}
\theoremstyle{definition}
\newtheorem{defn}[thm]{Definition}
\crefname{defn}{Definition}{Definitions}
\newtheorem{defns}[thm]{Definitions}
\crefname{defns}{Definitions}{Definitions}
\newtheorem{eg}[thm]{Example}
\crefname{eg}{Example}{Examples}
\theoremstyle{remark}
\newtheorem{rmk}[thm]{Remark}
\crefname{rmk}{Remark}{Remarks}
\usepackage{tikz}
\usepackage{tikz-cd}
\usetikzlibrary{decorations.markings}
\tikzset{edge/.style={decoration={markings,mark=at position 0.5 with {\arrow{>}}},postaction={decorate}}}
\tikzset{vertex/.style={circle,draw,inner sep=1pt}}
\usetikzlibrary{shapes.geometric}
\tikzset{outer/.style={regular polygon,regular polygon sides=3,inner sep=1pt,draw,shape border rotate=180}}
\tikzset{houter/.style={regular polygon,regular polygon sides=3,inner sep=1pt,draw,shape border rotate=270}}
\tikzset{cross/.style={white,line width=3pt}}
\let\sto\looparrowright
\def\M{\mathcal{M}}
\def\A{\mathcal{A}}
\def\B{\mathcal{B}}
\def\C{\mathcal{C}}
\def\P{\mathcal{P}}
\def\Q{\mathcal{Q}}
\def\D{\mathcal{D}}
\def\G{\mathcal{G}}
\def\H{\mathcal{H}}
\def\K{\mathcal{K}}
\def\L{\mathcal{L}}
\def\R{\mathcal{R}}
\let\setof\Set
\def\Set{\mathbf{Set}}
\def\Cat{\ensuremath{\mathcal{C}\mathit{at}}}
%\def\Cat{\ensuremath{\mathbf{Cat}}}
\def\Fib{\mathcal{F}\mathit{ib}}
\def\SFib{\mathcal{SF}\mathit{ib}}
\def\Prof{\mathcal{P}\mathit{rof}}
\def\cpg{\ensuremath{\mathcal{CPG}}\xspace}
\def\dom{\mathrm{dom}}
\def\cod{\mathrm{cod}}
\def\id{\mathrm{id}}
\def\Id{\mathrm{Id}}
\def\side#1{{\scriptstyle(#1)}}
\def\sid{\side{\id}}
% \def\twocell#1#2#3#4{\inferrule*[Left={$\side{#1}$},Right={$\side{#4}$}]{#2}{#3}}
% \def\twocelll#1#2#3#4{\inferrule*[left={$\side{#1}$},Right={$\side{#4}$}]{#2}{#3}}
% \def\twocellr#1#2#3#4{\inferrule*[Left={$\side{#1}$},right={$\side{#4}$}]{#2}{#3}}
% \def\twocelllr#1#2#3#4{\inferrule*[left={$\side{#1}$},right={$\side{#4}$}]{#2}{#3}}

\def\op{^{\mathrm{op}}}
\def\lan{\operatorname{Lan}}

\newcounter{nodemaker}
\setcounter{nodemaker}{0}
\newcommand{\twocell}[2][]{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#2,phantom,shift left=3,""{name=\mynodeone}]%
  \ar[#2,phantom,shift right=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,from=\mynodeone,to=\mynodetwo,"{#1}"]%
}
\newcommand{\twocellop}[2][]{%
  \global\edef\mynodeone{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \global\edef\mynodetwo{twocell\arabic{nodemaker}}%
  \stepcounter{nodemaker}%
  \ar[#2,phantom,shift left=3,""{name=\mynodeone}]%
  \ar[#2,phantom,shift right=3,""'{name=\mynodetwo}]%
  \ar[Rightarrow,from=\mynodetwo,to=\mynodeone,"{#1}"]%
}
\newcommand{\drpullback}[1][dr]{\ar[#1,phantom,near start,"\lrcorner"]}
\newcommand{\dlpullback}[1][dl]{\ar[#1,phantom,near start,"\llcorner"]}
\newcommand{\urpullback}[1][ur]{\ar[#1,phantom,near start,"\urcorner"]}
\newcommand{\ulpullback}[1][ul]{\ar[#1,phantom,near start,"\ulcorner"]}

\let\ot\leftarrow
\let\xto\xrightarrow
\let\xot\xleftarrow
\let\tot\leftrightarrow
\def\o{^{\circ}}
\tikzset{horiz/.style={"\mathclap\bullet" description}}
\def\genus{\mathsf{genus}}
\def\degree{\mathsf{degree}}
\def\rank{\mathsf{rank}}
\def\N{\mathbb{N}}
\def\Np{\N_{\bullet}}
% \def\hy{\mathcal{H}\mathit{y}\mathcal{G}\mathit{ph}}
\def\hyrel{\mathcal{H}\mathit{y}\mathcal{R}\mathit{el}}
\def\hy{\mathbf{HyGph}}
\def\RGph{\mathbf{RGph}}
\def\GCtx{\mathbf{GCtx}}
\def\hohy{\mathbf{HyGph}}
\def\thy{\mathcal{T}}
\def\dhy{\mathcal{D}}
\def\fhy{\mathcal{F}}
\def\ehy{\mathcal{E}\mathit{xt}\mathcal{H}\mathit{y}\mathcal{G}\mathit{ph}}

% Get new symbols from mathabx without changing the old ones
\DeclareFontFamily{U}{mathb}{\hyphenchar\font45}
\DeclareFontShape{U}{mathb}{m}{n}{
      <5> <6> <7> <8> <9> <10> gen * mathb
      <10.95> mathb10 <12> <14.4> <17.28> <20.74> <24.88> mathb12
      }{}
\DeclareSymbolFont{mathb}{U}{mathb}{m}{n}
\DeclareFontSubstitution{U}{mathb}{m}{n}
\DeclareMathSymbol{\Asterisk}{2}{mathb}{"06}

\makeatletter
%\def\ins#1#2#3#4{#1 \underset{\@ifmtarg{#2}{#3}{#3\in #2}}{\circ} #4}
\def\ins#1#2#3#4{#1 \mathbin{{\Asterisk}_{\@ifmtarg{#2}{#3}{#3\in #2}}} #4}
\def\insy{\Asterisk}
\def\coll{\mathbin{\Asterisk}}
\makeatother
\def\bE{\mathbf{E}}
\def\bC{\ensuremath{\mathbf{C}}\xspace}
\def\bS{\ensuremath{\mathbf{S}}\xspace}
\def\Ebar{\overline{\mathbf{E}}}
\def\Gbar{\overline{\mathcal{G}}}
\def\Cbar{\overline{\mathcal{C}}}
\def\Hbar{\overline{\mathcal{H}}}
\def\Kbar{\overline{\mathcal{K}}}
\def\Lbar{\overline{\mathcal{L}}}
\def\dhybar{\overline{\mathcal{D}}}

\def\ec{\diamond}
\def\edgectx{\;\mathsf{edgectx}}
\def\loopctx{\;\mathsf{loopctx}}
\def\vertex{\;\mathsf{vertex}}
\def\ctx{\;\mathsf{ctx}}
\def\graph{\;\mathsf{graph}}
\def\type{\;\mathsf{type}}
\let\types\vdash
\let\jdeq\equiv
\let\sametypes\approx
\def\varsof#1{|#1|}

\hyphenation{hyper-graph}
\hyphenation{hyper-graphs}

\title{Hypercategories and some kind of type theory}
\author{Dan Licata \and\ Mitchell Riley \and\ Patrick Schultz \and\ Michael Shulman}
\begin{document}
\maketitle

\section{Hypergraphs}
\label{sec:hypergraphs}

Intuitively, a hypergraph is like a graph, but where an ``edge'' can be incident to any number of vertices, not only two.
An incidence between a vertex and an edge is called a \emph{flag}.
For directed hypergraphs, which we will mainly be concerned with, each flag is marked as ``incoming'' or ``outgoing'' (to the associated vertex).
When drawing a hypergraph, we draw vertices as dots and edges as lines connecting them, which are allowed to ``branch'' in order to connect more than two vertices.
Here is an example:
\[
\begin{tikzpicture}
  \node[vertex] (f) at (0,1) {$f$};
  \node[vertex] (g) at (0,-1) {$g$};
  \node[vertex] (h) at (2,0) {$h$};
  \coordinate (e) at (1,0);
  \draw[edge] (f) to[out=0,in=180] (e);
  \draw[edge] (g) to[out=30,in=180] (e);
  \draw[edge] (e) to[out=0,in=180] node[auto] {$e_1$} (h);
  \coordinate (e2) at (1,2);
  \draw[edge] (h) to[out=30,in=0] node[auto,swap] {$e_2$} (e2);
  \draw[edge] (e2) to[out=180,in=180,looseness=2] (g);
  \coordinate (e3) at (3,-1);
  \draw[edge] (h) to[out=-30,in=180] (e3);
  \draw[edge] (g) to[out=-30,in=180] node[auto,swap] {$e_3$} (e3);
  \draw[edge] (h) -- node[auto,very near end] {$e_4$} +(1,0);
  \draw[edge] (f) to[out=-60,in=-120,looseness=5] node[auto] {$e_5$} (f);
  \draw (-1,-.5) -- node[auto] {$e_6$} (0,-.5);
\end{tikzpicture}
\]
Here $e_1$ is incident to $f$ and $g$ outgoing and to $h$ incoming, $e_2$ is adjacent to $h$ outgoing and $g$ incoming, $e_3$ is adjacent to $g$ and $h$ both outgoing, $e_4$ is adjacent to only $h$ outgoing, $e_5$ is adjacent to $f$ once outgoing and once incoming, and $e_6$ is not adjacent to any vertices at all.

There are many possible variations on hypergraphs.
Unlike in the combinatorial literature, but like the ``graphs'' usually used in category theory, our edges are not uniquely determined by the vertices they are incident to, i.e.\ we can have ``parallel edges''.
Also, we will assume that each vertex is incident to a finite set of edges, but in general place no such restriction on the edges; this will be convenient because it makes polygraphs a special case of directed hypergraphs.

We will also allow edges to contain ``loops''.
In particular, this distinguishes between the following two edges, neither of which is adjacent to any vertices, but of which one contains a loop and one does not:
\[
\begin{tikzpicture}
  \draw (0,0) -- (1,0);
  \draw (3,0) to[out=90,in=90,looseness=2] (4,0) to[out=-90,in=-90,looseness=2] (3,0);
\end{tikzpicture}
\]
Moreover, the hyper-ness of our graphs means that once we allow loops, we need to allow edges adjacent to vertices to also contain loops, and some edges to contain multiple loops.
The presence of loops turns out to make the definition of hypergraph very tricky to get right, in particular as regards the notion of morphism between such graphs.

First I tried just marking each edge with a natural number ``genus''; but in defining labeled hypergraphs as morphisms we need to be able to collapse loops, and automorphisms of hypergraphs need to be able to permute loops.
Then I thought of just assigning to each edge a pointed set of ``loops'', but when inserting one hypergraph into another we can create ``loops'' of a sort for which there is no obvious way to choose a ``basepoint'' to get an actual ``set of loops''; what arises naturally is a directed graph, or equivalently a free groupoid.
So I tried defining a hypergraph to have a (free) groupoid of edges rather than a set; but free groupoids have too many automorphisms.
At present the most promising approach seems to be to define a hypergraph to have a reflexive directed graph of edges, although the treatment of isomorphisms is still not completely satisfactory.

\begin{defn}
  A \textbf{hypergraph} $\G$ is a span
  \[ V \ot F \to E \]
  in which $V$ and $F$ are sets, each fiber of the map $F\to V$ is finite, and $E$ is a reflexive directed graph (with $F$ mapping into its vertices).

  The vertices of $E$ are called \textbf{edge representatives} of $\G$, the edges of $E$ are called \textbf{edge identifications} of $\G$, and the connected components of $E$ are called the \textbf{edges} of $\G$.
  The elements of $V$ are called the \textbf{vertices} of $\G$, and those of $F$ are called its \textbf{flags}.
  If a vertex and an edge (representative) are the image of a common flag, we say they are \textbf{incident}; thus the flags are the ``witnesses of incidence''.
  We also speak of a flag as being \textbf{incident} to its associated edge (representative) and vertex.
\end{defn}

We allow vertices that are not incident to any edges, and edges that are not incident to any vertices.
Also a vertex and an edge can be ``incident more than once'', i.e.\ the image of more than one common flag.

We write $\pi E$ for the set of edges, i.e.\ the set of connected components of $E$.

\begin{defn}
  Let $\G=(V\ot F\to E)$ be a hypergraph.
  \begin{itemize}
  \item The \textbf{degree} of a vertex in $\G$ is the cardinality of the set of flags adjacent to it, which is a natural number.
    The \textbf{rank} of an edge in $\G$ is the cardinality of the set of flags adjacent to it, which in general can be finite or infinite.
    We say $\G$ %has \textbf{finite rank} if all its ranks are finite, and $\G$
    is \textbf{finite} if $V$ and $E$ (hence also $F$) are finite.
  \item The free rank of the fundamental group of an edge (meaning that of its geometric realization, considered as a 1-truncated simplicial set, or equivalently of the free groupoid that it generates) is called its \textbf{genus}.
    We say $\G$ has \textbf{genus zero} if all of its edges have genus zero, i.e.\ $E$ is a forest.
  \item The \textbf{connected components} of $\G$ are the connected components of the groupoid pushout of the span $V \leftarrow F \to \pi E$.
    We say $\G$ is \textbf{connected} if it has exactly one connected component.
    % In particular, vertices not incident to any edges, and edges not incident to any vertices, lie in their own connected components.
  \item We say $\G$ is \textbf{simple} if no edge is incident to any vertex more than once, so that the span $V \ot F \to \pi E$ is a relation.
  \item We say $\G$ is \textbf{reduced} if every edge has exactly one representative.
  \end{itemize}
\end{defn}

The (directed) hypergraphs of~\cite{glpn:directed-hypergraphs} are our (directed) finite simple reduced hypergraphs of genus zero.

\begin{defn}
  A \textbf{morphism of hypergraphs} is a diagram
  \[
  \begin{tikzcd}
    V' \ar[d] & F' \ar[d] \ar[r] \ar[l] \dlpullback[dl] & E' \ar[d]\\
    V  & F \ar[r] \ar[l] & E
  \end{tikzcd}
  \]
  in which the left-hand square is a pullback.
  This defines the category $\hy$.
\end{defn}

The fact that the left-hand square is a pullback means in particular that a morphism of hypergraphs preserves the degree of vertices.
However, it does not preserve the rank or the genus of edges.

Usually we will want to assume that the flags incident to each vertex are ordered so that we can distinguish them.
Let $\thy$ be the hypergraph with exactly one edge representative of genus zero, and for each natural number $n$ exactly one vertex incident to $n$ flags (each in turn incident to the unique edge representative).
We fix a labeling of these $n$ flags $0,1,\dots,n-1$, so that they are ordered.

\begin{defn}
  The category of \textbf{ordered hypergraphs} is the slice category $\hy/\thy$.
\end{defn}

A hypergraph morphism $\G\to\thy$ is uniquely determined on edges and vertices, so it consists only of the data of an ordering on the flags adjacent to each vertex.
Of course, such a morphism always exists, i.e.\ any hypergraph can be ordered; the point is that morphisms in $\hy/\thy$ must preserve the specified orderings.

Ordered hypergraphs have another convenient description.
Let $\Np$ be the set $\setof{(k,n) \in \N\times \N | k<n}$, with $\ell:\Np\to \N$ the second projection.
Thus the fiber of $\ell$ over $n\in\N$ is the canonical $n$-element linear order, and we can write $\thy = (\N \ot \Np \to 1)$.

Let $P_\ell$ be the polynomial endofunctor of $\Set$ defined by $\ell$, i.e.\ the composite
\[ \Set \xto{(\Np)^*} \Set/\Np \xto{\Pi_\ell} \Set/\N \xto{\Sigma_\N} \Set.\]
Thus an element of $P_\ell(E)$ is a finite list of elements of $E$.

Let $\RGph$ denote the category of reflexive directed graphs, with $U:\RGph\to\Set$ the functor taking the underlying set of vertices.

\begin{lem}
  The category $\hy/\thy$ of ordered hypergraphs is equivalent to the comma category
  \[
  \begin{tikzcd}
    \hy \ar[rr] \ar[d] \twocell{drr} && \Set \ar[d,equals] \\
    \RGph \ar[r,"U"'] & \Set \ar[r,"P_\ell"'] & \Set.
  \end{tikzcd}
  \]
\end{lem}
\begin{proof}
  An object of the comma category consists of a reflexive graph $E$ together with a set $V$ and a map $V \to P_\ell U E$.
  By definition of $P_\ell$, the latter map is equivalent to a map $f:V\to \N$ together with a map $f^*\Np \to UE$.
  This is exactly the data of a hypergraph $V \ot f^*\Np \to E$ equipped with a hypergraph map to $\thy = (\N \ot\Np \to 1)$.
\end{proof}

\begin{cor}
  $\hy/\thy$ is a presheaf topos.
  In particular, it is complete and cocomplete.
\end{cor}
\begin{proof}
  The functor $P_\ell \circ U : \RGph \to \Set$ is a parametric right adjoint, since $P_\ell$ is a polynomial functor and $U$ is a right adjoint.
  Thus, since $\RGph$ is a presheaf topos, by~\cite{cj:clfrag} $\hy/\thy$ is again a presheaf topos.
\end{proof}

Sometimes we want a further refinement of ordered hypergraphs to \emph{directed} ones.
Let $\dhy$ denote the hypergraph with $E=1$ and $V=\N\times \N$, with the vertex $(n,m)$ having $n+m$ flags, which we think of as partitioned into $n$ ordered elements and $m$ ordered elements.

\begin{defn}
  The category of \textbf{directed hypergraphs} is the slice category $\hy/\dhy$.
\end{defn}

Thus, a directed hypergraph is a hypergraph in which at each vertex the list of adjacent flags is partitioned into two linear orders, which we call the \textbf{incoming} and \textbf{outgoing} flags respectively.
The numbers of incoming and outgoing flags are respectively called the \textbf{in-degree} and \textbf{out-degree} of the vertex.
Similarly, the \textbf{in-rank} and \textbf{out-rank} of an edge are respectively the cardinalities of the sets of outgoing (from their vertices, hence incoming to the edge) and incoming (to their vertices, hence outgoing from the edge) flags adjacent to it.

There is an obvious projection $\dhy\to\thy$ sending $(n,m)$ to $n+m$, with the incoming flags ordered before the outgoing ones.
Moreover, this has a section $\thy\to\dhy$ that sends the vertex $n$ to $(0,n)$.
Thus, we have
\[\hy/\dhy \simeq (\hy/\thy)/(\dhy\to\thy) \]
\[\hy/\thy \simeq (\hy/\dhy)/(\thy\to\dhy).\]
In other words, ordered and directed hypergraphs are each special cases of each other.
This is one advantage of hypergraphs over ordinary graphs.
Another is the ease of the following definitions.

\begin{defn}
  An ordered reduced hypergraph of genus zero is called a \textbf{cycligraph}.
  A directed cycligraph is called a \textbf{polygraph}.
  A polygraph in which each vertex has out-degree equal to 1 is a \textbf{multigraph}.

  In all of these cases, the edges are called \textbf{objects} and the vertices are called \textbf{morphisms}.
\end{defn}

A polygraph is the underlying data of a polycategory or a (colored) prop: each morphism has a finite list of ``source'' objects and a finite list of ``target'' objects.
Similarly, a multigraph is the underlying data of a multicategory: each morphism has a finite list of source objects and a single target object.
And a cycligraph is the underlying data of a cyclic multicategory, in which sources and targets are not distinguished; we speak instead of the \textbf{legs} of a morphism.

Our graph-theoretic representation of these objects invokes the Poincar\'e dual ``string diagram convention'', in which objects are 1-dimensional and morphisms are 0-dimensional.
The categories of cycligraphs, polygraphs, and multigraphs are presheaf toposes.
Also, cycligraphs are a reflective subcategory of $\hy/\thy$, and polygraphs are a reflective subcategory of $\hy/\dhy$.
We write $\pi \G$ for the cycligraph reflection of an ordered hypergraph $\G$, which has the same vertices and edges as $\G$ but its edge graph is the discrete set $\pi E$ of connected components of the edge graph $E$ of $\G$.

The above definitions of cycligraphs, polygraphs, and multigraphs make the following definitions very easy.

\begin{defn}\label{thm:labeled}
  If $P$ is a cycligraph, then a \textbf{$P$-labeled hypergraph} is a hypergraph $\G$ equipped with a hypergraph morphism $\G\to P$.
\end{defn}

Since a cycligraph is ordered, if $\G\to P$ is a $P$ labeled hypergraph then $\G$ automatically inherits an ordering.
On the other hand, if $\G$ is given as an ordered hypergraph, then to give a map $\G\to P$ is equivalently to give a map of cycligraphs $\pi \G \to P$.
Similar remarks apply to directed hypergraphs and polygraphs.

Other conditions on hypergraphs are not as naturally expressed categorically.
For instance:

\begin{defn}
  A hypergraph is \textbf{rooted} if it is equipped with a specified vertex called the \textbf{root}.
\end{defn}

In general, we think of the root as ``not really there'' and the flags adjacent to it as ``free''.
In a directed rooted hypergraph, we think of the incoming or outgoing edges of the root as ``incoming/outgoing to the entire graph''.
For instance, given the graph on the left with $\ast$ the root:
\begin{equation}
  \begin{tikzpicture}
    \node[vertex] (r) at (0,0) {$\ast$};
    \node[vertex] (f) at (2,1) {$f$};
    \node[vertex] (g) at (1,-1) {$g$};
    \node[vertex] (h) at (3,-1) {$h$};
    \draw[edge] (1,2) to[out=-90,in=90] (f);
    \draw[edge] (1,2) to[out=-90,in=90] node[auto,swap] {$e_1$} (r);
    \draw[edge] (r) to[out=-90,in=90] (3,-3);
    \draw[edge] (h) to[out=-90,in=90] node[auto] {$e_5$} (3,-3);
    \draw[cross] (g) to[out=-90,in=90] (1,-3);
    \draw[edge] (g) to[out=-90,in=90] (1,-3);
    \draw[edge] (r) to[out=-90,in=90] node[auto,swap] {$e_4$} (1,-3);
    \draw[edge] (f) to[out=-90,in=90] node[auto,swap] {$e_2$} (g);
    \draw[edge] (f) to[out=-90,in=90] node[auto] {$e_3$} (h);
  \end{tikzpicture}
  \qquad
  \begin{tikzpicture}
    \node[outer] (e1) at (2,2) {};
    \node[vertex] (f) at (2,1) {$f$};
    \node[vertex] (g) at (1,-1) {$g$};
    \node[vertex] (h) at (3,-1) {$h$};
    \node[outer] (e4) at (1,-3) {};
    \node[outer] (e5) at (3,-3) {};
    \draw[edge] (e1) to[out=-90,in=90] node[auto,swap] {$e_1$} (f);
    \draw[edge] (h) to[out=-90,in=90] node[auto] {$e_5$} (e5);
    \draw[edge] (g) to[out=-90,in=90] node[auto,swap] {$e_4$} (e4);
    \draw[edge] (f) to[out=-90,in=90] node[auto,swap] {$e_2$} (g);
    \draw[edge] (f) to[out=-90,in=90] node[auto] {$e_3$} (h);
  \end{tikzpicture}\label{eq:rooted-graph}
\end{equation}
we think of the edge $e_1$ as ``incoming to the graph'' and the edges $e_4,e_5$ as ``outgoing from the graph'', as drawn above on the right.

Note that an edge like $e_1$ that is ``incoming to the graph'' is \emph{incoming} to the root (as well as to other vertices like $f$), and one like $e_4$ or $e_5$ that is ``outgoing from the graph'' is \emph{outgoing} from the root (as well as from other vertices such as $g$ or $h$).
This choice, which as we will see makes the definition of insertion somewhat simpler, is only possible when using \emph{hyper}graphs, where edges can be incoming to multiple vertices and outgoing from multiple vertices.

% \begin{defn}\label{defn:loop}
%   A \textbf{loop} in a directed hypergraph is a sequence of flags
%   \[(f_0,g_0,f_1,g_1,\dots,f_n,g_n),\]
%   for $n\ge 0$, such that
%   \begin{enumerate}
%   \item Each $f_i,g_i$ are incident on the same edge, and
%   \item Each $g_i,f_{i+1}$ (including $g_n,f_0$ by mod-$n$ arithmetic) are incident on the same vertex, with $g_i$ incoming and $f_{i+1}$ outgoing.
%   \end{enumerate}
%   In particular, a loop with $n=0$ is an edge that is both incoming and outgoing to the same vertex.
%   A directed hypergraph is \textbf{loop-free} if it contains no loops.
% \end{defn}

% The left-hand rooted graph in~\eqref{eq:rooted-graph} is loop-free, which makes sense when considering the right-hand ``graph with free flags'' that it represents.
% If we chose to represent edges ``incoming to the graph'' by edges \emph{outgoing} to the root, then we would have to represent the right-hand ``graph with free flags'' in~\eqref{eq:rooted-graph} by the following rooted graph:
% \begin{equation}
%     \begin{tikzpicture}
%     \node[vertex] (r) at (0,0) {$\ast$};
%     \node[vertex] (f) at (2,1) {$f$};
%     \node[vertex] (g) at (1,-1) {$g$};
%     \node[vertex] (h) at (3,-1) {$h$};
%     \draw[edge] (r) to[out=90,in=90] node[auto] {$e_1$} (f);
%     \draw[edge] (h) to[out=-90,in=-90,looseness=2] node[auto] {$e_5$} (r);
%     \draw[edge] (g) to[out=-90,in=-90] node[auto,very near start] {$e_4$} (r);
%     \draw[edge] (f) to[out=-90,in=90] node[auto,swap] {$e_2$} (g);
%     \draw[edge] (f) to[out=-90,in=90] node[auto] {$e_3$} (h);
%   \end{tikzpicture}\label{eq:loop}
% \end{equation}
% which is not loop-free according to \cref{defn:loop} as written; thus we would have had to special-case the root vertex in \cref{defn:loop}.
% In fact, we regard~\eqref{eq:loop} as representing the following ``graph with free flags'':
% \begin{equation}
%   \begin{tikzpicture}
%     \node[vertex] (f) at (2,1) {$f$};
%     \node[vertex] (g) at (1,-1) {$g$};
%     \node[vertex] (h) at (3,-1) {$h$};
%     \draw[edge] (1,2) to[out=-90,in=90] (f);
%     \draw[edge] (1,2) to[out=-90,in=90] node[auto,swap,near end] {$e_1$} (-1,-4);
%     \draw[edge] (5,3) to[out=-90,in=90] node[auto] {$e_5$} (3,-3);
%     \draw[edge] (h) to[out=-90,in=90] (3,-3);
%     \draw[edge] (g) to[out=-90,in=90] (1,-3);
%     \draw[cross] (-1,3) to[out=-90,in=90] (1,-3);
%     \draw[edge] (-1,3) to[out=-90,in=90] node[auto,swap,near start] {$e_4$} (1,-3);
%     \draw[edge] (f) to[out=-90,in=90] node[auto,swap] {$e_2$} (g);
%     \draw[edge] (f) to[out=-90,in=90] node[auto] {$e_3$} (h);
%   \end{tikzpicture}\label{eq:loops2}
% \end{equation}
% in which $e_4$ and $e_5$ are ``incoming to the graph'' and $e_1$ is ``outgoing from the graph''.
% We do want to consider~\eqref{eq:loops2} as containing ``loops'', because there are paths from ``in'' to ``out'' that travel some paths ``backwards''.\fxnote{Is that right?}

Note also that we allow edges that are not adjacent to any vertices, or that are adjacent to only one vertex, but are \emph{not} adjacent to the root and hence not ``incoming'' or ``outgoing'' to the graph.
The following example shows a number of distinct degenerate possibilities in a directed (reduced) hypergraph (where $\ast$ is the root):
\begin{center}
  \begin{tikzpicture}
    \node[vertex] (r) at (0,0) {$\ast$};
    \draw[edge] (r) to[out=-120,in=-90] +(-1,0) to[out=90,in=120] node[auto] {$e_1$} (r);
    \draw[edge] (1,1) to[out=-120,in=30] node[auto] {$e_2$} (r);
    \draw[edge] (r) to[out=-30,in=120] node[auto] {$e_3$} (1,-1);
    \node[vertex] (h) at (1,2) {$h$};
    \draw[edge] (h) to[out=-90,in=60] node[auto,swap,near start] {$e_6$} (r);
    \node[vertex] (k) at (1,-2) {$k$};
    \draw[edge] (r) to[out=-60,in=90] node[auto,swap,near end] {$e_7$} (k);
    \node[vertex] (m) at (0,2) {$m$};
    \draw[edge] (-1,1.5) to[out=0,in=-120] node[auto,near start] {$e_4$} (m);
    \draw[edge] (-1,1.5) to[out=0,in=90] (r);
    \node[vertex] (n) at (0,-2) {$n$};
    \draw[edge] (n) to[out=120,in=0] node[auto,swap,near start] {$e_5$} (-1,-1.5);
    \draw[edge] (r) to[out=-90,in=0] (-1,-1.5);
    \node[vertex] (f) at (2,0) {$f$};
    \draw[edge] (2,1) -- node[auto] {$e_8$} (f);
    \node[vertex] (g) at (3,0) {$g$};
    \draw[edge] (g) -- node[auto] {$e_9$} +(0,-1);
    \node[vertex] (l) at (4,0) {$l$};
    \draw (5,1) -- node[auto,near end] {$e_{10}$} (5,-1);
    \draw (6.5,0) to[out=90,in=90,looseness=1.5] node[auto,swap] {$e_{11}$} (6,0) to[out=-90,in=-90,looseness=1.5] (6.5,0);
    \draw (7.5,0) to[out=90,in=90,looseness=1.5] node[auto,swap] {$e_{12}$} (7,0) to[out=-90,in=-90,looseness=1.5] (7.5,0);
    \draw (7.5,0) to[out=90,in=90,looseness=1.5] (8,0) to[out=-90,in=-90,looseness=1.5] (7.5,0);
  \end{tikzpicture}
\end{center}
Here $e_{10}$, $e_{11}$, and $e_{12}$ are all edges not adjacent to any vertices, with genera 0, 1, and 2 respectively.
We did not draw any arrows on them because only flags, not edges, are directed as ``incoming'' or ``outgoing''.
When interpreted as incoming or outgoing to the entire graph, the edges $e_1$--$e_7$ adjacent to the root above would be drawn as follows. %(preserving the ordering on incoming and outgoing edges to the root by drawing the incoming and outgoing edges to the graph in the same order).
\begin{center}
  \begin{tikzpicture}
    \node[outer] (e1a) at (2,1) {};
    \node[outer] (e1b) at (2,-1) {};
    \draw[edge] (e1a) -- node[auto] {$e_1$} (e1b);
    \node[outer] (e2) at (8,1) {};
    \draw[edge] (e2) -- node[auto] {$e_2$} (8,0);
    \node[outer] (e3) at (9,-1) {};
    \draw[edge] (9,0) -- node[auto] {$e_3$} (e3);
    \node[vertex] (m) at (3,0) {$m$};
    \node[outer] (e4) at (3,1) {};
    \draw[edge] (e4) -- node[auto] {$e_4$} (m);
    \node[vertex] (n) at (4,0) {$n$};
    \node[outer] (e5) at (4,-1) {};
    \draw[edge] (n) -- node[auto] {$e_5$} (e5);
    \node[vertex] (h) at (5,.2) {$h$};
    \node[outer] (e6) at (5.5,1) {};
    \draw[edge] (e6) -- node[auto] {$e_6$} (5.5,-.7);
    \draw[edge] (h) to[out=-90,in=90]  (5.5,-.7);
    \node[vertex] (k) at (6.5,-.2) {$k$};
    \node[outer] (e7) at (7,-1) {};
    \draw[edge] (7,.7) -- node[auto] {$e_7$} (e7);
    \draw[edge] (7,.7) to[out=-90,in=90] (k);
  \end{tikzpicture}
\end{center}

We note that there are many ways in which even a ordered hypergraph can have nontrivial automorphisms.
One simple example is the graph with two vertices and no edges:
\begin{center}
\begin{tikzpicture}
  \node[circle,fill,inner sep=1pt] at (0,0) {};
  \node[circle,fill,inner sep=1pt] at (1,0) {};
\end{tikzpicture}
\end{center}
in which the two vertices can be swapped by an automorphism.
However, it is not necessary to be disconnected to have nontrivial automorphisms:
\begin{center}
  \begin{tikzpicture}[scale=2]
    \node[vertex] (f) at (0,0) {$f$};
    \node[vertex] (g) at (1,0) {$g$};
    \node[vertex] (h) at (0,1) {$h$};
    \node[vertex] (k) at (1,1) {$k$};
    \draw[edge] (h) to[out=-120,in=120] (f);
    \draw[edge] (k) to[out=-60,in=30,looseness=2] (f);
    \draw[cross] (h) to[out=-60,in=60] (g);
    \draw[edge] (h) to[out=-60,in=60] (g);
    \draw[cross] (k) to[out=-120,in=120] (g);
    \draw[edge] (k) to[out=-120,in=120] (g);
  \end{tikzpicture}
\end{center}
Here there is an automorphism that swaps $f$ with $g$ and swaps $h$ with $k$.
Moreover, if we orient this graph by giving the edges the left-to-right ordering in the picture, then this automorphism preserves the orientation.
This example cannot be rooted (the automorphism has no fixed points) --- or more precisely, it cannot occur in the connected component of the root --- but if we use edges that are incident on more than two vertices then we can have nontrivial automorphisms with fixed points:
\begin{center}
  \begin{tikzpicture}
    \node[vertex] (f) at (0,0) {$\ast$};
    \node[vertex] (g) at (1,2) {$g$};
    \node[vertex] (h) at (-1,2) {$h$};
    \draw[edge] (g) to[out=-90,in=90] (0,1);
    \draw[edge] (h) to[out=-90,in=90] (0,1);
    \draw[edge] (0,1) -- (f);
  \end{tikzpicture}
\end{center}
Here there is an automorphism that swaps $g$ and $h$ and fixes the root $\ast$.
The most restrictive thing we can say about about automorphisms is the following.

\begin{defn}
  A hypergraph is \textbf{binary}, or simply a \textbf{graph}, if % for each edge $e$ we have
  % \[ \rank(e) + 2 \cdot \genus(e)  = 2, \]
  % i.e.\ if
  every edge either has rank 2 and genus 0, or rank 0 and genus 1.
\end{defn}

Amusingly, this condition can be reformulated by saying that the rank of an edge is the same as its ``Euler characteristic'' $\chi=2-2g$.

\begin{lem}
  A connected rooted directed reduced binary hypergraph of genus zero has no nontrivial automorphisms.
\end{lem}
\begin{proof}
  Suppose $\phi$ is an automorphism of $\G$.
  By assumption, it must preserve the root.
  Since it is locally-ordered, it must preserve all edges adjacent to the root.
  But since each of those edges is adjacent to exactly one other vertex, it must preserve those vertices too.
  Proceeding inductively we find that it must preserve all edges and vertices in the connected component of the root, which is all of them since the graph is connected.
  Finally, since $\G$ is reduced and of genus zero, preserving all the edges means that it is the identity on the reflexive graph $E$.
\end{proof}

The presence of nontrivial automorphisms means that in general, we cannot simply ``pass to isomorphism classes'' of hypergraphs, and thus structures over hypergraphs are not definable using ``set-based shapes'', such as polynomial monads on the category of polygraphs.
In~\cite{bb:htapm} isomorphism classes and polynomial monads are shown to work for certain subclasses of graphs, but even when it works such a restriction is technical and error-prone.
Thus, we will generally work with categories instead of sets, never passing to isomorphism classes, and using a weak monad rather than a strict one.

In addition, our definition of hypergraph does not support all the isoomorphisms we would like to have.
For instance, we would like a non-reduced hypergraph to be isomorphic to a ``reduction'' in which distinct edge representatives of the same edge have been collapsed along an identification.
This collapse exists as a \emph{morphism} of hypergraphs in one direction, but is not invertible.
Thus we introduce the following definition:

\begin{defn}\label{defn:weq}
  A morphism of reflexive graphs is a \textbf{weak equivalence} if the preimage of every reflexivity edge is a (nonempty) undirected tree.
  A morphism of hypergraphs is a \textbf{weak equivalence} if it is bijective on vertices (hence on flags) and its map on edges is a weak equivalence.
\end{defn}

\begin{lem}
  Every hypergraph admits a weak equivalence to a reduced one.
  Moreover, if $\G\to \G_1$ and $\G \to \G_2$ are weak equivalences with $\G_1$ and $\G_2$ reduced, then there is a non-unique isomorphism $\G_1 \cong \G_2$ (which need not commute with the maps from $\G$).
\end{lem}
\begin{proof}
  To construct a reduction of $\G$, choose a spanning tree inside each edge and collapse it to a point.
  The second statement follows since weak equivalences induce isomorphisms of sets of edges that preserve genera, and any two reduced hypergraphs with the same vertices, flags, edges, and genera are isomorphic.
\end{proof}

The non-uniqueness of ``reduction'' is the reason for including non-reduced graphs in the theory; as we will see, they arise naturally in the construction of insertion in \cref{sec:tt-insertion}, and without a canonical way to reduce them it is more natural to keep them around.
If we represented the edges by a free groupoid rather than a reflexive graph, weak equivalences would be actual equivalences, but free groupoids also have additional automorphisms that we don't want.

% The directed version of the binary condition is a little kludgy to state due to our convention about the orientations of flags adjacent to the root.

% \begin{defn}
%   Let $\G$ be a directed rooted hypergraph.
%   \begin{enumerate}
%   \item $\G$ is \textbf{weakly binary} if it is binary (in the undirected sense) and moreover every edge not adjacent to the root has equal in-rank and out-rank (i.e.\ either both 1 or both 0).
%   \item $\G$ is \textbf{strongly binary} if it is binary (in the undirected sense) and moreover if we switched the direction of all flags adjacent to the root then every edge would have equal in-rank and out-rank.
%   \end{enumerate}
% \end{defn}

% Here is an example of a strongly binary directed rooted hypergraph:
% \[
% \begin{tikzpicture}
%   \node[vertex] (f) at (0,0) {$f$};
%   \node[vertex] (g) at (1,-1) {$g$};
%   \node[vertex] (h) at (0,-2) {$h$};
%   \node[outer] (in1) at (0,1) {};
%   \node[outer] (in2) at (2,1) {};
%   \node[outer] (in3) at (1,1) {};
%   \node[outer] (out2) at (2,-3) {};
%   \node[outer] (out3) at (1,-3) {};
%   \node[outer] (out1) at (0,-3) {};
%   \draw[edge] (f) -- (g);
%   \draw[edge] (in1) -- (f);
%   \draw[edge] (g) -- (h);
%   \draw[edge] (f) -- (h);
%   \draw[edge] (h) -- (out1);
%   \draw[edge] (in3) -- (g);
%   \draw[edge] (in2) -- (out2);
%   \draw[edge] (h) -- (out3);
% \end{tikzpicture}
% \]
% Here is one that is weakly binary but not strongly binary:
% \[
% \begin{tikzpicture}
%   \node[vertex] (f) at (0,0) {$f$};
%   \node[vertex] (g) at (1,-1) {$g$};
%   \node[vertex] (h) at (0,-2) {$h$};
%   \node[outer] (in1) at (0,1) {};
%   \node[outer] (in2) at (3,1) {};
%   \node[outer] (in4) at (2,1) {};
%   \node[outer] (in3) at (1,1) {};
%   \node[outer] (out2) at (3,-4) {};
%   \node[outer] (out3) at (1,-4) {};
%   \node[outer] (out4) at (2,-4) {};
%   \node[outer] (out1) at (0,-4) {};
%   \draw[edge] (f) -- (g);
%   \draw[edge] (in1) -- (f);
%   \draw[edge] (g) -- (h);
%   \draw[edge] (f) -- (h);
%   \draw[edge] (h) -- (out1);
%   \draw[edge] (in3) -- (g);
%   \draw[edge] (in2) -- (out2);
%   \coordinate (four) at (1,-3);
%   \draw[edge] (h) to[out=-90,in=90] (four);
%   \draw[edge] (in4) to[out=-90,in=90] (four);
%   \coordinate (five) at (2,-3);
%   \draw[edge] (five) to[out=-90,in=90] (out3);
%   \draw[edge] (five) to[out=-90,in=90] (out4);
% \end{tikzpicture}
% \]
% And here is a directed rooted hypergrah that is binary in the undirected sense, but not even weakly binary in the directed sense:
% \[
% \begin{tikzpicture}
%   \node[vertex] (f) at (0,0) {$f$};
%   \node[vertex] (g) at (1,-1) {$g$};
%   \node[vertex] (h) at (0,-2) {$h$};
%   \node[outer] (in1) at (0,1) {};
%   \node[outer] (in3) at (1,1) {};
%   \node[outer] (out3) at (1,-4) {};
%   \node[outer] (out1) at (0,-4) {};
%   \draw[edge] (f) -- (g);
%   \draw[edge] (in1) -- (f);
%   \draw[edge] (g) -- (h);
%   \draw[edge] (h) -- (out1);
%   \draw[edge] (in3) -- (g);
%   \draw[edge] (h) -- (out3);
%   \coordinate (two) at (-1,-3);
%   \draw[edge] (f) to[out=-90,in=90] (two);
%   \draw[edge] (h) to[out=-120,in=90] (two);
% \end{tikzpicture}
% \]

We end this section by comparing our graphs to others in the literature.
Graphs with ``free flags'' have been used in defining many kinds of operads, but usually only of the binary sort, corresponding to non-cartesian multicategories and operads.

In a reduced binary rooted hypergraph, we can define an involution on the set of flags not adjacent to the root by sending each flag to the other flag of its corresponding edge, if that flag is not adjacent to the root, or to itself otherwise.
The quotient of this involution is then isomorphic to the set of edges that are adjacent to some non-root vertex.
Thus, we can equivalently define a binary rooted hypergraph by giving
\begin{itemize}
\item a set $F$ of flags (the flags not adjacent to the root),
\item an involution on $F$,
\item a set of ``exceptional linear edges'' (the edges adjacent to the root twice),
\item a set of ``exceptional loops'' (the edges not adjacent to any vertex --- the only ones with genus 1), and
\item a set $V$ of (non-root) vertices and a function $F\to V$ with finite linearly ordered fibers (equivalently, a ``partition'' of $F$ into finite linearly ordered blocks, some of which are allowed to be empty).
\end{itemize}
This is the definition of ``graph'' used commonly in operad theory, e.g.~\cite{bm:gen-opds,km:gwcqceg,costello:ainf,mms:wheeled-props,gk:modular-operads}, although often exceptional loops and edges are omitted or treated inconsistently.

Alternatively, if we remove the root but not the flags adjacent to it, then the function $F\to V$ becomes a partial function, which is defined on a flag just when that flag is not adjacent to the root.
Now we still have the exceptional edges (those adjacent to two flags that are not adjacent to any vertices) and the exceptional loops (those not adjacent to any flags).
This is essentially how binary rooted hypegraphs are encoded in~\cite{bb:htapm}, except that their exceptional loops are ``adjacent to a single flag twice'' rather than to no flags at all.

Another possibility is to express the partial function $F\rightharpoonup V$ as a relation, i.e.\ a span $F \ot H \to V$ in which $H\to F$ is injective.
If we exclude the possibility of exceptional loops, then the function $F\to E$ is a 2-to-1 surjection and hence can be encoded up to isomorphism by a fixed-point-free involution of $F$.
This is the definition of graph from~\cite{jk:feynman} (though they call the elements $H$ the ``flags'' and those of $F$ the ``(directed) edges'').
Their graph morphisms are similar to ours, although theirs are not required to preserve the ``degree of the root''.


\section{Type theory for hypergraphs}
\label{sec:tt-hy}

For all of this section, let $P$ be a fixed cycligraph; we will describe a type theory for $P$-labeled hypergraphs.
This includes unlabeled hypergraphs as the degenerate case when $P$ is terminal, and also the directed case if $P$ happens to be a polygraph or a multigraph.

An \textbf{edge context} $\Delta$ is a finite list of distinct variables, each labeled with an object of $P$ as its type.

\begin{mathpar}
  \inferrule{ }{\ec \edgectx}
  \and
  \inferrule{\Delta\edgectx \\ p\in P \\ x\notin \Delta}{(\Delta,x:p) \edgectx}
\end{mathpar}

A \textbf{loop context} $\Xi$ in an edge context $\Delta$ is a finite list of equalities between variables of the same type.

\begin{mathpar}
  \inferrule{ }{\Delta \types \ec\loopctx}
  \and
  \inferrule{\Delta\types\Xi\loopctx \\ (x:p)\in \Delta \\ (y:p)\in\Delta}{\Delta\types (\Xi,x\doteq y) \loopctx}
\end{mathpar}

A \textbf{vertex} in an edge context is a morphism of $P$ with variables of appropriate type assigned as its legs.

\begin{mathpar}
  \inferrule{\alpha\in P(p_1,\dots,p_n) \\ (x_i\in p_i)\in\Delta}{\Delta \types \alpha(x_1,\dots,x_n) \vertex}
\end{mathpar}

A \textbf{graph context} is an edge context, a loop context, and a finite list of variables assigned to vertices.

\begin{mathpar}
  \inferrule{\Delta \edgectx \\ \Delta\types \Xi\loopctx}{\Delta \mid\Xi\types \ec\graph}
  \and
  \inferrule{\Delta \mid\Xi\types \Gamma\graph \\ \Delta\types M\vertex \\ (f\notin \Gamma)}{\Delta\mid\Xi\types (\Gamma,f:M)\graph}
\end{mathpar}

\begin{thm}\label{thm:ctx-hy}
  A graph context determines, and is determined by, a finite $P$-labeled hypergraph $\G\to P$.
\end{thm}
\begin{proof}
  The variables in the edge context correspond to the edge representatives, and their assignment to types corresponds to the action of the labeling morphism $\G\to P$ on these.
  The equalities in the loop context correspond to non-reflexivity edges in the reflexive graph $E$.
  The variables in the graph context correspond to the vertices of $\G$, and their type assignment to a morphism of $P$ is the action of $\G\to P$ on vertices.
  Finally, the list of variables in a syntactic vertex $\alpha(x_1,\dots,x_n)$ specifies the flags of $\G$.
\end{proof}

In order to enhance \cref{thm:ctx-hy} to some sort of equivalence, we need to introduce morphisms between graph contexts.

\begin{defn}
  Given two graph contexts
  \begin{mathpar}
    \Delta\mid\Xi\types \Gamma\graph \and
    \Delta'\mid\Xi'\types \Gamma'\graph \and
  \end{mathpar}
  an \textbf{morphism} or \textbf{substitution} $\Gamma\to\Gamma'$ consists of:
  \begin{enumerate}
  \item A function $\sigma : \Delta' \to \Delta$ that respects types.
  \item A partial function $\tau : \Xi' \rightharpoonup \Xi$ such that
    \begin{enumerate}
    \item If $\tau(x\doteq y)$ is defined, then it is of the form $\sigma(x)\doteq \sigma(y)$.
    \item If $\tau(x\doteq y)$ is undefined, then $\sigma(x)=\sigma(y)$.
    \end{enumerate}
  \item A function $\nu : \Gamma' \to \Gamma$ that respects types modulo $\sigma$, i.e.\ if $f:\alpha(\vec x)$ then $\nu(f) : \alpha(\sigma(\vec x))$.
  \end{enumerate}
  This defines the category $\GCtx_P$ of $P$-labeled graph contexts.
\end{defn}

\begin{thm}
  There is an equivalence of categories
  \[ (\hy/P)\op \simeq \GCtx_P. \]
\end{thm}
\begin{proof}
  The contravariance of the equivalence is because context morphisms were defined to go the opposite way from their underlying functions on contexts (we think of the morphism as substituting $\sigma(x)$ for $x$ and so on).
  The function $\sigma$ corresponds to the map on edge representatives and the function $\nu$ corresponds to the map on vertices.
  The partial function $\tau$ corresponds to the action on edge identifications; where it is undefined, we send the corresponding edge to reflexivity.
\end{proof}

The weak equivalences from \cref{defn:weq} also have a natural type-theoretic interpretation.
They are inductively obtained by substituting along equalities of \emph{distinct} variables:
\begin{equation}\label{eq:subst}
  \inferrule{\Delta,y:p\mid\Xi,x\doteq y \types \Gamma\graph \\ x\not\jdeq y}{\Delta\mid\Xi[x/y]\types \Gamma[x/y] \graph}
\end{equation}


\section{Insertion of hypergraphs}
\label{sec:insertion}

We now define an operation of \emph{insertion} of hypergraphs, which replaces some of the vertices in one graph by entire new graphs having the same ``flag structure''.
To clarify the abstract properties of this operation, we phrase it as a bicategorical composition.

\begin{defn}
  If $E_1 \xot{s} F \xto{t} E_2$ is a span of reflexive graphs in which $F$ is discrete (has only reflexivity edges), then its \textbf{collage} $E_1 \coll_F E_2$ is the disjoint union reflexive graph $E_1+E_2$ augmented by a new edge for each $x\in F$, attaching $s(x)$ to $t(x)$.
\end{defn}

\begin{defn}
  A \textbf{corolla} is a reduced hypergraph of genus zero of the form $1 \ot F = F$, i.e.\ having one vertex, each flag of which is adjacent to a unique edge.
  A disjoint union of corollas, i.e.\ a hypergraph of the form $V \ot F = F$, is called an \textbf{inflorescence}.\footnote{A corolla is the whorl of petals in a flower; an inflorescence is a cluster of flowers on a single stem.}
\end{defn}

Note that an inflorescence is uniquely determined, up to non-unique isomorphism, by giving a set of vertices and their degrees.

\begin{defn}
  A \textbf{conormal lax bicategory} is like a bicategory, but its unit transformations $f \circ 1_x \to f$ and $1_y\circ f \to f$ are not necessarily invertible (though it associativity isomorphisms are).
  We still ask for the same coherence axioms.
\end{defn}

\begin{thm}\label{thm:hyrel}
  There is a conormal lax bicategory $\hyrel$ in which
  \begin{itemize}
  \item The objects are inflorescences.
  \item The morphisms from $\A$ to $\B$ are cospans $\A \to \G \ot \B$ of hypergraphs such that $(\A+\B) \to \G$ is bijective on vertices.
    Equivalently, the morphisms are hypergraphs $\G$ equipped with a partition of their vertices into two disjoint subsets; the inflorescences $\A$ and $\B$ are then uniquely determined.
  \item The composite $\G \coll_{\B} \H$ of $\A \to \G \ot \B$ and $\B \to \H \ot \C$ is defined to be
    \[ V_{\A}  + V_{\B} \longleftarrow F_{\A} + F_{\B} \longrightarrow E_{\G} \coll_{E_\B} E_{\H} \]
    In other words:
    \begin{enumerate}
    \item The vertices and flags of $\G \coll_{\B} \H$ the disjoint unions of those of $\A$ and those of $\C$.
    \item The reflexive graph of edges of $\G \coll_{\B} \H$ is the collage of those of $\G$ and $\H$ under that of $\B$.
      Thus, an edge representative is either one in $\G$ or one in $\H$, while an edge identification is either one in $\G$, one in $\H$, or one identifying the images in $\G$ and $\H$ of an edge in $\B$.
    \end{enumerate}
  \item The unit $1_{\A}$ of an inflorescence $\A=(V\ot F = F)$ is $V+V \ot F+F \to F$, with the two evident inclusions from $\A$.
  \end{itemize}
\end{thm}
\begin{proof}
  Associativity follows from the associativity of coproducts and collages.
  The latter means that if we have $E_1 \ot F_1 \to E_2 \ot F_2 \to E_3$ with $F_1,F_2$ discrete, then $(E_1 \coll_{F_1} E_2) \coll_{F_2} E_3 \cong E_1 \coll_{F_1} (E_2 \coll_{F_2} E_3)$, and the pentagon equation is satisfied if we have another span $E_3 \ot F_3 \to E_4$.
  This is a straightforward verification.

  The composite $1_{\A} \coll_{\A} \G$ has the same vertices and flags as $\G$ (up to isomorphism), but its edge graph has been augmented by a new edge representative $\bar{x}$ for each flag $x\in F_{\A}$, and new identifications connecting $\bar{x}$ to the edge representative adjacent to the image of $x$ in $\G$.
  Thus, it is not isomorphic to $\G$, but admits a map to $\G$ that contracts each of these new identifications to reflexivity.
  The other unit constraint is dual, and the coherence axiom is straightforward to check.
\end{proof}

Note that if $\A$ and $\C$ are ordered or directed, so is $\G \coll_{\B} \H$, since its vertices are simply those of $\A$ and $\C$.
Moreover, the set $\pi(E_1 \coll_F E_2)$ of connected components of a collage of reflexive graphs is the pushout $\pi E_1 +_{\pi F} \pi E_2$.
It follows that in the ordered case, the cycligraph reflection $\pi(\G \coll_{\B} \H)$ of a composite in $\hyrel$ is the pushout $\pi\G \coll_{\pi \B} \pi \H_v$ of the cycligraph reflections, and similarly for the unit.
In other words, the ``homwise cycligraph reflection'' of the ordered form of $\hyrel$ is simply the bicategory of cospans of cycligraphs.

The most common situation in which we apply this is the following.
Suppose $\G = (V\ot F \to E)$ is a hypergraph, and that for some subset $V_0 \subseteq V$ and each $v\in V_0$ we have a rooted hypergraph $\H_v = (V_v \ot F_v \to E_v)$ whose root $\ast_v$ has the same degree as $v$.
%In the directed case, we require it to have the same in-degree and out-degree separately.
(Usually, $V_0$ will be either a single vertex or the set of all non-root vertices.)

We regard $\G$ as a morphism from $\A$ to $\B$ in $\hyrel$, where $\A$ is determined by the vertices not in $V_0$ and $\B$ is determined by the vertices in $V_0$.
Similarly, we regard $\sum_v \H_v$ as a morphism from $\B'$ to $\C$, where $\B'$ is determined by the roots $\setof{ \ast_v | v\in V_0}$ and $\C$ by the non-root vertices.
The assumption tells us that $\B'\cong \B$, so we can form the composite $\G \coll_{\B} \sum_v \H_v$ in $\hyrel$.
We call the result the \textbf{insertion} of the hypergraphs $\H_v$ into $\G$ at the vertices $v\in V_0$, denoted $\ins{\G}{V_0}{v}{\H_v}$.

If $\G$ was rooted with $\ast \notin V_0$, then $\ins{\G}{V_0}{v}{\H_v}$ is again rooted with the same root.
Moreover, if $\G$ and each $\H_v$ are labeled by some cycligraph $P$, with labelings that agree on $V_0$, then since these labelings factor through $\pi \G$ and $\pi \H_v$ and the cycligraph reflection takes insertions to pushouts, there is a unique induced labeling on $\ins{\G}{V_0}{v}{\H_v}$.

\fxnote{Add some examples.}



\section{Type theory for insertion}
\label{sec:tt-insertion}

If $\Gamma$ and $\Gamma'$ are graph contexts, we write $\Gamma \sametypes \Gamma'$ to mean that their variables have the same types in the same order, i.e.:
\begin{mathpar}
  \inferrule{ }{\Delta\mid\Xi\types \ec \sametypes \ec}
  \and
  \inferrule{\Delta\mid\Xi\types \Gamma\sametypes\Gamma' \\ \Delta\types \alpha(\vec x)\vertex \\ \Delta\types \alpha(\vec y) \vertex}{\Delta\mid\Xi\types (\Gamma,\alpha(\vec x)) \sametypes (\Gamma',\alpha(\vec y))}
\end{mathpar}
We also write $\varsof\Gamma$ for the ordered list of edge variables occurring in $\Gamma$, i.e.:
\begin{align*}
  \varsof\ec &\coloneqq ()\\
  \varsof{(\Gamma,\alpha(\vec x))} &\coloneqq (\varsof\Gamma,\vec x)
\end{align*}
With these notations, the insertion rule can be expressed as:
\begin{mathpar}
  \inferrule{\Delta\mid\Xi\types (\Gamma,\Phi)\graph\\ \Delta'\mid\Xi'\types (\Psi,\Upsilon) \graph}
  {\Delta,\Delta' \mid \Xi,\Xi',\varsof\Phi\doteq\varsof\Psi \types (\Gamma,\Upsilon) \graph}
\end{mathpar}
Implicit in the notation is that $\Delta\cap \Delta'=\emptyset$, so that $\varsof\Phi\doteq\varsof\Psi$ consists of equalities between distinct variables.
Thus at least some of them can be substituted away by a weak equivalence as in~\eqref{eq:subst} (a ``unification algorithm'' for the arguments of the vertices in $\Phi$ and $\Psi$).
However, we may still be left with additional self-loops created by the insertion, for instance:

\begin{mathpar}
  \inferrule*{\inferrule*{x:p \mid\cdot \types (\Gamma_1,f:\alpha(x,x)) \graph \\
    u:p \mid\cdot \types (g:\alpha(u,u),\Gamma_2) \graph}
  {x:p,u:p \mid x\doteq u, x\doteq u \types (\Gamma_1,\Gamma_2)\graph}}
{x:p \mid x\doteq x \types \Gamma_1,\Gamma_2[x/u] \graph}
\end{mathpar}


\section{Parametric right 2-adjoints}
\label{sec:pr2a}

We would like to build a monad out of labeled hypergraphs.
Our first thought may be that it should be a polynomial monad, since each hypergraph should give a ``constructor'' whose ``arguments'' are a labeling of it.
However, in a categorical situation where labelings have dependency, polynomial functors are too restrictive.
They are sufficient in the ``one-object'' clase of generalized operads (as in~\cite{bb:htapm}), but for generalized multicategories (``colored operads'') we need the more general \emph{parametric right adjoints} of~\cite{weber:parmrep,weber:fam-pra}.

As shown in~\cite{weber:fam-pra}, a parametric right adjoint (p.r.a.) functor between presheaf categories $[I\op,\Set]\to [J\op,\Set]$ can be represented by a discrete fibration $p:K\to J$ together with a profunctor $H:I\op\times K\to\Set$.
The p.r.a.\ functor corresponding to $p$ and $H$ is the composite
\[ [I\op,\Set] \xto{\hom_I(H,-)} [K\op,\Set] \xto{\lan_p} [J\op,\Set]. \]
where $\hom_I(H,X)(k) = \lim_{i\in I} \hom(H(i,k),X(i))$.
By writing $H$ as a two-sided discrete fibration, we can also represent a p.r.a.\ functor as the restriction to discrete fibrations of a polynomial in \Cat, but this will be less useful for our purposes.
However, we do note that $\lan_p$ acting on discrete fibration is just composition with $p$.

In fact, hypergraphs do not quite give such a parametric right adjoint either: the presence of automorphisms prevents $p$ from being a \emph{discrete} fibration.
We can still define a functor on presheaf categories in the same way, but it will not be p.r.a.\ because $\lan_p$ is no longer just composition of discrete fibrations.
A more natural thing to do is to define a functor on \Cat-valued presheaves, where the first step $\hom_I(H,-)$ is still the same, but the second step is given by composition with a non-discrete fibration $p$.

The situation is analogous to how while the 2-monad for strict monoidal categories is just the monad for monoids acting on objects and morphisms separately, the 2-monad for symmetric strict monoidal categories is not similarly obtained from the monad for commutative monoids.
Instead the operations have to be ordered and the symmetry only imposed up to isomorphism, and hence the 2-monad does not restrict to discrete categories, though it can be reflected into them.

In this section we develop the necessary preliminaries on parametric right 2-adjoints.

\begin{lem}\label{thm:pra}
  Suppose given categories $I,J,K$, a \Cat-valued profunctor $H:I\op\times K\to \Cat$, and a split fibration $p:K\to J$.
  Then the composite
  \[ [I\op,\Cat] \xto{\hom_I(K,-)} [K\op,\Cat] \cong \SFib/K \xto{\Sigma_p} \SFib/J \cong [J\op,\Cat] \]
  is a parametric right adjoint 2-functor, i.e.\ the induced 2-functor $[I\op,\Cat] \to [J\op,\Cat]/T1$ is a right 2-adjoint.
\end{lem}
\begin{proof}
  Since $\hom_I(K,-)$ is a right 2-adjoint, it suffices to show that $\Sigma_p$ is a parametric right adjoint.
  But $\Sigma_p1 = K$, so the relevant functor on slice categories is an equivalence.
\end{proof}

It is natural to conjecture that every p.r.a.\ 2-functor between presheaf 2-categories can be represented in this form, but we will not need this.
We do however need functorial extensions of this result.
The following proofs are adapted from the corresponding proofs for polynomial functors in~\cite{kg:polynomials,weber:poly-pb}.

\begin{lem}\label{thm:pra2cell}
  Suppose given a split fibration $p:K\to J$ and $H:I\op \times K\to \Cat$ determining a p.r.a.\ 2-functor $F$, and also $p':K'\to J$ and $H':I\op\times K'\to\Cat$ determining another one $G$, and also a functor $k:K'\to K$ such that $p' = p k$ and $H' \cong H(1,k)$.
  Then there is an induced cartesian 2-natural transformation $F\to G$.
\end{lem}
\begin{proof}
  Since $H' \cong H(1,k)$, the functor $\hom_I(H',-)$ is isomorphic to $k^* \circ \hom_I(H,-)$, where $k^*$ denotes precomposition with $k$, or equivalently pullback of split fibrations along $k$.
  Moreover, since $p' = p k$, we have $\Sigma_{p'} \cong \Sigma_p \circ \Sigma_k$ as functors on slice categories of \Cat.
  (Note that in general, $\Sigma_k : \Cat/K' \to \Cat/K$ need not preserve split fibrations or split morphisms between them, but it does take them to objects and morphisms whose images under $\Sigma_p$ are split.)
  Thus, $F$ is isomorphic to the composite $\Sigma_p \circ \Sigma_k \circ k^* \circ \hom_I(H,-)$, and our transformation is induced by the counit $\Sigma_k k^* \to \Id$.
  But this counit is always a cartesian transformation, and $\Sigma_p$ preserves pullbacks.
\end{proof}

\begin{lem}\label{thm:pracomp}
  Suppose given $H : J\op\times K \to \Cat$ and a split fibration $p:E\to J$.
  Then there is a split fibration $q:L\to K$ and a profunctor $M:E\op \times L \to \Cat$ and a natural isomorphism
  \[
  \begin{tikzcd}[column sep=huge]
    {[E\op,\Cat]} \ar[r,"{\hom_E(M,-)}"] \ar[d,"\Sigma_p"'] \ar[dr,phantom,"\cong"] & {[L\op,\Cat]} \ar[d,"\Sigma_q"]\\
    {[J\op,\Cat]} \ar[r,"{\hom_J(H,-)}"'] & {[K\op,\Cat]}
  \end{tikzcd}
  \]
\end{lem}
\begin{proof}
  Let $P:J\op\to\Cat$ be the functor corresponding to the split fibration $p:E\to J$, let $Q : K\op\to\Cat$ be $\hom_J(H,P)$, and let $q:L\to K$ be the split fibration corresponding to $Q$.
  Thus an object $\ell\in L$ is a natural transformation $\ell : H(-,q(\ell)) \to P$.

  If we let $f:F_\ell \to J$ be the split fibration corresponding to $H(-,q(\ell))$, then $\ell$ is equivalently a strict morphism of split fibrations $\hat\ell : F_\ell \to E$ over $J$.
  Let $G_\ell$ be the comma category of $\hat\ell$ under $E$ and over $J$, i.e.\ there is a universal 2-cell such that
  \[
  \begin{tikzcd}
    G_\ell \ar[r] \ar[d] \twocell{dr} & E \ar[d,equals] \\
    F_\ell \ar[r,"{\hat\ell}"'] & E \ar[dr,"p"] \\
    && J
  \end{tikzcd}
  \]
  is an identity.
  Then $G_\ell \to E$ is a split fibration; we define $M(-,\ell) : E\op\to\Cat$ to be the corresponding functor.
  For functoriality in $\ell$, note that a morphism $\psi:\ell\to\ell'$ consists of an arrow $q(\psi):q(\ell) \to q(\ell')$ and a modification
  \[
  \begin{tikzcd}
    H(-,q(\ell)) \ar[rr,"{H(-,q(\psi))}"] \ar[dr,"\ell"'] & ~\twocellop[\bar{\psi}]{d} & H(-,q(\ell')) \ar[dl,"\ell'"] \\
    & P.
  \end{tikzcd}
  \]
  or equivalently a vertical transformation
  \[
  \begin{tikzcd}
    F_\ell \ar[rr,"{F_\psi}"] \ar[dr,"\ell"'] & ~\twocellop[\bar{\psi}]{d} & F_{\ell'} \ar[dl,"\ell'"] \\
    & E.
  \end{tikzcd}
  \]
  If we paste this with the defining comma square of $G_\ell$, we can factor it through $G_{\ell'}$ by a map that is a strict morphism of split fibrations, hence induces a map $M(-,\ell) \to M(-,\ell')$.

  % Of course, an object $e\in E$ is an object of $P(p(e))$.
  % We define $M(e,\ell)$ to be the comma category of the functor $\ell_{p(e)} : H(p(e),q(\ell)) \to P(p(e))$ under $e$:
  % \[
  % \begin{tikzcd}
  %   M(e,\ell) \ar[r] \ar[d] \twocell{dr} & 1 \ar[d,"e"] \\
  %   H(p(e),q(\ell)) \ar[r,"{\ell_{p(e)}}"'] & P(p(e))
  % \end{tikzcd}
  % \]
  % That is, an object of $M(e,\ell)$ is an object $h\in H(p(e),q(\ell))$ with a morphism $e\to \ell_{p(e)}(h)$.

  % To make $M$ a profunctor, note that a morphism $\phi : e'\to e$ in $E$ consists of a morphism $p(\phi) : p(e')\to p(e)$ in $J$ and a morphism $\bar{\phi}:e'\to p(\phi)^*(e)$ in $P(p(e'))$, while a morphism $\psi:\ell\to\ell'$ consists of an arrow $q(\psi):q(\ell) \to q(\ell')$ and a modification
  % \[
  % \begin{tikzcd}
  %   H(-,q(\ell)) \ar[rr,"{H(-,q(\psi))}"] \ar[dr,"\ell"'] & ~\twocellop[\bar{\psi}]{d} & H(-,q(\ell')) \ar[dl,"\ell'"] \\
  %   & P.
  % \end{tikzcd}
  % \]
  % To define the action of $M$ on $\phi,\psi$ we form the following pasting:
  % \[
  % \begin{tikzcd}
  %   M(e,\ell) \ar[r] \ar[d] \twocell{dr} & 1 \ar[d,"e"] \ar[ddr,bend left,"e'"] \twocell[\bar{\phi}]{ddr} \\
  %   H(p(e),q(\ell)) \ar[r,"{\ell_{p(e)}}"'] \ar[d,"{H(\phi,1)}"'] & P(p(e)) \ar[dr,"{p(\phi)^*}" description]\\
  %   H(p(e'),q(\ell)) \ar[rr,"{\ell_{p(e')}}"] \ar[d,"{H(1,\psi)}"'] &~& P(p(e'))\\
  %   H(p(e'),q(\ell')) \ar[urr,"{\ell'_{p(e')}}"',shift right] \twocell[\bar{\psi}_{p(e')}]{ur}
  % \end{tikzcd}
  % \]
  % and factor it through the comma square for $e'$ and $\ell'$:
  % \[
  % \begin{tikzcd}
  %   M(e,\ell) \ar[dr,"{M(\phi,\psi)}"]\\
  %   &M(e',\ell') \ar[r] \ar[d] \twocell{dr} & 1 \ar[d,"e'"] \\
  %   &H(p(e'),q(\ell')) \ar[r,"{\ell'_{p(e')}}"'] & P(p(e'))
  % \end{tikzcd}
  % \]

  Now we construct the desired isomorphism.
  We will take it to be the mate under the adjunctions $\Sigma_p \dashv p^*$ and $\Sigma_q \dashv q^*$ of an isomorphism
  \begin{equation}
  \begin{tikzcd}[column sep=huge]
    {[E\op,\Cat]} \ar[r,"{\hom_E(M,-)}"] \ar[from=d,"p^*"] \ar[dr,phantom,"\cong"] & {[L\op,\Cat]} \ar[from=d,"q^*"']\\
    {[J\op,\Cat]} \ar[r,"{\hom_J(H,-)}"'] & {[K\op,\Cat]}
  \end{tikzcd}\label{eq:pracomp-mate}
  \end{equation}
  To construct this, let $R:J\op\to\Cat$, corresponding to a split fibration $r:C\to J$.
  Its image under the lower-right composite is the functor $S:L\op\to\Cat$ defined by $S(\ell) = \hom_J(H(-,q(\ell)),R)$.
  That is, an object of $S(\ell)$ is a natural transformation $H(-,q(\ell)) \to R$, or equivalently a strict morphism of split fibrations $F_\ell \to C$ over $J$.
  %, assigning to each $j\in J$ a functor $H(j,q(\ell)) \to R(j)$, naturally in $j$.

  The image of $R$ under the left-upper composite is the functor $T:L\op\to Cat$ defined by $T(\ell) = \hom_E(M,R\circ p)$.
  That is, an object of $T(\ell)$ is a natural transformation $M(-,\ell) \to R(p(-))$, or equivalently a strict morphism of split fibrations
  \[
  \begin{tikzcd}
    G_\ell \ar[d] \ar[r] & C \ar[d] \\
    E \ar[r,"p"'] & J
  \end{tikzcd}
  \]
  over $p$.
  % , assigning to each $e\in E$ a functor $M(e,\ell) \to R(p(e))$.
  % Now an object of $M(e,\ell)$ consists of an object $h\in H(p(e),q(\ell))$ and an arrow $e\to \ell_{p(e)}(h)$ in $P(p(e))$.
  % In particular, for each $j\in J$ and $h\in H(j,q(\ell))$ we can take $e=\ell_{j}(h)$ and act on the identity arrow in $P(p(e))$ to get an object of $R(p(\ell_{j}(h)))$, i.e.\ $R(j)$.
  However, $G_\ell$ is the free fibration generated by $\hat\ell : F_\ell \to E$ over $J$, so such a morphism is equivalently an arbtrary morphism
  \[
  \begin{tikzcd}
    F_\ell \ar[d] \ar[r] & C \ar[d] \\
    E \ar[r,"p"'] & J
  \end{tikzcd}
  \]
  that is a strict morphism over $J$, i.e.\ an object of $S(\ell)$.
  We leave it to the reader to verify the naturality of this isomorphism.

  It remains to show that the mate of~\eqref{eq:pracomp-mate} really is an isomorphism.
  Since the unit and counit of the adjunctions $\Sigma_p \dashv p^*$ and $\Sigma_q \dashv q^*$ are cartesian natural transformations, and all the functors involved preserve pullbacks, this mate is again a cartesian transformation.
  Thus, it is an isomorphism as soon as its component at the terminal object is so.
  Now $\hom_E(M,-)$ is a right adjoint, hence preserves the terminal object, while $\Sigma_q$ takes the terminal object to the split fibration $q:L\to K$ itself.
  But $\Sigma_p$ also takes the terminal object to $p:E\to J$ itself, which $\hom_J(H,-)$ takes to $q:L\to K$ by definition of $q$.
\end{proof}

\begin{lem}\label{thm:pracomp2}
  Given a split fibration $p_2:K\to J_3$ and $H_2:J_2\op \times K\to \Cat$ determining a p.r.a.\ 2-functor $F_2:[J_2\op,\Cat] \to [J_3\op,\Cat]$, and also $p_1:E\to J$ and $H_1:J_1\op \times E\to \Cat$ determining $F_1 : [J_1\op,\Cat] \to [J_2\op,\Cat]$, the composite $F_2\circ F_1$ is determined by the composite split fibration $L \xto{q} K \xto{p_2} J_3$ and the composite profunctor $H_1 \otimes_E M : J_1\op \times L \to \Cat$, where $q$ and $M$ are as in \cref{thm:pracomp}.
\end{lem}
\begin{proof}
  From the isomorphism of \cref{thm:pracomp} we obtain
  \[
  \begin{tikzcd}[column sep=huge]
    {[J_1\op,\Cat]} \ar[r,"{\hom_{J_1}(H_1,-)}"] \ar[dr,"F_1"'] \ar[rr,"{\hom_{J_1}(H_1 \otimes_E M,-)}",bend left] &
    {[E\op,\Cat]} \ar[r,"{\hom_E(M,-)}"] \ar[d,"\Sigma_p"'] \ar[dr,phantom,"\cong"] & {[L\op,\Cat]} \ar[d,"\Sigma_q"]
    \ar[dr,"\Sigma_{p_2 q}"] \\
    &{[J_2\op,\Cat]} \ar[r,"{\hom_{J_2}(H_2,-)}"'] \ar[rr,"F_2"',bend right]
    & {[K\op,\Cat]}
    \ar[r,"\Sigma_{p_2}"] & {[J_3\op,\Cat]}
  \end{tikzcd}
  \]
  yielding the desired isomorphism.
\end{proof}

Putting all this together, we have:

\begin{thm}\label{thm:pra-psfr}
  There is a bicategory whose objects are categories, whose morphisms from $I$ to $J$ consist of a split fibration $p:K\to J$ and a profunctor $H:I\op\times K\to \Cat$, whose 2-cells are as in \cref{thm:pra2cell}, and whose composition is as in \cref{thm:pracomp2}.
  Moreover, $J\mapsto [J\op,\Cat]$ defines a pseudofunctor from this bicategory to the bicategory of 2-categories, parametric right adjoint 2-functors, and cartesian 2-natural transformations.\qed
\end{thm}


\section{The pseudomonad for hypercategories}
\label{sec:hypercats}

We now apply the machinery of \cref{sec:pr2a} to construct a monad out of hypergraphs, where the non-discrete split fibration $p:K\to J$ incorporates the automorphisms of hypergraphs.
In fact we will include in it also the weak equivalences from \cref{defn:weq}, so that it will not even be a groupoid.
In all the semantic examples that we know, these weak equivalences act as isomorphisms; so in constructing the monad we could formally invert them.
But this would actually make our lives \emph{more} difficult, since it would be extra work to verify that the inversion is consistent everywhere, and from a syntactic point of view it is more natural to keep them directional (since substitution is more natural than its inverse).

We begin with a simpler monad that omits any monoidal structure on objects.
Let $J$ be the category such that presheaves on $J$ are cycligraphs.
Then $J$ has one object $\bullet$ and objects $[n]$ for $n\in\N$, with $n$ nonidentity morphisms $\bullet\to [n]$.
A functor $J\op\to\Cat$ is an internal cycligraph in \Cat, or equivalently an internal category in cycligraphs; we call it a \textbf{\Cat-cycligraph}.

By an \textbf{$n$-hypergraph} we will mean a rooted ordered hypergraph whose root has rank $n$.
We define a \Cat-cycligraph $J\op\to\Cat$ by sending $[n]$ to the category of $n$-hypergraphs and weak equivalences between them, and $\bullet$ to the terminal category with unique object $\star$.
(Note that any isomorphism is a weak equivalence.)
Let $p:K_1 \to J$ be the (split, but not discrete) fibration corresponding to this functor.

We define a profunctor $H_1 : J\op\times K_1 \to \Set$ as follows:
\begin{align*}
  H_1(\bullet,\G) &= \text{edges of $\G$}\\
  H_1([n],\G) &= \text{non-root vertices in $\G$ with rank $n$}\\
  H_1(\bullet,\star) &= 1\\
  H_1([n],\star) &= \emptyset
\end{align*}
The morphisms of graphs in the fibers of $K_1$ over $[n]$ act (by isomorphisms) on $\H_1(-,\G)$ in the obvious way.
The $n$ morphisms $\star\to\G$ in $K_1$ induce the maps $H_1(\bullet,\star) \to H_1(\bullet,\G)$ picking out the edges incident to the root.
The $n$ morphisms $\bullet\to [n]$ in $J$ induce the maps $H_1([n],\G) \to H_1(\bullet,\G)$ selecting the edges incident to each vertex.

Thus we have an induced p.r.a.\ endo-2-functor $T_1$ of the 2-category $[J\op,\Cat]$ of \Cat-cycligraphs.
We now make $T_1$ into a sort of monad, using \cref{thm:pra-psfr}.

The identity functor $\Id$ of $[J\op,\Cat]$ is p.r.a.\ and determined by the hom-profunctor $\hom_J$ and the identity split fibration $J\to J$.
Thus, to define a unit $\eta : \Id \to S$, it suffices to define a functor $k:J\to K_1$ such that $p k\cong 1_J$ and $H_1(1,k) \cong \hom_J$.
In our case, we define $k$ to send $\bullet$ to $1$ and $[n]$ to the \textbf{rooted $n$-corolla} $\C_n$, which has two vertices (one of which is the root) and $n$ edges each incident to both vertices once in the same order.
It is clear that $k$ is a section of $p$, while inspecting the definition of $H_1$ yields $H_1(1,k) \cong \hom_J$.

Thus we have a cartesian 2-natural transformation $\eta : \Id\to T_1$, where $\eta_P : P \to T_1 P$ sends each each morphism to the $n$-corolla labeled by itself.
Of course, there are many different (isomorphic) $n$-corollas.
However, onec we fix any particular such corolla for each $n$, we get such a transformation $\eta$.
The existence of other corollas means that $\eta$, though fully faithful, is not replete: objects of $T_1 P$ defined using other corollas are isomorphic to ones in the image of $\eta$ but are not in the image of $\eta$ themselves.

Now we define a cartesian 2-natural transformation $\mu:T^2\to T$.


\newpage

This is almost, but not quite, the monad we want: we also want a monoidal structure on the objects, which requires a further enhancement.

We define a \textbf{bracketing} of $n$ things to be a list of natural numbers whose sum is $n$, regarded as as giving the number of things in each bracket.
The \textbf{arity} of the bracketing is the length of the list.
For instance, the bracketing $(2,0,3,1)$ of $6$, of arity $4$, should be thought of as $(xx)()(xxx)(x)$.
An \textbf{$n$-bracketed hypergraph} is a rooted hypergraph together with a bracketing of arity $n$ of the flags incident to the root.




TODO: orders

A morphism of bracketed hypergraphs must, of course, preserve the bracketings.

Now we define another functor $J\op\to\Cat$ by sending $[n]$ to the category of $n$-bracketed hypergraphs and bracket-preserving weak equivalences between them, and $\bullet$ to the discrete category $\N$.\fxnote{Can we incorporate symmetries here?  We ought to have them for kits at least.}
The $n$ morphisms $\bullet \to [n]$ act by sending an $n$-bracketed hypergraph to the $n$ natural numbers appearing in its bracketing.

Let $p:K \to J$ be the split fibration corresponding to this functor.
We define a profunctor $H : J\op\times K \to \Set$ as follows:
\begin{align*}
  H(\bullet,\G) &= \text{edges of $\G$}\\
  H([n],\G) &= \text{non-root vertices in $\G$ with rank $n$}\\
  H(\bullet,m) &= \mathbf{m} \quad\text{(the standard $m$-element set)}\\
  H([n],m) &= \emptyset
\end{align*}
The morphisms of graphs in the fibers of $K$ over $[n]$ act (by isomorphisms) on $\H(-,\G)$ in the obvious way.
If $m$ appears in the bracketing of $\G$, then the corresponding morphism $m\to\G$ in $K$ induces the map $H(\bullet,m) \to H(\bullet,\G)$ that picks out the corresponding $m$ edges incident to the root.
And as before, the $n$ morphisms $\bullet\to [n]$ in $J$ induce the maps $H([n],\G) \to H(\bullet,\G)$ selecting the edges incident to each vertex.

Let $T$ be the induced endo-2-functor of the 2-category $[J\op,\Cat]$ of \Cat-polygraphs. %, which we denote \cpg.
Note that as a parametric right adjoint, $T$ preserves connected limits, and in particular pullbacks.

We will now make $T$ into a monad.
For this purpose we 

We bracket this as $(1,1,\dots,1)$, so that we can send the $n$ morphisms $\bullet \to [n]$ to the $n$ morphisms $\star\to \C_n$ that pick out each of the edges.



Since $\hyrel$ is a conormal lax bicategory, with associativity up to isomorphism and unitality up to transformation, $T$ is similarly a \emph{conormal lax monad} with associativity up to isomorphism and unitality up to transformation.\fxnote{Incomplete}
Lax monads are perhaps not very familiar, but they are not much harder to deal with than pseudomonads.
In particular, we can define pseudoalgebras for any lax monad; the coherence axioms still make sense, and indeed force the noninvertible constraints of $T$ to become invertible in any pseudoalgebra.

\begin{defn}
  A $T$-pseudoalgebra is called a \textbf{double hypercategory}.
\end{defn}

A double hypercategory $H$ has the following structure:
\begin{itemize}
\item A set of \emph{objects}, the objects of the category $H(0)$.
\item A set of \emph{vertical arrows}, the arrows of $H(0)$, which can be composed in the usual way.
\item An (unbiased, non-strict) monoidal structure on the category of objects and vertical arrows.
\item For each $n,m$, a set of \emph{horizontal arrows} with lists of $n$ objects as source and $m$ objects as target (the objects of the category $H(n,m)$).
\item For each $n,m$, a set of \emph{2-cells} with horizontal arrows as ``vertical source and target'', and lists of $n$ vertical arrows and $m$ vertical arrows as ``horizontal source and target''.
  These can be composed vertically.
\item ``Horizontal composition'' operations on horizontal arrows and 2-cells, parametrized by bracketed hypergraphs.
  That is, if we label the non-root vertices of any rooted locally-ordered directed hypergraph by horizontal arrows of $H$, in such a way that the edges are labeled compatibly by objects, and bracket the incoming and outgoing edges to the root, then we obtain a composed horizontal arrow whose source and target are obtained by applying the monoidal structure on objects to the groups in the brackets.
  We can similarly compose hypergraphs labeled by 2-cells, and this operation is functorial with respect to vertical composition.
\item Moreover, isomorphisms of bracketed hypergraphs induce isomorphisms of composed horizontal arrows, naturally.
  In particular, this applies to \emph{automorphisms}.
\end{itemize}

\begin{defn}
  If a double hypercategory has only identity vertical arrows, we call it a \textbf{2-hypercategory}.
  If it additionally has only identity 2-cells, we call it a \textbf{hypercategory}.%
  \footnote{The word ``hypercategory'' was also used by~\cite{hmt:strict-n-hypercats,mt:omega-hypergraphs}.
    Our meaning is somewhat different, but not unrelated since they also use a kind of hypergraph.
    The ``hyperstructures'' of~\cite{baas:higher-structures} are also related, although in contrast to both of these references we consider here only one dimension of hyper-dependency.}
\end{defn}

\begin{eg}
  Let \bC be a symmetric monoidal category in which every object is equipped with the structure of a Frobenius algebra (but we do \emph{not} assume that all morphisms of \bC are monoid or comonoid homomorphisms).
  Then \bC has the structure of a hypercategory.
  In fact, it could be that this is exactly what a hypercategory is.
\end{eg}

\begin{eg}
  More generally, a sufficiently strictly monoidal 2-category in which every object has the structure of a Frobenius pseudomonoid~\cite{street:frob-psmon} gives rise to a 2-hypercategory.
  In particular, this applies to any cartesian bicategory~\cite{ckww:cartbicats-ii} in which every object is Frobenius~\cite{ww:frob-cart} and in which the monoidal structure is strict enough.

  In general, what can we take the vertical arrows to be?
  Arbitrary left adjoints?
  Morphisms that are colax for both monoid and comonoid structures?
\end{eg}

\begin{eg}
  If \bS has finite products, then an \bS-indexed monoidal category with indexed homotopy coproducts preserved by the tensor product on both sides, in the sense of~\cite{ps:indexed}, gives rise to a double hypercategory whose vertical category is \bS.
\end{eg}




\section{Virtual double hypercategories}
\label{sec:vdhc}

Our main purpose in defining the pseudomonad $T$ was to consider $T$-multicategories.
Leinster~\cite{leinster:higher-opds} defines $T$-multicategories with respect to a cartesian monad on any category with pullbacks.
Here we have only a pseudomonad on \cpg, but this causes little difficulty, especially since we are interested in the ``object-discrete'' case.

\begin{defn}
  A \textbf{virtual double hypercategory} $M$ consists of the following.
  \begin{enumerate}
  \item A polygraph $M_0$.
  \item A discrete fibration of \Cat-polygraphs $M_1 \to M_0 \times TM_0$.
  \item A composition operation $M_1 \times_{TM_0} TM_1 \to M_1$ over $1\times \mu$:
    \[
    \begin{tikzcd}
      M_1 \times_{TM_0} TM_1 \ar[r,dashed] \ar[d] & M_1\ar[d]\\
      M_0 \times TTM_0 \ar[r,"1\times \mu"'] & M_0\times TM_0.
    \end{tikzcd}
    \]
  \item A unit $M_0 \to M_1$ over $(1,\eta)$:
    \[
    \begin{tikzcd}
      M_0 \ar[r,dashed] \ar[d,equals] & M_1 \ar[d] \\
      M_0\ar[r,"{(1,\eta)}"'] & M_0\times TM_0.
    \end{tikzcd}
    \]
  \item An associativity isomorphism lying over the pseudomonad coherence isomorphism:
    \[\hspace{-2cm}
    \begin{tikzcd}
      & M_1 \times_{TM_0} TM_1 \ar[drr] \ar[ddd]\\
      M_1 \times_{TM_0} TM_1 \times_{TTM_0} TTM_1 \ar[ur] \ar[drr] \ar[ddd] \ar[rrr,phantom,"\cong"] &&&
      M_1 \ar[ddd] \\
      && M_1 \times_{TM_0} TM_1  \ar[ur]\ar[ddd]\\
      & M_0\times TTM_0\ar[drr] \\
      M_0 \times TTTM_0 \ar[ur] \ar[drr] \ar[rrr,phantom,"\cong"] &&&
      M_0\times TM_0 \\
      && M_0\times TTM_0\ar[ur]
    \end{tikzcd}\hspace{-2cm}
    \]
  \item Unit isomorphisms lying over the pseudomonad coherence isomorphisms:
    \[
    \begin{tikzcd}
      & M_1 \times_{TM_0} TM_1 \ar[dr] \ar[dddr,phantom,"\cong" very near start] \ar[dd] \\
      M_1 \ar[rr,equals] \ar[ur]\ar[dd] &~ & M_1\ar[dd]\\
      & M_0\times TM_0 \times TTM_0 \ar[dr] \ar[d,phantom,"\cong"] \\
      M_0\times TM_0 \ar[rr,equals]\ar[ur] &~& M_0\times TM_0
    \end{tikzcd}
    \]
    (There are two such isomorphisms, but the pictures look the same except that the omitted labels on the arrows should be different.)
  \end{enumerate}
\end{defn}

Since $M_1 \to M_0\times TM_0$ is assumed to be a discrete fibration, the coherence isomorphisms are unique, and automatically satisfy any axioms we might wish them to; thus we do not bother writing down those axioms (which would simply lift the corresponding pseudomonad axioms).
Explicitly, a virtual double hypercategory has the following structure.

\begin{enumerate}
\item A set of \emph{objects} (the objects of $M_0$).
\item A set of \emph{vertical multi-arrows}, with source a finite list of objects and target a single object (the objects of $M_1$).
  These can be composed as in an ordinary (non-symmetric) multicategory.
\item For each $n,m$, a set of \emph{horizontal arrows} with lists of $n$ objects as source and $m$ objects as target (the morphisms in the polygraph $M_0$).
\item A set of \emph{2-cells}, each of which has a bracketed hypergraph labeled by horizontal arrows as its vertical source, a single horizontal arrow as its vertical target, and lists of vertical multi-arrows as its horizontal source and target.
\item Each horizontal arrow has an identity 2-cell.
\item A composition operation on 2-cells that involves hypergraph insertion, which is appropriately associative and unital.
\end{enumerate}

We also have algebras over generalized multicategories, for which again we restrict to the discrete case.
Here there is no room for nontrivial isomorphisms at all.

\begin{defn}
  If $M$ is a virtual double hypercategory, an \textbf{$M$-algebra} consists of the following.
  \begin{enumerate}
  \item A polygraph $A$ with a map $A \to M_0$.
  \item An action map $M_1 \times_{TM_0} TA \to A$ over $M_0$.
  \item The action is associative and unital:
    \[\hspace{-2cm}
    \begin{tikzcd}
      M_1 \times_{TM_0} TM_1 \times_{TTM_0} TTA \ar[r] \ar[d] &M_1 \times_{TM_0} TA \ar[d]\\
      M_1 \times_{TM_0} TA \ar[r] & A
    \end{tikzcd}
    \qquad
    \begin{tikzcd}
      A \ar[r] \ar[dr,equals] & M_1 \times_{TM_0} TA\ar[d] \\ & A
    \end{tikzcd}\hspace{-2cm}
    \]
  \end{enumerate}
\end{defn}


\section{Undirected hypercategories and kits}
\label{sec:kits}

Can define similar monad using undirected hypergraphs.
The virtual undirected ones are a special case of directed virtual ones in which all sources are empty.
Kits should be a virtual undirected ones living over a ``shape'' one that marks variance.


\section{Type theory of virtual double hypercategories}
\label{sec:type-theory}

We adopt a ``type-theoretic rule'' notation for 2-cells in virtual double hypercategories.
To describe a labeled hypergraph, we assign a variable to each edge, and declare the variables as having the corresponding objects as ``types'' with their genera as annotations on the typing declaration, for instance
\begin{mathpar}
  x :^0 p \and y:^1 p \and z:^0 q
\end{mathpar}
where $p,q,r$ are objects of $M$.
In practice the genera will almost always be $0$, in which case we omit to notate them.
We notate the vertices as sequents with their labeling horizontal arrow as a term, and with their incident edges as the input and output variables:
\begin{mathpar}
  (x,y,x) \types \alpha: (x,z) \and
  (z,z,y) \types \beta:()
\end{mathpar}
Thus, we must have $\alpha:(p,p,p) \to (p,q)$ and $\beta : (q,q,p) \to ()$.
These declarations all occur in the ``premises''.
Finally, we treat vertical multi-arrows as function symbols and ``apply'' them to the variables denoting the corresponding edges, then place the resulting terms in a ``conclusion'' sequent, labeled again by a horizontal arrow:
\begin{mathpar}
  (F(x,y),x) \types \gamma : (z,G())
\end{mathpar}
For vertical identity arrows, we simply write the variable itself, i.e.\ $x$ means $1_p(x)$ and $z$ means $1_q(z)$.
If $F:(p,p)\to q$ and $G:() \to p$, then we must have $\gamma : (q,p) \to (q,p)$.
Putting the above examples together, we obtain the rule
\begin{mathpar}
  \inferrule{x :^0 p \\ y:^1 p \\ z:^0 q \\
    (x,y,x) \types \alpha: (x,z) \\ (z,z,y) \types \beta:()}
  {(F(x,y),x) \types \gamma : (z,G())}
\end{mathpar}
which corresponds to the following graphically drawn 2-cell:
\begin{center}
  \begin{tikzpicture}
    \node[houter] (Fxy) at (.5,0) {};
    \node[houter] (idx) at (2,-1) {};
    \node[vertex] (gm) at (5.5,-.5) {$\gamma$};
    \node[houter] (idz) at (9,0) {};
    \node[houter] (G) at (10,-1) {};
    \draw[edge] (Fxy) -- (gm);
    \draw[edge] (idx) -- (gm);
    \draw[edge] (gm) -- (idz);
    \draw[edge] (gm) -- (G);
    \node[kite,draw,inner sep=1pt] (Gin) at (10,1) {$G$};
    \draw[->] (Gin) -- (G);
    \node[houter] (zout) at (9,3) {};
    \draw[double,double equal sign distance] (zout) -- (idz);
    \node[houter] (xin) at (2,2) {};
    \draw[double,double equal sign distance] (xin) -- (idx);
    \node[houter] (xyinx) at (0,3) {};
    \node[houter] (xyiny) at (1,2.5) {};
    \node[kite,draw,inner sep=1pt] (F) at (.5,1.5) {$F$};
    \draw (xyinx) -- (F);
    \draw (xyiny) -- (F);
    \draw[->] (F) -- (Fxy);
    \node[vertex] (be) at (8,2) {$\beta$};
    \node[vertex] (al) at (6,3) {$\alpha$};
    \coordinate (x) at (3.5,3);
    \coordinate (y) at (3.5,2);
    \draw[edge] (xyinx) to[out=0,in=180] node[auto] {$p$} (x);
    \draw[edge] (xin) to[out=0,in=180] (x);
    \draw[cross] (xyiny) to[out=0,in=180] (y);
    \draw[edge] (xyiny) to[out=0,in=180] node[auto,swap,very near end] {$p$} (y);
    \draw[edge] (x) to[out=0,in=120] (al);
    \draw[edge] (x) to[out=0,in=-120] (al);
    \coordinate (y2) at (4.5,2);
    \draw[cross] (y2) to[out=0,in=-180] (al);
    \draw[edge] (y2) to[out=0,in=-180] (al);
    \draw (y) to[out=0,in=180] (4,2.2) to[out=0,in=180] (y2);
    \draw (y) to[out=0,in=180] (4,1.8) to[out=0,in=180] (y2);
    \draw[edge] (al) to[out=30,in=0] (4,4) to[out=180,in=180,looseness=2] (x);
    \coordinate (z) at (7,2.5);
    \draw[edge] (al) to[out=-30,in=180] (z);
    \draw[edge] (z) to[out=0,in=120] (be);
    \draw[edge] (z) to[out=0,in=180] (be);
    \draw[edge] (y2) to[out=0,in=-150] (be);
    \draw[edge] (z) to[out=0,in=-180] node[auto] {$q$} (zout);
    \node at (5.5,1) {$\Downarrow$};
  \end{tikzpicture}
\end{center}

Identity 2-cells are easy:
\[ \inferrule{ (x,y,z) \types \alpha : (u,v,w) }{ (x,y,z) \types \alpha : (u,v,w) }\]
Composition of 2-cells is, thankfully, well-notated by combining rules in derivation trees, and \emph{substituting} the terms such as $F(x,y)$ in the conclusion of one rule into the variables occurring in the premises of another.
We do have to be careful that the vertical arrow parts match up between all the 2-cells we are precomposing with.
\fxnote{Some examples?}

It is important to note that when we write a 2-cell as a ``rule'' we are not ``deriving the conclusion from the premises''.
Instead each ``rule'' is a datum, namely the 2-cell, and putting together rules into derivation trees is an operation on these data.

When we get to \emph{$M$-algebras}, however, the rules become operations on sequents.
Here we notate the objects lying over an object $p$ by
\[A \type_p \qquad\text{or}\qquad A_p,\]
and the morphisms lying over $\alpha : (p,q,r) \to (u,v)$ by
\[(A_p,B_q,C_r) \types_\alpha f : (D_u,E_v).\]
Now the 2-cell considered above \emph{acts} on morphisms in the algebra, which we can interpret as a rule of the usual sort that produces a conclusion from the premises:
\begin{mathpar}
  \inferrule{A \type_p \\ B \type^1_p \\ C \type_q \\\\
    (A,B,A) \types_\alpha f : (A,C) \\ (C,C,B) \types_\beta g :()}
  {(F(A,B),A) \types_\gamma g\circ_\rho f : (C,G())}
\end{mathpar}
where $g\circ_\rho f$ denotes a sort of ``composition'' of $f$ and $g$ parametrized by the rule $\rho$.
Note that the vertical arrows $F$ and $G$ act similarly on \emph{types}, which we can notate with type formation rules:
\begin{mathpar}
  \inferrule{A\type_p \\ B\type_p}{F(A,B) \type_q}
  \and
  \inferrule{ }{G() \type_p}
\end{mathpar}

In this way, we can interpret a virtual double hypercategory as a reasonably general sort of \emph{specification of a sequent calculus}.
The objects are the \emph{modes} to which the types can belong.
The horizontal arrows are the \emph{mode morphisms}, or \emph{sequent forms}.
The vertical arrows are the \emph{type formation rules}.
And the 2-cells are the \emph{derivation rules} for sequents.
Each derivation rule takes as premises some number of types, each with a specified mode, and some number of sequents containing those types, each with a specified form, and yields as a conclusion a sequent with a specified form containing some of the types from the premises together with potentially other new types formed from them by the formation rules.
We call this a ``sequent calculus'' because the type formation operators can only appear in the conclusion; all types in the premises must be (meta-)variables.

Note that all the contraction, weakening, composition, and identities are performed formally in the vertical domain.
We contract two types by making the corresponding flags incident on the same edge, and so on.
In the type-theoretic notation, this is indicated by using the same (meta-)variable for the types in the corresponding places.
Even the symmetric action (exchange) is performed formally in the domain, since the incoming and outgoing edges on the root are ordered, and the vertical multi-arrows preserve ordering --- but this ordering is not visible in the premises of the type-theoretic notation, instead being indicated by the order in which the (meta-)variables appear in the conclusion.

The fact that vertical arrows and 2-cells have an algebraic structure of composition means that all \emph{derivable} rules are present on an equal footing with the primitive ones, along with all equations that hold between such derivations.
The primitive rules and primitive equality axioms between composites of these form a \emph{presentation} of a virtual double hypercategory by generators and relations.


\section{Examples}
\label{sec:examples}

For now, we consider only examples without type formation rules.

\subsection{Intuitionistic type theories}
\label{sec:intuitionistic}

We obtain intuitionistic type theories simply by requiring all mode morphisms to have unary targets.
If we have one mode $p$ and one such morphism $p^n \to p$ for each $n$, we can express the identity and cut rules of ordered logic:
\begin{mathpar}
  \inferrule{A\type}{A\types A}
  \and
  \inferrule{\Gamma\types A \\ \Delta,A,\Psi\types B}{\Delta,\Gamma,\Psi\types B}
\end{mathpar}
We can assert axioms on the composites of these to obtain the semantic structure of a non-symmetric multicategory.

We can then add the exchange rule of intuitionistic linear logic:
\begin{mathpar}
  \inferrule{\Gamma,A,B,\Delta\types C}{\Gamma,B,A,\Delta\types C}
\end{mathpar}
with axioms yielding a symmetric multicategory.

\subsection{Flavors of operad}
\label{sec:operads}

All of these use only binary directed graphs.
A summary is in~\cite{bb:htapm}.

Directed sorts:
\begin{itemize}
\item Wheeled props~\cite{mms:wheeled-props} use arbitrary directed graphs.
\item Props use directed graphs with no directed loops.
\item Properads~\cite{vallette:properads} use connected directed graphs with no directed loops.
\item Wheeled properads use arbitrary connected directed graphs.
\item Dioperads~\cite{gan:dioperads} / polycategories~\cite{szabo:polycats,koslowski:polycats,garner:polycats} have no directed loops and are connected and simply connected (no undirected loops either), or equivalently contractible.~\cite{markl:operads-props}
\item Symmetric operads/multicategories use arbitrary directed trees.
\item Non-symmetric operads/multicategories use planar directed trees.
\end{itemize}

Undirected sorts:
\begin{itemize}
\item Cyclic operads~\cite{gk:cyclic-operads} use undirected trees; compare to~\cite{co:flang-cyclic}.
\item Modular operads~\cite{gk:modular-operads} use arbitrary connected graphs (plus a ``stability'' condition).
\item Compact symmetric multicategories~\cite{jk:feynman} use arbitrary graphs.
  This is a somewhat misleading name as it doesn't indicate that the objects are actually \emph{self-}dual (the undirectedness).
\end{itemize}

\bibliography{../all.bib}
\bibliographystyle{alpha}

\end{document}


\newcommand\mor[3]{\ensuremath{#2} \longrightarrow_#1 #3}
\newcommand\C{\ensuremath{\mathcal{C}}}
\newcommand\D{\ensuremath{\mathcal{D}}}
\newcommand\E{\ensuremath{\mathcal{E}}}
\newcommand\deq{\ensuremath{\equiv}}
\newcommand\seq[3]{\ensuremath{#1 \vdash_{#2} #3}}
\newcommand\F[2]{\ensuremath{\dsd{F}_{#1}(#2)}}
\newcommand\U[3]{\ensuremath{\dsd{U}_{#1}(#2 \mid #3)}}
\newcommand\Fsymb[0]{\dsd{F}}
\newcommand\Usymb[0]{\dsd{U}}
\newcommand\tsubst[2]{\ensuremath{#1[#2]}}
\renewcommand\subst[3]{\ensuremath{#1[#2/#3]}}
\newcommand\wftype[2]{\ensuremath{#1 \: \dsd{type}_{#2}}}
\renewcommand\wfctx[2]{\ensuremath{#1 \: \dsd{ctx}_{#2}}}
\newcommand\modeof[1]{\ensuremath{\hat{#1}}}
\newcommand\many[1]{\ensuremath{\overline{#1}}}
\renewcommand{\oftp}[3]{\ensuremath{#1 \, \vdash #2 \, \dcd{:} \, #3}}
\newcommand\FL{\dsd{FL}}
\newcommand\FR{\dsd{FR}}
\newcommand\UL{\dsd{UL}}
\newcommand\UR{\dsd{UR}}

\section{1-Multicategories}

\subsection{Syntax for Cartesian Multicategories}
In an ordinary category, each morphism has a single object as both its
domain and its range.  In a \emph{multicategory}, each morphism has a
list of objects as its domain, and a single object as its range.  In a
\emph{cartesian multicategory}, these multiple objects in the domain are
treated like cartesian (structural) variables. So for a cartesian
multicategory \C\/ we will describe a morphism
\[
\alpha \in \mor{\C}{p_1,\ldots,p_n}{q}
\]
by a term with variables $x_i:p_i$ free, built from generating constants
\dsd{c}:
\[
\begin{array}{llll}
\text{modes} & p & & (constants) \\
\text{mode contexts} & \psi & ::= & \cdot \mid \psi,\tptm{x}{p} \\
\text{mode morphisms} & \alpha,\beta & ::= & x \mid \dsd{c}(\alpha_1,\ldots,\alpha_n) \\
\text{mode substitutions} & \gamma,\delta & ::= & \cdot \mid \gamma,\alpha/x\\
\end{array}
\]
We write $\oftp{\psi}{\alpha}{q}$ for mode morphism well-formedness;
$\psi$ here enjoys (cartesian) structural properties (weakening,
exchange, contraction).  We write $\oftp{\psi}{\gamma}{\psi'}$ for a
familiar structural substitution in the mode multicategory, which
consists of a term $\alpha_i/x_i$ for each variable $\tptm{x_i}{p_i}$ in
$\psi'$, where each $\alpha_i$ satisfies $\oftp{\psi}{\alpha_i}{p_i}$.
Simultaneous substitution into terms is defined in the standard way.

The multicategories needed for this section can be presented by giving a
signature for the constants \dsd{c}, together with some generating
axioms $\deqtm{\psi}{\alpha}{\beta}{q}$ for two mode morphisms
\oftp{\psi}{\alpha,\beta}{q}.  The set of morphisms is defined to be the
quotient of the above terms by the least congruence containing these
generating equations.

\subsection{Logic over a Multicategory}

The rules for the logic are given in Figure~\ref{fig:1logic}.  

explain intended structural properties

For $\FL$, there are two competing principles: making the rules
obviously structural, and reducing inessential non-determinism.  Here,
we choose the later, and treat the assumption of \F{\alpha}{\Delta}
affinely, removing it from the context when it is used.  It will turn
out that the judgement nonetheless enjoys contraction (over
contraction), because contraction for negatives is built in, and
contraction for positives follows from this and the fact that we can
always reconstruct a positive from what it decays to on the left
(c.f. how purely positive formulas have contraction in linear logic).  

\begin{figure}
\[
\begin{array}{c}
\begin{array}{llll}
\text{Types} & A & ::= & P \mid \F{\alpha}{\Delta} \mid \U{\alpha}{\Delta}{A} \\
\end{array}
\\ \\
\framebox{\wftype{A}{p}}
\\ \\
\infer{\wftype{P}{p}}{\text{(declared in signature)}}
\qquad
\infer{\wftype{\F{\alpha}{\Delta}}{q}}
      {\oftp{\psi}{\alpha}{q} &
        \wfctx{\Delta}{\psi}}
\\ \\
\infer{\wftype{\U{x.\alpha}{\Delta}{A}}{q}}
      {\oftp{\psi,x:q}{\alpha}{p} &
        \wfctx{\Delta}{\psi} &
        \wftype{A}{p}
      }
\\ \\
\framebox{\wfctx{\Gamma}{\psi}}
\\ \\
\infer{\wfctx{\cdot}{\cdot}}{}
\qquad
\infer{\wfctx{\Delta,x:A}{\psi,x:p}}
      {\wfctx{\Delta}{\psi} &
        \wftype{A}{p}}
\\ \\
\framebox{\seq{\Gamma}{\alpha}{A}}
\\ \\
\infer[\dsd{v}]{\seq{\Gamma}{\beta}{P}}
      {x:P \in \Gamma & \beta \equiv x}
\\ \\
\infer[\FR]{\seq{\Gamma}{\beta}{\F{\alpha}{\Delta}}}
      {%% \modeof{\Gamma} \vdash \gamma : \modeof{\Delta} & 
        \beta \deq \tsubst{\alpha}{\gamma} &
        \seq{\Gamma}{\gamma}{\Delta} 
      }
\quad
\infer[\FL]{\seq{\Gamma,x:\F{\Delta}{A},\Gamma'}{\beta}{C}}
      {\seq{\Gamma,\Gamma',\Delta}{\subst \beta {\alpha}{x}}{C}}
%% \infer{\seq{\Gamma}{\beta}{C}}
%%       {{x}:{\F{\alpha}{\Delta}} \in \Gamma & 
%%         \oftp{\modeof{\Gamma},{x'} : {\modeof{\F{\alpha}{\Delta}}}}{\beta'}{\modeof{C}} &
%%         \beta \deq \tsubst{\beta'}{x/x'} &
%%         \seq{\Gamma,\Delta}{\subst {\beta'} {\alpha}{x'}}{C}}
\\ \\
\infer[\UR]{\seq{\Gamma}{\beta}{\U{x.\alpha}{\Delta}{A}}}
      {\seq{\Gamma,\Delta}{\subst{\alpha}{\beta}{x}}{A}}
\\ \\
\infer[\UL]{\seq{\Gamma}{\beta}{C}}
      {x:\U{x.\alpha}{\Delta}{A} \in \Gamma & 
        \beta \deq \subst{\beta'}{\tsubst{\alpha}{\gamma}}{z} &
        \seq{\Gamma}{\gamma}{\Delta} &
        \seq{\Gamma,\tptm{z}{A}}{\beta'}{C}
      }
\\ \\
\framebox{\seq{\Gamma}{\gamma}{\Delta}}
\\ \\
\infer[\cdot]{\seq{\Gamma}{\cdot}{\cdot}}
      {}
\qquad
\infer[\_,\_]{\seq{\Gamma}{\gamma,\alpha/x}{\Delta,x:A}}
      {\seq{\Gamma}{\gamma}{\Delta} &
       \seq{\Gamma}{\alpha}{A}
      }
\end{array}
\]    
\caption{1-Multicategorical Logic}
\label{fig:1logic}
\hrule
\end{figure}

\subsection{Examples}

\subsubsection{Non-associative Logic}

\subsubsection{Ordered Logic}

\subsubsection{Linear Logic}

\subsubsection{Relevant Logic}

\subsubsection{``Non-cartesian BI''} Two monoids

\subsubsection{Adjoint Logic} Non-tensor-preserving left adjoint

\subsubsection{Zero-use variables}

\subsubsection{Multi-use variables}

\subsection{Properties}

Define the \emph{size} of a derivation of \seq{\Gamma}{\alpha}{A} or
\seq{\Gamma}{\gamma}{\Delta} to be the number of inference rules for
these judgements $(\dsd{v},\FL, \FR, \UL, \UR,
\cdot, \_,\_)$ used in it (i.e., the evidence that variables are in a
context and the evidence for equations does not contribute to the size).
Sizes are necessary for the cut proof, where we sometimes weaken or
invert a derivation before applying the inductive hypothesis.

\begin{lemma}[Respect for Equality] ~ \label{lemma:respecteq}
\begin{enumerate}
\item If \seq{\Gamma}{\beta}{A} and $\beta' \deq \beta$ then
\seq{\Gamma}{\beta'}{A}, and the resulting derivation has the same size
as the given one.
\item If \seq{\Gamma}{\gamma}{\Delta} and $\gamma' \deq \gamma$ then
  \seq{\Gamma}{\gamma'}{\Delta}, and the resulting derivation has the
  same size as the given one.
\end{enumerate}
\end{lemma}
\begin{proof}
Mutual induction on the given derivation.  The cases for \dsd{v} and
$\FR$ and $\UL$ are immediate (with no use of the inductive
hypothesis) by composing with the equality in the premise of the rule.
The cases for $\FL$ and $\UR$ use the inductive hypothesis,
along with congruence for equality of mode morphism to show that
$\subst{\beta}{\alpha}{x} \deq \subst{\beta'}{\alpha}{x}$ or
$\subst{\alpha}{\beta}{x} \deq \subst{\alpha}{\beta'}{x}$.  The cases
for substitutions rely on the fact that no generating equalities for
mode substitutions are allowed, so if $\gamma' \deq \cdot$ then
$\gamma'$ is literally $\cdot$, and $(-,-)$ is injective (if $\gamma'
\deq (\gamma_1,\alpha_2/x)$, then $\gamma'$ is $(\gamma_1',\alpha_2'/x)$
with $\gamma_1' \deq \gamma_1$ and $\alpha_2' = \alpha_2$); this is
enough to use the inductive hypotheses in the cons case.  
\end{proof}

\begin{lemma}[Weakening over weakening] \label{thm:weakening} ~
\begin{enumerate}
\item If \seq{\Gamma,\Gamma'}{\alpha}{C} then
\seq{\Gamma,\tptm{z}{A},\Gamma'}{\alpha}{C}, and the resulting
derivation has the same size as the given one.  
\item If \seq{\Gamma,\Gamma'}{\gamma}{\Delta} then
\seq{\Gamma,\tptm{z}{A},\Gamma'}{\gamma}{\Delta}, and the resulting
derivation has the same size as the given one.  
\item If \seq{\Gamma,\Gamma''}{\alpha}{C} then
\seq{\Gamma,\Gamma',\Gamma''}{\alpha}{C}, and the resulting
derivation has the same size as the given one.  
\end{enumerate}
\end{lemma}
\begin{proof}
It is implicit that the mode morphism $\alpha$ is weakend with $z$ in
the conclusion.  Intuitively, weakening holds because the contexts
$\Gamma$ are treated like ordinary structural contexts in all of the
rules---they are fully general in every conclusion, and the premises
check membership or extend them---and because weakening holds for mode
morphisms and equalities of mode morphisms.  Formally, the first two
parts are proved by mutual induction; each case is either immediate
or follows from weakening for the mode morphisms, weakening for
equalities of mode morphisms, and the inductive hypotheses.  The third
part is proved by induction over $\Gamma'$, repeatedly applying the
first part.  
%% The case for the hypothesis rule is immediate, because
%% $\Gamma$ may contain variables other than $x$.  The case for
%% \Fsymb-right follows from weakening for the mode morphisms, and
%% equations between mode morphisms, and the inductive hypothesis for
%% substitutions.  The case for \Fsymb-left follows from the inductive
%% hypothesis, as does the case for \Usymb-right.  
\end{proof}

\begin{lemma}[Exchange over exchange]
If \seq{\Gamma,x:A,y:B,\Gamma'}{\alpha}{C} then
\seq{\Gamma,y:B,x:A,\Gamma'}{\alpha}{C}, and the resulting derivation
has the same size as the given one.  (And similarly for substitutions,
and exchange can be iterated).  
\end{lemma}
\begin{proof} Analogous to weakening.  
\end{proof}

\begin{theorem}[Identity] ~
\begin{enumerate}
\item If $x:A \in \Gamma$ then $\seq{\Gamma}{x}{A}$.
\item If $\oftp{\modeof{\Gamma}}{\rho}{\modeof{\Delta}}$ is a
  variable-for-variable mode substitution such that $x:A \in \Delta$
  implies $\rho(x) : A \in \Gamma$, then $\seq{\Gamma}{\rho}{\Delta}$.
\end{enumerate}
\end{theorem}

\begin{proof}
The standard proof by induction on $A$ (mutually with $\Delta$) applies:
the case for atomic propositions is a rule, and for the other
connectives, apply the invertible and then non-invertible rule to reduce
the problem to the inductive hypotheses.  More specifically, identity
for $P$ is a rule.  In the case for \F{\alpha}{\Delta}, with $\Gamma =
\Gamma_1,x:\F{\alpha}{\Delta},\Gamma_2$, we reduce it to the inductive
hypothesis as follows:
\[
\infer[\FL]{\seq{\Gamma_1,x:\F{\alpha}{\Delta},\Gamma_2}{x}{\F{\alpha}{\Delta}}}
      {\infer[\FR]{\seq{\Gamma_1,\Gamma_2,\Delta}{\alpha}{\F{\alpha}{\Delta}}}
                        {\alpha \deq \tsubst{\alpha}{\vec{x/x}} &
                        \seq{\Gamma_1,\Gamma_2,\Delta}{\vec{x/x}}{\Delta}
                        }}
\]
In the second premise, the $\vec{x/x}$ substitution for each $x \in
\Delta$ is a variable-for-variable substitution, so the second part of
the inductive hypothesis applies.  
The case for \Usymb\/ is similar
\[
\infer[\UR]{\seq{\Gamma}{x}{\U{\alpha}{\Delta}{A}}}
      {\infer[\UL]{\seq{\Gamma,\Delta}{\alpha}{A}}
                        {\alpha \deq \subst{x}{\tsubst{\alpha}{\vec{x/x}}}{x} &
                        \seq{\Gamma,\Delta}{\vec{x/x}}{\Delta} &
                        \seq{\Gamma,x:A}{x}{A}
                        }}
\]

For the second part, the hypothesis of the lemma asks that every
variable in $\Delta$ is associated by $\rho$ with a variable of the same
type in $\Gamma$; this is enough to iterate the first part of the
lemma for each position in $\Delta$.  Specifically, the case where
$\Delta$ is the empty context $\cdot$ is a rule. In the case for a cons
$\Delta,y:A$, we have
\oftp{\modeof{\Gamma}}{\rho}{(\modeof{\Delta},y:\modeof{A})} which means
$\rho$ must be of the form $\rho',x/y$ where $x \in \modeof{\Gamma}$ and
$\rho'$ is a variable-for-variable substitution.  Because $\rho$ was
type-preserving, $x : A \in \Gamma$ and $\rho'$ is type-preserving, so
we obtain the result from the inductive hypotheses as follows:
\[
\infer{\seq{\Gamma}{\rho,x/y}{\Delta,y:A}}
      {\seq{\Gamma}{\rho}{\Delta} & 
       \seq{\Gamma}{x}{A}
      }
\]
\end{proof}

\begin{lemma}[Left-invertibility of \Fsymb] \label{lemma:Finv}
If $\D :: \seq{\Gamma_1,x_0:\F{\alpha_0}{\Delta_0},\Gamma_2}{\beta}{C}$
and then there is a derivation $D' ::
\seq{\Gamma_1,\Gamma_2,\Delta_0}{\subst{\beta}{\alpha_0}{x_0}}{C}$ and
$size(\D') \le size(\D)$ (and analogously for substitutions).
\end{lemma}

\begin{proof}
By induction on \D.  We write $\Gamma$ for
the whole context $\Gamma_1,x_0:\F{\alpha_0}{\Delta_0},\Gamma_2$.

In the case for \dsd{v}, $x : P \in
\Gamma_1,x_0:\F{\alpha_0}{\Delta_0},\Gamma_2$ cannot be equal to $x_0 :
\F{\alpha_0}{\Delta_0}$ because the types conflict, so we can reapply
the \dsd{v} rule in $\Gamma_1,\Gamma_2,\Delta$.

In the case for $\FR$, we have
\[
\infer{\seq{\Gamma}{\beta}{\F{\alpha}{\Delta}}}
      {\beta \deq \tsubst{\alpha}{\gamma} &
        \seq{\Gamma}{\gamma}{\Delta} 
      }
\]
with $x_0 : \F{\alpha_0}{\Delta_0} \in \Gamma$.  By the inductive
hypothesis we get
\seq{\Gamma_1,\Gamma_2,\Delta_0}{\subst{\gamma}{\alpha_0}{x}}{\Delta}.  Because
$x_0$ is not free in $\alpha$,
$\subst{(\tsubst{\alpha}{\gamma})}{\alpha_0}{x_0} =
\tsubst{\alpha}{\subst{\gamma}{\alpha_0}{x_0}}$, so we can reapply \FR:
\[
\infer{\seq{\Gamma_1,\Gamma_2}{\subst{\beta}{\alpha_0}{x_0}}{\F{\alpha}{\Delta}}}
      {{\subst{\beta}{\alpha_0}{x_0}} \deq \tsubst{\alpha}{\subst{\gamma}{\alpha_0}{x_0}} &
        \seq{\Gamma_1,\Gamma_2,\Delta_0}{\subst{\gamma}{\alpha_0}{x}}{\Delta}
      }
\]
Both the input and the output have size 1 more than the size of their
subderivations, and the output subderivation is no bigger than the input
by the inductive hypothesis.

In the case for $\FL$
\[
\infer[\FL]{\seq{\Gamma_1',x:\F{\alpha}{\Delta},\Gamma_2'}{\beta}{C}}
      {\deduce{\seq{\Gamma_1',\Gamma_2',\Delta}{\subst \beta {\alpha}{x}}{C}}{\D}}
\]
with $\Gamma_1,x_0 : \F{\alpha_0}{\Delta_0},\Gamma_2 =
\Gamma_1',x:\F{\alpha}{\Delta},\Gamma_2'$, we distinguish cases on
whether $x = x_0$ or not.  If they are the same (i.e. we have hit a left
rule on $x_0$), then $\alpha_0 = \alpha$ and $\Delta_0 = \Delta$ and
\D\/ is the result, and the size is 1 less than the size of the input.
If they are different, then (because $x_0$ is somewhere in
$\Gamma_1',\Gamma_2'$) by the inductive hypothesis we have a derivation
\[
\D' :: {\seq{(\Gamma_1',\Gamma_2')-x_0,\Delta,\Delta_0}{\subst{\subst \beta {\alpha}{x}}{\alpha_0}{x_0}}{C}}
\]
that is no bigger than \D.  Because $x_0$ is from $\Gamma$ and not
$\Delta$, it does not occur in $\alpha$, so 
\[
{\subst{\subst \beta {\alpha}{x}}{\alpha_0}{x_0}} = 
{\subst{\subst \beta {\alpha_0}{x_0}}{\alpha}{x}}
\]
By (iterating) exchange, we get a derivation 
\[
\D'' :: {\seq{(\Gamma_1',\Gamma_2')-x_0,\Delta_0,\Delta}{\subst{\subst \beta {\alpha_0}{x_0}}{\alpha}{x}}{C}}
\]
whose size is the same as $\D'$ and so no bigger than $\D$.  Applying
$\FL$ to $\D''$ (using the fact that
$(\Gamma_1',x:\F{\alpha}{\Delta},\Gamma_2')-x_0 = \Gamma_1,\Gamma_2$)
derives $\seq{\Gamma_1,\Gamma_2}{\subst{\beta}{\alpha_0}{x_0}}{C}$, and
the size is no bigger than the size of the input.

In the case for $\UR$,
\[
\infer{\seq{\Gamma}{\beta}{\U{x.\alpha}{\Delta}{A}}}
      {\seq{\Gamma,\Delta}{\subst{\alpha}{\beta}{x}}{A}}
\]
the inductive hypothesis gives a
$\D' :: \seq{\Gamma_1,\Gamma_2,\Delta,\Delta_0}{\subst{\subst{\alpha}{\beta}{x}}{\alpha_0}{x_0}}{A}$
and (iterated) exchange gives 
$\D'' ::
\seq{\Gamma_1,\Gamma_2,\Delta_0,\Delta}{\subst{\subst{\alpha}{\beta}{x}}{\alpha_0}{x_0}}{A}$,
both no bigger than \D.  Because $x_0$ is in $\Gamma$ and not $\Delta$,
it is not free in $\alpha$, so 
\[
{\subst{\subst{\alpha}{\beta}{x}}{\alpha_0}{x_0}} = {\subst{\alpha}{\subst{\beta}{\alpha_0}{x_0}}{x}}
\]
Thus, we can derive
\[
\infer{\seq{\Gamma_1,\Gamma_2,\Delta_0}{\subst{\beta}{\alpha_0}{x_0}}{\U{x.\alpha}{\Delta}{A}}}
      {\deduce{\seq{\Gamma_1,\Gamma_2,\Delta_0,\Delta}{\subst{\alpha}{\subst{\beta}{\alpha_0}{x_0}}{x}}{A}}{\D''}}
\]

In the case for $\UL$, 
\[
\infer{\seq{\Gamma}{\beta}{C}}
      {x:\U{x.\alpha}{\Delta}{A} \in \Gamma & 
        \beta \deq \subst{\beta'}{\tsubst{\alpha}{\gamma}}{z} &
        \seq{\Gamma}{\gamma}{\Delta} &
        \seq{\Gamma,\tptm{z}{A}}{\beta'}{C}
      }
\]
we know that $x$ is different that $x_0$ because the types conflict.
The inductive hypotheses give no-bigger derivations of
\[
\seq{\Gamma_1,\Gamma_2\Delta_0}{\subst{\gamma}{\alpha_0}{x_0}}{\Delta} \qquad \seq{\Gamma_1,\Gamma_2,\tptm{z}{A},\Delta_0}{\subst{\beta'}{\alpha_0}{x_0}}{C}
\]
and the latter can be exchanged to
\[
\seq{\Gamma_1,\Gamma_2,\Delta_0,\tptm{z}{A}}{\subst{\beta'}{\alpha_0}{x_0}}{C}
\]
again without increasing the size.  Thus, we can produce
\[
\infer{\seq{\Gamma_1,\Gamma_2,\Delta_0}{\subst{\beta}{\alpha_0}{x}}{C}}
      {\begin{array}{l}
          x:\U{x.\alpha}{\Delta}{A} \in \Gamma_1,\Gamma_2,\Delta_0 \\
          {\subst{\beta}{\alpha_0}{x}} \deq \subst{{\subst{\beta'}{\alpha_0}{x_0}}}{\tsubst{\alpha}{{\subst{\gamma}{\alpha_0}{x_0}}}}{z}\\
          \seq{\Gamma_1,\Gamma_2,\Delta_0}{\subst{\gamma}{\alpha_0}{x_0}}{\Delta} \\
          \seq{\Gamma_1,\Gamma_2,\Delta_0,\tptm{z}{A}}{\subst{\beta'}{\alpha_0}{x_0}}{C}
        \end{array}
      }
\]
where equality is the composition of the \subst{-}{\alpha_0}{x_0}
substitution into the given equality, and rearranging the substitution
(note that $x_0$ does not occur in $\alpha$):
\[
\begin{array}{ll}
\subst{\beta}{\alpha_0}{x_0} & \deq
\subst{\subst{\beta'}{\tsubst{\alpha}{\gamma}}{z}}{\alpha_0}{x_0} 
= 
\subst{\subst{\beta'}{\alpha_0}{x_0}}{\subst{\tsubst{\alpha}{\gamma}}{\alpha_0}{x_0}}{z}
\\
& =
\subst{\subst{\beta'}{\alpha_0}{x_0}}{\tsubst{\alpha}{\subst{\gamma}{\alpha_0}{x_0}}}{z} 
\end{array}
\]

The case for $\cdot$ is immediate.  The case for $\_,\_$ follows from
the two inductive hypotheses, because
$\subst{(\gamma,\alpha/x)}{\alpha_0}{x_0} =
{(\subst{\gamma}{\alpha_0}{x_0},\subst{\alpha}{\alpha_0}{x_0}/x)}$.
\end{proof}


\begin{theorem}[Cut] ~
\begin{enumerate} 
\item  If $\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}$ and $\seq{\Gamma,x_0:A_0,\Gamma'}{\beta}{B}$ 
then $\seq{\Gamma,\Gamma'}{\beta[\alpha_0/x_0]}{B}$ 
\item If $\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}$ and $\seq{\Gamma,x_0:A_0,\Gamma'}{\gamma}{\Delta}$ 
then $\seq{\Gamma,\Gamma'}{\gamma[\alpha_0/x_0]}{\Delta}$ 
\item If $\seq{\Gamma}{\gamma}{\Delta}$ and 
\seq{\Gamma,\Delta}{\beta}{C}
then \seq{\Gamma}{\tsubst{\beta}{\gamma}}{C}.  
\end{enumerate}
\end{theorem}

\begin{proof}
Induction ordering: Part 1 and 2: cut formula, then simultaneous on the
size of \D\/ and \E\/.  Part 3:

Part 1: There are 5 rules, so 25 pairs of final rules.  

\begin{itemize}
\item (5 pairs) Any rule and identity
\[
\deduce{\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}}{\D} \qquad \infer{\seq{\Gamma,x:A,\Gamma'}{z}{Q}}{z:Q \in (\Gamma,x:A,\Gamma')}
\]
There two subcases, depending on whether the variable being cut for is
$z$ or not.  If $z$ is $x_0$ and $A_0$ is $Q$, then \D\/ has the desired
conclusion \seq{\Gamma}{\alpha}{Q}.  If not, then $z:Q \in \Gamma,\Gamma'$, so
the hypothesis rule applies to give \seq{\Gamma,\Gamma'}{z}{Q}.  

\item (5 pairs) Any rule and $\FR$ (right-commutative)
\[
\deduce{\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}}{\D} \qquad
\infer{\seq{\Gamma,x_0:A_0,\Gamma'}{\beta}{\F{\alpha}{\Delta}}}
      {%% \modeof{\Gamma} \vdash \gamma : \modeof{\Delta} & 
        \beta \deq \tsubst{\alpha}{\gamma} &
        \deduce{\seq{\Gamma,x_0:A_0,\Gamma'}{\gamma}{\Delta}}{\E}
      }
\]
By the inductive hypothesis, cutting into \D\/ into \E\/ gives
\seq{\Gamma,\Gamma'}{\subst{\gamma}{\alpha_0}{x_0}}{\Delta}.  By
congruence, $\subst{\beta}{\alpha_0}{x_0} \deq
\subst{\tsubst{\alpha}{\gamma}}{\alpha_0}{x_0}$.  Since $\gamma$ is a
total substitution for all variables in \modeof{\Delta},
$\subst{\tsubst{\alpha}{\gamma}}{\alpha_0}{x} =
\tsubst{\alpha}{\subst{\gamma}{\alpha_0}{x}}$, so
\subst{\beta}{\alpha_0}{x_0} \deq
\tsubst{\alpha}{\subst{\gamma}{\alpha_0}{x}}.  Thus we can reapply the
$\FR$ rule to get
\seq{\Gamma,\Gamma'}{\subst{\beta}{\alpha_0}{x_0}}{\F{\alpha}{\Delta}}.

\item (5 pairs) Any rule and $\UR$ (right-commutative).    
\[
\deduce{\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}}{\D} \qquad
\infer{\seq{\Gamma,x_0:A_0,\Gamma'}{\beta}{\U{x.\alpha}{\Delta}{A}}}
      {\deduce{\seq{\Gamma,x_0:A_0,\Gamma',\Delta}{\subst{\alpha}{\beta}{x}}{A}}{\E}}
\]
The inductive cut of \D\/ into \E\/ gives 
\[
\seq{\Gamma,\Gamma',\Delta}{\subst{\subst{\alpha}{\beta}{x}}{\alpha_0}{x_0}}{A}
\]
Because the variables from $\modeof{\Gamma},\modeof{\Gamma'}$ occur only
in $\beta$, not in $\alpha$, this substitution equals 
{\subst{\alpha}{\subst{\beta}{\alpha_0}{x_0}}{x}} so reapplying the
$\UR$ rule
derives 
{\seq{\Gamma,\Gamma'}{\subst{\beta}{\alpha_0}{x_0}}{\U{x.\alpha}{\Delta}{A}}}.   

\item (2 additional pairs, plus 3 overlapping with above) $\FL$ and
  any rule (left commutative).  

There is one subtlety in this case.  The usual strategy for a left rule
against an arbitrary \E is to push $\E$ into the ``continuation'' of the
\Fsymb-left on $x$.  However, as discussed above, our left rule for
\Fsymb eagerly inverts \emph{all} occurences of $x$, while $\E$ itself
also has $x$ in scope.  Thus, we use Lemma~\ref{lemma:Finv} to pull the
left-inversion to the bottom of \E, and then push that into \D.  On
proof terms, this corresponds to making all references to $x$ in \E
instead refer to the results of the case-analysis at the bottom of $\D$.
This subtlety could be avoided by building contraction into $\FL$, as
discussed above.

Formally, we have
\[
\begin{array}{c}
\infer{\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}}
      {{x}:{\F{\alpha}{\Delta}} \in \Gamma,\Gamma' &
        \deduce{\seq{((\Gamma,\Gamma')-x),\Delta}{\subst {\alpha_0} {\alpha}{x}}{A_0}}{\D}}
\\ \\
\deduce{\seq{\Gamma,x_0:A_0,\Gamma'}{\beta}{C}}{\E}
\end{array}
\]

By left invertibility on \E, we obtain (note that $x \neq x_0$ because
$x_0$ is added to the context in the right-hand derivation) a derivation
$\E'$ of
{\seq{(\Gamma,x:A_0,\Gamma')-x,\Delta}{\subst{\beta}{\alpha}{x}}{C}} that is
no bigger than $\E$.  Because the cut formula is the same, and $\E'$ has
the same size as \E\/, and \D\/ is smaller than the given derivation of
$A_0$, we can apply the inductive hypothesis to cut $\D$ and $\E'$ to
get
\[
{\seq{(\Gamma,\Gamma')-x,\Delta}{\subst{\subst{\beta}{\alpha}{x}}{\subst{\alpha_0}{\alpha}{x}}{x_0}}{C}}.
\]
Commuting substitutions gives
\[
{\subst{{\subst{\beta}{\alpha}{x}}}{\subst{\alpha_0}{\alpha}{x}}{x_0}} = \subst {\beta[\alpha_0/x_0]}{\alpha}{x}
\]
so we can reapply $\FL$ to get
\[
\infer{\seq{\Gamma,\Gamma'}{\beta[\alpha_0/x_0]}{C}}
      {\seq{((\Gamma,\Gamma')-x),\Delta}{\subst {(\beta[\alpha_0/x_0])} {\alpha}{x}}{C}}
\]


\item (2 additional pairs, plus 3 overlapping with above) $\UL$ and any rule (left commutative)
In this case, $x:\U{\alpha}{\Delta}{A} \in \Gamma,\Gamma'$ and
we have
\[
\begin{array}{c}
\infer{\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}}
      {\alpha_0 \deq \subst{\alpha_0'}{\tsubst{\alpha}{\gamma}}{z} &
       \deduce{\seq{\Gamma,\Gamma'}{\gamma}{\Delta}}{\D_1} &
       \deduce{\seq{\Gamma,\Gamma',z:A}{\alpha_0'}{A_0}}{\D_2}
      }
\\ \\
\deduce{\seq{\Gamma,x_0:A_0,\Gamma'}{\beta}{B}}{\E}
\end{array}
\]

Weakening \E with $z$ and then cutting $\D_2$ and $\E$ by the inductive
hypothesis (which applies because $\D_2$ is smaller and weakening does
not change the size) gives
\[
\deduce{\seq{\Gamma,\Gamma',z:A}{\subst{\beta}{\alpha_0'}{x_0}}{B}}{\D_2'}
\]
Thus, we have the first, third, and fourth premises of
\[
\infer{\seq{\Gamma,\Gamma'}{\subst{\beta}{\alpha_0}{x_0}}{A_0}}
      {\begin{array}{l}
          x:\U{\alpha}{\Delta}{A} \in \Gamma,\Gamma' \\
          {\subst{\beta}{\alpha_0}{x_0}} \deq \subst{\subst{\beta}{\alpha_0'}{x_0}}{\tsubst{\alpha}{\gamma}}{z} \\
       {\seq{\Gamma,\Gamma'}{\gamma}{\Delta}} \\
       {\seq{\Gamma,\Gamma',z:A}{\subst{\beta}{\alpha_0'}{x_0}}{B}}
        \end{array}
      }
\]
The equation is proved by
\[
     {\subst{\beta}{\alpha_0}{x_0}} 
\deq \subst{\beta}{\subst{\alpha_0'}{\tsubst{\alpha}{\gamma}}{z}}{x0} = \subst{\subst{\beta}{\alpha_0'}{x_0}}{\tsubst{\alpha}{\gamma}}{z}
\]
where the first step is by congruence with $\beta$ on the 
equality about $\alpha_0$ assumed for the case, and the second is by
properties of substitution ($z$ is not free in $\beta$).  

\item (3 pairs) Right rule or identity and $\FL$ (principal or
  right-commutative).  

Suppose the right-hand derivation ends with $\FL$, and the left-hand
derivation is either a right rule or identity (\dsd{v}) (the cases for
left-rules were covered above).  

We distinguish cases on whether the \FL\/ case-analyzes $x_0$ or not.  If
it does, then, because $A_0 is \F{\alpha}{\Delta}$, the left-hand
derivation must be \FR, and we have a principal cut
\[
\infer{\seq{\Gamma,\Gamma'}{\alpha_0}{\F{\alpha}{\Delta}}}
      {  
        \alpha_0 \deq \tsubst{\alpha}{\gamma} &
        \deduce{\seq{\Gamma,\Gamma'}{\gamma}{\Delta}}{\D}
      }
\qquad
\infer{\seq{\Gamma,x_0:\F{\alpha}{\Delta},\Gamma'}{\beta}{C}}
      {\deduce{\seq{\Gamma,\Gamma',\Delta}{\subst{\beta}{\alpha}{x_0}}{C}}
              {\E}}
\]
Using the inductive hypothesis part 3 to cut \D and \E ($\Delta$ is a
subformula of the original cut formula \F{\alpha}{\Delta}) gives
\[
\seq{\Gamma,\Gamma'}{\tsubst{\subst{\beta}{\alpha}{x_0}}{\gamma}}{C}
\]
By congruence with $\beta$ and because $\gamma$ substitutes only for
variables in $\modeof {\Delta}$,
\[
\subst{\beta}{\alpha_0}{x_0} \deq 
{\subst{\beta}{\tsubst \alpha \gamma}{x_0}} =
{\tsubst{\subst{\beta}{\alpha}{x_0}}{\gamma}} 
\]
So applying Lemma~\ref{lemma:respecteq} gives 
\seq{\Gamma,\Gamma'}{\subst{\beta}{\alpha_0}{x_0}}{C}.  

If not, then we have
\[
\deduce{\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}}{\D}
\quad
\infer{\seq{\Gamma,x_0:A_0,\Gamma'}{\beta}{C}}
      { x : \F{\alpha}{\Delta} \in \Gamma,\Gamma' &
        \deduce{\seq{((\Gamma,x_0:A_0,\Gamma')-x),\Delta}{\subst{\beta}{\alpha}{x}}{C}}{\E}}
\]

We are going to commute $\D$ under \FL on $x$, so need to reroute uses
of $x$ to here by the left-inversion lemma
\[
\D' :: {\seq{((\Gamma,\Gamma')-x),\Delta}{\subst{\alpha_0}{\alpha}{x}}{A_0}}
\]
and $\D'$ is no bigger than \D.

Cutting $\D'$ and $\E$ by the inductive hypothesis gives
\[
\seq{((\Gamma,\Gamma')-x),\Delta}{\subst{\subst{\beta}{\alpha}{x}}{\subst{\alpha_0}{\alpha}{x}}{x_0}}{C}
\]
Because $x_0$ is not free in $\alpha$, 
\[
  {\subst{\subst{\beta}{\alpha}{x}}{\subst{\alpha_0}{\alpha}{x}}{x_0}}
= {\subst{\subst{\beta}{\alpha_0}{x_0}}{\alpha}{x}}
\]
so we can apply \FL
\[
\infer{\seq{\Gamma,\Gamma'}{\subst{\beta}{\alpha_0}{x_0}}{C}}
      {\seq{(\Gamma,\Gamma'-x)}{\subst{\subst{\beta}{\alpha_0}{x_0}}{\alpha}{x}}{C}}
\]
%% \seq{((\Gamma,\Gamma')-x),\Delta}{\subst{\subst{\beta}{\alpha}{x}}{\alpha_0}{x_0}}{C}
%% \]

\item (3 pairs) Right rule or identity and $\UL$ (principal or
  right-commutative).

If $x_0$ is the variable used in the left rule in the right-hand
derivation, then the left-hand derivation must have been derived by
$\UR$, and we have
\[
\begin{array}{l}
\D \quad = \quad \infer{\seq{\Gamma,\Gamma'}{\alpha_0}{\U{x_0.\alpha}{\Delta}{A}}}
   {  
     \deduce{\seq{\Gamma,\Gamma',\Delta}{\subst \alpha {\alpha_0}{x_0}}{A}}{\D'}
   }
\\ \\
\infer{\seq{\Gamma,x_0:\U{x_0.\alpha}{\Delta}{A},\Gamma'}{\beta}{C}}
      {
        \begin{array}{l}
        \beta \deq \subst{\beta'}{\tsubst{\alpha}{\gamma}}{z} \\
        {\E_1 :: \seq{\Gamma,x_0:{\U{x_0.\alpha}{\Delta}{A}},\Gamma'}{\gamma}{\Delta}}\\
        {\E_2 :: \seq{\Gamma,x_0:{\U{x_0.\alpha}{\Delta}{A}},\Gamma',\tptm{z}{A}}{\beta'}{C}}
        \end{array}
      }
\end{array}
\]
First, cutting the original \D and the smaller $\E_1$ and $\E_2$ gives 
\[
\deduce{{\seq{\Gamma,\Gamma'}{\subst{\gamma}{\alpha_0}{x_0}}{\Delta}}}{\E_1'}
\qquad 
\deduce{{\seq{\Gamma,\Gamma',\tptm{z}{A}}{\subst{\beta'}{\alpha_0}{x_0}}{C}}}{\E_2'}
\]
Cutting $\E_1'$ \emph{into} $\D'$ (the cut formula $\Delta$ is a
subformula of $\U{x_0.\alpha}{\Delta}{A}$, so it is okay that the derivations are
not known to be smaller) gives
\[
\deduce
{\seq{\Gamma,\Gamma'}{\tsubst{\alpha}{\subst{\gamma}{\alpha_0}{x}}}{A}} {\D_1'}
\]
Cutting $\D_1'$ into $\E_2'$ gives 
\[
\seq{\Gamma,\Gamma'}{\subst{\subst{\beta'}{\alpha_0}{x_0}}{\subst{\alpha}{\alpha_0}{x_0}}{z}}{A}
\]
But we have 
\[
\subst{\beta}{\alpha_0}{x_0} \deq 
\subst{(\subst{\beta'}{\tsubst{\alpha}{\gamma}}{z})}{\alpha_0}{x_0} = 
{\subst{\subst{\beta'}{\alpha_0}{x_0}}{\tsubst{\alpha}{\subst{\gamma}{\alpha_0}{x_0}}}{z}}
\]
by commuting substitutions, which gives the result.  

On the other hand, if the subject of the left rule $x$ is not equal to
$x_0$, then we have
\[
\deduce{\seq{\Gamma,\Gamma'}{\alpha_0}{A_0}}
       {
         \D
       }
\quad
\infer{\seq{\Gamma,x_0:A_0,\Gamma'}{\beta}{C}}
      {
        \begin{array}{l}
          x : \U{x.\alpha}{\Delta}{A} \in \Gamma,\Gamma' \\
          \beta \deq \subst{\beta'}{\tsubst{\alpha}{\gamma}}{z} \\
          \seq{\Gamma,x_0:A_0,\Gamma'}{\gamma}{\Delta} \\
          \seq{\Gamma,x_0:A_0,\Gamma',\tptm{z}{A}}{\beta'}{C}
        \end{array}
      }
\]

By the inductive hypotheses we get 
\[
\seq{\Gamma,\Gamma'}{\subst{\gamma}{\alpha_0}{x_0}}{\Delta}
\qquad
\seq{\Gamma,\Gamma',z:A}{\subst{\beta'}{\alpha_0}{x_0}}{C}
\]
so we can derive
\[
\infer{\seq{\Gamma,x_0:A_0,\Gamma'}{\subst{\beta}{\alpha_0}{x_0}}{C}}
      {
        \begin{array}{l}
          x : \U{x.\alpha}{\Delta}{A} \in \Gamma,\Gamma' \\
          {\subst{\beta}{\alpha_0}{x_0}} \deq \subst{\subst{\beta'}{\alpha_0}{x_0}}{\tsubst{\alpha}{\subst{\gamma}{\alpha_0}{x_0}}}{z} \\
          \seq{\Gamma,\Gamma'}{\subst{\gamma}{\alpha_0}{x_0}}{\Delta} \\
          \seq{\Gamma,\Gamma',\tptm{z}{A}}{\subst{\beta'}{\alpha_0}{x_0}}{C}
        \end{array}
      }
\]
For the equation, we get
\[
\subst{\beta}{\alpha_0}{x_0} \deq
\subst{\subst{\beta'}{\tsubst{\alpha}{\gamma}}{z}}{\alpha_0}{x_0}
\]
by congruence on the assumed equation, and then commute substitutions.  

Part 2:

Part 3: 

\end{itemize}
\end{proof}


\begin{lemma}[Contraction over contraction]
\item If
\seq{\Gamma,x:A,y:A,\Gamma'}{\alpha}{C}
then
\seq{\Gamma,z:A,\Gamma'}{\tsubst \alpha {z/x,z/y}}{C}
\end{lemma}

\begin{proof}  Contraction can be shown by cutting with an identity substitution.
The mode substitution $z/x,z/y$ is a variable-for-variable substitution,
and is type-preserving between ${x:A,y:A}$ and ${\Gamma,z:A,\Gamma'}$.
Therefore, by identity (part 2),
\seq{\Gamma,z:A,\Gamma'}{z/x,z/y}{x:A,y:A}.  Thus, by cut (part 2), we
obtain the result.
\end{proof}

\begin{lemma}[Right-invertibility of \Usymb] \label{lemma:Uinv}
If $\seq{\Gamma}{\beta}{\U{x.\alpha}{\Delta}{A}}$ then 
{\seq{\Gamma,\Delta}{\subst{\alpha}{\beta}{x}}{A}}.
\end{lemma}

\begin{proof}
$\UL$ with identities in both premises gives a derivation
\[
\infer{\seq{\Gamma,\Delta,x:{\U{x.\alpha}{\Delta}{A}}}{\alpha}{A}}
      {
        \alpha = z[\alpha[\vec{x/x}]/z] & 
        \seq{\Gamma,\Delta}{\vec{x/x}}{\Delta} &
        \seq{\Gamma,\Delta,x:{\U{x.\alpha}{\Delta}{A}},z:A}{z}{A}
      }
\]
Weakening the assumed derivation to 
\seq{\Gamma,\Delta}{\beta}{\U{x.\alpha}{\Delta}{A}}
and then cutting for $x$ in the above gives the result.  

\[
\infer{\seq{\Gamma,\Delta}{\subst{\alpha}{\beta}{x}}{A}}
      {\seq{\Gamma,\Delta}{\beta}{\U{x.\alpha}{\Delta}{A}} & 
       \seq{\Gamma,\Delta,x:{\U{x.\alpha}{\Delta}{A}}}{\alpha}{A}
      }
\]

\end{proof}

\begin{theorem}[Fusion] ~
\begin{enumerate} 
\item F
\item UU
\item UF
\end{enumerate}
\end{theorem}

\subsection{Equational Theory of Proofs}

\subsection{Categorical Semantics}

TODO: Mitchell

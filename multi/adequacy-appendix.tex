
% non-associative products NO
% ordered products YES
%         implications NO
% linear products     NO
%        implications NO
% multi-use functions YES
%           products NO
% affine products YES
%        implications YES
% relevant NO
% cartesian products     YES
%           implications YES
% BI NO
% Adjoint ! NO
% Adjoint Box YES
% Subexponentials NO
% Monads nonstrong YES
%        strong NO
%        box-strong NO
% spatial NO

\section{Logical Adequacy}
\label{sec:adequacy-long}

Suppose we are representing some object logic, like the examples from
Section~\ref{sec:exampleencodings}, in our framework.  In general, for a
specific mode theory, the framework will have more types than the object
logic.  For example, if we represent a logic with a binary product by a
product in the mode theory, then the framework will have not only \F{x
  \otimes y}{x:A,y:B}, but also a primitive triple product \F{x \otimes
  y \otimes z}{x:A,y:B,z:C}, and so on.  If we represent a modal logic
with a monad by its adjoint decomposition, then the framework will have
not only the $\Usymb \Fsymb$ composite, but also the \Usymb\/ and
\Fsymb\/ types separately.  Thus, in general we will define a
translation from object-logic sequents $J$ to framework sequents $J^*$,
in such a way that $J$ is provable in the object logic iff $J^*$ is
provable in the framework.  No claims are made about framework
derivations of sequents that are not in the image of the translation.
We call this \emph{logical adequacy}, because it says that entailment in
the object logic is soundly and completely represented by entailment in
the framework.  We plan to consider stronger adequacy theorems, which
extend this logical correspondence to an isomorphism on
equivalence-classes of proofs.

We will often use the following lemma:  

\begin{lemma}[0-use Strengthing] \label{lem:0-use-strengthening}
We say that a formula $\F{\alpha}{\Delta}$ and \U{c.\alpha}{\Delta}{A}
is relevant if every variable from $\Delta$ (and $c$ for \Usymb) occurs
at least once in $\alpha$.

Suppose the mode theory has the property that for all $x$, $\alpha$,
$\beta$, if $\alpha \spr \beta$ and $x \# \alpha$ then $x \# \beta$ (in
particular, equations must have the same variables on both sides).
Suppose additionally a sequent \seq{\Gamma}{\alpha}{A} such that every
\Fsymb/\Usymb\/ subformula of $\Gamma,A$ is relevant.

Then if $\D :: \seq{\Gamma}{\alpha}{A}$ and $\vec{x}$ are variables such
that $\vec{x} \# \alpha$ then there is a $\D' ::
\seq{\Gamma-\vec{x}}{\alpha}{A}$ and $size(\D') \le size(\D)$.
\end{lemma}

\begin{proof}
The proof is by induction on $\D$.  In all cases, the assumption that
every formula is relevant is preserved for all premises of a rule by the
subformula property.

\begin{itemize}
\item In the case for a variable $x:P$ with transformation $\beta \spr
  x$, we need to show that the variable $x$ being used is not one of the
  ones being strengthened away.  But if $x$ were in $\vec{x}$, then we
  would have $x \# \beta$, and therefore by the assumption, $x \# x$, a
  contradiction.  Therefore $x \in {\Gamma-\vec{x}}$, and we can reapply
  the variable rule, which has the same size.

\item In the case for \FR, we have $\vec{x} \# \beta$, so by the
  reduction condition, $\vec{x} \# \alpha[\gamma]$.  By the relevance
  condition, all variables that $\gamma$ substitutes occur in $\alpha$,
  which means each component of $\gamma$ occurs in $\alpha[\gamma]$.
  Therefore $\vec{x} \# \gamma$.  We can use the inductive hypothesis to
  obtain a no-bigger derivation of \seq{\Gamma-\vec{x}}{\gamma}{\Delta},
  and then reapply \FR.

\item In the case for \FL, we distinguish cases on whether $x \in
  \vec{x}$ or not.

  If it is, then this is an elimination on a 0-use variable that we
  would like to drop.  Because $x \# \beta$, $\beta[\alpha/x] = \beta$,
  and note that $\Delta \# \beta$ because it occurs only in $\alpha$.
  Thus, if we appeal to the inductive hypothesis on the premise with
  $\vec{x}-x,\Delta$, we get
  \seq{(\Gamma,\Gamma',\Delta)-(\vec{x}-x,\Delta)}{\beta}{C}, 
  i.e.
  \seq{\Gamma,x:\F{\alpha}{\Delta},\Gamma',-\vec{x}}{\beta}{C}
  as desired.  That is, we recursively drop all variables that came from
  the elimination, in addition to any others that we were trying to drop
  besides $\vec{x}$.  

  If it is not, then $\vec{x} \# \beta$ and $\vec{x} \# \alpha$ (by
  scoping) implies $\vec{x} \# \beta[\alpha/x]$, so by the inductive
  hypothesis we get a no-bigger derivation of
  \seq{\Gamma,\Gamma'-\vec{x},\Delta}{\beta[\alpha/x]}{C}, and we can
  reapply \FL (because the principal variable $x$ of the left rule is
  not removed).

\item In the case for \UR, we have $\vec{x}$ a collection of variables
  bound in $\Gamma$, so $\vec{x} \# \alpha$ (since the domain of
  $\alpha$ is not $\Gamma$) in addition to $\vec{x} \# \beta$.  Thus
  $\vec{x} \# \subst\alpha{\beta}{x}$, so the inductive hypothesis gives a
  no-bigger derivation of
  \seq{\Gamma-\vec{x},\Delta}{\alpha[\beta/x]}{A}, and we can reapply
  the rule.

\item In the case for \UL, we distinguish cases on whether $z$ occurs in
  $\beta'$.  

  If $z \# \beta'$, then this \UL\/ is generating a 0-use assumption $z$, so
  we can remove it and the \UL\/ along with $\vec{x}$.  That is, we appeal
  to the inductive hypothesis on the continuation with $\vec{x},z$,
  which gives \seq{\Gamma,z:A-(\vec{x},z)}{\beta'}{C}, i.e.
  \seq{\Gamma-\vec{x}}{\beta'}{C}.  We also have $\beta \spr \beta'$
  because the $[\alpha[\gamma]/z]$ substitution cancels.  So we have
  \seq{\Gamma-\vec{x}}{\beta}{C} by Lemma~\ref{lem:respectspr}.
  
  If $z$ occurs in $\beta'$, we further distinguish cases on whether $x
  \in \vec{x}$ or not.  

  If it is not, then we know $\vec{x} \# \beta$, so pushing this along
  the transformation gives $\vec{x} \# \beta'[\alpha[\gamma]/z]$.  Thus
  $\vec{x} \# \beta'$ (note that $z$ cannot be in $\vec{x}$ because it
  is bound only in the continuation), and because $z$ occurs in
  $\beta'$, $\alpha[\gamma/z]$ occurs in the substitution, so $\vec{x}
  \# \alpha[\gamma]$.  By the relevance assumption, each term in
  $\gamma$ also occurs after the substitution, so $\vec{x} \# \gamma$ as
  well.  Thus, by the inductive hypotheses we get no-bigger derivations
  of \seq{\Gamma-\vec{x}}{\gamma}{\Delta} and
  \seq{\Gamma-\vec{x},z:A}{\beta'}{C}, and the principal $x$ survives in
  $\Gamma-\vec{x}$, so we can reapply \UL.

  Finally, if $x \in \vec{x}$ and $z \in \beta'$, then we have $x \#
  \beta$, so $x \# \beta'[\alpha[\gamma]/z]$ by moving along the
  transformation, and then $x \# \alpha[\gamma]$ by the fact that $z$
  occurs.  However, this contradicts the relevance assumption on
  $\U{x.\alpha}{\Delta}{A}$, which says that $x$ occurs in $\alpha$.  
\end{itemize}

\end{proof}

\begin{lemma} \label{lem:spr-doesnt-introduce}
Suppose each axiom $c : \alpha \spr \beta$ has the property that $x \#
\alpha$ implies $x \# \beta$.  Then for any derivation of $\alpha \spr
\beta$, $x \# \alpha$ implies $x \# \beta$.
\end{lemma}

\begin{proof}
The cases for reflexivity is immediate, and the case for axioms is
assumed.  In the case for transitivity $\alpha \spr \beta_1 \spr
\beta_2$, we get $\vec{x} \# \beta_1$ by the first inductive hypothesis
and then $\vec{x} \# \beta_2$ by the second.  In the case for
congruence, we have $\vec{x} \# \alpha[\beta/y]$.  This means that
either $\vec{x} \# \alpha$ and $\vec{x} \# \beta$, or $\vec{x} \#
\alpha$ and $y \# \alpha$ (in which case $\vec{x}$ might occur in
$\beta$).  In the first case, we get $\vec{x} \# \alpha'$ and $\vec{x}
\# \beta'$ by the inductive hypotheses, so $\vec{x} \#
\alpha'[\beta'/y]$.  In the second, we get $\vec{x},y \# \alpha'$ by the
inductive hypothesis, so $\alpha'[\beta'/y] = \alpha'$, and $\vec{x} \#
\alpha'$.
\end{proof}

\subsection{Ordered Logic (Product Only)}
\label{sec:adequacy:ordered-logical}

\newcommand\dotLd[2]{\ensuremath{\mathord{\odot}}\dsd{L}^{#1}(#2)}
\newcommand\dotRd[2]{\ensuremath{\mathord{\odot}}\dsd{R}(#1,#2)}

As a first example of an adequacy proof, we consider ordered logic with only $A \odot B$:
\[
\infer{\seql{A}{o}{A}}{}
\quad
\infer{\seql{\Gamma,\Delta,\Gamma'}{o}{C}}
      {\seql{\Gamma,A,\Gamma'}{o}{C} &
        \seql{\Delta}{o}{A}}
\quad
\infer{\seql{\Gamma,A \odot B,\Gamma'}{o}{C}}
      {\seql{\Gamma,A,B,\Gamma'}{o}{C}}
\quad
\infer{\seql{\Gamma,\Delta}{o}{A \odot B}}
      {\seql{\Gamma}{o}{A} &
        \seql{\Delta}{o}{B}}
\]

We use a mode theory with a monoid $(\odot,1)$, so the only
transformation axioms are equality axioms for associativity and unit.  

The type translation is given by $P^* := P$ and $(A \odot B)^* := \F{x
  \odot y}{x:A^*,y:B^*}$.  A context $(x_1:A_1,\ldots,x_n:A_n)^* :=
x_1:A_1^*,\ldots,x_n:A_n^*$.  Writing $\vars{x_1:A_1,\ldots,x_n:A_n} :=
x_1 \odot \ldots \odot x_n$, a sequent $\seql{\Gamma}{o}{A}$ is
translated to \seq{\Gamma^*}{\vars{\Gamma}}{A^*}.

We use the following properties of the mode theory:
\begin{itemize}
\item If ${\vars{\Gamma^*}} \deq {x}$ then $\Gamma$ is $x:Q$ for some
  $Q$.  
\item If $\vars{\Gamma} \deq \alpha_1 \odot \alpha_2$, then there exist
  $\Gamma_1,\Gamma_2$ such that $\Gamma = \Gamma_1,\Gamma_2$ and
  $\vars{\Gamma_1} \deq \alpha_1$ and $\vars{\Gamma_2} \deq \alpha_2$.
\item $A^*$ and $\Gamma^*$ are relevant propositions, and the monoid
  axioms preserve variables, so by Lemma~\ref{lem:0-use-strengthening} we can
  strengthen away any variables that are not in the context descriptor.  
\end{itemize}

Using these definitions, we have

\begin{theorem}[Logical adequacy for ordered products] 
$\seql{\Gamma}{o}{A}$ iff $\seq{\Gamma^*}{\vars{\Gamma}}{A^*}$
\end{theorem}

\begin{proof}
The forward direction is by induction on \seql{\Gamma}{o}{A}, where 
the inference rules for $\odot$ are derived as follows:

\[
\infer[\FL]{\seq{\Gamma^*,z:\F{x \otimes y}{x:A^*,y:B^*},{\Gamma'}^*}{\vars{\Gamma}\odot z \odot \vars{\Gamma'}}{C}}
      {\infer[Lemma~\ref{lem:exchange}]
        {\seq{\Gamma^*,{\Gamma'}^*,x:A,y:B}{\vars{\Gamma}\odot x \odot y \odot \vars{\Gamma'}}{C}}
        {\seq{\Gamma^*,x:A,y:B,{\Gamma'}^*}{\vars{\Gamma}\odot x \odot y \odot \vars{\Gamma'}}{C}}}
\]

\[
\infer{\seq{\Gamma^*,\Delta^*}{\vars{\Gamma} \odot \vars{\Delta}}{\F{x \odot y}{x:A,y:B}}}
      {{\vars{\Gamma} \odot \vars{\Delta}} \spr (x \odot y)[\vars{\Gamma}/x,\vars{\Delta}/y] &
        \infer[Lemma~\ref{lem:weakening}]
              {\seq{\Gamma^*,\Delta^*}{\vars{\Gamma}}{A}}
              {\seq{\Gamma^*}{\vars{\Gamma}}{A}} &
        \infer[Lemma~\ref{lem:weakening}]
              {\seq{\Gamma^*,\Delta^*}{\vars{\Gamma}}{A}}
              {\seq{\Delta^*}{\vars{\Delta}}{B}}}
\]

The backward direction is also by induction on the given derivation:
\begin{itemize}
\item For identity
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{P}}
      {{\vars{\Gamma^*}} \spr {x} &
        x : P \in \Gamma^*}
\]
Because the only structural transformation axioms are equalities for
associativity and unit, we have ${\vars{\Gamma^*}} \deq {x}$, which in
turn implies that $\Gamma$ is $x:Q$ for some $Q$ (because if $\Gamma$ is
empty, does not contain $x$, or contains anything else, \vars{\Gamma}
will not equal $x$).  By definition, this implies $Q = P$, so $\Gamma$
is $x:P$.  Therefore the identity rule applies.

\item For \FR, because the only type that encodes to \F{\alpha}{\Delta}
  is $A \odot B$, and in this case we have $(A_1 \odot A_2)^* = \F{x \odot
    y}{x:A_1,y:A_2}$, we have
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{\F{x \odot y}{x:A_1^*,y:A_2^*}}}
      {\vars{\Gamma} \deq \alpha_1 \odot \alpha_2 &
       \seq{\Gamma^*}{\alpha_1}{A_1^*} &
       \seq{\Gamma^*}{\alpha_2}{A_2^*}
      }
\]
By properties of the mode theory, $\Gamma = \Gamma_1,\Gamma_2$ with
$\vars{\Gamma_i} \deq \alpha_i$, so we have derivations of
\seq{\Gamma^*}{\vars{\Gamma_i}}{A_i^*}.  Because 0-use strengthening
applies, we can strengthen these to
\seq{\Gamma_i^*}{\vars{\Gamma_i}}{A_i^*}.  Then the inductive hypothesis
gives \seql{\Gamma_i}{o}{A_i}, so applying the $\odot$ right rule gives the
result.

\item For \FL, because the only type encoding to $\Fsymb$ is $A \odot
  B$, we have
\[
\infer{\seq{\Gamma^*,z:\F{x \odot y}{x:A^*,y:B^*},{\Gamma'}^*}{\vars{\Gamma} \odot z \odot \vars{\Gamma'}}{C^*}}
      {\seq{\Gamma^*,{\Gamma'}^*,x:A^*,y:B^*}{\vars{\Gamma} \odot (x \odot y) \odot \vars{\Gamma'}}{C^*}}
\]
By exchange (Lemma~\ref{lem:exchange}), we have a no-bigger derivation
of
{\seq{\Gamma^*,x:A^*,y:B^*,{\Gamma'}^*}{\vars{\Gamma} \odot (x \odot y) \odot \vars{\Gamma'}}{C^*}} 
so applying the IH gives 
\seql{{\Gamma,x:A,y:B,{\Gamma'}}}{o}{C}, and then $\odot$-left gives the result.
\end{itemize}
\end{proof}

\subsection{Affine Logic}

Consider the following rules for affine logic, where the context is
represented by a list of assumptions labeled with variables, and $\Gamma
\splits \Delta_1,\Delta_2$ means interleaving $\Delta_1$ and $\Delta_2$
in some order equals $\Gamma$.

\begin{small}
\[
\begin{array}{c}
\infer{\seqa{\Gamma}{P}}{P \in \Gamma}
\qquad
\infer{\seqa{\Gamma,z:A\otimes B,\Gamma'}{C}}
      {\seqa{\Gamma,\Gamma',x:A,y:B}{C}}
\qquad
\infer{\seqa{\Gamma}{A \otimes B}}
      {\Gamma \splits \Delta_1;\Delta_2 &
        \seqa{\Delta_1}{A} &
        \seqa{\Delta_2}{B}}
\\\\
\infer{\seqa{\Gamma}{A \lolli B}}
      {\seqa{\Gamma,x:A}{B}}
\qquad
\infer{\seqa{\Gamma}{C}}
      {\Gamma \splits \Delta_1;\Delta_2;(f:A \lolli B) &
        \seqa{\Delta_1}{A} &
        \seqa{\Delta_2,z:B}{C}
      }
\end{array}
\]
\end{small}

\noindent Weakening and exchange are admissible for these rules.  

Using the mode theory from Section~\ref{sec:ex:affine}, we translate the
propositions and contexts of adjoint logic as follows:
\[
\begin{array}{rcl}
P^* & = & P \\
(A\otimes B)^* & = & \F{x \otimes y}{x:A^*,y:B^*} \\
(A\lolli B)^* & = & \U{c.c \otimes x}{x:A^*}{B^*} \\
\\
\cdot^* & = & \cdot\\
(\Gamma,x:A)^* & = & \Gamma^*,x:A^*\\
\end{array}
\]
We also define a function that collects the variables from $\Gamma$ as a
context descriptor:
\[
\begin{array}{rcl}
\vars{\cdot} & = & 1\\
\vars{(\Gamma,x:A)} & = & \vars{\Gamma} \otimes x\\
\end{array}
\]

Overall, we have
\begin{theorem}[Logical adequacy for affine products and functions] ~\\
$\seqa{\Gamma}{A}$ iff $\seq{\Gamma^*}{\vars{\Gamma}}{A^*}$
\end{theorem}

\begin{proof}

The forward direction is by induction on $\seqa{\Gamma}{A}$:
\begin{itemize}
\item For the hypothesis rule, we need to show
  \seq{\Gamma^*}{\vars{\Gamma}}{P}.  Because $x$ is in $\Gamma$, we can
  prove by induction on $\Gamma$ that $x:P$ is in $\Gamma^*$ and that
  $\vars{\Gamma} \deq \alpha \otimes x$.  Thus, the weakening
  transformation gives $\alpha \otimes x \spr 1 \otimes x \deq
  x$. Therefore we can derive
\[
\infer[\dsd{v}]
      {\seq{\Gamma^*}{\vars{\Gamma}}{P}}
      {x:P \in \Gamma & 
        {\vars{\Gamma}} \spr x}
\]

\item For $\otimes$-left, the inductive hypothesis gives
\seq{\Gamma^*,\Gamma'^*,x:A^*,y:B^*}{\vars{\Gamma} \otimes \vars{\Gamma'} \otimes x \otimes y}{C^*}
and we want 
\seq{\Gamma^*,z:\F{x\otimes y}{x:A^*,y:B^*},\Gamma'^*}{\vars{\Gamma} \otimes z \otimes \vars{\Gamma'}}{C^*}.
This is \FL\/ on the inductive hypothesis, with using associativity and commutativity of
$\otimes$ from the mode theory to move $x \otimes y$ to the end.  

\item 
For $\otimes$-right, we 
have \seq{\Delta_1^*}{\vars{\Delta_1}}{A^*}
and \seq{\Delta_2^*}{\vars{\Delta_2}}{B^*} by the inductive hypotheses,
which we can weaken to
 \seq{\Delta_1^*,\Delta_2^*}{\vars{\Delta_1}}{A^*}
and 
 \seq{\Delta_1^*,\Delta_2^*}{\vars{\Delta_2}}{B^*}, 
and then exchange to 
 \seq{\Gamma^*}{\vars{\Delta_1}}{A^*}
and 
 \seq{\Gamma^*}{\vars{\Delta_2}}{B^*} (using a lemma that when $\Gamma \splits \Delta_1,\Delta_2$,
$\Gamma$ and $(\Delta_1,\Delta_2)$ differ only in order, and that
 reordering is preserved by the mapped application of $*$).  
To apply \FR\/ to derive \seq{\Gamma^*}{\vars{\Gamma}}{\F{x \otimes y}{x:A,y:B}}, it thus suffices to show that 
$\vars{\Gamma} \spr \vars{\Delta_1}\otimes\vars{\Delta_2}$.  In fact
they are $\deq$,  which we can
prove by induction on $\Gamma \splits \Delta_1,\Delta_2$ using the
commutative monoid laws.  

\item For $\lolli$-right, we have
  \seq{\Gamma^*,x:A^*}{\vars{\Gamma}\otimes x}{B^*}
by the inductive hypothesis, which is exactly the premise of using \UR\/
to prove
  \seq{\Gamma^*}{\vars{\Gamma}}{\U{c.c\otimes x}{x:A^*}{B^*}}.  

\item For $\lolli$-left, we have \seq{\Delta_1^*}{\vars{\Delta_1}}{A}
  and \seq{\Delta_2^*,z:B^*}{\vars{\Delta_2}\otimes z}{C^*} by the
  inductive hypothesis, and by similar reasoning to the $\otimes R$
  case, we can weaken and exchange to
  \seq{\Gamma^*,\Gamma'^*}{\vars{\Delta_1}}{A} and
  \seq{\Gamma^*,\Gamma'^*,z:B^*}{\vars{\Delta_2}\otimes z}{C^*} and then
  finally weaken to \seq{\Gamma^*,f:(A\lolli
    B)^*,\Gamma'^*}{\vars{\Delta_1}}{A} and \seq{\Gamma^*,f:(A\lolli
    B)^*,\Gamma'^*,z:B^*}{\vars{\Delta_2}\otimes z}{C^*}.
Thus, we only need to show the transformation premise of
\[
\infer[\UL]{\seq{\Gamma^*,f:(A\lolli B)^*,\Gamma'^*}{\vars{\Gamma}\otimes f \otimes \vars{\Gamma'}}{C^*}}
      {  
        \begin{array}{l}
        {\vars{\Gamma}\otimes f \otimes \vars{\Gamma'}} \spr
        (\vars{\Delta_2} \otimes z)[f \otimes \vars{\Delta_1} /z] \\
        \seq{\Gamma^*,f:(A\lolli B)^*,\Gamma'^*}{\vars{\Delta_1}}{A} \\
        \seq{\Gamma^*,f:(A\lolli B)^*,\Gamma'^*,z:B^*}{\vars{\Delta_2}\otimes z}{C^*}
        \end{array}
      }
\]
In fact 
${\vars{\Gamma}\otimes f \otimes \vars{\Gamma'}} \deq (\vars{\Delta_2} \otimes f \otimes \vars{\Delta_1})$,
which again follows from $\Gamma \splits \Delta_1,\Delta_2$, using associativity and commutativity
of $\otimes$.  
\end{itemize}
In terms of structural property placement, observe that the above proof
uses only identity transformations on \FR\/ and \UL, and uses the
\dsd{w} axiom only at the leaves.  

We need the following facts about the mode theory.  

\begin{lemma} \label{lem:affine-mode-1}
If $\alpha \spr \beta$ then $\alpha \deq \beta \otimes \beta'$
for some $\beta'$.
\end{lemma}
\begin{proof}

In the case for weakening $\alpha \spr 1$ (the only axiom), take
$\beta' = \beta$.  In the case for reflexivity take $\beta' =
1$.  In the case for transitivity, we have $\alpha \spr \beta_1
\spr \beta_2$.  By the second inductive hypothesis, we have
$\beta_1 \deq \beta_2 \otimes \beta_2'$, and by the first we have
$\alpha \deq \beta_1 \otimes \beta_1'$, so 
$\alpha \deq \beta_2 \otimes (\beta_2' \otimes \beta_1')$.  

In the case for congruence, we have
$\alpha_1[\alpha_2/x] \spr \beta_1[\beta_2/x]$
and the inductive hypotheses give
    $\alpha_1 \deq \beta_1 \otimes \beta_1'$
and $\alpha_2 \deq \beta_2 \otimes \beta_2'$.  
Thus, 
$\alpha_1[\alpha_2/x] \deq \beta_1[\beta_2 \otimes \beta_2'/x] \otimes \beta_1'[\beta_2 \otimes \beta_2'/x]$,
and then the right-hand side equals 
$\beta_1[\beta_2/x] \otimes \beta_2^n \otimes \beta_1'[\beta_2 \otimes \beta_2'/x]$
for some $n$.  
This is because, 
for this mode theory, we can rewrite any $\alpha$ as $\alpha' \otimes (x
\otimes \ldots \otimes x)$ where $\alpha'$ does not contain $x$ (because
any context descriptor is equal to a ``polynomial'' giving the
multiplicity of each variable), so in general we have $\alpha[\beta_1
  \otimes \beta_2/x] \deq \alpha' \otimes (\beta_1 \otimes \beta_2)^n
\deq \alpha' \otimes \beta_1^n \otimes \beta_2^n \deq \alpha[\beta_1/x]
\otimes \beta_2^n$.
\end{proof}

\begin{lemma} \label{lem:affine-mode-5}
If $\vars{\Gamma} \deq \alpha_1 \otimes \alpha_2$, 
then $\Gamma \splits \Gamma_1,\Gamma_2$ with 
$\vars{\Gamma_1} \deq \alpha_1$ 
and $\vars{\Gamma_2} \deq \alpha_2$.  
\end{lemma}
\begin{proof}
We define the splitting $\Gamma \splits \Gamma_1,\Gamma_2$ adding each
variable in $\Gamma$ to $\Gamma_1$ if it occurs in $\alpha_1$, or
$\Gamma_2$ if it occurs in $\alpha_2$ and not $\alpha_1$ (occurrence
respects \deq).  Because $\deq$ consists of associativity,
commutativity, and unit, $\alpha_1$ and $\alpha_2$ have no duplicates
and every variable from \vars{\Gamma} occurs exactly once in one or the
other, which gives $\vars{\Gamma_1} \deq \alpha_1$ and $\vars{\Gamma_2}
\deq \alpha_1$.
%% FIXME: last sentence is a little sketchy
\end{proof}

\begin{lemma} \label{lem:affine-mode-4}
If $\vars{\Gamma} \spr \alpha$, then there is a $\Gamma'$ such that
$\Gamma \ge \Gamma'$ and $\alpha \deq \vars{\Gamma'}$.
\end{lemma}

\begin{proof}
By Lemma~\ref{lem:affine-mode-1}, $\vars{\Gamma} \deq \alpha \otimes
\beta$ for some $\beta$.  By Lemma~\ref{lem:affine-mode-5}, this means
$\Gamma \splits \Gamma_1,\Gamma_2$ with $\vars{\Gamma_1} \deq \alpha$.
Then the fact that $\Gamma \splits \Gamma_1,\Gamma_2$ implies $\Gamma
\ge \Gamma_1$ gives the result.
\end{proof}

\begin{lemma} \label{lem:strengthening-affine}
If $\seq{{\Gamma_0}^*}{\alpha}{A^*}$ and $\vec{x} \# \alpha$ then there
is a no-bigger derivation of $\seq{{\Gamma}^*-\vec{x}}{\alpha}{A^*}$
\end{lemma}

\begin{proof}
We will use Lemma~\ref{lem:0-use-strengthening}.  First, no variables
are free in the range of weakening, so
Lemma~\ref{lem:spr-doesnt-introduce} gives that $\alpha \spr \beta$ and
$x \# \alpha$ imply $x \# \beta$.  Second, we prove by induction that
every subformula of $\Gamma^*$ and $A^*$ is relevant, because the only
context descriptors used are \F{x \otimes y}{x:A,y:B} and \U{c.c \otimes x}{x:A}{B}.
\end{proof}

We now prove that if $\seq{\Gamma^*}{\vars{\Gamma}}{A^*}$ then
$\seqa{\Gamma}{A}$.  The proof is by induction on the size of the
assumption, because we will sometimes use
Lemma~\ref{lem:strengthening-affine} before appealing to the inductive
hypothesis.
\begin{itemize}
\item In the case for the assumption rule, we have
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{P}}
      {x:P \in \Gamma^* &
       \vars{\Gamma} \spr x}
\]
Since $x:P \in \Gamma^*$, $x:P \in \Gamma$, and we can apply the affine
logic rule.  

\item In the case where \UR\/ was used to derive
  \seq{\Gamma^*}{\vars{\Gamma}}{A^*}, $A$ must be $A_1 \lolli A_2$
  (because no other types encode to \Usymb), and the premise is
  \seq{\Gamma^*,x:A_1^*}{\vars{\Gamma}\otimes x}{A_2^*}.  The inductive
  hypothesis gives $\seqa{\Gamma,x:A_1}{A_2}$, and we can apply
  $\lolli$-right.

\item In the case where \FR\/ was used, the conclusion must be $(A_1
  \otimes A_2)$, and we have $\vars{\Gamma} \spr (\alpha_1 \otimes
  \alpha_2)$ with \seq{\Gamma^*}{\alpha_1}{A_1^*} and
  \seq{\Gamma^*}{\alpha_2}{A_1^*}.  By Lemma~\ref{lem:affine-mode-4},
  this means there is a $\Gamma \ge \Gamma'$ with $\vars{\Gamma'} \deq
  (\alpha_1 \otimes \alpha_2)$.  By Lemma~\ref{lem:affine-mode-5}, we
  have $\Gamma' \splits \Gamma_1,\Gamma_2$ with $\vars{\Gamma_1} \deq
  \alpha_1$ and $\vars{\Gamma_2} \deq \alpha_2$. So the premises are
  \seq{\Gamma^*}{\vars{\Gamma_1}}{A_1^*} and
  \seq{\Gamma^*}{\vars{\Gamma_2}}{A_2^*}.  By
  Lemma~\ref{lem:strengthening-affine}, we can modify the premises to
  no-bigger derivations of \seq{\Gamma_1^*}{\vars{\Gamma_1}}{A_1^*} and
  \seq{\Gamma_2^*}{\vars{\Gamma_2}}{A_2^*}.  Thus, by the inductive
  hypotheses we get $\seqa{\Gamma_1}{A_1}$ and $\seqa{\Gamma_2}{A_2}$,
  so $\seqa{\Gamma'}{A_1 \otimes A_2}$.  Then weakening and exchange on
  $\Gamma \ge \Gamma'$ gives the result.

\item 
  In the case where \FL\/ was used, the formula under elimination must
  be the translation of $z:(A_1 \otimes A_2) \in \Gamma$. The premise is
  \seq{\Gamma^*-z,x:A_1^*,y:A_2^*}{\vars{\Gamma}[(x \otimes y)/z]}{C^*},
  and we want \seqa{\Gamma}{C}.  Since \vars{\Gamma} has exactly one
  occurrence of $z$, $\vars{\Gamma}[(x \otimes y)/z] \deq
  (\vars{\Gamma}-z)\otimes x \otimes y$, so by the inductive hypothesis
  we get \seqa{\Gamma-z,x:A_1,y:A_2}{C} by the inductive hypothesis, and
  can apply $\otimes$-left.

\item In the case for \UL, the assumption $f$ that is eliminated must be
  the translation of $f:(A_1 \lolli A_2) \in \Gamma$ , so the premises
  are $\vars{\Gamma} \spr \beta'[f \otimes \alpha/z]$ with
  $\seq{\Gamma^*}{\alpha}{A_1^*}$ and
  $\seq{\Gamma^*,z:A_2^*}{\beta'}{C}$. 

  By Lemma~\ref{lem:affine-mode-4}, there is a $\Gamma'$ with $\Gamma
  \ge \Gamma'$ and $\vars{\Gamma'} \deq \beta'[f \otimes \alpha/z]$.
  Since $\vars{\Gamma'}$ has no duplicates, $z$ occurs at most once in
  $\beta'$ (or else $f$ would occur more than once in the substitution).
  
  If $z$ occurs once in $\beta'$, then because all context descriptors
  are products of variables, we can commute it to the end, writing
  $\beta' \deq \beta'' \otimes z$, so $\vars{\Gamma'} \deq \beta''
  \otimes f \otimes \alpha$.  Since $f$ is in \vars{\Gamma'}, $f$ must
  be declared with some type in $\Gamma'$, and since $\Gamma \ge
  \Gamma'$ and $f:A_1 \lolli A_2 \in \Gamma$, we must have $f:A_1 \lolli
  A_2 \in \Gamma'$.  So by Lemma~\ref{lem:affine-mode-5}, we can split
  $\Gamma' \splits \Delta_1;\Delta_2;f:A_1 \lolli A_2$ where
  $\vars{\Delta_2} \deq \beta''$ and $\vars{\Delta_1} \deq \alpha$.
  Using these equalities, the premises derive
  $\seq{\Gamma^*}{\vars{\Delta_1}}{A_1^*}$ and
  $\seq{\Gamma^*,z:A_2^*}{\vars{\Delta_2} \otimes z}{C}$, so by
  Lemma~\ref{lem:strengthening-affine} we can strengthen to no-bigger
  derivations of
  $\seq{\Delta_1^*}{\vars{\Delta_1}}{A_1^*}$ (removing $\Gamma-\Delta_1$) and
  $\seq{\Delta_2*,z:A_2^*}{\vars{\Delta_2} \otimes z}{C}$ (removing $\Gamma-\Delta_2$).
  Then the inductive hypotheses give \seq{\Delta_1}{A_1} and
  \seq{\Delta_2,z:A_2}{C}, so we have the premises to use $\lolli$-left
  to conclude \seq{\Gamma'}{C}.  Finally, we weaken/exchange with
  $\Gamma \ge \Gamma'$.

  If $z$ occurs 0 times in $\beta'$ (that is, we did a \UL\/ that
  introduced a 0-use variable in the continuation), then we have
  premises \seq{\Gamma^*,z:A_2^*}{\beta'}{C} and $\vars{\Gamma} \spr
  \beta'$ (the substitution cancels).  By Lemma~\ref{lem:affine-mode-4},
  we get $\Gamma \ge \Gamma'$ with $\vars{\Gamma'} \deq \beta'$.  By
  Lemma~\ref{lem:strengthening-affine}, we can remove $z$ and anything
  in $\Gamma$ but not in $\Gamma'$ to get a no-bigger derivation of
  \seq{\Gamma'^*}{\vars{\Gamma'}}{C}.  Then the inductive hypothesis on
  this premise gives \seqa{\Gamma'}{C}, and weakening/exchanging with
  $\Gamma \ge \Gamma'$ gives the result.
\end{itemize}
\end{proof}


Inspecting this proof, we can see that the translation from a ``native''
sequent proof in affine logic to our framework and back is the identity
on cut-free derivations.  The other round-trip is not the identity,
because the framework allows two things that the native sequent calculus
does not.  First, the framework allows weakening at the non-invertible
rules, rather than pushing it to the leaves.  For example, we have
the following two derivations of $P,Q,R \vdash P \otimes R$.

\[
\infer[\FR]
      {\seq{x:P,y:Q,z:R}{x \otimes y \otimes z}{\F{x' \otimes z'}{x':P,z':R}}}
      {x \otimes y \otimes z \spr (x' \otimes y')[(x \otimes y)/x', z/y'] &
        \infer[\dsd{v}]
              {\seq{x:P,y:Q,z:R}{x \otimes y}{P}}
              {(x \otimes y) \spr x} &
        \infer[\dsd{v}]
              {\seq{x:P,y:Q,z:R}{z}{R}}
              {z \spr z}
      }
\]
\[
\infer[\FR]
      {\seq{x:P,y:Q,z:R}{x \otimes y \otimes z}{\F{x' \otimes z'}{x':P,z':R}}}
      {x \otimes y \otimes z \spr (x' \otimes y')[x/x', z/y'] &
        \infer[\dsd{v}]
              {\seq{x:P,y:Q,z:R}{x}{P}}
              {x \spr x} &
        \infer[\dsd{v}]
              {\seq{x:P,y:Q,z:R}{z}{R}}
              {z \spr z}
      }
\]

\noindent The second is that a derivation may perform a left rule on a
$0$-linear (in the sense of Section~\ref{sec:ex:nlinear}) variable,
i.e. one that does not occur in the context descriptor.  Such variables
arise because \UL\/ ``removes a variable from the context'' by marking
it as 0-use, not by actually removing it.  For this mode theory, these
left rules produce only other 0-use variables, which ultimately cannot
be used, and were strengthened away by
Lemma~\ref{lem:0-use-strengthening}.

The equational theory of derivations (Section~\ref{sec:equational})
handles both of these issues, so we expect that the
framework-native-framework composite of adequacy produces a derivation
that is equal in this equational theory.

%% These differ by the placement of weakening: our rules allow for
%% weakening away $y$ either at a leaf (there is a third possible
%% derivation that weakens in the $z$ leaf instead), as is typical in
%% affine logic, or at the context division in $\FR$.  However, these two
%% derivations are equal in the above equational theory:
%% \[
%% \FRd{1}{\Trd{(1_{x \otimes y}[\dsd{w}/y])}{x},\Trd{1}{z}}
%% \deq
%% \FRd{1_{x \otimes y \otimes z}[\dsd{w}/y]}{\Trd{1}{x},\Trd{1}{z}}
%% \]
%% By associativity, unit and projection laws, we have that a general
%% instance of \FR\/ is equal to an iterated cut (in any order) and then a
%% structural transformation on the ``axiomatic'' $\FR^* ::
%% \seq{\Gamma,\Delta}{\alpha}{\F{\alpha}{\Delta}}$
%% \[
%% \FRd{\alpha}{\vec{\D_i/x_i}} \deq \Trd{\alpha}{\FR^*[\vec{\D_i/x_i}]}
%% \]
%% So applying this to both sides it suffices to show
%% \[
%% \begin{array}{rcl}
%% & &  \Trd{{(1_{x \otimes y \otimes z})}}{\FR^*[\Trd{1}{z}/z'][\Trd{(1_{x \otimes y}[\dsd{w}/y])}{x}/x']}\\
%% & \deq & \Trd{{(1_{x \otimes y \otimes z}[\dsd{w}/y])}}{\FR^*[\Trd{1}{z}/z'][\Trd{1}{x}/x']} 
%% \end{array}
%% \]
%% Here we have
%% \[
%% \begin{array}{rcl}
%% \FR^*[\Trd{1}{z}/z'] & :: & \seq{x:P,y:Q,z:R,x':P}{x' \otimes z}{P \otimes R}\\
%% \Trd{1}{x} & :: & \seq{x:P,y:Q,z:R}{x}{P}\\
%% {(1_{x \otimes y}[\dsd{w}/y])} & :: & x \otimes y \spr y\\
%% 1_{x'\otimes z} & :: & x' \otimes z
%% \end{array}
%% \]
%% so the transformation-on-cut equation gives
%% \[
%% \begin{array}{rl}
%%      & \Cut{(\Trd{({1_{x'\otimes z}})}{\FR^*[\Trd{1}{z}/z']})}{\Trd{{(1_{x \otimes y}[\dsd{w}/y])}}{\Trd{1}{x}}}{x'}\\
%%  \deq & \Trd{ (\subst{({1_{x'\otimes z}})}{(1_{x \otimes y}[\dsd{w}/y])}{x'})  }{\Cut{\FR^*[\Trd{1}{z}/z']}{\Trd{1}{x}}{x'}}
%% \end{array}
%% \]
%% The left-hand side is equal to the left-hand side of the goal by
%% functoriality of \Trd{-}{-}, and the right-hand side is equal to the
%% right-hand side of the goal by associativity of horizontal composition
%% and $1_{x' \otimes z}[1_{x \otimes y/x'}] \deq 1_{x \otimes y \otimes
%%   z}$.  

%% %% \begin{array}{rcll}
%% %% & &  \FRd{1}{\Trd{(1_{x \otimes y}[\dsd{w}/y])}{x},\Trd{1}{z}} \\
%% %% & \deq & \Trd{{(1_{x \otimes y \otimes z})}}{\FR^*[\Trd{1}{z}/z'][\Trd{(1_{x \otimes y}[\dsd{w}/y])}{x}/x']}\\
%% %% & \deq & ? \\
%% %% & \deq & \Trd{{(1_{x \otimes y \otimes z}[\dsd{w}/y])}}{\FR^*[\Trd{1}{z}/z'][\Trd{1}{x}/x']} \\
%% %% & \deq & \FRd{1_{x \otimes y \otimes z}[\dsd{w}/y]}{\Trd{1}{x},\Trd{1}{z}} \\
%% %% \end{array}
%% %% \]

\subsection{$n$-use Variables}

%% FIXME: this is the main idea; could prove the mode theory properties
%% more carefully

Consider the rules and mode theory from Section~\ref{sec:ex:nlinear}.
We use the following normal form theorem for the linear logic mode
(commutative monoid) mode theory, which says that any mode morphism can
be written as a ``polynomial'' of its variables:

\begin{lemma} \label{lem:monoid-normal} 
If $x_1 : \dsd{l},\ldots,x_n : \dsd{l} \vdash \alpha : \dsd{l}$ then
there exist unique ${k_1,\ldots,k_n}$ such that $\alpha \deq x_1^{k_1}
\otimes \ldots \otimes x_n^{k_n}$.
\end{lemma}

\begin{theorem}[Logical adequacy for $n$-use functions] ~\\
$x_1:^{k_1} A_1,\ldots,x_n :^{k_n} A_n \vdash C$ iff
  \seq{x_1:A_1^*,\ldots,x_n:A_n^*}{x_1^{k_1} \otimes \ldots \otimes
    x_n^{k_n}}{C^*}
\end{theorem}

\begin{proof}
When $\Gamma$ is $x_1:^{k_1} A_1,\ldots,x_n :^{k_n} A_n$, we write
\vars{\Gamma} for ${x_1^{k_1} \otimes \ldots \otimes x_n^{k_n}}$.  

The native inference rules are derivable as follows:
\begin{itemize}
\item For the identity rule, we use the fact that \vars{0 \cdot \Gamma}
  is equal to 1 by the unit laws for the monoid:
\[
\infer{{0\cdot \Gamma + x:^1 P} \vdash {P}}
      {}
\qquad
\infer{\seq{\Gamma^*,x:P}{\vars{0 \cdot \Gamma}\otimes{x}}{P}}
      {{\vars{0 \cdot \Gamma} \otimes x} \spr x}
\]

\item 
\[
\infer{\Gamma \vdash A \to^n B}
      {{\Gamma, x :^n A} \vdash {B}}
\qquad
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{\U{c.c\otimes x^n}{x:A^*}{B^*}}}
      {\seq{\Gamma^*, x:A^*}{\vars{\Gamma} \otimes x^n}{B^*}}
\]

\item Note that $\Gamma + \Delta$ is only defined on contexts that have
  the same variables and types, so $(\Gamma + \Delta)^* = \Gamma^* =
  \Delta^*$.  Additionally, $\vars{\Gamma + \Delta} \deq \vars{\Gamma}
  \otimes \vars{\Delta}$, and $\vars{n \cdot \Gamma} \deq
  \vars{\Gamma}^n$.
\[
\infer{\Gamma + f:^k A \to^n B + (nk \cdot \Delta) \vdash C}
      {\Delta \vdash A &
        {\Gamma, z :^k B} \vdash {C}}
\qquad
\infer{\seq{\Gamma^*}{\vars{\Gamma} \otimes f^k \otimes \vars{\Delta}^{nk}}{C}}
      {\begin{array}{l}
          f : \U{f.f \otimes x^n}{x : A}{B} \in \Gamma^* \\
          {\vars{\Gamma} \otimes f^k \otimes \vars{\Delta}^{nk}} \deq (\vars{\Gamma} \otimes z^k)[f \otimes (\alpha)^n/z] \\
          \seq{\Delta^* = \Gamma^*}{\vars{\Delta}}{A} \\
          \seq{\Gamma^*, z:B^*}{\vars{\Gamma} \otimes z^k}{C^*} 
       \end{array}
      }
\]
Here we use associativity and commutativity to show
$(f \otimes (\alpha)^n)^k \deq f^k \otimes (\alpha)^{nk}$.  

\end{itemize}

Conversely, suppose we have \seq{\Gamma^*}{\vars{\Gamma}}{A^*}.  
\begin{itemize}
\item Case for 
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{P}}
      {x:P \in {\Gamma}^* & 
       \vars{\Gamma} \spr x}
\]
Let $\Gamma$ be $x_1 :^{k_1} A_1,\ldots,x:^{k}A,\ldots,x_n:^{k_n}{A_n}$.
Since the only type that encodes to an atom is that atom, we have $A =
P$.  For the linear logic mode theory (commutative monoid), there are no
transformation axioms besides equations, so $\vars{\Gamma} \spr x$ implies $\vars{\Gamma} \deq x$,
which in turn implies that $k_i = 0$ and $k = 1$ (anything else would
encode to a monoid term with a non-zero coefficient for some variable
besides $x$, or with a non-one coefficient for $x$).  Thus 
\[
\Gamma = (x_1 :^{0} A_1,\ldots,x:^{1}P,\ldots,x_n:^{0}{A_n}) = 0 \cdot (x_1 :^{0} A_1,\ldots,x:^{0}P,\ldots,x_n:^{0}{A_n}) + x:^{1}P
\]
so the hypothesis rule applies:
\[
\infer{0 \cdot (x_1 :^{0} A_1,\ldots,x:^{0}A,\ldots,x_n:^{0}{A_n}) + x:^{1}P \vdash P}{}
\]

\item Since the only type that encodes to a \U{c.\alpha}{\Delta}{B} is
  $A \to^n B$, if the derivation was by \UR, we have
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{\U{c.c\otimes x^n}{x:A^*}{B^*}}}
      {\seq{\Gamma^*, x:A^*}{\vars{\Gamma} \otimes x^n}{B^*}}
\]
Noting that the context of the premise is ${(\Gamma,x:^{n}A)}^*$ and the
context descriptor of the premise is $\vars{\Gamma,x:^{n}A}$, the
inductive hypothesis gives a derivation of ${{\Gamma, x :^n A} \vdash
  {B}}$, so we can derive
\[
\infer{\Gamma \vdash A \to^n B}
      {{\Gamma, x :^n A} \vdash {B}}
\]

\item Since the only type that encodes to a \U{c.\alpha}{\Delta}{B} is
  $A \to^n B$, if the derivation was by \UL, we have
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{C}}
      {\begin{array}{l}
          f : \U{f.f \otimes x^n}{x : A^*}{B^*} \in \Gamma^* \\
          \vars{\Gamma} \deq \beta'[f \otimes (\alpha)^n/z] \\
          \seq{\Gamma^*}{\alpha}{A^*} \\
          \seq{\Gamma^*, z:B^*}{\beta'^*}{C^*} 
       \end{array}
      }
\]
Suppose $\Gamma = x_1 :^{k_1} A_1, \ldots, x_n :^{k_n} A_n,$.  By
Lemma~\ref{lem:monoid-normal}, we have $\alpha \deq x_1^{a_1} \otimes
\ldots \otimes x_n^{a_n}$ and $\beta' \deq x_1^{b_1} \otimes \ldots
\otimes x_n^{b_n} \otimes z^{k}$.  The fact that
\[
x_1 ^{k_1} \otimes \ldots \otimes x_n^{k_n} \deq \beta'[f \otimes (\alpha)^n/z]
\]
implies that $k_i = b_i + kn a_i$ if $x_i \neq f$ and $k_i = b_i + kn a_i
+ k$ if $x_i = f$, so $\Gamma = \Gamma' + f:^{k} (A \to^n B) + nk\Delta$.
Writing 
\[
\begin{array}{l}
\Delta  = x_1 :^{a_1} A_1,\ldots,x_n :^{a_n} A_n
\Gamma' = x_1 :^{b_1} A_1,\ldots,x_n :^{b_n} A_n
\end{array}
\]
We have $\Delta^* = \Gamma^*$ and $\Gamma'^* = \Gamma^*$ and
$\vars{\Delta} = \alpha$ and $\vars{\Gamma',z:^{k}B} = \beta'$, so the
inductive hypotheses give $\Delta \vdash A$ and $\Gamma',z:^{k}B \vdash
C$, and we can apply the rule to get
\[
\infer{\Gamma = (\Gamma' + f:^k A \to^n B + (nk \cdot \Delta)) \vdash C}
      {\Delta \vdash A &
        {\Gamma, z :^k B} \vdash {C}}
\]
\end{itemize}
\end{proof}



\subsection{Cartesian Logic}

We compare the cartesian monoid mode theory from
Section~\ref{sec:ex:relevant-cartesian} with the following rules:
\[
\begin{array}{c}
\infer{\seqc{\Gamma}{P}}{x:P \in \Gamma}
\quad
\infer{\seqc{\Gamma}{A \times B}}
      {\seqc{\Gamma}{A} &
        \seqc{\Gamma}{B}}
\quad
\infer{\seqc{\Gamma}{C}}
      {p:A\times B \in \Gamma & 
        \seqc{\Gamma,x:A,y:B}{C}}
\\\\
\infer{\seqc{\Gamma}{A \to B}}
      {\seqc{\Gamma,x:A}{B}}
\quad
\infer{\seqc{\Gamma}{C}}
      {f: A \to B \in \Gamma &
        \seqc{\Gamma}{A} &
        \seqc{\Gamma,z:B}{C}
      }
\end{array}
\]
In this case, neither round-trip will be the identity on raw derivations
(as opposed to equivalence classes), though the one starting at these
native rules will be the identity up to a (positive/left) $\eta$ law for
$\times$.  The difference is that the above rules allow contraction for
$A \times B$, whereas the framework reduces this to contraction at $A$
and $B$ separately.  We could instead compare against a native sequent
calculus that does not allow contraction for positives, but the above is
more standard.

Overall, we have
\begin{theorem}[Logical adequacy for cartesian products and functions]
$\seqc{\Gamma}{A}$ iff \seq{\Gamma^*}{\vars{\Gamma}}{A^*}
\end{theorem}

\begin{proof}
The proof of the forward direction is by induction on the given
derivation, using the derivations of each rule:

\[
\infer[\dsd{v}]{\seq{\Gamma^*}{\vars{\Gamma}}{P^*}}
      {x:P^* \in \Gamma^* &
        1_{(\vars{\Gamma-x})\times x}[\dsd{w}/x] :: \vars{\Gamma-x} \times x \spr x}
\]

\[
\infer[\FR]{\seq{\Gamma^*}{\vars{\Gamma}}{\F{x\times y}{x:A^*,y:B^*}}}
      {\dsd{c} :: \vars{\Gamma} \spr \vars{\Gamma} \times \vars{\Gamma} &
       \seq{\Gamma^*}{\vars{\Gamma}}{A^*} & 
       \seq{\Gamma^*}{\vars{\Gamma}}{B^*}}
\]

\[
\infer[Lemma~\ref{lem:respectspr}]
      {\seq{\Gamma^*}{\vars{\Gamma}}{C^*}}
      { %% 1_{\vars{\Gamma-p}\times p}[\dsd{c}/p] :: 
        \vars{\Gamma} \spr \vars{\Gamma} \times p &
        \infer[Cor.~\ref{cor:contraction}]
              {\seq{\Gamma^*}{\vars{\Gamma}\times p}{C^*}}
              {p : (A\times B)^* \in \Gamma^* &
                \infer[\FL]
                      {\seq{\Gamma^*,q:(A\times B)^*}{\vars{\Gamma}\times q}{C^*}}
                      {\seq{\Gamma^*,x:A^*,y:B^*}{\vars{\Gamma}\times x \times y}{C^*}}}
      }
\]

\[
\infer[\UR]
      {\seq{\Gamma^*}{\vars{\Gamma}}{\U{f.f\times x}{x:A^*}{B^*}}}
      {\seq{\Gamma^*,x:A^*}{\vars{\Gamma}\times x}{B^*}}
\]

\begin{small}
\[
\infer[\UL]
      {\seq{\Gamma^*}{\vars{\Gamma}}{C}}
      {f:(A\to B)^* \in \Gamma^* &
        \vars{\Gamma} \spr \vars{\Gamma} \times (f \times \vars{\Gamma}) &
        \seq{\Gamma^*}{\vars{\Gamma}}{A^*} &
        \seq{\Gamma^*,z:B^*}{\vars{\Gamma}\times z}{B^*}
      }
\]
\end{small}

This shows that the above sequent calculus uses structural rules in the
following places: The hypothesis rule weakens away all other variables.
The $\times$ right rule contracts the entire context.  The $\times$ left
rule uses contraction for the mode theory ($p \spr p \times p$) and
contraction-over-contraction to duplicate $p$ to $q$---if we did not
have a contraction here in the native rule, then this would just be \FL,
as the $\to$ right rule is just \UR.  The $\to$ left rule contracts
everything in $\Gamma$ for use in both the argument and the
continuation, and contracts the function an additional time for use
here.

Conversely, we show \seq{\Gamma^*}{\vars{\Gamma}}{A^*} implies
$\seqc{\Gamma}{A}$ The proof is by induction on the size of the given
derivation, to allow uses of Lemma~\ref{lem:respectspr} before applying
the inductive hypothesis.

\begin{itemize}

\item The hypothesis rule is immediate because $x:P^* \in \Gamma^*$
  implies $x:P \in \Gamma$.  

\item For a general use of \FR, the conclusion must be $(A \times B)^*$
  because this is the only type that encodes to an $\Fsymb$:
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{\F{x\times y}{x:A,y:B}}}
      {\vars{\Gamma} \spr \alpha \times \beta &
        \seq{\Gamma^*}{\alpha}{A} &
        \seq{\Gamma^*}{\beta}{B}}
\]
Because we have projections, we can compose $\vars{\Gamma} \spr \alpha
\times \beta \spr \alpha$ and $\vars{\Gamma} \spr \alpha \times \beta
\spr \beta$, and apply these to the premises by
Lemma~\ref{lem:respectspr} to get no-bigger derivations of
$\seq{\Gamma^*}{\vars{\Gamma}}{A}$ and $\seq{\Gamma^*}{\vars{\Gamma}}{B}$,
and then the inductive hypotheses and $\times$-right give the result.

This corresponds to treating this derivation as if it were 
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{\F{x\times y}{x:A,y:B}}}
      {\vars{\Gamma} \spr \vars{\Gamma} \times \vars{\Gamma} &
        \infer{\seq{\Gamma^*}{\vars{\Gamma}}{A}}
              {\vars{\Gamma} \spr \alpha &
                \seq{\Gamma^*}{\alpha}{A}} &
        \infer{\seq{\Gamma^*}{\vars{\Gamma}}{B}}
              {\vars{\Gamma} \spr \beta &
                \seq{\Gamma^*}{\beta}{B}}
      }
\]
where we contract all variables and weaken the premises with any that
did not already occur in $\alpha/\beta$.  In our equational theory on
derivations these two are indeed equal, assuming equations on
transformations giving the universal property of a cartesian product in
the mode theory.

\item For a general use of \FL, which must be on the encoding of a $p: A
  \times B \in \Gamma$, we have
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{C}}
      {\seq{(\Gamma-p)^*,x:A^*,y:B^*}{\vars{\Gamma}[x \times y/p]}{C}}
\]
Because $\Gamma \deq (\Gamma-p)\times p$, the inductive hypothesis gives
a derivation of \seqc{\Gamma-p,x:A,y:B}{C}.  Using the admissible
weakening for cartesian logic, we have \seqc{\Gamma,x:A,y:B}{C}, so
$\times$-left gives the result.  That is, our given derivation does not
contract $p$, so we weaken with the extra occurrence of $p$.

\item For \UR, the inductive hypothesis applied to the premise gives
  exactly the premise of $\to$-right.  

\item For \UL\/ on $f:(A\to B)^*$, we have
\[
\infer{\seq{\Gamma^*}{\vars{\Gamma}}{C^*}}
      {
        {\vars{\Gamma}} \spr \beta'[(f \times \alpha)/z] &
        \seq{\Gamma^*}{\alpha}{A^*} &
        \seq{\Gamma^*,z:B^*}{\beta'}{B^*}
      }
\]
Because all context descriptors are products of variables, we can
rewrite $\beta' \deq \beta'' \times z^k$ for some $k$ and $\beta''$ not
containing $z$.  Thus, we have 
$\vars{\Gamma} \spr \beta'' \times (f \times \alpha)^k$
so using
projections we have
$\vars{\Gamma} \spr \beta''$
and 
$\vars{\Gamma} \spr \alpha$.  
Using contraction, we have 
$\vars{\Gamma} \times z \spr \beta'' \times z^k$.
Applying these to the premises with Lemma~\ref{lem:respectspr}
gives derivations of 
\seq{\Gamma^*}{\vars{\Gamma}}{A^*} 
and 
\seq{\Gamma^*,z:B^*}{\vars{\Gamma}\times z}{B^*}.
Thus, the inductive hypotheses give the premises of $\to$-left.  

Equationally, the only thing suspicious about this is projecting
\emph{one} of the $\alpha$'s from $(f \times \alpha)^k$.   However,
\vars{\Gamma} has no duplicate variables, and for this mode theory any
map $x \spr x^k$ is the $k$-fold contraction of $x$.  Therefore, all
projections are the same, and contracting-projecting-recontracting is
the same as the original contraction.  

\end{itemize}

\end{proof}

\subsection{Constructive S4 \Bx{}{}}

The native rules (writing $\seql{\Delta;\Gamma}{}{A}$ for 
$\validj{\Delta};\truej{\Gamma} \vdash \truej{A}$) are
\[
\infer{\seql{\Delta;\Gamma}{}{P}}
      {P \in \Gamma}
\quad
\infer{\seql{\Delta;\Gamma}{}{C}}
      {A \in \Delta & 
       \seql{\Delta;\Gamma,A}{}{C}
      }
\quad
\infer{\seql{\Delta;\Gamma,\Bx{}{A},\Gamma'}{}{C}}
      {\seql{\Delta,A;\Gamma,\Gamma'}{}{C}}
\quad
\infer{\seql{\Delta;\Gamma}{}{\Bx{}{A}}}
      {\seql{\Delta;\cdot}{}{A}}
\]

For the mode theory in Section~\ref{sec:example:box}, we have
\begin{theorem}[Logical adequacy for a comonad]
\[
\begin{array}{c}
 x_1:\validj{A_1},\ldots;y_1:\truej{B_1},\ldots \vdash \truej{C}\\
\text{iff}\\
\seq{x_1:\Uempty{\dsd{f}}{A_1^*},\ldots;y_1:B_1^*,\ldots}
    {\dsd{f}(x_1) \times\ldots\times \dsd{f}(x_n) \times y_1 \times \ldots \times y_n}{C^*}
\end{array}
\]
\end{theorem}

\begin{proof}
We write $\Delta^*$ for $\vec{x_i : \Uempty{\dsd{f}}{A_i^*}}$ for each
assumption in $x : A_i \in \Delta$ and $\Gamma^*$ as usual.  
We write \vars{\Delta} for $\dsd{f}(x_1) \times \ldots \times \dsd{f}(x_n)$ for
the variables in $\Delta$ 
and \vars{\Gamma} as usual.  

First we show that \seql{\Delta;\Gamma}{}{C} implies
\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{C^*}
by induction, using the following encodings:

For the hyp rule:
\[
\infer{\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{P}}
      { x:P \in \Gamma^* &
        {\vars{\Delta}\times\vars{\Gamma}} \spr x
      }
\]
where the transformation weakens everything else.  

For the copy rule:
\[
\infer[\UL]{\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{C^*}}
      {
        \begin{array}{l}
          x:\Uempty{\dsd{f}}{A^*} \in \Delta^* \\
          {\vars{\Delta}\times\vars{\Gamma}} \spr
          (\vars{\Delta}\times\vars{\Gamma}\times z)[\dsd{f}(x)/z] \\
        \seq{\Delta^*,\Gamma^*,z:A^*}{\vars{\Delta}\times\vars{\Gamma}\times z}{C^*}
        \end{array}
      }
\]
where the transformation contracts the $\dsd{f}(x)$ that must be in $\vars{\Delta}$.

For \Bx{}{}-left:
\[
\infer[\FL]{\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{C^*}}
      {x:\F{\dsd{f}}{\Uempty{\dsd{f}}{A^*}} \in \Gamma^* &
        \infer[\ref{lem:exchange}]
              {\seq{\Delta^*,\Gamma^*-x,z:{\Uempty{\dsd{f}}{A^*}}}
                   {\vars{\Delta}\times\vars{\Gamma-x}\times z}{C^*}}
              {\seq{\Delta^*,z:{\Uempty{\dsd{f}}{A^*}},\Gamma^*-x}{\vars{\Delta}\times\vars{\Gamma-x}\times z}{C^*}}
      }
\]
We took the liberty of making \Bx{}{}-left remove the \Bx{}{}-assumption
(which as usual for positives is a choice), or else we could do a
contraction here to match it.  We use commutativity of $\times$ and
exchange to make the order match the native rule.  

For \Bx{}{}-right:
\begin{footnotesize}
\[
\infer[\FR]
      {\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{\F{\dsd{f}}{\Uempty{\dsd{f}}{A^*}}}}
      { {\vars{\Delta}\times\vars{\Gamma}} \spr 
        \dsd{f}(x_1\times_v \ldots) &
        \infer[\UR]
              {\seq{\Delta^*,\Gamma^*}{(x_1\times_v \ldots)}{{\Uempty{\dsd{f}}{A^*}}}}
              {\infer[\ref{lem:respectspr}]
                {\seq{\Delta^*,\Gamma^*}{\dsd{f}(x_1\times_v \ldots)}{A^*}}
                {{\dsd{f}(x_1 \times \ldots)} \spr {\dsd{f}(x_1) \times \ldots} &
                  \infer[\ref{lem:weakening}]
                        {\seq{\Delta^*,\Gamma^*}{\dsd{f}(x_1) \times \ldots }{A^*}}
                        {\seq{\Delta^*}{\vars{\Delta}}{A^*}}
                }
              }}
\]
\end{footnotesize}
We write $x_1 \ldots$ for the variables from $\Delta$.  The first
transformation weakens away $\Gamma$ and uses the monoidalness
transformation axioms for \dsd{f} to pull \dsd{f} outside the product.
After the \UR, we uses the converse $\dsd{f}(\top_v) \spr \top$ and
$\dsd{f}(x \times_v y) \spr \dsd{f}(x) \times \dsd{f}(y)$ that follow
from the intro forms for the cartesian $(\times,\top)$ and congruence of
\dsd{f}\/ on the projections.  Finally, we weaken-over-weaken the
encoding of the premise with $\Gamma^*$

Conversely, suppose we have
\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{C^*}.  For
this mode theory, the context descriptors containing all variables are
initial:
\begin{itemize}
\item If
  $\oftp{\vec{x_i}:{\dsd{v}},\vec{y_i}:{\dsd{t}}}{\alpha}{\dsd{v}}$ then
  $x_1 \times_v \ldots \times_v x_n \spr \alpha$.  $\alpha$ a variable,
  in which case we weaken all the others, $1$, in which case we weaken
  everything, or $\alpha_1 \times_v \alpha_2$, in which case we get $x_1
  \times_v \ldots \times_v x_n \spr \alpha_1$ and $x_1 \times_v \ldots
  \times_v x_n \spr \alpha_2$ by induction, apply congruence of
  $\times_v$, and then precompose with contraction.

\item If
  $\oftp{\vec{x_i}:{\dsd{v}},\vec{y_i}:{\dsd{t}}}{\alpha}{\dsd{t}}$ then
  $\dsd{f}(x_1) \times \dsd{f}(x_n) \times y_1 \times \ldots \times y_n
  \spr \alpha$.  By induction on $\alpha$.  If it is $y_i$, then we
  weaken all other variables; if it is $1$ then, we weaken everything.
  If it is $\alpha_1 \times \alpha_2$, then we get
  $\vec{f(x_i)} \otimes \vec{y_i} \spr \alpha_1$ $\vec{f(x_i)} \otimes
  \vec{y_i} \spr \alpha_2$ by induction, apply congruence of $\times$,
  and precompose with contraction.  Finally, if it is $\dsd{f}(\alpha)$,
  then we get $x_1 \times_v \ldots \times_v x_n \spr \alpha$ by the
  inductive hypothesis, apply congruence of \dsd{f}, and then weaken
  with $\vec{y_i}$ and precompose with $\dsd{f}(x_1) \times \ldots
  \times \dsd{f}(x_n) \spr \dsd{f}(x_1 \times_v \ldots \times_v x_n)$.
\end{itemize}

%% \item If $\dsd{f}(x_1) \otimes \ldots \otimes \dsd{f}(x_n) \otimes y_1
%%   \otimes \ldots \otimes y_n \spr \dsd{f}(\alpha)$, then $x_1 \otimes
%%   \ldots \otimes x_n \spr \alpha$.

We proceed by induction on the given derivation.  Observe that
Lemma~\ref{lem:0-use-strengthening} applies to any sequent
\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{C^*}, because
\F{\dsd{f}}{A} and \Uempty{\dsd{f}}{A} are relevant, and the
equations (associativity, unit, commutativity) have the same variables
on both sides, and the transformations (weakening, contraction,
distributing \dsd{f}) do not introduce any new variables on the
right-hand side, so Lemma~\ref{lem:spr-doesnt-introduce} applies.  
\begin{itemize}
\item For the axiom rule, we know $x:P$ is in $\Gamma^*$ not $\Delta^*$
  because all $\Delta$-formulas are prefixed with a \Usymb.  Since the
  only formula that encodes to an atom is that atom, we have $x:P \in
  \Gamma$, so the hypothesis rule applies.  

\item If the last rule used was $\FR$, then because the only formula
  that encodes to \dsd{F} is $\Bx {}A$, we have 
\[
\infer{\seq{\Delta^*,\Gamma^*}{\vars{\Delta} \times \vars{\Gamma}}{\F{\dsd{f}}{\Uempty{\dsd{f}}{A}}}}
      {
        {\Delta^* \times \Gamma^*} \spr \dsd{f}(\alpha) &
        \seq{\Delta^*,\Gamma^*}{\alpha}{\Uempty{\dsd{f}}{A}}
      }
\]
Writing the variables of $\Delta$ as $x_1,\ldots,x_n$, the first premise
implies that $x_1 \times \ldots \times x_n \spr \alpha$, so by
Lemma~\ref{lem:respectspr}, we can make the second premise into a
no-bigger derivation of \seq{\Delta^*,\Gamma^*}{x_1 \times \ldots
  \times x_n}{\Uempty{\dsd{f}}{A}}.  Applying Lemma~\ref{lem:Uinv-subderivation},
we get a no-bigger derivation of 
\seq{\Delta^*,\Gamma^*}{\dsd{f}(x_1 \times \ldots \times x_n)}{A}.  
Again using Lemma~\ref{lem:respectspr}, we get 
\seq{\Delta^*,\Gamma^*}{\dsd{f}(x_1) \times \ldots \times \dsd{f}(x_n)}{A}.  
Finally, we use Lemma~\ref{lem:0-use-strengthening} to remove
$\Gamma^*$, getting a no-larger derivation of 
\seq{\Delta^*}{\vars{\Delta}}{A}.  Then the inductive hypothesis gives 
$\Delta;\cdot \vdash A$, so we get $\Delta;\Gamma \vdash \Bx{}{}A$ by
rule.  

\item The last rule cannot have been \UR, because no types encode to a
  formula beginning with $U$.  

\item For \FL, because each variable in $\Delta^*$ begins with a \Usymb,
  the variable being eliminated must be in $\Gamma$.  Because the only
  type that encodes to $F$ is $\Bx{}{A}$, we have $x : \Bx{}{A}$ in
  $\Gamma$ and 
\[
\infer{\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{C^*}}
      {x : \F{\dsd{f}}{\Uempty{\dsd{f}}{A^*}} \in \Gamma^* &
        \seq{\Delta^*,\Gamma^*-x,y:\Uempty{\dsd{f}}{A}}
            {\vars{\Delta} \times \vars{\Gamma}[\dsd{f}(y)/x]}
            {C^*}
      }
\]
Using Lemma~\ref{lem:exchange}, we can change the premise's context to
${\Delta^*,y:\Uempty{\dsd{f}}{A^*},\Gamma^*-x,}$ which is
$(\Delta,y:A)^*,\Gamma^*-x$.  By associativity and commutativity, we
have that $\vars{\Delta,y:A} \times \vars{\Gamma-x} \deq {\vars{\Delta}
  \times \vars{\Gamma}[\dsd{f}(y)/x]}$.  So we can apply the inductive
hypothesis to the premise to get $\Delta,y:A;\Gamma-x \vdash C$, and
then we get $\Delta;\Gamma \vdash C$ by rule.  

\item For \UL, because no types encode to \Usymb, the eliminated
  variable must be from $\Delta^*$.  This means $x:A \in \Delta$ and we
  have
\[
\infer{\seq{\Delta^*,\Gamma^*}{\vars{\Delta}\times\vars{\Gamma}}{C^*}}
      {\begin{array}{l}
          x:\Uempty{\dsd{f}}{A} \in \Delta^* \\
          {\vars{\Delta}\times\vars{\Gamma}} \spr \subst{\beta'}{\dsd{f}(x)}{z} \\
          \seq{{\Delta^*,\Gamma^*},\tptm{z}{A^*}}{\beta'}{C^*}
       \end{array}
      }
\]
We have $\vars{\Delta} \times \vars{\Gamma} \times z \spr
\beta'$, so by Lemma~\ref{lem:respectspr}, 
$\seq{{\Delta^*,\Gamma^*},\tptm{z}{A^*}}{\vars{\Delta} \times \vars{\Gamma} \times z}{C^*}$.
Then the inductive hypothesis gives 
$\Delta;\Gamma,z:A \vdash C$, so the copy rule gives 
$\Delta;\Gamma \vdash C$.  
\end{itemize}
\end{proof}

\subsection{Non-strong Monad (\Dia{}{})}

We compare the mode theory for the non-strong \Dia{}{} (modes \dsd{t}
and \dsd{p} with an affine (semicartesian) commutative monoid
$(\otimes,1,\dsd{w} :: x \spr 1)$ on \dsd{t} and
\oftp{x:\dsd{t}}{\dsd{g}(x)}{\dsd{p}}) against the rules at the
beginning of Section~\ref{sec:example:monad}.

Recall from above that $\Dia{}{A}^* =
\Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}$ and that the correspondence is:
\begin{theorem}[Logical adequacy for a non-strong monad]
\[
\begin{array}{c}
\truej{A_1}, \ldots, \truej{A_1} \vdash \truej{C}\\
\text{iff}\\
\seq{x_1:A_1^*,\ldots,x_1:A_n^*}{x_1\otimes\ldots\otimes x_n}{C^*}
\end{array}
\]
and 
\[
\begin{array}{c}
\truej{A_1}, \ldots, \truej{A_n} \vdash \possj{C}\\
\text{iff}\\
\seq{x_1:A_1^*,\ldots,x_1:A_n^*}{\dsd{g}(x_1\otimes\ldots\otimes x_n)}{\F{\dsd{g}}{C^*}}.
\end{array}
\]
\end{theorem}

\begin{proof}
We write $\Gamma^*$ as usual and \vars{\Gamma} for
$x_1\otimes\ldots\otimes x_n$.  

The three rules are represented by
\[
\infer[\FR]
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
      {\dsd{g}(\vars{\Gamma}) \spr \dsd{g}(\vars{\Gamma}) &
        \seq{\Gamma^*}{\vars{\Gamma}}{A^*}}
\]

\[
\infer[\UR]
      {\seq{\Gamma^*}{\vars{\Gamma}}{\Uempty{\dsd{g}}{\F{\dsd{g}}{C^*}}}}
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
\]

\[
\infer{\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
      {x : \Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}} \in \Gamma^* &
        \dsd{g}(\vars{\Gamma}) \spr \dsd{g}(x) &
        \infer[\FL]
              {\seq{y:\F{\dsd{g}}{A}^*}{\dsd{y}}{\F{\dsd{g}}{C^*}}}
              {\seq{z:A^*}{\dsd{g}(z)}{\F{\dsd{g}}{C^*}}}
      }
\]
(and an identity rule $\Gamma,\truej{P} \vdash \truej{P}$ would be
translated as usual).

Conversely, suppose we have a derivation of
\seq{\Gamma^*}{\vars{\Gamma}}{C^*} or
\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}.
Lemma~\ref{lem:0-use-strengthening} can be used on such derivations: the
equational axioms preserve variables and \dsd{w} removes but does not
add, so we use Lemma~\ref{lem:spr-doesnt-introduce}; and \F{\dsd{g}}{A}
and \Uempty{\dsd{g}}{A} are both relevant, so by induction the encoding
of any sequent is.

Suppose we have \seq{\Gamma^*}{\vars{\Gamma}}{C^*}.  
The hypothesis rule is translated back to itself as usual.  Since there
are no types that encode to \Fsymb, any other final rule must be \UR\/ or \UL,
and the type must be \Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}.
\begin{itemize}
\item 
If we have
\[
\infer[\UR]
      {\seq{\Gamma^*}{\vars{\Gamma}}{\Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}}}
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{A^*}}}
\]
then in the inductive hypothesis gives $\Gamma \vdash \possj{A}$, so we
have $\Gamma \vdash \truej{\Dia{}{A}}$ by rule.  

\item 
Suppose we have 
\[
\infer[\UL]
      {\seq{\Gamma^*}{\vars{\Gamma}}{C^*}}
      {x:{\Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}} \in \Gamma &
        \vars{\Gamma} \spr \beta'[\dsd{g}(x)/z] &
        \seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{\beta'}{C^*}}
\]
For this mode theory, 
the constants do not allow embedding a \dsd{p}-mode term in a
\dsd{t}-mode term.  Therefore, the subterm $\dsd{g}(x)$ cannot occur in
a ``reduct'' of \vars{\Gamma}, which has mode \dsd{t}.  Thus, $z$ does
not occur in $\beta'$, and $\vars{\Gamma} \spr \beta'$.  Applying
Lemma~\ref{lem:respectspr} to the premise gives a no-bigger derivation
of \seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{\vars{\Gamma}}{C^*}, and applying
Lemma~\ref{lem:0-use-strengthening} to strengthen away $z$ gives a
no-bigger derivation of \seq{\Gamma^*}{\vars{\Gamma}}{C^*}.
Then the inductive hypothesis gives $\Gamma \vdash \truej{C}$ as
desired.  
\end{itemize}

Suppose we have \seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}
and want $\Gamma \vdash \possj{C}$.  Since there are no \Fsymb's in the
context, the only possibilities are \UL\/ and \FR:
\begin{itemize}

\item Suppose we have
\[
\infer[\FR]
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
      {{\dsd{g}(\vars{\Gamma})} \spr \dsd{g}(\alpha) &
        {\seq{\Gamma^*}{\alpha}{C^*}}}
\]
For this mode theory, there are no there are no equalities or
transformations between terms of the form $\dsd{g}(\alpha)$ and any
other \dsd{p}-mode term besides congruence on $\alpha \spr \alpha'$, so
we can extract a transformation $\vars{\Gamma} \spr \alpha$ (such that
the given one is equal to congruence with \dsd{g} on it).  So we get
$\vars{\Gamma} \spr \alpha$ and can use Lemma~\ref{lem:respectspr} to
get a no-bigger derivation of {\seq{\Gamma^*}{\vars{\Gamma}}{C^*}}.  By
the inductive hypothesis on this premise we get $\Gamma \vdash
\truej{A}$, which gives $\Gamma \vdash \possj{A}$ as desired.  
%% : reflexivity
%% goes to reflexivity, merge composites, and rewrite any congruence 
%% $1_\dsd{g}(\alpha)$ as congruence with $\dsd{g}$

\item Suppose we have 
\[
\infer[\UL]
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
      {\begin{array}{l}
          x:{\Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}} \in \Gamma \\
          \dsd{g}(\vars{\Gamma}) \spr \beta'[\dsd{g}(x)/z] \\
          \seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{\beta'}{\F{\dsd{g}}{C^*}}
        \end{array}
      }
\]
We have \oftp{x_i:\dsd{t},z:\dsd{p}}{\beta'}{\dsd{p}}, so by inversion
the only possibilities are $z$ or $\dsd{g}(-)$, and in the latter case
$z$ does not occur, as argued above.  

If $\beta'$ is \dsd{z}, then we have 
\seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{z}{\F{\dsd{g}}{C^*}}.  By
Lemma~\ref{lem:0-use-strengthening} (strengthening away $\Gamma^*$) we
have a no-bigger derivation of
\seq{z:{\F{\dsd{g}}{A^*}}}{z}{\F{\dsd{g}}{C^*}}.
By Lemma~\ref{lem:Finv}, we can left-invert to get a no-bigger
derivation of 
\seq{z':{A^*}}{\dsd{g}{(z')}}{\F{\dsd{g}}{C^*}}.  
By the inductive hypothesis, this translates to a derivation of 
$\truej{A} \vdash \possj{C}$, so 
applying \Dia{}{}-left gives the result.

If $z$ does not occur in $\beta'$ we have $\dsd{g}(\vars{\Gamma}) \spr
\beta'$ so pushing this into the premise gives by
Lemma~\ref{lem:respectspr} gives a no-bigger derivation of
\seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}.
Then strengthening $z$ by Lemma~\ref{lem:0-use-strengthening} gives a
no-bigger derivation of
\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}.  so the
inductive hypothesis gives the result.  That is, we did an elimination
to produce a 0-use variable, which we can strengthen away.  
\end{itemize}
\end{proof}

\subsection{Strong Monad (\Crc{}{A})}

For the linear logic (commutative monoid)  mode theory, we compare the rules
\[
\infer{\Gamma \vdash \possj{A}}
      {\Gamma \vdash \truej{A}}
\qquad
\infer{\Gamma \vdash \truej{\Crc{}{A}}}
      {\Gamma \vdash \possj{A}}
\qquad
\infer{\Gamma,\truej{\Crc{}{A}},\Gamma' \vdash \possj{C}}
      {\Gamma,\Gamma',\truej{A} \vdash \possj{C}}
\]
with the mode theory consisting of a commutative monoid $(\otimes,1)$ on
\dsd{p}, a functor \dsd{g} from \dsd{t} to \dsd{p}, and 
\[
\begin{array}{ll}
\oftp{x : \dsd{t}, y : \dsd{p}}{\ttp x y}{\dsd{p}}
& \dsd{g}(x \otimes y) \deq \ttp x {\dsd{g}(y)}\\
\end{array}
\]
(We elide the equations $\ttp {(x \otimes y)} z \deq \ttp x {(\ttp y
  z)}$ and $\ttp {\dsd{1}} z \deq z$ discussed above because they
provable when $z$ is $\dsd{g}(x)$, which are the only terms that come up
in this encoding.)
%% FIXME: do proof with them, since they seem useful for the general
%% case where we consider more connectives.  

Translating \Crc{}{A} by \Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}, we have
the same adequacy statement as above:
\begin{theorem}[Logical adequacy for a strong monad]
\[
\begin{array}{c}
\truej{A_1}, \ldots, \truej{A_1} \vdash \truej{C}\\
\text{iff}\\
\seq{x_1:A_1^*,\ldots,x_1:A_n^*}{x_1\otimes\ldots\otimes x_n}{C^*}
\end{array}
\]
and 
\[
\begin{array}{c}
\truej{A_1}, \ldots, \truej{A_n} \vdash \possj{C}\\
\text{iff}\\
\seq{x_1:A_1^*,\ldots,x_1:A_n^*}{\dsd{g}(x_1\otimes\ldots\otimes x_n)}{\F{\dsd{g}}{C^*}}.
\end{array}
\]
\end{theorem}

\begin{proof}
When $\Gamma$ is $x_1:\truej{A_1}, \ldots, x_n:\truej{A_n}$, we write 
\vars{\Gamma} for $x_1 \otimes \ldots \otimes x_n$.  

The three rules are represented by
\[
\infer[\FR]
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
      {\dsd{g}(\vars{\Gamma}) \spr \dsd{g}(\vars{\Gamma}) &
        \seq{\Gamma^*}{\vars{\Gamma}}{A^*}}
\]

\[
\infer[\UR]
      {\seq{\Gamma^*}{\vars{\Gamma}}{\Uempty{\dsd{g}}{\F{\dsd{g}}{C^*}}}}
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
\]

\[
\infer{\seq{(\Gamma^* = \Gamma_1^*,x:\Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}},\Gamma_2^*)}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
      {x : \Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}} \in \Gamma^* &
        \dsd{g}(\vars{\Gamma}) \spr \ttp {(\vars{\Gamma_1} \otimes \vars{\Gamma_2})} {\dsd{g}(x)} &
        \infer[\FL]
              {\seq{\Gamma^*,z:\F{\dsd{g}}{A^*}}{\vars{\Gamma_1} \otimes \vars{\Gamma_2} \otimes z}{\F{\dsd{g}}{C^*}}}
              {\infer[Lemma~\ref{lem:weakening}]
                     {\seq{\Gamma^*,y:{A^*}}{(\vars{\Gamma_1} \otimes \vars{\Gamma_2} \otimes \dsd{g}(y)) \deq \dsd{g}(\vars{\Gamma_1} \otimes y \otimes \vars{\Gamma_2})}{\F{\dsd{g}}{C^*}}}
                     {\seq{\Gamma_1^*,\Gamma_2^*,y:{A^*}}{\dsd{g}(\vars{\Gamma_1}\otimes\vars{\Gamma_2}\otimes y)}{\F{\dsd{g}}{C^*}}}}
      }
\]
The transformation $\dsd{g}(\vars{\Gamma}) \spr \ttp {(\vars{\Gamma_1}
  \otimes \vars{\Gamma_2})} {\dsd{g}(x)}$ is an equality given by
associating and commuting $\vars{\Gamma} = (\vars{\Gamma_1} \otimes x
\otimes \vars{\Gamma_2})$ to $(\vars{\Gamma_1} \otimes \vars{\Gamma_2})
\otimes x$ and then using 
\[
\dsd{g}((\vars{\Gamma_1} \otimes
\vars{\Gamma_2}) \otimes x) \deq \ttp {(\vars{\Gamma_1} \otimes
  \vars{\Gamma_2})} {\dsd{g}(x)}
\]

An identity rule $\truej{P} \vdash \truej{P}$ is translated as usual.

Conversely, suppose we have a derivation of
\seq{\Gamma^*}{\vars{\Gamma}}{C^*} or
\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}.
Lemma~\ref{lem:0-use-strengthening} can be used on such derivations: the
equational axioms preserve variables and there are no transformations,
so we use Lemma~\ref{lem:spr-doesnt-introduce}; and \F{\dsd{g}}{A} and
\Uempty{\dsd{g}}{A} are both relevant, so by induction the encoding of
any sequent is.  We use the following properties of the mode theory:
\begin{itemize}
\item If $\alpha \spr \beta$ then $\alpha \deq \beta$, because there are
  no structural transformation axioms.

\item If $\oftp{\tptm{x_1}{\dsd{t}}, \ldots, \tptm{x_n}{\dsd{t}},
  \tptm{z}{\dsd{p}}}{\beta}{\dsd{p}}$ then $\beta$ is of the form
  $\ttp{\alpha_1}{\ttp{\alpha_2}{\ldots z}}$, or
  $\ttp{\alpha_1}{\ttp{\alpha_2}{\ldots \dsd{g}(\alpha_{n})}}$ (in which
  case $z$ does not occur).  Moreover, if $\oftp{\tptm{x_1}{\dsd{t}},
    \ldots, \tptm{x_n}{\dsd{t}}}{\beta}{\dsd{p}}$ then $\beta$ is of the
  form $\ttp{\alpha_1}{\ttp{\alpha_2}{\ldots \dsd{g}(\alpha_{n})}}$.
  This is because the only constants of mode \dsd{p} are $\ttp{}{}$,
  which has only 1 \dsd{p}-mode subposition, and \dsd{g}, which has 0,
  so any term of mode \dsd{p} must be an iterated application of
  $\ttp{}{}$ ending in either a variable (if there is one in the
  context), or \dsd{g}.

\item If $\vec{x_i : \dsd{t}} \vdash \dsd{g}(\alpha) \deq
  \dsd{g}(\beta)$ then $\alpha \deq \beta$.  We generalize and define a
  meta-operation $\oftp{\psi}{t(\alpha)}{\dsd{t}}$ when
  $\oftp{\psi}{\alpha}{\dsd{p}}$ that picks out the \dsd{t} parts of
  $\alpha$: 
  \[
  \begin{array}{l}
    t(z) = 1
    t(\ttp \alpha \beta) = \alpha \otimes t(\beta)\\
    t(\dsd{g}(\alpha)) = \alpha
  \end{array}
  \]
  It now suffices to show that $\alpha \deq \beta$ implies $t(\alpha)
  \deq t(\beta)$.  The cases for reflexivity, symmetry, and transitivity
  all follow from the inductive hypotheses and the corresponding rules.
  For the axiom $\dsd{g}(x \otimes y) \deq \ttp{x} \otimes \dsd{g}(y)$,
  we get $x \otimes y$ on both sides.  For congruence, suppose $\psi,x:q
  \vdash \alpha' \deq \beta' : \dsd{p}$ and $\psi \vdash \alpha \deq
  \beta : q$.  By the inductive hypothesis, $t(\alpha) \deq t(\beta)$.
  We distinguish cases on whether $q$ is \dsd{p} or $\dsd{t}$.  

  If the congruence variable $x$ has mode \dsd{t}, then the result
  follows from the fact that $x : \dsd{t} \vdash \alpha : \dsd{p}$
  implies $t(\alpha[\beta/x]) \deq t(\alpha)[\beta/x]$, because we get
  $t(\alpha)[\alpha'/x] \deq t(\beta)[\beta'/x]$ by the congruence rule.
  To prove this, the case for $z$ is immediate, because both sides are
  $1$.  In the case for $\dsd{g}(\alpha)$, both sides are
  $\alpha[\beta/x]$.  In the case for $\ttp{\alpha_1}{\alpha_2}$, by the
  inductive hypothesis we get $t(\alpha_2[\beta/x]) \deq
  t(\alpha_2)[\beta/x]$ by the inductive hypothesis, and we need to show
  that $\alpha_1[\beta/x] \otimes t(\alpha_2[\beta/x]) \deq (\alpha_1
  \otimes t(\alpha_2))[\beta/x]$, which is true by definition of
  substitution.
  
  If the congruence variable $x$ has mode \dsd{p}, then because all
  equational axioms have the same variables on the left and right, $x$
  occurs either on both sides or on neither.  If it occurs on neither,
  then the inductive hypothesis $t(\alpha) \deq t(\beta)$ is enough,
  because $t(\alpha[\beta/x]) = t(\alpha) \deq t(\beta) =
  t(\alpha'[\beta'/x])$.  If it occurs on both, then the result follows
  from the fact that $t(\alpha[\beta/x]) \deq t(\alpha) \otimes
  t(\beta)$, because $t(\alpha) \deq t(\beta)$ and $t(\alpha') \deq
  t(\beta')$ by the inductive hypotheses on the two subderivations, both
  of which have mode \dsd{p}.  We prove the lemma that $x : \dsd{p}
  \vdash \alpha : \dsd{p}$ (where $x$ occurs in $\alpha$) and $\beta :
  \dsd{p}$ imply $t(\alpha[\beta/x]) \deq t(\alpha) \otimes t(\beta)$ by
  induction on $\alpha$.  If it is $x$, then we have $t(\beta) \deq 1
  \otimes t(\beta)$.  It cannot be some other $y$ or $\dsd{g}(\alpha)$
  because then $x$ has no place to occur.  If it is
  $\ttp{\alpha_1}{\alpha_2}$, then by the inductive hypothesis,
  $t(\alpha_2[\beta/x]) \deq t(\alpha_2) \otimes t(\beta)$, and we have
  to show that $\alpha_1[\beta/x] \otimes t(\alpha_2[\beta/x]) \deq
  \alpha_1 \otimes t(\alpha_2) \otimes t(\beta)$.  This follows because
  $x$, which has mode \dsd{p}, cannot occur in $\alpha_1$, which has
  mode \dsd{t}.
\end{itemize}

Suppose we have \seq{\Gamma^*}{\vars{\Gamma}}{C^*}.  
The hypothesis rule is translated back to itself as usual.  Since there
are no types that encode to \Fsymb, any other final rule must be \UR\/ or \UL,
and the type must be \Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}.
\begin{itemize}
\item 
If we have
\[
\infer[\UR]
      {\seq{\Gamma^*}{\vars{\Gamma}}{\Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}}}
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{A^*}}}
\]
then the inductive hypothesis gives $\Gamma \vdash \possj{A}$, so we
have $\Gamma \vdash \truej{\Crc{}{A}}$ by rule.

\item 
Suppose we have 
\[
\infer[\UL]
      {\seq{\Gamma^*}{\vars{\Gamma}}{C^*}}
      {x:{\Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}} \in \Gamma &
        \vars{\Gamma} \spr \beta'[\dsd{g}(x)/z] &
        \seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{\beta'}{C^*}}
\]
For this mode theory, there are no transformations besides identities,
so $\vars{\Gamma} \deq \beta'[\dsd{g}(x)/z]$.  The constants do not
allow embedding a \dsd{p}-mode term in a \dsd{t}-mode term.  Therefore,
the subterm $\dsd{g}(x)$ cannot occur in a anything equal to
\vars{\Gamma}, which has mode \dsd{t}.  Thus, $z$ does not occur in
$\beta'$, and $\vars{\Gamma} \deq \beta'$.  Applying
Lemma~\ref{lem:0-use-strengthening} to strengthen away $z$ gives a
no-bigger derivation of \seq{\Gamma^*}{\vars{\Gamma}}{C^*}.  Then the
inductive hypothesis gives $\Gamma \vdash \truej{C}$ as desired.
\end{itemize}

Suppose we have \seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}
and want $\Gamma \vdash \possj{C}$.  Since there are no \Fsymb's in the
context, the only possibilities are \UL\/ and \FR:
\begin{itemize}

\item Suppose we have
\[
\infer[\FR]
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
      {{\dsd{g}(\vars{\Gamma})} \spr \dsd{g}(\alpha) &
        {\seq{\Gamma^*}{\alpha}{C^*}}}
\]

We have ${\dsd{g}(\vars{\Gamma})} \deq \dsd{g}(\alpha)$, which 
implies $\vars{\Gamma} \deq \alpha$.  By the inductive hypothesis on
the premise we get $\Gamma \vdash \truej{A}$, which gives $\Gamma \vdash
\possj{A}$ as desired.

\item Suppose we have 
\[
\infer[\UL]
      {\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}}
      {\begin{array}{l}
          x:{\Uempty{\dsd{g}}{\F{\dsd{g}}{A^*}}} \in \Gamma^* \\
          \dsd{g}(\vars{\Gamma}) \deq \beta'[\dsd{g}(x)/z] \\
          \seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{\beta'}{\F{\dsd{g}}{C^*}}
        \end{array}
      }
\]
We have \oftp{x_1:\dsd{t},\ldots,x_n:\dsd{t},z:\dsd{p}}{\beta'}{\dsd{p}}, so 
$\beta'$ is either $\ttp {\alpha_1}{\ttp \ldots z}$ 
or $\ttp {\alpha_1}{\ttp \ldots \dsd{g}{(\alpha)}}$, 
and in this case \dsd{z} does not occur.  

If $\beta'$ is $\ttp {\alpha_1}{\ttp \ldots z}$, then we have
\seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{\ttp {\alpha_1}{\ttp \ldots \ttp
    {\alpha_n} z}}{\F{\dsd{g}}{C^*}} and $\dsd{g}(\vars{\Gamma}) \deq
\ttp {\alpha_1}{\ttp \ldots \dsd{g}(x)}$.  This entails ${\vars{\Gamma}}
\deq \alpha_1 \otimes \ldots \otimes \alpha_n \otimes x$, and because
the only equations are the commutative monoid laws, $\vars{\Gamma-x}
\deq \alpha_1 \otimes \ldots \otimes \alpha_n$.  By
Lemma~\ref{lem:Finv}, we have a no-bigger derivation of
\seq{\Gamma^*,y:A^*}{\ttp {\alpha_1}{\ttp \ldots
    \dsd{g}(y)}}{\F{\dsd{g}}{C^*}}.  The subscript ${\ttp
  {\alpha_1}{\ttp \ldots \dsd{g}(y)}}$ is equal to $\dsd{g}(\alpha_1
\otimes \ldots \otimes \alpha_n \otimes y)$ and therefore
$\dsd{g}(\vars{\Gamma-x} \otimes y)$, so we have 
\seq{\Gamma^*,y:A^*}{\vars {\Gamma-x,y:A}}{\F{\dsd{g}}{C^*}}.
By Lemma~\ref{lem:0-use-strengthening}, we can strengthen away $x$,
giving a no-bigger derivation of 
\seq{(\Gamma^*-x),y:A^*}{\vars {\Gamma-x,y:A}}{\F{\dsd{g}}{C^*}}.
By the inductive hypothesis, this translates to a
derivation of $\Gamma-x,\truej{A} \vdash \possj{C}$, so applying
\Crc{}{}-left gives the result.

If $z$ does not occur in $\beta'$ we have $\dsd{g}(\vars{\Gamma}) \deq
\beta'$, so the premise is
\seq{\Gamma^*,z:{\F{\dsd{g}}{A^*}}}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}.
Then strengthening $z$ by Lemma~\ref{lem:0-use-strengthening} gives a
no-bigger derivation of
\seq{\Gamma^*}{\dsd{g}(\vars{\Gamma})}{\F{\dsd{g}}{C^*}}.  So the
inductive hypothesis gives the result.  That is, we did an elimination
to produce a 0-use variable, which we can strengthen away.
\end{itemize}
\end{proof}



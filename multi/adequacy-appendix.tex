
\newcommand\seqa[2]{\ensuremath{#1 \vdash^{\dsd a} #2}}
\newcommand\splits{\rightrightarrows}
\newcommand\vars[1]{\ensuremath{\overline{#1}}}

\appendix[Adequacy Proofs]

\subsection{Affine Logic}

Consider the following rules for affine logic, where the context is
represented by a list of assumptions labeled with variables, and $\Gamma
\splits \Delta_1,\Delta_2$ means interleaving $\Delta_1$ and $\Delta_2$
in some order equals $\Gamma$.
\[
\begin{array}{c}
\infer{\seqa{\Gamma}{P}}{P \in \Gamma}
\qquad
\infer{\seqa{\Gamma,z:A\otimes B,\Gamma'}{C}}
      {\seqa{\Gamma,\Gamma',x:A,y:B}{C}}
\qquad
\infer{\seqa{\Gamma}{A \otimes B}}
      {\Gamma \splits \Delta_1;\Delta_2 &
        \seqa{\Delta_1}{A} &
        \seqa{\Delta_2}{B}}
\\\\
\infer{\seqa{\Gamma}{A \lolli B}}
      {\seqa{\Gamma,x:A}{B}}
\qquad
\infer{\seqa{\Gamma}{C}}
      {\Gamma \splits \Delta_1;\Delta_2;(f:A \lolli B) &
        \seqa{\Delta_1}{A} &
        \seqa{\Delta_2,z:B}{C}
      }
\end{array}
\]
Weakening and exchange are admissible for these rules.  

Using the mode theory from Section~\ref{sec:ex:affine}, we translate the
propositions and contexts of adjoint logic as follows:
\[
\begin{array}{rcl}
P^* & = & P \\
(A\otimes B)^* & = & \F{x \otimes y}{x:A^*,y:B^*} \\
(A\lolli B)^* & = & \U{c.c \otimes x}{x:A^*}{B^*} \\
\\
\cdot^* & = & \cdot\\
(\Gamma,x:A)^* & = & \Gamma^*,x:A^*\\
\end{array}
\]
We also define a function that collects the variables from $\Gamma$ as a
context descriptor:
\[
\begin{array}{rcl}
\vars{\cdot} & = & 1\\
\vars{(\Gamma,x:A)} & = & \vars{\Gamma} \otimes x\\
\end{array}
\]

Overall, we have
\begin{theorem}[Adequacy of provability for $\seqa{}{}$] ~\\
$\seqa{\Gamma}{A}$ iff $\seq{\Gamma^*}{\vars{\Gamma}}{A^*}$
\end{theorem}

\begin{proof}

The forward direction is by induction on $\seqa{\Gamma}{A}$:
\begin{itemize}
\item For the hypothesis rule, we need to show
  \seq{\Gamma^*}{\vars{\Gamma}}{P}.  Because $x$ is in $\Gamma$, we can
  prove by induction on $\Gamma$ that $x:P$ is in $\Gamma^*$ and that
  $\vars{\Gamma} \deq \alpha \otimes x$.  Thus, the weakening
  transformation gives $\alpha \otimes x \spr 1 \otimes x \deq
  x$. Therefore we can derive
\[
\infer[\dsd{v}]
      {\seq{\Gamma^*}{\vars{\Gamma}}{P}}
      {x:P \in \Gamma & 
        {\vars{\Gamma}} \spr x}
\]

\item For $\otimes$-left, the inductive hypothesis gives
\seq{\Gamma^*,\Gamma'^*,x:A^*,y:B^*}{\vars{\Gamma} \otimes \vars{\Gamma'} \otimes x \otimes y}{C^*}
and we want 
\seq{\Gamma^*,z:\F{x\otimes y}{x:A^*,y:B^*},\Gamma'^*}{\vars{\Gamma} \otimes z \otimes \vars{\Gamma'}}{C^*}.
This is \FL\/ on the inductive hypothesis, with using associativity and commutativity of
$\otimes$ from the mode theory to move $x \otimes y$ to the end.  

\item 
For $\otimes$-right, we 
have \seq{\Delta_1^*}{\vars{\Delta_1}}{A^*}
and \seq{\Delta_2^*}{\vars{\Delta_2}}{B^*} by the inductive hypotheses,
which we can weaken to
 \seq{\Delta_1^*,\Delta_2^*}{\vars{\Delta_1}}{A^*}
and 
 \seq{\Delta_1^*,\Delta_2^*}{\vars{\Delta_2}}{B^*}, 
and then exchange to 
 \seq{\Gamma^*}{\vars{\Delta_1}}{A^*}
and 
 \seq{\Gamma^*}{\vars{\Delta_2}}{B^*} (using a lemma that when $\Gamma \splits \Delta_1,\Delta_2$,
$\Gamma$ and $(\Delta_1,\Delta_2)$ differ only in order, and that
 reordering is preserved by the mapped application of $*$).  
To apply \FR\/ to derive \seq{\Gamma^*}{\vars{\Gamma}}{\F{x \otimes y}{x:A,y:B}}, it thus suffices to show that 
$\vars{\Gamma} \spr \vars{\Delta_1}\otimes\vars{\Delta_2}$.  In fact
they are $\deq$,  which we can
prove by induction on $\Gamma \splits \Delta_1,\Delta_2$ using the
commutative monoids laws.  

\item For $\lolli$-right, we have
  \seq{\Gamma^*,x:A^*}{\vars{\Gamma}\otimes x}{B^*}
by the inductive hypothesis, which is exactly the premise of using \UR\/
to prove
  \seq{\Gamma^*}{\vars{\Gamma}}{\U{c.c\otimes x}{x:A^*}{B^*}}.  

\item For $\lolli$-left, we have \seq{\Delta_1^*}{\vars{\Delta_1}}{A}
  and \seq{\Delta_2^*,z:B^*}{\vars{\Delta_2}\otimes z}{C^*} by the
  inductive hypothesis, and by similar reasoning to the $\otimes R$
  case, we can weaken and exchange to
  \seq{\Gamma^*,\Gamma'^*}{\vars{\Delta_1}}{A} and
  \seq{\Gamma^*,\Gamma'^*,z:B^*}{\vars{\Delta_2}\otimes z}{C^*} and then
  finally weaken to \seq{\Gamma^*,f:(A\lolli
    B)^*,\Gamma'^*}{\vars{\Delta_1}}{A} and \seq{\Gamma^*,f:(A\lolli
    B)^*,\Gamma'^*,z:B^*}{\vars{\Delta_2}\otimes z}{C^*}.
Thus, we only need to show the transformation premise of
\[
\infer[\UL]{\seq{\Gamma^*,f:(A\lolli B)^*,\Gamma'^*}{\vars{\Gamma}\otimes f \otimes \vars{\Gamma'}}{C^*}}
      {  
        \begin{array}{l}
        {\vars{\Gamma}\otimes f \otimes \vars{\Gamma'}} \spr
        (\vars{\Delta_2} \otimes z)[f \otimes \vars{\Delta_1} /z] \\
        \seq{\Gamma^*,f:(A\lolli B)^*,\Gamma'^*}{\vars{\Delta_1}}{A} \\
        \seq{\Gamma^*,f:(A\lolli B)^*,\Gamma'^*,z:B^*}{\vars{\Delta_2}\otimes z}{C^*}
        \end{array}
      }
\]
In fact 
${\vars{\Gamma}\otimes f \otimes \vars{\Gamma'}} \deq (\vars{\Delta_2} \otimes f \otimes \vars{\Delta_1})$,
which again follows from $\Gamma \splits \Delta_1,\Delta_2$, using associativity and commutativity
of $\otimes$.  
\end{itemize}
In terms of structural property placement, observe that the above proof
uses only identity transformations on \FR\/ and \UL, and uses the
\dsd{w} axiom only at the leaves.  

In the converse direction, we generalize slightly and prove 
\begin{quote}
If $\Gamma_0 \ge \Gamma$ and $\seq{\Gamma_0^*}{\vars{\Gamma}}{A^*}$ then
$\seqa{\Gamma}{A}$
\end{quote}
where $\Gamma_0 \ge \Gamma$ means that $\Gamma_0$ contains every
assumption $x:A$ that $\Gamma$ does and possibly more (i.e. $\Gamma_0$
is a weakening of an exchange of $\Gamma$); this is a preorder.  That
is, we allow the actual context of the encoding to contain more
assumptions than the context descriptor, but all of those assumptions
will be of a type that is in the image of the translation of affine
logic.  This is necessary because of the contraction in \UL, where the
function is removed from the descriptor but not from the context itself.
The reason exchange is needed here is that commutativity can be applied
at any point in a derivation so if we start with a derivation with
context descriptor ${\vars{\Gamma}}$, the premises might always be some
exchange of it.

We need the following facts about the mode theory.  

\begin{lemma} \label{lem:affine-mode-1}
If $\alpha \spr \beta$ then $\alpha \deq \beta \otimes \beta'$
for some $\beta'$.
\end{lemma}
\begin{proof}

In the case for weakening $\alpha \spr 1$ (the only axiom), take
$\beta' = \beta$.  In the case for reflexivity take $\beta' =
1$.  In the case for transitivity, we have $\alpha \spr \beta_1
\spr \beta_2$.  By the second inductive hypothesis, we have
$\beta_1 \deq \beta_2 \otimes \beta_2'$, and by the first we have
$\alpha \deq \beta_1 \otimes \beta_1'$, so 
$\alpha \deq \beta_2 \otimes (\beta_2' \otimes \beta_1')$.  

In the case for congruence, we have
$\alpha_1[\alpha_2/x] \spr \beta_1[\beta_2/x]$
and the inductive hypotheses give
    $\alpha_1 \deq \beta_1 \otimes \beta_1'$
and $\alpha_2 \deq \beta_2 \otimes \beta_2'$.  
Thus, 
$\alpha_1[\alpha_2/x] \deq \beta_1[\beta_2 \otimes \beta_2'/x] \otimes \beta_1'[\beta_2 \otimes \beta_2'/x]$,
and then the right-hand side equals 
$\beta_1[\beta_2/x] \otimes \beta_2^n \otimes \beta_1'[\beta_2 \otimes \beta_2'/x]$
for some $n$.  
This is because, 
for this mode theory, we can rewrite any $\alpha$ as $\alpha' \otimes (x
\otimes \ldots \otimes x)$ where $\alpha'$ does not contain $x$ (because
any context descriptor is equal to a ``polynomial'' giving the
multiplicity of each variable), so in general we have $\alpha[\beta_1
  \otimes \beta_2/x] \deq \alpha' \otimes (\beta_1 \otimes \beta_2)^n
\deq \alpha' \otimes \beta_1^n \otimes \beta_2^n \deq \alpha[\beta_1/x]
\otimes \beta_2^n$.
\end{proof}

\begin{lemma} \label{lem:affine-mode-5}
If $\vars{\Gamma} \deq \alpha_1 \otimes \alpha_2$, 
then $\Gamma \splits \Gamma_1,\Gamma_2$ with 
$\vars{\Gamma_1} \deq \alpha_1$ 
and $\vars{\Gamma_2} \deq \alpha_2$.  
\end{lemma}
\begin{proof}
We define the splitting $\Gamma \splits \Gamma_1,\Gamma_2$ adding each
variable in $\Gamma$ to $\Gamma_1$ if it occurs in $\alpha_1$, or
$\Gamma_2$ if it occurs in $\alpha_2$ and not $\alpha_1$ (occurence
respects \deq).  Because $\deq$ is associativity, commutativity, and
unit, $\alpha_1$ and $\alpha_2$ have no duplicates and every variable
from \vars{\Gamma} occurs exactly once in one or the other, which gives
$\vars{\Gamma_1} \deq \alpha_1$ and $\vars{\Gamma_2} \deq \alpha_1$.
%% FIXME: last sentence is a little sketchy
\end{proof}

\begin{lemma} \label{lem:affine-mode-4}
If $\vars{\Gamma} \spr \alpha$, then there is a $\Gamma'$ such that
$\Gamma \ge \Gamma'$ and $\alpha \deq \vars{\Gamma'}$.
\end{lemma}

\begin{proof}
By Lemma~\ref{lem:affine-mode-1}, $\vars{\Gamma} \deq \alpha \otimes
\beta$ for some $\beta$.  By Lemma~\ref{lem:affine-mode-5}, this means
$\Gamma \splits \Gamma_1,\Gamma_2$ with $\vars{\Gamma_1} \deq \alpha$.
Then the fact that $\Gamma \splits \Gamma_1,\Gamma_2$ implies $\Gamma
\ge \Gamma_1$ gives the result.
\end{proof}

Moving on to the proof of the converse,

\begin{itemize}
\item In the case for the assumption rule, we have
\[
\infer{\seq{\Gamma_0^*}{\vars{\Gamma}}{P}}
      {x:P \in \Gamma_0 &
       \vars{\Gamma} \spr x}
\]
First, by Lemma~\ref{lem:affine-mode-4}, $\vars{\Gamma} \spr x$ implies
there is a $\Gamma'$ such that $\Gamma \ge \Gamma'$ and $\vars{\Gamma'}
\deq x$.  By inversion, this means, $\Gamma'$ is $x:Q$ for some $Q$.
Because $\Gamma_0 \ge \Gamma \ge x:Q$ and $x:P$ is in $\Gamma_0$, $x$
must have type $P$ in $\Gamma$ ($\ge$ implies that any variable in both
has the same type in both), so we can apply the hypothesis rule of
affine logic.

\item In the case where \UR\/ was used to derive
  \seq{\Gamma_0^*}{\vars{\Gamma}}{A^*}, $A$ must be $A_1 \lolli A_2$
  (because no other types encode to \Usymb), and the premise is
  \seq{\Gamma_0^*,x:A_1^*}{\vars{\Gamma}\otimes x}{A_2^*}.  Since
  ${\Gamma_0,x:A_1} \ge {\Gamma,x:A_1}$, the inductive hypothesis gives
  $\seqa{\Gamma,x:A_1}{A_2}$, and we can apply $\lolli$-right.

\item In the case where \FR\/ was used, the conclusion must be $(A_1
  \otimes A_2)$, and we have $\vars{\Gamma} \spr (\alpha_1 \otimes
  \alpha_2)$ with \seq{\Gamma_0^*}{\alpha_1}{A_1^*} and
  \seq{\Gamma_0^*}{\alpha_2}{A_1^*}.  By Lemma~\ref{lem:affine-mode-4},
  this means there is a $\Gamma \ge \Gamma'$ with $\vars{\Gamma'} \deq
  (\alpha_1 \otimes \alpha_2)$.  By Lemma~\ref{lem:affine-mode-5}, we
  have $\Gamma' \splits \Gamma_1,\Gamma_2$ with $\vars{\Gamma_1} \deq
  \alpha_1$ and $\vars{\Gamma_2} \deq \alpha_2$. So the premises are
  \seq{\Gamma_0^*}{\vars{\Gamma_1}}{A_1^*} and
  \seq{\Gamma_0^*}{\vars{\Gamma_2}}{A_2^*}, with $\Gamma_0 \ge \Gamma
  \ge \Gamma' \ge \Gamma_i$.  Thus, by the inductive hypotheses we get
  $\seqa{\Gamma_1}{A_1}$ and $\seqa{\Gamma_2}{A_2}$, so
  $\seqa{\Gamma'}{A_1 \otimes A_2}$.  Then weakening and exchange on
  $\Gamma \ge \Gamma'$ gives the result.

\item In the case where \FL\/ was used, we know that every assumption
  even in the larger context $\Gamma_0$ is of the form $A^*$ for some
  $A$, so the formula under elimination must be $z:(A_1 \otimes A_2)^*
  \in \Gamma_0$. The premise is
  \seq{\Gamma_0^*-z,x:A_1^*,y:A_2^*}{\vars{\Gamma}[(x \otimes
      y)/z]}{C^*}, and we want \seqa{\Gamma}{C}.

  We distinguish cases on whether $z$ (which is only known to be in
  $\Gamma_0$) is bound in $\Gamma$ or not.  

  If it is, then $\vars{\Gamma}[(x \otimes y)/z] \deq
  (\vars{\Gamma}-z)\otimes x \otimes y$, and since
  $\Gamma_0^-z,x:A_1,y:A_2 \ge \Gamma-z,x:A_1,y:A_2$, we get
  \seqa{\Gamma-z,x:A_1,y:A_2}{C} by the inductive hypothesis, and can
  apply $\otimes$-left.

  If it is not, then $\vars{\Gamma}[(x \otimes y)/z] \deq
  \vars{\Gamma}$.  Because $\Gamma_0 \ge \Gamma$ by assumption,
  ${\Gamma_0-z,x:A_1,y:A_2} \ge \Gamma$ (it removes something not in
  $\Gamma$, and adds two things).  Using the equality, the premise derives
  \seq{\Gamma_0^*-z,x:A_1^*,y:A_2^*}{\vars{\Gamma}}{C^*},
  so we get \seqa{\Gamma}{C} directly by the inductive hypothesis.  
  In this case, the given proof does a left rule on a ``0-use''
  variable that does not occur in the context descriptor, which adds
  some additional 0-use assumptions to the context.  The inductive
  hypothesis is compatible with this, and returning its result
  drops this step.    

\item In the case for \UL, the assumption $f$ that is eliminated must be
  the translation of $f:(A_1 \lolli A_2) \in \Gamma_0$ , so the premises
  are $\vars{\Gamma} \spr \beta'[f \otimes \alpha/z]$ with
  $\seq{\Gamma_0^*}{\alpha}{A_1^*}$ and
  $\seq{\Gamma_0^*,z:A_2^*}{\beta'}{C}$.

  By Lemma~\ref{lem:affine-mode-4}, there is a $\Gamma'$ with $\Gamma_0
  \ge \Gamma \ge \Gamma'$ and $\vars{\Gamma'} \deq \beta'[f \otimes
    \alpha/z]$.  Since $\vars{\Gamma'}$ has no duplicates, $z$ occurs at
  most once in $\beta'$ (or else $f$ would occur more than once in the
  substitution).
  
  %% Since every context descriptor is equal to a product of variables, we
  %% write $\vec{y} for \alpha$ and $\vec{z}$ for $\beta'$.  By
  %% Lemma~\ref{lem:affine-mode-3}, $\vec{z}[f \otimes \vec{x}/z]$ has no
  %% duplicate variable occurences, so $z$ occurs at most once in $\beta'$.

  If $z$ occurs once in $\beta'$, then because all context descriptors
  are products of variables, we can commute it to the end, writing
  $\beta' \deq \vec{y} \otimes z$, so $\vars{\Gamma'} \deq \vec{y}
  \otimes f \otimes \alpha$.  Since $f$ is in \vars{\Gamma'}, $f$ must
  be declared with some type in $\Gamma'$, and since $\Gamma_0 \ge
  \Gamma \ge \Gamma'$ and $f:A_1 \lolli A_2 \in \Gamma_0$, it must have
  the same type.  By Lemma~\ref{lem:affine-mode-5}, we can split
  $\Gamma' \splits \Gamma_1;\Gamma_2;f:A_1 \lolli A_2$ where
  $\vars{\Gamma_1} \deq \vec{y}$ and $\vars{\Gamma_2} \deq \alpha$.
  Since the splitting implies that $\Gamma' \ge \Gamma_1$ and $\Gamma'
  \ge \Gamma_2$, we have $\Gamma_0,z:A_2 \ge \Gamma_1,z:A_2$ and
  $\Gamma_0 \ge \Gamma_2$.  Moreover, we have $\beta' \deq \vec{y}
  \otimes z \deq \vars{\Gamma_1} \otimes z$ and $\alpha \deq
  \vars{\Gamma_2}$, so the premises are
  $\seq{\Gamma_0^*}{\vars{\Gamma_2}}{A_1^*}$ and
  $\seq{\Gamma_0^*,z:A_2^*}{\vars{\Gamma_1,z:A_2}}{C^*}$.  Thus, the
  inductive hypotheses give \seqa{\Gamma_2}{A_1} and
  \seqa{\Gamma_1,z:A_2}{C}, which combined with the splitting gives
  \seqa{\Gamma'}{C} by $\lolli$-left.  Finally, we have $\Gamma \ge
  \Gamma'$, so we can weaken/exchange to get \seqa{\Gamma}{C}.

  If $z$ occurs 0 times, then we have
  \seq{\Gamma_0^*,z:A_2^*}{\beta'}{C} with $\vars{\Gamma} \spr \beta'$.
  By Lemma~\ref{lem:affine-mode-4}, we get $\Gamma \ge \Gamma'$ with
  $\vars{\Gamma'} \deq \beta'$. So because $\Gamma_0 \ge \Gamma \ge
  \Gamma'$, we have $\Gamma_0,z:A_2 \ge \Gamma'$, and can use the
  inductive hypothesis on the continuation to get \seqa{\Gamma'}{C}, and
  then weaken/exchange to get \seqa{\Gamma}{C}. This part of the proof
  corresponds to eliminating a \UL\/ on a 0-use $f$ from the affine
  logic proof, which is possible because $z$ is 0-use, so the inductive
  hypothesis will remove any uses of it.
\end{itemize}
\end{proof}

\documentclass[10pt]{article}
  \usepackage{xcolor}
  \definecolor{darkgreen}{rgb}{0,0.45,0} 
  \usepackage[pagebackref,colorlinks,citecolor=darkgreen,linkcolor=darkgreen]{hyperref}
  \usepackage{pdflscape}

\usepackage[sort]{natbib}
  
\usepackage{fullpage}
\usepackage{amssymb,amsthm,bbm}
\usepackage[centertags]{amsmath}
\usepackage[mathscr]{euscript}
\usepackage{dsfont}
\usepackage{fontawesome}
\usepackage{tikz-cd}
\usepackage{mathpartir}
\usepackage{enumitem}
\usepackage[status=draft,inline,nomargin]{fixme}
\FXRegisterAuthor{ms}{anms}{\color{blue}MS}
\FXRegisterAuthor{mvr}{anmvr}{\color{olive}MVR}
\FXRegisterAuthor{drl}{andrl}{\color{purple}DRL}
\usepackage{stmaryrd}
\usepackage{mathtools}

\newtheorem{theorem}{Theorem}
\newtheorem{proposition}{Proposition}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{problem}{Problem}
\newenvironment{constr}{\begin{proof}[Construction]}{\end{proof}}

\theoremstyle{definition}
\newtheorem{definition}{Definition}
\newtheorem{remark}{Remark}
\newtheorem{example}{Example}

\let\oldemptyset\emptyset%
\let\emptyset\varnothing

\newcommand\dsd[1]{\ensuremath{\mathsf{#1}}}

\newcommand{\yields}{\vdash}
\newcommand{\Yields}{\tcell}
\newcommand{\tcell}{\Rightarrow}
\newcommand{\cbar}{\, | \,}
\newcommand{\judge}{\mathcal{J}}

\newcommand{\Id}[3]{\mathsf{Id}_{{#1}}(#2,#3)}
\newcommand{\CTX}{\,\,\mathsf{Ctx}}
\newcommand{\ctx}{\,\,\mathsf{mctx}}
\newcommand{\TYPE}{\,\,\mathsf{Type}}
\newcommand{\type}{\,\,\mathsf{mode}}
\newcommand{\TELE}{\,\,\mathsf{Tele}}
\newcommand{\tele}{\,\,\mathsf{mtele}}
\newcommand{\ISFIB}{\,\,\mathsf{IsFib}}

\newcommand{\app}[2]{\ensuremath{#1 \: #2}}
\newcommand{\telety}[3]{\ensuremath{(#1{:}#2,#3)}}
\newcommand{\mt}[0]{\ensuremath{()}}
\newcommand{\sigmacl}[3]{\ensuremath{(#1{:}#2,#3)}}
\newcommand{\fst}[1]{\app{\dsd{fst}}{#1}}
\newcommand{\snd}[1]{\app{\dsd{snd}}{#1}}
\newcommand\extend[2]{\ensuremath{(#1,\id_{#2})}}
\newcommand\TeleE[4]{\ensuremath{\mathsf{let} \, (#2, #3) \, = \, {#1} \, \mathsf{in} \, #4}}

\newcommand{\id}{\mathsf{id}}
\DeclareMathOperator{\ob}{ob}

\newcommand{\rewrite}[2]{\overleftarrow{#1}(#2)}
\newcommand\Fsym{\ensuremath{\mathsf{F}}}
\newcommand\Usym{\ensuremath{\mathsf{U}}}
\newcommand\Esym{\ensuremath{\mathsf{E}}}
\newcommand\F[2]{\ensuremath{\mathsf{F}_{#1}(#2)}}
\newcommand\E[2]{\ensuremath{\mathsf{E}_{#1}(#2)}}
\newcommand\U[3]{\ensuremath{\mathsf{U}_{#1}(#2 \mid #3)}}
\newcommand\UE[2]{\ensuremath{#1(#2)}}
\newcommand\UI[2]{\ensuremath{\lambda #1.#2}}
\newcommand\St[2]{\ensuremath{{#1}^*(#2)}}
\newcommand\StI[2]{\ensuremath{\mathsf{st}_{#1}(#2)}}
\newcommand\UStI[2]{\ensuremath{\mathsf{ust}_{#1}(#2)}}
\newcommand\UnSt[2]{\ensuremath{\mathsf{unst}_{#1}(#2)}}
%\newcommand\StE[2]{\ensuremath{\mathsf{unst}(#1,#2)}}
\newcommand\StE[4]{\ensuremath{\mathsf{let} \, \StI{#1}{#3} \, = \, {#2} \, \mathsf{in} \, #4}}
\newcommand\FE[3]{\ensuremath{\mathsf{let} \, \mathsf{F}(#2) \, = \, {#1} \, \mathsf{in} \, #3}}
% With subscript:
\newcommand\FEs[4]{\ensuremath{\mathsf{let} \, \mathsf{F}_{#1}(#3) \, = \, {#2} \, \mathsf{in} \, #4}} 
\newcommand\FI[1]{\ensuremath{\mathsf{F}{(#1)}}}
\newcommand\FIs[2]{\ensuremath{\mathsf{F}_{#1}{(#2)}}}
\newcommand\EE[3]{\ensuremath{\mathsf{let} \, \mathsf{E}(#2) \, = \, {#1} \, \mathsf{in} \, #3}}
% With subscript:
\newcommand\EEs[4]{\ensuremath{\mathsf{let} \, \mathsf{E}_{#1}(#3) \, = \, {#2} \, \mathsf{in} \, #4}} 
\newcommand\EI[1]{\ensuremath{\mathsf{E}{(#1)}}}
\newcommand\EIs[2]{\ensuremath{\mathsf{E}_{#1}{(#2)}}}
\newcommand\TypeTwo[4]{\ensuremath{#1 \vdash #2 :  #3 \tcell #4}}
\newcommand\TeleTwo[4]{\ensuremath{#1 \vdash #2 : #3 \tcell #4}}
\newcommand\TermTwo[4]{\ensuremath{#1 \vdash #2 : #3 \tcell #4}}
\newcommand\TermTwoT[5]{\ensuremath{#1 \vdash {#2} : #3 \tcell_{#5} #4}}
%% \newcommand\TermTwoDisp[5]{\ensuremath{#1 \mid #3 \tcell_{\mathsf{disp}} #2 :_{#5} #4}}
%\newcommand\SubTwo[4]{\ensuremath{#1 \mid #3 \tcell #2 : #4}}
\newcommand\TrPlus[2]{\ensuremath{{#1}^+(#2)}}
\newcommand\TrCirc[2]{\ensuremath{{#1}^\circ(#2)}}

\newcommand\El[2]{\mathcal{T}_{#1}(#2)}
\newcommand\ApEl[2]{\mathcal{T}_{#1}\langle#2\rangle}
\newcommand\bdot[0]{\mathbin{.}}
\newcommand\bang[0]{\mathord{!}}

\newcommand\ap[2]{\ensuremath{#1 \langle #2 \rangle }}
\newcommand\ApPlus[2]{\ensuremath{{#1}^+ \langle #2 \rangle }}
\newcommand\ApCirc[2]{\ensuremath{{#1}^\circ \langle #2 \rangle }}

% Lemmas
\newcommand\ctxtuple[1]{(#1)}
\newcommand\pack[1]{\ensuremath{\mathsf{pack}_{#1}}}
\newcommand\unpack[2]{\ensuremath{\mathsf{unpack}_{#1}(#2)}}
\newcommand\unp[2]{\ensuremath{{#2}^u}}

% MLTT
\newcommand{\modeof}[1]{{#1}_p}
\newcommand{\modeofq}[1]{{#1}_q}
\newcommand{\tdot}{\ensuremath{\mathtt{dot}}}
\newcommand{\tempty}{\ensuremath{\mathtt{empty}}}
\newcommand{\sdot}{\ensuremath{\mathrm{dot}}}
\newcommand{\sempty}{\ensuremath{\mathrm{empty}}}
\newcommand{\tshape}[1]{\ensuremath{\mathtt{shape}_{#1}}}

\newcommand{\qyields}{\Vdash} 
\newcommand{\upstairs}[1]{\overline{#1}}
\newcommand{\downstairs}[1]{\underline{#1}}
\newcommand\proj[1]{\ensuremath{\mathsf{proj}_{#1}}}
\newcommand\qvar[1]{\ensuremath{\mathsf{var}_{#1}}}

\newcommand\One{\ensuremath{\mathds{1}}}
\newcommand\var[1]{\ensuremath{\mathtt{var}_{#1}}}
\newcommand\ApOne[1]{\ensuremath{\One_{\langle {#1} \rangle }}}

\newcommand\mtt[1]{\mathtt{#1}}
\newcommand\contract[1]{\ensuremath{\mathtt{contract}_{#1}}}
\newcommand\fibpair[1]{\ensuremath{\mathtt{fibpair}_{#1}}}
\newcommand\pair[1]{\ensuremath{\mathtt{pair}_{#1}}}
\newcommand\tsplit[1]{\ensuremath{\mathtt{split}_{#1}}}
\newcommand\pinv[1]{\ensuremath{\mathtt{pinv}_{#1}}}

\newcommand\qunitmatch[1]{\ensuremath{\mathsf{letunit}(#1)}}
\newcommand\qpair[1]{\ensuremath{\mathsf{pair}_{#1}}}
\newcommand\qsplit[1]{\ensuremath{\mathsf{split}_{#1}}}
\newcommand\qapp[1]{\ensuremath{\mathsf{app}({#1})}}
\newcommand\qlam[1]{\ensuremath{\mathsf{lam}({#1})}}

% Adjoint type theory
\newcommand\fone[1]{\ensuremath{\mathtt{fone}_{#1}}}
\newcommand\fibf[1]{\ensuremath{\mathtt{fibf}_{#1}}}
\newcommand\foneinv[1]{\ensuremath{\fone{#1}^{-1}}}
\newcommand\fdist[1]{\ensuremath{\mathtt{fdist}_{#1}}}
\newcommand\fdistinv[1]{\ensuremath{\fdist{#1}^{-1}}}

\newcommand\flatone[1]{\ensuremath{\mathtt{flatone}_{#1}}}
\newcommand\flatdist[1]{\ensuremath{\mathtt{flatdist}_{#1}}}
\newcommand\flatdistinv[1]{\ensuremath{\flatdist{#1}^{-1}}}

\newcommand{\lock}{\text{\faUnlock}}
\newcommand{\Rtype}[1]{\mathsf{R}{#1}}
\newcommand{\RI}[1]{\mathsf{shut}({#1})}
\newcommand{\RE}[1]{\mathsf{open}({#1})}

\newcommand{\Ltype}[1]{\mathsf{L}{#1}}
\newcommand{\LI}[1]{\mathsf{left}_{#1}}
\newcommand{\LE}[1]{\mathsf{letleft}({#1})}

% Spatial type theory
\newcommand\fcomult[1]{\ensuremath{\mathtt{comult}_{#1}}}
\newcommand\fcounit[1]{\ensuremath{\mathtt{counit}_{#1}}}
\newcommand{\counit}[1]{\mathsf{counit}_{#1}}
\newcommand{\comult}[1]{\mathsf{comult}_{#1}}
\newcommand{\Flattype}[1]{\flat{#1}}
\newcommand{\FlatI}[1]{{#1}^\flat}
\newcommand{\FlatE}[1]{\mathsf{letflat}({#1})}
\newcommand{\Sharptype}[1]{\sharp{#1}}
\newcommand{\SharpI}[1]{{#1}^\sharp}
\newcommand{\SharpE}[1]{{#1}_\sharp}
\newcommand\qcrispvar[1]{\ensuremath{\textsf{crisp-var}_{#1}}}

% Linear zone
\newcommand{\fibshape}[1]{\ensuremath{{#1}_{\mathrm{fib}}}}
\newcommand{\linsnd}[1]{\mathtt{linsnd}_{#1}}
\newcommand{\linwk}[1]{\mathtt{linwk}_{#1}}
\newcommand{\frob}[1]{\mathtt{frob}_{#1}}
\newcommand\qlinvar[1]{\ensuremath{\mathsf{linvar}_{#1}}}
\newcommand\otimespair[1]{\ensuremath{\otimes\mathsf{pair}_{#1}}}
\newcommand\otimessplit[1]{\ensuremath{\otimes\mathsf{split}({#1})}}
\newcommand\linpair[1]{\ensuremath{\mathsf{linpair}_{#1}}}
\newcommand\linsplit[1]{\ensuremath{\mathsf{linsplit}({#1})}}
\newcommand\linapp[1]{\ensuremath{\mathsf{linapp}_{#1}}}
\newcommand\linlam{\ensuremath{\mathsf{linlam}}}
\newcommand{\qbang}[1]{\ensuremath{\mathsf{bang}_{#1}}}
\newcommand{\letbang}[1]{\mathsf{letbang}({#1})}

% Macros for semantics notation
\newcommand\mm[1]{\llbracket #1 \rrbracket}
\newcommand\op{^{\mathrm{op}}}
\newcommand\co{^{\mathrm{co}}}
\newcommand\coop{^{\mathrm{coop}}}
\newcommand\Set{\mathbf{Set}}
\newcommand\Cat{\mathbf{Cat}}
% \newcommand\CAT{\mathrm{CAT}}
\newcommand\M{\mathcal{M}}
\newcommand\Mhat{\widehat{\mathcal{M}}}
\newcommand\Mty{\mathsf{ty}}
\newcommand\MtySig{\mathsf{ty}^{\Sigma}}
\newcommand\Mtm{\mathsf{tm}}
% \newcommand\Mtyhat{{\widehat{\mathrm{ty}}_{\M}}}
% \newcommand\Mtmhat{{\widehat{\mathrm{Tm}}_{\M}}}
\newcommand\Ups{\Upsilon}
\newcommand\Upshat{{\widehat{\Upsilon}}}
\newcommand\C{\mathcal{C}}
\newcommand\Chat{{\widehat{\mathcal{C}}}}
\newcommand\Cty{\mathsf{TY}}
\newcommand\Cfibty{\mathsf{TY}^{\mathsf{fib}}}
\newcommand\Cfib{\C^{\mathsf{fib}}}
\newcommand\Ctm{\mathsf{TM}}
\newcommand\Cfibtm{\mathsf{TM}^{\mathsf{fib}}}
% \newcommand\Ctyhat{{\widehat{\mathrm{Ty}}}_{\C}}
% \newcommand\Cfibtyhat{{\widehat{\mathrm{Ty}}}^{\mathrm{fib}}_{\C}}
% \newcommand\Ctmhat{{\widehat{\mathrm{Tm}}}_{\C}}
% \newcommand\Cfibtmhat{{\widehat{\mathrm{Tm}}}^{\mathrm{fib}}_{\C}}
\newcommand\tight{\tau}
\newcommand\loose{\ell}
\newcommand\vp{\varpi}
\newcommand\vpst{\vp^*}
\newcommand\vpsh{\vp_!}
\newcommand\vptil{\widetilde{\vp}}
\newcommand\vpty{{\vp}_{\mathsf{ty}}}
\newcommand\vptm{{\vp}_{\mathsf{tm}}}
\newcommand\name[1]{\ulcorner #1\urcorner}
\newcommand{\Util}{\widetilde{U}}
\newcommand\ev{\mathrm{ev}}
\DeclareSymbolFont{bbold}{U}{bbold}{m}{n}
\DeclareSymbolFontAlphabet{\mathbbb}{bbold}
\newcommand\one{\mathbbb{1}}
\newcommand\ce{\mathord{\centerdot}}
\newcommand\ec{\diamond}
\newcommand\cslice{\mathbin{\sslash\!_c}}
%\newcommand\lslice{\mathbin{\sslash\!_\ell}}
\let\lslice\sslash
\newcommand\Un{U}
\newcommand\Ub{U_*}
\newcommand\Ubfib{\Ub^{\mathsf{fib}}}
\newcommand\pb{p_*}
\newcommand\qb{q_*}
\newcommand\alb{\alpha_*}
\newcommand\mub{\mu_*}
\newcommand\nub{\nu_*}
\newcommand\bb[1]{{(#1)}_*}
\newcommand{\sF}{\mathscr{F}}
% Hiragana "yo" for the Yoneda embedding, from https://arxiv.org/abs/1506.08870
\DeclareFontFamily{U}{min}{}
\DeclareFontShape{U}{min}{m}{n}{<-> udmj30}{}
\newcommand{\yon}{\!\text{\usefont{U}{min}{m}{n}\symbol{'210}}\!}

\defcitealias{lsr17multi-extended}{LSR}	
\defcitealias{ls16adjoint-extended}{LS}	

\title{A Fibrational Framework for \\ Substructural and Modal Dependent Type Theories}
\author{Daniel R. Licata, Mitchell Riley, Michael Shulman}
\date{}

\begin{document}
\maketitle

\begin{abstract}
Several recent modal extensions of homotopy type theory extend the
synthetic style of formalizing mathematics to additional situations.
For example, real-cohesive homotopy type theory can describe types with
both a groupoid structure and a separate topological structure.  These
modal dependent type theories add new types to the syntax, which
typically are given universal properties relative to new judgement
forms.  To facilitate the design of such type theories, we introduce a
general framework for modal dependent type theories.  To describe a
particular modal type theory, the first step is to specify a signature
of desired modalities using a \emph{base} directed dependent type
theory; we call such a signature a \emph{mode theory}.  Then,
instantiating a \emph{top} type theory with a given a mode theory gives
rules for working with the modalities it describes.  As examples, we
give mode theories for adjunctions, monads, comonads, and idempotent
(co)monads, in the context of a standard structural dependent type
theory, as well as a linear logic dependent on a structural one.  While
the framework does not automatically produce ``optimized'' inference
rules for a particular modal discipline (where structural rules are as
admissible as possible), it does provide a convenient syntactic setting
for investigating such issues, including a general equational theory
governing the placement of structural rules in types and in terms.  We
show that the top type theory over the above example mode theories
encode the expected rules.  Finally, we give the framework a categorical
semantics for all mode theories at once, which saves some of the effort
involved in translating each type theory individually.
%% as examples, we give mode theories for ordinary
%% non-modal dependent type theory with $\Pi$ and $\Sigma$ types, for a
%% dependent adjoint pair of modalities, and for the spatial type theory
%% used in real-cohesion.
\end{abstract}

\tableofcontents

\section{Introduction}

%% cites: Awodey and Bauer, Nuyts bridge-path, Vakar and Krishnaswami

%% fibrational: base type theory for specifying mode theories.  top type
%% theory is parametrized by a particular mode theory, gives general rules
%% that can be instantiated.  

%% Framework = both base and top

%% Mode theory = a particular signature in the base

%% In previous
%% work~\citep*{ls16adjoint,ls16adjoint-extended,lsr17multi,lsr17multi-extended},
%% the mode theory was a 2-category, or cartesian 2-multicategory.
%% Objects/types of the mode theory represent ``modes of truth,'' or
%% categories of types.  Morphisms/terms of the mode theory generate type
%% constructors, e.g. modalities.  The further 2-cell data of the mode
%% theory corresponds to structural rules, such as weakening, exchange,
%% contraction for a product, or a (co)unit or (co)multiplication of a
%% modality.  Just as a 2-category or 2-multicategory is a directed
%% \emph{simple} type theory, here we use a directed \emph{dependent} type
%% theory as the mode theory.

%% choose your own adventure organization:
%% proof theorist, Section~\ref{sec:base-syntax} and \ref{sec:top-syntax};
%% category theoriest, Section~\ref{sec:semantics},
%% examples Sections \ref{sec:mode-examples}, \ref{sec:example-encodings}.


\section{Base Type Theory}
\label{sec:base-syntax}

A \emph{mode theory} describes the contexts and types of a particular
modal dependent type theory.  Mode theories are given by a signature of
constants and equations in a directed dependent type theory, which,
because of the fibrational perpective, we call the \emph{base} type
theory.  We refer to the types of the base type theory as \emph{mode
  types} or just \emph{modes}, and terms as \emph{mode terms}, to
differentiate them from the types and terms of the top type theory.

The base type theory consists of five judgements:
\begin{itemize}
\item $\gamma \ctx$ are mode contexts
\item $\gamma \yields p \type$ are mode types
\item $\gamma \yields \mu : p$ are mode terms
\item $\TypeTwo{\gamma}{s}{p}{q}$ are \emph{mode type morphisms}
\item $\TermTwoT{\gamma}{s}{\mu}{\nu}{p}$ are \emph{mode 2-cells}
\end{itemize}
as well as corresponding judgemental equality judgements for each.
The first three judgements have the familiar structure of a dependent
type theory, while the fourth and fifth add an additional notion of
morphism between types and morphism between terms.  The mode type
morphisms can be thought of as a special class of terms, as explained
below.  A \emph{mode theory} is a signature of constants for mode types,
mode terms, mode type morphisms, and mode 2-cells.

The mode theory can be thought of as a certain kind of ``2-category with
dependent types,'' generalizing the base type theories of our previous
work~\citepalias{ls16adjoint-extended,lsr17multi-extended}, which were
2-(multi-)categories.  We describe the syntax of the base type theory in
this section, though it may be more illuminating to read the example
mode theories in Section~\ref{sec:mode-examples} in parallel with the formalism.

\subsection{Mode Contexts}
Mode contexts are, as usual, given by iteratively adding variables of
mode types:
\begin{mathpar}
  \inferrule*{ }
             {\cdot \ctx}
             
  \inferrule*
    {\gamma \ctx \\
     \gamma \yields p \type}
    {\gamma,x:p \ctx}
\end{mathpar}  

\subsection{Mode Terms}

In addition to the constants introduced by specific mode theories, there
are two ways of making mode terms: 

\begin{mathpar}
\inferrule*{ }
             {\gamma,x : p, \gamma' \yields x : p}
             
\inferrule*
    {\gamma \yields \mu : q \\
     \TypeTwo{\gamma}{s}{p}{q}
    }
    {\gamma \yields \TrPlus{s}{\mu} : p}

\TrPlus{\id}{\mu} \equiv \mu \qquad
\TrPlus{s'}{\TrPlus{s}{\mu}} \equiv \TrPlus{(s';s)}{\mu} 
\end{mathpar}

The first is the usual variable rule.  The second says a mode type
morphism $\TypeTwo{\gamma}{s}{p}{q}$ acts contravariantly on mode terms,
inducing a ``function'' $q \to p$ (since we do not have function types
in the base type theory, this means a term with a free variable $x : q
\vdash \TrPlus{s}{x} : p$), and that this action is functorial in
identity and composition of mode type morphisms (defined next).

\subsection{Mode type morphisms}

In addition to the constants of a specific mode theory, mode type
morphisms are given by identity, composition, and whiskering
(``$\mathsf{ap}$'') of a mode type on a mode term 2-cell (which are
defined below):

\begin{mathpar}
    \inferrule*{ }
          {\TypeTwo{\gamma}{\id_p}{p}{p}}
    \qquad
    \inferrule*{{\TypeTwo{\gamma}{s_1}{p_1}{p_2}} \\
                {\TypeTwo{\gamma}{s_2}{p_2}{p_3}}
          }
          {\TypeTwo{\gamma}{s_1;s_2}{p_1}{p_3}}

\inferrule*{{\gamma,x:p} \vdash {q} \type \\
            \TermTwoT{\gamma}{t}{\mu}{\mu'}{p}\\
           } 
           {\TypeTwo{\gamma}{\ap {q} {t/x}}{q[\mu/x]}{q[\mu'/x]}}

\\
\id;s \equiv s \equiv s;\id \and
(s;s');s'' \equiv s;(s';s'') \\ 
\ap q {\id_{\mu}/x} \equiv \id_{q[\mu/x]} \and
\ap q {(s;t)/x} \equiv \ap q {s/x}; \ap q {t/x} \and
\ap q {s/\_} \equiv \id_q \\ 
\ap {(q[\mu/x])} {s/y} \equiv \ap q {\ap \mu {s/y}/x} \quad \text{where } \gamma,y:p' \vdash \mu : p \text{ and } \gamma,x:p \vdash q \type\\
t[\nu/x];\ap{q'}{s/x} \equiv \ap{q}{s/x};t[\nu'/x] \quad 
\text{where } \TypeTwo{\gamma,x:p}{t}{q}{q'} \text{ and } \TermTwoT{\gamma}{s}{\nu}{\nu'}{p}
%% subst: \id_\mu[\nu/x] = \id_{\mu[\nu/x]}
%% subst: s[x/x] = s
%% subst: (s;t)[\mu/x] = s[\mu/x];t[\mu/x]
%% subst: s[\mu[\nu/x]/x] = s[\mu/x][\nu/x]
%% subst: ap q (s [\mu/x]) = (ap q s)[\mu/x] and generalization
\end{mathpar}

Most of the equations are standard identity/associativity/projection
laws.  The first two say that composition is unital and associative.
The next two say that whiskering is functorial in the identity and
composition of mode type 2-cells (defined below). The next says that
whiskering with a constant function (i.e. when $x$ does not occur in
$q$) is the identity mode type morphism.  The next says that whiskering
a type given by substitution associates with the whiskering of a mode
term 2-cell by a term (defined below).  The final equation is a
naturality law saying that the two possible definitions of a horizontal
composition $\ap t {s/x} : q[\nu/x] \tcell q'[\nu'/x]$ are equal.
We will use the following notation for this:
\begin{mathpar}
  \inferrule*[Left=Derivable]
      {\TermTwoT{\gamma}{s}{\mu}{\mu'}{p} \\
        \TypeTwo{\gamma, x : p}{t}{q}{q'}}
      {\TypeTwo{\gamma}{\ap{t}{s/x} :\equiv t[\nu/x];\ap{q'}{s/x}}{q[\mu/x]}{q'[\mu'/x]}}
\\ 
\ap{\id_q}{s/x} \equiv \ap{q}{s/x} \and \ap{t}{\id_{\mu}/x} \equiv t[\mu/x]
\end{mathpar}

We sometimes write \ap{q}{s} for \ap{q(x)}{s/x}, eliding the variable
name when it is clear how to view $q$ as a term with a distinguished
variable.

\subsection{Mode term 2-cells}

Similarly, mode term 2-cells are given by identity, composition, and
post-whiskering (pre-whiskering is given by substitution), and
associated equations:
\begin{mathpar}
    \inferrule*{ }
          {\TermTwoT{\gamma}{\id_\mu}{\mu}{\mu}{p}}
    \quad
    \inferrule*{{\TermTwoT{\gamma}{s_1}{\mu_1}{\mu_2}{p}} \\
                {\TermTwoT{\gamma}{s_2}{\mu_2}{\mu_3}{p}}
          }
   {\TermTwoT{\gamma}{s_1;s_2}{\mu_1}{\mu_3}{p}}
\quad
\inferrule*{{\gamma,x:p} \yields {\nu} : {q} \\
            \TermTwoT{\gamma}{s}{\mu}{\mu'}{p}\\
           } 
           {\TermTwoT{\gamma}{\ap \nu {s/x}}{\nu[\mu/x]}{\TrPlus{\ap{q}{s/x}}{\nu[\mu'/x]}}{q[\mu/x]}}

\\           
\id;s \equiv s \equiv s;\id \and
(s;s');s'' \equiv s;(s';s'') \\ 
\ap \nu {\id_{\mu}/x} \equiv \id_{\nu[\mu/x]} \and
\ap \nu {(s;t)/x} \equiv \ap \nu {s/x} ; (\ap {(\TrPlus{\ap{q}{s/x}}{y})} {\ap \nu {t/x}/y}) \\ 
\ap x {s/x} \equiv s  \\ 
\ap {(\nu[\mu/x])} {s/y} \equiv \ap \nu {\ap \mu {s/y}/x} \quad
\text{where } \gamma,y:p' \vdash \mu : p \text{ and } \gamma,x:p \vdash \nu : q\\
\ap \nu {s/\_} \equiv \id_\nu \\
t[\mu/x];\ap{\nu'}{s/x} \equiv \ap{\nu}{s/x};\ap{(\TrPlus{\ap{q}{s/x}}{y})}{t[\mu'/x]/y} \quad
 \text{where } \TermTwoT{\gamma,x:p}{t}{\nu}{\nu'}{q} \text{ and } \TermTwoT{\gamma}{s}{\mu}{\mu'}{p} \\
\ap{(\TrPlus{s}{\mu})}{t/x} \equiv \ApPlus{(s[\nu/x])}{\ap{\mu}{t/x}}\quad 
\text{where } \TypeTwo{\gamma,x:p}{s}{q}{q'} \text{ and }
\TermTwoT{\gamma}{t}{\nu}{\nu'}{p} \text{ and } \gamma,x:p \vdash \mu : q'
\end{mathpar}

Identity and composition are standard.  When $q$ does not depend on $x$,
whiskering the ``function'' $x : p \vdash \nu : q$ onto the mode term
2-cell $s : \mu \tcell_p \mu'$ between two mode terms $\mu,\mu'$ of
mode $p$ gives a term 2-cell $\nu[\mu/x] \tcell_q \nu[\mu'/x]$.
However, in general $q$ might depend on $x$, in which case we have a
``dependent $\mathsf{ap}$'', which gives a mode term in $q[\mu/x]$
between $\nu[\mu/x]$ and the ``transport'' of $\nu[\mu'/x]$ along the
mode type morphism $\ap q {s/x} : q[\mu/x] \tcell q[\mu'/x]$ (in
the non-dependent case, the above equations say that $\ap q {s/x} \equiv
\id_q$, and that $\TrPlus{\id_q}{\nu[\mu'/x]} \equiv {\nu[\mu'/x]}$, so
the ``transport'' cancels).

As with whiskering of types,
we sometimes write \ap{\mu}{s} for \ap{\mu(x)}{s/x}, eliding the
variable name when it is clear how to view $\mu$ as a term with a
distinguished variable; e.g. $\ApPlus{s}{t}$ for
$\ap{\TrPlus{s}{x}}{t/x}$.

The first two equations say that composition is associative and unital.
The next two say that whiskering is functorial in mode term 2-cell identity
and composition; the composition equation is the usual ``path over''
composition using whiskering, and both equations type check because of
the functoriality equations for $\TrPlus{s}{-}$.  The next two equations
say that whiskering is functorial in the function position: whiskering
with the identity function is the identity, and whiskering with a
composition is iterated whiskering.  The next equation says that
whiskering with a constant function ($x$ does not occur in $\nu$) is the
identity.

The next equation equates the two potential definitions of horizontal
composition $\ap t {s/x} : \nu[\mu/x] \tcell_{q[\mu/x]}
\TrPlus{\ap{q}{s/x}}{\nu'[\mu'/x]}$.  We write
\begin{mathpar}
  \inferrule*[Left=Derivable]
      {\TermTwoT{\gamma}{s}{\mu}{\mu'}{p} \\
    \TermTwoT{\gamma, x : p}{t}{\nu}{\nu'}{q}}
             {\TermTwoT{\gamma}{\ap{t}{s/x} :\equiv t[\mu/x];\ap{\nu'}{s/x}}{\nu[\mu/x]}{\TrPlus{\ap{q}{s/x}}{\nu'[\mu'/x]}}{q[\mu/x]}}
\\ 
\ap{\id_\nu}{s/x} \equiv \ap{\nu}{s/x} \and \ap{t}{\id_{\mu}/x} \equiv t[\mu/x]
\end{mathpar}
for this.

The final equation distributes the $\mathsf{ap}$ of a ``transport'' 
$\TrPlus{s}{\mu}$ into two $\mathsf{ap}$'s, and type checks because 
$s[\nu/x];\ap{q'}{t/x} \equiv \ap{q}{t/x};s[\nu'/x]$.
In more detail, we initially type the two sides of this equation as
\begin{mathpar}
  \infer*{\infer*{\gamma,x:p \vdash \mu : q' \\ \TypeTwo{\gamma,x:p}{s}{q}{q'}}
    {\gamma, x:p \vdash \TrPlus{s}{\mu} : q} \\
    \TermTwoT{\gamma}{t}{\nu}{\nu'}{p}
    }
  {\TermTwoT{\gamma}{\ap{(\TrPlus{s}{\mu})}{t/x}}{(\TrPlus{s}{\mu})[\nu/x]}{\TrPlus{\ap{q}{t/x}}{(\TrPlus{s}{\mu})[\nu'/x]}}{q[\nu/x]}}
  \and
  \infer*{
    \infer*{\gamma,x:p \vdash \mu : q' \\ \TermTwoT{\gamma}{t}{\nu}{\nu'}{p}}
    {\TermTwoT{\gamma}{\ap{\mu}{t/x}}{\mu[\nu/x]}{\TrPlus{\ap{q'}{t/x}}{\mu[\nu'/x]}}{q'[\nu/x]}}
    \\
    \infer*{\infer*{\gamma \vdash \nu : p \\ \TypeTwo{\gamma,x:p}{s}{q}{q'}}{\TypeTwo{\gamma}{s[\nu/x]}{q[\nu/x]}{q'[\nu/x]}}}
    {\gamma, u:q'[\nu/x] \vdash \TrPlus{s[\nu/x]}{u} : q[\nu/x]}}
  {\TermTwoT{\gamma}{\ap{(\TrPlus{s[\nu/x]}{u})}{\ap{\mu}{t/x}/u}}{\TrPlus{s[\nu/x]}{\mu[\nu/x]}}{\TrPlus{\ap{q[\nu/x]}{\ap{\mu}{t/x}/u}}{(\TrPlus{s[\nu/x]}{\TrPlus{\ap{q'}{t/x}}{\mu[\nu'/x]}})}}{q[\nu/x][\mu[\nu/x]/u]}}.
\end{mathpar}
where in the given equation $\ap{(\TrPlus{s[\nu/x]}{u})}{\ap{\mu}{t/x}/u}$ is abbreviated, in line with our above conventions, as $\ApPlus{(s[\nu/x])}{\ap{\mu}{t/x}}$.
Since $u$ does not occur in $q[\nu/x]$, we have
\begin{align*}
  q[\nu/x][\mu[\nu/x]/u] &\equiv q[\nu/x]\\
  \ap{q[\nu/x]}{\ap{\mu}{t/x}/u} &\equiv \id_{q[\nu/x]}
\end{align*}
so the second type reduces to
\[ \TermTwoT{\gamma}{\ApPlus{(s[\nu/x])}{\ap{\mu}{t/x}}}{\TrPlus{s[\nu/x]}{\mu[\nu/x]}}{(\TrPlus{s[\nu/x]}{\TrPlus{\ap{q'}{t/x}}{\mu[\nu'/x]}})}{q[\nu/x]}
\]
and we can compute, using the definition of substitution and previously-given equations:
\begin{align*}
  (\TrPlus{s}{\mu})[\nu/x] &\equiv \TrPlus{s[\nu/x]}{\mu[\nu/x]}\\
  \TrPlus{\ap{q}{t/x}}{(\TrPlus{s}{\mu})[\nu'/x]}
  &\equiv \TrPlus{\ap{q}{t/x}}{\TrPlus{s[\nu'/x]}{\mu[\nu'/x]}}\\
  &\equiv \TrPlus{\ap{q}{t/x};s[\nu'/x]}{\mu[\nu'/x]}\\
  &\equiv \TrPlus{s[\nu/x];\ap{q'}{t/x}}{\mu[\nu'/x]}\\
  &\equiv \TrPlus{s[\nu/x]}{\TrPlus{\ap{q'}{t/x}}{\mu[\nu'/x]}}.
\end{align*}

\subsection{Mode Unit Types}

It will be useful to have the unit mode type in the base type theory:

\begin{mathpar}
  \inferrule*{ } { \gamma \yields 1 \type } \and
  
  \inferrule*{ }
             {\gamma \yields \mt : 1}
  \and 
  \mu \equiv \mt
  \and
s \equiv \id_{()} \text{ for } \yields s : () \tcell_1 ()
\end{mathpar}

\subsection{Mode $\Sigma$ types}
\label{sec:base-telescopes}

It will also be convenient to have $\Sigma$ mode types.  We write these
as telescopes $\sigmacl{x}{p}{q}$ to distinguish them from the $\Sigma$
types of an object language.  At the mode type and term level, the rules
are standard:
\begin{mathpar}
  \inferrule*{ \gamma \yields p \type \\ 
               \gamma,x:p \yields q \type }
             {\gamma \yields \sigmacl{x}{p}{q} \type} \\
             
\\
\inferrule*{
  \gamma \yields \mu : p \and
  \gamma \yields \nu : q[\mu/x]
    }
   {\gamma \yields (\mu,\nu) : \sigmacl{x}{p}{q}}
\and
\inferrule*
    {\gamma \yields \mu : \sigmacl{x}{p}{q}}
    {\gamma \yields \fst \mu : p}
\and
\inferrule*
    {\gamma \yields \mu : \sigmacl{x}{p}{q}}
    {\gamma \yields \snd \mu : q[\fst \mu / x]}
    \\
    \fst{(\mu,\nu)} \equiv \mu \and
    \snd{(\mu,\nu)} \equiv \nu \and
    p \equiv (\fst p, \snd p)
\end{mathpar}

Next, we assert a congruence rule for $\Sigma$-types on mode type
morphisms:
\begin{mathpar}
  \inferrule*
  {\TypeTwo{\gamma}{s}{p}{p'} \\
    \TypeTwo{\gamma,x':p'}{t}{q[\TrPlus{s}{x'}/x]}{q'}}
  {\TypeTwo{\gamma}{\sigmacl{x'}{s}{t}}{\sigmacl{x}{p}{q}}{\sigmacl{x'}{p'}{q'}}} 
  \\
    \sigmacl{x'}{\id_p}{\id_q} \equiv \id_{\sigmacl{x'}{p}{q}} \\
  (\sigmacl{x'}{s}{t});(\sigmacl{x''}{s'}{t'}) \equiv \sigmacl{x''}{(s;s')}{(t[\TrPlus{s'}{x''}/x'];t')} \\

  \ap{(\sigmacl{x'}{p}{q})}{s/(y:r)} \equiv
  \sigmacl{x'}{\ap{p}{s/y}}{\ap{({q[\fst z/x,\snd z/y]})}{\extend{s}{x'}/z:(\sigmacl{y}{r}{p})}}
  \\
  \TrPlus{(\sigmacl{x}{s}{t})}{\mu} \equiv (\TrPlus{s}{\fst \mu},\TrPlus{(t[\fst \mu/x])}{\snd \mu})
\end{mathpar}
The first three equations say that this interacts with identity,
compositions, and whiskering: The $\Sigma$ of two identities is the
identity.  The composition of two $\Sigma$ morphisms is the $\Sigma$ of
the composites.  The generic whiskering for mode type morphisms, when
instantiated with a $\Sigma$ mode, is equal to the appropriate instance
of this congruence rule (we write $\ap{q}{s/(x:p)}$ to indicate the type
of the variable involved in the $\mathsf{ap}$).  The final equation says
that the ``transport'' along the $\Sigma$ of two mode type morphisms
acts componentwise.

Finally, we add mode term 2-cells for $\Sigma$ mode types.  It suffices
to add the ``horizontal'' mode term 2-cells (non-trivial in the first
component), because the ``vertical'' ones (non-trivial in the second
component) are given by a whiskering: if $t : \nu \tcell_{q[\mu/x]}
\nu'$ then $\ap{(\mu,y)}{t/y} : (\mu,\nu) \tcell_{\sigmacl{x}{p}{q}}
(\mu,\nu')$.  The rules are:
\begin{mathpar}
\inferrule*
    {\TermTwoT{\gamma}{s}{\mu}{\mu'}{p} \and
      \gamma \vdash \nu' : q[\mu'/x]
    }
      {\TermTwoT{\gamma}{\extend{s}{\nu'}}{(\mu,\TrPlus{\ap{q}{s/x}}{\nu'})}{(\mu',\nu')}{\sigmacl{x}{p}{q}}}\\
\ap {\fst} {\extend{s}{\nu'}} \equiv s \and
\ap {\snd} {\extend{s}{\nu'}} \equiv \id_{\TrPlus{\ap{q}{s/x}}{\nu'}}  \and
s \equiv (\ap{\fst}{s}, \ap{\snd}{s}) %% \quad \text{where } \TermTwoT{\gamma}{s}{\mu}{\mu'}{\sigmacl{x}{p}{q}}
\\      
{\extend{\id_\mu}{\nu'}} \equiv \id_{(\mu,\nu')} \and
{\extend{(s;s')}{\nu''}} \equiv  \extend{s}{\TrPlus{\ap{q}{s'/x}}{\nu''}};\extend{s'}{\nu''}   \\
\extend{s}{\nu'} ; (\ap{(\mu',y)}{t/y}) \equiv
(\ap{(\mu,\TrPlus{(\ap{q}{s})}{y})}{t/y}); \extend{s}{\nu''} \qquad \text{where }\TermTwoT{\gamma}{t}{\nu'}{\nu''}{q[\mu'/x]}
\end{mathpar}

The equations make use of the following definable abbreviations for
pairing and projection 2-cells:
\begin{mathpar}
  \inferrule*[Left=Derivable]
      {\TermTwoT{\gamma}{s}{\mu}{\mu'}{p} \\
    \TermTwoT{\gamma}{t}{\nu}{\TrPlus{\ap{q}{s}}{\nu'}}{q[\mu/x]}}
             {\TermTwoT{\gamma}{(s,t) :\equiv \ap{(\mu,y)}{t/y};\extend{s}{\nu'}}{(\mu,\nu)}{(\mu',\nu')}{\sigmacl{x}{p}{q}}}
  \\
   \inferrule*[Left=Derivable]
              { {\TermTwoT{\gamma}{s}{\mu}{\mu'}{\sigmacl{x}{p}{q}}} }
              { {\TermTwoT{\gamma}{\ap{\fst}{s} := \ap{\fst(y)}{s/y}}{\fst{\mu}}{\fst{\mu'}}{p}} }
  \\
   \inferrule*[Left=Derivable]
              { {\TermTwoT{\gamma}{s}{\mu}{\mu'}{\sigmacl{x}{p}{q}}} }
              { {\TermTwoT{\gamma}{\ap{\snd}{s} := \ap{\snd(y)}{s/y}}{\snd{\mu}}{\TrPlus{\ap{(q(\fst y/x))}{s/y}}{\snd{\mu'}}}{q[\fst{\mu}/x]}} }
\end{mathpar}
%
The first two equation are the $\beta$ rules for morphisms in $\Sigma$
modes.  The next is an $\eta$ (the right-hand side expands to
\ap{(\fst{\mu},y)}{\ap{(\snd z)}{s/z}/y};\extend{\ap{(\fst{z})}{s/z}}{\snd{\mu'}}).
The next two equations give functoriality on identity and composition of
mode term 2-cells in $p$. The final naturality equation
reconciles the two possible ways of defining $(s,t)$.  

The derivable general pairing 2-cell interacts with identity and
composition: we have $(\id_\mu,\id_{\nu}) \equiv \id_{(\mu,\nu)}$ 
and, for mode term 2-cells 
\TermTwoT{\gamma}{s}{\mu}{\mu'}{p} and 
\TermTwoT{\gamma}{t}{\nu}{\TrPlus{\ap{q}{s}}{\nu'}}{q[\mu/x]} and 
\TermTwoT{\gamma}{s'}{\mu'}{\mu''}{p} and 
\TermTwoT{\gamma}{t'}{\nu'}{\TrPlus{\ap{q}{s'}}{\nu''}}{q[\mu'/x]}
we have
\begin{align*}
(s, t);(s', t') \equiv ((s;s'), (t;\ApPlus{\ap{q}{s}}{t'}))
\end{align*}
This follows by
\begin{align*}
(s, t);(s', t') 
&\equiv \ap{(\mu,y)}{t/y};\extend{s}{\nu'};\ap{(\mu',y)}{t'/y};\extend{s'}{\nu''} \\
&\equiv \ap{(\mu,y)}{t/y};\ap{(\mu, \TrPlus{\ap{q}{s}}{y})}{t'/y};\extend{s}{\TrPlus{\ap{q}{s'}}{\nu''}};\extend{s'}{\nu''} \\
&\equiv \ap{(\mu,y)}{t/y};\ap{(\mu, y)}{\ApPlus{\ap{q}{s}}{t'}/y};\extend{s}{\TrPlus{\ap{q}{s'}}{\nu''}};\extend{s'}{\nu''} \\
&\equiv \ap{(\mu,y)}{t;\ApPlus{\ap{q}{s}}{t'}/y};\extend{s;s'}{\nu''} \\
&\equiv ((s;s'), (t;\ApPlus{\ap{q}{s}}{t'}))
\end{align*}

\begin{remark}
An alternative to specifying the mode term morphisms in $\Sigma$-types
as above would be to have mode telescopes as part of the judgement
structure.  For example, if we had a primitive ``Frobenius'' whiskering
that acted on the middle of the context:
\[
\inferrule*{{\gamma,x:p,\gamma'} \vdash {q} \type \\
            \TermTwoT{\gamma}{t}{\mu}{\mu'}{p}\\
           } 
           {\TypeTwo{\gamma,\vec{y}:\gamma'[\mu'/x]}{\ap {q} {t/x}}{q[\mu/x,\TrPlus{\ap{\gamma'}{s}}{\vec{y}}/y]}{q[\mu'/x]}}
\]
(and similarly for terms) then $(s,\mathsf{id})$ would be a special
case.  Conversely, we can define these Frobenius whiskerings by packing
$x:p,\gamma'$ into a mode $\Sigma$ type.  Though the telscope approach
would be more judgemental, it adds a bit of weight to the presentation,
which we choose to avoid here.
\end{remark}

\subsection{Substitution}
  All judgements have an admissible substitution principle
\begin{mathpar}
  \inferrule*{\gamma,x:p,\gamma' \yields J \\
              \gamma \yields \mu : p
              }
             {\gamma,\gamma'[\mu/x] \yields J[\mu/x]} \\

J[\mu/x][\nu/y] \equiv J[\nu/y][\mu[\nu/y]/x]
\end{mathpar}


\section{Example Mode Theories}
\label{sec:mode-examples}

In this section, we give some example mode theories that, when plugged
into the top type theory introduced in Section~\ref{sec:top-syntax},
produce some familiar type theories, as we show in
Section~\ref{sec:example-encodings}.  We hope this section will help the
reader understand how the type theory of Section~\ref{sec:base-syntax}
can be used to describe some familiar categorical structures, though it
will be necessary to read Sections~\ref{sec:top-syntax}
and~\ref{sec:example-encodings} to understand why these particular
structures are the ones we wish to consider.

All of these mode theory definitions should be thought of as portions of
a signature of assumed constants and equation generating mode types,
mode terms, etc.  Some mode theories will build on others; for example,
the theory of an adjoint triple would extend the theory of an
adjunction.  Because of this, we phrase the mode theories in this
section not as introducing new constants (``the signature for an
adjunction consists of new constants for mode types $\mathsf{p},
\mathsf{q}$, new constants for mode terms $x : \mathsf{p} \vdash
\mathsf{f}(x) : \mathsf{q}$, \ldots'') but as structure/properties on
existing mode types/terms, so that signature fragments can be composed.
In a proof assistant for the framework, we envision using some kind of
module system to manage these mode theory fragments, and to assume
certain mode types, terms, etc. exist---there are no
interesting mode types in the empty context, so some
uninterpreted constants will certainly need to be introduced.  Though we are
technically working at the meta-level here, and so could make statements
about the mode theory that are only \emph{admissible} (require knowing
the totality of the mode theory), we will be careful to only make
\emph{derivable} statements (ones that depend only on knowing the
existence of certain mode types/terms/etc., not the absence of others).

When describing a mode theory, we omit the ambient mode context
$\gamma$, but all definitions should be understood to take place in an
arbitrary such context.

We will often treat mode terms with a distinguished parameter as though
they were functions, because $f(\mu)$ is shorter than $f[\mu/x]$.  We do
this when $\gamma, x : p \yields f : q$ and the fact that it should be a
function of $x$ is clear from context.

As usual with logical frameworks, there can be a bit of terminological
confusion, because we are using a type theory to describe other type
theories; here, this is compounded by the fact that the framework itself
consists of two type theories, the base described above and the top
described below.  For this section, we will say ``mode context'', ``mode
type'', etc. for the contexts, types, etc. of the base type theory, and
``context'', ``dependent type'', etc. for the constructions in the base
type theory that correspond to contexts, dependent types, etc. in an
encoded language.  

\subsection{Adjoint Mode Terms}

Adjunctions in the mode theory played a role in our previous work,
because an adjunction in the base generates to a triple adjunction in
the top---this is because a single mode term in the base generates an
adjunction in the top, and an adjoint pair of adjunctions is a triple
adjunction.  Additional examples of such triple adjunctions will come up
here---for example as in the Lawvere definition of quantifiers
$\exists_x \dashv \pi_x \dashv \forall_x$ in first-order logic.
Exploiting the fact that the mode types, mode terms, and mode term
2-cells in every context $\gamma$ of the mode theory form a 2-category,
we can give the usual definition of an adjunction in a 2-category:

\begin{definition} \label{def:adjunction}
For mode types $p$ and $q$, a mode term $x : p \yields f : q$ is
\emph{left adjoint} to $y : q \yields u : p$ if there are mode term
2-cells:
\begin{align*}
 x : p &\yields \eta_x : x \tcell_p u(f(x)) \\
 y : q &\yields \varepsilon_y : f(u(y)) \tcell_q y
\end{align*}
such that $\eta$ and $\varepsilon$ are natural:
\begin{align}
\eta_x ; \ap{u}{\ap{f}{s}} &\equiv s ; \eta_{x'} && \text{for all } s : x \tcell_p x'  \\
\ap{f}{\ap{u}{t}} ; \varepsilon_{y'}  &\equiv \varepsilon_y ; t && \text{for all } t : y \tcell_q y'
\end{align}
and the triangle identities hold:
\begin{align}
\eta_{u(\nu)};\ap{u}{\varepsilon_\nu} &\equiv \id_{u(\nu)} \\
\ap{f}{\eta_\mu};\varepsilon_{f(\mu)} &\equiv \id_{f(\mu)}
\end{align}
\end{definition}

\subsection{Terminal Objects}

A (closed) mode type $p \type$ will represent a category of contexts or
closed types, where mode terms of type $p$ correspond to contexts, and
mode term 2-cells $\alpha \tcell_p \beta$ correspond to certain
substitutions (those that are ``structural rules'') between contexts
$\alpha$ and $\beta$.  In structural (as opposed to substructural) type
theories, the empty context is terminal:

\begin{definition}
For $p \type$, a term $\emptyset : p$ is \emph{terminal} if there are mode term 2-cells
\begin{mathpar}
\TermTwoT{x : p}{!_x}{x}{\emptyset}{p}
\end{mathpar}
such that $t \equiv \bang_x$ for all $\TermTwoT{\gamma}{t}{\mu}{\emptyset}{p}$.
\end{definition}

%\begin{definition}
%For a dependent mode $x : p \vdash S(x) \type$, a \emph{fibred terminal object} term is specified by:
%\begin{mathpar}
%x : p \vdash \One_x : S(x) \and
%\TermTwoT{x : p, \mu : S(x)}{!_\mu}{\mu}{\One_x}{S(x)}
%\end{mathpar}
%such that
%\begin{align}
%\label{bang-unique}
%t & \equiv \bang_\mu && \text{where } \TermTwoT{\gamma}{t}{\mu}{\One_\alpha}{S(\alpha)}\\
%\label{s-plus-one-strict}
%\TrPlus{\ap{S}{s}}{\One_\alpha} &\equiv \One_\beta && \text{where } \TermTwoT{\gamma}{s}{\beta}{\alpha}{p}
%\end{align}
%\end{definition}

\subsection{Comprehension Object}

Suppose we would like a mode type $p$ to represent the contexts of a
dependent type theory.  In addition to a terminal object $\emptyset$
representing the empty context, there must be a notion of dependent type
over each context from $p$, with an operation extending a context with a
dependent type.  To represent dependent types in context $\alpha:p$, we assume a mode type
$\alpha : p \vdash \El{p} \alpha \type$ that is dependent on $p$.  Context
extension should then be an operation that takes mode terms $\alpha : p$
and $x : \El{p}{\alpha}$ to a mode term $\alpha.x : p$ representing the
extended context.

Since every mode type in the base type theory, including dependent ones,
comes with a notion of 2-cell, the base type theory includes mode term
2-cells $x \tcell_{\El p \alpha} y$ for $\alpha : p$ and $x,y : \El p
\alpha$.  Thus, for each context $\alpha : p$, there is a \emph{category} of
types in context $\alpha$, whose objects are mode terms $x,y$ of type
$\El{p}{\alpha}$, and whose morphisms are mode term 2-cells of type
$\El{p}{\alpha}$.  Because of this, our setting bears some resemblence
to Lawvere's approach to first-order and related logics via
hyperdoctrines~\citep{lawvere70comprehension}.  In terms of categorical
semantics of dependent types, the best analogy is to think of
$\sigmacl{\alpha}{p}{\El{p}{\alpha}} \twoheadrightarrow p$ as the
fibration part of a comprehension category~\citep{jacobs93compcat}, in
which case the mode term 2-cells $x \tcell_{\El p \alpha} y$ are like
the fibers in the fibration of types over contexts---i.e. the portion of
a comprehension category that is typically ignored by making the
comprehension category discrete or full.

Here, rather than ignoring this data, we will use mode term 2-cells $x
\tcell_{\El p \alpha} y$ as a notion of ``term''.  There are two reasons
for this: First, when we consider dependently indexed linear logics in
Section~\ref{sec:mode-example-lin}, the fibration is neither full nor
discrete.  Second, for the way in which the base type theory is used by
the top type theory, we will sometimes want morphisms in the fiber
$\El{p}{\alpha}$, rather than e.g. sections of projection in $p$, so it
is more direct to use the morphisms in the fiber throughout than to use
sections of projection and stipulate the fibration to be full (in the
sense that of there being a bijection between mode term 2-cells $x
\tcell_{\El{p}{\alpha}} y$ and mode term 2-cells $\alpha.x \tcell_p
\alpha.y$ that commute with projection).

However, morphisms in the fiber $x \tcell_{\El p \alpha} y$ have a
context $\alpha$, a target type $y$, as well as a source type $x$, while
sections of projection in $p$ would be maps $\alpha \tcell_p \alpha.y$,
and have only a context and target type.  Thus, to use maps in the fiber
as terms in the usual sense of dependent type theory, it is necessary to
have a distinguished type $\One_\alpha$ to use in place of $x$, so that
terms of type $y$ in context $\alpha$ are represented by maps in the
fiber $\One_\alpha \tcell_{\El p \alpha} y$ for that distinguished
object.  The final necessary ingredient is then to stipulate some notion
of comprehension, providing the projection, variable, and
substitution-for-an-extended-context operations associated to the
context extension $\alpha.x$ in dependent type theory.  In this
notation, this means we want substitutions $\beta \tcell_p \alpha.x$ to
correspond to pair of substitutions $s : \beta \vdash_p \alpha$ and
terms $\One_\alpha \vdash \TrPlus{s}{x}$, using the ``transport''
$\TrPlus{s}{-} : \El{p}{\alpha} \to \El{p}{\beta}$ to model substitution
in the object language.

Having objects $\One_\alpha$ with such a correspondence is very close to
Lawvere's definition of comprehension~\citep{lawvere70comprehension} in
a hyperdoctrine, as reformulated by
Ehrhard~\citep{ehrhardXXcomprehension} to apply to any fibration
(avoiding the use of the pushforwards in a bifibration in Lawvere's
formulation).  In our notation, Ehrhard's definition says that first
there is a mode term (functor) $p \to
\sigmacl{\alpha}{p}{\El{p}{\alpha}}$, which is a section of the
projection $\fst : \sigmacl{\alpha}{p}{\El{p}{\alpha}} \to p$, and picks
out fiberwise terminal objects, and second that this functor has a right
adjoint.  We can simplify the terminal object condition to having a mode
term $\alpha : p \vdash \One_\alpha : \El{p} \alpha$, which is a section
of $\fst$ by typing, such that each $\One_\alpha$ is terminal in
$\El{p}{\alpha}$.  Then the right adjoint (as a bijection on homsets)
gives a bijection between mode term 2-cells $\beta \tcell_p \alpha.x$
and mode term 2-cells $(\beta,\One_\beta)
\vdash_{\sigmacl{\alpha}{p}{\El{p}{\alpha}}} (\alpha,x)$, which by
definition of 2-cells in $\Sigma$ modes are isomorphic to pairs of $s :
\beta \tcell_p \alpha$ (a substitution from $\beta$ to $\alpha$) and
$\One \tcell_{\El p \beta} \TrPlus{s}{x}$ (a term of type
$\TrPlus s x$ in
context $\alpha$).

The one change we make is to drop the requirement that $\One_\alpha$ be
terminal---while this is true for structural dependent type theory, in
indexed linear logic (Section~\ref{sec:mode-example-lin}) it will be the
monoidal unit, which is not terminal.

Semantically, every fibration with Ehrhard comprehension determines a
comprehension category~\citep{jacobs93comprehension}, and every
\emph{full} comprehension category where the $\One_\alpha$ types are
terminal supports Ehrhard comprehension (because the fibers $1
\tcell_{\El p \alpha} x$ are equivalent to $\alpha.\One_\alpha \tcell_p
\alpha.x$ (commuting over $\alpha$) by fullness, and therefore to
$\alpha \tcell \alpha.x$ (section of projection) if $\One_\alpha$ is
terminal).  Since the semantics of the mode theory for comprehension in
the ``canonical semantics'' will be a fibration with Ehrhard
comprehension, we expect to be able to interpret the type theory for
this mode theory in any comprehension category with unit types (by
taking its full completion if it is not already full).  

The above analogy can be summarized as:

\begin{center}
\begin{tabular}{|l|l|}
  \hline
  encoded language contexts & mode terms of type $p$ \\
  \hline
  encoded language types in context $\alpha$ & mode terms of type $\El p \alpha$ \\
  \hline
  encoded language substitutions from $\alpha$ to $\beta$ & mode term 2-cells $\alpha \tcell_p \beta$ \\
  \hline
  encoded language terms in context $\alpha$ of type $x$ & mode term 2-cells $\One_\alpha \tcell_{\El{p}{\alpha}} x$ \\
  \hline
  encoded language substitution by $s : \beta \tcell_p \alpha$ into a type $x : \El p \alpha$  & mode term $\TrPlus{s}{x} : \El{p}{\beta}$ \\
  \hline
\end{tabular}
\end{center}

The actual signature in the base type theory for the above situation is quite simple:

\begin{definition}[Comprehension Object]\label{def:comprehension-object}
  A \emph{comprehension object} is specified by the following
  constants:
  \begin{mathpar}
    p \type \and \alpha : p \yields \El{p}{\alpha} \type \and \alpha : p \yields \One_\alpha : \El{p}{\alpha}
    \\ 
   w : \sigmacl{\alpha}{p}{\El{p}{\alpha}} \yields \sdot\, w : p \and
    \yields \sempty : p
  \end{mathpar}
  such that
\begin{align*}
\alpha : p &\yields (\alpha, \One_\alpha) : \sigmacl{\alpha}{p}{\El{p}{\alpha}} \\
\alpha : p &\yields () : 1
\intertext{are left adjoints to}
w : \sigmacl{\alpha}{p}{\El{p}{\alpha}} &\yields \sdot\, w : p \\
w : 1 &\yields \sempty : p
\end{align*}
respectively. 
\end{definition}

We will usually write $\sdot(\alpha, x)$ infix as $\alpha.x$, and abbreviate $\sempty$ as $\emptyset$.

\msnote{I find it a bit confusing to use the same infix dot for comprehension that we use for variable binding (e.g.\ $\F{x.\mu}{-}$).  What would you think about using a different dot for comprehension such as $\alpha \ce x$, which I used in the semantics?}

In Section~\ref{sec:example-encodings}, we will show that the top type
theory for a comprehension object interprets the context structure of
dependent type theory.

By Definition~\ref{def:adjunction}, saying that there is
an adjunction in the mode theory unpacks to asking for natural mode term
morphisms
\begin{align*}
\eta^\sdot_\alpha {}&: \alpha \tcell_p \alpha.\One_\alpha \\
\varepsilon^\sdot_{(\alpha, \mu)} {}&: (\alpha.\mu, \One_{\alpha.\mu}) \tcell_{\sigmacl{\alpha}{p}{\El{p}{\alpha}}} (\alpha, \mu) \\
\eta^\emptyset_\alpha {}&: \alpha \tcell_p \emptyset \\
\varepsilon^\emptyset_{x} {}&: x \tcell_1 ()
\end{align*}
satisfying the triangle identities.  Note that $\varepsilon^\emptyset_x$
is necessarily the unique morphism in the unit mode type $1$.

In the syntax of the base type theory, we can unpack the pieces of the
comprehension-$\One$ adjunction as follows:

\begin{definition}
Any comprehension object supports the following derived forms, where
$\alpha : p$, $\beta : p$ and
${s} : {\beta} \tcell_p {\alpha}$ and
$\mu : \El{p}{\alpha}$ and $\nu : \El{p}{\beta}$:
  \begin{itemize}
  \item $\pi^\alpha_\mu$ and $\var{\mu}$ are defined via the counit of the adjunction $(\alpha,\One_\alpha) \dashv \sdot$.
  \begin{mathpar}
  {\TermTwoT{\alpha:p,x:\El{p}{\alpha}}{\pi^\alpha_x}{\alpha.x}{\alpha}{p}}
  \and
  \pi^\alpha_x :\equiv \ap \fst {\varepsilon^\sdot_{(\alpha, x)}} \\
  {\TermTwoT{\alpha:p,x:\El{p}{\alpha}}{\var{x}}{\One_{\alpha.x}}{\TrPlus{\ApEl{p}{\pi^\alpha_x}}{x}}{\El{p}{\alpha.x}}} 
    \and
    \var{x} :\equiv \ap \snd {\varepsilon^\sdot_{(\alpha, x)}}
  \end{mathpar}

  \item One kind of pairing for the comprehension object is given by $\mathsf{ap}$ of
  $.$ on the pairing for telescope modes:
  \begin{mathpar}
  \inferrule{\TermTwoT{\gamma}{s}{\beta}{\alpha}{p} \and
             \TermTwoT{\gamma}{m}{\nu}{\TrPlus{\ApEl{p}{s}}{\mu}}{\El{p}{\beta}}}
            {\TermTwoT{\gamma}{s.m}{\beta.\nu}{\alpha.\mu}{p}} \and
  s \bdot m :\equiv \ap{\sdot}{(s, m)}
  \end{mathpar}

  If $\mu$ is $\One$, we get ${\beta.\One} \tcell_p
  {\alpha.\mu}$, so $\eta_\beta;(s \bdot m)$ gives
  a substitution ${\beta} \tcell_p {\alpha.\mu}$, which is the usual
  type theoretic rule for introducing substitutions into an extended
  context.

  \item For $s : \beta \tcell_p \alpha$, we write $\ApOne{s} :
    \One_{\beta} \tcell_{\El p \beta} \TrPlus{s}{\One_\alpha}$ as a
    short-hand for $\ap{\One_z}{s/z}$.  
  \end{itemize}
\end{definition}

Using the above derived forms, the triangle equations for the adjunctions may be written:
\begin{align}
\label{eq:chi-triangle-1} \eta^\sdot_{\alpha.x};(\pi_x^\alpha \bdot \var{x}) &\equiv \id_{\alpha.x} \\
\label{eq:chi-triangle-2} (\eta^\sdot_\alpha ; \pi^\alpha_{\One_\alpha}, \ApOne{\eta^\sdot_\alpha} ; \ApPlus{\ApEl{p}{\eta^\sdot_\alpha}}{\var{\One_\alpha}}) &\equiv \id_{(\alpha, \One_\alpha)}\\
\eta^\emptyset_\emptyset &\equiv \id_\emptyset \\
\id_{()}&\equiv \id_{()}
\end{align}

Requiring that $()$ is left adjoint to $\emptyset$ is a cute way of
stating the following (which we use to emphasize the similarity between
the empty context and context extension):
\begin{lemma}
For $p$ a comprehension object, $\emptyset : p$ is terminal.
\end{lemma}
\begin{proof}
We always have a map $\eta^\sempty_\alpha : \alpha \tcell_p \emptyset$. To show it is unique, note that for any $s : \alpha \tcell_p \emptyset$,
\begin{align*}
s 
&\equiv s ; \eta^\emptyset_\emptyset \\
&\equiv \eta^\emptyset_\alpha ; \ApPlus{\emptyset}{\ApCirc{\emptyset}{s}} \\
&\equiv \eta^\emptyset_\alpha ; \ApPlus{\emptyset}{\id_{()}} \\
&\equiv \eta^\emptyset_\alpha
\end{align*}
by naturality of $\eta^\emptyset$.
\end{proof}

Some additional equations that will be useful below:
\begin{lemma}

  \drlnote{Some of the $s$'s were $\alpha \tcell \beta$ instead of
    $\beta \tcell \alpha$ (or possibly inconsistent) here, so I tried to
    flip them all to $\beta \tcell \alpha$; please proofread.}
    
  The following equations hold for any comprehension object:
  \begin{itemize}
  \item
    Fusion for dot: 
    $(s \bdot m);(s' \bdot m') \equiv ((s;s') \bdot (m;\ApPlus{\ApEl{p}{s}} {m'}))$

  \item
    Naturality of $\pi^\alpha_\mu$ in $\mu$:
    for ${m} : {\nu} \tcell_{\El{p}{\beta}} {\TrPlus{\ApEl{p}{s}}{\mu}}$,
    $(s \bdot m); \pi^\alpha_\mu \equiv \pi^\beta_\nu;s$

  \item Beta reduction for first projection: for $s : \beta \tcell_p
    \alpha$ and ${m} : {\One_\beta} \tcell_{\El p
      {\beta}}{\TrPlus{\ApEl{p}{s}}{\mu}}$,
    we have $\eta_\beta;(s \bdot m);\pi^\alpha_\mu \equiv s $

  \item Naturality of $\var{}$: for ${m} : {\nu} \tcell_{\El{p}{\beta}}
    {\TrPlus{\ApEl{p}{s}}{\mu}}$, we have
    $\ApOne{(s \bdot m)};\ApPlus{\ApEl{p}{(s \bdot m)}}{\var{\mu}} \equiv \var{\nu};\ApPlus{\ApEl{p}{\pi^\beta_\nu}}{m} $
    
  \item The $\eta$ principle for pairing: if ${t} : {\beta} \tcell_p
    {\alpha.\mu}$ then 
    $t \equiv \eta_\beta;((t;\pi_\mu^\alpha) \bdot (\ApOne{t}; \ApPlus{\ApEl{p}{t}}{\var{\mu}}))$

%  \item Naturality of $\eta^\tdot_\beta$: 
%    $s;\eta^\tdot_\alpha \equiv \eta^\tdot_{\beta} ; (s \bdot \ApOne{s})$
  \end{itemize}
\end{lemma}

\begin{proof}~
\begin{itemize}
\item Fusion for $.$
\begin{align}
\label{dot-fusion}
    (s \bdot m);(s' \bdot m') \equiv ((s;s') \bdot (m;\ApPlus{\ApEl{p}{s}} {m'}))
\end{align}
follows by fusing the ap's and the corresponding fusion rule for morphisms in telescope modes:
\begin{align*}
(s \bdot m);(s' \bdot m') &\equiv \ap{\sdot}{(s, m)} ; \ap{\sdot}{(s', m')} \\
&\equiv \ap{\sdot}{(s, m);(s', m')} \\
&\equiv \ap{\sdot}{(s;s'), (m;\ApPlus{\ApEl{p}{s}} {m'})} \\
&\equiv ((s;s') \bdot (m;\ApPlus{\ApEl{p}{s}} {m'}))
\end{align*}

\item $\pi^\alpha_\mu$ is natural in $\mu$:
  \begin{align}
  \label{pi-naturality}
  (s \bdot m); \pi^\alpha_\mu &\equiv \pi^\beta_\nu;s && \text{where }
  {m} : {\nu} \tcell_{\El{p}{\beta}} {\TrPlus{\ApEl{p}{s}}{\mu}}
  \end{align}
  by
  \begin{align*}
  (s \bdot m); \pi^\alpha_\mu 
  &\equiv \ap{\sdot}{(s, m)} ; \ap \fst {\varepsilon^\sdot_{(\alpha, \mu)}} \\  
  &\equiv \ap{\fst}{\ap{(z,\One_z)}{\ap{\sdot}{(s, m)}}} ; \ap \fst {\varepsilon^\sdot_{(\alpha, \mu)}} \\
  &\equiv \ap{\fst}{\ap{(z,\One_z)}{\ap{\sdot}{(s, m)}} ; \varepsilon^\sdot_{(\alpha, \mu)}}  \\
  &\equiv \ap{\fst}{\varepsilon^\sdot_{(\beta, \nu)}; (s, m) } \\
  &\equiv \ap{\fst}{\varepsilon^\sdot_{(\beta, \nu)}} ; s\\
  &\equiv \pi^\beta_\nu ; s
  \end{align*}

The main step is naturality of $\varepsilon^\sdot$, but because the adjunction
is defined on the whole mode $\Sigma$ type \sigmacl{\alpha}{p}{\El p
  \alpha}, we need to move the first projection to the outside of the
composition.
  
\item Beta reduction for first projection:
  \begin{align}
\label{beta-pi}
\eta_\beta;(s \bdot m);\pi^\alpha_\mu &\equiv s && \text{where } {m} : {\One_\beta} \tcell_{\El p \beta} {\TrPlus{\ApEl{p}{s}}{\mu}}
  \end{align}
follows from naturality and the second triangle equation by:
\begin{align*}
\eta_\beta;(s \bdot m);\pi^\alpha_\mu
&\equiv \eta_\beta;\pi^\beta_{\One_\beta};s \\
&\equiv s
\end{align*}

\item Naturality of $\var{}$:
\begin{align}
\label{beta-var}
\ApOne{(s \bdot m)};\ApPlus{\ApEl{p}{(s \bdot m)}}{\var{\mu}} &\equiv \var{\nu};\ApPlus{\ApEl{p}{\pi^\beta_\nu}}{m}  && \text{where } \TermTwoT{\gamma}{m}{\nu}{\TrPlus{\ApEl{p}{s}}{\mu}}{\El{p}{\beta}}
\end{align}
is derivable by:
\begin{align*}
\ApOne{(s \bdot m)};\ApPlus{\ApEl{p}{(s \bdot m)}}{\var{\mu}} 
&\equiv \ApOne{(s \bdot m)};\ApPlus{\ApEl{p}{\ap{\sdot}{(s, m)}}}{\ap \snd {\varepsilon^\sdot_{(\alpha, \mu)}}} \\
&\equiv \ap \snd {((s \bdot m), \ApOne{(s \bdot m)});\varepsilon^\sdot_{(\alpha, \mu)}} \\
&\equiv \ap \snd {\ap{\sdot(y,\One_y)}{(s, m)};\varepsilon^\sdot_{(\alpha, \mu)}} \\
&\equiv \ap \snd {\varepsilon^\sdot_{(\beta, \nu)};(s, m)} \\
&\equiv \ap \snd {\varepsilon^\sdot_{(\beta, \nu)}}; \ApPlus{\ApEl{p}{\pi^\beta_{\nu}}}{\ap \snd (s, m)}  \\
&\equiv \var{\nu}; \ApPlus{\ApEl{p}{\pi^\beta_{\nu}}}{m} 
\end{align*}

This says that ``substituting'' into a ``variable'' is second projection
on the ``substitution''.

\item The eta principle for pairing:
\begin{align}
\label{eta-pi-var}
t &\equiv \eta_\beta;((t;\pi_\mu^\alpha) \bdot (\ApOne{t}; \ApPlus{\ApEl{p}{t}}{\var{\mu}})) && \text{where } \TermTwoT{\gamma}{t}{\beta}{\alpha.\mu}{p}
\end{align}
is derived by the first triangle equation followed by naturality of $\eta$:
\begin{align*}
t &\equiv t;\eta_{\alpha.\mu};(\pi_\mu^\alpha \bdot \var{\mu}) \\
&\equiv \eta_\beta;\ap{\sdot(z,\One_z)}{t/z};(\pi_\mu^\alpha \bdot \var{\mu}) \\
&\equiv \eta_\beta;(t \bdot \ApOne{t});(\pi_\mu^\alpha \bdot \var{\mu}) \\
&\equiv \eta_\beta;((t;\pi_\mu^\alpha) \bdot (\ApOne{t}; \ApPlus{\ApEl{p}{t}}{\var{\mu}}))
\end{align*}

This is the usual $\eta$ principle for ``subsitutions''.

%\item Naturality of $\eta^\sdot_\beta$ takes the following form:
%\begin{align*}
%s;\eta^\tdot_\alpha \equiv \eta^\tdot_{\beta} ; (s \bdot \ApOne{s})
%\end{align*}
%
%\drlnote{Missing proof}

\end{itemize}
\end{proof}

We sometimes want to switch between terms in the fiber and sections of projection:
\begin{lemma}\label{sigma:total-to-fiber0} 
For any comprehension object $p$, mode term 2-cells $s : \alpha \tcell_p
\alpha.x$ such that $s;\pi^\alpha_x \equiv \id_\alpha$ correspond
bijectively to 2-cells $\One_\alpha \tcell_{\El{p}{\alpha}} x$.
\end{lemma}
\begin{proof}
Given such an $s$, we can define
\begin{align*}
\hat{s} &: \One_\alpha \tcell_{\El{p}{\alpha}} x \\
\hat{s} &:\equiv \ApOne{s};\ApPlus{s}{\var{x}}
\end{align*}
where the identity $s;\pi^\alpha_x \equiv \id_\alpha$ is used to verify that the codomain is $\TrPlus{s}{\TrPlus{\pi^\alpha_x}{x}} \equiv \TrPlus{(s;\pi^\alpha_x)}{x} \equiv x$.

Conversely, given $m : \One_\alpha \tcell_{\El{p}{\alpha}} x$ we have:
\begin{align*}
\tilde{m} &: \alpha \tcell_p \alpha.x \\
\tilde{m} &:\equiv \eta^\sdot_\alpha ; (\id_\alpha \bdot m)
\end{align*}
And indeed $\tilde{m};\pi^\alpha_x \equiv \eta^\sdot_\alpha ; (\id_\alpha \bdot m);\pi^\alpha_x \equiv \id_\alpha$ by Equation~\eqref{beta-pi}.

It is easy to check the round trips are the identity:
\begin{align*}
&\eta^\sdot_\alpha ; (\id_\alpha \bdot \ApOne{s};\ApPlus{s}{\var{x}}) \\
&\equiv \eta^\sdot_\alpha ; (s;\pi^\alpha_x \bdot \ApOne{s};\ApPlus{s}{\var{x}}) \\
&\equiv \eta^\sdot_\alpha ; (s \bdot \ApOne{s});(\pi^\alpha_x \bdot \var{x}) \\
&\equiv s;\eta^\sdot_{\alpha.x} ; (\pi^\alpha_x \bdot \var{x}) \\
&\equiv s
\end{align*}
And:
\begin{align*}
&\ApOne{\eta^\sdot_\alpha ; (\id_\alpha \bdot m)};\ApPlus{(\eta^\sdot_\alpha ; (\id_\alpha \bdot m))}{\var{x}} \\
&\equiv \ApOne{\eta^\sdot_\alpha};\ApPlus{\eta^\sdot_\alpha}{\ApOne{(\id_\alpha \bdot m)};\ApPlus{(\id_\alpha \bdot m)}{\var{x}}} \\
&\equiv \ApOne{\eta^\sdot_\alpha};\ApPlus{\eta^\sdot_\alpha}{\var{\One_\alpha};\ApPlus{\pi^\alpha_{\One_\alpha}}{m}} \\
&\equiv \ApOne{\eta^\sdot_\alpha};\ApPlus{\eta^\sdot_\alpha}{\var{\One_\alpha}};\ApPlus{\eta^\sdot_\alpha}{\ApPlus{\pi^\alpha_{\One_\alpha}}{m}} \\
&\equiv \ApPlus{\eta^\sdot_\alpha}{\ApPlus{\pi^\alpha_{\One_\alpha}}{m}} \\
&\equiv m
\end{align*}
\end{proof}

\subsubsection[\dots with Unit]{Comprehension Object with Unit}

Next, we begin to define the conditions under which a mode theory, when
used with the top type theory in Section~\ref{sec:top-syntax}, will
support the usual $1, \Sigma, \Pi$ types of dependent type theory.  For
positive types (1, $\Sigma$, left adjoint modalities), we will
ordinarily need to put in a new operation on $\El{p}{-}$ corresponding
to the type.  However, for the unit type, we will use the $\One$ that is
already part of the comprehension object.  A standard description of
unit types is that $\Gamma.1 \cong \Gamma$, which we state here as:
\begin{definition}\label{def:supports-unit}
A comprehension object \emph{supports the unit type} if
$\eta^\sdot_\alpha : \alpha \tcell_p \alpha.\One_\alpha$ and $\pi :
\alpha.\One_\alpha \tcell_p \alpha$ are an isomorphism, i.e.:
\begin{align}
\pi^\alpha_{\One_\alpha} ; \eta^\sdot_\alpha \equiv \id_{\alpha.\One_\alpha}
\end{align}
\end{definition}
Composition in the other direction is already the identity, by one of the triangle identities for $\sdot$.

\subsubsection[\dots with $\Sigma$]{Comprehension Object with $\Sigma$}
\label{sec:compobj-sigma}

For $\Sigma$ types, a standard description is that there is a type
former $\Sigma$ that takes $A \in Ty(\Gamma)$, $B \in Ty(\Gamma.A)$ to
$\Sigma_A B \in Ty(\Gamma)$, such that $\Gamma.A.B \cong \Gamma.\Sigma_A
B$.  We mostly follow this here, except that in the base type theory,
the constant generating the $\Sigma$ type is automatically functorial in
mode term 2-cells, and using this, the ``introduction rule''
$\Gamma.A.B \vdash \Gamma.\Sigma_A B$ follows from a special case.

\begin{definition}\label{def:supports-sigmas}
A comprehension object \emph{supports $\Sigma$ types} if there is a specified mode term
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, y : \El{p}{\alpha.x} \vdash \Sigma_1(\alpha,x,y) : \El{p}{\alpha}
\end{align*}
and mode term 2-cells
\begin{align*}
\contract{\alpha} &: \One_\alpha \tcell_{\El{p}{\alpha}} \Sigma_1(\alpha,\One_\alpha,\One_{\alpha.{\One_\alpha}}) \\
\tsplit{\alpha,x,y} &: \alpha.\Sigma_1(\alpha,x,y) \tcell_{p} \alpha.x.y
\end{align*}
such that $\tsplit{\alpha,x,y}$ is an inverse to $\pair{\alpha,x,y}$, defined by:
\begin{align*}
\fibpair{\alpha,x,y} &: \One_{\alpha.x.y} \tcell_{\El{p}{\alpha.x.y}} \TrPlus{(\pi^{\alpha.x}_y;\pi^\alpha_x)}{\Sigma_1(\alpha,x,y)} \\
\fibpair{\alpha,x,y} &:\equiv \contract{\alpha.x.y};\ap{\Sigma_1}{(\pi^{\alpha.x}_y;\pi^{\alpha}_x,\ApOne{\pi^{\alpha.x}_y};\ApPlus{\ApEl{p}{\pi^{\alpha.x}_y}}{\var{x}}, \ApOne{\pi^{\alpha.x.y}_{\One_{\alpha.x.y}}};\ApPlus{\ApEl{p}{\pi^{\alpha.x.y}_{\One_{\alpha.x.y}}}}{\var{y}})} \\
\pair{\alpha,x,y} &: \alpha.x.y \tcell_{p} \alpha.\Sigma_1(\alpha,x,y) \\
\pair{\alpha, x, y} &:\equiv \eta^\sdot_{\alpha.x.y};((\pi^{\alpha.x}_y;\pi^\alpha_x) \bdot \fibpair{\alpha,x,y})
\end{align*}
and $\contract{\alpha}$ is natural:
\begin{align}
\contract{\alpha};\ap{\Sigma_1(\alpha,x,y)}{(s, \ApOne{s}, \ApOne{s \bdot \ApOne{s}})/(\alpha,x,y)} \equiv \ApOne{s};\ApPlus{\ApEl{p}{s}}{\contract{\beta}}
\end{align}
for any $s : \alpha \tcell_p \beta$.
\end{definition}

In this definition, the second part of $\fibpair{\alpha,x,y}$,
$\ap{\Sigma_1}{\ldots}$, is a mode term 2-cell
\[
\Sigma_{\alpha.x.y}(\One_{\alpha.x.y},\One_{\alpha.x.y.\One_{\alpha.x.y}}) \tcell_{\El p {\alpha.x.y}} \TrPlus{(\pi^{\alpha.x}_y;\pi^\alpha_x)}{\Sigma_1(\alpha,x,y)}
\]
The first part, $\contract{\alpha.x.y} : \One_{\alpha.x.y} \tcell
\Sigma_{\alpha.x.y}(\One_{\alpha.x.y},\One_{\alpha.x.y.\One_{\alpha.x.y}})$,
we view as a form of \emph{contraction}, allowing the context
$\alpha.x.y$ to be duplicated and used in both components of the
$\Sigma$ type.

%% \mvrnote{How does this compare to left adjoint to weakening? I still don't see...}
%% Only $\contract{\alpha}$ is needed to define $\pair{\alpha,x,y}$, as
%% mode terms are always functorial with respect to mode term morphisms via
%% ap. If the requirement that $\pair{\alpha, x, y}$ be an isomorphism is
%% dropped, we may still interpret weak $\Sigma$-types with a non-dependent
%% eliminator.

\begin{lemma}
A comprehension object that supports $\Sigma$s satisfies the following equations:
\begin{align}
\pair{\alpha,x,y};\pi^\alpha_{\Sigma_1(\alpha, x, y)} &\equiv \pi^{\alpha.x}_y;\pi^\alpha_x \\
\tsplit{\alpha,x,y};\pi^{\alpha.x}_y;\pi^\alpha_x &\equiv \pi^\alpha_{\Sigma_1(\alpha, x, y)} %\\
%\fibpair{\alpha,\One_\alpha,\One_{\alpha.\One_\alpha}} &\equiv \ApOne{\pi^{\alpha.\One_\alpha}_{\One_{\alpha.\One_\alpha}};\pi^\alpha_{\One_\alpha}};\ApPlus{(\pi^{\alpha.\One_\alpha}_{\One_{\alpha.\One_\alpha}};\pi^\alpha_{\One_\alpha})}{\contract{\alpha}} \\
%(\id_\alpha \bdot \contract{\alpha});\tsplit{\alpha,\One_\alpha,\One_{\alpha.\One_\alpha}} &\equiv \eta^\sdot_{\alpha.\One_\alpha}
\end{align}
\end{lemma}
\begin{proof}
The first follows from the definition of $\pair{}$ and Equation~\ref{beta-pi}. The second is immediate from the first, precomposing with $\tsplit{}$. 
\end{proof}

\subsubsection[\dots with $\Pi$]{Comprehension Object with $\Pi$}

For negative types ($\Pi$, right adjoint modalities), we do not add any
new constants to the mode theory, but instead will use a mechanism of
the top type theory to ask for a right adjoint to an existing mode
term.  For $\Pi$ types, the term in questions is $\pi^\alpha_x$
(``forall is right adjoint to weakening''), but because of the way we
are representing terms, we will need that the $\One$ types are (pseudo)
stable under ``weakening'' in the mode theory: 

\begin{definition}\label{def:supports-pis}
  A comprehension object \emph{supports $\Pi$s} if
  the unit types are pseudo-stable under weakening, i.e.
  if 
  $\ApOne{\pi^\alpha_x} :
\One_{\alpha.x} \tcell_{\El{p}{\alpha.x}} \TrPlus{\ApEl p {\pi^\alpha_x}}{\One_\alpha}$ is an
isomorphism.
\end{definition}

We write $\pinv{\alpha,x}$ to denote the inverse of $\ApOne{\pi^\alpha_x}$.

%% \begin{lemma}
%% If $\One_\alpha : \El{p}{\alpha}$ are terminal in each fiber, then $p$ supports $\Pi$s.
%% \end{lemma}
%% \begin{proof}
%%   Take $\pinv{\alpha,x}$ to be the unique map to $\One_{\alpha.x}$.
%%   The composite on $\One_{\alpha.x}$ is automatically the identity
%%   because $\One$ is terminal.  The composite on
%%   $\TrPlus{\pi^\alpha_x}{\One_{\alpha}}$
%%   is $!;\ApOne{\pi^\alpha_x}$.

%%   FIXME: seems like we need to assert weak stability, so doesn't add anything?
%% \end{proof}

\subsection{Morphism of Comprehension Objects}

Next, we describe the mode theories for some modal dependent type
theories.  The simplest of these will be a type theory with two modes of
dependent types, $p$ and $q$, with an adjoint pair of functors between
them.  First, we have

\begin{definition}\label{def:morphism-comprehension-object}
For two comprehension objects $p$ and $q$,
a \emph{morphism of comprehension objects} $f$ from $(p, \One^p, \sdot^p, \sempty^p)$ to $(q, \One^q, \sdot^q, \sempty^q)$ consists of 
\begin{align*}
\alpha : p &\yields f(\alpha) : q \\
\alpha : p, x : \El{p}{\alpha} &\yields f_1(x) : \El{q}{f(\alpha)} \\
\alpha : p, x : \El{p}{\alpha} &\yields \fone{\alpha} : \One^q_{f(\alpha)}  \tcell_{\El{q}{f(\alpha)}} f_1(\One^p_\alpha)
\end{align*}
such that $\fone{\alpha}$ is natural:
\begin{align}
\fone{\alpha};\ap{f_1}{s/\alpha, \ApOne{s}/x} \equiv \ApOne{\ap{f}{s}};\ApPlus{\ApEl{q}{\ap{f}{s}}}{\fone{\beta}}
\end{align}
\end{definition}

The idea is that $f$ represents applying the left adjoint to
a $p$-context to get a $q$-context.  $f_1$ represents a left adjoint
type constructor that takes $p$-types in context $\alpha$ to $q$-types
in context $f(\alpha)$.  The right adjoint to $f_1$ in the top
type theory will take $q$ types that are dependent on the inclusion of a
$p$ context to $p$ types, but analogously to
Definition~\ref{def:supports-pis}, because of the way we are
representing terms, for such a right adjoint type will need that the
left adjoint preserves $\One$:

\begin{definition} \label{def:supports-right-adjoint}
A morphism of comprehension objects \emph{supports right adjoint types}
if $\fone{\alpha} : \One_{f(\alpha)} \tcell f_1(\One_\alpha)$ is an isomorphism.
\end{definition}
We write $\foneinv{\alpha}$ to denote the inverse of $\fone{\alpha}$.

Analogously to Definition~\ref{def:supports-sigmas}, the elimination
rule for a left adjoint type will require the following:

\begin{definition} \label{def:supports-left}
A morphism of comprehension objects $f$ \emph{supports left adjoint types} if $\fdist{\alpha, x}$ defined by
\begin{align*}
\fibf{\alpha, x} &: \One_{f(\alpha.x)} \tcell_{\El{q}{f(\alpha.x)}} \ApPlus{\ApEl{q}{\ap{f}{\pi^\alpha_x}}}{f_1(x)} \\
\fibf{\alpha, x} &:\equiv \fone{\alpha.x};\ap{f_1}{\pi^\alpha_x/\alpha, \var{x}/x} \\
\fdist{\alpha, x} &: f(\alpha.x) \tcell_q f(\alpha).f_1(x) \\
\fdist{\alpha, x} &:\equiv \eta^{\sdot^q}_{f(\alpha.x)} ; (\ap{f}{\pi^\alpha_x} \bdot \fibf{\alpha, x})
\end{align*}
is an isomorphism.
\end{definition}
We write $\fdistinv{\alpha,x}$ to denote the inverse of $\fdist{\alpha,x}$.

%% Finally, many modal type theories do not distinguish between the empty
%% contexts of the two modes:
%% \begin{definition}
%% A morphism of comprehension objects $f$ \emph{preserves the empty
%%   context} if $! : \TrPlus{f}{\emptyset_p} \tcell_q \emptyset_q$
%% is an isomorphism.  \drlnote{This must come up somewhere?}
%% \end{definition}

\subsection{Spatial Type Theory}

Spatial type theory~\citep{shulman15realcohesion} has an adjoint pair of
modalities $\flat \dashv \sharp$ where $\flat$ is an idempotent comonad
and $\sharp$ is an idempotent monad.  We represent this by a mode theory
with a mode $p$, a morphism of comprehension objects $f$ from $p$ to
itself, where $f(-)$ is moreover a comonad.

\begin{definition}
A mode term morphism $x : p \yields \mu : p$ is a \emph{comonad} if there are morphisms
\begin{align*}
x : p &\yields \fcounit{x} : \mu(x) \Rightarrow_p x \\
x : p &\yields \fcomult{x} : \mu(x) \Rightarrow_p \mu(\mu(x))
\end{align*}
satisfying:
\begin{align}
\fcomult{x};\ap{\mu}{\fcomult{x}} &\equiv \fcomult{x};\fcomult{\mu(x)} \\
\fcomult{x};\ap{\mu}{\fcounit{x}} &\equiv \id_{\mu(x)} \\
\fcomult{x};\fcounit{\mu(x)} &\equiv \id_{\mu(x)}
\end{align}
A comonad is \emph{idempotent} if any of the following equivalent equations hold:
\begin{align}
\fcounit{\mu(x)} &\equiv \ap{\mu}{\fcounit{x}} \\
\ap{\mu}{\fcounit{x}} ; \fcomult{x} &\equiv \id_{\mu(\mu(x))} \\
\fcounit{\mu(x)} ; \fcomult{x} &\equiv \id_{\mu(\mu(x))} 
\end{align}
\end{definition}

\begin{definition}\label{def:supports-spatial}
An endomorphism of comprehension objects $f$ \emph{supports spatial type
  theory} if $f$ is an idempotent comonad and $f$ supports
left and right adjoint types.
\end{definition}

%We would also like to talk about $\flat$-types for a non-idempotent comonad. 
%\begin{definition}
%A \mvrnote{copointed endofunctor I suppose} \emph{supports $\flat$-types} if there are constants
%\begin{align*}
%\alpha : p, x : \El{p}{\TrPlus{f}{\alpha}} &\yields \flat_1(x) : \El{p}{\TrPlus{f}{\alpha}} \\
%\alpha : p &\yields \flatone{\alpha} : \One_{\TrPlus{f}{\alpha}} \tcell_{\TrPlus{f}{\alpha}} \flat_1(\One_{\TrPlus{f}{\alpha}})
%\end{align*}
%such that
%\begin{align*}
%\flatdist{\alpha, x} &: \TrPlus{f}{\TrPlus{f}{\alpha}.x} \tcell_p \TrPlus{f}{\alpha}.\flat_1(x) \\
%\flatdist{\alpha, x} &:\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\fcounit{\TrPlus{f}{\alpha}.x};\pi^{\TrPlus{f}{\alpha}}_x) \bdot (\ApOne{\fcounit{\TrPlus{f}{\alpha}}};\ApPlus{\ApEl{p}{\fcounit{\TrPlus{f}{\alpha}}}}{\flatone{\alpha};\ap{\flat_1}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x}}))
%\end{align*}
%is an isomorphism.
%\end{definition}
%
%\begin{lemma}
%If $f$ supports spatial type theory then it supports $\flat$-types.
%\end{lemma}
%\begin{proof}
%Define
%\begin{align*}
%\flat_1(x) &:\equiv \TrPlus{\ApEl{p}{\fcomult{\alpha}}}{f_1(x)} \\
%\flatone{\alpha} &:\equiv \ApOne{\fcomult{\alpha}};\ApPlus{\ApEl{p}{\fcomult{\alpha}}}{\fone{\TrPlus{f}{\alpha}}}
%\end{align*}
%
%$\flatdist{\alpha, x}$ is then an isomorphism, as it is equal to:
%\begin{align*}
%&\flatdist{\alpha, x} \\
%&\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\fcounit{\TrPlus{f}{\alpha}.x};\pi^{\TrPlus{f}{\alpha}}_x) \bdot (\ApOne{\fcounit{\TrPlus{f}{\alpha}}};\ApPlus{\ApEl{p}{\fcounit{\TrPlus{f}{\alpha}}}}{\flatone{\alpha};\ap{\flat_1}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x}})) \\
%&\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\fcounit{\TrPlus{f}{\alpha}.x};\pi^{\TrPlus{f}{\alpha}}_x) \bdot (\ApOne{\fcounit{\TrPlus{f}{\alpha}}};\ApPlus{\ApEl{p}{\fcounit{\TrPlus{f}{\alpha}}}}{\ApOne{\fcomult{\alpha}};\ApPlus{\ApEl{p}{\fcomult{\alpha}}}{\fone{\TrPlus{f}{\alpha}}};\ap{\TrPlus{\ApEl{p}{\fcomult{\alpha}}}{f_1(x)}}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x}})) \\
%&\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\fcounit{\TrPlus{f}{\alpha}.x};\pi^{\TrPlus{f}{\alpha}}_x) \bdot (\fone{\TrPlus{f}{\alpha}};\ap{f_1(x)}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x})) \\
%&\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\ApPlus{f}{\pi^{\TrPlus{f}{\alpha}}_x};\fcounit{\TrPlus{f}{\alpha}.x}) \bdot (\fone{\TrPlus{f}{\alpha}};\ap{f_1(x)}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x})) \\
%&\equiv \eta^{\tdot}_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}} ; (\ApPlus{f}{\pi^{\TrPlus{f}{\alpha}}_x} \bdot \fone{\TrPlus{f}{\alpha}.x};\ap{f_1}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x}) ; (\fcounit{\TrPlus{f}{\alpha}} \bdot \id_{\TrPlus{\ApEl{p}{\fcounit{\TrPlus{f}{\alpha}};\fcomult{\alpha}}}{f_1(x)}})
%\end{align*}
%%\begin{align*}
%%\flatdist{\alpha, x} &\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\fcounit{\TrPlus{f}{\alpha}.x};\pi^{\TrPlus{f}{\alpha}}_x) \bdot (\flatone{\alpha};\ApPlus{\ApEl{p}{\fcounit{\TrPlus{f}{\alpha}}}}{\ap{\flat_1}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x}})) \\
%%&\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\fcounit{\TrPlus{f}{\alpha}.x};\pi^{\TrPlus{f}{\alpha}}_x) \bdot (\fone{\TrPlus{f}{\alpha}};\ApPlus{\ApEl{p}{\fcounit{\TrPlus{f}{\alpha}}}}{\ap{\TrPlus{\ApEl{p}{\fcomult{\alpha}}}{f_1(x)}}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x}})) \\
%%&\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\fcounit{\TrPlus{f}{\alpha}.x};\pi^{\TrPlus{f}{\alpha}}_x) \bdot (\fone{\TrPlus{f}{\alpha}};\ap{f_1}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x})) \\
%%&\equiv \eta^\tdot_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}};((\ApPlus{f}{\pi^{\TrPlus{f}{\alpha}}_x};\fcounit{\TrPlus{f}{\alpha}.x}) \bdot (\fone{\TrPlus{f}{\alpha}};\ap{f_1}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x})) \\
%%&\equiv \eta^{\tdot}_{\TrPlus{f}{\TrPlus{f}{\alpha}.x}} ; (\ApPlus{f}{\pi^{\TrPlus{f}{\alpha}}_x} \bdot \fone{\TrPlus{f}{\alpha}.x};\ap{f_1}{\pi^{\TrPlus{f}{\alpha}}_x/\alpha, \var{x}/x}) ; (\fcounit{\TrPlus{f}{\alpha}} \bdot \id_{\TrPlus{\ApEl{p}{\fcounit{\TrPlus{f}{\alpha}};\fcomult{\alpha}}}{f_1(x)}})
%%\end{align*}
%which is the composite of the isomorphisms $\TrPlus{f}{\TrPlus{f}{\alpha}.x} \tcell \TrPlus{f}{\TrPlus{f}{\alpha}}.f_1(x) \tcell \TrPlus{f}{\alpha}.\TrPlus{\ApEl{p}{\fcomult{\alpha}}}{f_1(x)}$
%\end{proof}

% \subsection{First Order Logic}

\subsection{Dependently Indexed Linear Types}

Next, we consider non-dependent linear types indexed by structural
dependent types, as in \citep{vakar}, which is a simple examples of a
dependent type theory with some linearity.

\begin{definition}
A comprehension object $p$ \emph{supports a dependently indexed linear context} if there is:
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, y : \El{p}{\alpha} &\yields x \otimes_\alpha y : \El{p}{\alpha}
\end{align*}
such that $\otimes_\alpha$ is associative and commutative and $\One_\alpha$ is a unit for
$\otimes_\alpha$.
\mvrnote{(strictness?)}. \mvrnote{Pending: What exactly do we need?}
\end{definition}

%% \begin{definition}
%% A comprehension object $p$ \emph{supports $!$-types} if it supports a linear context and there is \mvrnote{???}
%% \end{definition}

\begin{definition}\label{def:supports-sigma-bangs}
A comprehension object $p$ \emph{supports $\Sigma!$-types} if it supports a linear context and there is
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, y : \El{p}{\alpha.x} \yields \Sigma!(x,y) : \El{p}{\alpha}
\end{align*}
and mode term morphisms
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, y : \El{p}{\alpha.x} &\yields \linsnd{x,y} : y \tcell_{\El{p}{\alpha.x}} \TrPlus{\ApEl{p}{\pi^\alpha_x}}{\Sigma!(x,y)} \\
\alpha : p, x : \El{p}{\alpha}, z : \El{p}{\alpha} &\yields \linwk{x,z} : \Sigma!(x, \TrPlus{\ApEl{p}{\pi^\alpha_x}}{z}) \tcell_{\El{p}{\alpha}} z
\end{align*}
that exhibit $\Sigma!(x,-)$ as a left adjoint to $\TrPlus{\ApEl{p}{\pi^\alpha_x}}{-}$, and the morphism $\frob{\xi, x, y}$ defined by:
\begin{align*}
\mathtt{lax}_{v,w} &: \TrPlus{\ApEl{p}{\pi^\alpha_x}}{w} \otimes_{\alpha.x} \TrPlus{\ApEl{p}{\pi^\alpha_x}}{v} \tcell \TrPlus{\ApEl{p}{\pi^\alpha_x}}{w \otimes_\alpha v} \\
\mathtt{lax}_{v,w} &:\equiv \ap{(w \otimes_\alpha v)}{\pi^\alpha_x / \alpha, \id_{\TrPlus{\ApEl{p}{\pi^\alpha_x}}{w}}/w, \id_{\TrPlus{\ApEl{p}{\pi^\alpha_x}}{v}}/v} \\
\frob{\xi, x, y} &: \Sigma!(x, \TrPlus{\ApEl{p}{\pi^\alpha_x}}{\xi} \otimes_{\alpha.x} y) \tcell_{\El{p}{\alpha}} \xi \otimes_\alpha \Sigma!(x, y) \\
\frob{\xi, x, y} &:\equiv \ap{\Sigma!(x, \TrPlus{\ApEl{p}{\pi^\alpha_x}}{\xi} \otimes_{\alpha.x} -)}{\linsnd{x,y}} ; \ap{\Sigma!(x, -)}{\mathtt{lax}_{\xi, \Sigma!(x,y)}} ; \linwk{x, \xi \otimes \Sigma!(x,y)}
\end{align*}
is an isomorphism.
\end{definition}
Here, $\frob{}$ is a Frobenius condition, which allows carrying some
linear assumptions $\xi$ through to the premise of a $\Sigma!$
elimination; a weaker $\Sigma!$ elimination rule is available without
it.

For $\Pi!$ types, we will see that no additional structure in the mode theory is needed.

\section{Type Theory over a Mode Theory}
\label{sec:top-syntax}

The role of the \emph{top type theory} in our framework is to provide
general type-theoretic rules for working ``inside'' the type theory
specified by a mode theory.  In the previous section, we showed
signatures for a variety of example substructural and modal dependent
type theories, and in the next section we will prove that the instances
of the top type theory with these mode theories support the familiar
rules for these examples.

The top type theory consists of four judgements: 
\begin{itemize}
\item $\yields_\gamma \Gamma \CTX$ where $\yields \gamma \ctx$.
\item $\Gamma \yields_p A \TYPE$ where $\gamma \yields p \type$.
\item $\Gamma \yields_p A \ISFIB$ where already $\Gamma \yields_p A \TYPE$
\item $\Gamma \yields_\mu M : A$ where $\gamma \yields \mu : p$ and
  $\Gamma \yields_p A \TYPE$.
\end{itemize}
along with corresponding equality judgements.  Because of the
fibrational perspective, we say that a judgement is ``over'' a
corresponding entity from the base type theory: a top context $\Gamma$
is over a mode context $\gamma$, a top type $A$ is over a mode type $p$,
and a top term $M$ is over a mode term $\mu$.  We also say that a type $A$
``has mode $p$'', and that a term $M$ ``has mode $\mu$''. 

We treat the well-formedness of the mode theory entities as a
presupposition of the top judgements, but sometimes write ``(over
\ldots)'' in inference rules to emphasize the typing that is happening
in the base.  We also treat the well-formedness of the non-principal
subjects of a judgement as presuppostions.

Using the common substructural logic parlance, we think of the base type
theory entities subscripting the turnstile as ``resources'', with the
mode theory dictating the ``resource usage policies'' of a particular
type theory.  For example, in logic with weakening and contraction, the
context $x : A \vdash J$ allows as many uses of $x$ as desired; but
without contraction, $x$ is a ``resource'' that can be used at most
once; while without weakening $x$ must be ``spent''.  This metaphor
extends to modal logics, where we think of modalities as additional
policies that must be obeyed; for example, if $f$ is a comonad, then the
resource $f(x)$ can be used as $x$ (by the counit), and can be used to
construct something else in the comonad; but a resource $x$ cannot be
used to construct something in the comonad.

\subsection{Top Contexts}

Top contexts are as usual, over the corresponding contexts of the base.  

\begin{mathpar}
  \inferrule*[Left = ctx-form]{ }
             {\yields_{\cdot} \cdot \CTX  } \and 

  \inferrule*[Left = ctx-form]{
    \yields_\gamma \Gamma \CTX \quad \text{over } (\yields \gamma \ctx) \\\\
    \Gamma \yields_p A \TYPE \quad \text{over }  (\gamma \yields p \type)}
  {\yields_{\gamma, x : p} \Gamma, x : A \CTX \quad \text{over } (\yields \gamma,x:p \ctx)  } \\
\end{mathpar}

We adopt a convention that the same variable names are used in the top
context and base context (which must, by these rules have the same
number of variables).  

\subsection{Top Structural Rules}
\label{sec:top-syntax-structural}

There are two derivable structural rules: 
\begin{mathpar}
  \inferrule*[Left = var]{
    % \yields \Gamma, x : A, \Gamma' \CTX_{\gamma, x : p, \gamma'}
  }
  {\Gamma, x : A, \Gamma' \yields_x x : A \quad (\text{over } \gamma,x:p,\gamma' \yields x : p)} \and

 \inferrule*[Left = rewrite]{
   \Gamma \yields_\mu M : A 
   \and \TermTwoT{\gamma}{s}{\nu}{\mu}{p}
  }
  {\Gamma \yields_\nu \rewrite{s}{M} : A} \\ \\
  
  \rewrite{\id_{\mu}}{M} \equiv M \and
  \rewrite{(s;t)}{M} \equiv \rewrite{s}{\rewrite{t}{M}} \and
  \rewrite{s}{M}[\rewrite{t}{N}/x] \equiv \rewrite{\ap{s}{t/x}}{\StI{\ap{q}{t/x}}{M[N/x]}}
\end{mathpar}

The first is the familiar variable rule, which is over the corresponding
variable rule in the base.  Intuitively, this says that to use an
assumption, the subscripting mode term must tell you that you can and
must use exactly that variable.  More permissive policies
(e.g. weakening away unused variables) will come from specific mode
theories.

The second rule says that mode term morphisms act contravariantly on
judgement subscripts, and the equations say that this action is
functorial, and commutes with substitution (the $\StI{}{}$ notation is
introduced in Section~\ref{sec:top-s-types} below).

The remaining rules make weakening, exchange, and substitution
admissible for the top type theory, where each rule is over the
corresponding structural rule of the base.  For example, we have
\begin{mathpar}
\inferrule*[Left = weaken-over, Right=admissible]
           {\Gamma,\Gamma' \yields_\mu M : A \quad (\text{over } \gamma,\gamma' \vdash \mu : p)}
           {\Gamma,y:B,\Gamma' \yields_\mu M : A \quad (\text{over } \gamma,y:q,\gamma' \vdash \mu : p)}

\inferrule*[Left = subst-over, Right=admissible]
           {\Gamma,x:A,\Gamma' \yields_\nu N : C \quad (\text{over } \gamma,x:p,\gamma' \vdash \nu : \gamma) \\\\
            \Gamma \vdash_\mu M : A \quad (\text{over } \gamma \vdash \mu : p)
           }
           {\Gamma,\Gamma'[M/x] \yields_{\nu[\mu/x]} N[M/x] : A[M/x] \quad (\text{over } \gamma,\gamma'[\mu/x] \vdash \nu[\mu/x] : p[\mu/x])}
\end{mathpar}

In terms of resources, weakening-over-weakening says that it is always
permissible to add a variable to the framework context, even when using
the framework to encode a type theory without weakening; this is because
adding $y$ to the framework context does not also add it to the
``resources'' $\mu$, which is a separate step that must be given in the
mode theory.  Substitution-over-substitution says that, in the mode
term, a substitution replaces all occurences of $x$ with the mode term
$\mu$ used to construct the top term $M$ that is plugged in for $x$.

\subsection{Top Unit Types}

We introduce a unit type in the top type theory, whose rules are over
the corresponding rules for the unit type in the base:

\begin{mathpar}
  \inferrule*[Left=$1$-form]{~}{\Gamma \yields_{1} 1 \TYPE} \and
  \inferrule*[Left=$1$-fib]{~}{\Gamma \yields_{1} 1 \ISFIB} \and
  \inferrule*[Left=$1$-intro]{~}{\Gamma \yields_{()} () : 1} \and
  M \equiv () \\
\end{mathpar}

Note that top unit types will play a rather structural role, and not, on
their own, model the unit types of a particular encoded language.  This
is because the unit type of an encoded language will have mode
$\mathsf{p}$ for some constant, or e.g. for a comprehension object
representing dependent type theory $\El{\mathsf p}{\alpha}$, and not
mode $1$.  

\subsection{Top Telescope Types}

Similarly, we introduce a $\Sigma$ type to the top type theory, over the
corresponding rules for mode $\Sigma$ types.  But as in the base type
theory, we refer to them as \emph{telescope types} to emphasize that
they play a structural role, rather than, on their own, represent the
$\Sigma$ types of an encoded language.  

\begin{mathpar}
  \inferrule*[Left=$()$-form]{ \Gamma \yields_p A \TYPE \\
               \Gamma,x:A \yields_q B \TYPE}
             { \Gamma \yields_{\sigmacl{x}{p}{q}} \telety{x}{A}{B} \TYPE}
  \and
  \inferrule*[Left=$()$-fib]{ \Gamma \yields_p A \ISFIB \\
               \Gamma,x:A \yields_q B \ISFIB}
             { \Gamma \yields_{\sigmacl{x}{p}{q}} \telety{x}{A}{B} \ISFIB}
  \\
  \inferrule*[Left=$()$-pair]{ \Gamma \yields_\mu M : A \\
               \Gamma \yields_\nu N : B[M/x]
             }
             { \Gamma \yields_{(\mu,\nu)} (M,N) : \telety{x}{A}{B}}
  \\             
  \inferrule*[Left=$()$-fst]{ \Gamma \yields_{\mu} M : \telety{x}{A}{B}}
             { \Gamma \yields_{\fst \mu} \fst{M} : A} 
  \and
  \inferrule*[Left=$()$-snd]{ \Gamma \yields_{\mu} M : \telety{x}{A}{B}}
             { \Gamma \yields_{\snd \mu} \snd{M} : B[\fst M/x]} 
  \\
             
    \fst{(M,N)} \equiv M \and
    \snd{(M,N)} \equiv N \and
    P \equiv (\fst P, \snd P)
\end{mathpar}

We present telescope types as negative $\Sigma$ types, with a
judgemental $\eta$ rule.  Each rule is over the corresponding rule of
the base type theory.

\subsection{Left Adjoint Modalities}

Left adjoint modalities, written $\F{x.\mu}{A}$, represent a
pushforward/cocartesian lift of a mode term $x : p \vdash \mu : q$, taking
types of mode $p$ to types of mode $q$.  $\mathsf{F}$-types will be used
to represent left adjoint modalities (e.g. $\flat$ in spatial type
theory).  In combination with top unit types and top telescope types,
these will also be used to represent encoded language unit and $\Sigma$
types.  For example, the $\Sigma_A B$ of standard dependent type theory
will be represented by $\F{z.\Sigma_1(\fst z, \snd
  z)}{\telety{x}{A}{B}}$: the telescope type has telescope mode
$\sigmacl{x}{\El{p}{\alpha}}{\El{p}{\alpha.x}}$, and then we use an
$\mathsf{F}$ type to push forward along the mode term $\Sigma_1$ that we
use to assert that a comprehension object supports $\Sigma$ types.
In \citepalias{lsr17multi-extended}, we used an $n$-ary $\mathsf{F}$ type in
place of having separate telescope types.

The rules are:

\begin{mathpar}
  \inferrule*[Left = F-form]{
    %% \yields_\gamma \Gamma \CTX \quad (\text{over } \yields \gamma \ctx)\\\\
    \Gamma \yields_p A \TYPE \quad (\text{over } \gamma \yields p \type) \\\\
    \gamma, x:p \yields \mu : q 
  }
  {\Gamma \yields_q \F{x.\mu}{A} \TYPE \quad (\text{over } \gamma \yields q \type) } \and
  \inferrule*[Left = F-fib]{
    \Gamma \yields_p A \ISFIB
  }
  {\Gamma \yields_q \F{x.\mu}{A} \ISFIB } \\
  
  \inferrule*[Left = F-intro]{
    \Gamma \yields_{\nu} M : A
    \quad (\text{over } \gamma \yields {\nu} : p)
    %% \and \gamma \yields \nu : q 
    %% \and \gamma \yields \mu[\theta] : q 
    %% \and \gamma \yields (\nu \Rightarrow \mu[\theta]) : q
  }
  {\Gamma \yields_{\mu[\nu/x]} \FI{M} : \F{x.\mu}{A} \quad (\text{over } \gamma \yields \mu[\nu/x] : q)} \\

  \inferrule*[Left = F-elim]{
    \Gamma, y : \F{x.\mu}{A} \yields_{r} C \TYPE \quad (\text{over } \gamma, y : q \yields r \type) \and \Gamma, y : \F{x.\mu}{A} \yields_{r} C \ISFIB \\\\
    \Gamma \yields_{\nu} M : \F{x.\mu}{A} \quad (\text{over } \gamma \yields \nu : q) \\\\
    \Gamma, x:A \yields_{\nu' [\mu / y]} N : C [\FI{x}/y]
    \quad (\text{over } \gamma, x:p \yields \nu' [\mu / y] : r [\mu / y] )}
  {\Gamma \yields_{\nu'[\nu/y]} \FE{M}{x}{N} : C[M/y]  \quad (\text{over }  \gamma \yields {\nu'[\nu/y]} : r[\nu/y])} \\
  \FE{\FI{M}}{x}{N} \equiv N[M/x] %\and
%  \text{(optionally:) }
%  \FE{M}{x}{N[\FI{x}/z]} \equiv N[M/z]
  \\ 

  \inferrule*[Left = F-Elim]{
    \gamma,y:q \yields r \type \\\\
    \Gamma \yields_{\nu} M : \F{x.\mu}{A} \quad (\text{over } \gamma \yields \nu : q) \\\\
    \Gamma, x:A \yields_{r [\mu / y]} C \TYPE
    \quad (\text{over } \gamma, x:p \yields r [\mu / y] \type )}
  {\Gamma \yields_{r[\nu/y]} \FE{M}{x}{C} \TYPE \quad (\text{over }  \gamma \yields {r[\nu/y]} \type)} \\
  \FE{\FI{M}}{x}{C} \equiv C[M/x] %\and
%  \text{(optionally:) }
%  \FE{M}{x}{C[\FI{x}/z]} \equiv C[M/z]
  \\
  
  (\FE{M}{x}{\rewrite{t[\mu/y]}{N}}) \equiv \rewrite{t[\nu/y]}{\FE{M}{x}{N}}
\end{mathpar}

$\mathsf{F}$ types are a positive type, and can be thought of as a
datatype with one constructor, the introduction rule $\FI{M}$.  The main
idea is that $\Gamma, x:A \vdash_{\mu(x)} \FI{x} : \F{x.\mu}{A}$;
i.e. to introduce $\F{x.\mu}{A}$, the mode term must be $\mu$.  The full
form of the introduction rule builds in a substitution for $x$ to make
substitution admissible.  The elimination rule patterm-matches on a term
of $\mathsf{F}$ type.  In sequent calculus style, it characterizes maps
out of $\mathsf{F}$ types:
\begin{mathpar}
  \inferrule*{
    \Gamma, y : \F{x.\mu}{A} \yields_{r} C \TYPE \quad (\text{over } \gamma, y : q \yields r \type) \\\\
    \Gamma, y : \F{x.\mu}{A}, x:A \yields_{\nu' [\mu / y]} N : C [\FI{x}/y]
    \quad (\text{over } \gamma, x:p \yields \nu' [\mu / y] : r [\mu / y] )}
  {\Gamma, y : \F{x.\mu}{A} \yields_{\nu'} \FE{y}{x}{N} : C  \quad (\text{over }  \gamma,y:q \yields {\nu'} : r)} 
\end{mathpar}
This says that an assumption of $\F{x.\mu}{A}$ can be replaced by an
assumption of $A$, but in the mode term we replace $y$ by $\mu$ to
remember the ``resources'' used to make $x$.

We treat $\mathsf{F}$ types like a positive type in dependent type
theory: we have a judgemental $\beta$ equality, but no $\eta$ (we intend
$\eta$ to be provable from the elimination rule with some sort of
identity type (which we have not yet investigated)).  We also include a
large elimination rule, i.e. a second elimination rule that maps into
types (which we do not identify with elements of a universe).
In general, the interaction of the structural rule applying a mode term
2-cell to a term, $\rewrite{t}{M}$, and the terms for various types
will follow from the equalities for $\rewrite{t}{-}$ in
Section~\ref{sec:top-syntax-structural} and the $\eta$ rules for the
types.  Because we do not have judgemental $\eta$ for $\mathsf{F}$
types, we assert the necessary interaction in the final equation in the
figure.  

\subsection{Right Adjoint Modalities}

A simple form of right adjoint types has the shape $\mathsf{U}_{c.\mu}(A
\TYPE_q) \TYPE_r$ when $c:r \vdash \mu : q$, and represents a
pullback/cartesian lift along $\mu$, and will be right adjoint to
$\F{c.\mu}{-}$.  We will generalize this by allowing a contravariant
position as well, so that right adjoint types include both right adjoint
modalities and dependent function types
($\Pi$)~\citep{atkey04separation,lsr17multi-extended}.

\begin{mathpar}
  \inferrule*[Left = U-form]{
    \Gamma \yields_p A \TYPE \quad (\text{over } \gamma \yields p \type)\\\\
    \and \Gamma,x:A \yields_q B \TYPE \quad (\text{over } \gamma,x:p \yields q \type)\\\\
    \and \gamma, x:p, c:r \yields \mu : q
  }{\Gamma \yields_r \U{c.\mu}{x:A}{B} \TYPE \quad (\text{over } \gamma \yields r \type)} \and
  \inferrule*[Left = U-fib]{
    \Gamma \yields_p A \ISFIB \\\\
    \and \Gamma,x:A \yields_q B \ISFIB
  }{\Gamma \yields_r \U{c.\mu}{x:A}{B} \ISFIB} \\

  \inferrule*[Left = U-intro]{
    \Gamma,x:A \yields_{\mu[\nu/c]} M : B \quad (\text{over } \gamma,x:p \yields {\mu[\nu/c]} : q)
  }
  {\Gamma \yields_{\nu} \UI {x}{M} : \U{c.\mu}{x:A}{B}
    \quad (\text{over } \gamma \yields \nu : r)
  } \\
  
  \inferrule*[Left = U-elim]{
    \Gamma \yields_{\nu_1} N_1 : \U{c.\mu}{x:A}{B} \quad (\text{over } \gamma \yields \nu_1 : r) \\\\
    \Gamma \yields_{\nu_2} N_2 : A \quad (\text{over } \gamma \yields \nu_2 : p)
  }{
    \Gamma \yields_{\mu[\nu_2/x,\nu_1/c]} \UE{N_1}{N_2} : B[N_2/x] \quad (\text{over } \gamma \yields \mu[\nu_2/x,\nu_1/c] : q)
  } \\

  \UE{(\UI{x}{M})}{N} \equiv M[N/x] \and 
  \UI{x}{\UE{N}{x}} \equiv N
\end{mathpar}

The type $\U{c.\mu}{x:A}{B}$ can be thought of as a modal verson of $\Pi
x:A.B$, where $\mu$ describes the resources under which the variable
$x$ can be used.  The simplified version discussed above is the special
case where $A$ is the top unit type $1$.  The variable $c$ in $\mu$ is a
placeholder for the ``current'' mode term: the $\lambda$ rule says that
to prove $\U{c.\mu}{x:A}{B}$ over $\nu$, you substitute $\nu$ for $c$ in
$\mu$ in the premise.  In the elimination rule, application, $\mu$ tells
you how to combine $\nu_1$ (the resources for the function) and
$\nu_2$ (the resources for the argument) when you apply a function.
For example, in the simply typed case~\citep*{lsr17multi-extended},
taking $\mu(c,x)$ to be $c \times x$ gives an $\to$ type right adjoint
to a product $\times$.

$\mathsf{U}$ types are a negative type, with judgemental $\beta$ and
$\eta$ equality rules.

\subsection{Strict Modalities}
\label{sec:strict-modalities}

\mvrnote{Text needs updating:}

The term $\rewrite{s}{a}$ (Section~\ref{sec:top-syntax-structural})
``transports'' a term $\Gamma \vdash_\mu a : A$ along a mode term 2-cell
$s : \mu \tcell_p \nu$ to make a term $\Gamma \vdash_\mu \rewrite{s}{a}
: A$.  In this section, we consider an analogous operation on types,
transporting a type $\Gamma \vdash_p A \TYPE$ along a mode type morphism
$s : q \tcell p$ to make a new type $\Gamma \vdash_q \St{s}{A} \TYPE$.
For example, if $s := \ApEl{p}{\pi} : \El p {\alpha.x} \tcell \El p
{\alpha}$ is the projection mode type morphism for a comprehension
object, then $\St{s}{A}$ represents weakening a type in the encoded
language ($\Gamma \vdash B \TYPE$ implies $\Gamma,A \vdash B \TYPE$).

In some sense, such an operation already exists, because the mode type
morphism $s$ contravariantly induces a mode term $x : p \vdash
\TrPlus{s}{x} : q$, and we can take the left adjoint type
$\F{x.\TrPlus{s}{x}}{A}$.  However, we will want the action of mode type
morphisms to obey certain judgemental equalities that we do not assert,
%% or do not even make sense
for a general mode term.  We call these
\emph{strict modalities}, written $\St{s}{A}$.  The introduction and
elimination rules for $\St{s}{A}$ are the same as those for
$\F{x.\TrPlus{s}{x}}{A}$, except we additionally assert a judgemental
$\eta$ rule that any map $N$ from $\St{s}{A}$ is equal to first doing
the elimination:
\[
\inferrule*{\Gamma,z:\St{s}{A} \vdash_\mu N : C \and
            \Gamma \vdash_\nu M : \St{s}{A} \and
           }
           {\Gamma \vdash_{\mu[\nu/z]} (\StE{s}{M}{x}{N[\StI{s}{x}/z]}) \equiv N[M/z] : C[\St{s}{A}/z]}
\]
(along with a corresponding judgemental $\eta$ for the large elimination
rule).  

In addition to this, we add four judgemental equalities
((\ref{eq:stype-id}) to \ref{eq:stype-pair}) of types (in the right-hand
column) and of terms with those types (in the left-hand column).  These
four equations give the four mode-theory-independent ways we have of
making mode type morphisms strict actions on types.  For non-strict left
adjoints $\F{x.\TrPlus{s}{x}}{A}$, these type equalities would only be an
``equivalence'': there are functions back and forth, but we would need
an identity type in order to use the induction principle for
$\mathsf{F}$ types to prove that the composites are the identity.

The first equation (\ref{eq:stype-id}) concerns the identity mode type
morphism $\id{p}$, which takes a type $\vdash_p A$ to another type of
mode $p$.  The equation in the right-hand column says that $\St{\id
  p}{A}$ is judgementally equal to $A$, and that, for $\Gamma \vdash_\mu
M : A$, the introduction form $\Gamma \vdash_{\TrPlus{\id p}{\mu}}
\StI{\id p}{M} : \St{\id p}{A}$ is equal to $M$ (both terms witness the
same judgement because of the right-hand equation and functoriality of
$\TrPlus{\id_p}{-}$ in the mode theory.  The second equation
(\ref{eq:stype-comp}) is the analogous rule for composition of mode type
morphisms.

%% It would type check to ask that, for general mode terms, $\F{x.x}{A}
%% \equiv A$ and $\F{g}{\F{f}{A}} \equiv \F{g \circ f}{A}$, but we do not
%% ask for this judgemental equality for general $\mathsf{F}$-types.

The next equation (\ref{eq:stype-subst}) is an analogous rule for the
whiskering operation that takes $t : \mu \tcell_p \mu'$ to $\ap q {t/x} :
q[\mu/x] \tcell q[\mu'/x]$.  Suppose $\Gamma,x:A \vdash_q B \TYPE$ and
$\Gamma \vdash_{\mu'} M : A$.  Then we could either first transport $M$,
getting $\Gamma \vdash_\mu \rewrite{t}{M} : A$, and then substitute into
$B$ to get $\Gamma \vdash_{q[\mu/x]} B[\rewrite{t}{M}/x] \TYPE$; or we
could first substitute to get $\Gamma \vdash_{q[\nu/x]} B[M/x] \TYPE$
and then transport the type along $\ap q {t/x}$, getting $\Gamma
\vdash_{q[\nu/x]} \St{\ap q {t/x}}{B[M/x]} \TYPE$.  The equation says
that these types are judgementally equal.  The left-hand column says
that if we have $x : A \vdash_\nu N : B$, then substituting
$\rewrite{t}{M}$ or substituting $M$ and then rewriting are equal.

Note that the corresponding equation for whiskering on the other side,
$(\St{s}{A})[M/x] \equiv \St{(s[\mu/x])}{A[M/x]}$, is one of the
defining equations for substitution.

For the final equation (\ref{eq:stype-pair}), the right-hand
equation interprets the action of a $\Sigma$ of mode type morphisms on
an upstairs telescope type as a componentwise action. Recall from
Section~\ref{sec:base-telescopes} that $\sigmacl{x'}{s}{t}$ type checks when
$\TypeTwo{\gamma}{s}{p}{p'}$ and
$\TypeTwo{\gamma,x':p'}{t}{q[\TrPlus{s}{x'}/x]}{q'}$,
and here we require
$\Gamma \vdash_{p'} A' \TYPE$ and $\Gamma,x':A' \vdash_{q'} B' \TYPE$,
so we have
$\Gamma \vdash_{\sigmacl{x}{p}{q}} \St{(\telety{x'}{s}{t})}{\telety{x'}{A'}{B'}}$
and
$\Gamma \vdash_{p} \St{s}{A'} \TYPE$
and 
$\Gamma,x':p' \vdash_{q[\TrPlus{s}{x'}/x]} \St{t}{B'} \TYPE$, so
$\Gamma,x:\St{s}{A'} \vdash_{q} \StE{s}{x}{x'}{\St{t}{B'}} \TYPE$, so
$\Gamma \vdash_{\sigmacl{x}{p}{q}} \telety{x}{\St{s}{A'}}{\StE{s}{x}{x'}{\St{t}{B'}}}$.
The
left-hand column says that, assuming $\Gamma
\vdash_\mu M : A'$ and $\Gamma \vdash_\nu N : B'[M/x']$, 
the term
$\Gamma \vdash_{\TrPlus{\sigmacl{x'}{s}{t}}{(\mu,\nu)}} \StI{\sigmacl{x'}{s}{t}}{(M, N)} : \St{(\telety{x'}{s}{t})}{\telety{x'}{A'}{B'}}$ is equal to
is equal to the term
$\Gamma \vdash_{(\TrPlus{s}{\mu},\TrPlus{t[\mu/x']}{\nu})} (\StI{s}{M}, \StI{t[\mu/x]}{N}) : \telety{x}{\St{s}{A'}}{\StE{s}{x}{x'}{\St{t}{B'}}}$,
using the equation between types and the equation for a $\Sigma$ mode
type morphism on mode terms.  

\begin{mathpar}
  \inferrule*[Left = E-form]{
    \Gamma \yields_p A \TYPE \quad (\text{over } \gamma \yields p \type) \\\\
    \gamma, x:p \yields \mu : q 
  }
  {\Gamma \yields_q \E{x.\mu}{A} \TYPE \quad (\text{over } \gamma \yields q \type) } \\
  \inferrule*[Left = E-intro]{
    \Gamma \yields_{\nu} M : A
    \quad (\text{over } \gamma \yields {\nu} : p)
    %% \and \gamma \yields \nu : q 
    %% \and \gamma \yields \mu[\theta] : q 
    %% \and \gamma \yields (\nu \Rightarrow \mu[\theta]) : q
  }
  {\Gamma \yields_{\mu[\nu/x]} \EI{M} : \E{x.\mu}{A} \quad (\text{over } \gamma \yields \mu[\nu/x] : q)} \\

  \inferrule*[Left = E-elim]{
    \Gamma, y : \E{x.\mu}{A} \yields_{r} C \TYPE \quad (\text{over } \gamma, y : q \yields r \type) \\\\
    \Gamma \yields_{\nu} M : \E{x.\mu}{A} \quad (\text{over } \gamma \yields \nu : q) \\\\
    \Gamma, x:A \yields_{\nu' [\mu / y]} N : C [\EI{x}/y]
    \quad (\text{over } \gamma, x:p \yields \nu' [\mu / y] : r [\mu / y] )}
  {\Gamma \yields_{\nu'[\nu/y]} \EE{M}{x}{N} : C[M/y]  \quad (\text{over }  \gamma \yields {\nu'[\nu/y]} : r[\nu/y])} \\
  \EEs{\mu}{\EI{M}}{x}{N} \equiv N[M/x] \and
  (\EEs{\mu}{M}{x}{N[\EI{x}/z]}) \equiv N[M/z]
  \\
  
\inferrule*[Left = E-Elim]{
    \gamma,y:q \yields r \type \\\\
    \Gamma \yields_{\nu} M : \E{x.\mu}{A} \quad (\text{over } \gamma \yields \nu : q) \\\\
    \Gamma, x:A \yields_{r [\mu / y]} C \TYPE
    \quad (\text{over } \gamma, x:p \yields r [\mu / y] \type )}
  {\Gamma \yields_{r[\nu/y]} \EEs{\mu}{M}{x}{C} \TYPE \quad (\text{over }  \gamma \yields {r[\nu/y]} \type)} \\
  \EEs{\mu}{\EI{M}}{x}{C} \equiv C[M/x] \and
  (\EEs{\mu}{M}{x}{C[\EI{x}/z]}) \equiv C[M/z]
\end{mathpar}

\begin{align}
\label{eq:etype-id} \EIs{x.x}{M} &\equiv M &\E{x.x}{A} &\equiv A \\
\label{eq:etype-comp} \EIs{x.\mu}{\EIs{x.\nu}{M}} &\equiv \EIs{x.\mu[\nu/x]}{M} &\EIs{x.\mu}{\EIs{x.\nu}{A}} &\equiv \EIs{x.\mu[\nu/x]}{A} \\
\label{eq:etype-pair}\EIs{(y,y').(\nu, \nu')}{(M, N)} &\equiv (\EIs{y.\nu}{M}, \EIs{y.\nu'[\mu/x]}{N}) &\E{(y,y').(\nu, \nu')}{x' : A', B'} & \equiv \telety{x}{\E{y.\nu}{A'}}{\EEs{\nu}{x}{x'}{\E{y.\nu'}{B'}}} 
%% other whiskering 'is a substitution rule:
%% \St{(s[\mu/x])}{B[M/x]} & \equiv (\St{s}{B})[M/x] 
\end{align}
Using $\EIs{(y,y').(\nu, \nu')}{\dots}$ as a short-hand for $\EIs{w.(\nu[\fst w/y], \nu'[\snd w/y'])}{\dots}$.

\mvrnote{s-types intro} An instance of $\mathsf{E}$-types that we will use frequently is the $\mathsf{E}$-type for the mode term $\TrPlus{s}{x}$, where $s : p \tcell q$ is a mode term morphism. We introduce some syntax for this situation:
\begin{align*}
\St{s}{A} &:\equiv \E{x.\TrPlus{s}{x}}{A} \\
\StI{s}{x} &:\equiv \EIs{x.\TrPlus{s}{x}}{x} \\
\StE{s}{M}{y}{N} &:\equiv \EEs{x.\TrPlus{s}{x}}{M}{y}{N}
\end{align*}

In combination with \mvrnote{mode theory equations}, the fusion equations for $\mathsf{E}$-types specialise to:
\begin{align}
\label{eq:stype-id} \StI{\id_p}{M} &\equiv M &\St{\id_p}{A} &\equiv A \\
\label{eq:stype-comp} \StI{s}{\StI{t}{M}} &\equiv \StI{s;t}{M} &\St{s}{\St{t}{A}} &\equiv \St{(s;t)}{A} \\
\label{eq:stype-pair}\StI{(s, t)}{(M, N)} &\equiv (\StI{s}{M}, \StI{t[\mu/x]}{N}) &\St{(\telety{x'}{s}{t})}{\telety{x'}{A'}{B'}} & \equiv \telety{x}{\St{s}{A'}}{\StE{s}{x}{x'}{\St{t}{B'}}} 
\end{align}

Finally, we stipulate that $\St{s}{-}$ preserves fibrancy of types.
\begin{mathpar}
  \inferrule*[Left = s-fib]{
    \Gamma \yields_p A \ISFIB
  }
  {\Gamma \yields_q \St{s}{A} \ISFIB }
\end{mathpar}

\subsection{Derivable Terms and Equations}

We end this section with a number of lemmas (which apply to all mode
theories) that will be used in example encodings.

\begin{lemma}
The \textsc{rewrite} rule commutes with pairing of telescope types:
\begin{align*}
%(\rewrite{s}{M},N) &\equiv \rewrite{(s, \varepsilon_\nu^{\ap{q}{s/x}})}{(M, \UnSt{\ap{q}{s/x}}{N}}) \\
%(M,\rewrite{t}{N}) &\equiv \rewrite{(\id_\mu, t)}{(M,N)} \\
\rewrite{(s, t)}{(M, N)} &\equiv (\rewrite{s}{M}, \rewrite{t}{\StI{\ap{q}{s/x}}{N}} ) 
\end{align*}
where
\begin{align*}
\TermTwoT{\gamma &}{s}{\mu}{\mu'}{p} \\
\TermTwoT{\gamma &}{t}{\nu}{\TrPlus{\ap{q}{s}}{\nu'}}{q[\mu/x]} \\
\Gamma &\yields_{\mu'} M : A \\
\Gamma &\yields_{\nu'} N : B[M/x]
\end{align*}
\end{lemma}
\begin{proof}
\begin{align*}
&\rewrite{(s, t)}{(M, N)} \\
&\equiv (\fst\rewrite{(s, t)}{(M, N)}, \snd \rewrite{(s, t)}{(M, N)} ) \\
&\equiv (\fst z [\rewrite{(s, t)}{(M, N)}/z], \snd z [\rewrite{(s, t)}{(M, N)}/z] ) \\
&\equiv (\rewrite{\ap{\fst}{(s, t)}}{\fst (M, N)}, \rewrite{\ap{\snd}{(s, t)}}{\StI{\ap{q[\fst z/x]}{(s, t)/z}}{\snd (M, N)}} ) \\
&\equiv (\rewrite{s}{M}, \rewrite{t}{\StI{\ap{q}{s/x}}{N}} )
\end{align*}
This type checks via Equation~\eqref{eq:stype-subst}; in the second component we have
\begin{align*}
&\snd \rewrite{(s, t)}{(M, N)} &&: B[\fst\rewrite{(s, t)}{(M, N)}/x] \\
\equiv~&\snd \rewrite{(s, t)}{(M, N)} &&: B[\rewrite{s}{M}/x] \\
\equiv~&\rewrite{t}{\StI{\ap{q}{s/x}}{N}} &&: \St{\ap{q}{s/x}}{B[M/x]}
\end{align*}
\end{proof}

\begin{lemma} \label{lem:rewrite-push}
The \textsc{rewrite} rule commutes with $\mathsf{F}$-, $\mathsf{U}$- and $E$- introduction and elimination.
\begin{align*}
\FI{\rewrite{s}{M}} &\equiv \rewrite{\ap{\mu}{s/x}}{\FI{M}} \\
(\FE{\rewrite{s}{M}}{x}{N}) &\equiv \rewrite{\ap{\nu'}{s/y}}{\StI{\ap{r}{s/y}}{\FE{M}{x}{N}}} \\
\UE{M}{\rewrite{s}{N}} &\equiv \rewrite{\ap{\mu[\nu_1/c]}{s/x}}{\StI{\ap{q}{s/x}}{\UE{M}{N}}} \\
\UE{(\rewrite{t}{M})}{N} &\equiv \rewrite{\ap{\mu[\nu_2/x]}{t/c}}{\UE{M}{N}} \\
\UI{x}{\rewrite{\ap{\mu}{s/c}}{M}}  &\equiv\rewrite{s}{\UI{x}{M}} \\
\EI{\rewrite{s}{M}} &\equiv \rewrite{\ap{\mu}{s/x}}{\EI{M}} \\
(\EE{\rewrite{s}{M}}{x}{N}) &\equiv \rewrite{\ap{\nu'}{s/y}}{\StI{\ap{r}{s/y}}{\EE{M}{x}{N}}} \\
(\EEs{\mu}{M}{x}{\rewrite{s[\mu/y]}{N}}) &\equiv \rewrite{s[\nu/y]}{\EEs{\mu}{M}{x}{N}} 
\end{align*}
\end{lemma}
\begin{proof}
For \textsf{F}-types:
\begin{align*}
\FI{\rewrite{s}{M}} 
&\equiv \rewrite{\id_{\mu[\nu/x]}}{\FI{x}}[\rewrite{s}{M}/x]  \\
&\equiv \rewrite{\ap{\mu}{s/x}}{\StI{\ap{q}{s/x}}{\FI{x}[M/x]}} \\
&\equiv \rewrite{\ap{\mu}{s/x}}{\StI{\ap{q}{s/x}}{\FI{M}}} \\
&\equiv \rewrite{\ap{\mu}{s/x}}{\FI{M}} && \text{As $x$ does not appear in $q$.}\\
(\FE{\rewrite{s}{M}}{x}{N})
&\equiv \rewrite{\id_{\nu'[\nu/y]}}{\FE{y}{x}{N}}[\rewrite{s}{M}/y] \\
&\equiv \rewrite{\ap{\nu'}{s/y}}{\StI{\ap{r}{s/y}}{(\FE{y}{x}{N})[M/y]}} \\
&\equiv \rewrite{\ap{\nu'}{s/y}}{\StI{\ap{r}{s/y}}{\FE{M}{x}{N}}}
\end{align*}

For \textsf{U}-types:
\begin{align*}
\UE{M}{\rewrite{s}{N}}
&\equiv \rewrite{\id_{\mu[z/x, \nu_1/c]}}{\UE{M}{z}}[\rewrite{s}{N}/z] \\
&\equiv \rewrite{\ap{\mu[\nu_1/c]}{s/x}}{\StI{\ap{q[\nu_1/c]}{s/x}}{\UE{M}{N}}} \\
&\equiv \rewrite{\ap{\mu[\nu_1/c]}{s/x}}{\StI{\ap{q}{s/x}}{\UE{M}{N}}} \\
\UE{(\rewrite{t}{M})}{N}
&\equiv \rewrite{\id_{\mu[\nu_2/x, z/c]}}{\UE{(z)}{N}}[\rewrite{t}{M}/z] \\
&\equiv \rewrite{\ap{\mu[\nu_2/x]}{t/c}}{\StI{\ap{q[\nu_2/x]}{t/c}}{\UE{M}{N}}} \\
&\equiv \rewrite{\ap{\mu[\nu_2/x]}{t/c}}{\UE{M}{N}} && \text{(As $c$ does not appear in $q$)}\\
\rewrite{s}{\UI{x}{M}}
&\equiv \UI{y}{\UE{(\rewrite{s}{\UI{x}{M}})}{y}} \\
&\equiv \UI{y}{\rewrite{\ap{\mu[y/x]}{s/c}}{\UE{(\UI{x}{M})}{y}}} \\
&\equiv \UI{y}{\rewrite{\ap{\mu[y/x]}{s/c}}{M[y/x]}} \\
&\equiv \UI{x}{\rewrite{\ap{\mu}{s/c}}{M}}
\end{align*}

The first two equations for $\mathsf{E}$-types follow by the same reasoning as for $\mathsf{F}$-types. For the third, we make use of the $\eta$-expansion that is not available for $\mathsf{F}$-types.
\begin{align*}
\rewrite{s[\nu/y]}{\EEs{\mu}{M}{x}{N}}
&\equiv \rewrite{s}{\EEs{\mu}{y}{x}{N}} [M/y] \\
&\equiv \EEs{\mu}{M}{z}{(\rewrite{s}{\EEs{\mu}{y}{x}{N}}[\EIs{\mu}{z}/y])} \\
&\equiv \EEs{\mu}{M}{z}{(\rewrite{s[\mu/y]}{\EEs{\mu}{\EIs{\mu}{z}}{x}{N}})} \\
&\equiv \EEs{\mu}{M}{z}{\rewrite{s[\mu/y]}{N}}
\end{align*}
\end{proof}

\begin{lemma}
The \textsc{rewrite} rule commutes with \Fsym- and \Esym-elimination into types:
\begin{align*}
(\FE{\rewrite{s}{M}}{x}{C}) &\equiv \St{\ap{r}{s/y}}{\FE{M}{x}{C}} \\
(\EE{\rewrite{s}{M}}{x}{C}) &\equiv \St{\ap{r}{s/y}}{\EE{M}{x}{C}}
\end{align*}
\end{lemma}
\begin{proof}
This is analogous to elimination into terms:
\begin{align*}
\FE{\rewrite{s}{M}}{x}{C}
&\equiv (\FE{y}{x}{C})[\rewrite{s}{M}/y] \\
&\equiv \St{\ap{r}{s/y}}{(\FE{y}{x}{C})[M/y]} \\
&\equiv \St{\ap{r}{s/y}}{\FE{M}{x}{C}}
\end{align*}
and similarly for \Esym-types.
\end{proof}

\begin{lemma}\label{lem:s-elim-s-elim}
\textsc{E-elim} commutes with \textsc{F-elim} and \textsc{E-elim}:
\begin{align*}
\FE{(\EEs{\mu}{M}{x'}{N'})}{x}{N} &\equiv \EEs{\mu}{M}{x'}{(\FE{N'}{x}{N})} \\
\EEs{\nu}{(\EEs{\mu}{M}{x'}{N'})}{x}{N} &\equiv \EEs{\mu}{M}{x'}{(\EEs{\nu}{N'}{x}{N})}
\end{align*}
\end{lemma}
\begin{proof}
Using $\eta$ for \Esym-types:
\begin{align*}
&\FE{(\EEs{\mu}{M}{x'}{N'})}{x}{N} \\
&\equiv (\FE{(\EEs{\mu}{z}{x'}{N'})}{x}{N})[M/z] \\
&\equiv \EEs{\mu}{M}{z'}{((\FE{(\EEs{\mu}{z}{x'}{N'})}{x}{N})[\EIs{\mu}{z'}/z])} \\
&\equiv \EEs{\mu}{M}{z'}{((\FE{(\EEs{\mu}{\EIs{\mu}{z'}}{x'}{N'})}{x}{N}))} \\
&\equiv \EEs{\mu}{M}{z'}{(\FE{N'[z'/x']}{x}{N})} \\
&\equiv \EEs{\mu}{M}{x'}{(\FE{N'}{x}{N})}
\end{align*}
and similarly for the second.
\end{proof}

\begin{lemma}\label{lem:s-elim-fusion}
Fusion for \textsc{E-elim} on composites:
\begin{align*}
\EEs{y.\mu[\nu/y]}{M}{x}{N} \equiv \EEs{y.\mu}{M}{x'}{\EEs{y.\nu}{x'}{x}{N}}
\end{align*}
\end{lemma}
\begin{proof}
\begin{align*}
\StE{s;t}{M}{x}{N}
&\equiv \EEs{y.\mu}{M}{x'}{\EEs{y.\mu[\nu/y]}{\EIs{y.\mu}{x'}}{x}{N}} \\
&\equiv \EEs{y.\mu}{M}{x'}{\EEs{y.\nu}{x'}{x''}{\EEs{y.\mu[\nu/y]}{\EIs{y.\mu}{\EIs{y.\nu}{x''}}}{x}{N}}} \\
&\equiv \EEs{y.\mu}{M}{x'}{\EEs{y.\nu}{x'}{x''}{\EEs{y.\mu[\nu/y]}{\EIs{y.\mu[\nu/y]}{x''}}{x}{N}}} \\
&\equiv \EEs{y.\mu}{M}{x'}{\EEs{y.\nu}{x'}{x''}{N[x''/x]}} \\
&\equiv \EEs{y.\mu}{M}{x'}{\EEs{y.\nu}{x'}{x}{N}}
\end{align*}
\end{proof}

%\begin{lemma}\label{lem:s-elim-tuple}
%Fusion for \textsc{s-elim} on tuples:
%\begin{align*}
%\StE{(x : s, t)}{(M, M'[M/x])}{w}{N} \equiv \StE{s}{M}{x}{\StE{t[\TrPlus{s}{x}/x]}{M'[\StI{s}{x}/x]}{y}{N[(x,y)/w]}}
%\end{align*}
%\end{lemma}
%\begin{proof}
%\begin{align*}
%&\StE{(x : s, t)}{(M, M'[M/x])}{w}{N} \\
%&\equiv \StE{s}{M}{x}{\StE{(s, t)}{(\StI{s}{x}, M'[\StI{s}{x}/x])}{w}{N}} \\
%&\equiv \StE{s}{M}{x}{(\StE{t[\TrPlus{s}{x}/x]}{M'[\StI{s}{x}/x]}{y}{\StE{(s, t)}{(\StI{s}{x}, \StI{t[\TrPlus{s}{x}/x]}{y})}{w}{N}})} \\
%&\equiv \StE{s}{M}{x}{(\StE{t[\TrPlus{s}{x}/x]}{M'[\StI{s}{x}/x]}{y}{\StE{(s, t)}{\StI{(x : s, t)}{(x,y)}}{w}{N}})} \\
%&\equiv \StE{s}{M}{x}{\StE{t[\TrPlus{s}{x}/x]}{M'[\StI{s}{x}/x]}{y}{N[(x,y)/w]}}
%\end{align*}
%\end{proof}

%\begin{lemma}
%\textsc{F-elim} fuses with \textsc{s-intro}.
%\end{lemma}
%\begin{proof}
%\begin{align*}
%&\FEs{\TrPlus{s}{\mu}}{\StI{s}{M}}{x}{N} \\
%&\equiv \StE{s}{\StI{s}{M}}{y}{(\FEs{\mu}{y}{x}{N})} \\
%&\equiv \FEs{\mu}{M}{x}{N}
%\end{align*}
%and
%\begin{align*}
%& \FEs{\mu[\TrPlus{s}{x}/x]}{M}{x}{N[\StI{s}{x}/x]} \\
%&\equiv \FEs{\mu}{M}{y}{(\StE{s}{y}{x}{N[\StI{s}{x}/x]})}  \\
%&\equiv \FEs{\mu}{M}{y}{N[y/x]} \\
%&\equiv \FEs{\mu}{M}{x}{N}
%\end{align*}
%\end{proof}

\begin{lemma}
Split for telescope types is derivable:
\begin{mathpar}
\inferrule*[Left=$()$-split]{\Gamma, w : \telety{x}{A}{B} \yields_r C \TYPE \\\\ \Gamma \yields_{\nu} M : \telety{x}{A}{B} \\\\ \Gamma, x : A, y : B \yields_{\nu'[(x,y)/w]} N : C[(x,y)/w]}{\Gamma \yields_{\nu'[\nu/w]} \TeleE{M}{x}{y}{N} : C[M/w]}
\end{mathpar}
\end{lemma}
\begin{proof}
\begin{mathpar}
\inferrule*[Left=cut]{\Gamma, x : A, y : B \yields_{\nu'[(x,y)/w]} N : C[(x,y)/w]}{\Gamma \yields_{\nu'[\nu/w]} N[\fst M/x, \snd M/y] : C[(x, y)/w][\fst M/x, \snd M/y]}
\end{mathpar}
And by eta for telescope types, $C[(x, y)/w][\fst M/x, \snd M/y] \equiv C[(\fst M, \snd M)/w] \equiv C[M/w]$.
\end{proof}

Given a term such as $\beta : \E{\mu}{\telety{\alpha}{A}{B}}$, we will often use $\Esym$-elimination and then split on the pair. For clarity, rather than writing
\begin{align*}
\EEs{\mu}{M}{w}{\TeleE{w}{x}{y}{(\dots)}}
\end{align*}
we will write
\begin{align*}
\EEs{\mu}{M}{x, y}{(\dots)}
\end{align*}
Similarly, when $x : \alpha, y : \beta \yields \mu : \delta$  rather than writing 
\begin{align*}
\EEs{w.\mu(\fst w, \snd w)}{M}{z}{N}
\end{align*}
we will write
\begin{align*}
\EEs{(x, y).\mu(x, y)}{M}{z}{N}
\end{align*}

\begin{lemma}\label{lem:e-elim-telescope-type}
\textsc{s-elim} into types commutes with telescope formation and $\mathsf{U}$-formation, in the following sense:
\begin{align*}
\EEs{y.\nu}{M}{x}{(z : A, B)} &\equiv (z : \EEs{y.\nu}{M}{x}{A}, \EEs{(y, y').(\nu, y')}{(M,z)}{x, z}{B}) \\
\EEs{y.\nu}{M}{x}{\U{c.\mu'[\nu/x]}{z : A}{B}} &\equiv \U{c.\mu'[\mu/x]}{z : \EEs{\nu}{M}{x}{A}}{\EEs{(y, y').(\nu, y')}{(M,z)}{x, z}{B}}
\end{align*}
\end{lemma}
\begin{proof}
For telescopes:
\begin{align*}
&\EEs{y.\nu}{M}{x}{(z : A, B)} \\
&\equiv \EEs{\nu}{M}{x}{(z : \EEs{\nu}{\EIs{\nu}{x}}{x'}{A[x'/x]}, \EEs{(y, y').(\nu, y')}{\EIs{(y, y').(\nu, y')}{x, z}}{x', z'}{B[x'/x, z'/z]})} \\
&\equiv \EEs{\nu}{M}{x}{(z : \EEs{\nu}{\EIs{\nu}{x}}{x'}{A[x'/x]}, \EEs{(y, y').(\nu, y')}{(\EIs{\nu}{x},z)}{x', z'}{B[x'/x, z'/z]})} \\
&\equiv (z : \EEs{\nu}{\EIs{\nu}{x}}{x'}{A[x'/x]}, \EEs{(y, y').(\nu, y')}{(M,z)}{x', z'}{B[x'/x, z'/z]}) \\
&\equiv (z : \EEs{\nu}{\EIs{\nu}{x}}{x}{A}, \EEs{(y, y').(\nu, y')}{(M,z)}{x, z}{B}) 
\end{align*}
and for $\mathsf{U}$-types the proof is similar.
\end{proof}

\begin{lemma}\label{lem:ctxtuple}
Any context $\Gamma$ can be tupled into an iterated telescope type $\ctxtuple{\Gamma}$ of mode $\ctxtuple{\gamma}$, so that substitutions $\Gamma \yields \Theta : \Delta$ correspond bijectively with terms of $\ctxtuple{\Delta}$.
\begin{mathpar}
\inferrule*{\yields_\gamma \Gamma}
             {\cdot \yields_{\ctxtuple{\gamma}} \ctxtuple{\Gamma} \TYPE}
\and
\inferrule*{~}
             {\sigma : \ctxtuple{\Gamma} \yields_{\unpack{\gamma}{\sigma}} \unpack{\Gamma}{\sigma} : \Gamma}
\and
\inferrule*{~}
             {\Gamma \yields_{\pack{\gamma}} \pack{\Gamma} : \ctxtuple{\Gamma}}
\\
\inferrule*{~}
             {\Gamma \yields \unpack{\Gamma}{\pack{\Gamma}} \equiv \id_\Gamma}
\and
\inferrule*{~}
             {\sigma : \ctxtuple{\Gamma} \yields \pack{\Gamma}[\unpack{\Gamma}{\sigma}] \equiv \sigma}
\end{mathpar}
\end{lemma}
\begin{proof}
$\ctxtuple{\Gamma}$ is defined inductively by
\begin{align*}
\ctxtuple{\cdot} &:\equiv 1 \\
\ctxtuple{\Gamma, x : A} &:\equiv \sigmacl{\sigma}{\ctxtuple \Gamma}{A[\unpack{\Gamma}{\sigma}]}\\
\unpack{(\cdot)}{\sigma} &:\equiv \cdot \\
\unpack{\Gamma, x : A}{\sigma} &:\equiv \unpack{\Gamma}{\fst \sigma}, \snd{\sigma}/x
\end{align*}
with each definition lying over the identical one downstairs. 
For $\pack{\Gamma}$ we simultaneously verify the equation $ \unpack{\Gamma}{\pack{\Gamma}} \equiv \id_\Gamma$, as we need it to hold for $(\pack{\Gamma}, x)$ to be well typed.
\begin{align*}
\pack{(\cdot)} &:\equiv \mt : 1 \\
\pack{\Gamma, x : A} &:\equiv (\pack{\Gamma}, x) : \sigmacl{\sigma}{\ctxtuple \Gamma}{A[\unpack{\Gamma}{\sigma}]} \\
\unpack{(\cdot)}{\pack{(\cdot)}} &\equiv  \cdot \equiv \id_{(\cdot)}\\
\unpack{\Gamma, x : A}{\pack{\Gamma, x : A}} 
&\equiv \unpack{\Gamma}{\fst \pack{\Gamma, x : A}}, \snd{\pack{\Gamma, x : A}}/x \\
&\equiv \unpack{\Gamma}{\pack{\Gamma}}, x/x \\
&\equiv \id_\Gamma, x/x \\
&\equiv \id_{\Gamma, x : A}
\end{align*}
For the second equation, we check inductively that
\begin{align*}
\pack{(\cdot)}[\unpack{(\cdot)}{\sigma}] 
&\equiv \mt[\id_{(\cdot)}] \\
&\equiv \sigma \\
\pack{\Gamma, x : A}[\unpack{\Gamma, x : A}{\sigma}]
&\equiv (\pack{\Gamma}, x)[\unpack{\Gamma}{\fst \sigma}, \snd{\sigma}/x] \\
&\equiv (\pack{\Gamma}[\unpack{\Gamma}{\fst \sigma}], \snd \sigma) \\
&\equiv (\fst \sigma, \snd \sigma) \\
&\equiv \sigma
\end{align*}
\end{proof}

%\begin{lemma}
%Tupling respects substitution: for $\gamma \yields \theta : \delta$ and $\delta \yields \kappa : \lambda$, we have:
%\begin{align*}
%\ctxtuple{(\kappa[\theta])} &\equiv (\ctxtuple{\kappa})[\theta]
%\end{align*}
%\end{lemma}
%\begin{proof}
%By induction on the length of $\lambda$:
%\begin{align*}
%\ctxtuple{((\cdot)[\theta])}
%&\equiv \ctxtuple{(\cdot)} \\
%&\equiv (\ctxtuple{(\cdot)})[\theta] \\
%\ctxtuple{((\kappa, M)[\theta])}
%&\equiv \ctxtuple{(\kappa[\theta], M[\theta])} \\
%&\equiv \ctxtuple{(\kappa[\theta]), M[\theta]} \\
%&\equiv (\ctxtuple \kappa)[\theta], M[\theta] \\
%&\equiv (\ctxtuple\kappa, M)[\theta]
%\end{align*}
%\end{proof}

%\begin{definition}
%A 2-cell between mode substitutions of shape $\gamma \yields t : \theta \tcell_\delta \theta' $ is specified by a mode term 2-cell \[\gamma \yields \ctxtuple t : \ctxtuple \theta \tcell_{\ctxtuple \delta} \ctxtuple \theta'. \]
%\end{definition}
%\mvrnote{A little confusing: for contexts and substitutions $\ctxtuple{}$ is an operation, here $\ctxtuple t$ is not an operation on $t$ but rather the underlying `implementation' of $t$.}

%\begin{lemma}\label{lem:n-ary-ap-rewrite}
%N-ary ap and rewrite are admissible:
%\begin{mathpar}
%\inferrule*{\delta \vdash {q} \type \\
%            \gamma \yields t : \theta \tcell_\delta \theta'
%           } 
%           {\TypeTwo{\gamma}{\ap {q} {t}}{q[\theta]}{q[\theta']}}
%\and
%\inferrule*{\delta \yields {\nu} : {q} \\
%            \gamma\yields t : \theta \tcell \theta'
%           } 
%           {\TermTwoT{\gamma}{\ap \nu {t}}{\nu[\theta]}{\TrPlus{\ap{q}{t}}{\nu[\theta]}}{q[\theta]}} \\
% \inferrule*[Left = rewrite]{
%   \Gamma \yields_{\theta'} \Theta : \Delta \and 
%   \gamma \yields t : \theta \tcell \theta'
%  }
%  {\Gamma \yields_{\theta} \rewrite{t}{\Theta} : \Delta}
%\end{mathpar}
%\end{lemma}
%\begin{proof}
%These are
%\begin{align*}
%\ap {q} {t} &:\equiv \ap{q[\unpack{\delta}{\sigma}]}{\ctxtuple t/\sigma} \\
%\ap {\nu} {t} &:\equiv \ap{\nu[\unpack{\delta}{\sigma}]}{\ctxtuple t/\sigma} \\
%\rewrite{t}{\Theta} &:\equiv \unpack{\Delta}{\rewrite{\ctxtuple t}{\ctxtuple \Theta}}
%\end{align*}
%which are well-typed by the equation $\theta \equiv \unpack{\delta}{\ctxtuple \theta}$.
%\end{proof}
%
%In particular, we have the following rules for building and using 2-cells between substitutions.
%\begin{mathpar}
%\inferrule{\gamma \yields t : \theta \tcell_\delta \theta' \and \gamma \yields s : \mu[\theta] \tcell_{p[\theta]} \TrPlus{\ap{p}{t}}{\mu'[\theta']}}
%{ \gamma \yields (s, t) : (\theta, \mu) \tcell_{(\delta,x:p)} (\theta', \mu')} \\
%%
%\inferrule{\gamma \yields t : (\theta, \mu) \tcell_{(\delta, x : p)} (\theta', \mu')}
%{\gamma \yields \ap{\fst}{t} : \theta \tcell_\delta \theta' } \and
%%
%\inferrule{\gamma \yields t : (\theta, \mu) \tcell_{(\delta, x : p)} (\theta', \mu')}
%{\gamma \yields \ap{\snd}{t} : \mu[\theta] \tcell_{p[\theta]} \TrPlus{\ap{p}{\ap{\fst}{t}}}{\mu'[\theta']}}
%\end{mathpar}%
%
%\begin{lemma}
%N-ary ap of a 2-cell on a substitution is admissible
%\begin{mathpar}
%\inferrule{\gamma \yields t : \theta \tcell_\delta \theta' \and \delta \yields \kappa : \lambda}
%{\gamma \yields \ap{\kappa}{t} : \kappa[\theta] \tcell_\lambda \kappa[\theta']}
%\end{mathpar} 
%\end{lemma}
%\begin{proof}
%Due to the equation $\ctxtuple(\kappa[\theta]) \equiv (\ctxtuple \kappa)[\theta]$ we can just define $\ctxtuple{(\ap{\kappa}{t})} :\equiv \ap{(\ctxtuple \kappa)}{t}$.
%\end{proof}

%\begin{lemma}
%N-ary associativity and interchange hold:
%\begin{align*}
%\ap {(\nu[\theta])} {t} &\equiv \ap \nu {\ap \theta {t}} \\
%s[\theta];\ap{\nu'}{t} &\equiv \ap{\nu}{t};\ap{(\TrPlus{\ap{q}{t}}{y})}{s[\theta']/y}
%\end{align*}
%\end{lemma}
%\begin{proof}
%Unwinding definitions we find:
%\begin{align*}
%\ap {(\nu[\theta])} {t}
%&\equiv \ap{\nu[\theta][\fan{\delta}]}{\ctxtuple t/\sigma} \\
%&\equiv \ap{\nu[\fan{\delta}][\ctxtuple \theta / \sigma][\fan{\gamma}]}{\ctxtuple t/\sigma} \\
%&\equiv \ap{\nu[\fan{\delta}]}{\ap{\ctxtuple \theta[\fan{\gamma}]}{\ctxtuple t/\sigma}/\sigma} \\
%&\equiv \ap{\nu[\fan{\delta}]}{\ap{(\ctxtuple \theta)}{t}/\sigma} \\
%&\equiv \ap{\nu[\fan{\delta}]}{\ctxtuple{(\ap \theta {t})}/\sigma} \\
%&\equiv \ap \nu {\ap \theta {t}}
%\end{align*}
%and
%\begin{align*}
%s[\theta];\ap{\nu'}{t} 
%&\equiv s[\theta];\ap{\nu'[\fan{\delta}]}{\ctxtuple t/\sigma} \\
%&\equiv \ap{\nu[\fan{\delta}]}{\ctxtuple t/\sigma} ; \ApPlus{(\ap{q[\fan{\delta}]}{\ctxtuple t/\sigma})}{s[\theta']} \\
%&\equiv \ap{\nu}{t};\ap{(\TrPlus{\ap{q}{t}}{y})}{s[\theta']/y}
%\end{align*}
%\end{proof}

%\begin{lemma}
%A N-ary versions of the equations concerning rewrites hold:
%\begin{align*}
%\St{(\ap{q}{t})}{B[\Theta]} &\equiv B[\rewrite{t}{\Theta}] \\
%\rewrite{\ap{\nu}{t}}{\StI{\ap{q}{t}}{N[\Theta]}} &\equiv N[\rewrite{t}{\Theta}] \\
%\rewrite{\ap{\kappa}{t}}{\Theta;\kappa} &\equiv \rewrite{t}{\Theta};\kappa
%\end{align*}
%\end{lemma}
%\begin{proof}
%\begin{align*}
%B[\rewrite{t}{\Theta}] 
%&\equiv B[\fan{\Delta}[\rewrite{\ctxtuple t}{\ctxtuple \Theta}/\sigma]] \\
%&\equiv B[\fan{\Delta}][\rewrite{\ctxtuple t}{\ctxtuple \Theta}/\sigma] \\
%&\equiv \St{\ap{q[\fan{\delta}]}{\ctxtuple t / \sigma}}{B[\fan{\Delta}][\ctxtuple \Theta/\sigma]} \\
%&\equiv \St{\ap{q}{t}}{B[\Theta]}
%\end{align*}
%And:
%\begin{align*}
%N[\rewrite{t}{\Theta}]
%&\equiv N[\fan{\Delta}[\rewrite{\ctxtuple t}{\ctxtuple \Theta}/\sigma]] \\
%&\equiv N[\fan{\Delta}][\rewrite{\ctxtuple t}{\ctxtuple \Theta}/\sigma] \\
%&\equiv \rewrite{\ap{\nu[\fan{\delta}]}{\ctxtuple t/\sigma}}{\StI{\ap{q[\fan{\delta}]}{\ctxtuple t/\sigma}}{N[\fan{\Delta}][\ctxtuple \Theta/\sigma]}} \\
%&\equiv \rewrite{\ap{\nu}{t}}{\StI{\ap{q}{t}}{N[\Theta]}} \\
%\end{align*}
%And:
%\begin{align*}
%\rewrite{\ap{\kappa}{t}}{\Theta;\kappa}
%&\equiv \fan{\Lambda}[\rewrite{\ctxtuple{(\ap{\kappa}{t})}}{\ctxtuple {(\Theta;\kappa)}}/\sigma] \\
%&\equiv \fan{\Lambda}[\rewrite{\ap{(\ctxtuple \kappa)}{t}}{(\ctxtuple \kappa)[\Theta]}/\sigma] \\
%&\equiv \fan{\Lambda}[(\ctxtuple \kappa)[\rewrite{t}{\Theta}]/\sigma] \\
%&\equiv \fan{\Lambda}[(\ctxtuple \kappa)/\sigma][\rewrite{t}{\Theta}] \\
%&\equiv \kappa[\rewrite{t}{\Theta}] \\
%&\equiv \rewrite{t}{\Theta};\kappa
%\end{align*}
%using the previous equation.
%\end{proof}

%\begin{lemma}
%Rewriting by a tuple is a tuple of rewritings:
%\begin{align*}
%\rewrite{(t, s/x)}{\Theta, M/x} \equiv (\rewrite{t}{\Theta}, \rewrite{s}{\StI{\ap{p}{t}}{M}})
%\end{align*}
%\end{lemma}
%\begin{proof}
%Unwinding definitions:
%\begin{align*}
%\rewrite{(t, s/x)}{\Theta, M/x}
%&\equiv \fan{\Delta, x : A}[\rewrite{\ctxtuple{(t, s/x)}}{\ctxtuple{(\Theta, M/x)}}/\sigma] \\
%&\equiv (\fan\Delta[\fst{\sigma}/\sigma], \snd{\sigma})[\rewrite{(\ctxtuple t, s)}{\ctxtuple\Theta, M}/\sigma] \\
%&\equiv (\fan\Delta[\fst{\sigma}/\sigma], \snd{\sigma})[(\rewrite{\ctxtuple t}{\ctxtuple\Theta}, \rewrite{s}{\StI{\ap{p[\fan{\delta}]}{\ctxtuple t/\sigma}}{N}})/\sigma] \\
%&\equiv (\fan\Delta[\rewrite{\ctxtuple t}{\ctxtuple\Theta}/\sigma], \rewrite{s}{\StI{\ap{p[\fan{\delta}]}{\ctxtuple t/\sigma}}{N}}) \\
%&\equiv (\rewrite{t}{\Theta}, \rewrite{s}{\StI{\ap{p}{t}}{M}})
%\end{align*}
%\end{proof}
%
%As a special case, note that we have
%\begin{align*}
%\rewrite{(\id_\Theta, s/x)}{\Theta, M/x} \equiv (\Theta, \rewrite{s}{M}/x)
%\end{align*}
%
%\mvrnote{Need to say something like: Because the above $n$-ary versions have been derived, from now on we use $\ap{\mu}{s/x, t/y}$ as shorthand for the $n$-ary version}

\section{Example Encodings of Object Languages}
\label{sec:example-encodings}

Next, we show that the top theory for the mode theories from
Section~\ref{sec:mode-examples} support the usual rules for these type theories.

\subsection{Martin-L\"of Type Theory}
\label{sec:mltt}

To distinguish judgements in the type theory we are encoding from the ones in the
framework we use $\qyields$ as the turnstile. We have the following
judgements:
\begin{mathpar}
\qyields \Gamma \CTX \and \Gamma \qyields A \TYPE \and \Gamma \qyields a : A \and \Gamma \qyields \Theta : \Delta 
\end{mathpar}
with the inference rules given in Figure~\ref{fig:qit-rules}, which we
think of in quotient inductive-inductive type style as presenting the
free category with families.
Note that some equations require earlier equations to hold in order to typecheck.

The idea for the representation in the framework is that: 

\begin{itemize}
\item A context $\qyields \Gamma \CTX$ is represented by a framework
  context $\upstairs{\Gamma}$ over mode context $\downstairs{\Gamma}$,
  together with a mode term $\downstairs{\Gamma} \yields \modeof{\Gamma} : p$. The mode context $\downstairs{\Gamma}$ describes the \emph{internal} dependency structure of the context $\Gamma$ (i.e.\ how types in $\Gamma$ depend on variables elsewhere in $\Gamma$).
  $\modeof{\Gamma}$ describes the \emph{external} dependency structure (i.e.\ how some other judgment made \emph{in} context $\Gamma$ will depend on the variables in $\Gamma$).
  These will be defined mutually, because the internal dependency of a
  context extension involves a type that is externally dependent on the
  previous context.  
\item A type $\Gamma \qyields A \TYPE$ is represented by a framework type $\upstairs{\Gamma} \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{A} \TYPE$.
\item A term $\Gamma \qyields a : A$ is represented by a framework term $\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \upstairs{a} : \upstairs{A}$.
\item A substitution $\Gamma \qyields \Theta : \Delta$ is represented by a framework term $\upstairs{\Gamma} \yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\sigma.\modeof{\Delta}[\unpack{\Delta}{\sigma}]}{\upstairs{\Delta}}$ where $(\upstairs{\Delta})$ denotes the iterated tupling of $\upstairs{\Delta}$ as in Lemma~\ref{lem:ctxtuple}. 
\end{itemize}
\mvrnote{One might expect substitutions to be represented by framework substitutions. In the current setup this is not possible: a substitution $\upstairs{\Gamma} \yields_{\modeof{\Gamma}} \upstairs{\Theta} : \upstairs{\Delta}$ has the shape of $\Gamma$ described on the turnstile, but the shape of $\Delta$ is not described anywhere. See \dots for a semantic description of where the issue lies.}

\subsubsection{Contexts and Substitutions}

\begin{theorem}
The rules in Figure~\ref{fig:qit-rules} for the contexts and
substitutions of Martin-L\"of type theory can be interpreted in the type
theory over a comprehension object with $\E{\sigma.\modeof{\Gamma}[\unpack{\Gamma}{\sigma}]}{-}$ types
for all $\Gamma$, i.e.\ with strict modalities for composites of $\sdot$
and $\sempty$.
\end{theorem}

In what follows, to reduce clutter we will abbreviate $\unpack{\Delta}{\sigma}$ to $\unp{\Delta}{\sigma}$.

\begin{figure}
\begin{mathpar}
\inferrule*[left=ctx-empty]{~}{\cdot \CTX} \and
\inferrule*[left=ctx-ext]{\qyields \Gamma \CTX \and \Gamma \qyields A \TYPE}{\qyields \Gamma, A \CTX} \\
\inferrule*[left=type-sub]{\Delta \qyields A \TYPE \and \Gamma \qyields \Theta : \Delta}{\Gamma \qyields A[\Theta] \TYPE} \and
\inferrule*[left=term-sub]{\Delta \qyields a : A  \and \Gamma \qyields \Theta : \Delta}{\Gamma \qyields a[\Theta] : A[\Theta]} 
\\
\inferrule*[left=sub-empty]{~}{\Gamma \qyields \epsilon_\Gamma : \cdot} \and
\inferrule*[left=sub-ext]{\Gamma \qyields \Theta : \Delta \and \Gamma \qyields a : A[\Theta]}{\Gamma \qyields (\Theta, a) : \Delta, A} \\
\inferrule*[left=sub-id]{~}{\Gamma \qyields \id_\Gamma : \Gamma} \and
\inferrule*[left=sub-comp]{\Gamma \qyields \Theta : \Delta \and \Delta \qyields \kappa : \Lambda}{\Gamma \qyields \Theta ; \kappa : \Lambda} \\
\inferrule*[left=sub-proj]{~}{\Gamma, A \qyields \proj{\Gamma,A} : \Gamma} \and 
\inferrule*[left=var]{~}{\Gamma, A \qyields \qvar{\Gamma,A} : A[\proj{\Gamma,A}]} 
\end{mathpar}

\begin{align}
A[\id] &\equiv A \\
A[\Theta ; \kappa] &\equiv A[\kappa][\Theta] \\
\nonumber\\
a[\id] &\equiv a \\
a[\Theta ; \kappa] &\equiv a[\kappa][\Theta] \\
\nonumber\\
\id ; \Theta &\equiv \Theta \\
\Theta ; \id &\equiv \Theta \\
(\Theta; \kappa) ; \rho &\equiv \Theta ; (\kappa ; \rho) \\
\nonumber\\
\Theta ; (\kappa , a) &\equiv (\Theta ; \kappa) , a[\Theta] \\ 
(\Theta, a);\proj{\Gamma,A} &\equiv \Theta \\
\qvar{\Delta,A}[\Theta, a] &\equiv a \\
(\proj{\Gamma,A}, \qvar{\Gamma,A}) &\equiv \id_{\Gamma, A} \\
\Theta &\equiv \epsilon_\Gamma && \text{for } \Gamma \qyields \Theta : \cdot
\end{align}
\caption{Rules of MLTT Contexts and Substitutions}\label{fig:qit-rules}
\end{figure}

The structural rules of MLTT have the following translations:
\begin{enumerate}
\item[\textsc{ctx-empty}] Define $\upstairs{(\cdot)}$ to be the empty framework context and $\modeof{(\cdot)} :\equiv \emptyset : p$.

\item[\textsc{ctx-ext}] Given $\upstairs{\Gamma}
  \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{A} \TYPE$, define $\upstairs{\Gamma, A}$ to be the extended framework context $\upstairs{\Gamma}, x : \upstairs{A}$. We need to specify a term $\upstairs{\Gamma}, x : \upstairs{A} \yields \modeof{(\Gamma, A)} : p$, for this we can use
  \begin{align*}
  \upstairs{\Gamma}, x : \upstairs{A} \yields \modeof{(\Gamma, A)} :\equiv (\modeof{\Gamma}).x : p
  \end{align*}
  
\item[\textsc{type-sub}] Given $\upstairs{\Delta} \yields_{\El{p}{\modeof{\Delta}}} \upstairs{A} \TYPE$ and $\upstairs{\Gamma} \yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\modeof{\Delta}}{\upstairs{\Delta}}$, we can form:
\begin{align*}
\upstairs{\Gamma} \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{A[\Theta]} :\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]} \TYPE
\end{align*}

\item[\textsc{term-sub}] Similarly, given $\upstairs{\Delta} \yields_{\El{p}{\One_{\modeof{\Delta}}}} \upstairs{a} : \upstairs{A} \TYPE$ and $\upstairs{\Gamma} \yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\modeof{\Delta}}{\upstairs{\Delta}}$, we can form:
\begin{align*}
\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \upstairs{a[\Theta]} :\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{a}[\unp{\Delta}{\sigma}]} : \upstairs{A[\Theta]}
\end{align*}

\item[\textsc{sub-empty}] We are constructing a term
\begin{align*}
\upstairs{\Gamma} \yields_{\modeof{\Gamma}} \upstairs{\epsilon_\Gamma} : \E{\emptyset}{}
\end{align*}
We may use the counit $\eta^\sempty_{\modeof{\Gamma}} : \modeof{\Gamma} \tcell_p \emptyset$ to form
\begin{align*}
\upstairs{\epsilon_\Gamma} :\equiv \rewrite{\eta^\sempty_{\modeof{\Gamma}}}{\EIs{\emptyset}{}}
\end{align*}

\item[\textsc{sub-ext}] We are provided
\begin{align*}
\upstairs{\Gamma} &\yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\modeof{\Delta}}{\upstairs{\Delta}} \\
\upstairs{\Gamma} &\yields_{\One_{\modeof{\Gamma}}} \upstairs{a} : \upstairs{A[\Theta]}
\end{align*}
and we are trying to define:
\begin{align*}
\upstairs{\Gamma} &\yields_{\modeof{\Gamma}} \upstairs{\Theta, a} : \E{\modeof{(\Delta, A)}}{\upstairs{\Delta, A}}
\end{align*}
Unfolding definitions:
\begin{align*}
\upstairs{A[\Theta]}
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}
\intertext{and}
\E{\modeof{(\Delta, A)}}{\upstairs{\Delta, A}} 
&\equiv \E{(\sigma, x). \sdot(\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{\sigma : \ctxtuple{\upstairs{\Delta}}, \upstairs{A}[\unp{\Delta}{\sigma}]} 
 \\
&\equiv \E{(\sigma, x). \sdot\, w[(\modeof{\Delta}[\unp{\Delta}{\sigma}], x)/w]}{\ctxtuple{\sigma : \upstairs{\Delta}}, \upstairs{A}[\unp{\Delta}{\sigma}]} \\
&\equiv \E{\sdot}{\E{(\sigma, x).(\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{\ctxtuple{\sigma : \upstairs{\Delta}}, \upstairs{A}[\unp{\Delta}{\sigma}]}} \\
&\equiv \E{\sdot}{\ctxtuple{\sigma' : \E{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Delta}}, \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\sigma'}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}}} \\
\end{align*}
So we can form:
\begin{align*}
\upstairs{\Theta, a} :\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EIs{\sdot}{\upstairs{\Theta}, \upstairs{a}}}
\end{align*}

\item[\textsc{sub-id}] We have:
\begin{align*}
\upstairs{\Gamma} \yields_{\modeof{\Gamma}} \upstairs{\id_\Gamma} :\equiv \EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\upstairs{\Gamma}}} : \E{\modeof{\Gamma}}{\upstairs{\Gamma}}
\end{align*}

\item[\textsc{sub-comp}]
Given 
\begin{align*}
\upstairs{\Gamma} &\yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\modeof{\Delta}}{\upstairs{\Delta}} \\
\upstairs{\Delta} &\yields_{\modeof{\Delta}} \upstairs{\kappa} : \E{\modeof{\Lambda}}{\upstairs{\Lambda}}
\end{align*}
we can form
\begin{align*}
\upstairs{\Theta;\kappa} :\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{\kappa}[\unp{\upstairs{\Delta}}{\sigma}]}
\end{align*}

\item[\textsc{sub-proj}] We are trying to construct a term
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A} \yields_{\modeof{(\Gamma, A)}} \upstairs{\proj{\Gamma, A}} : \E{\modeof{\Gamma}}{\upstairs{\Gamma}}
\end{align*}
The mode term morphism $\pi^{\modeof{\Gamma}}_x$ has type $\modeof{(\Gamma, A)} \equiv (\modeof{\Gamma}).x \tcell_{p} \modeof{\Gamma}$
So define:
\begin{align*}
\upstairs{\proj{\Gamma, A}} :\equiv \rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_\Gamma}}
\end{align*}

\item[\textsc{var}] We are a building a term
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{\modeof{(\Gamma, A)}}} \upstairs{\qvar{\Gamma, A}} : \upstairs{A[\proj{\Gamma, A}]}
\end{align*}
The type in question simplifies:
\begin{align*}
\upstairs{A[\proj{\Gamma, A}]}
&\equiv \EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\upstairs{\proj{\Gamma, A}}}{\sigma}{\upstairs{A}[\unp{\Gamma}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_\Gamma}}}{\sigma}{\upstairs{A}[\unp{\Gamma}{\sigma}]} \\
&\equiv \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\upstairs{\id_\Gamma}}{\sigma}{\upstairs{A}[\unp{\Gamma}{\sigma}]}} \\
&\equiv \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\downstairs{\Gamma}}}}{\sigma}{\upstairs{A}[\unp{\Gamma}{\sigma}]}} \\
&\equiv \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{A}[\unp{\Gamma}{\sigma}][\pack{\downstairs{\Gamma}}/\sigma]} \\
&\equiv \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{A}}
\end{align*}

So define $\upstairs{\qvar{\Gamma, A}}$ by:
\begin{align*}
\upstairs{\qvar{\Gamma, A}} :\equiv \rewrite{\var{x}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{x}}
\end{align*}
\end{enumerate}

Now we check that these translations satisfy the required equations.

\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$A[\id_\Gamma] \equiv A$}] 
\begin{align*}
\upstairs{A[\id_\Gamma]}
&\equiv \EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\upstairs{\id_\Gamma}}{\sigma}{\upstairs{A}[\unp{\Gamma}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\downstairs{\Gamma}}}}{\sigma}{\upstairs{A}[\unp{\Gamma}{\sigma}]} \\
&\equiv \upstairs{A}[\unp{\Gamma}{\pack{\downstairs{\Gamma}}}]\\
&\equiv \upstairs{A}
\end{align*}

\item[{$A[\Theta ; \kappa] \equiv A[\kappa][\Theta]$}] 
\begin{align*}
\upstairs{A[\Theta ; \kappa]}
&\equiv \EEs{\sigma.\modeof{\Lambda}[\unp{\Lambda}{\sigma}]}{\upstairs{\Theta ; \kappa}}{\sigma}{\upstairs{A}[\unp{\Lambda}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Lambda}[\unp{\Lambda}{\sigma}]}{(\EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma'}{\upstairs{\kappa}[\unp{\upstairs{\Delta}}{\sigma'}]})}{\sigma}{\upstairs{A}[\unp{\Lambda}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma'}{\EEs{\sigma.\modeof{\Lambda}[\unp{\Lambda}{\sigma}]}{\upstairs{\kappa}[\unp{\upstairs{\Delta}}{\sigma'}]}{\sigma}{\upstairs{A}[\unp{\Lambda}{\sigma}]}} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma'}{(\EEs{\sigma.\modeof{\Lambda}[\unp{\Lambda}{\sigma}]}{\upstairs{\kappa}}{\sigma}{\upstairs{A}[\unp{\Lambda}{\sigma}]})[\unp{\Delta}{\sigma'}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma'}{\upstairs{A[\kappa]}[\unp{\Lambda}{\sigma'}]} \\
&\equiv \upstairs{A[\kappa][\Theta]}
\end{align*}

\item[{$a[\id_\Gamma] \equiv a$}] Same as for types.
\item[{$a[\Theta ; \kappa] \equiv a[\kappa][\Theta]$}] Same as for types.

\item[{$\Theta ; (\kappa , a) \equiv (\Theta ; \kappa) , a[\Theta]$}]
\begin{align*}
\upstairs{\Theta ; (\kappa , a)}
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{(\kappa , a)}[\unp{\upstairs{\Delta}}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\rewrite{\eta^\sdot_{\modeof{\Lambda}}}{\EIs{\sdot}{\upstairs{\kappa}, \upstairs{a}}}[\unp{\upstairs{\Delta}}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\rewrite{\eta^\sdot_{\modeof{\Lambda}}}{\EIs{\sdot}{\upstairs{\kappa}[\unp{\upstairs{\Delta}}{\sigma}], \upstairs{a}[\unp{\upstairs{\Delta}}{\sigma}]}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Lambda}}}{\EIs{\sdot}{(\EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{\kappa}[\unp{\upstairs{\Delta}}{\sigma}]}), (\EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{a}[\unp{\upstairs{\Delta}}{\sigma}]})}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Lambda}}}{\EIs{\sdot}{\upstairs{(\Theta ; \kappa)}, \upstairs{a[\Theta]}}} \\
&\equiv \upstairs{(\Theta ; \kappa) , a[\Theta]}
\end{align*} 

\item[{$(\Theta, a);\proj{\Delta,A} \equiv \Theta$}]
\begin{align*}
\upstairs{(\Theta, a);\proj{\Delta,A}}
&\equiv \EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\upstairs{\Theta, a}}{\sigma}{\upstairs{\proj{\Delta,A}}[\unp{\upstairs{\Delta, A}}{\sigma}]} \\
&\equiv \EEs{(\sigma, x). \sdot \, w[(\modeof{\Delta}[\unp{\Delta}{\sigma}], x)/w]}{\rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EIs{\sdot}{\upstairs{\Theta}, \upstairs{a}}}}{\sigma}{\rewrite{\pi^{\modeof{\Delta}}_x}{\upstairs{\id_\Delta}}[\unp{\upstairs{\Delta, x : A}}{\sigma}]} \\
&\equiv \EEs{\sdot}{\rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EIs{\sdot}{\upstairs{\Theta}, \upstairs{a}}}}{\sigma'}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{\sigma'}{\sigma}{\rewrite{\pi^{\modeof{\Delta}}_x}{\upstairs{\id_\Delta}}[\unp{\upstairs{\Delta, x : A}}{\sigma}]}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EEs{\sdot}{\StI{\sdot}{\upstairs{\Theta}, \upstairs{a}}}{\sigma'}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{\sigma'}{\sigma}{\rewrite{\pi^{\modeof{\Delta}}_x}{\upstairs{\id_\Delta}}[\unp{\upstairs{\Delta, x : A}}{\sigma}]}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, \upstairs{a})}{\sigma}{\rewrite{\pi^{\modeof{\Delta}}_x}{\upstairs{\id_\Delta}}[\unp{\upstairs{\Delta, x : A}}{\sigma}]}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, \upstairs{a})}{\sigma}{\rewrite{\pi^{\modeof{\Delta}}_x}{\upstairs{\id_\Delta}}[\unp{\upstairs{\Delta}}{\fst \sigma}/\sigma, \snd \sigma / x]}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, \upstairs{a})}{\sigma}{\rewrite{\pi^{\modeof{\Delta}[\unp{\upstairs{\Delta}}{\fst \sigma}]}_{\snd \sigma}}{\EIs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\fst \sigma}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\rewrite{\pi^{\fst \sigma}_{\snd \sigma}}{\fst \sigma}[(\upstairs{\Theta}, \upstairs{a})/\sigma]} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}};\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}{\upstairs{\Theta}} \\
&\equiv \upstairs{\Theta}
\end{align*}

\item[{$\qvar{\Delta,A}[\Theta, a] \equiv a$}]
\begin{align*}
\upstairs{\qvar{\Delta,A}[\Theta, a]}
&\equiv \EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\upstairs{(\Theta, a)}}{\sigma}{\upstairs{\qvar{\Delta,A}}[\unp{\Delta, x : A}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EIs{\sdot}{\upstairs{\Theta}, \upstairs{a}}}}{\sigma}{\rewrite{\var{x}}{\StI{\ApEl{p}{\pi^{\modeof{\Delta}}_x}}{x}}[\unp{\Delta, A}{\sigma}]} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\EIs{\sdot}{\upstairs{\Theta}, \upstairs{a}}}{\sigma}{\rewrite{\var{\snd \sigma}}{\StI{\ApEl{p}{\pi^{\modeof{\Delta}[\unp{\Delta}{\fst \sigma}]}_{\snd \sigma}}}{\snd \sigma}}}}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, \upstairs{a})}{\sigma}{\rewrite{\var{\snd \sigma}}{\StI{\ApEl{p}{\pi^{\modeof{\Delta}[\unp{\Delta}{\fst \sigma}]}_{\snd \sigma}}}{\snd \sigma}}}}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\rewrite{\var{\snd \sigma}}{\StI{\ApEl{p}{\pi^{\fst \sigma}_{\snd \sigma}}}{\snd \sigma}}[(\upstairs{\Theta}, \upstairs{a})/\sigma]}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\rewrite{\var{\One_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{a}}}}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\rewrite{\ApPlus{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\var{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{a}}}}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}};\ApPlus{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\var{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}};\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{a}}} \\
&\equiv \upstairs{a}
\end{align*}
Where we have used that
\begin{align*}
\ApOne{\eta^\sdot_\alpha};\ApPlus{\ApEl{p}{\eta^\sdot_\alpha}}{\var{\One_\alpha}} \equiv \id_{\One_\alpha}
\end{align*}
by the triangle identity for $\sdot$, Equation~\eqref{eq:chi-triangle-2}

\item[{$(\proj{\Gamma,A}, \qvar{\Gamma,A}) \equiv \id_{\Gamma, A}$}] 
\begin{align*}
\upstairs{(\proj{\Gamma,A}, \qvar{\Gamma,A})}
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, A)}}}{\EIs{\sdot}{\upstairs{\proj{\Gamma,A}}, \upstairs{\qvar{\Gamma,A}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, A)}}}{\EIs{\sdot}{\rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_\Gamma}}, \rewrite{\var{x}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{x}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, A)}}}{\EIs{\sdot}{\rewrite{(\pi^{\modeof{\Gamma}}_x, \var{x})}{(\upstairs{\id_\Gamma}, x)}}}\\
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, A)}}}{\rewrite{\ApPlus{\sdot}{(\pi^{\modeof{\Gamma}}_x, \var{x})}}{\EIs{\sdot}{\upstairs{\id_\Gamma}, x}}}\\
&\equiv \EIs{\sdot}{\upstairs{\id_\Gamma}, x} \\
&\equiv \EIs{\sdot}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\downstairs{\Gamma}}}, x}\\
&\equiv \EIs{\sdot(\fst w, \snd w)[(\modeof{\Gamma}, x)/w]}{\pack{\downstairs{\Gamma}}, x} \\
&\equiv \EIs{\sigma.\modeof{(\Gamma, A)}[\unp{\Gamma, A}{\sigma}]}{\pack{\downstairs{\Gamma, A}}} \\
&\equiv \upstairs{\id_{\Gamma, A}}
\end{align*}

\item[$\Theta \equiv \epsilon_\Gamma$] 
Using eta expansion for $\E{\emptyset}{}$ once in each direction:
\begin{align*}
\upstairs{\Theta}
&\equiv \EEs{\modeof{(\cdot)}}{\upstairs{\Theta}}{x}{\EIs{\modeof{(\cdot)}}{x}} \\
&\equiv \EEs{\emptyset}{\upstairs{\Theta}}{x}{\rewrite{\eta^\sempty_{\emptyset}}{\EIs{\emptyset}{}}} \\
&\equiv \rewrite{\eta^\sempty_{\modeof{\Gamma}}}{\EIs{\emptyset}{}} \\
&\equiv \upstairs{\epsilon_\Gamma}
\end{align*}
\end{enumerate}

The above translation satisfies the following, which will be used when
adding types:

\begin{lemma}
\begin{align*}
\upstairs{B[\proj{\Gamma, A}]} &\equiv \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{B}} \\
\upstairs{b[\proj{\Gamma, A}]} &\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{b}}} \\
\upstairs{\proj{\Gamma, A, B};\proj{\Gamma, A}} &\equiv \rewrite{\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_{\Gamma}}}
\end{align*}
\end{lemma}
\begin{proof}
The first was shown in the translation of $\qvar{}$. The second is similar:
\begin{align*}
\upstairs{b[\proj{\Gamma, A}]}
&\equiv \EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\upstairs{\proj{\Gamma, A}}}{\sigma}{\upstairs{b}[\unp{\Gamma}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_\Gamma}}}{\sigma}{\upstairs{b}[\unp{\Gamma}{\sigma}]} \\
&\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\upstairs{\id_\Gamma}}{\sigma}{\upstairs{b}[\unp{\Gamma}{\sigma}]}}} \\
&\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\downstairs{\Gamma}}}}{\sigma}{\upstairs{b}[\unp{\Gamma}{\sigma}]}}} \\
&\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{b}[\unp{\Gamma}{\sigma}][\pack{\downstairs{\Gamma}}/\sigma]}} \\
&\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{b}}}
\end{align*}
And the third:
\begin{align*}
\upstairs{\proj{\Gamma, A, B};\proj{\Gamma, A}} 
&\equiv \EEs{\sigma.\modeof{(\Gamma, A)}[\unp{\Gamma, A}{\sigma}]}{\upstairs{\proj{\Gamma, A, B}}}{\sigma}{\upstairs{\proj{\Gamma, A}}[\unp{\upstairs{\Gamma, A}}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{(\Gamma, A)}[\unp{\Gamma, A}{\sigma}]}{\rewrite{\pi^{\modeof{\Gamma}.x}_y}{\upstairs{\id_{\Gamma, A}}}}{\sigma}{\upstairs{\proj{\Gamma, A}}[\unp{\upstairs{\Gamma, A}}{\sigma}]} \\
&\equiv \rewrite{\pi^{\modeof{\Gamma}.x}_y}{\EEs{\sigma.\modeof{(\Gamma, A)}[\unp{\Gamma, A}{\sigma}]}{\upstairs{\id_{\Gamma, A}}}{\sigma}{\upstairs{\proj{\Gamma, A}}[\unp{\upstairs{\Gamma, A}}{\sigma}]}} \\
&\equiv \rewrite{\pi^{\modeof{\Gamma}.x}_y}{\upstairs{\id_{\Gamma, A};\proj{\Gamma, A}}} \\
&\equiv \rewrite{\pi^{\modeof{\Gamma}.x}_y}{\upstairs{\proj{\Gamma, A}}} \\
&\equiv \rewrite{\pi^{\modeof{\Gamma}.x}_y}{\rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_\Gamma}}} \\
&\equiv \rewrite{\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_\Gamma}}
\end{align*}
\end{proof}

\begin{lemma}
There is a derived operation
\begin{mathpar}
\inferrule*[left=derivable]{\Gamma \qyields \Theta : \Delta \and \Delta \qyields A \TYPE}{\Gamma, A[\Theta] \qyields \Theta \uparrow A : \Delta, A}
\end{mathpar}
defined by:
\begin{align*}
\Theta \uparrow A &:\equiv (\proj{\Gamma, A[\Theta]}; \Theta) , \qvar{\Gamma, A[\Theta]}
\end{align*}
such that
\begin{align*}
(\Theta \uparrow A) ; \proj{\Delta, A} &\equiv \proj{\Gamma, A[\Theta]} ; \Theta \\
\qvar{\Delta, A}[\Theta \uparrow A] &\equiv \qvar{\Gamma, A[\Theta]} \\
(\Theta, a);(\kappa \uparrow A) &\equiv (\Theta;\kappa), a \\
\intertext{and in the translation,}
\upstairs{\Theta \uparrow A} &\equiv \EIs{\sdot}{\upstairs{\Theta}, x} \\
\EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\upstairs{\Theta \uparrow A}}{\sigma}{M[\unp{\Delta, A}{\sigma}]} &\equiv \EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma}{M[\unp{\Delta}{\sigma}, x/x]}
\end{align*}
\end{lemma}
\begin{proof}
\mvrnote{first two}
\begin{align*}
&(\Theta, a);(\kappa \uparrow A) \\
&\equiv (\Theta,a);((\proj{\Delta, A[\kappa]}; \kappa) , \qvar{\Delta, A[\kappa]}) \\
&\equiv ((\Theta, a);\proj{\Delta, A[\kappa]}; \kappa) , \qvar{\Delta, A[\kappa]}[\Theta,a] \\
&\equiv (\Theta;\kappa) , a
\end{align*}
\begin{align*}
\upstairs{\Theta \uparrow A} 
&\equiv \upstairs{(\proj{\Gamma, A[\Theta]}; \Theta) , \qvar{\Gamma, A[\Theta]}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, x : A[\Theta])}}}{\EIs{\sdot}{\upstairs{(\proj{\Gamma, A[\Theta]}; \Theta)}, \upstairs{\qvar{\Gamma,A[\Theta]}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, x : A[\Theta])}}}{\EIs{\sdot}{\EEs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\upstairs{\proj{\Gamma, A[\Theta]}}}{\sigma}{\upstairs{\Theta}[\unp{\upstairs{\Gamma}}{\sigma}]}, \upstairs{\qvar{\Gamma,A[\Theta]}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, x : A[\Theta])}}}{\EIs{\sdot}{\rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\Theta}[\unp{\upstairs{\Gamma}}{\sigma}][\pack{\Gamma}/\sigma]}, \upstairs{\qvar{\Gamma,A[\Theta]}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, x : A[\Theta])}}}{\EIs{\sdot}{\rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\Theta}}, \upstairs{\qvar{\Gamma,A[\Theta]}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{(\Gamma, x : A[\Theta])}}}{\EIs{\sdot}{\rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\Theta}},  \rewrite{\var{x}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{x}}}} \\
&\equiv \StI{\sdot}{\upstairs{\Theta}, x}
\end{align*}
And:
\begin{align*}
&\EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\upstairs{\Theta \uparrow A}}{\sigma}{M[\unp{\Delta, A}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\EIs{\sdot}{\upstairs{\Theta}, x}}{\sigma}{M[\unp{\Delta, A}{\sigma}]} \\
&\equiv \EEs{\sdot}{\EIs{\sdot}{\upstairs{\Theta}, x}}{\sigma'}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{\sigma'}{\sigma}{M[\unp{\Delta, A}{\sigma}]}} \\
&\equiv \EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma}{M[\unp{\Delta, A}{\sigma}]} \\
&\equiv \EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma, x}{M[\unp{\Delta, A}{(\sigma, x)}]} \\
&\equiv \EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma, x}{M[\unp{\Delta}{\sigma}, x/x]}
\end{align*}
\end{proof}

\subsubsection{Unit type}
Next, we extend the translation to include unit types, encoding the
rules from Figure~\ref{fig:qit-unit-rules}, which give a positive unit
type.  

\begin{figure}
\begin{mathpar}
\inferrule*[left=1-form]{~}{\Gamma \qyields 1_\Gamma \TYPE} \and
\inferrule*[left=1-intro]{~}{\Gamma \qyields \star_\Gamma : 1_\Gamma} \and
\inferrule*[left=1-elim]{\Gamma \qyields c : C[\id_\Gamma, \star_\Gamma]}{\Gamma, 1_\Gamma \qyields \qunitmatch{c} : C}
\end{mathpar}
\begin{align}
1_\Delta[\Theta] &\equiv 1_\Gamma \\
\star_\Delta[\Theta] &\equiv \star_\Gamma \\ 
\qunitmatch{c}[\Theta \uparrow 1_\Gamma] &\equiv \qunitmatch{c[\Theta]} \\
\nonumber \\
\qunitmatch{c}[\id_\Gamma, \star_\Gamma] &\equiv c
\end{align}
\caption{Rules for the unit type}\label{fig:qit-unit-rules}
\end{figure}

\begin{theorem}
The rules for the unit type can be interpreted over any mode theory
containing a comprehension object $p$ that has unit (Definition \ref{def:supports-unit}), if
the strict modalities for composites of $\sdot$ and $\sempty$ exist, and
the $\mathsf{F}$-type for $\One_\alpha$ exists.
\end{theorem}

Translating the rules:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[\textsc{1-form}] For any $\upstairs{\Gamma}$ we can form
\begin{align*}
\upstairs{\Gamma} \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{1_\Gamma} :\equiv \F{\One_{\modeof{\Gamma}}}{1} \TYPE
\end{align*}

\item[\textsc{1-intro}] We have
\begin{align*}
\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \upstairs{\star_\Gamma} :\equiv \FIs{\One_{\modeof{\Gamma}}}{} : \upstairs{1_\Gamma}
\end{align*}

\item[\textsc{1-elim}] We are given
\begin{align*}
\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \upstairs{c} : \upstairs{C[\id_\Gamma, \star_\Gamma]} 
\end{align*}
The type of $\upstairs{c}$ can be simplified to:
\begin{align*}
\upstairs{C[\id_\Gamma, \star_\Gamma]} 
&\equiv \EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\upstairs{\id_\Gamma, \star_\Gamma}}{\sigma}{\upstairs{C}[\unp{\Gamma, 1_\Gamma}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EIs{\sdot}{\upstairs{\id_\Gamma}, \upstairs{\star_\Gamma}}}}{\sigma}{\upstairs{C}[\unp{\Gamma, 1_\Gamma}{\sigma}]} \\
&\equiv \St{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\EIs{\sdot}{\upstairs{\id_\Gamma}, \upstairs{\star_\Gamma}}}{\sigma}{\upstairs{C}[\unp{\Gamma, 1_\Gamma}{\sigma}]}} \\
&\equiv \St{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\EIs{\sdot}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\Gamma}}, \upstairs{\star_\Gamma}}}{\sigma}{\upstairs{C}[\unp{\Gamma, 1_\Gamma}{\sigma}]}} \\
&\equiv \St{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\EIs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\pack{\Gamma}, \upstairs{\star_\Gamma}}}{\sigma}{\upstairs{C}[\unp{\Gamma, 1_\Gamma}{\sigma}]}} \\
&\equiv \St{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\upstairs{C}[\unp{\Gamma, 1_\Gamma}{\sigma}][\pack{\Gamma}/\sigma, \upstairs{\star_\Gamma}/x]} \\
&\equiv \St{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\upstairs{C}[\upstairs{\star_\Gamma}/x]} \\
&\equiv \St{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\upstairs{C}[\FIs{\One_{\modeof{\Gamma}}}{}/x]}
\end{align*}
So as our translation use:
\begin{mathpar}
\inferrule*[Left=F-elim]{
\inferrule*[Left=rewrite]{
\inferrule*[Left=s-intro]{
\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \upstairs{c} : \St{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\upstairs{C}[\FIs{\One_{\modeof{\Gamma}}}{}/x]}}
{\upstairs{\Gamma} \yields_{\TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\One_{\modeof{\Gamma}}}} \StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{c}} : \upstairs{C}[\FIs{\One_{\modeof{\Gamma}}}{}/x]}}
{\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}.\One_{\modeof{\Gamma}}}} \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{c}}} : \upstairs{C}[\FIs{\One_{\modeof{\Gamma}}}{}/x]}}
{\upstairs{\Gamma}, z : \upstairs{1_\Gamma} \yields_{\One_{\modeof{\Gamma}}} \FE{z}{}{\rewrite{\ApOne{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{c}}}} : \upstairs{C}}
\end{mathpar}
\end{enumerate}

Checking the equations:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$1_\Delta[\Theta] \equiv 1_\Gamma$}:] 
\begin{align*}
&\upstairs{1_\Delta[\Theta]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\F{\One_{\modeof{\Delta}}}{1} [\unp{\Delta}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\F{\One_{\modeof{\Delta}[\unp{\Delta}{\sigma}]}}{1}} \\
&\equiv \F{\One_{\modeof{\Gamma}}}{1} \\
&\equiv \upstairs{1_\Gamma}
\end{align*}

\item[{$\star_\Delta[\Theta] \equiv \star_\Gamma $}:]
\begin{align*}
&\upstairs{\star_\Delta[\Theta]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\FIs{\One_{\modeof{\Delta}}}{}[\unp{\Delta}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\FIs{\One_{\modeof{\Delta}[\unp{\Delta}{\sigma}]}}{}} \\
&\equiv \FIs{\One_{\modeof{\Gamma}}}{} \\
&\equiv \upstairs{\star_\Gamma}
\end{align*}

\item[{$\qunitmatch{c}[\Theta \uparrow 1_\Delta] \equiv \qunitmatch{c[\Theta]}$}:]
\begin{align*}
&\upstairs{\qunitmatch{c}[\Theta \uparrow 1_\Delta]} \\
&\equiv \EEs{\sigma. \modeof{(\Delta, 1_\Delta)}[\unp{\Delta, 1_\Delta}{\sigma}]}{\upstairs{\Theta \uparrow 1_\Delta}}{\sigma}{(\FE{z}{}{\rewrite{\ApOne{\pi^{\modeof{\Delta}}_{\One_{\modeof{\Delta}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Delta}}_{\One_{\modeof{\Delta}}}}}{\upstairs{c}}}})[\unp{\Delta, 1_\Delta}{\sigma}]} \\
&\equiv \EEs{(\sigma,z).(\modeof{\Delta}[\unp{\Delta}{\sigma}], z)}{(\upstairs{\Theta},z)}{\sigma}{(\FE{z}{}{\rewrite{\ApOne{\pi^{\modeof{\Delta}}_{\One_{\modeof{\Delta}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Delta}}_{\One_{\modeof{\Delta}}}}}{\upstairs{c}}}})[\unp{\Delta, 1_\Delta}{\sigma},z/z]} \\
&\equiv \EEs{(\sigma,z).(\modeof{\Delta}[\unp{\Delta}{\sigma}], z)}{(\upstairs{\Theta},z)}{\sigma}{(\FE{z}{}{\rewrite{\ApOne{\pi^{\modeof{\Delta}[\unp{\Delta}{\sigma}]}_{\One_{\modeof{\Delta}[\unp{\Delta}{\sigma}]}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Delta}[\unp{\Delta}{\sigma}]}_{\One_{\modeof{\Delta}[\unp{\Delta}{\sigma}]}}}}{\EEs{\sigma. \modeof{\Delta}[\unp{\Delta}{\sigma}]}{\EIs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\sigma}}{\sigma}{\upstairs{c}[\unp{\Delta}{\sigma}]}}}})} \\
&\equiv \FE{z}{}{\rewrite{\ApOne{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\EEs{\sigma. \modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{c}[\unp{\Delta}{\sigma}]}}}} \\
&\equiv \FE{z}{}{\rewrite{\ApOne{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{c[\Theta]}}}} \\
&\equiv \upstairs{\qunitmatch{c[\Theta]}}
\end{align*}

\item[{$\qunitmatch{c}[\id_\Gamma, \star_\Gamma] \equiv c$}:] 
\begin{align*}
&\upstairs{\qunitmatch{c}[\id_\Gamma, \star_\Gamma]} \\
&\equiv \EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\upstairs{\id_\Gamma, \star_\Gamma}}{\sigma}{\upstairs{\qunitmatch{c}}[\unp{\Gamma, 1_\Gamma}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EIs{\sdot}{\upstairs{\id_\Gamma}, \upstairs{\star_\Gamma}}}}{\sigma}{\upstairs{\qunitmatch{c}}[\unp{\Gamma, 1_\Gamma}{\sigma}]} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\EIs{\sdot}{\upstairs{\id_\Gamma}, \upstairs{\star_\Gamma}}}{\sigma}{\upstairs{\qunitmatch{c}}[\unp{\Gamma, 1_\Gamma}{\sigma}]}}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\EEs{\sigma.\modeof{(\Gamma, 1_\Gamma)}[\unp{\Gamma, 1_\Gamma}{\sigma}]}{\EIs{\sdot}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\Gamma}}, \upstairs{\star_\Gamma}}}{\sigma}{\upstairs{\qunitmatch{c}}[\unp{\Gamma, 1_\Gamma}{\sigma}]}}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\upstairs{\qunitmatch{c}}[\unp{\Gamma, 1_\Gamma}{\sigma}][\pack{\Gamma}, \upstairs{\star_\Gamma}/z]}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\upstairs{\qunitmatch{c}}[\upstairs{\star_\Gamma}/z]}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\FE{z}{}{\rewrite{\ApOne{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{c}}}}[\FIs{\One_{\modeof{\Gamma}}}{}/z]}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\FE{\FIs{\One_{\modeof{\Gamma}}}{}}{}{\rewrite{\ApOne{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{c}}}}}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}}}}{\rewrite{\ApOne{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{c}}}}} \\
&\equiv \rewrite{\ApOne{\eta^\sdot_{\modeof{\Gamma}};\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\StI{\ApEl{p}{\eta^\sdot_{\modeof{\Gamma}};\pi^{\modeof{\Gamma}}_{\One_{\modeof{\Gamma}}}}}{\upstairs{c}}} \\
&\equiv \upstairs{c}
\end{align*}
\end{enumerate}

\subsubsection{$\Sigma$-types}

Next, we extend the translation to include $\Sigma$-types, again as a
positive type, with the rules in Figure~\ref{fig:qit-sigma-rules}. 

% There are two versions of the eliminator; a weak and strong version. The choice of one or the other yields \emph{weak} $\Sigma$-types or \emph{strong} $\Sigma$-types.

\begin{figure}
\begin{mathpar}
\inferrule*[left=$\Sigma$-form]{\Gamma \qyields A \TYPE \and \Gamma, A \qyields B \TYPE}{\Gamma \qyields \Sigma_A B \TYPE} \\
\inferrule*[left=$\Sigma$-pair]{~}{\Gamma, A, B \qyields \qpair{A, B} : (\Sigma_A B)[\proj{\Gamma, A, B};\proj{\Gamma, A}]} \and
\inferrule*[left=$\Sigma$-split]{\Gamma, A, B \qyields c : C[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}]}{\Gamma, \Sigma_A B \qyields \qsplit{A, B}(c) : C}
%\inferrule*[left=$\Sigma$-pair]{\Gamma \qyields a : A \and \Gamma \qyields b : B[\hat{a}]}{\Gamma \qyields (a, b) : \Sigma_A B} \and
%\inferrule*[left=$\Sigma$-$\pi_1$]{\Gamma \qyields p : \Sigma_A B}{\Gamma \qyields \pi_1(p) : A} \and
%\inferrule*[left=$\Sigma$-$\pi_2$]{\Gamma \qyields p : \Sigma_A B}{\Gamma \qyields \pi_2(p) : B[\widehat{\pi_1(p)}]} \and
\end{mathpar}
\begin{align}
(\Sigma_A B)[\Theta] &\equiv \Sigma_{A[\Theta]} B[\Theta \uparrow A] \\
\qpair{A, B}[\Theta \uparrow A \uparrow B] &\equiv \qpair{A[\Theta], B[\Theta \uparrow A]} \\
\qsplit{A,B}(c)[\Theta \uparrow \Sigma_A B] &\equiv \qsplit{A[\Theta],B[\Theta \uparrow A]}(c[\Theta \uparrow A \uparrow B])  \\
\nonumber \\
\qsplit{A,B}(c)[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}] &\equiv c
%\intertext{(If framework $\mathsf{F}$-types have eta:)}
%\qsplit{A,B}(\qpair{A,B}) &\equiv \qvar{\Gamma, \Sigma_A B}
\end{align}
%\mvrnote{that eta is not general enough}
%\vspace{1cm}
%\begin{mathpar}
%\inferrule*[left=$\Sigma$-split-weak]{\Gamma, A, B \qyields c : C[\proj{\Gamma, A, B};\proj{\Gamma, A}]}{\Gamma, \Sigma_A B \qyields \mathsf{wsplit}_{A, B}(c) : C[\proj{\Gamma, \Sigma_A B}]}
%\end{mathpar}
%\begin{align}
%\mathsf{wsplit}_{A,B}(\qpair{A,B}) &\equiv \qvar{\Gamma, \Sigma_A B} \\
%\mathsf{wsplit}_{A,B}(c)[\Theta \uparrow \Sigma_A B] &\equiv \mathsf{wsplit}_{A[\Theta],B[\Theta \uparrow A]}(c[\Theta \uparrow A \uparrow B]) \\
%\end{align}
%\begin{align}
%%\pi_1(a, b) &\equiv a \\
%%\pi_2(a, b) &\equiv b \\
%%(\pi_1(p), \pi_2(p)) &\equiv p \\
%%(a, b)[\Theta] &\equiv (a[\Theta], b[\Theta])
%\end{align}
\caption{Rules for $\Sigma$-types}\label{fig:qit-sigma-rules}
\end{figure}

\begin{theorem}
The rules for $\Sigma$-types can be interpreted over any mode theory
containing a comprehension object that supports strong $\Sigma$-types
(Definition \ref{def:supports-sigmas}),
if
the strict modalities for composites of $\sdot$ and $\sempty$ exist, and
for all $\alpha : p$,
the $\mathsf{F}$-type for $z : \sigmacl{x}{\El p \alpha}{\El p
  {\alpha.x}} \vdash \Sigma_1(\alpha,\fst z, \snd z)$ exists.
\end{theorem}

Suppose the comprehension object supports $\Sigma$ types. In the framework, $\Sigma$-types are the $\mathsf{F}$-types for the mode term
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, y : \El{p}{\alpha.x} \yields \Sigma_1(x,y) : \El{p}{\alpha}
\end{align*}
with $\alpha$ in the context and $x$ and $y$ tupled together, i.e. for
$z : \sigmacl{x}{\El p \alpha}{\El p
  {\alpha.x}} \vdash \Sigma_1(\alpha,\fst z, \snd z)$.  

We now translate all the rules:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[\textsc{$\Sigma$-form}] 
We are given
\begin{align*}
\upstairs{\Gamma} &\yields_{\El{p}{\modeof{\Gamma}}} \upstairs{A} \TYPE \\
\upstairs{\Gamma}, x : \upstairs{A} &\yields_{\El{p}{\modeof{\Gamma}.x}} \upstairs{B} \TYPE
\end{align*}
which are of the right shape to form
\begin{align*}
\upstairs{\Gamma} \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{\Sigma_A B} :\equiv \F{w. \Sigma_1(\alpha,\fst w, \snd w)}{x : \upstairs{A}, \upstairs{B}} \TYPE
\end{align*}

\item[\textsc{$\Sigma$-pair}] Our goal is a term:
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \equiv_{\One_{\modeof{\Gamma}.x.y}} \upstairs{\qpair{A,B}} : \St{\ApEl{p}{\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x}}{\upstairs{\Sigma_A B}}
\end{align*}
and we can get this by
\begin{mathpar}
\inferrule*[Left=rewrite]{
\inferrule*[Left=s-intro]{
\inferrule*[Left=F-intro]{~}{
\alpha : \upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\Sigma(x,y)} \FIs{w. \Sigma_1(\fst w, \snd w)}{x,y} : \upstairs{\Sigma_A B}}}
{\alpha : \upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x}}{\Sigma(x,y)}} \StI{\ApEl{p}{\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x}}{\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}} : \upstairs{\Sigma_A B[\proj{\Gamma, A, B};\proj{\Gamma, A}]}}}
{\alpha : \upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\One_{\modeof{\Gamma}.x.y}} \rewrite{\fibpair{x,y}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x}}{\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}} : \upstairs{\Sigma_A B[\proj{\Gamma, A, B};\proj{\Gamma, A}]}}
\end{mathpar}

\item[\textsc{$\Sigma$-split}] 
First, the substitution $(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}$ is translated to:
\begin{align*}
&\upstairs{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}.x.y}}{\EIs{\sdot}{\upstairs{\proj{\Gamma, A, B};\proj{\Gamma, A}}, \upstairs{\qpair{A,B}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}.x.y}}{\EIs{\sdot}{\rewrite{\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_\Gamma}}, \rewrite{\fibpair{x,y}}{\StI{(\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x)}{\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}}} \\
&\equiv \rewrite{\eta^\sdot_{\modeof{\Gamma}.x.y};(\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x,\fibpair{x,y})}{\EIs{\sdot}{\upstairs{\id_\Gamma},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}} \\
&\equiv \rewrite{\pair{x,y}}{\EIs{\sdot}{\upstairs{\id_\Gamma},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}
\end{align*}
So the type $C[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}]$ becomes:
\begin{align*}
&\upstairs{C[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}]} \\
&\equiv \EEs{\sigma.\modeof{(\Gamma, \Sigma_A B)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}{\upstairs{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}}}{\sigma}{\upstairs{C}[\unp{\Gamma, \Sigma_A B}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{(\Gamma, \Sigma_A B)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}{\rewrite{\pair{x,y}}{\EIs{\sdot}{\upstairs{\id_\Gamma},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}}{\sigma}{\upstairs{C}[\unp{(\Gamma, \Sigma_A B)}{\sigma}]} \\
&\equiv \St{\ApEl{p}{\pair{x,y}}}{\EEs{\sigma.\modeof{(\Gamma, \Sigma_A B)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}{\EIs{\sdot}{\upstairs{\id_\Gamma},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}{\sigma}{\upstairs{C}[\unp{\Gamma, \Sigma_A B}{\sigma}]}} \\
&\equiv \St{\ApEl{p}{\pair{x,y}}}{\EEs{\sigma.\modeof{(\Gamma, \Sigma_A B)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}{\EIs{\sdot}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\downstairs{\Gamma}}},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}{\sigma}{\upstairs{C}[\unp{\Gamma, \Sigma_A B}{\sigma}]}} \\
&\equiv \St{\ApEl{p}{\pair{x,y}}}{\upstairs{C}[\unp{\Gamma, \Sigma_A B}{\sigma}][(\pack{\upstairs{\Gamma}},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y})/\sigma]} \\
&\equiv \St{\ApEl{p}{\pair{x,y}}}{\upstairs{C}[\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}/z]}
\end{align*}
So as the translation use:
\begin{mathpar}
\inferrule*[Left=F-elim]{
\inferrule*[Left=rewrite]{
\inferrule*[Left=s-intro]{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\One_{\modeof{\Gamma}.x.y}} \upstairs{c} : \St{\ApEl{p}{\pair{x,y}}}{\upstairs{C}[\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}/z]}}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\TrPlus{\ApEl{p}{\tsplit{x,y}}}{\One_{\modeof{\Gamma}.x.y}}} \StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}} : \upstairs{C}[\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}/z]}}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\One_{\modeof{\Gamma}.\Sigma_1(x,y)}} \rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}}} : \upstairs{C}[\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}/z]}}
{\upstairs{\Gamma}, z : \upstairs{\Sigma_A B} \yields_{\One_{\modeof{\Gamma}.z}} \FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}}}} : \upstairs{C}}
\end{mathpar}
\end{enumerate}

Now the equations:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$(\Sigma_A B)[\Theta] \equiv \Sigma_{A[\Theta]} B[\Theta \uparrow A]$}:] 
\begin{align*}
&\upstairs{(\Sigma_A B)[\Theta]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\F{w. \Sigma_1(\modeof{\Delta},\fst w, \snd w)}{x : \upstairs{A}, \upstairs{B}}[\unp{\Delta}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\F{w. \Sigma_1(\modeof{\Delta}[\unp{\Delta}{\sigma}],\fst w, \snd w)}{x : \upstairs{A}[\unp{\Delta}{\sigma}], \upstairs{B}[\unp{\Delta}{\sigma}, x / x] }} \\
&\equiv \F{w. \Sigma_1(\modeof{\Gamma},\fst w, \snd w)}{x : \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}, \EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta},x)}{\sigma, x}{\upstairs{B}[\unp{\Delta}{\sigma}, x/x]} } \\
&\equiv \F{w. \Sigma_1(\modeof{\Gamma},\fst w, \snd w)}{x : \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}, \EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\EIs{\sdot}{\upstairs{\Theta},x}}{\sigma, x}{\upstairs{B}[\unp{\Delta, A}{\sigma}]} } \\
&\equiv \F{w. \Sigma_1(\modeof{\Gamma},\fst w, \snd w)}{x : \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}, \EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\upstairs{\Theta \uparrow A}}{\sigma, x}{\upstairs{B}[\unp{\Delta, A}{\sigma}]} } \\
&\equiv \F{w. \Sigma_1(\modeof{\Gamma},\fst w, \snd w)}{x : \upstairs{A[\Theta]}, \upstairs{B[\Theta \uparrow A]}} \\
&\equiv \upstairs{\Sigma_{A[\Theta]} B[\Theta \uparrow A]}
\end{align*}

\item[{$\qpair{A, B}[\Theta \uparrow A \uparrow B] \equiv \qpair{A[\Theta], B[\Theta \uparrow A]}$}:]
\begin{align*}
&\upstairs{\qpair{A, B}[\Theta \uparrow A \uparrow B]} \\
&\equiv \EEs{\sigma. \modeof{(\Delta, A, B)}[\unp{\Delta, A, B}{\sigma}]}{\upstairs{\Theta \uparrow A \uparrow B}}{\sigma}{\upstairs{\qpair{A, B}}[\unp{\Delta, A, B}{\sigma}]} \\
&\equiv \EEs{\sigma. \modeof{(\Delta, A, B)}[\unp{\Delta, A, B}{\sigma}]}{\EIs{\sdot}{\EIs{\sdot}{\upstairs{\Theta}, x}, y}}{\sigma}{\upstairs{\qpair{A, B}}[\unp{\Delta, A, B}{\sigma}]} \\
&\equiv \EEs{(\sigma, x, y).(\modeof{\Delta}[\unp{\Delta}{\sigma}], x, y)}{(\upstairs{\Theta},x,y)}{\sigma,x,y}{\upstairs{\qpair{A, B}}[\unp{\Delta}{\sigma}, x/x, y/y]} \\
&\equiv \EEs{(\sigma, x, y).(\modeof{\Delta}[\unp{\Delta}{\sigma}], x, y)}{(\upstairs{\Theta},x,y)}{\sigma,x,y}{\rewrite{\fibpair{x,y}}{\StI{\ApEl{p}{\pi^{\modeof{\Delta}.x}_y;\pi^{\modeof{\Delta}}_x}}{\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}[\unp{\Delta}{\sigma}, x/x, y/y]} \\
&\equiv \EEs{(\sigma, x, y).(\modeof{\Delta}[\unp{\Delta}{\sigma}], x, y)}{(\upstairs{\Theta},x,y)}{\sigma,x,y}{\rewrite{\fibpair{x,y}}{\StI{\ApEl{p}{\pi^{\modeof{\Delta}[\unp{\Delta}{\sigma}].x}_y;\pi^{\modeof{\Delta}[\unp{\Delta}{\sigma}]}_x}}{\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}} \\
&\equiv \rewrite{\fibpair{x,y}}{\StI{(\pi^{\modeof{\Gamma}.x}_y;\pi^{\modeof{\Gamma}}_x)}{\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}} \\
&\equiv \upstairs{\qpair{A, B}[\Theta \uparrow A \uparrow B]}
\end{align*}

\item[{$\qsplit{A,B}(c)[\Theta \uparrow \Sigma_A B] \equiv \qsplit{A[\Theta],B[\Theta \uparrow A]}(c[\Theta \uparrow A \uparrow B])$}:]
\begin{align*}
&\upstairs{\qsplit{A,B}(c)[\Theta \uparrow \Sigma_A B]} \\
&\equiv \EEs{\sigma. \modeof{(\Delta, \Sigma_A B)}[\unp{\Delta, \Sigma_A B}{\sigma}]}{\upstairs{\Theta \uparrow \Sigma_A B}}{\sigma}{(\FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}}}})[\unp{\Delta, \Sigma_A B}{\sigma}]} \\
&\equiv \EEs{(\sigma, z).(\modeof{\Delta}[\unp{\delta}{\sigma}], z)}{(\upstairs{\Theta}, z)}{\sigma, z}{(\FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}}}})[\unp{\Delta}{\sigma}, z/z]} \\
&\equiv \EEs{(\sigma, z).(\modeof{\Delta}[\unp{\delta}{\sigma}], z)}{(\upstairs{\Theta}, z)}{\sigma, z}{\FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}[\unp{\Delta}{\sigma}, x/x, y/y]}}}} \\
&\equiv \EEs{(\sigma, z).(\modeof{\Delta}[\unp{\delta}{\sigma}], z)}{(\upstairs{\Theta}, z)}{\sigma, z}{\FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\\&\qquad \EEs{(\sigma, x, y). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x, y)}{(\EIs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\sigma},x, y)}{\sigma,x,y}{\upstairs{c}[\unp{\Delta}{\sigma}, x/x, y/y]}}}}} \\
&\equiv \FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\EEs{(\sigma, x, y). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x, y)}{(\upstairs{\Theta}, x, y)}{\sigma,x,y}{\upstairs{c}[\unp{\Delta}{\sigma}, x/x, y/y]}}}} \\
&\equiv \FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\EEs{\sigma.\modeof{(\Delta, A, B)}[\unp{\Delta, A, B}{\sigma}]}{\upstairs{\Theta \uparrow A \uparrow B}}{\sigma}{\upstairs{c}[\unp{\Delta, A, B}{\sigma}]}}}} \\
&\equiv \FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c[\Theta \uparrow A \uparrow B]}}}} \\
&\equiv \upstairs{\qsplit{A[\Theta],B[\Theta \uparrow A]}(c[\Theta \uparrow A \uparrow B])}
\end{align*}

\item[{$\qsplit{A,B}(c)\allowbreak[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \allowbreak\qpair{A,B}] \equiv c$}:] 
We have already calculated the translation of the substitution, when translating $\qsplit{}$.
\begin{align*}
&\upstairs{\qsplit{A,B}(c)[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}]} \\
&\equiv \EEs{\sigma.\modeof{(\Gamma, \Sigma_A B)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}{\upstairs{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}}}{\sigma}{\upstairs{\qsplit{A,B}(c)}[\unp{\Gamma, \Sigma_A B}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{(\Gamma, \Sigma_A B)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}{\rewrite{\pair{x,y}}{\EIs{\sdot}{\upstairs{\id_\Gamma},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}}{\sigma}{\upstairs{\qsplit{A,B}(c)}[\unp{\Gamma, \Sigma_A B}{\sigma}]} \\
&\equiv \rewrite{\ApOne{\pair{x,y}}}{\StI{\ApEl{p}{\pair{x,y}}}{\EEs{\sigma.\modeof{(\Gamma, \Sigma_A B)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}{\EIs{\sdot}{\upstairs{\id_\Gamma},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}{\sigma}{\upstairs{\qsplit{A,B}(c)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}}} \\
&\equiv \rewrite{\ApOne{\pair{x,y}}}{\StI{\ApEl{p}{\pair{x,y}}}{\EEs{\sigma.\modeof{(\Gamma, \Sigma_A B)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}{\EIs{\sdot}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\Gamma}},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}}{\sigma}{\upstairs{\qsplit{A,B}(c)}[\unp{\Gamma, \Sigma_A B}{\sigma}]}}} \\
&\equiv \rewrite{\ApOne{\pair{x,y}}}{\StI{\ApEl{p}{\pair{x,y}}}{\upstairs{\qsplit{A,B}(c)}[\unp{\Gamma, \Sigma_A B}{\sigma}][(\pack{\Gamma},\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y})/\sigma]}} \\
&\equiv \rewrite{\ApOne{\pair{x,y}}}{\StI{\ApEl{p}{\pair{x,y}}}{\upstairs{\qsplit{A,B}(c)}[\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}/z]}} \\
&\equiv \rewrite{\ApOne{\pair{x,y}}}{\StI{\ApEl{p}{\pair{x,y}}}{\FE{z}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}}}}[\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}/z]}} \\
&\equiv \rewrite{\ApOne{\pair{x,y}}}{\StI{\ApEl{p}{\pair{x,y}}}{\FE{\FIs{w. \Sigma_1(\fst w, \snd w)}{x,y}}{x,y}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}}}}}} \\
&\equiv \rewrite{\ApOne{\pair{x,y}}}{\StI{\ApEl{p}{\pair{x,y}}}{\rewrite{\ApOne{\tsplit{x,y}}}{\StI{\ApEl{p}{\tsplit{x,y}}}{\upstairs{c}}}}} \\
&\equiv \rewrite{\ApOne{\pair{x,y};\tsplit{x,y}}}{\StI{\ApEl{p}{\pair{x,y};\tsplit{x,y}}}{\upstairs{c}}} \\
&\equiv \upstairs{c}
\end{align*}
\end{enumerate}

\subsubsection{$\Pi$-types}

The rules for $\Pi$ types are given in
Figure~\ref{fig:qit-pi-rules}. Note that stability of $\qapp{}$ under substitution is derivable from stability of $\qlam{}$ using the $\beta$ and $\eta$ rules:
\begin{align*}
\qapp{f}[\Theta \uparrow A]
&\equiv \qapp{\qlam{\qapp{f}[\Theta \uparrow A]}} \\
&\equiv \qapp{\qlam{\qapp{f}}[\Theta]} \\
&\equiv \qapp{f[\Theta]}
\end{align*}

\begin{figure}
\begin{mathpar}
\inferrule*[left=$\Pi$-form]{\Gamma \qyields A \TYPE \and \Gamma, A \qyields B \TYPE}{\Gamma \qyields \Pi_A B \TYPE} \\
\inferrule*[left=$\Pi$-intro]{\Gamma, A \qyields b : B}{\Gamma \qyields \qlam{b} : \Pi_A B} \and
\inferrule*[left=$\Pi$-elim]{\Gamma \qyields f : \Pi_A B}{\Gamma, A \qyields \qapp{f} : B}
\end{mathpar}
\begin{align}
(\Pi_A B)[\Theta] &\equiv \Pi_{A[\Theta]} B[\Theta \uparrow A] \\
\qlam{b}[\Theta] &\equiv \qlam{b[\Theta \uparrow A]} \\
\nonumber \\
\qapp{\qlam{b}} &\equiv b \\
\qlam{\qapp{f}} &\equiv f
\end{align}
\caption{Rules for $\Pi$-types}\label{fig:qit-pi-rules}
\end{figure}

For a comprehension object $p$, write
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, c : \El{p}{\alpha} \yields \Pi_1(\alpha,x,c) :\equiv \TrPlus{\ApEl{p}{\pi^\alpha_x}}{c} : \El{p}{\alpha.x}
\end{align*}

\begin{theorem}
The rules for $\Pi$-types can be interpreted over any mode theory with a
comprehension object that supports $\Pi$ types
(Definition~\ref{def:supports-pis}), if
the strict modalities for composites of $\sdot$ and $\sempty$ exist, and
for each $\alpha : p$, 
the $\mathsf{U}$-types for $x:\El{p} \alpha, c:\El{p}{\alpha} \vdash \Pi_1(\alpha,x,c)$ exist.
\end{theorem}

\begin{enumerate}
\item[\textsc{$\Pi$-form}] We are given
\begin{align*}
\upstairs{\Gamma} &\yields_{\El{p}{\modeof{\Gamma}}} \upstairs{A} \TYPE \\
\upstairs{\Gamma}, x : \upstairs{A} &\yields_{\El{p}{\modeof{\Gamma}.x}} \upstairs{B} \TYPE
\end{align*}
which are of the right shape to form
\begin{align*}
\upstairs{\Gamma} \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{\Pi_A B} :\equiv \U{c.\Pi_1(\modeof{\Gamma},x,c)}{x : \upstairs{A}}{\upstairs{B}} \TYPE
\end{align*}
\item[\textsc{$\Pi$-intro}] We are given a term
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A} &\yields_{\One_{\modeof{\Gamma}.x}} \upstairs{b} : \upstairs{B}
\end{align*}
So use
\begin{mathpar}
\inferrule*[Left=U-intro]{
\inferrule*[Left=rewrite]{
\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{\modeof{\Gamma}.x}} \upstairs{b} : \upstairs{B}}
{\upstairs{\Gamma}, x : \upstairs{A} \yields_{\TrPlus{\pi^{\modeof{\Gamma}}_x}{\One_{\modeof{\Gamma}}}} \rewrite{\pinv{x}}{\upstairs{b}} : \upstairs{B}}}
{\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \UI{x}{\rewrite{\pinv{x}}{\upstairs{b}}} : \upstairs{\Pi_A B}}
\end{mathpar}
\item[\textsc{$\Pi$-elim}] We are given
\begin{align*}
\upstairs{\Gamma} &\yields_{\One_{\modeof{\Gamma}}} \upstairs{f} : \upstairs{\Pi_A B}
\end{align*}
and want to produce
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A} &\yields_{\One_{\modeof{\Gamma}.x}} \upstairs{\qapp{A,B}(f)} : \upstairs{B}
\end{align*}
This is:
\begin{mathpar}
\inferrule*[Left=rewrite]{
\inferrule*[Left=U-elim]{
\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \upstairs{f} : \upstairs{\Pi_A B}}
{\upstairs{\Gamma}, x : \upstairs{A} \yields_{\TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\One_{\modeof{\Gamma}}}} \UE{\upstairs{f}}{x} : \upstairs{B}}}
{\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{\modeof{\Gamma}.x}} \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\UE{\upstairs{f}}{x}} : \upstairs{B}}
\end{mathpar}
\end{enumerate}

And the equations:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$(\Pi_A B)[\Theta] \equiv \Pi_{A[\Theta]} B[\Theta \uparrow A]$}:] Similar to the case for $\Sigma$:
\begin{align*}
&\upstairs{(\Pi_A B)[\Theta]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\U{c. \Pi_1(\modeof{\Delta},x,c)}{x : \upstairs{A}}{\upstairs{B}}[\unp{\Delta}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\U{c. \Pi_1(\modeof{\Delta}[\unp{\Delta}{\sigma}],x,c)}{x : \upstairs{A}[\unp{\Delta}{\sigma}]}{\upstairs{B}[\unp{\Delta}{\sigma}], x/x}} \\
&\equiv \U{c. \Pi_1(\modeof{\Gamma},x,c)}{x : \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma, x}{\upstairs{B}[\unp{\Delta}{\sigma}, x/x]}} \\
&\equiv \U{c. \Pi_1(\modeof{\Gamma},x,c)}{x : \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}}{\EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\StI{\sdot}{\upstairs{\Theta}, x}}{\sigma}{\upstairs{B}[\unp{\Delta, A}{\sigma}]}} \\
&\equiv \U{c. \Pi_1(\modeof{\Gamma},x,c)}{x : \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}}{\EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\upstairs{\Theta \uparrow A}}{\sigma}{\upstairs{B}[\unp{\Delta, A}{\sigma}]}} \\
&\equiv \U{c. \Pi_1(\modeof{\Gamma},x,c)}{x : \upstairs{A[\Theta]}}{\upstairs{B[\Theta \uparrow A]}} \\
&\equiv \upstairs{\Pi_{A[\Theta]} B[\Theta \uparrow A]}
\end{align*}

\item[{$\qlam{b}[\Theta] \equiv \qlam{b[\Theta \uparrow A]}$}:]
\begin{align*}
&\upstairs{\qlam{b}[\Theta]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{\qlam{b}}[\unp{\Delta}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\UI{x}{\rewrite{\pinv{x}}{\upstairs{b}}}[\unp{\Delta}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\UI{x}{\rewrite{\pinv{x}}{\upstairs{b}[\unp{\Delta}{\sigma}, x/x]}}} \\
&\equiv \UI{x}{\rewrite{\pinv{x}}{\EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma, x}{\upstairs{b}[\unp{\Delta}{\sigma}, x/x]}}} \\
&\equiv \UI{x}{\rewrite{\pinv{x}}{\EEs{\sigma.\modeof{(\Delta,A)}[\unp{\Delta,A}{\sigma}]}{\upstairs{\Theta \uparrow A}}{\sigma}{\upstairs{b}[\unp{\Delta,A}{\sigma}]}}} \\
&\equiv \UI{x}{\rewrite{\pinv{x}}{\upstairs{b[\Theta \uparrow A]}}} \\
&\equiv \upstairs{\qlam{b[\Theta \uparrow A]}}
\end{align*}

\item[{$\qapp{\qlam{b}} \equiv b$}:] 
\begin{align*}
&\upstairs{\qapp{\qlam{b}}} \\
&\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\UE{\upstairs{\qlam{b}}}{x}} \\
&\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\UE{\UI{x}{\rewrite{\pinv{x}}{\upstairs{b}}}}{x}} \\
&\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\UE{\UI{x}{\rewrite{\pinv{x}}{\upstairs{b}}}}{x}} \\
&\equiv \rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\rewrite{\pinv{x}}{\upstairs{b}}} \\
&\equiv \upstairs{b}
\end{align*}

\item[{$\qlam{\qapp{f}} \equiv f$}]
\begin{align*}
&\upstairs{\qlam{\qapp{f}}} \\
&\equiv \UI{x}{\rewrite{\pinv{x}}{\upstairs{\qapp{f}}}} \\
&\equiv \UI{x}{\rewrite{\pinv{x}}{\rewrite{\ApOne{\pi^{\modeof{\Gamma}}_x}}{\UE{\upstairs{f}}{x}}}} \\
&\equiv \UI{x}{\UE{\upstairs{f}}{x}} \\
&\equiv \upstairs{f}
\end{align*}
\end{enumerate}

\subsection{Adjoint Type Theory}

Continuing from the previous section, we extend MLTT with a pair of
adjoint modalities, generated by two modes $p$ and $q$, which are
comprehension objects (Definition~\ref{def:comprehension-object}) with a
morphism of comprehension objects
(Definition~\ref{def:morphism-comprehension-object}) between them.
Next, in Section~\ref{sec:example-encodings-spatial}, we add enough
structure to make these into the $\flat \dashv \sharp$ of spatial type
theory, by taking $p = q$ and making the left adjoint into an idempotent
comonad and the right adjoint into an idempotent monad.

For the bare adjunction (before we add the comonad structure), the
$\mathsf{U}$ types will support the rules for dependent right adjoint
types by \citet{birkedal+18rightadjoint}, so we use their notation for
the language being encoded.  The action of the left adjoint on contexts
is written $\Gamma,\lock$, and the right adjoint types are written as
$\Rtype{}$, with $\lock$ adjoint to $\Rtype{}$ in the sense that terms
of $\Gamma, \lock \qyields A \TYPE$ correspond bijectively with terms of
$\Gamma \qyields \Rtype{A} \TYPE$.  We give the rules of dependent
adjoint types in Figure~\ref{fig:qit-adjoint-rules}, presented in an
algebraic style with explicit weakenings and substitutions.  Each
judgement is marked with the comprehension object to which it belongs,
$p$ or $q$, and we assume that $p$ and $q$ both have the rules from
Figure~\ref{fig:qit-rules}.  The rules for right adjoint types follow
\citet{birkedal+18rightadjoint}, but our adjoint is not necessarily an
endofunctor, so judgements with subscript $p$ necessarily have no locks
in the context and those with subscript $q$ have exactly one.  To
recover their type theory, we take $p = q$, which allows a context to
contain multiple locks.  The framework suggests rules for dependent
\emph{left} adjoint types, which we write as $\Ltype{}$; these are the
$\mathsf{F}$ types for the same mode term generating the $\mathsf{U}$
types implementing $\mathsf{R}$.

Similar to $\Pi$-types, stability of $\RE{}$ under substitution follows from stability of $\RI{}$ using eta expansion:
\begin{align*}
\RE{b}[\Theta, \lock] 
&\equiv \RE{\RI{\RE{b}[\Theta, \lock]}} \\
&\equiv \RE{\RI{\RE{b}}[\Theta]} \\
&\equiv \RE{b[\Theta]}
\end{align*}

\begin{figure}
\begin{mathpar}
\inferrule*[left=ctx-$\lock$]{\qyields_p \Gamma \CTX}{\qyields_q \Gamma, \lock \CTX} \and
\inferrule*[left=sub-$\lock$]{\Gamma \qyields_p \Theta : \Delta}{\Gamma, \lock \qyields_q \Theta, \lock : \Delta, \lock} \\
\inferrule*[left=R-form]{\Gamma, \lock \qyields_q A \TYPE}{\Gamma \qyields_p \Rtype{A} \TYPE} \\
\inferrule*[left=R-intro]{\Gamma, \lock \qyields_q a : A}{\Gamma \qyields_p \RI{a} : \Rtype{A}} \and
\inferrule*[left=R-elim]{\Gamma \qyields_p b : \Rtype{B}}{\Gamma, \lock \qyields_q \RE{b} : B} \\
\inferrule*[left=L-form]{\Gamma \qyields_p A \TYPE}{\Gamma, \lock \qyields_q \Ltype{A} \TYPE} \\
\inferrule*[left=L-intro]{~}{\Gamma, A, \lock \qyields_q \LI{A} : \Ltype{A}[\proj{\Gamma, A}, \lock]} \and
\inferrule*[left=L-elim]{\Gamma, A, \lock \qyields_q c : C[\proj{\Gamma, A}, \lock, \LI{A}]}{\Gamma, \lock, \Ltype{A} \qyields_q \LE{c} : C} \\
\end{mathpar}
\begin{align}
\id_\Gamma , \lock &\equiv \id_{\Gamma, \lock} \\
(\Theta, \lock) ; (\kappa, \lock) &\equiv (\Theta ; \kappa), \lock \\
\nonumber \\
\Rtype{A}[\Theta] &\equiv \Rtype{(A[\Theta, \lock])} \\
\RI{a}[\Theta] &\equiv \RI{a[\Theta, \lock]} \\
\RE{\RI{a}} &\equiv a \\
\RI{\RE{b}} &\equiv b \\
\nonumber \\
\Ltype{A}[\Theta, \lock] &\equiv \Ltype{(A[\Theta])} \\
\LI{A}[\Theta \uparrow A, \lock] &\equiv \LI{A[\Theta]} \\
\LE{c}[\Theta, \lock \uparrow \Ltype{A}] &\equiv \LE{c[\Theta \uparrow A, \lock]} \\
\LE{c}[\proj{\Gamma, A}, \lock, \LI{A}] &\equiv c
\end{align}
\caption{Rules for Dependent Adjoints}\label{fig:qit-adjoint-rules}
\end{figure}

Object-level contexts are translated to framework contexts as before,
with $\qyields_p \Gamma \CTX$ given an associated mode term
$\downstairs{\Gamma} \yields \modeof{\Gamma} : p$ and
$\qyields_q \Delta \CTX$ given a mode term $\downstairs{\Delta} \yields \modeofq{\Delta} : q$.

\subsubsection{Contexts}

\begin{theorem}
  The rules for the context structure of dependent adjoints can be
  interpreted over the mode theory of two comprehension objects $p$ and
  $q$, with a morphism $f$ between them
  (Definition~\ref{def:morphism-comprehension-object}), assuming strict
  modalities for $f$ and composites of $\sdot_p$ and $\sempty_p$ and
  $\sdot_q$ and $\sempty_q$ exist.
\end{theorem}

First the structural rules.
\begin{enumerate}
\item[\textsc{ctx-$\lock$}] Given $\yields \upstairs{\Gamma} \CTX$, we define $\upstairs{\Gamma, \lock} :\equiv \upstairs{\Gamma}$, but with
\begin{align*}
\modeofq{(\Gamma, \lock)} :\equiv f(\modeof{\Gamma})
\end{align*}
%
\item[\textsc{sub-$\lock$}] We are given
\begin{align*}
\upstairs{\Gamma} \yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\modeof{\Delta}}{\ctxtuple{\upstairs{\Delta}}}
\end{align*}
and need to produce:
\begin{align*}
\upstairs{\Gamma, \lock} \yields_{\modeof{(\Gamma, \lock)}} \upstairs{\Theta, \lock} : \E{\modeofq{(\Delta, \lock)}}{\ctxtuple{\upstairs{\Delta, \lock}}}
\end{align*}
But because $\lock$ does not change the translation of the context we can define:
\begin{align*}
\upstairs{\Theta, \lock} :\equiv \EIs{f}{\upstairs{\Theta}}
\end{align*}
The type of the latter is $\E{f(\modeof{\Delta})}{\ctxtuple{\upstairs{\Delta, \lock}}}$ as required, by fusion for $\Esym$-types.
\end{enumerate}

The equations are then straightforward:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$\id_\Gamma , \lock \equiv \id_{\Gamma, \lock}$}:]
\begin{align*}
\upstairs{\id_\Gamma , \lock}
&\equiv \EIs{f}{\upstairs{\id_\Gamma}} \\
&\equiv \EIs{f}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\Gamma}}} \\
&\equiv \EIs{\sigma. f(\modeof{\Gamma}[\unp{\Gamma}{\sigma}])}{\pack{\Gamma}} \\
&\equiv \EIs{\modeofq{\Gamma, \lock}}{\pack{\Gamma, \lock}} \\
&\equiv \upstairs{\id_{\Gamma, \lock}}
\end{align*}

\item[{$(\Theta, \lock) ; (\kappa, \lock) \equiv (\Theta ; \kappa), \lock$}:] 
\begin{align*}
&\upstairs{(\Theta, \lock) ; (\kappa, \lock)} \\
&\equiv \EEs{\sigma.\modeofq{\Delta, \lock}[\unp{\Delta, \lock}{\sigma}]}{\upstairs{\Theta, \lock}}{\sigma}{\upstairs{\kappa, \lock}[\unpack{\upstairs{\Delta, \lock}}{\sigma}]} \\
&\equiv \EEs{\sigma.f(\modeof{\Delta})[\unp{\Delta}{\sigma}]}{\EIs{f}{\upstairs{\Theta}}}{\sigma}{\EIs{f}{\upstairs{\kappa}}[\unpack{\upstairs{\Delta}}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\EIs{f}{\upstairs{\kappa}}[\unpack{\upstairs{\Delta}}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\EIs{f}{\upstairs{\kappa}[\unpack{\upstairs{\Delta}}{\sigma}]}} \\
&\equiv \EIs{f}{\EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{\kappa}[\unpack{\upstairs{\Delta}}{\sigma}]}} \\
&\equiv \EIs{f}{\upstairs{\Theta ; \kappa}} \\
&\equiv \upstairs{(\Theta ; \kappa), \lock}
\end{align*}
\end{enumerate}

\subsubsection{$\mathsf{R}$-types}

\begin{theorem}
  The rules for right adjoint types can be interpreted in any morphism
  of comprehension objects that supports right adjoint types
  (Definition~\ref{def:supports-right-adjoint}), if the strict modalities for
  the contexts exist, and for each $\alpha : p$,
  $\mathsf{U}_{c.f_1(\alpha,c)}$ types exist.
\end{theorem}

\begin{enumerate}
\item[\textsc{R-form}] We are given 
\begin{align*}
\upstairs{\Gamma, \lock} \yields_{\El{q}{f(\modeof{\Gamma})}} \upstairs{A} \TYPE
\end{align*}
and can form
\begin{align*}
\upstairs{\Gamma} \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{\Rtype{A}} :\equiv \U{f_1}{1}{\upstairs{A}} \TYPE
\end{align*}

\item[\textsc{R-intro}] We are given 
\begin{align*}
\upstairs{\Gamma,\lock} \yields_{\One_{f(\modeof{\Gamma})}} \upstairs{a} : \upstairs{A}
\end{align*}
and can do:
\begin{mathpar}
\inferrule*[Left=U-intro]{
\inferrule*[Left=rewrite]{
\upstairs{\Gamma,\lock} \yields_{\One_{f(\modeof{\Gamma})}} \upstairs{a} : \upstairs{A}}
{\upstairs{\Gamma,\lock} \yields_{f_1(\One_{\modeof{\Gamma}})} \rewrite{\foneinv{\modeof{\Gamma}}}{\upstairs{a}} : \upstairs{A}}}
{\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \UI{()}{\rewrite{\foneinv{\modeof{\Gamma}}}{\upstairs{a}}} : \upstairs{\Rtype{A}}}
\end{mathpar}

\item[\textsc{R-elim}] Given
\begin{align*}
\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \upstairs{b} : \U{f_1}{1}{\upstairs{B}}
\end{align*}
we can do:
\begin{mathpar}
\inferrule*[Left=rewrite]{
\inferrule*[Left=U-elim]{
\upstairs{\Gamma} \yields_{\One_{\modeof{\Gamma}}} \upstairs{b} : \U{f_1}{1}{\upstairs{B}}}
{\upstairs{\Gamma} \yields_{f_1(\One_{\modeof{\Gamma}})} \UE{\upstairs{b}}{} : \upstairs{B}}}
{\upstairs{\Gamma} \yields_{\One_{f(\modeof{\Gamma})}} \rewrite{\fone{\modeof{\Gamma}}}{\UE{\upstairs{b}}{}} : \upstairs{B}}
\end{mathpar}
\end{enumerate}

The equations are verified in more or less the same way as for $\Pi$-types.
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$\Rtype{A}[\Theta] \equiv \Rtype{(A[\Theta, \lock])}$}:] 
\begin{align*}
&\upstairs{\Rtype{A}[\Theta]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\U{f_1}{1}{\upstairs{A}}[\unpack{\Delta}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\U{f_1}{1}{\upstairs{A}[\unpack{\Delta}{\sigma}]}} \\
&\equiv \U{f_1}{1}{\EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unpack{\Delta}{\sigma}]}} \\
&\equiv \U{f_1}{1}{\EEs{\sigma.\modeofq{(\Delta, \lock)}[\unp{\Delta, \lock}{\sigma}]}{\EIs{f}{\upstairs{\Theta}}}{\sigma}{\upstairs{A}[\unpack{\Delta}{\sigma}]}} \\
&\equiv \U{f_1}{1}{\EEs{\sigma.\modeofq{(\Delta, \lock)}[\unp{\Delta, \lock}{\sigma}]}{\upstairs{\Theta, \lock}}{\sigma}{\upstairs{A}[\unpack{\Delta, \lock}{\sigma}]}} \\
&\equiv \upstairs{\Rtype{(A[\Theta, \lock])}}
\end{align*}

\item[{$\RI{a}[\Theta] \equiv \RI{a[\Theta, \lock]}$}:] 
\begin{align*}
&\upstairs{\RI{a}[\Theta]} \\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\UI{()}{\rewrite{\foneinv{\modeof{\Delta}}}{\upstairs{a}}}[\unpack{\Delta}{\sigma}]} \\
&\equiv \rewrite{\foneinv{\modeof{\Gamma}}}{\UI{()}{\EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{a}[\unpack{\Delta, \lock}{\sigma}]}}} \\
&\equiv \rewrite{\foneinv{\modeof{\Gamma}}}{\UI{()}{\EEs{\sigma.\modeofq{(\Delta, \lock)}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta, \lock}}{\sigma}{\upstairs{a}[\unpack{\Delta, \lock}{\sigma}]}}} \\
&\equiv \upstairs{\RI{a[\Theta, \lock]}}
\end{align*}

\item[{$\RE{\RI{a}} \equiv a$}:] As for $\Pi$-types.
\begin{align*}
&\upstairs{\RE{\RI{a}}} \\
&\equiv \rewrite{\fone{\modeof{\Gamma}}}{\UE{\upstairs{\RI{a}}}{}} \\
&\equiv \rewrite{\fone{\modeof{\Gamma}}}{\UE{(\UI{()}{\rewrite{\foneinv{\modeof{\Gamma}}}{\upstairs{a}}})}{}} \\
&\equiv \rewrite{\fone{\modeof{\Gamma}}}{\rewrite{\foneinv{\modeof{\Gamma}}}{\upstairs{a}}} \\
&\equiv \upstairs{a}
\end{align*}

\item[{$\RI{\RE{b}} \equiv b$}:] As for $\Pi$-types.
\begin{align*}
&\upstairs{\RI{\RE{b}}} \\
&\equiv \UI{()}{\rewrite{\foneinv{\modeof{\Gamma}}}{\upstairs{\RE{b}}}} \\
&\equiv \UI{()}{\rewrite{\foneinv{\modeof{\Gamma}}}{\rewrite{\fone{\modeof{\Gamma}}}{\UE{\upstairs{b}}{}}}} \\
&\equiv \UI{()}{\UE{\upstairs{b}}{}} \\
&\equiv \upstairs{b}
\end{align*}
\end{enumerate}

\subsubsection{$\mathsf{L}$-types}

\begin{theorem}
  The rules for left adjoint types can be interpreted in any morphism of
  comprehension objects that supports left adjoint types
  (Definition~\ref{def:supports-left}) if the strict modalities for the
  contexts exist, and for each $\alpha : p$,
  $\mathsf{F}_{x.f_1(\alpha,x)}$ types exist.
\end{theorem}

And now the left adjoint:

\begin{enumerate}
\item[\textsc{L-form}] We are given
\begin{align*}
\upstairs{\Gamma} \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{A} \TYPE
\end{align*}
So we can form
\begin{mathpar}
\upstairs{\Gamma, \lock} \yields_{\El{p}{f(\modeof{\Gamma})}} \upstairs{\Ltype{A}} :\equiv \F{f_1}{\upstairs{A}} \TYPE
\end{mathpar}

\item[\textsc{L-intro}] Our goal is a term $\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{\modeofq{(\Gamma, A, \lock)}}} \upstairs{\LI{A}} : \upstairs{\Ltype{A}[\proj{\Gamma, A}, \lock]}$. The substitution can be simplified:
\begin{align*}
&\upstairs{\proj{\Gamma, A}, \lock} \\
&\equiv \EIs{f}{\upstairs{\proj{\Gamma, A}}} \\
&\equiv \EIs{f}{\rewrite{\pi^{\modeof{\Gamma}}_x}{\upstairs{\id_\Gamma}}} \\ 
&\equiv \rewrite{\ap{f}{\pi^{\modeof{\Gamma}}_x}}{\EIs{f}{\upstairs{\id_\Gamma}}}
\end{align*}
So the type $\upstairs{\Ltype{A}[\proj{\Gamma, A}, \lock]}$ is translated to:
\begin{align*}
&\upstairs{\Ltype{A}[\proj{\Gamma, A}, \lock]} \\
&\equiv \EEs{\sigma.\modeofq{(\Delta, \lock)}[\unp{\Delta, \lock}{\sigma}]}{\upstairs{\proj{\Gamma, A}, \lock}}{\sigma}{\upstairs{\Ltype{A}}[\unpack{\Delta, \lock}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeofq{(\Delta, \lock)}[\unp{\Delta, \lock}{\sigma}]}{\rewrite{\ap{f}{\pi^{\modeof{\Gamma}}_x}}{\EIs{f}{\upstairs{\id_\Gamma}}}}{\sigma}{\upstairs{\Ltype{A}}[\unpack{\Delta, \lock}{\sigma}]} \\
&\equiv \St{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\EEs{\sigma.\modeofq{(\Delta, \lock)}[\unp{\Delta, \lock}{\sigma}]}{\EIs{f}{\upstairs{\id_\Gamma}}}{\sigma}{\upstairs{\Ltype{A}}[\unpack{\Delta, \lock}{\sigma}]}} \\
&\equiv \St{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\id_\Gamma}}{\sigma}{\upstairs{\Ltype{A}}[\unpack{\Delta, \lock}{\sigma}]}} \\
&\equiv \St{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\upstairs{\Ltype{A}}}
\end{align*}
So define $\upstairs{\LI{A}}$ to be:
\begin{mathpar}
\inferrule*[Left=rewrite]{
\inferrule*[Left=s-intro]{
\inferrule*[Left=F-intro]{
\upstairs{\Gamma}, x : \upstairs{A} \yields_x x : \upstairs{A}}
{\upstairs{\Gamma}, x : \upstairs{A} \yields_{f_1(x)} \FI{x} : \upstairs{\Ltype{A}}}}
{\upstairs{\Gamma}, x : \upstairs{A} \yields_{\TrPlus{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{f_1(x)}} \StI{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\FI{x}} : \St{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\upstairs{\Ltype{A}}}}}
{\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{f(\modeof{\Gamma}.x)}} \rewrite{\fibf{x}}{\StI{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\FI{x}}} : \St{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\upstairs{\Ltype{A}}}}
\end{mathpar}

\item[\textsc{L-elim}] We are given a term $\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{f(\modeof{\Gamma}.x)}} \upstairs{c} : \upstairs{C[\proj{\Gamma, A}, \lock, \LI{A}]}$. 

The substitution $\proj{\Gamma, A}, \lock, \LI{A}$ is translated to 
\begin{align*}
&\upstairs{\proj{\Gamma, A}, \lock, \LI{A}} \\
\equiv{} &\rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EIs{\sdot}{\upstairs{\proj{\Gamma, A}, \lock}, \upstairs{\LI{A}}}} \\
\equiv{} &\rewrite{\eta^\sdot_{\modeof{\Gamma}}}{\EIs{\sdot}{\rewrite{\ap{f}{\pi^{\modeof{\Gamma}}_x}}{\EIs{f}{\upstairs{\id_\Gamma}}}, \rewrite{\fibf{x}}{\StI{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\FI{x}}}}} \\
\equiv{} &\rewrite{\eta^\sdot_{\modeof{\Gamma}};(\ap{f}{\pi^{\modeof{\Gamma}}_x} \bdot \fibf{x})}{\EIs{\sdot}{\EIs{f}{\upstairs{\id_\Gamma}}, \FI{x}}} \\
\equiv{} &\rewrite{\fdist{x}}{\EIs{\sdot}{\EIs{f}{\upstairs{\id_\Gamma}}, \FI{x}}} 
\end{align*}
So $\upstairs{C[\proj{\Gamma, A}, \lock, \LI{A}]}$ becomes:
\begin{align*}
&\upstairs{C[\proj{\Gamma, A}, \lock, \LI{A}]} \\
&\equiv \EEs{\sigma.\modeofq{(\Gamma, \lock, \Ltype{A})}[\unp{\Gamma, \lock, \Ltype{A}}{\sigma}]}{\upstairs{\proj{\Gamma, A}, \lock, \LI{A}}}{\sigma}{\upstairs{C}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeofq{(\Gamma, \lock, \Ltype{A})}[\unp{\Gamma, \lock, \Ltype{A}}{\sigma}]}{\rewrite{\fdist{x}}{\EIs{\sdot}{\EIs{f}{\upstairs{\id_\Gamma}}, \FI{x}}} }{\sigma}{\upstairs{C}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}]} \\
&\equiv \St{\ApEl{q}{\fdist{x}}}{\EEs{\sigma.\modeofq{(\Gamma, \lock, \Ltype{A})}[\unp{\Gamma, \lock, \Ltype{A}}{\sigma}]}{\EIs{\sdot}{\EIs{f}{\upstairs{\id_\Gamma}}, \FI{x}}}{\sigma}{\upstairs{C}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}]}} \\
&\equiv \St{\ApEl{q}{\fdist{x}}}{\EEs{\sigma.\modeofq{(\Gamma, \lock, \Ltype{A})}[\unp{\Gamma, \lock, \Ltype{A}}{\sigma}]}{\EIs{\sdot}{\EIs{f}{\StI{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\Gamma}}, \FI{x}}}}{\sigma}{\upstairs{C}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}]}} \\
&\equiv \St{\ApEl{q}{\fdist{x}}}{\upstairs{C}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}][\pack{\Gamma}/\sigma, \FI{x}/z]} \\
&\equiv \St{\ApEl{q}{\fdist{x}}}{\upstairs{C}[\FI{x}/z]}
\end{align*}
Define the translation of $\LE{c}$ to be:
\begin{mathpar}
\inferrule*[Left=F-elim]{
\inferrule*[Left=rewrite]{
\inferrule*[Left=s-intro]{
\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{f(\modeof{\Gamma}.x)}} \upstairs{c} : \St{\ApEl{q}{\fdist{x}}}{\upstairs{C}[\FI{x}/z]}}
{\upstairs{\Gamma}, x : \upstairs{A} \yields_{\TrPlus{\ApEl{q}{\fdistinv{x}}}{\One_{f(\modeof{\Gamma}.x)}}} \StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c}} : \upstairs{C}[\FI{x}/z]}}
{\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{f(\modeof{\Gamma}).f_1(x)}} \rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c}}} : \upstairs{C}[\FI{x}/z]}}
{\upstairs{\Gamma}, z : \upstairs{\Ltype{A}} \yields_{\One_{f(\modeof{\Gamma}).z}} \FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c}}}} : \upstairs{C}}
\end{mathpar}
\end{enumerate}

And the equations: 

\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$\Ltype{A}[\Theta, \lock] \equiv \Ltype{(A[\Theta])}$}:]
\begin{align*}
&\upstairs{\Ltype{A}[\Theta, \lock]} \\
&\equiv \EEs{\sigma.\modeofq{\Delta, \lock}[\unp{\Delta, \lock}{\sigma}]}{\upstairs{\Theta, \lock}}{\sigma}{\upstairs{\Ltype{A}}[\unpack{\Delta, \lock}{\sigma}]}
&\equiv \EEs{\sigma.f(\modeof{\Delta}[\unp{\Delta}{\sigma}])}{\EIs{f}{\upstairs{\Theta}}}{\sigma}{ \F{f_1}{\upstairs{A}}[\unpack{\Delta, \lock}{\sigma}]}\\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{ \F{f_1}{\upstairs{A}}[\unpack{\Delta, \lock}{\sigma}]}\\
&\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{
\F{f_1}{\upstairs{A}[\unpack{\Delta}{\sigma}]}}\\
&\equiv \F{f_1}{\EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unpack{\Delta}{\sigma}]}}\\
&\equiv \F{f_1}{\upstairs{A[\Theta]}} \\
&\equiv \upstairs{\Ltype{(A[\Theta])}}
\end{align*}

\item[{$\LI{A}[\Theta \uparrow A, \lock] \equiv \LI{A[\Theta]}$}:]
\begin{align*}
&\upstairs{\LI{A}[\Theta \uparrow A, \lock]} \\
&\equiv \EEs{\sigma.\modeofq{(\Delta, A, \lock)}[\unp{\Delta, A, \lock}{\sigma}]}{\upstairs{\Theta \uparrow A, \lock}}{\sigma}{\upstairs{\LI{A}}[\unpack{\Delta, A, \lock}{\sigma}]} \\
&\equiv \EEs{\sigma.f(\modeof{(\Delta, A)}[\unp{\Delta, A}{\sigma}])}{\EIs{f}{\upstairs{\Theta \uparrow A}}}{\sigma}{\upstairs{\LI{A}}[\unpack{\Delta, A, \lock}{\sigma}]} \\
&\equiv \EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma, x}{\upstairs{\LI{A}}[\unpack{\Delta}{\sigma}, x/x]} \\
&\equiv \EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma, x}{\rewrite{\fibf{x}}{\StI{\ApEl{q}{\ap{f}{\pi^{\modeof{\Delta}}_x}}}{\FI{x}}}[\unpack{\Delta}{\sigma}, x/x]} \\
&\equiv \EEs{(\sigma, x). (\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma, x}{\rewrite{\fibf{x}}{\StI{\ApEl{q}{\ap{f}{\pi^{\modeof{\Delta}[\unp{\Delta}{\sigma}]}_x}}}{\FI{x}}}} \\
&\equiv \rewrite{\fibf{x}}{\StI{\ApEl{q}{\ap{f}{\pi^{\modeof{\Gamma}}_x}}}{\FI{x}}} \\
&\equiv \upstairs{\LI{A[\Theta]}}
\end{align*}

\item[{$\LE{c}[\Theta, \lock \uparrow \Ltype{A}] \equiv \LE{c[\Theta \uparrow A, \lock]}$}:]
\begin{align*}
&\upstairs{\LE{c}[\Theta, \lock \uparrow \Ltype{A}]} \\
&\equiv \EEs{\sigma.\modeofq{(\Delta, \lock, \Ltype{A})}[\unp{\Delta, \lock, \Ltype{A}}{\sigma}]}{\upstairs{\Theta, \lock \uparrow \Ltype{A}}}{\sigma}{\upstairs{\LE{c}}[\unpack{\Delta, \lock, \Ltype{A}}{\sigma}]} \\
&\equiv \EEs{(\sigma, z).(\modeofq{(\Delta, \lock)}[\unp{\Delta, \lock}{\sigma}], z)}{(\upstairs{\Theta, \lock}, z)}{\sigma, z}{\upstairs{\LE{c}}[\unpack{\Delta, \lock}{\sigma}, z/z]} \\
&\equiv \EEs{(\sigma, z).(f(\modeof{\Delta}[\unp{\Delta}{\sigma}]), z)}{(\EIs{f}{\upstairs{\Theta}}, z)}{\sigma, z}{\upstairs{\LE{c}}[\unpack{\Delta, \lock}{\sigma}, z/z]} \\
&\equiv \EEs{(\sigma, z).(\modeof{\Delta}[\unp{\Delta}{\sigma}], z)}{(\upstairs{\Theta}, z)}{\sigma, z}{\upstairs{\LE{c}}[\unpack{\Delta}{\sigma}, z/z]} \\
&\equiv \EEs{(\sigma, z).(\modeof{\Delta}[\unp{\Delta}{\sigma}], z)}{(\upstairs{\Theta}, z)}{\sigma, z}{\FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c}}}}[\unpack{\Delta}{\sigma}, z/z]} \\
&\equiv \EEs{(\sigma, z).(\modeof{\Delta}[\unp{\Delta}{\sigma}], z)}{(\upstairs{\Theta}, z)}{\sigma, z}{\FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c}[\unpack{\Delta}{\sigma}, x/x]}}}} \\
&\equiv \EEs{(\sigma, z).(\modeof{\Delta}[\unp{\Delta}{\sigma}], z)}{(\upstairs{\Theta}, z)}{\sigma, z}{\FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\\
&\qquad \EEs{(\sigma, x).(\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\EIs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\sigma}, x)}{\sigma, x}{\upstairs{c}[\unpack{\Delta}{\sigma}, x/x]}}}}} \\
&\equiv \FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\EEs{(\sigma, x).(\modeof{\Delta}[\unp{\Delta}{\sigma}], x)}{(\upstairs{\Theta}, x)}{\sigma, x}{\upstairs{c}[\unpack{\Delta}{\sigma}, x/x]}}}} \\
&\equiv \FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\EEs{\sigma.\modeof{(\Delta, A)}[\unp{\Delta, A}{\sigma}]}{\upstairs{\Theta \uparrow A}}{\sigma}{\upstairs{c}[\unpack{\Delta, A}{\sigma}]}}}} \\
&\equiv \FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\EEs{\sigma.\modeofq{(\Delta, A, \lock)}[\unp{(\Delta, A, \lock)}{\sigma}]}{\upstairs{\Theta \uparrow A, \lock}}{\sigma}{\upstairs{c}[\unpack{\Delta, A}{\sigma}]}}}} \\
&\equiv \FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c[\Theta \uparrow A, \lock]}}}} \\
&\equiv \upstairs{\LE{c[\Theta \uparrow A, \lock]}}
\end{align*}

\item[{$\LE{c}[\proj{\Gamma, A}, \lock, \LI{A}] \equiv c$}:]
\begin{align*}
&\upstairs{\LE{c}[\proj{\Gamma, A}, \lock, \LI{A}]} \\
&\equiv \EEs{\sigma.\modeofq{(\Gamma, \lock, \Ltype{A})}[\unp{\Gamma, \lock, \Ltype{A}}{\sigma}]}{\upstairs{\proj{\Gamma, A}, \lock, \LI{A}}}{\sigma}{\upstairs{\LE{c}}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeofq{(\Gamma, \lock, \Ltype{A})}[\unp{\Gamma, \lock, \Ltype{A}}{\sigma}]}{\rewrite{\fdist{x}}{\EIs{\sdot}{\EIs{f}{\upstairs{\id_\Gamma}}, \FI{x}}} }{\sigma}{\upstairs{\LE{c}}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}]} \\
&\equiv \rewrite{\ApOne{\fdist{x}}}{\StI{\ApEl{p}{\fdist{x}}}{\EEs{\sigma.\modeofq{(\Gamma, \lock, \Ltype{A})}[\unp{\Gamma, \lock, \Ltype{A}}{\sigma}]}{\EIs{\sdot}{\EIs{f}{\upstairs{\id_\Gamma}}, \FI{x}} }{\sigma}{\upstairs{\LE{c}}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}]}}} \\
&\equiv \rewrite{\ApOne{\fdist{x}}}{\StI{\ApEl{p}{\fdist{x}}}{\EEs{\sigma.\modeofq{(\Gamma, \lock, \Ltype{A})}[\unp{\Gamma, \lock, \Ltype{A}}{\sigma}]}{\EIs{\sdot}{\EIs{f}{\EIs{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\pack{\Gamma}}}, \FI{x}} }{\sigma}{\upstairs{\LE{c}}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}]}}} \\
&\equiv \rewrite{\ApOne{\fdist{x}}}{\StI{\ApEl{p}{\fdist{x}}}{\upstairs{\LE{c}}[\unpack{\Gamma, \lock, \Ltype{A}}{\sigma}][(\pack{\Gamma}, \FI{x})/\sigma]}} \\
&\equiv \rewrite{\ApOne{\fdist{x}}}{\StI{\ApEl{p}{\fdist{x}}}{\upstairs{\LE{c}}[\FI{x}/z]}} \\
&\equiv \rewrite{\ApOne{\fdist{x}}}{\StI{\ApEl{p}{\fdist{x}}}{\FE{z}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c}}}}[\FI{x}/z]}} \\
&\equiv \rewrite{\ApOne{\fdist{x}}}{\StI{\ApEl{p}{\fdist{x}}}{\FE{\FI{x}}{x}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c}}}}}} \\
&\equiv \rewrite{\ApOne{\fdist{x}}}{\StI{\ApEl{p}{\fdist{x}}}{\rewrite{\ApOne{\fdistinv{x}}}{\StI{\ApEl{q}{\fdistinv{x}}}{\upstairs{c}}}}} \\
&\equiv \upstairs{c}
\end{align*}
\end{enumerate}

\subsubsection{Spatial Type Theory}

In any algebraic style, passing from adjoint type theory to spatial type
theory is only a matter of adding some additional substitutions making
the left adjoint on contexts into a comonad:

\begin{theorem}
Suppose $f$ supports spatial type theory
(Definition~\ref{def:supports-spatial}), so $f$ has the
structure of an idempotent comonad, and that we have the
top types needed for $\mathsf{L}$ and $\mathsf{R}$ types.
If strict modalities for the counit and comultiplication exist,
then we can additionally interpret axiomatic substitutions
\[
\begin{array}{l}
\Gamma, \lock \qyields \counit{\Gamma} : \Gamma\\
\Gamma, \lock \qyields \comult{\Gamma} : \Gamma, \lock, \lock
\end{array}
\]
satisfing the same equations as the mode theory, for example,
$\comult{\Gamma};\counit{\Gamma, \lock} \equiv \id_{\Gamma, \lock}$.
\end{theorem}

%\begin{figure}
%\begin{mathpar}
%\inferrule*[left=counit-$\lock$]{~}{\Gamma, \lock \qyields \counit{\Gamma} : \Gamma} \and
%\inferrule*[left=comult-$\lock$]{~}{\Gamma, \lock \qyields \comult{\Gamma} : \Gamma, \lock, \lock}
%\end{mathpar}
%\begin{align}
%\counit{\Gamma}; \Theta &\equiv (\Theta, \lock) ; \counit{\Delta} \\
%\comult{\Gamma}; (\Theta, \lock, \lock) &\equiv (\Theta, \lock) ; \comult{\Delta} \\
%\nonumber \\
%\comult{\Gamma}; (\comult{\Gamma}, \lock) &\equiv \comult{\Gamma} ; \comult{\Gamma, \lock} \\
%\comult{\Gamma} ; \counit{\Gamma, \lock} &\equiv \id_{\Gamma, \lock} \\
%\comult{\Gamma} ; (\counit{\Gamma}, \lock) &\equiv \id_{\Gamma, \lock}
%\end{align}
%\caption{\mvrnote{Name?} Minimal Rules for Spatial Type Theory with Explicit Substitutions}\label{fig:qit-minimal-spatial-rules}
%\end{figure}

The two axiomatic substitutions are defined straightforwardly as
\begin{align*}
\upstairs{\Gamma, \lock} &\yields_{\modeof{(\Gamma, \lock)}} \upstairs{\counit{\Gamma}} :\equiv \rewrite{\fcounit{\modeof{\Gamma}}}{\upstairs{\id_{\Gamma}}} : \E{\sigma.\modeof{\Gamma}[\unp{\Gamma}{\sigma}]}{\ctxtuple{\upstairs{\Gamma}}} \\
\upstairs{\Gamma, \lock} &\yields_{\modeof{(\Gamma, \lock)}} \upstairs{\comult{\Gamma}} :\equiv \rewrite{\fcomult{\modeof{\Gamma}}}{\upstairs{\id_{\Gamma, \lock, \lock}}} : \E{\sigma.\modeof{\Gamma, \lock, \lock}[\unp{\Gamma, \lock, \lock}{\sigma}]}{\ctxtuple{\upstairs{\Gamma, \lock, \lock}}}
\end{align*}

The equations follow quickly from the analogous equations in the mode theory, for example, 
\begin{align*}
&\upstairs{\comult{\Gamma} ; \counit{\Gamma, \lock}} \\
&\equiv \EEs{\sigma.\modeof{\Gamma, \lock, \lock}[\unp{\Gamma, \lock, \lock}{\sigma}]}{\upstairs{\comult{\Gamma}}}{\sigma}{\upstairs{\counit{\Gamma, \lock}}[\unpack{\upstairs{\Gamma, \lock, \lock}}{\sigma}]} \\
&\equiv \EEs{\sigma.\modeof{\Gamma, \lock, \lock}[\unp{\Gamma, \lock, \lock}{\sigma}]}{\rewrite{\fcomult{\modeof{\Gamma}}}{\upstairs{\id_{\Gamma, \lock, \lock}}}}{\sigma}{\rewrite{\fcounit{\modeof{\Gamma, \lock}}}{\upstairs{\id_{\Gamma, \lock}}}[\unpack{\upstairs{\Gamma, \lock, \lock}}{\sigma}]} \\
&\equiv \rewrite{\fcomult{\modeof{\Gamma}}}{\EEs{\sigma.\modeof{\Gamma, \lock, \lock}[\unp{\Gamma, \lock, \lock}{\sigma}]}{\upstairs{\id_{\Gamma, \lock, \lock}}}{\sigma}{\rewrite{\fcounit{\modeof{\Gamma, \lock}}}{\upstairs{\id_{\Gamma, \lock}}}[\unpack{\upstairs{\Gamma, \lock, \lock}}{\sigma}]}} \\
&\equiv \rewrite{\fcomult{\modeof{\Gamma}}}{\rewrite{\fcounit{\modeof{\Gamma, \lock}}}{\upstairs{\id_{\Gamma, \lock}}}} \\
&\equiv \rewrite{\fcomult{\modeof{\Gamma}};\fcounit{f(\modeof{\Gamma})}}{\upstairs{\id_{\Gamma, \lock}}} \\
&\equiv \upstairs{\id_{\Gamma, \lock}}
\end{align*}

\begin{lemma}
For any substitution $\Gamma \qyields \Theta : \Delta, \lock$, the identity $(\Theta ; \counit{\Delta}), \lock \equiv \counit{\Gamma} ; \Theta$ holds.
\end{lemma}
\begin{proof}
\begin{align*}
&(\Theta ; \counit{\Delta}), \lock \\
&\equiv (\Theta, \lock) ; (\counit{\Delta}, \lock) \\
&\equiv (\Theta, \lock) ; \counit{\Delta, \lock}\\
&\equiv \counit{\Gamma} ; \Theta
\end{align*}
\end{proof}

What remains is to connect this algebraic presentation to the rules for
spatial type theory in \citet{shulman15realcohesion}, by translating the
``optimized'' rules into the algebraic presentation.  In
Figure~\ref{fig:qit-spatial-rules} we show each spatial type theory rule
and its equivalent in the algebraic style.  The spatial type theory
rules are slightly modified by omitting some cuts and weakenings, as
both are derivable rules in the algebraic syntax.

A context $\Delta \mid \Gamma$ of spatial type theory is translated such
that a $\lock$ is applied after every context extension of the
\emph{crisp context}. For example, $x :: A, y :: B \mid w : C, z : D$
becomes $\lock, A, \lock, B, \lock, C, D$. In this way we maintain the
invariant that a crisp context $\Delta \mid \cdot$ always ends with a
$\lock$.

\begin{figure}
\begin{mathpar}
\inferrule*[left=crisp-var]{~}{\Delta, x :: A \mid \cdot \yields x : A} \and
\inferrule*{~}{\Gamma, \lock, A, \lock \qyields \qcrispvar{A} : A[\counit{\Gamma, \lock, A} ; \proj{\Gamma, \lock, A}] } \\
\inferrule*[left=crisp-ctx-ext]{\Delta \mid \cdot \yields A \TYPE}{\yields \Delta, A \mid \cdot \CTX} \and
\inferrule*{\Gamma, \lock \qyields A \TYPE}{\qyields \Gamma, \lock, A, \lock \CTX} \\
\inferrule*[left=crisp-sub-ext]{(\Delta \mid \cdot) \yields \Theta : (\Delta' \mid \cdot) \and (\Delta \mid \cdot) \yields a : A[\Theta]}{(\Delta \mid \cdot) \yields (\Theta, a) : (\Delta', A \mid \cdot)} \and
\inferrule*{\Gamma, \lock \qyields \Theta : \Gamma', \lock \and \Gamma, \lock \yields a : A[\Theta]}{\Gamma, \lock \qyields (\Theta, a) : \Gamma', \lock, A, \lock} \\
\inferrule*[left=$\flat$-form]{\Delta \mid \cdot \yields A \TYPE}{\Delta \mid \cdot \yields \Flattype{A} \TYPE} \and
\inferrule*{\Gamma, \lock \qyields A \TYPE}{\Gamma, \lock \qyields \Flattype{A} \TYPE} \\
\inferrule*[left=$\flat$-intro]{\Delta \mid \cdot \yields a : A}{\Delta \mid \cdot \yields \FlatI{a} : \Flattype{A}} \and
\inferrule*{\Gamma, \lock \qyields a : A}{\Gamma, \lock \qyields \FlatI{a} : \Flattype{A}} \\
\inferrule*[left=$\flat$-elim]{\Delta, u :: A \mid \cdot \yields c : C[\FlatI{u}/x]}{\Delta \mid x : \Flattype{A} \yields \FlatE{c} : C} \and
\inferrule*{\Gamma, \lock, A, \lock \qyields c : C[(\counit{\Gamma, \lock, A} ; \proj{\Gamma, \lock, A}), \FlatI{\qcrispvar{A}}]}{\Gamma, \lock, \Flattype{A} \qyields \FlatE{c} : C} \\
\inferrule*[left=$\sharp$-form]{\Delta, \Gamma \mid \cdot \yields A \TYPE}{\Delta \mid \Gamma \yields \Sharptype{A} \TYPE} \and
\inferrule*{\Gamma, \lock, B, \lock \qyields A \TYPE}{\Gamma, \lock, B \qyields \Sharptype{A} \TYPE} \\
\inferrule*[left=$\sharp$-intro]{\Delta, \Gamma \mid \cdot \yields a : A}{\Delta \mid \Gamma \yields \SharpI{a} : \Sharptype{A}} \and
\inferrule*{\Gamma, \lock, B, \lock \qyields a : A}{\Gamma, \lock, B \qyields \SharpI{a} : \Sharptype{A}} \\
\inferrule*[left=$\sharp$-elim]{\Delta \mid \cdot \yields a : \Sharptype{A}}{\Delta \mid \cdot \yields \SharpE{a} : A} \and
\inferrule*{\Gamma, \lock, B, \lock \qyields a : \Sharptype{A}[\counit{\Gamma, \lock, B}]}{\Gamma, \lock, B, \lock \qyields \SharpE{a} : A}
\end{mathpar}
%\begin{align}
%\id_\Gamma , \lock &\equiv \id_{\Gamma, \lock} \\
%(\Theta, \lock) ; (\kappa, \lock) &\equiv (\Theta ; \kappa), \lock \\
%\counit{\Gamma}; \Theta &\equiv (\Theta, \lock) ; \counit{\Delta} \\
%\nonumber \\
%(\Flattype{A})[\Theta, \lock] &\equiv \Flattype{(A[\Theta, \lock])} \\
%\FlatI{A}[\Theta, \lock \uparrow A, \lock] &\equiv \FlatI{A[\Theta, \lock]} \\
%\FlatE{c}[\Theta, \lock \uparrow \Flattype{A}] &\equiv \FlatE{c[\Theta, \lock \uparrow A, \lock]} \\
%\FlatE{c}[(\proj{\Gamma, \lock, A};\counit{\Gamma}), \lock, \FlatI{A}] &\equiv c \\
%\nonumber \\
%\Sharptype{A}[\Theta] &\equiv \Sharptype{(A[\Theta, \lock])} \\
%\SharpI{a}[\Theta] &\equiv \SharpI{(a[\Theta, \lock])} \\
%\SharpE{(\SharpI{a}[\counit{\Gamma}])} &\equiv a \\
%\SharpI{(\SharpE{b})}[\counit{\Gamma}] &\equiv b \\
%\intertext{and for idempotent}
%\counit{\Gamma}, \lock &\equiv \counit{\Gamma, \lock}
%\end{align}
\caption{Spatial type theory rules and their algebraic equivalent}\label{fig:qit-spatial-rules}
\end{figure}

\begin{proposition}
The rules of spatial type theory are all derivable in the algebraic syntax, with
\begin{align*}
\Flattype{A} &:\equiv \Ltype{A}[\comult{\Gamma}] \\
\Sharptype{A} &:\equiv \Rtype{A}
\end{align*}
\end{proposition}

\begin{enumerate}
\item[\textsc{crisp-var}]
\begin{mathpar}
\inferrule*[Left=cut]{
\inferrule*[Left=var]{~}
{\Gamma, \lock, A \qyields \qvar{A} : A[\proj{\Gamma, \lock, A}]}}
{\Gamma, \lock, A, \lock \qyields \qvar{A}[\counit{\Gamma, \lock, A}] : A[\counit{\Gamma, \lock, A};\proj{\Gamma, \lock, A}]}
\end{mathpar}

\item[\textsc{crisp-sub-ext}]
\begin{mathpar}
\inferrule*[Left=cut]{
\inferrule*[Left=sub-$\lock$]{
\inferrule*[Left=sub-ext]{\Gamma, \lock \qyields \Theta : \Gamma', \lock \and \Gamma, \lock \yields a : A[\Theta]}{\Gamma, \lock \qyields (\Theta, a) : \Gamma', \lock, A}}
{\Gamma, \lock, \lock \qyields (\Theta, a, \lock) : \Gamma', \lock, A, \lock}}
{\Gamma, \lock \qyields \comult{\Gamma};(\Theta, a, \lock) : \Gamma', \lock, A, \lock}
\end{mathpar}

\item[\textsc{$\flat$-form}]
\begin{mathpar}
\inferrule*[Left=cut]{
\inferrule*[Left=$\Ltype{}$-form]
{\Gamma, \lock \qyields A \TYPE}
{\Gamma, \lock, \lock \qyields \Ltype{A} \TYPE}}
{\Gamma, \lock \qyields \Ltype{A}[\comult{\Gamma}] \TYPE}
\end{mathpar}

\item[\textsc{$\flat$-intro}]
\begin{mathpar}
\inferrule*[Left=cut]
{
\inferrule*[Left=crisp-sub-ext]{\Gamma, \lock \qyields a : A}{\Gamma, \lock \qyields \comult{\Gamma};(\id_{\Gamma, \lock}, a, \lock) : \Gamma, \lock, A, \lock }
\and \inferrule*[left=L-intro]{~}{\Gamma, \lock, A, \lock \qyields \LI{A} : \Ltype{A}[\proj{\Gamma, \lock, A}, \lock]}}
{\Gamma, \lock \qyields \LI{A}[\comult{\Gamma};(\id_{\Gamma, \lock}, a, \lock)] : \Ltype{A}[\proj{\Gamma, \lock, A}, \lock][\comult{\Gamma};(\id_{\Gamma, \lock}, a, \lock)]}
\end{mathpar}
and we see that this is of the right type:
\begin{align*}
&\Ltype{A}[\proj{\Gamma, \lock, A}, \lock][\comult{\Gamma};(\id_{\Gamma, \lock}, a, \lock);] \\
&\equiv \Ltype{A}[\comult{\Gamma};(\id_{\Gamma, \lock}, a, \lock);(\proj{\Gamma, \lock, A}, \lock)] \\
&\equiv \Ltype{A}[\comult{\Gamma};((\id_{\Gamma, \lock}, a;\proj{\Gamma, \lock, A}), \lock)] \\
&\equiv \Ltype{A}[\comult{\Gamma};(\id_{\Gamma, \lock}, \lock)] \\
&\equiv \Ltype{A}[\comult{\Gamma}]
\end{align*}

\item[\textsc{$\flat$-elim}]
Using the above derivations, $\FlatI{\qcrispvar{A}}$ becomes:
\begin{align*}
&\FlatI{\qcrispvar{A}} \\
&\equiv \LI{A[\counit{\Gamma, \lock, A};\proj{\Gamma, \lock, A}]}[\comult{\Gamma, \lock, A};(\id_{\Gamma, \lock, A, \lock}, \qcrispvar{A}, \lock)] \\
&\equiv \LI{A}[(\counit{\Gamma, \lock, A};\proj{\Gamma, \lock, A}) \uparrow A, \lock][\comult{\Gamma, \lock, A};(\id_{\Gamma, \lock, A, \lock}, \qcrispvar{A}, \lock)] \\
&\equiv \LI{A}[\comult{\Gamma, \lock, A};(\id_{\Gamma, \lock, A, \lock}, \qcrispvar{A}, \lock);((\counit{\Gamma, \lock, A};\proj{\Gamma, \lock, A}) \uparrow A, \lock)] \\
&\equiv \LI{A}[\comult{\Gamma, \lock, A};((\id_{\Gamma, \lock, A, \lock}, \qcrispvar{A});((\counit{\Gamma, \lock, A};\proj{\Gamma, \lock, A}) \uparrow A), \lock)] \\
&\equiv \LI{A}[\comult{\Gamma, \lock, A};((\counit{\Gamma, \lock, A};\proj{\Gamma, \lock, A}), \qcrispvar{A}, \lock)] \\
&\equiv \LI{A}[\comult{\Gamma, \lock, A};((\counit{\Gamma, \lock, A};\proj{\Gamma, \lock, A}), \qvar{A}[\counit{\Gamma, \lock, A}], \lock)] \\
&\equiv \LI{A}[\comult{\Gamma, \lock, A};(\counit{\Gamma, \lock, A};(\proj{\Gamma, \lock, A}, \qvar{A}), \lock)] \\
&\equiv \LI{A}[\comult{\Gamma, \lock, A};(\counit{\Gamma, \lock, A}, \lock)] \\
&\equiv \LI{A}
\end{align*}
We can use idempotence now to show:
\begin{align*}
&C[(\counit{\Gamma, \lock, A} ; \proj{\Gamma, \lock, A}), \FlatI{\qcrispvar{A}}] \\
&\equiv C[(\counit{\Gamma, \lock, A} ; \proj{\Gamma, \lock, A}), \LI{A}] \\
&\equiv C[( (\proj{\Gamma, \lock, A}, \lock) ; \counit{\Gamma, \lock}), \LI{A}] \\
&\equiv C[(\proj{\Gamma, \lock, A}, \lock, \LI{A});((\proj{\Gamma, \lock, \lock, \Ltype{A}}; \counit{\Gamma, \lock}) , \qvar{\Gamma,\lock,\lock, \Ltype{A}})] \\
&\equiv C[(\proj{\Gamma, \lock, A}, \lock, \LI{A});(\counit{\Gamma, \lock} \uparrow \Ltype{A}[\comult{\Gamma}])] \\
&\equiv C[\counit{\Gamma, \lock} \uparrow \Ltype{A}[\comult{\Gamma}]][\proj{\Gamma, \lock, A}, \lock, \LI{A}]
\end{align*}
where idempotence is used to show that $\Ltype{A}[\comult{\Gamma}][\counit{\Gamma, \lock}] \equiv \Ltype{A}$.
So we can apply $\mathsf{L}$-elim immediately:
\begin{mathpar}
\inferrule*[Left=cut]{
\inferrule*[Left=L-elim]
{\Gamma, \lock, A, \lock \qyields c : C[\counit{\Gamma, \lock} \uparrow \Ltype{A}[\comult{\Gamma}]][\proj{\Gamma, \lock, A}, \lock, \LI{A}]}
{\Gamma, \lock, \lock, \Ltype{A} \qyields \LE{c} : C[\counit{\Gamma, \lock} \uparrow \Ltype{A}[\comult{\Gamma}]]}}
{\Gamma, \lock, \Ltype{A}[\comult{\Gamma}] \qyields \LE{c}[\comult{\Gamma} \uparrow \Ltype{A}] : C[\counit{\Gamma, \lock} \uparrow \Ltype{A}[\comult{\Gamma}]][\comult{\Gamma} \uparrow \Ltype{A}]}
\end{mathpar}
and one of the triangle equations gives that
\begin{align*}
C[\counit{\Gamma, \lock} \uparrow \Ltype{A}[\comult{\Gamma}]][\comult{\Gamma} \uparrow \Ltype{A}] \equiv C
\end{align*}

\item[\textsc{$\sharp$-form/$\sharp$-intro}] These are identical to $\Rtype{}$-formation and introduction.

\item[\textsc{$\sharp$-elim}] Note that $\Sharptype{A}[\counit{\Gamma, \lock, B}] \equiv \Sharptype{(A[\counit{\Gamma, \lock, B}, \lock])}$. We can then do:
\begin{mathpar}
\inferrule*[Left=cut]{
\inferrule*[Left=R-elim]
{\Gamma, \lock, B, \lock \qyields a : \Sharptype{(A[\counit{\Gamma, \lock, B}, \lock])}}
{\Gamma, \lock, B, \lock, \lock \qyields \SharpE{a} : A[\counit{\Gamma, \lock, B}, \lock]}}
{\Gamma, \lock, B, \lock \qyields \SharpE{a}[\comult{\Gamma, \lock, B}] : A[\counit{\Gamma, \lock, B}, \lock][\comult{\Gamma, \lock, B}]}
\end{mathpar}
and
\begin{align*}
&A[\counit{\Gamma, \lock, B}, \lock][\comult{\Gamma, \lock, B}] \\
&\equiv A[\comult{\Gamma, \lock, B};(\counit{\Gamma, \lock, B}, \lock)] \\
&\equiv A
\end{align*}
\end{enumerate}

\mvrnote{Why was it that our $\flat$-elim was sufficient? Is it $\Pi$-types moving everything to the right and back?}

In the algebraic versions of $\sharp$-form and $\sharp$-elim we demonstrate how a single-variable cohesive context is promoted to the cohesive zone. This is sufficient for the general case in the presence of unit and $\Sigma$-types, by the following lemma:

\begin{lemma}
The two substitutions:
\begin{align*}
\Gamma, A, B, \lock &\qyields \comult{\Gamma, A, B};(((\proj{\Gamma, A, B}, \lock), \qvar{B}[\counit{\Gamma, A, B}]), \lock) &&: \Gamma, A, \lock, B[\counit{\Gamma, A}], \lock \\
\Gamma, A, \lock, B[\counit{\Gamma, A}], \lock &\qyields (\counit{\Gamma, A} \uparrow B), \lock &&: \Gamma, A, B, \lock
\end{align*}
are inverses.
\end{lemma}

For a general cohesive context, we can therefore pack the context into an iterated $\Sigma$-type, apply the $\sharp$ rule, then unpack and repeatedly apply the above Lemma in order to return to a context of the correct form.

\begin{proof}
Checking both directions:
\begin{align*}
&\comult{\Gamma, A, B};(((\proj{\Gamma, A, B}, \lock), \qvar{B}[\counit{\Gamma, A,B}]), \lock);((\counit{\Gamma, A} \uparrow B), \lock) \\
&\equiv \comult{\Gamma, A, B};(((\proj{\Gamma, A, B}, \lock), \qvar{B}[\counit{\Gamma, A,B}]);(\counit{\Gamma, A} \uparrow B), \lock) \\
&\equiv \comult{\Gamma, A, B};(((\proj{\Gamma, A, B}, \lock);\counit{\Gamma, A,B}, \qvar{B}[\counit{\Gamma, A}]), \lock) \\
&\equiv \comult{\Gamma, A, B};((\counit{\Gamma, A, B};\proj{\Gamma, A, B}, \qvar{B}[\counit{\Gamma, A,B}]), \lock) \\
&\equiv \comult{\Gamma, A, B};(\counit{\Gamma, A, B};(\proj{\Gamma, A, B}, \qvar{B}), \lock) \\
&\equiv \comult{\Gamma, A, B};(\counit{\Gamma, A, B}, \lock) \\
&\equiv \id_{\Gamma, A, B, \lock}
\end{align*}
and:
\begin{align*}
&((\counit{\Gamma, A} \uparrow B), \lock);\comult{\Gamma, A, B};(((\proj{\Gamma, A, B}, \lock), \qvar{B}[\counit{\Gamma, A,B}]), \lock) \\
&\equiv \comult{\Gamma, A, \lock, B[\counit{\Gamma, A}]};((\counit{\Gamma, A} \uparrow B), \lock, \lock);(((\proj{\Gamma, A, B}, \lock), \qvar{B}[\counit{\Gamma, A,B}]), \lock) \\
&\equiv \comult{\Gamma, A, \lock, B[\counit{\Gamma, A}]};((\counit{\Gamma, A} \uparrow B), \lock);((\proj{\Gamma, A, B}, \lock), \qvar{B}[\counit{\Gamma, A,B}]), \lock)
\end{align*}
On the inside we have
\begin{align*}
&((\counit{\Gamma, A} \uparrow B), \lock);((\proj{\Gamma, A, B}, \lock), \qvar{B}[\counit{\Gamma, A,B}]) \\
&\equiv ((\counit{\Gamma, A} \uparrow B), \lock);(\proj{\Gamma, A, B}, \lock)), \qvar{B}[\counit{\Gamma, A,B}][((\counit{\Gamma, A} \uparrow B), \lock)]) \\
&\equiv ((\counit{\Gamma, A} \uparrow B);\proj{\Gamma, A, B}) , \lock), \qvar{B}[((\counit{\Gamma, A} \uparrow B), \lock);\counit{\Gamma, A,B}]) \\
&\equiv ((\proj{\Gamma, A, \lock, B[\counit{\Gamma, A}]};\counit{\Gamma, A}), \lock), \qvar{B}[((\counit{\Gamma, A} \uparrow B), \lock);\counit{\Gamma, A,B}]) \\
&\equiv ((\proj{\Gamma, A, \lock, B[\counit{\Gamma, A}]};\counit{\Gamma, A}), \lock), \qvar{B}[\counit{\Gamma, A, \lock, B[\counit{\Gamma, A}]};(\counit{\Gamma, A} \uparrow B)]) \\
&\equiv ((\counit{\Gamma, A, \lock, B[\counit{\Gamma, A}]};\proj{\Gamma, A, \lock, B[\counit{\Gamma, A}]}), \qvar{B}[(\counit{\Gamma, A} \uparrow B)][\counit{\Gamma, A, \lock, B[\counit{\Gamma, A}]}]) \\
&\equiv \counit{\Gamma, A, \lock, B[\counit{\Gamma, A}]}; (\proj{\Gamma, A, \lock, B[\counit{\Gamma, A}]}), \qvar{B}[(\counit{\Gamma, A} \uparrow B)]) \\
&\equiv \counit{\Gamma, A, \lock, B[\counit{\Gamma, A}]}; (\proj{\Gamma, A, \lock, B[\counit{\Gamma, A}]}), \qvar{B[\counit{\Gamma, A}]}) \\
&\equiv \counit{\Gamma, A, \lock, B[\counit{\Gamma, A}]}
\end{align*}
So finally
\begin{align*}
&\comult{\Gamma, A, \lock, B[\counit{\Gamma, A}]};((\counit{\Gamma, A} \uparrow B), \lock);((\proj{\Gamma, A, B}, \lock), \qvar{B}[\counit{\Gamma, A,B}]), \lock) \\
&\equiv \comult{\Gamma, A, \lock, B[\counit{\Gamma, A}]};(\counit{\Gamma, A, \lock, B[\counit{\Gamma, A}]}, \lock) \\
&\equiv \id_{\Gamma, A, \lock, B[\counit{\Gamma, A}], \lock}
\end{align*}
\end{proof}

\subsection{Dependently Indexed Linear Types}

The structural rules of \mvrnote{DILTT} are given by the structural rules for ordinary MLTT and the additional ones in Figure~\ref{fig:qit-linear-structural-rules}. \mvrnote{In term-sub, the notation $\Xi[\Theta]$ is not defined...} Judgements are translated as follows:

\begin{itemize}
\item A context $\qyields \Gamma \CTX$ is represented as in MLTT, by a framework context $\upstairs{\Gamma}$  together with a mode term morphism $\downstairs{\Gamma} \yields \modeof{\Gamma} : p$.
\item A context $\qyields \Gamma \mid \Xi \CTX$ is represented as a framework context $\upstairs{\Gamma}, \upstairs{\Xi}$. DILTT maintains the invariant that all types in the linear zone are well-formed in the intuitionistic context, so the types in $\upstairs{\Xi}$ are all in mode $\El{p}{\modeof{\Gamma}}$. We also require an associated term $\fibshape{\Xi} : \El{p}{\modeof{\Gamma}}$ that describes the shape of the linear zone.
\item A type $\Gamma \qyields A \TYPE$ is represented as in MLTT, by a framework type $\upstairs{\Gamma} \yields_{\El{p}{\modeof{\Gamma}}} \upstairs{A} \TYPE$`.
\item A term $\Gamma \mid \Xi \qyields a : A$ is represented by a framework term $\upstairs{\Gamma}, \upstairs{\Xi} \yields_{\fibshape{\Xi}} \upstairs{a} : \upstairs{A}$.
\item A substitution $\Gamma \qyields \Theta : \Delta$ is represented by a term $\upstairs{\Gamma} \yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\sigma.\modeof{\Delta}[\unpack{\Delta}{\sigma}]}{\upstairs{\Delta}}$, as in MLTT.
\item A linear substitution $\Gamma \mid \Xi \qyields \Theta : \Xi'$ is represented by a framework term $\upstairs{\Gamma}, \upstairs{\Xi} \yields_{\fibshape{\Xi}} \upstairs{\Theta} : \E{\sigma.\fibshape{\Xi'}[\unp{\Xi'}{\sigma}]}{\upstairs{\Xi'}}$.
\end{itemize}

\begin{figure}
\begin{mathpar}
\inferrule*[left=ctx-lin-empty]{\qyields \Gamma \CTX}{\qyields \Gamma \mid \cdot \CTX} \and
\inferrule*[left=ctx-lin-ext]{\qyields \Gamma \mid \Xi \CTX \and \Gamma \qyields A \TYPE}{\qyields \Gamma \mid \Xi, A \CTX} \\
\inferrule*[left=sub-lin-empty]{~}{\Gamma \mid \cdot \qyields \varepsilon_{\Gamma} : \cdot} \and
\inferrule*[left=sub-lin-ext]{\Gamma \mid \Xi \qyields \Theta : \Xi' \and \Gamma \mid \Xi'' \qyields a : A}{\Gamma \mid \Xi, \Xi'' \qyields (\Theta, a) : \Xi', A} \\
\inferrule*[left=sub-lin-id]{~}{\Gamma \mid \Xi \qyields \id_{\Xi} : \Xi} \and
\inferrule*[left=sub-lin-comp]{\Gamma \mid \Xi \qyields \Theta : \Xi' \and \Gamma \mid \Xi' \qyields \kappa : \Xi''}{\Gamma \mid \Xi \qyields (\Theta ; \kappa) : \Xi''} \\
\inferrule*[left=term-sub]{\Delta \mid \Xi \qyields a : A  \and \Gamma \qyields \Theta : \Delta}{\Gamma \mid \Xi[\Theta] \qyields a[\Theta] : A[\Theta]} \and
\inferrule*[left=term-lin-sub]{\Gamma \mid \Xi' \qyields b : B \and \Gamma \mid \Xi \qyields \Theta :  \Xi'}{\Gamma \mid \Xi \qyields b\{\Theta\} : B} \\
\inferrule*[left=var]{~}{\Gamma, A \mid \cdot \qyields \qvar{\Gamma,A} : A[\proj{\Gamma,A}]}  \and
\inferrule*[left=lin-var]{~}{\Gamma \mid A \qyields \qlinvar{A} : A} 
\end{mathpar}
\begin{align}
b\{\id_\Xi\} &\equiv b \\
\id_\Xi;\Theta &\equiv \Theta \\
\Theta;\id_{\Xi'} &\equiv \Theta \\
(\Theta;\kappa);\rho &\equiv \Theta ; (\kappa; \rho) \\
\nonumber \\
\id_{\Xi, A} &\equiv (\id_\Xi, \qlinvar{A}) \\
\qlinvar{A}[\Theta] &\equiv \qlinvar{A[\Theta]}
\end{align}
\caption{Structural Rules for Dependently Indexed Linear Types}\label{fig:qit-linear-structural-rules}
\end{figure}

\begin{enumerate}
\item[\textsc{ctx-lin-empty}] $\Gamma \mid \cdot$ is translated to $\upstairs{\Gamma}$, with $\fibshape{(\cdot)} :\equiv \One_{\modeof{\Gamma}}$.
\item[\textsc{ctx-lin-ext}] $\Gamma \mid \Xi, A$ is translated to $\upstairs{\Gamma}, \upstairs{\Xi}, x : \upstairs{A}$, with $\fibshape{(\Xi, A)} :\equiv \fibshape{\Xi} \otimes x$
\item[\textsc{sub-lin-empty}]  The linear substitution $\Gamma \mid \cdot \qyields \varepsilon_{\Gamma} : \cdot$ is translated the term $\upstairs{\Gamma}, \upstairs{\Xi} \yields_{\One_{\modeof{\Gamma}}} \EI{} : \E{\One_{\modeof{\Gamma}}}{}$
\item[\textsc{sub-lin-ext}] Given translations of $\Gamma \mid \Xi \yields \Theta : \Xi'$ and $\Gamma \mid \Xi'' \qyields a : A$, define $\upstairs{(\Theta, a)}$ to be
\begin{align*}
\upstairs{\Gamma}, \upstairs{\Xi}, \upstairs{\Xi''} \yields_{\downstairs{\Theta}, \fibshape{\Xi} \otimes \fibshape{\Xi''}} \EIs{}{\upstairs{\Theta}, \upstairs{a}} : \E{w. \fst w \otimes \snd w}{\upstairs{\Xi'}, \upstairs{A}}
\end{align*}
\item[\textsc{sub-lin-id}] We use the term $\upstairs{\Gamma}, \upstairs{\Xi} \yields_{\fibshape{\Xi}} \EI{\pack{\Xi}} : \E{\fibshape{\Xi}}{\upstairs{\Xi}}$
\item[\textsc{sub-lin-comp}] This is translated analogously to composition of ordinary substitutions. Given
\begin{align*}
\upstairs{\Gamma}, \upstairs{\Xi} &\yields_{\fibshape{\Xi}} \upstairs{\Theta} : \E{\sigma.\fibshape{\Xi'}[\unp{\Xi'}{\sigma}]}{\upstairs{\Xi'}} \\
\upstairs{\Gamma}, \upstairs{\Xi'} &\yields_{\fibshape{\Xi'}} \upstairs{\kappa} : \E{\sigma.\fibshape{\Xi''}[\unp{\Xi''}{\sigma}]}{\upstairs{\Xi''}}
\end{align*}
we form
\begin{align*}
\upstairs{\Theta;\kappa} :\equiv \EEs{\sigma.\fibshape{\Xi'}[\unp{\Xi'}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{\kappa}[\unp{\upstairs{\Delta}}{\sigma}]}
\end{align*}

\item[\textsc{term-sub}] 
%\begin{align*}
%\upstairs{\Delta}, \upstairs{\Xi} &\yields_{\fibshape{\Xi}} \upstairs{a} : \upstairs{A} \\
%\upstairs{\Gamma} &\yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\sigma.\modeof{\Delta}[\unpack{\Delta}{\sigma}]}{\upstairs{\Delta}}
%\end{align*} 
\mvrnote{Here let's do the case of a single variable in the linear context.}
\begin{align*}
\upstairs{\Delta}, \upstairs{B} &\yields_{\fibshape{B}} \upstairs{a} : \upstairs{A} \\
\upstairs{\Gamma} &\yields_{\modeof{\Gamma}} \upstairs{\Theta} : \E{\sigma.\modeof{\Delta}[\unpack{\Delta}{\sigma}]}{\upstairs{\Delta}}
\end{align*} 
and our goal is:
\begin{align*}
\upstairs{\Gamma}, \upstairs{B[\Theta]} &\yields_{\fibshape{B[\Theta]}} \upstairs{a[\Theta]} : \upstairs{A[\Theta]}
\end{align*}
or expanding definitions,
\begin{align*}
\upstairs{\Gamma}, x : \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{B}[\unp{\Delta}{\sigma}]} &\yields_x \upstairs{a[\Theta]} : \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{A}[\unp{\Delta}{\sigma}]}
\end{align*}
Define:
\begin{align*}
\upstairs{a[\Theta]} :\equiv \EEs{\sigma.\modeof{\Delta}[\unp{\Delta}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{a}[\unp{\Delta}{\sigma}]}
\end{align*}
\item[\textsc{term-lin-sub}] 
\begin{align*}
\upstairs{\Gamma}, \upstairs{\Xi'} &\yields_{\fibshape{\Xi'}} \upstairs{b} : \upstairs{B} \\
\upstairs{\Gamma}, \upstairs{\Xi} &\yields_{\fibshape{\Xi}} \upstairs{\Theta} : \E{\sigma.\fibshape{\Xi'}[\unp{\Xi'}{\sigma}]}{\upstairs{\Xi'}}
\end{align*} 
and our goal is:
\begin{align*}
\upstairs{\Gamma}, \upstairs{\Xi} &\yields_{\fibshape{\Xi}} \upstairs{b} : \upstairs{B}
\end{align*}
Define
\begin{align*}
\upstairs{b\{\Theta\}} :\equiv \EEs{\sigma.\fibshape{\Xi'}[\unp{\Xi'}{\sigma}]}{\upstairs{\Theta}}{\sigma}{\upstairs{b}[\unp{\Xi'}{\sigma}]}
\end{align*}
\item[\textsc{var}] This is translated the same as $\qvar{A}$ in MLTT. This is a term in mode $\One_{\modeof{(\Gamma, A)}}$, i.e., with empty linear context.
\item[\textsc{lin-var}] This is exactly the framework variable rule: $\upstairs{\Gamma}, x : \upstairs{A} \yields_x x : \upstairs{A}$.
\end{enumerate}

Note that terms with empty linear zone always have mode $\One_{\modeof{\Gamma}}$. The translations of the rules for ordinary $\Sigma$-, $\Pi$-, etc.\ types therefore remain valid, so long as they only operate on contexts with empty linear zone. For example:
\begin{mathpar}
\inferrule*[left=$\Sigma$-split]{\Gamma, A, B \mid \cdot \qyields c : C[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \qpair{A,B}]}{\Gamma, \Sigma_A B \mid \cdot \qyields \qsplit{A, B}(c) : C}
\end{mathpar}

\subsubsection{Types in the Fiber}

The linear zone of DILTT can be made to support the ordinary type formers of linear logic. In Figure~\ref{fig:qit-linear-fiber-rules}, the rules for $I$- and $\otimes$-types are given in algebraic style.

\begin{figure}
\begin{mathpar}
\inferrule*[Left=$I$-form]{~}{\Gamma \qyields I_\Gamma \TYPE} \\
\inferrule*[Left=$I$-intro]{~}{\Gamma \mid \cdot \qyields \star_\Gamma : I_\Gamma } \and
\inferrule*[Left=$I$-elim]{\Gamma \mid \Xi \qyields c : C}{\Gamma \mid \Xi, I \qyields \qunitmatch{c} : C} \\
%%%
\inferrule*[Left=$\otimes$-form]{\Gamma \qyields A \TYPE \and \Gamma \qyields B \TYPE}{\Gamma \qyields A \otimes B \TYPE} \\
\inferrule*[Left=$\otimes$-intro]{~}{\Gamma \mid A, B \qyields \otimespair{A,B} : A \otimes B} \and
\inferrule*[Left=$\otimes$-elim]{\Gamma \mid \Xi, A, B \qyields c : C}{\Gamma \mid \Xi, A \otimes B \qyields \otimessplit{c} : C} \\
%%%
\end{mathpar}
\mvrnote{TODO: the other linear type formers? $\multimap, \top, \&, \oplus, 0$}
\caption{Rules for \mvrnote{Types in the Fiber}}\label{fig:qit-linear-fiber-rules}
\end{figure}

For $I$- and $\otimes$-types, the rules are immediate from the framework rules for $\Esym$-types; no unpacking or rewriting is necessary.  \mvrnote{We are using strict associativity/unit here...} \mvrnote{The Vakar paper has strict eta for $I$ and $\otimes$.} Because \textsc{$I$-elim} is non-dependent, it is not necessary for the comprehension object to support the unit type (in the sense of Definition~\ref{def:supports-unit}) in order to interpret the $I$ type.
\begin{align*}
\upstairs{I_\Gamma} :&\equiv \E{\One_{\modeof{\Gamma}}}{1} \\
\upstairs{\star_\Gamma} :&\equiv \EIs{\One_{\modeof{\Gamma}}}{} \\
\upstairs{\qunitmatch{c}} :&\equiv \EEs{\One_{\modeof{\Gamma}}}{z}{}{\upstairs{c}} \\
\upstairs{A \otimes B} :&\equiv \E{w. (\fst w) \otimes_{\modeof{\Gamma}} (\snd w)}{\upstairs{A}, \upstairs{B}} \\
\upstairs{\otimespair{A,B}} :&\equiv \EIs{w. (\fst w) \otimes_{\modeof{\Gamma}} (\snd w)}{\upstairs{a}, \upstairs{b}} \\
\upstairs{\otimessplit{c}} :&\equiv \EEs{w. (\fst w) \otimes_{\modeof{\Gamma}} (\snd w)}{z}{x, y}{\upstairs{c}}
\end{align*}

\subsubsection{Dependent Types}

The rules for $\Sigma!$ and $\Pi!$ in algebraic style are given in Figure~\ref{fig:qit-linear-dependent-rules}. Rules such as $\Sigma!$-elim and $\Pi!$-intro are presented with only a single linear type $\Xi$ in the linear context. In the presence of $I$- and $\otimes$-types, we may pack a more general linear context into a single iterated $\otimes$-type, apply the rule, then unpack the $\otimes$-type.

\begin{theorem}
The rules for $\Sigma!$-types can be interpreted over any mode theory
containing a comprehension object that supports $\Sigma!$-types
(Definition \ref{def:supports-sigma-bangs}),
if
the strict modalities for composites of $\sdot$ and $\sempty$ exist, and
for all $\alpha : p$,
the $\mathsf{F}$-type for $z : \sigmacl{x}{\El p \alpha}{\El p
  {\alpha.x}} \vdash \Sigma!(\alpha,\fst z, \snd z)$ exists.
\end{theorem}

\begin{figure}
\begin{mathpar}
%\inferrule*[Left=$!$-form]{\Gamma \qyields A \TYPE}{\Gamma \qyields \bang A \TYPE} \\
%\inferrule*[Left=$!$-intro]{~}{\Gamma, A \mid \cdot \qyields \qbang{A} : \bang A[\proj{\Gamma, A}]} \and
%\inferrule*[Left=$!$-elim]{\Gamma, A \mid \Xi[\proj{\Gamma, A}] \qyields c : C[\proj{\Gamma, A}]}{\Gamma \mid \Xi, \bang A \qyields \letbang{c} : C} \\
%%%
\inferrule*[Left=$\Sigma!$-form]{\Gamma \qyields A \TYPE \and \Gamma, A \qyields B \TYPE}{\Gamma \qyields \Sigma!_A B \TYPE } \\
\inferrule*[Left=$\Sigma!$-intro]{~}{\Gamma, A \mid B \qyields \linpair{A,B} : \Sigma!_A B [\proj{\Gamma, A}]} \and
\inferrule*[Left=$\Sigma!$-elim]{\Gamma, A \mid \Xi[\proj{\Gamma, A}], B \qyields c : C[\proj{\Gamma, A}]}{\Gamma \mid \Xi, \Sigma!_A B \qyields \linsplit{c} : C} \\
%%%
\inferrule*[Left=$\Pi!$-form]{\Gamma \qyields A \TYPE \and \Gamma, A \qyields B \TYPE}{\Gamma \qyields \Pi!_A B \TYPE } \\
\inferrule*[left=$\Pi!$-intro]{\Gamma, A \mid \Xi[\proj{\Gamma, A}]\qyields b : B}{\Gamma \mid \Xi \qyields \linlam(b) : \Pi!_A B} \and
\inferrule*[left=$\Pi!$-elim]{~}{\Gamma, A \mid (\Pi_A B)[\proj{\Gamma, A}] \qyields \linapp{A, B} : B}
\end{mathpar}
\mvrnote{TODO: equations}
\caption{Rules for Dependently Indexed Linear Types}\label{fig:qit-linear-dependent-rules}
\end{figure}

%\begin{enumerate}
%\item[\textsc{$!$-form}]
%\item[\textsc{$!$-intro}] We want:
%\begin{align*}
%\upstairs{\Gamma}, x : \upstairs{A} \yields_{\One_{\modeof{\Gamma}.x}} \upstairs{\qbang{A}} : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{\bang A}}
%\end{align*}
%
%\item[\textsc{$!$-elim}] The translation of the provided term has type:
%\begin{align*}
%\upstairs{\Gamma}, x : \upstairs{A}, \xi : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{\Xi}} \yields_\xi \upstairs{c} : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{C}}
%\end{align*}
%\begin{mathpar}
%\inferrule*[Left=F-elim]{
%\inferrule*[Left=rewrite]{
%\inferrule*[Left=s-elim]{
%\inferrule*[Left=cut]{
%\upstairs{\Gamma}, x : \upstairs{A}, \xi : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{\Xi}} \yields_\xi \upstairs{c} : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{C}}}
%{\upstairs{\Gamma}, x : \upstairs{A}, \xi : \upstairs{\Xi} \yields_{\TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}} \upstairs{c}[\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}/\xi] : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{C}}
%}\and
%\upstairs{\Gamma}, x : \upstairs{A}, z : \upstairs{C} \yields_{\Sigma!(x, \TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{z})} \rewrite{\linwk{x,z}}{z} : \upstairs{C}}
%{\upstairs{\Gamma}, x : \upstairs{A}, \xi : \upstairs{\Xi}, y : \upstairs{B} \yields_{\Sigma!(x, \TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi} \otimes y)} \StE{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{c}[\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}/\xi]}{z}{\rewrite{\linwk{x,z}}{z}} : \upstairs{C} }}
%{\upstairs{\Gamma}, x : \upstairs{A}, \xi : \upstairs{\Xi}, y : \upstairs{B} \yields_{\xi \otimes \Sigma!(x, y)} \rewrite{\frob{\xi,x,y}}{\StE{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{c}[\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}/\xi]}{z}{\rewrite{\linwk{x,z}}{z}}} : \upstairs{C}}}
%{\upstairs{\Gamma}, \xi : \upstairs{\Xi}, z : \upstairs{\Sigma!_A B} \yields_{\xi \otimes z} \FE{z}{x,y}{\rewrite{\frob{\xi,x,y}}{\StE{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{c}[\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}/\xi]}{z}{\rewrite{\linwk{x,z}}{z}}}} : \upstairs{C}}
%\end{mathpar}
%\end{enumerate}

\begin{enumerate}
\item[\textsc{$\Sigma!$-form}] The same as for $\Sigma$-types:
\begin{align*}
\upstairs{\Sigma!_A B} :\equiv \F{w. \Sigma!(\fst w, \snd w)}{\upstairs{A}, \upstairs{B}}
\end{align*}

\item[\textsc{$\Sigma!$-intro}] We want a term
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_y \upstairs{\linpair{A,B}} : \TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{\Sigma!_A B}}
\end{align*}
And we can produce such a term by:
\begin{mathpar}
\inferrule*[Left=rewrite]{
\inferrule*[Left=s-intro]{
\inferrule*[Left=F-intro]{~}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\Sigma!(x,y)} \FI{x,y} : \upstairs{\Sigma!_A B}}}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\Sigma!(x,y)}} \StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\FI{x,y}} : \TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{\Sigma!_A B}}}}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_y \rewrite{\linsnd{x,y}}{\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\FI{x,y}}} : \TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{\Sigma!_A B}}}
\end{mathpar}

\item[\textsc{$\Sigma!$-elim}]
The translation of the provided term has type:
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A}, \xi : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{\Xi}}, y : \upstairs{B} \yields_{\xi \otimes y} \upstairs{c} : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{C}}
\end{align*}
So use:
\begin{mathpar}
\inferrule*[Left=F-elim]{
\inferrule*[Left=rewrite]{
\inferrule*[Left=s-elim]{
\inferrule*[Left=cut]{
\upstairs{\Gamma}, x : \upstairs{A}, \xi : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{\Xi}}, y : \upstairs{B} \yields_{\xi \otimes y} \upstairs{c} : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{C}}}
{\upstairs{\Gamma}, x : \upstairs{A}, \xi : \upstairs{\Xi}, y : \upstairs{B} \yields_{\TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi} \otimes y} \upstairs{c}[\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}/\xi] : \St{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{C}}
}\and
\upstairs{\Gamma}, x : \upstairs{A}, z : \upstairs{C} \yields_{\Sigma!(x, \TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{z})} \rewrite{\linwk{x,z}}{z} : \upstairs{C}}
{\upstairs{\Gamma}, x : \upstairs{A}, \xi : \upstairs{\Xi}, y : \upstairs{B} \yields_{\Sigma!(x, \TrPlus{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi} \otimes y)} \StE{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{c}[\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}/\xi]}{z}{\rewrite{\linwk{x,z}}{z}} : \upstairs{C} }}
{\upstairs{\Gamma}, x : \upstairs{A}, \xi : \upstairs{\Xi}, y : \upstairs{B} \yields_{\xi \otimes \Sigma!(x, y)} \rewrite{\frob{\xi,x,y}}{\StE{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{c}[\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}/\xi]}{z}{\rewrite{\linwk{x,z}}{z}}} : \upstairs{C}}}
{\upstairs{\Gamma}, \xi : \upstairs{\Xi}, z : \upstairs{\Sigma!_A B} \yields_{\xi \otimes z} \FE{z}{x,y}{\rewrite{\frob{\xi,x,y}}{\StE{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\upstairs{c}[\StI{\ApEl{p}{\pi^{\modeof{\Gamma}}_x}}{\xi}/\xi]}{z}{\rewrite{\linwk{x,z}}{z}}}} : \upstairs{C}}
\end{mathpar}
\mvrnote{This is simpler with a non-frobenius eliminator, worth writing that out too?}
\end{enumerate}

As with $\Pi$-types, set
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, c : \El{p}{\alpha} \yields \Pi_1(\alpha,x,c) :\equiv \TrPlus{\ApEl{p}{\pi^\alpha_x}}{c} : \El{p}{\alpha.x}
\end{align*}

\begin{theorem}
The rules for $\Pi!$-types can be interpreted over any mode theory with a
comprehension object if
the strict modalities for composites of $\sdot$ and $\sempty$ exist, and
for each $\alpha : p$, the $\mathsf{U}$-types for $x:\El{p} \alpha, c:\El{p}{\alpha} \vdash \Pi_1(\alpha,x,c)$ exist.
\end{theorem}

\begin{enumerate}
\item[\textsc{$\Pi!$-form}] The same as for $\Pi$-types:
\begin{align*}
\upstairs{\Pi!_A B} :\equiv \F{w. \Pi!(\fst w, \snd w)}{\upstairs{A}, \upstairs{B}}
\end{align*}

\item[\textsc{$\Pi!$-intro}]
\begin{mathpar}
\inferrule*[Left=U-intro]{
\inferrule*[Left=cut]{\upstairs{\Gamma}, x : \upstairs{A}, \xi : \upstairs{\Xi[\proj{\Gamma, A}]} \yields_\xi \upstairs{b} : \upstairs{B}}
{\alpha : \upstairs{\Gamma}, x : \upstairs{A}, \xi : \upstairs{\Xi} \yields_{\TrPlus{\ApEl{p}{\pi^\alpha_x}}{\xi}} \upstairs{b}[\StI{\ApEl{p}{\pi^\alpha_x}}{\xi}/\xi] : \upstairs{B}}}
{\alpha : \upstairs{\Gamma}, \xi : \upstairs{\Xi} \yields_\xi \UI{x}{\upstairs{b}[\StI{\ApEl{p}{\pi^\alpha_x}}{\xi}/\xi]} : \upstairs{\Pi!_A B}}
\end{mathpar}

\item[\textsc{$\Pi!$-elim}]
\begin{mathpar}
\inferrule*[Left=s-elim]{
\inferrule*[Left=U-elim]{~}
{\alpha : \upstairs{\Gamma}, x : \upstairs{A}, f : \upstairs{\Pi!_A B} \yields_{\TrPlus{\ApEl{p}{\pi^\alpha_x}}{f}} \UE{f}{x} : \upstairs{B}}}
{\alpha : \upstairs{\Gamma}, x : \upstairs{A}, g : \St{\ApEl{p}{\pi^\alpha_x}}{\upstairs{\Pi!_A B}} \yields_g \StE{\ApEl{p}{\pi^\alpha_x}}{g}{f}{\UE{f}{x}} : \upstairs{B}}
\end{mathpar}
\end{enumerate}

\section{Semantics}
\label{sec:semantics}

\subsection{2-categories with families}
\label{sec:2cwfs}

Ignoring fibrancy for now, the ``canonical'' semantics should interpret each judgment as follows:

Mode theory judgements:
\begin{enumerate}
\item $\mm{\gamma \ctx}$ is a category.
\item $\mm{\gamma \yields p \type}$ is a functor $\mm{\gamma}\op \to \Cat$.
\item $\mm{\TypeTwo{\gamma}{s}{p}{q}}$ is a natural transformation $\mm{\gamma \yields q} \Rightarrow \mm{\gamma \yields p}$ (note reversal of direction; this is because mode morphisms act contravariantly on mode terms and on upstairs subscripts).
\item $\mm{\gamma \yields \mu : p}$ is a section of the projection from the Grothendieck construction $\int\mm{\gamma\yields p} \to \mm{\gamma}$.
  In particular, it assigns to every object $x\in \mm{\gamma}$ an object $\mm{\gamma \yields \mu : p}(x)\in \mm{\gamma\yields p}(x)$.
\item $\mm{\TermTwoT{\gamma}{s}{\mu}{\nu}{p}}$ is a natural transformation of such sections over the identity, i.e.\ whose composite with the projection is the identity natural transformation of the identity functor.
\end{enumerate}

Top judgements: 
\begin{itemize}
\item $\mm{\yields_\gamma \Gamma \CTX}$ is an object of $\mm{\gamma}$
\item $\mm{\Gamma \yields_p A \TYPE}$ is an object of $\mm{\gamma \yields p}(\mm{\Gamma})$.
\item $\mm{\Gamma \yields_\mu M : A}$ is a morphism from $\mm{\gamma \yields \mu : p}(\mm{\Gamma})$ to $\mm{\Gamma \yields_p A}$ in $\mm{\gamma \yields p}(\mm{\Gamma})$.
\end{itemize}

Total substitutions in the mode theory, 2-cells between them, and
upstairs substitutions above them are not part of the primitive syntax
of the framework, but can be defined by tupling terms.
These can be interpreted as: 
\begin{itemize}
\item $\mm{\gamma \yields \theta : \delta}$ is a functor from $\mm{\gamma}$ to $\mm{\delta}$
\item $\mm{\gamma \yields \theta_1 \tcell_\delta \theta_2}$ is a natural
  transformation from $\mm{\gamma \yields \theta_1 : \delta}$ to
  $\mm{\gamma \yields \theta_2 : \delta}$
\item $\mm{\Gamma_{\gamma} \yields_\theta \Theta : \Delta_\delta}$ is a
  morphism from $\mm{\theta}(\mm{\Gamma})$ to $\mm{\Delta}$ in
  $\mm{\delta}$.
  Natural transformations act contravariantly because $\theta$ is in the
  domain of the morphism.  
  \end{itemize}
So the semantics of contexts/substitutions is a lot like 
one-variable adjoint logic with only $F$ types (\cite{ls16adjoint-extended}).

The general categorical semantics is an abstraction of these structures --- categories, contravariant $\Cat$-valued functors, Grothendieck constructions, sections, natural transformations, objects, and morphisms.
In this subsection we will concern ourselves only with the ``downstairs'' mode theory, which means abstracting the behavior of Grothendieck constructions in $\Cat$; in \S\ref{sec:fib-2cwf} we will reintroduce the ``upstairs'' type theory by additionally abstracting the behavior of ``objects and morphisms''.

We will ignore size issues, writing as if for instance $\Cat\in\Cat$.
The reader can easily insert meta-level universe distinctions for consistency.

\begin{enumerate}
\item Categories form a 2-category.
  In general we will stipulate an arbitrary (strict) 2-category $\M$.
\item Given a category $C$, the collection of functors and (strict) natural transformations $C\op \to \Cat$ forms a category $[C\op, \Cat]$, and if we reverse the directions of the natural transformations we get $[C\op, \Cat]\op$.
  Moreover, precomposition with functors $C\to C'$ and natural transformations between them makes $[(-)\op, \Cat]\op$ into a strict 2-functor $\Cat\op \to \Cat$.
  Syntactically, the actions of the functor $[(C')\op, \Cat]\op \to [C\op,\Cat]\op$ induced by $\mu:C\to C'$ are $q[\mu/x]$ and $s[\mu/x]$, while the components of a natural transformation $t:\mu\Rightarrow\mu'$ are $\ap{q}{\mu/x}$.
  Note this 2-functor is covariant on 2-cells: the two $(-)\op$s cancel each other out at that level.
  (In fact, this 2-functor can be identified with the representable $[-,\Cat\op]$; this will be useful below.)

  Thus, in general we will stipulate a strict 2-functor $\Mty:\M\op \to \Cat$.
\item Given a category $C$ and a functor $T:C\op\to \Cat$, the sections of the projection $\int T \to C$, and natural transformations over the identity, form a category.
  Moreover, such sections also vary functorially as $C$ does.
  Thus, in general we will stipulate another strict 2-functor $\Mtm : \M\op\to\Cat$ with a strictly 2-natural projection map $\Mtm\to\Mty$.
\item The contravariant action of mode morphisms $\TypeTwo{\gamma}{s}{p}{q}$ on mode terms tells us that the morphisms of $\Mty(C)$ must act on the objects of $\Mtm$ contravariantly.
  Moreover, this action is strictly functorial, and respected by substitution.
  Thus, we stipulate that $\Mtm \to \Mty$ is a \emph{split fibration} internal to the 2-category $[\M\op,\Cat]$, which means that each functor $\Mtm(C) \to \Mty(C)$ is a split fibration and that all the naturality squares
  \begin{center}
    \begin{tikzcd}
      \Mtm(C) \ar[d] \ar[r] & \Mtm(C')\ar[d] \\
      \Mty(C) \ar[r] & \Mty(C')
    \end{tikzcd}
  \end{center}
  are strict morphisms of split fibrations (preserve the splittings on the nose).
\item To represent the Grothendieck construction $\int T$ itself, we stipulate that this projection is additionally a \emph{representable morphism} in that for any $C\in \M$, with corresponding representable functor $\yon C(-) = \M(-,C) : \M\op\to\Cat$, if we form the pullback in $[\M\op,\Cat]$
  \begin{equation}
    \begin{tikzcd}
      \bullet \ar[d] \ar[r] \ar[dr,phantom,near start,"\lrcorner"] & \Mtm \ar[d] \\
      \yon C \ar[r,"{T}"'] & \Mty
    \end{tikzcd}\label{eq:rep-pb}
  \end{equation}
  then the pullback object is also of the form $\yon(C\ce T)$ for some object $C\ce T\in \M$.
  (The notation $C\ce T$, rather than $\int T$, suggests context extension.)
  The Yoneda lemma implies that (strict) 2-natural transformations ${T} : \yon C \to \Mty$ are in bijection with objects $T\in \Mty(C)$; thus every $T\in \Mty(C)$ induces an object $C\ce T$ with a projection $C\ce  T \to C$ in $\M$, such that elements of $\Mtm(C)$ over $T$ are in bijection with sections of this projection.
  To make the notion algebraic, we require the object $C\ce  T$ to be a specified function of $C$ and $T$; we call this being \textbf{algebraically representable}.

  Since~\eqref{eq:rep-pb} is a pullback in a 2-category, it also has a universal property for 2-cells.
  Thus, morphisms in $\Mtm$ (over the identity in $\Mty$) are in bijection with 2-cells between sections (over the identity).

  The 2-categorical Yoneda lemma also says that morphisms $\mu : S\to T$ in $\Mty(C)$ correspond bijectively to modifications between strict 2-natural transformations ${\mu}:{S} \to {T} : \yon C \to \Mty$.
  Since $\Mtm\to\Mty$ is a fibration, such a ${\mu}$ induces a map in the other direction $C\ce  \mu : C\ce  T\to C\ce  S$ (see Hermida, Buckley, Johnstone), such that postcomposing with $C\ce  \mu$ corresponds to the split (contravariant) fibrational action of $\mu$ on elements of $\Mtm$.
\end{enumerate}

Thus, the entire mode theory except for 1- and $\Sigma$-modes is encapsulated semantically by:

\begin{definition}
  A \textbf{2-category with families} is a 2-category $\M$ having a terminal object, together with two 2-functors $\Mty,\Mtm : \M\op\to\Cat$ and a 2-natural transformation $\Ups:\Mtm\to \Mty$ that is both (1) an internal split fibration and (2) algebraically representable.
\end{definition}

Pleasingly, this is a straightforward categorification of the standard notion of category with families (in its ``natural model'' formulation~\cite{awodey:natural-models}).
The only really new ingredient is the requirement that $\Mtm\to \Mty$ be an internal fibration, which has no analogue for 1-categories.
We write the terminal object as $\ec$ (the empty context).

\begin{example}\label{eg:syn-2cwf}
  Let $\M$ be the 2-category whose:
  \begin{itemize}
  \item objects are mode contexts $\gamma \ctx$,
  \item morphisms are total mode substitutions $\gamma \yields \theta : \delta$, and
  \item 2-cells are total mode 2-cells $\gamma \yields_\delta \theta_1 \tcell \theta_2$.
  \end{itemize}
  We define $\Mty:\M\op\to\Cat$ such that
  \begin{itemize}
  \item the objects of $\Mty(\gamma)$ are modes $\gamma \yields p\type$, and
  \item the morphisms of $\Mty(\gamma)$ are mode morphisms $\TypeTwo{\gamma}{s}{p}{q}$,
  \item with functorial action by substitution.
  \end{itemize}
  Finally, we define $\Mtm:\M\op\to\Cat$ such that
  \begin{itemize}
  \item the objects of $\Mtm(\gamma)$ are mode terms $\gamma \yields \mu:p$, and
  \item the morphisms of $\Mtm(\gamma)$ are mode 2-cells $\TermTwoT{\gamma}{s}{\mu}{\nu}{p}$,
  \item with functorial action by substitution.
  \end{itemize}
  The projection $\Ups:\Mtm\to\Mty$ is clear.
  Its representability is given, as usual, by context extension $(\gamma, x:p) \ctx$; the universal property follows from the definition of total substitutions and 2-cells as tuples.
  The split fibration structure is given by the contravariant action of mode morphisms on mode terms ${\gamma \yields \TrPlus{s}{\mu} : p}$.
  We call this the \textbf{syntactic model}; as mentioned above, so far it only sees the ``downstairs'' mode theory.
\end{example}

The ruminations above suggest that there should be a 2-category with families where $\M=\Cat$ and $\Mty(C) = [C\op,\Cat]\op$.
We call this the \textbf{canonical model}; we will construct it formally in Section \ref{sec:2cwf-univ}.

Now we add the unit and $\Sigma$ modes.
The unit is easy:

\begin{definition}
  A 2-category with families has a \textbf{unit type} if there is an element $1\in \Mty(\ec)$ such that $\ec\ce 1$ is a terminal object of $\M$.
\end{definition}

As preparation for $\Sigma$-modes, given a 2-category with families $\M$, define $\MtySig:\M\op\to\Cat$ by:
\begin{itemize}
\item The objects of $\MtySig(C)$ are pairs of $T_1\in \Mty(C)$ and $T_2 \in \Mty(C\ce T_1)$.
\item Its morphisms are pairs of a morphism $f_1: T_1 \to T_1'$ in $\Mty(C)$, which induces a morphism $C\ce f_1 : C\ce T_1' \to C\ce T_1$ in the opposite direction by the fibration structure, and a morphism $f_2 : (C\ce f_1)^*(T_2) \to T_2'$.
\item The 2-functorial action is induced by that of $\Mty$.
\end{itemize}
(This is the dependent exponential of $\Mty$ along $\Upsilon$, but we will not need that fact.)
We have a projection $\pi_1 : \MtySig \to \Mty$ that picks out $T_1$.
The pullback $\MtySig \times_{\Mty} \Mtm$ has objects over $C$ given by triples of $T_1\in \Mty(C)$, $t_1 \in \Mtm(C)$ over $T_1$, and $T_2 \in \Mty(C\ce T_1)$.
Note that $t_1$ comprehends to a section $C\ce t_1 : C \to C \ce T_1$, so that $(C\ce t_1)^*(T_2) \in \Mty(C)$.
This gives another projection $\pi_2 : \MtySig \times_{\Mty} \Mtm \to \Mty$, along which we can once again pull back $\Upsilon : \Mtm\to\Mty$.

\begin{definition}
  A 2-category with families has \textbf{$\Sigma$-types} it is equipped with horizontal maps such that the square
  \begin{center}
    \begin{tikzcd}
      \MtySig \times_{\Mty} \Mtm \times_{\Mty} \Mtm \ar[r] \ar[d,->>] & \Mtm \ar[dd,->>]\\
      \MtySig \times_{\Mty} \Mtm \ar[d,->>] \\
      \MtySig \ar[r] & \Mty
    \end{tikzcd}
  \end{center}
  (1) commutes, (2) is a pullback, and (3) is a strict morphism of split fibrations.
\end{definition}

\begin{example}\label{eg:syn-sig}
  Continuing Example \ref{eg:syn-2cwf}, we argue that the syntactic model has $\Sigma$-types in this sense if and only if it has $\Sigma$-modes (i.e.\ telescopes, Section~\ref{sec:base-telescopes}) in the syntactic sense.
  By definition of $\MtySig$, the bottom morphism $\MtySig \to \Mty$ assigns to any pair of mode types $\gamma\yields p\type$ and $\gamma,x:p \yields q \type$, a mode type $\gamma \yields \sigmacl{x}{p}{q} \type$.
  The top morphism similarly assigns to any pair of mode terms $\gamma \yields \mu : p$ and $\gamma \yields \nu : q[\mu/x]$ a mode term $(p,q):\sigmacl{x}{p}{q}$.
  The fact that the square is a pullback (on objects) means that we have $\fst$ and $\snd$ collectively forming an inverse isomorphism, i.e.\ the $\beta$- and $\eta$-rules hold for $\Sigma$-modes.

  The action of the bottom map on morphisms gives the congruence rules for $\Sigma$ on mode type morphisms, along with its functoriality laws (since this map over each $\gamma$ is a functor) and its naturality law for substitution (since this map is a natural transformation as $\gamma$ varies).
  Similarly, the action of the top map on morphisms gives the 2-cell operation on $\Sigma$-modes (although the latter is currently written to only apply when one of the morphisms being paired is cartesian), and the fact that the square is a pullback on morphisms gives the $\beta$- and $\eta$-rules for these.

  Finally, the fact that this square is a strict morphism of split fibrations gives the equation for ``transport'' in $\Sigma$.
\end{example}


\subsection{Fibered 2-categories with families}
\label{sec:fib-2cwf}

As in our previous work, with the 2-categorical analogue of the downstairs mode theory in place, the upstairs type theory corresponds to a ``local fibration'' over it.
To define this, we first need to talk about morphisms between 2-categories with families.

Note that any 2-functor $\vp:\C\to\M$ induces a left Kan extension $\vpsh : [\C\op,\Cat] \to [\M\op,\Cat]$, with a right adjoint $\vpst$ defined by precomposition, $\vpst(X)(C) = X(\vp(C))$.

\begin{definition}\label{defn:mor-2cwu}
  Let $(\C,\Cty,\Ctm)$ and $(\M,\Mty,\Mtm)$ be two 2-categories with families.
  A \textbf{morphism of 2-categories with families} consists of:
  \begin{enumerate}
  \item A 2-functor $\vp:\C\to\M$.
  \item A strict morphism of split fibrations in $[\C\op,\Cat]$:
    \begin{equation}
      \begin{tikzcd}
        \Ctm \ar[d] \ar[r] & \vpst \Mtm \ar[d] \\
        \Cty \ar[r] & \vpst \Mty
      \end{tikzcd}\label{eq:mor2cwfsq}
    \end{equation}
  \item This morphism furthermore ``preserves the algebraic representations'' in the following sense: given $C\in \C$ and $T:C \to \Cty$, with specified pullback $C\ce T$, the composite square
    \begin{equation}
      \begin{tikzcd}
        \mathllap{\yon \vp (C\ce T) \cong \;}\vpsh \yon (C\ce T) \ar[r] \ar[d] & \vpsh \Ctm \ar[r] \ar[d] & \Mtm \ar[d]\\
        \mathllap{\yon \vp C \cong \;}\vpsh \yon C \ar[r,"\vpsh(T)"'] & \vpsh \Cty \ar[r,"{\vpty}"'] & \Mty
      \end{tikzcd}\label{eq:mor-presrep}
    \end{equation}
    (where the right-hand square is the adjunct of~\eqref{eq:mor2cwfsq})
    is also a specified pullback, i.e.\ $\vp(C\ce T) = \vp(C)\ce(\vpty(\vpsh(T)))$ with all the associated structure also coinciding.\msnote{Refer to Clive's thesis for the natural-models formulation of morphisms of 1-CwFs}
  \end{enumerate}
\end{definition}

\begin{definition}\label{thm:2cwf-ldf}
  A \textbf{local discrete fibration of 2-categories with families} is a morphism of 2-categories with families $\vp : \C\to\M$ such that
  \begin{enumerate}
  \item $\vp$ preserves the terminal object.
  \item The 2-functor $\vp:\C\to\M$ is a local discrete fibration, i.e.\ the induced functors on hom-categories $\C(X,Y) \to \M(\vp(X),\vp(Y))$ are discrete fibrations.\footnote{If they were non-discrete fibrations, there would be an additional compatibility condition on composition, but in the discrete case this is automatic.}\label{item:ldf1}
  \item The horizontal morphisms in~\eqref{eq:mor2cwfsq} are discrete fibrations.\label{item:ldf2}
  \end{enumerate}
\end{definition}

\begin{example}\label{eg:syn-fib-2cwf}
  Returning to Example \ref{eg:syn-2cwf}, we construct a local discrete fibration over the syntactic model $\M$, now using the ``upstairs'' type theory.
  \begin{itemize}
  \item An object of $\C$ is a context $\yields_\gamma \Gamma \CTX$.
    Of course, its image in $\M$ is $\yields \gamma \ctx$.
  \item A morphism in $\C$ is a total substitution $\Gamma_{\gamma} \yields_\theta \Theta : \Delta_\delta$, lying over $\gamma \yields \theta : \delta$.
  \item The fibrational action of 2-cells in $\M$ on morphisms in $\C$ is given by N-ary rewrite (Lemma \ref{lem:n-ary-ap-rewrite}).
  \item An object of $\Cty(\Gamma)$ is a type $\Gamma_\gamma \yields_p A \TYPE$, lying over $\gamma \yields p\type$ in $\Mty(\gamma) = \Mty(\vp(\Gamma))$.
    The fibrational action of morphisms in $\Mty$ is given by the $\St{s}{A}$ types.
  \item An object of $\Ctm(\Gamma)$ over $A\in \Cty(\Gamma)$ is a term $\Gamma_\gamma \yields_\mu M:A_p$, lying over $\gamma \yields \mu:p$ in $\Mtm$.
    To act on such a term by a morphism in $\Mtm(\gamma)$, we first factor the latter morphism as a mode 2-cell in a fiber $\TermTwoT{\gamma}{s}{\mu}{\TrPlus{t}{\nu}}{p}$ followed by the cartesian arrow corresponding to the action of a mode morphism $\TypeTwo{\gamma}{t}{p}{q}$ on $\nu$.
    The cartesian morphism then acts on $M$ by S-intro, $\StI{t}{M} : \St{t}{A}$, and then we rewrite with the fiber 2-cell $\rewrite{s}{\StI{t}{M}}$.
  \end{itemize}
\end{example}

Note that we are using the strict modalities $\St{s}{A}$ over mode type morphisms, but not the more general ones $\E{x.\mu}{A}$ over arbitrary mode terms.

If $\C$ and $\M$ have $\Sigma$-types, there is an obvious sense to saying that $\vp$ \textbf{preserves} them.
We can then show similarly that in the syntactic model, $\M$ and $\C$ have and $\vp$ preserves $\Sigma$-types just when the mode theory has $\Sigma$-types and the upstairs theory has telescope types over these.


\subsection{Families from universes}
\label{sec:2cwf-univ}

We now construct the canonical model, as a special case of a ``universe'' construction (a categorification of Voevodsky's).

\begin{theorem}\label{thm:2cwf-univ}
  Let $\M$ be a 2-category with (specified) pullbacks and a terminal object, and $\pi:\Ub\to\Un$ be an internal split fibration in $\M$.
  Then defining
  \[ \Mty(C) = \M(C,\Un) \qquad \Mtm(C) = \M(C,\Ub) \]
  yields a 2-category with families.
\end{theorem}
\begin{proof}
  Split fibrations are preserved by the Yoneda embedding, and any morphism between representable objects is a representable morphism; specified pullbacks in $\M$ yield specified representing objects in $[\M\op,\Cat]$.
\end{proof}

We can then restrict to any full sub-2-category of $\M$ that contains the terminal object and is closed under comprehension, such as to reduce the meta-level universe size.
The \emph{smallest} such full sub-2-category would be a sort of ``contextual 2-category''.

\begin{example}\label{eg:canon-2cwf}
  Let $\M =\Cat$ and $\Un= \Cat\op$, with $\Ub$ the Grothendieck construction of the identity functor $\Cat \to \Cat$ regarded as a contravariant functor from $\Cat\op$ to $\Cat$.
  Then $\pi:\Ub\to\Un$ is a split fibration, and of course $\Cat$ has pullbacks.
  Thus Theorem~\ref{thm:2cwf-univ} yields a 2-category with families, which we call the \textbf{canonical model}.

  We can unravel the definition of the canonical model more explicitly to see that it coincides with our intuitive description at the beginning of Section~\ref{sec:semantics}.
  Since $\M=\Cat$, the mode contexts are categories, the total mode substitutions are functors, and the 2-cells between them are natural transformations.
  Since $\Mty(\gamma) = \M(\gamma,\Cat\op)$, the mode types in context $\gamma$ are 2-functors $\gamma \to \Cat\op$, which are bijective with 2-functors $\gamma\op\to\Cat$.
  Similarly, the mode type morphisms are natural transformations between 2-functors $\gamma \to \Cat\op$, which are bijective with natural transformations between 2-functors $\gamma\op\to\Cat$ but in the reversed direction.

  The pullback of $\pi:\Ub\to\Un$ along a functor $p:\gamma\to\Un=\Cat\op$ can be verified to be isomorphic to the usual Grothendieck construction of $T$.
  Thus mode terms $\gamma\vdash \mu:p$, being lifts of $p$ to $\Ub$, are in bijection with sections of this Grothendieck construction, and likewise for morphisms between them (that lie over identities).
  The action $\TrPlus{s}{\mu}$ comes from the split fibration structure on $\pi$, which is to say simply the componentwise action of the natural transformation $s$ on objects of categories.
\end{example}

\begin{theorem}\label{thm:fib2cwf-univ}
  Let $\M$ be a 2-category with (specified) pullbacks and a terminal object, $\pi:\Ub\to\Un$ be an internal split fibration in $\M$, and $\one$ an arbitrary object of $\M$. % equipped with a map $\top : \one \to \Ub$.
  Let $\C = \one\lslice\M$ be the lax slice 2-category of $\M$ under $\one$: its objects are morphisms $a:\one\to A$ in $\M$, its morphisms are 2-cells inhabiting triangles
  \begin{equation}\label{eq:laxslice-mor}
    \begin{tikzcd}
      & \one \ar[dl,"a"'] \ar[dr,"b"] \ar[d,phantom,"\overset{\phi}{\Rightarrow}"] \\
      A \ar[rr,"f"'] & {}& B
    \end{tikzcd}
  \end{equation}
  and its 2-cells $(f,\phi) \to (g,\psi)$ are 2-cells $\alpha :f\to g$ in $\M$ such that $\psi\cdot (\alpha\circ a) = \phi$.
  In $\C$ we define
  \begin{itemize}
  \item $\Cty(B,b)$ to be the category whose objects are strictly commuting squares
    \[
      \begin{tikzcd}
        \one \ar[d,"b"'] \ar[r,"\pb"] & \Ub \ar[d,"\pi"] \\
        B \ar[r,"p"'] & \Un
      \end{tikzcd}
    \]
    and whose morphisms $(p,\pb) \to (q,\qb)$ are pairs of 2-cells $\alpha:p\to q$ and $\alb : \pb \to \qb$ such that $\pi \circ \alb = \alpha\circ  b$, and also $\alb$ belongs to the splitting of $\pi$ (thus, in particular, $\alb$ and $\pb$ are uniquely determined by $\alpha$ and $\qb$).
  \item $\Ctm(B,b)$ to be the category whose objects are diagrams
    \[
      \begin{tikzcd}
        \one \ar[d,"b"'] \ar[r,"\pb"] \ar[dr,phantom,near start,"\scriptstyle\mub\Uparrow"] & \Ub \ar[d,"\pi"] \\
        B \ar[r,"p"']\ar[ur,"\mu"'] & \Un
      \end{tikzcd}
    \]
    in which the bottom triangle commutes strictly (i.e.\ $\pi\circ \mu = p$) and $\pi\circ \mub$ is the identity, and whose morphisms $(p,\pb,\mu,\mub) \to (q,\qb,\nu,\nub)$ are triples of 2-cells $\alpha:p\to q$ and $\alb : \pb \to \qb$ as in $\Cty(B,b)$ and also $\beta:\mu\to\nu$ such that $\nub \cdot (\beta\circ b) = \alb \cdot \mub$.
  \end{itemize}
  Then $\C$ is a 2-category with families, and the evident projection $\vp:\C\to\M$ is a local discrete fibration of 2-categories with families.
\end{theorem}
\begin{proof}
  The unique map $\one\to\ec$ is a terminal object of $\C$, and the forgetful 2-functor $\C\to\M$ preserves the terminal object.
  Moreover, the following forgetful functors are discrete fibrations:
  \begin{itemize}
  \item $\C((A,a),(B,b)) \to \M(A,B)$ (the action on homs of the forgetful 2-functor $\C\to\M$).
    For given $(g,\psi) : (A,a) \to (B,b)$ and $\alpha:f\to g$, there is a unique choice of $\phi = \psi\cdot (\alpha\circ a)$.
  \item $\Cty(B,b) \to \Mty(B) = \M(B,\Un)$.
    For given $(q,\qb)\in\Cty(B,b)$ and $\alpha:p\to q$ in $\M$, there is a unique choice of $\alb$ lying in the splitting over $\alpha\circ b$, determining $\pb$ as its domain.
  \item $\Ctm(B,b) \to \Mtm(B) = \M(B,\Ub)$.
    For similarly, given $(q,\qb,\nu,\nub)\in\Ctm(B,b)$ and $\beta : \mu \to \nu$ in $\M$ (determining $\alpha : p \to q$ as $\pi \circ \beta$), there is a unique choice of $\alb$ lying in the splitting over $\alpha\circ b$, determining $\pb$ as its domain, and then a unique choice of $\mub$ by the universal property of the cartesian 2-cell $\alb$.
  \end{itemize}
  In addition, the forgetful functor $\Ctm(B,b) \to \Cty(B,b)$ is a split fibration.
  For given $(q,\qb,\nu,\nub)\in\Ctm(B,b)$ and $(\alpha,\alb):(p,\pb) \to (q,\qb)$ in $\Cty(B,b)$, we can choose $\beta$ lying in the splitting over $\alpha$ (determining $\mu$ as its domain), and then there is a unique choice of $\mub$ by the universal property of the cartesian 2-cell $\alb$.
  Cartesianness and functoriality of this choice follows from the same properties for $\pi$.

  It remains to define the 2-functorial action of $\Cty$ and $\Ctm$ and show that it preserves the splittings of $\Ctm(B,b) \to \Cty(B,b)$ and that the map $\Cty\to\Ctm$ is 2-natural and algebraically representable.
  Given $(f,\phi) : (A,a) \to (B,b)$ in $\C$ and also $(p,\pb)\in \Cty(B,b)$, let $\xi : \bb{pf} \to \pb$ belong to the splitting over $p\circ \phi : p\circ f\circ a \to p\circ b$.
  This determines the morphism $\bb{pf}$ so that in particular $\pi\circ \bb{pf} = p\circ f\circ a$, so that $(p\circ f, \bb{pf}) \in \Cty(A,a)$.
  This defines the action on objects of the functor $(f,\phi)^*: \Cty(B,b) \to \Cty(A,a)$; all the necessary functoriality properties then follow by composition of morphisms in the splitting.

  Similarly, given $(f,\phi) : (A,a) \to (B,b)$ in $\C$ and $(p,\pb,\mu,\mub)\in \Ctm(B,b)$, choose $\xi : \bb{pf} \to \pb$ as above.
  Then we have $\mu\circ f : A\to \Ub$ and $(\mub\circ f)\cdot (\mu\circ \phi): \mu\circ f\circ a \to \pb$ lying over $p\circ \phi$, so the universal property of $\xi$ yields a unique $\bb{\mu f} : \mu\circ f\circ a \to \bb{pf}$.
  Hence $(p\circ f, \bb{pf}, \mu\circ f, \bb{\mu f}) \in \Ctm(A,a)$, defining the action on objects of the functor $(f,\phi)^*: \Ctm(B,b) \to \Ctm(A,a)$, and the rest of the structure follows as before.

  It is evident by construction that the forgetful functors $\Ctm(B,b) \to \Cty(B,b)$ form a 2-natural transformation, and composition of morphisms in the splitting implies that it the functorial action preserves the splittings of these functors, so that $\Ctm\to \Cty$ is an internal split fibration.
  Now given $(p,\pb) \in \Cty(B,b)$, we have the pullback as on the left:
  \[
    \begin{tikzcd}
      \one \ar[dr,"c"] \ar[ddr,bend right=20,"b"'] \ar[drr,bend left=20,"\pb"] \\
      &C \ar[r,"h"] \ar[d,"g"'] \ar[dr,near start,phantom,"\lrcorner"] & \Ub \ar[d,"\pi"] \\
      &B \ar[r,"p"'] & \Un
    \end{tikzcd}
    \hspace{2cm}
    \begin{tikzcd}
      \one \ar[d,"c"'] \ar[rr,"\pb"] && \Ub \ar[d,"\pi"] \\
      C \ar[r,"g"'] \ar[urr,"h"] & B \ar[r,"p"'] & \Un
    \end{tikzcd}
  \]
  that is a representing object for $p\in \Mty(B)$, and the commuting square $\pi \circ \pb = p \circ b$ induces a unique $c:\one\to C$ such that $g\circ c = b$ and $h\circ c = \pb$.
  Hence $(C,c) \in \C$ and $(g,\id) : (C,c) \to (B,b)$ in $\C$.
  Moreover, the element $(g,\id)^*(p,\pb) = (p\circ g, \pb) \in \Cty(C,c)$ lifts to an element $(p\circ g, \pb, h, \id) \in \Ctm(C,c)$ as shown on the right above.

  We claim this is a representing element for $(p,\pb)$.
  We must show that given $(f,\phi):(A,a)\to (B,b)$ and a lifting of $(p\circ f, \bb{pf}) \in \Cty(A,a)$ to some element $(p\circ f, \bb{pf},\mu,\mub) \in \Ctm(A,a)$, where $\xi:\bb{pf} \to \pb$ belongs to the splitting over $p\circ \phi$:
  \[
    \begin{tikzcd}
      \one \ar[d,"a"'] \ar[rr,"\bb{pf}"] \ar[dr,phantom,near start,"\scriptstyle\mub\Uparrow"] && \Ub \ar[d,"\pi"] \\
      A \ar[r,"f"'] \ar[urr,near end,"\mu"'] & B \ar[r,"p"'] & \Un
    \end{tikzcd}
    \hspace{2cm}
    \begin{tikzcd}
      \one \ar[d,"a"] \ar[dr,shift left,"b" description] \ar[rr,shift right=2,"\bb{pf}"'] \ar[rr,shift left=2,"\pb"] \ar[rr,phantom,"\scriptstyle\xi\Uparrow"] && \Ub \ar[d,"\pi"] \\
      A \ar[r,shift right,"f"']  \ar[r,phantom,shift left=2,"\scriptstyle\phi\Uparrow"] & B \ar[r,"p"'] & \Un
    \end{tikzcd}
  \]
  there is a unique morphism $(k,\psi) : (A,a) \to (C,c)$ such that $(g,\id) \circ (k,\psi) = (f,\phi)$ and $(k,\psi)^*(p\circ g, \pb, h, \id) = (p\circ f, \bb{pf},\mu,\mub)$.
  Note that as constructed above, for any $(k,\psi) : (A,a) \to (C,c)$ we have
  \[(k,\psi)^*(p\circ g, \pb, h, \id) = (p\circ g\circ k, \bb{pgk}, h\circ k, \bb{hk})\]
  where $\zeta:\bb{pgk} \to \pb$ belongs to the splitting over $p\circ g\circ \psi$ and $\bb{hk}:h\circ k \circ a \to \bb{pgk}$ is the unique 2-cell with $\zeta \cdot \bb{hk} = h\circ \psi$.

  Firstly, since $\pi \circ \mu = p\circ f$, by the universal property of $C$ as a pullback, there is a unique $k:A\to C$ such that $h\circ k = \mu$ and $g\circ k = f$.
  Then for any $\psi:k\circ a \to c$ it will follow that $(k,\psi)^*(p\circ g, \pb, h, \id)$ and $(p\circ f, \bb{pf},\mu,\mub)$ agree in their first, second, and third components.
  Now the 2-cell aspect of the universal property of $C$, there is a unique $\psi : k\circ a \to c$ such that $h\circ \psi = \xi\cdot \mub : \mu\circ a \to \pb$ and $g\circ \psi = \phi : f \circ a \to b$, since $\pi\circ (\xi\cdot \mub) = \pi\circ \xi = p\circ \phi$.
  In particular, $p\circ g\circ \psi = p\circ \phi$, so $\zeta = \xi$ and thus $\bb{pgk} = \bb{pf}$, and $\bb{hk}$ is the unique 2-cell with $\xi \cdot \bb{hk} = h\circ \psi = \xi\cdot\mub$, hence $\bb{hk} = \mub$ as desired.
  And the equation $(g,\id) \circ (k,\psi) = (f,\phi)$ means $g\circ \psi = \phi$, which is true by construction.

  It remains to show that $(k,\psi)$ is unique with this property.
  Suppose $(k',\psi')$ also satisfies it, so that $g\circ k = g\circ k'$ and $g\circ \psi = g\circ \psi'$ and also
  \[ (p\circ g\circ k, \bb{pgk}, h\circ k, \bb{hk}) = (p\circ g\circ k', \bb{pgk'}, h\circ k', \bb{hk'}). \]
  Then in particular $h\circ k = h\circ k'$, so that $k=k'$ by the 1-morphism uniqueness aspect of the universal property of $C$.
  To analogously show $\psi=\psi'$, it will suffice to show $h\circ \psi = h\circ \psi'$.
  But $\zeta \cdot \bb{hk} = h\circ \psi$ and $\zeta' \cdot \bb{hk'} = h\circ \psi'$, while $\zeta=\zeta'$ since $g\circ \psi = g\circ \psi'$ and $\bb{hk} = \bb{hk'}$ by assumption; thus $h\circ \psi = h\circ \psi'$.
\end{proof}

\begin{example}
  Continuing the canonical model of Example~\ref{eg:canon-2cwf} and taking $\one\in\Cat$ to be the terminal category, Theorem~\ref{thm:fib2cwf-univ} yields a a local discrete fibration of 2-categories with families, to which we extend the terminology \textbf{canonical model}.
  Explicitly, an object of $\C$ is a category with a chosen object, so that an upstairs context $\Gamma$ over a category $\gamma$ is an object of $\gamma$.
  Similarly, a morphism from $(\gamma,\Gamma)$ to $(\delta,\Delta)$ is a functor $\theta:\gamma\to \delta$ with a morphism $\theta(\Gamma)\to \Delta$ in $\delta$, corresponding to our informal description of total upstairs substitutions from the beginning of Section~\ref{sec:semantics}.

  An object of $\Cty(\gamma,\Gamma)$ is a functor $p:\gamma\op\to\Cat$ together with an object $A\in p(\Gamma)$.
  And an object of $\Ctm(\gamma,\Gamma)$ over such $(p,A)$ is a section $\mu$ of the Grothendieck construction of $p$, together with a morphism from $\mu(\Gamma)$ to $A$ in $p(\Gamma)$.
  Thus once again the construction matches our expectation.
\end{example}

\msnote{Remains to discuss unit types and $\Sigma$-types, but they should be easy.}


\subsection{Fibrancy}
\label{sec:fibrancy}

\begin{definition}
  A \textbf{fibrancy structure} on a local discrete fibration of 2-categories with families $\vp : \C\to\M$ consists of a full subfunctor $\Cfibty \hookrightarrow \Cty$ (i.e.\ a 2-natural transformation that is componentwise fully faithful and injective on objects) such that the composite $\Cfibty \to \Cty \to \vpst \Mty$ is again a discrete fibration.
\end{definition}

Syntactically, this means we have a subset of the upstairs types in each context (the ``fibrant types'') that is closed under substitution (because $\Cfibty$ is a sub-2-functor) and under the $\St{s}{-}$ types (because $\Cfibty \to \Cty \to \vpst \Mty$ is a discrete fibration).
(Recall that in Section \ref{sec:strict-modalities} we stipulated that $\St{s}{-}$ preserves fibrancy of types.)

\begin{theorem}\label{thm:2cwf-fib}
  Let $\M$, $\pi:\Ub\to\Un$, and $\one$ be as in Theorem \ref{thm:fib2cwf-univ}, and let $\Ubfib \hookrightarrow \Ub$ be a full subobject, i.e.\ such that each functor $\M(X,\Ubfib) \to \M(X,\Ub)$ is fully faithful and injective on objects, such that the composite $\Ubfib \hookrightarrow \Ub \xrightarrow{\pi}\Un$ is a split fibration and the morphism $\Ubfib \hookrightarrow \Ub$ is a strict morphism of split fibrations.
  Define $\Cfibty(B,b)$ to consist of those $(p,\pb)\in \Cty(B,b)$ such that $\pb$ factors (necessarily uniquely) through $\Ubfib$.
  Then this yields a fibrancy structure.
\end{theorem}
\begin{proof}
  The inclusion $\Cfibty\hookrightarrow \Cty$ is obvious, and closure of $\Ubfib$ under the splitting of $\pi$ implies closure of $\Cfibty$ under the discrete fibrational action of $\Cty \to \vpst\Mty$.
\end{proof}

\begin{example}
  As in~\cite{lackshulman:laxlim}, let $\sF$ be the category whose objects are fully faithful and injective-on-objects functors $A_\tight \to A_\loose$.
  Let $\M=\Cat$ and $\one=1$ as before, but now let $\Un=\sF\op$, and let $\Ub$ be the Grothendieck construction of the functor $\Un\op = \sF \xrightarrow{(-)_\loose} \Cat$, while $\Ubfib$ is similarly the Grothendieck construction of $\Un\op = \sF \xrightarrow{(-)_\tight} \Cat$.
  Then applying Theorem \ref{thm:2cwf-fib} yields a local discrete fibration of 2-categories with families having a fibrancy structure, in which:
  \begin{itemize}
  \item The mode types, total substitutions, and total substitution 2-cells are, again, categories, functors, and natural transformations.
  \item A mode type in context $\gamma$ is a functor $p : \gamma\op\to\sF$, i.e.\ a functor $p_\loose : \gamma\op\to\Cat$ as in the canonical model equipped with a full subfunctor $p_\tight$.
  \item A mode type morphism is a natural transformation in the opposite direction between functors $\gamma\op\to\sF$, i.e.\ a natural transformation $q_\loose \to p_\loose$ as in the canonical model that also maps $q_\tight$ into $p_\tight$.
  \item The comprehension $\gamma\ce p$ is the Grothendieck construction of $p_\loose$.
    In particular, the information about $p_\tight$ is discarded at this stage.
    Thus, mode terms (being sections in $\Cat$ of such) also do not ``see'' $p_\tight$.
  \item An upstairs context over $\gamma$ is an object $\Gamma\in\gamma$, and similarly for total substitutions and the action of total 2-cells, as in the canonical model.
  \item An upstairs type in context $\Gamma$ over $p:\gamma\op\to\sF$ is, as in the canonical model, an object of $p_\loose(\Gamma)$.
    It is fibrant precisely when it belongs to $p_\tight(\Gamma)$.
  \item The upstairs comprehension and terms are defined as in the canonical model; thus they do not see fibrancy.
    The action $\St{s}{-}$, however, does preserve fibrant types, as required, because each such $s$ was required to preserve the subfunctors $p_\tight$.
  \end{itemize}
  We call this the \textbf{canonical fibrant model}.
\end{example}

\subsection{$\Esym$-types: opcartesian arrows}
\label{sec:opcartesian-arrows}

\begin{definition}
  Let $\vp:\C\to\M$ be a local discrete fibration of 2-categories with families, $\theta : \gamma\to\delta$ a morphism in $\M$, and $\Gamma$ an object of $\C$ with $\vp( \Gamma) = \gamma$.
  An arrow $\Theta : \Gamma\to \Delta$ with $\vp(\Theta) = \theta$ is \textbf{(strictly) opcartesian} if for any $\Delta'\in\M$, with $\vp(\Delta') = \delta$, the following square is a pullback in $\Cat$:
  \[
  \begin{tikzcd}
    \C(\Delta,\Delta') \ar[d] \ar[r] & \C(\Gamma,\Delta') \ar[d] \\
    \M(\delta,\delta') \ar[r] & \M(\gamma,\delta').
  \end{tikzcd}\]
\end{definition}

This is a $\Cat$-enriched universal property, so it has a 1-morphism and a 2-morphism aspect.
The 1-morphism aspect says that $\Theta$ is opcartesian in the usual sense in the underlying 1-categories: for any morphism $\Theta'' : \Gamma\to\Delta'$ and factorization $\vp(\Theta'') = \theta' \theta$, there is a unique morphism $\Theta' : \Delta\to\Delta'$ with $\Theta'' = \Theta'\Theta$ and $\vp(\Theta') = \theta'$.
The construction $\Theta\mapsto\Delta$ is therefore, insofar as it is defined, a functor from the fiber of $\vp$ over $\gamma$ to that over $\delta$, which we denote $\theta_!$.

The 2-morphism aspect says that given morphisms $\Theta'_1,\Theta'_2 : \Delta\to\Delta'$ and 2-cells $R:\Theta'_1\Theta \Rightarrow \Theta'_2\Theta$ and $\rho' : \vp(\Theta'_1)\Rightarrow \vp(\Theta'_2)$ such that $\vp(R) = \rho' \theta$, there exists a unique 2-cell $R' : \Theta'_1\Rightarrow \Theta'_2$ such that $R' \Theta = R$ and $\vp(R') = \rho'$.
But since $\vp$ is a local discrete fibration, we already know there exists a unique 2-cell $R' : \overline{\Theta'_1}\Rightarrow \Theta'_2$ such that $\vp(R') = \rho'$, so the content of this statement is that $\overline{\Theta'_1} = \Theta'_1$.
In other words, factoring through an opcartesian arrow commutes with the local discrete fibration action.


\bibliographystyle{abbrvnat}
\bibliography{../drl-common/cs}

\end{document}

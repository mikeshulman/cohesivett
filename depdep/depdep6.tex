\documentclass[10pt]{article}
  \usepackage{xcolor}
  \definecolor{darkgreen}{rgb}{0,0.45,0} 
  \usepackage[pagebackref,colorlinks,citecolor=darkgreen,linkcolor=darkgreen]{hyperref}
  \usepackage{pdflscape}

\usepackage{fullpage}
\usepackage{amssymb,amsthm,bbm}
\usepackage[centertags]{amsmath}
\usepackage{stackengine}
\stackMath
\usepackage[mathscr]{euscript}
\usepackage{tikz-cd}
\usepackage{mathpartir}
\usepackage{enumitem}
\usepackage[status=draft,inline,nomargin]{fixme}
\FXRegisterAuthor{ms}{anms}{\color{blue}MS}
\FXRegisterAuthor{mvr}{anmvr}{\color{olive}MVR}
\FXRegisterAuthor{drl}{andrl}{\color{purple}DRL}

\newtheorem{theorem}{Theorem}
\newtheorem{proposition}{Proposition}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}

\theoremstyle{definition}
\newtheorem{definition}{Definition}
\newtheorem{remark}{Remark}

\let\oldemptyset\emptyset%
\let\emptyset\varnothing

\newcommand\dsd[1]{\ensuremath{\mathsf{#1}}}

\newcommand{\yields}{\vdash}
\newcommand{\Yields}{\vDash}
\newcommand{\cbar}{\, | \,}
\newcommand{\judge}{\mathcal{J}}

\newcommand{\Id}[3]{\mathsf{Id}_{{#1}}(#2,#3)}
\newcommand{\CTX}{\,\,\mathsf{Ctx}}
\newcommand{\ctx}{\,\,\mathsf{mctx}}
\newcommand{\TYPE}{\,\,\mathsf{Type}}
\newcommand{\type}{\,\,\mathsf{mode}}
\newcommand{\TELE}{\,\,\mathsf{Tele}}
\newcommand{\tele}{\,\,\mathsf{mtele}}

\newcommand{\rewrite}[2]{\overleftarrow{#1}(#2)}
\newcommand\F[2]{\ensuremath{\mathsf{F}_{#1}(#2)}}
\newcommand\U[3]{\ensuremath{\mathsf{U}_{#1}(#2 \mid #3)}}
\newcommand\UE[2]{\ensuremath{#1(#2)}}
\newcommand\UI[2]{\ensuremath{\lambda #1.#2}}
\newcommand\St[2]{\ensuremath{{#1}^*(#2)}}
\newcommand\StI[2]{\ensuremath{\mathsf{st}_{#1}(#2)}}
\newcommand\UStI[2]{\ensuremath{\mathsf{ust}_{#1}(#2)}}
\newcommand\UnSt[2]{\ensuremath{\mathsf{unst}_{#1}(#2)}}
%\newcommand\StE[2]{\ensuremath{\mathsf{unst}(#1,#2)}}
\newcommand\StE[4]{\ensuremath{\mathsf{let} \, \StI{#1}{#3} \, = \, {#2} \, \mathsf{in} \, #4}}
\newcommand\FE[3]{\ensuremath{\mathsf{let} \, \mathsf{F}(#2) \, = \, {#1} \, \mathsf{in} \, #3}}
% With subscript:
\newcommand\FEs[4]{\ensuremath{\mathsf{let} \, \mathsf{F}_{#1}(#3) \, = \, {#2} \, \mathsf{in} \, #4}} 
\newcommand\FI[1]{\ensuremath{\mathsf{F}{(#1)}}}
\newcommand\TypeTwo[4]{\ensuremath{#1 \mid #3 \vDash #2 : #4}}
\newcommand\TeleTwo[4]{\ensuremath{#1 \mid #3 \vDash #2 : #4}}
\newcommand\TermTwo[4]{\ensuremath{#1 \mid #3 \vDash #2 : #4}}
\newcommand\TermTwoT[5]{\ensuremath{#1 \mid #3 \vDash_{#5} #2 : #4}}
%% \newcommand\TermTwoDisp[5]{\ensuremath{#1 \mid #3 \vDash_{\mathsf{disp}} #2 :_{#5} #4}}
\newcommand\SubTwo[4]{\ensuremath{#1 \mid #3 \vDash #2 : #4}}
\newcommand\TrPlus[2]{\ensuremath{{#1}^+(#2)}}
\newcommand\TrCirc[2]{\ensuremath{{#1}^\circ(#2)}}

\newcommand\Set[0]{\ensuremath{\textbf{Set}}}
\newcommand\Hom[3]{\ensuremath{\textbf{hom}_{#1}(#2,#3)}}
\newcommand\just[1]{\ensuremath{\textsf{just}_{#1}}}
\newcommand\Dt[2]{\ensuremath{#1.#2}}
\newcommand\proj[1]{\ensuremath{\mathsf{proj}_{#1}}}
\newcommand\var[1]{\ensuremath{\mathsf{var}_{#1}}}

\newcommand\fan[1]{\ensuremath{\mathsf{fan}_{#1}}}

\newcommand\Push[3]{\ensuremath{#1 +_{#2} #3}}
\newcommand\Pushout[5]{\ensuremath{#1 +^{#4,#5}_{#2} #3}}
\newcommand{\case}{\mathsf{case}}
\newcommand{\inl}{\mathsf{inl}}
\newcommand{\inr}{\mathsf{inr}}
\newcommand{\ini}{\mathsf{in}}

\newcommand{\id}{\mathsf{id}}
\DeclareMathOperator{\ob}{ob}

\newcommand\El[2]{\mathcal{T}_{#1}(#2)}
\newcommand\ApEl[2]{\mathcal{T}_{#1}\langle#2\rangle}

\newcommand\ap[2]{\ensuremath{#1 \langle #2 \rangle }}
\newcommand\ApPlus[2]{\ensuremath{{#1}^+ \langle #2 \rangle }}
\newcommand\ApCirc[2]{\ensuremath{{#1}^\circ \langle #2 \rangle }}

\newcommand{\app}[2]{\ensuremath{#1 \: #2}}
\newcommand{\sigmacl}[3]{\ensuremath{\textnormal{$\Sigma$}\,#1{:}#2.\,#3}}
\newcommand{\fst}[1]{\app{\dsd{fst}}{#1}}
\newcommand{\snd}[1]{\app{\dsd{snd}}{#1}}
\newcommand{\picl}[3]{\ensuremath{\textnormal{$\Pi$}\,#1{:}#2.\,#3}}

\newcommand{\telety}[3]{\ensuremath{(#1{:}#2,#3)}}
\newcommand{\mt}[0]{\ensuremath{()}}

%% FIXME: notation?
\newcommand\extend[2]{\ensuremath{(#1,\id_{#2})}}

\newcommand\bdot[0]{\mathbin{.}}
\newcommand\bang[0]{\mathord{!}}

\newcommand\PP[1]{\mathcal{P}(#1)}
\newcommand\ApP[1]{\mathcal{P}\langle#1\rangle}
\newcommand\ii[0]{\dsd{i}}


\title{A Fibrational Framework for Modal Dependent Type Theories}
\author{Daniel R. Licata, Mitchell Riley, Michael Shulman}
\date{}

\begin{document}
\maketitle
\tableofcontents

\section{Syntax}

\subsection{Overview of Judgements}

Mode theory judgements:
\begin{enumerate}
\item $\gamma \ctx$ (empty, extension)
\item $\gamma \yields p \type$ 
\item $\TypeTwo{\gamma}{s}{p}{q}$ (horizontal and vertical composition, identities)
\item $\gamma \yields \mu : p$ (variables, action of mode type morphisms)
\item $\TermTwoT{\gamma}{s}{\mu}{\nu}{p}$ (horizontal and vertical
    composition, identities)
\end{enumerate}

Top judgements: 
\begin{itemize}
\item $\yields_\gamma \Gamma \CTX$ over $\yields \gamma \ctx$
\item $\Gamma \yields_p A \TYPE$ over $\gamma \yields p \type$
\item $\Gamma \yields_\mu M : A$ over $\gamma \yields \mu : p$
\end{itemize}

Mode type morphisms $\TypeTwo{\gamma}{s}{p}{q}$ induce 1-cells
in \emph{both directions} in the mode theory, but
$\TypeTwo{\gamma}{s}{p}{q}$ and $\TermTwo{\gamma}{s}{\mu}{\nu}$
act \emph{contravariantly} on the subscripts of upstairs terms.

We expect structurality to be admissible for the base, and structurality
over that to be admissible for the top, e.g.:
\begin{mathpar}
\inferrule*[Left = weaken-over]
           {\Gamma,\Gamma' \yields_\mu M : A \\ (\text{where } \gamma,\gamma' \vdash \mu : p)}
           {\Gamma,y:B,\Gamma' \yields_\mu M : A \\ (\text{where } \gamma,y:q,\gamma' \vdash \mu : p)}

\inferrule*[Left = subst-over]
           {\Gamma,x:A,\Gamma' \yields_\nu N : C \\ (\text{where } \gamma,x:p,\gamma' \vdash \nu : \gamma) \\\\
            \Gamma \vdash_\mu M : A \\ (\text{where } \gamma \vdash \mu : p)
           }
           {\Gamma,\Gamma'[M/x] \yields_{\nu[\mu/x]} N[M/x] : A[M/x] \\ (\text{where } \gamma,\gamma'[\mu/x] \vdash \nu[\mu/x] : p[\mu/x])}
\end{mathpar}


\subsection{Mode Theory}

\begin{enumerate}

\item Contexts are as usual:

\begin{mathpar}
  \inferrule*{ }
             {\cdot \ctx}
             
  \inferrule*
    {\gamma \ctx \\
     \gamma \yields p \type}
    {\gamma,x:p \ctx}
\end{mathpar}

\item We assume $1/\Sigma$ modes:
\begin{mathpar}
  \inferrule*{ } { \gamma \yields 1 \type }
  
  \inferrule*{ \gamma \yields p \type \\ 
               \gamma,x:p \yields q \type }
             {\gamma \yields \sigmacl{x}{p}{q} \type}

\end{mathpar}
  

\item In all mode theories, terms must have: 

\begin{mathpar}
\inferrule*{ }
             {\gamma,x : p, \gamma' \yields x : p}
             
\inferrule*
    {\gamma \yields \mu : q \\
     \TypeTwo{\gamma}{s}{p}{q}
    }
    {\gamma \yields \TrPlus{s}{\mu} : p}
    
\inferrule*
    {\gamma \yields \mu : p \\
     \TypeTwo{\gamma}{s}{p}{q}
    }
    {\gamma \yields \TrCirc{s}{\mu} : q}
\\
\TrCirc{\id}{\mu} \equiv \mu \qquad
\TrCirc{s'}{\TrCirc{s}{\mu}} \equiv \TrCirc{(s;s')}{\mu} \qquad
\TrPlus{\id}{\mu} \equiv \mu \qquad
\TrPlus{s'}{\TrPlus{s}{\mu}} \equiv \TrPlus{(s';s)}{\mu} 
\end{mathpar}

These are adjoint as $s^\circ \dashv s^+$; this is the direction that identifies $F_{s^+}$ and $U_{s^\circ}$.  

We also have the usual rules for $1/\Sigma$ modes:
\begin{mathpar}
  \inferrule*{ }
             {\gamma \yields \mt : 1}
  \and 
  \mu \equiv \mt
\\
\inferrule*{
  \gamma \yields \mu : p \and
  \gamma \yields \nu : q[\mu/x]
    }
   {\gamma \yields (\mu,\nu) : \sigmacl{x}{p}{q}}
\and
\inferrule*
    {\gamma \yields \mu : \sigmacl{x}{p}{q}}
    {\gamma \yields \fst \mu : p}
\and
\inferrule*
    {\gamma \yields \mu : \sigmacl{x}{p}{q}}
    {\gamma \yields \snd \mu : q[\fst \mu / x]}
    \\
    \fst{(\mu,\nu)} \equiv \mu \and
    \snd{(\mu,\nu)} \equiv \nu \and
    p \equiv (\fst p, \snd p)
\end{mathpar}

Equations for ``transport'' in $\Sigma$:
\begin{mathpar}
\TrPlus{(\sigmacl{x}{s}{t})}{\mu} \equiv (\TrPlus{s}{\fst \mu},\TrPlus{(t[\fst \mu/x])}{\snd \mu})\\
\TrCirc{(\sigmacl{x}{s}{t})}{\mu} \equiv (\TrCirc{s}{\fst \mu},\TrCirc{(\ap{q}{\eta_{{\fst \mu}}/x};t[\TrCirc{s}{\fst \mu}/x])}{\snd \mu})
\end{mathpar}

\item Mode type morphisms:
\begin{mathpar}
    \inferrule*{ }
          {\TypeTwo{\gamma}{\id_p}{p}{p}}
    \qquad
    \inferrule*{{\TypeTwo{\gamma}{s_1}{p_1}{p_2}} \\
                {\TypeTwo{\gamma}{s_2}{p_2}{p_3}}
          }
          {\TypeTwo{\gamma}{s_1;s_2}{p_1}{p_3}}

\inferrule*{{\gamma,x:p} \vdash {q} \type \\
            \TermTwoT{\gamma}{t}{\mu}{\mu'}{p}\\
           } 
           {\TypeTwo{\gamma}{\ap {q} {t/x}}{q[\mu/x]}{q[\mu'/x]}}

\\
\id;s \equiv s \equiv s;\id \and
(s;s');s'' \equiv s;(s';s'') \\ 
\ap q {\id_{\mu}/x} \equiv \id_{q[\mu/x]} \and
\ap q {(s;t)/x} \equiv \ap q {s/x}; \ap q {t/x} \\ 
\ap q {s/\_} \equiv \id_q \\ 
\ap {(q[\mu/x])} {s/y} \equiv \ap q {\ap \mu {s/y}/x} \quad (\text{where } \gamma,y:p' \vdash \mu : p \text{ and } \gamma,x:p \vdash q \type)\\
s[\nu/x];\ap{q'}{t/x} \equiv \ap{q}{t/x};s[\nu'/x] \quad 
(\text{where } \TypeTwo{\gamma,x:p}{s}{q}{q'} \text{ and } \TermTwoT{\gamma}{t}{\nu}{\nu'}{p})

%% subst: \id_\mu[\nu/x] = \id_{\mu[\nu/x]}
%% subst: s[x/x] = s
%% subst: (s;t)[\mu/x] = s[\mu/x];t[\mu/x]
%% subst: s[\mu[\nu/x]/x] = s[\mu/x][\nu/x]
%% subst: ap q (s [\mu/x]) = (ap q s)[\mu/x] and generalization
\end{mathpar}

We write $\ap q {t/x}$ for whiskering (\dsd{ap} in book HoTT).

We need congruence for $\Sigma$ to be a rule (because we don't have ap
on a type variable/universes):
\begin{mathpar}
  \inferrule*
  {\TypeTwo{\gamma}{s}{p}{p'} \\
    \TypeTwo{\gamma,x':p'}{t}{q[\TrPlus{s}{x'}/x]}{q'}}
  {\TypeTwo{\gamma}{\sigmacl{x'}{s}{t}}{\sigmacl{x}{p}{q}}{\sigmacl{x'}{p'}{q'}}} \\

  \sigmacl{x'}{\id_p}{\id_q} \equiv \id_{\sigmacl{x'}{p}{q}} \and
  (\sigmacl{x'}{s}{t});(\sigmacl{x''}{s'}{t'}) \equiv \sigmacl{x''}{(s;s')}{(t[\TrPlus{s'}{x''}/x'];t')} \\

  \ap{(\sigmacl{x'}{p}{q})}{s/(y:r)} \equiv
  \sigmacl{x'}{\ap{p}{s/y}}{\ap{({q[\fst z/x,\snd z/y]})}{\extend{s}{x'}/(z:(\sigmacl{y}{r}{p}))}}
\end{mathpar}

\item 2-cells between terms.  First, we have
  identity/composition/whiskering and associated equations (whiskering
  on the other side is given by substitution):
\begin{mathpar}
    \inferrule*{ }
          {\TermTwoT{\gamma}{\id_\mu}{\mu}{\mu}{p}}
    \qquad
    \inferrule*{{\TermTwoT{\gamma}{s_1}{\mu_1}{\mu_2}{p}} \\
                {\TermTwoT{\gamma}{s_2}{\mu_2}{\mu_3}{p}}
          }
   {\TermTwoT{\gamma}{s_1;s_2}{\mu_1}{\mu_3}{p}}

\inferrule*{{\gamma,x:p} \yields {\nu} : {q} \\
            \TermTwoT{\gamma}{s}{\mu}{\mu'}{p}\\
           } 
           {\TermTwoT{\gamma}{\ap \nu {s/x}}{\nu[\mu/x]}{\TrPlus{\ap{q}{s/x}}{\nu[\mu'/x]}}{q[\mu/x]}}

\\           
\id;s \equiv s \equiv s;\id \and
(s;s');s'' \equiv s;(s';s'') \\ 
\ap \nu {\id_{\mu}/x} \equiv \id_{\nu[\mu/x]} \and
\ap \nu {(s;t)/x} \equiv \ap \nu {s/x} ; (\ap {(\TrPlus{\ap{q}{s/x}}{y})} {\ap \nu {t/x}/y}) \\ 
\ap x {s/x} \equiv s  \and
\ap \nu {s/\_} \equiv \id_\nu \and
\ap {(\nu[\mu/x])} {s/y} \equiv \ap \nu {\ap \mu {s/y}/x} \quad
(\text{where } \gamma,y:p' \vdash \mu : p \text{ and } \gamma,x:p \vdash \nu : q \type)\\
t[\mu/x];\ap{\nu'}{s/x} \equiv \ap{\nu}{s/x};\ap{(\TrPlus{\ap{q}{s/x}}{y})}{t[\mu'/x]/y} \quad
 (\text{where } \TermTwoT{\gamma,x:p}{t}{\nu}{\nu'}{q} \text{ and } \TermTwoT{\gamma}{s}{\mu}{\mu'}{p})
\end{mathpar}

Next, we have the adjunction for $s^\circ$ and $s^+$:
\begin{mathpar}
\inferrule*
    {\TypeTwo{\gamma}{s}{p}{q} \\
     \gamma \yields \nu : q
    }
    {\TermTwoT{\gamma}{\varepsilon^s_\nu}{\TrCirc{s}{\TrPlus{s}{\nu}}}{\nu}{q}}

\inferrule*
    {\TypeTwo{\gamma}{s}{p}{q} \\
      \gamma \yields \mu : p
    }
    {\TermTwoT{\gamma}{\eta^s_\mu}{\mu}{\TrPlus{s}{\TrCirc{s}{\mu}}}{p}}
\\ 
\eta^s_{\TrPlus{s}{\nu}};\ap{(\TrPlus{s}{z})}{\varepsilon^s_\nu/z} \equiv \id_{\TrPlus{s}{\nu}} \and
\ap{(\TrCirc{s}{z})}{\eta^s_\mu/z};\varepsilon^s_{\TrCirc{s}{\mu}} \equiv \id_{\TrCirc{s}{\mu}}
\\
\varepsilon^s_\nu;t \equiv \ap{\TrCirc{s}{\TrPlus{s}{z}}}{t/z} ; \varepsilon^s_{\nu'} \and t;\eta^s_\mu \equiv \eta^s_{\mu'} ; \ap{\TrPlus{s}{\TrCirc{s}{z}}}{t/z} \\
\varepsilon^{\id_p}_\nu \equiv \id_{\nu} \and \eta^{\id_p}_\mu \equiv \id_{\mu} \\
\varepsilon^{s;t}_\nu \equiv (\ap{t^\circ}{\varepsilon^s_{\TrPlus{t}{\nu}}}) ; \varepsilon^t_\nu \and 
\eta^{s;t}_\mu \equiv \eta^s_\mu ; (\ApPlus{s}{\eta^t_{\TrCirc{s}{\mu}}})
\end{mathpar}
\mvrnote{similar functoriality for horizontal composition?}

\drlnote{equations for when $s$ is $\sigmacl{x}{t}{t'}$}.  

Finally, we have the 2-cells for $\Sigma$-modes:
\begin{mathpar}
\inferrule*
    {\TermTwoT{\gamma}{s}{\mu}{\mu'}{p} \and
      \gamma \vdash \nu' : q[\mu'/x]
    }
      {\TermTwoT{\gamma}{\extend{s}{\nu'}}{(\mu,\TrPlus{\ap{q}{s/x}}{\nu'})}{(\mu',\nu')}{\sigmacl{x}{p}{q}}}\\
\ap {\fst(z)} {\extend{s}{\nu'}/z} \equiv s \and
\ap {\snd(z)} {\extend{s}{\nu'}/z} \equiv \id_{\TrPlus{\ap{q}{s/x}}{\nu'}}  \\
s \equiv \ap{(\fst{\mu},y)}{\ap{(\snd z)}{s/z}/y};\extend{\ap{(\fst{z})}{s/z}}{\snd{\mu'}} \quad (\text{where } \TermTwoT{\gamma}{s}{\mu}{\mu'}{\sigmacl{x}{p}{q}})
\\      
{\extend{\id_\mu}{\nu'}} \equiv \id_{(\mu,\nu')} \and
{\extend{(s;s')}{\nu''}} \equiv  \extend{s}{\TrPlus{\ap{q}{s'/x}}{\nu''}};\extend{s'}{\nu''}   \\
\extend{s}{\nu'} ; (\ap{(\mu',y)}{t/y}) \equiv
(\ap{(\mu,\TrPlus{(\ap{q}{s})}{y})}{t/y}); \extend{s}{\nu''} \qquad (\text{where }\TermTwoT{\gamma}{t}{\nu'}{\nu''}{q[\mu'/x]})
\end{mathpar}

\item
  All judgements have a substitution principle
\begin{mathpar}
  \inferrule*{\gamma,x:p,\gamma' \yields J \\
              \gamma \yields \mu : p
              }
             {\gamma,\gamma'[\mu/x] \yields J[\mu/x]} \\

J[\mu/x][\nu/y] \equiv J[\nu/y][\mu[\nu/y]/x]
\end{mathpar}

\drlnote{write out the usual rules defining this}
             
\end{enumerate}

We sometimes write \ap{\mu}{s} for \ap{\mu(x)}{s/x}, eliding the
variable name when it is clear how to view $\mu$ as a term with a
distinguished variable; e.g. $\ApPlus{s}{t}$ for
$\ap{\TrPlus{s}{x}}{t/x}$.

\subsubsection{Lemmas}

Horizontal composition:
\begin{mathpar}
  \inferrule*[Left=Derivable]
      {\TermTwoT{\gamma}{s}{\mu}{\mu'}{p} \\
    \TermTwoT{\gamma, x : p}{t}{\nu}{\nu'}{q}}
             {\TermTwoT{\gamma}{\ap{t}{s/x} :\equiv t[\mu/x];\ap{\nu'}{s/x}}{\nu[\mu/x]}{\TrPlus{\ap{q}{s/x}}{\nu'[\mu'/x]}}{q[\mu/x]}}
\\ 
\ap{\id_\nu}{s/x} \equiv \ap{\nu}{s/x} \and \ap{t}{\id_{\mu}/x} \equiv t[\mu/x]
\end{mathpar}

Pairing and projection 2-cells are definable:
\begin{mathpar}
  \inferrule*[Left=Derivable]
      {\TermTwoT{\gamma}{s}{\mu}{\mu'}{p} \\
    \TermTwoT{\gamma}{t}{\nu}{\TrPlus{\ap{q}{s}}{\nu'}}{q[\mu/x]}}
             {\TermTwoT{\gamma}{(s,t) :\equiv \ap{(\mu,y)}{t/y};\extend{s}{\nu'}}{(\mu,\nu)}{(\mu',\nu')}{\sigmacl{x}{p}{q}}}

   \inferrule*[Left=Deriv]
              { {\TermTwoT{\gamma}{s}{\mu}{\mu'}{\sigmacl{x}{p}{q}}} }
              { {\TermTwoT{\gamma}{\ap{\fst(y)}{s/y}}{\fst{\mu}}{\fst{\mu'}}{p}} }
   \and
   \inferrule*[Left=Deriv]
              { {\TermTwoT{\gamma}{s}{\mu}{\mu'}{\sigmacl{x}{p}{q}}} }
              { {\TermTwoT{\gamma}{\ap{\snd(y)}{s/y}}{\snd{\mu}}{\TrPlus{\ap{(q(\fst y/x))}{s/y}}{\snd{\mu'}}}{q[\fst{\mu}/x]}} }
\end{mathpar}

\drlnote{Check usual composition rule for pairing}

\begin{lemma}
If $s : p \vDash q$ and $t : q \vDash p$ are inverse, then $\TrPlus{t}{\mu} \cong \TrCirc{s}{\mu}$ for $\mu : p$.
\end{lemma}
\begin{proof}
The maps in either direction are given by
\begin{align*}
\eta^t_{\TrCirc{s}{\mu}} &: \TrCirc{s}{\mu} \vDash \TrPlus{t}{\TrCirc{t}{\TrCirc{s}{\mu}}} \equiv \TrPlus{t}{\mu} \\
\ApPlus{t}{\eta^s_\mu} &: \TrPlus{t}{\mu} \vDash \TrPlus{t}{\TrPlus{s}{\TrCirc{s}{\mu}}} \equiv \TrCirc{s}{\mu}
\end{align*}
And we can check that the composites are the identity:
\begin{align*}
\eta^t_{\TrCirc{s}{\mu}} ; \ApPlus{t}{\eta^s_\mu}
&\equiv \eta^t_{\TrCirc{s}{\mu}} ; \ApPlus{t}{\eta^s_{\TrCirc{t}{\TrCirc{s}{\mu}}}} \\
&\equiv \eta^{t;s}_{\TrCirc{s}{\mu}} \\ 
&\equiv \eta^{\id}_{\TrCirc{s}{\mu}} \\ 
&\equiv \id_{\TrCirc{s}{\mu}}
\intertext{and}
\ApPlus{t}{\eta^s_\mu} ; \eta^t_{\TrCirc{s}{\mu}}
&\equiv \ApPlus{(t;s)}{\ApPlus{t}{\eta^s_\mu} ; \eta^t_{\TrCirc{s}{\mu}}} \\
&\equiv \ApPlus{t}{\ApPlus{s}{\ApPlus{t}{\eta^s_\mu}} ; \ApPlus{s}{\eta^t_{\TrCirc{s}{\mu}}}} \\
&\equiv \ApPlus{t}{\eta^s_\mu ; \ApPlus{s}{\eta^t_{\TrCirc{s}{\mu}}}} \\
&\equiv \ApPlus{t}{\eta^{s;t}_\mu} \\
&\equiv \ApPlus{t}{\eta^{\id}_\mu} \\
&\equiv \ApPlus{t}{\id_\mu} \\
&\equiv \id_{\TrPlus{t}{\mu}}
\end{align*}
\end{proof}

\begin{lemma}
If $s : p \vDash q$ and $t : q \vDash p$ are inverse, then
\begin{align*}
\ApPlus{s}{\ApCirc{s}{\varepsilon^t_\mu}} &\equiv \eta^s_\mu \\
\varepsilon^t_\mu &\equiv \ApCirc{t}{\ApPlus{t}{\eta^s_\mu}} \\
\end{align*}
\end{lemma}
\begin{proof}
The first one:
\begin{align*}
\ApPlus{s}{\ApCirc{s}{\varepsilon^t_\mu}}
&\equiv \eta^{s;t}_\mu ; \ApPlus{s}{\ApCirc{s}{\varepsilon^t_\mu}} \\
&\equiv \eta^s_\mu ; \ApPlus{s}{\eta^t_{\TrCirc{s}{\mu}}} ; \ApPlus{s}{\ApCirc{s}{\varepsilon^t_\mu}} \\
&\equiv \eta^s_\mu ; \ApPlus{s}{\eta^t_{\TrCirc{s}{\mu}};\ApCirc{s}{\varepsilon^t_\mu}} \\
&\equiv \eta^s_\mu ; \ApPlus{s}{\ApCirc{s}{\ApCirc{t}{\eta^t_{\TrCirc{s}{\mu}}};\varepsilon^t_{\ApCirc{t}{\ApCirc{s}{\mu}}}}} \\
&\equiv \eta^s_\mu ; \ApPlus{s}{\ApCirc{s}{\id_{\ApCirc{t}{\ApCirc{s}{\mu}}}}} \\
&\equiv \eta^s_\mu
\end{align*}
The other follows from the first by applying $\ApCirc{t}{\ApPlus{t}{-}}$ to both sides.
\end{proof}

\subsection{Contexts}

\begin{mathpar}
  \inferrule*[Left = ctx-form]{ }
  {\yields_{\cdot} \cdot \CTX  } \and 

  \inferrule*[Left = ctx-form]{
    \yields_\gamma \Gamma \CTX \and (\text{where } \yields \gamma \ctx) \\\\
    \Gamma \yields_p A \TYPE \and (\text{where }  \gamma \yields p \type)}
  {\yields_{\gamma, x : p} \Gamma, x : A \CTX \and (\text{where } \yields \gamma,x:p \ctx)  } \\
\end{mathpar}

\subsection{Types and Terms}

\subsubsection{Structural Rules}

\begin{mathpar}
  \inferrule*[Left = var]{
    % \yields \Gamma, x : A, \Gamma' \CTX_{\gamma, x : p, \gamma'}
  }
  {\Gamma, x : A, \Gamma' \yields_x x : A \and (\text{where } \gamma,x:p,\gamma' \yields x : p)} \and

 \inferrule*[Left = rewrite]{
   \Gamma \yields_\mu M : A 
   \and \TermTwoT{\gamma}{s}{\nu}{\mu}{p}
  }
  {\Gamma \yields_\nu \rewrite{s}{M} : A} \\ \\
  
  \rewrite{\id_{\nu[\mu/x]}}{M} \equiv M \and
  \rewrite{(s;t)}{M} \equiv \rewrite{s}{\rewrite{t}{M}} \and
  \rewrite{s}{M}[\rewrite{t}{N}/x] \equiv \rewrite{\ap{s}{t/x}}{\StI{\ap{q}{t/x}}{M[N/x]}}
\end{mathpar}
In the absence of eta for $\mathsf{F}$, we also need to assert
\begin{mathpar}
(\FE{M}{x}{\rewrite{t[\mu/y]}{N}}) \equiv \rewrite{t[\nu/y]}{\FE{M}{x}{N}} %\\
%(\StE{t}{M}{x}{\rewrite{s[\TrPlus{t}{x}/y]}{N}}) \equiv \rewrite{s[\nu/y]}{\StE{t}{M}{x}{N}} 
\end{mathpar}

\subsubsection{Telescope Types}

\begin{mathpar}
  \inferrule*{~}{\Gamma \yields_{1} 1 \TYPE} \and
  \inferrule*{~}{\Gamma \yields_{()} () : 1} \and
  \inferrule*{ \Gamma \yields_p A \TYPE \\
               \Gamma,x:A \yields_q B \TYPE}
             { \Gamma \yields_{\sigmacl{x}{p}{q}} \telety{x}{A}{B} \TYPE}
  \and 
  \inferrule*{ \Gamma \yields_\mu M : A \\
               \Gamma \yields_\nu N : B[M/x]
             }
             { \Gamma \yields_{(\mu,\nu)} (M,N) : \telety{x}{A}{B}}
  \and
  \inferrule*{ \Gamma \yields_{\mu} M : \telety{x}{A}{B}}
             { \Gamma \yields_{\fst \mu} \fst{M} : A} 
  \and
  \inferrule*{ \Gamma \yields_{\mu} M : \telety{x}{A}{B}}
             { \Gamma \yields_{\snd \mu} \snd{M} : B[\fst M/x]} 

    \fst{(M,N)} \equiv M \and
    \snd{(M,N)} \equiv N \and
    P \equiv (\fst P, \snd P)
\end{mathpar}


\subsubsection{Modalities}

\begin{mathpar}
  \inferrule*[Left = F-form]{
    %% \yields_\gamma \Gamma \CTX \and (\text{where } \yields \gamma \ctx)\\\\
    \Gamma \yields_p A \TYPE \and (\text{where } \gamma \yields p \type) \\\\
    \gamma, x:p \yields \mu : q 
  }
  {\Gamma \yields_q \F{x.\mu}{A} \TYPE \and (\text{where } \gamma \yields q \type) } \\
  
  \inferrule*[Left = F-intro]{
    \Gamma \yields_{\nu} M : A
    \and (\text{where } \gamma \yields {\nu} : p)
    %% \and \gamma \yields \nu : q 
    %% \and \gamma \yields \mu[\theta] : q 
    %% \and \gamma \yields (\nu \Rightarrow \mu[\theta]) : q
  }
  {\Gamma \yields_{\mu[\nu/x]} \FI{M} : \F{x.\mu}{A} \and (\text{where } \gamma \yields \mu[\nu/x] : q)} \\

  \inferrule*[Left = F-elim]{
    \Gamma, y : \F{x.\mu}{A} \yields_{r} C \TYPE \and (\text{where } \gamma, y : q \yields r \type) \\\\
    \Gamma \yields_{\nu} M : \F{x.\mu}{A} \and (\text{where } \gamma \yields \nu : q) \\\\
    \Gamma, x:A \yields_{\nu' [\mu / y]} N : C [\FI{x}/y]
    \and (\text{where } \gamma, x:p \yields \nu' [\mu / y] : r [\mu / y] )}
  {\Gamma \yields_{\nu'[\nu/y]} \FE{M}{x}{N} : C[M/y]  \and (\text{where }  \gamma \yields {\nu'[\nu/y]} : r[\nu/y])} \\
  \FE{\FI{M}}{x}{N} \equiv N[M/x] \and
  \text{(optionally:) }
  \FE{M}{x}{N[\FI{x}/z]} \equiv N[M/z]
  \\ \\

  \inferrule*[Left = F-Elim]{
    \gamma,y:q \yields r \type \\\\
    \Gamma \yields_{\nu} M : \F{x.\mu}{A} \and (\text{where } \gamma \yields \nu : q) \\\\
    \Gamma, x:A \yields_{r [\mu / y]} C \TYPE
    \and (\text{where } \gamma, x:p \yields r [\mu / y] \type )}
  {\Gamma \yields_{r[\nu/y]} \FE{M}{x}{C} \TYPE \and (\text{where }  \gamma \yields {r[\nu/y]} \type)} \\
  \FE{\FI{M}}{x}{C} \equiv C[M/x] \and
  \text{(optionally:) }
  \FE{M}{x}{C[\FI{x}/z]} \equiv C[M/z]
\\ \\
  \inferrule*[Left = U-form]{
    \Gamma \yields_p A \TYPE \and (\text{where } \gamma \yields p \type)\\\\
    \and \Gamma,x:A \yields_q B \TYPE \and (\text{where } \gamma,x:p \yields q \type)\\\\
    \and \gamma, x:p, c:r \yields \mu : q
  }{\Gamma \yields_r \U{c.\mu}{A}{B} \TYPE \and (\text{where } \gamma \yields r \type)} \\

  \inferrule*[Left = U-intro]{
    \Gamma,x:A \yields_{\mu[\nu/c]} M : B \and (\text{where } \gamma,x:p \yields {\mu[\nu/c]} : q)
  }
  {\Gamma \yields_{\nu} \UI {x}{M} : \U{c.\mu}{x:A}{B}
    \and (\text{where } \gamma \yields \nu : r)
  } \\
  
  \inferrule*[Left = U-elim]{
    \Gamma \yields_{\nu_1} N_1 : \U{c.\mu}{x:A}{B} \and (\text{where } \gamma \yields \nu_1 : r) \\\\
    \Gamma \yields_{\nu_2} N_2 : A \and (\text{where } \gamma \yields \nu_2 : p)
  }{
    \Gamma \yields_{\mu[\nu_2/x,\nu_1/c]} \UE{N_1}{N_2} : B \and (\text{where } \gamma \yields \mu[\nu_2/x,\nu_1/c] : q)
  } \\

  \UE{(\UI{x}{M})}{N} \equiv M[N/x] \and 
  \UI{x}{\UE{N}{x}} \equiv N
\end{mathpar}

\subsubsection{Surprisingly Strict Modalities}

\begin{mathpar}
  \inferrule*[Left = s-form]{
    \Gamma \yields_p A \TYPE \and (\text{where } \gamma \yields p \type)\\\\
    \and \TypeTwo{\gamma}{s}{q}{p}
  }{\Gamma \yields_q \St{s}{A} \TYPE \and (\text{where } \gamma \yields q \type)} \\

  \inferrule*[Left = S-intro]{
    \Gamma \yields_{\mu} M : A
    \and (\text{where } \gamma \yields {\mu} : p)
  }
  {\Gamma \yields_{\TrPlus{s}{\mu}} \StI{s}{M} : \St{s}{A} \and (\text{where } \gamma \yields \TrPlus{s}{\mu} : q)} \\

  \inferrule*[Left = S-elim]{
    \Gamma, y : \St{s}{A} \yields_{r} C \TYPE \and (\text{where } \gamma, y : q \yields r \type) \and \\\\
    \Gamma \yields_{\nu} M : \St{s}{A} \and (\text{where } \gamma \yields \nu : q) \\\\
    \Gamma, x : A \yields_{\nu' [\TrPlus{s}{x} / y]} N : C [\StI{s}{x}/y]
    \and (\text{where } \gamma, x : p \yields \nu' [\TrPlus{s}{x} / y] : r[\TrPlus{s}{x} / y] )}
  {\Gamma \yields_{\nu'[\nu/y]} \StE{s}{M}{x}{N} : C[M/y]  \and (\text{where } \gamma \yields {\nu'[\nu/y]} : r[\nu/y])} \\
  \StE{s}{\StI{s}{M}}{x}{N} \equiv N[M/x] \and
  \StE{s}{M}{x}{N[\StI{s}{x}/z]} \equiv N[M/z]
  \\
  
  \inferrule*[Left = S-Elim]{
    \gamma,y:q \yields r \type \\\\
    \Gamma \yields_{\nu} M : \St{s}{A} \and (\text{where } \gamma \yields \nu : q) \\\\
    \Gamma, x:A \yields_{r [\TrPlus{s}{x} / y]} C \TYPE
    \and (\text{where } \gamma, x:p \yields r [\TrPlus{s}{x} / y] \type )}
  {\Gamma \yields_{r[\nu/y]} \StE{s}{M}{x}{C} \TYPE \and (\text{where }  \gamma \yields {r[\nu/y]} \type)} \\
  \StE{s}{\StI{s}{M}}{x}{C} \equiv C[M/x] \and
  \StE{s}{M}{x}{C[\StI{s}{x}/z]} \equiv C[M/z]
  \\ \\
\end{mathpar}

\drlnote{Change the definition of $s$-types to $U$-types as primitive
  and derive $F$, so that having $\eta$ is less surprising.}

Term/type equalities:
\begin{align*}
\StI{s}{\FI{M}} &\equiv \FI{M} &\St{s}{\F{x.\mu}{A}} &\equiv \F{x.\TrPlus{s}{\mu}}{A} \\
\FI{\StI{s}{M}} &\equiv \FI{M} &\F{x.\mu}{\St{s}{A}} &\equiv \F{x.\mu[\TrPlus{s}{x}/x]}{A} \\
\UStI{s}{\UI{x}{M}} &\equiv \UI{x}{M} &\St{s}{\U{c.\mu}{x:A}{B}} &\equiv \U{c.\mu[\TrCirc{s}{c}/c]}{x:A}{B} \\
\UI{x}{\UStI{s}{M}} &\equiv \UI{x}{M} &\U{c.\mu}{x:A}{\St{s}{B}} &\equiv \U{c.\TrCirc{s}{\mu}}{x:A}{B} \\
\UI{x}{M} &\equiv \UI{x}{M[\StI{s}{x}/x]} &\U{c.\mu}{x:\St{s}{A}}{B} &\equiv \U{c.\mu[\TrPlus{s}{x}/x]}{x:A}{B[\StI{s}{x}/x]} \\
\StI{(s, t)}{(M, N)} &\equiv (\StI{s}{M}, \StI{t[\mu/x]}{N}) &\St{(\telety{x'}{s}{t})}{\telety{x'}{A'}{B'}} & \equiv \telety{x}{\St{s}{A'}}{\StE{s}{x}{x'}{\St{t}{B'}}} \\
\StI{s}{\StI{t}{M}} &\equiv \StI{s;t}{M} &\St{s}{\St{t}{A}} &\equiv \St{(s;t)}{A} \\
\StI{\id_p}{M} &\equiv M &\St{\id_p}{A} &\equiv A\\
\rewrite{\ap{\nu}{t/x}}{\StI{\ap{q}{t/x}}{N[M/x]}} &\equiv N[\rewrite{t}{M}/x]  &\St{(\ap{q}{t/x})}{B[M/x]} & \equiv B[\rewrite{t}{M}/x] \\
%% other whiskering is a substitution rule:
%% \St{(s[\mu/x])}{B[M/x]} & \equiv (\St{s}{B})[M/x] 
\end{align*}
Where the last term equation is a special case of rewrite on substitutions. The inputs are typed $\Gamma,x:A \vdash_q B \TYPE $\ and $\Gamma \vdash_{\mu'} M : A$ and $\TermTwo{\gamma}{t}{\mu}{\mu'}$.
\mvrnote{TODO: Typecheck the U ones...}

In the absence of \textsf{F}-eta, we also need these extra equalities so we can push $s$-types around:
\begin{align*}
\StI{s[\nu/y]}{\FE{M}{x}{N}} &\equiv \FE{M}{x}{\StI{s[\mu/y]}{N}} \\
\FEs{\TrPlus{s}{\mu}}{M}{x}{N} &\equiv \StE{s}{M}{y}{(\FEs{\mu}{y}{x}{N})} \\
\FEs{\mu[\TrPlus{s}{x}/x]}{M}{x}{N} &\equiv \FEs{\mu}{M}{y}{(\StE{s}{y}{x}{N})} \\
\end{align*}
\mvrnote{Check that the ones for U-types hold already}

\subsection{Lemmas}

\begin{lemma}
The \textsc{rewrite} rule pushes into terms of telescope types:
\begin{align*}
%(\rewrite{s}{M},N) &\equiv \rewrite{(s, \varepsilon_\nu^{\ap{q}{s/x}})}{(M, \UnSt{\ap{q}{s/x}}{N}}) \\
%(M,\rewrite{t}{N}) &\equiv \rewrite{(\id_\mu, t)}{(M,N)} \\
\rewrite{(s, t)}{(M, N)} &\equiv (\rewrite{s}{M}, \rewrite{t}{\StI{\ap{q}{s/x}}{N}} ) 
\end{align*}
\end{lemma}
\begin{proof}
\begin{align*}
\rewrite{(s, t)}{(M, N)} 
&\equiv (\fst\rewrite{(s, t)}{(M, N)}, \snd \rewrite{(s, t)}{(M, N)} ) \\
&\equiv (\fst z [\rewrite{(s, t)}{(M, N)}/z], \snd z [\rewrite{(s, t)}{(M, N)}/z] ) \\
&\equiv (\rewrite{\ap{\fst}{(s, t)}}{\fst (M, N)}, \rewrite{\ap{\snd}{(s, t)}}{\StI{\ap{q[\fst z/x]}{(s, t)/z}}{\snd (M, N)}} ) \\
&\equiv (\rewrite{s}{M}, \rewrite{t}{\StI{\ap{q}{s/x}}{N}} )
\end{align*}

\drlnote{Add ref to equalities being used from second to third line.
  Also write out the typing for the second half of the pair, to show how
  the $s$-type moves work.}

%\begin{align*}
%(\rewrite{s}{M},N) 
%&\equiv  \\
%(M,\rewrite{t}{N}) 
%&\equiv \rewrite{(\id_\mu, \id_y)}{(M, y)}[\rewrite{t}{N}/y] \\
%&\equiv \rewrite{(\id_\mu, \id_y)[t/y]}{(M,N)} \\
%&\equiv \rewrite{(\id_\mu, t)}{(M,N)}
%\end{align*}
\end{proof}

\begin{lemma}
The \textsc{rewrite} rule pushes into terms of $\mathsf{F}$-, $\mathsf{U}$- and $s$-types:
\begin{align*}
\FI{\rewrite{s}{M}} &\equiv \rewrite{\ap{\mu}{s/x}}{\FI{M}} \\
(\FE{\rewrite{s}{M}}{x}{N}) &\equiv \rewrite{\ap{\nu'}{s/y}}{\StI{\ap{r}{s/y}}{\FE{M}{x}{N}}} \\
\UE{M}{\rewrite{s}{N}} &\equiv \rewrite{\ap{\mu[\nu_1/c]}{s/x}}{\StI{\ap{q}{s/x}}{\UE{M}{N}}} \\
\UE{(\rewrite{t}{M})}{N} &\equiv \rewrite{\ap{\mu[\nu_2/x]}{t/c}}{\UE{M}{N}} \\
\UI{x}{\rewrite{\ap{\mu}{s/c}}{M}}  &\equiv\rewrite{s}{\UI{x}{M}} \\
\StI{t}{\rewrite{s}{M}} &\equiv \rewrite{\ApPlus{t}{s}}{\StI{t}{M}} \\
(\StE{t}{\rewrite{s}{M}}{x}{N}) &\equiv \rewrite{\ap{\nu'}{s/y}}{\StI{\ap{r}{s/y}}{\StE{t}{M}{x}{N}}}
\intertext{If we have definitional eta-expansion for \textsf{F}- and $s$-types, we can also derive (rather than asserting)}
(\FE{M}{x}{\rewrite{s[\mu/y]}{N}}) &\equiv \rewrite{s[\nu/y]}{\FE{M}{x}{N}} \\
(\StE{t}{M}{x}{\rewrite{s[\TrPlus{t}{x}/y]}{N}}) &\equiv \rewrite{s[\nu/y]}{\StE{t}{M}{x}{N}} 
\end{align*}
\end{lemma}
\begin{proof}
For \textsf{F}-types:
\begin{align*}
\FI{\rewrite{s}{M}} 
&\equiv \rewrite{\id_{\mu[\nu/x]}}{\FI{x}}[\rewrite{s}{M}/x]  \\
&\equiv \rewrite{\ap{\mu}{s/x}}{\StI{\ap{q}{s/x}}{\FI{x}[M/x]}} \\
&\equiv \rewrite{\ap{\mu}{s/x}}{\StI{\ap{q}{s/x}}{\FI{M}}} \\
&\equiv \rewrite{\ap{\mu}{s/x}}{\FI{M}} && \text{As $x$ does not appear in $q$.}\\
(\FE{\rewrite{s}{M}}{x}{N})
&\equiv \rewrite{\id_{\nu'[\nu/y]}}{\FE{y}{x}{N}}[\rewrite{s}{M}/y] \\
&\equiv \rewrite{\ap{\nu'}{s/y}}{\StI{\ap{r}{s/y}}{(\FE{y}{x}{N})[M/y]}} \\
&\equiv \rewrite{\ap{\nu'}{s/y}}{\StI{\ap{r}{s/y}}{\FE{M}{x}{N}}}
\intertext{and assuming eta-expansion:}
\rewrite{s[\nu/y]}{\FE{M}{x}{N}}
&\equiv \rewrite{s}{\FE{y}{x}{N}} [M/y] \\
&\equiv \FE{M}{z}{(\rewrite{s}{\FE{y}{x}{N}}[\FI{z}/y])} \\
&\equiv \FE{M}{z}{(\rewrite{s[\mu/y]}{\FE{\FI{z}}{x}{N}})} \\
&\equiv \FE{M}{z}{\rewrite{s[\mu/y]}{N}}
\end{align*}

For \textsf{U}-types:
\begin{align*}
\UE{M}{\rewrite{s}{N}}
&\equiv \rewrite{\id_{\mu[z/x, \nu_1/c]}}{\UE{M}{z}}[\rewrite{s}{N}/z] \\
&\equiv \rewrite{\ap{\mu[\nu_1/c]}{s/x}}{\StI{\ap{q[\nu_1/c]}{s/x}}{\UE{M}{N}}} \\
&\equiv \rewrite{\ap{\mu[\nu_1/c]}{s/x}}{\StI{\ap{q}{s/x}}{\UE{M}{N}}} \\
\UE{(\rewrite{t}{M})}{N}
&\equiv \rewrite{\id_{\mu[\nu_2/x, z/c]}}{\UE{(z)}{N}}[\rewrite{t}{M}/z] \\
&\equiv \rewrite{\ap{\mu[\nu_2/x]}{t/c}}{\StI{\ap{q[\nu_2/x]}{t/c}}{\UE{M}{N}}} \\
&\equiv \rewrite{\ap{\mu[\nu_2/x]}{t/c}}{\UE{M}{N}} && \text{(As $c$ does not appear in $q$)}\\
\rewrite{s}{\UI{x}{M}}
&\equiv \UI{y}{\UE{(\rewrite{s}{\UI{x}{M}})}{y}} \\
&\equiv \UI{y}{\rewrite{\ap{\mu[y/x]}{s/c}}{\UE{(\UI{x}{M})}{y}}} \\
&\equiv \UI{y}{\rewrite{\ap{\mu[y/x]}{s/c}}{M[y/x]}} \\
&\equiv \UI{x}{\rewrite{\ap{\mu}{s/c}}{M}}
\end{align*}

And for $s$-types the reasoning is identical to that for \textsf{F}-types.
\end{proof}

\begin{lemma}
The \textsc{rewrite} rule pushes into types obtained by \textsf{F}- and $s$-elimination:
\begin{align*}
(\FE{\rewrite{s}{M}}{x}{C}) &\equiv \St{\ap{r}{s/y}}{\FE{M}{x}{C}} \\
(\StE{t}{\rewrite{s}{M}}{x}{C}) &\equiv \St{\ap{r}{s/y}}{\StE{t}{M}{x}{C}}
\end{align*}
\end{lemma}
\begin{proof}
This is analogous to elimination into terms:
\begin{align*}
\FE{\rewrite{s}{M}}{x}{C}
&\equiv (\FE{y}{x}{C})[\rewrite{s}{M}/y] \\
&\equiv \St{\ap{r}{s/y}}{(\FE{y}{x}{C})[M/y]} \\
&\equiv \St{\ap{r}{s/y}}{\FE{M}{x}{C}}
\end{align*}
and similarly for $s$-types.
\end{proof}

\begin{lemma}
The $\mathsf{U}$-style rules for $s$-types are derivable:
\begin{mathpar}
\inferrule*[Left = s-intro-2]{
    \Gamma \yields_{\TrCirc{s}{\mu}} M : B
  }
  {\Gamma \yields_{\mu} \UStI{s}{M} : \St{s}{B}
  } \and
  
  \inferrule*[Left = s-elim-2]{
    \Gamma \yields_{\mu} N : \St{s}{B}
  }{
    \Gamma \yields_{\TrCirc{s}{\mu}} \UnSt{s}{N} : B
  } \\
  \UnSt{s}{\UStI{s}{M}} \equiv M \and
  \UStI{s}{\UnSt{s}{N}} \equiv N \\
  \UnSt{t}{\UnSt{s}{N}} \equiv \UnSt{s;t}{N} \and
  \UStI{s}{\UStI{t}{M}} \equiv \UStI{s;t}{M} \and
\end{mathpar}
\end{lemma}
\begin{proof}
For the first:
\begin{mathpar}
\inferrule*[Left = rewrite]{
\inferrule*[Left = s-intro]{
    \Gamma \yields_{\TrCirc{s}{\mu}} M : A
  }
  {\Gamma \yields_{\TrPlus{s}{\TrCirc{s}{\mu}}} \StI{s}{M} : \St{s}{A}}}
  {
    {\Gamma \yields_{\mu} \UStI{s}{M} :\equiv \rewrite{\eta^s_\mu}{\StI{s}{M}} : \St{s}{A}}}
\end{mathpar}
And the second:
\begin{mathpar}
\inferrule*[Left = s-elim]{
\Gamma \yields_{\mu} N : \St{s}{B} 
\and
\inferrule*[left = rewrite]{
     \Gamma, x : B \yields_x x : B
  }{
    \Gamma, x : B \yields_{\TrCirc{s}{\TrPlus{s}{x}}} \rewrite{\varepsilon^s_x}{x} : B
  }
  }
  {
    \Gamma \yields_{\TrCirc{s}{\mu}} \UnSt{s}{N} :\equiv \StE{s}{N}{x}{\rewrite{\varepsilon^s_x}{x}} : B
  }
\end{mathpar}
Verifying the equations:
\begin{align*}
\UnSt{s}{\UStI{s}{M}}
&\equiv \StE{s}{\rewrite{\eta^s_\mu}{\StI{s}{M}}}{x}{\rewrite{\varepsilon^s_x}{x}} \\
&\equiv \rewrite{\ap{s^\circ}{\eta^s_\mu}}{\StE{s}{\StI{s}{M}}{x}{\rewrite{\varepsilon^s_x}{x}}} \\
&\equiv \rewrite{\ap{s^\circ}{\eta^s_\mu}}{\rewrite{\varepsilon^s_{\TrCirc{s}{\mu}}}{M}} \\
&\equiv \rewrite{\ap{s^\circ}{\eta^s_\mu};\varepsilon^s_{\TrCirc{s}{\mu}}}{M} \\
&\equiv M
\end{align*}
by one triangle identity, and:
\begin{align*}
\UStI{s}{\UnSt{s}{N}} 
&\equiv \UStI{s}{\StE{s}{N}{x}{\rewrite{\varepsilon^s_x}{x}}} \\ 
&\equiv \rewrite{\eta^s_\mu}{\StI{s}{\StE{s}{N}{x}{\rewrite{\varepsilon^s_x}{x}}}} \\ 
&\equiv \rewrite{\eta^s_y}{\StI{s}{\StE{s}{y}{x}{\rewrite{\varepsilon^s_x}{x}}}}[N/y] \\ 
&\equiv \StE{s}{N}{z}{\rewrite{\eta^s_y}{\StI{s}{\StE{s}{y}{x}{\rewrite{\varepsilon^s_x}{x}}}}[\StI{s}{z}/y]} \\ 
&\equiv \StE{s}{N}{z}{\rewrite{\eta^s_{\TrPlus{s}{z}}}{\StI{s}{\StE{s}{\StI{s}{z}}{x}{\rewrite{\varepsilon^s_x}{x}}}}} \\ 
&\equiv \StE{s}{N}{z}{\rewrite{\eta^s_{\TrPlus{s}{z}}}{\StI{s}{\rewrite{\varepsilon^s_x}{x}[z/x]}}} \\ 
&\equiv \StE{s}{N}{z}{\rewrite{\eta^s_{\TrPlus{s}{z}}}{\StI{s}{\rewrite{\varepsilon^s_z}{z}}}} \\ 
&\equiv \StE{s}{N}{z}{\rewrite{\eta^s_{\TrPlus{s}{z}}}{\rewrite{\ApPlus{s}{\varepsilon^s_z}}{\StI{s}{z}}}} \\ 
&\equiv \StE{s}{N}{z}{\rewrite{\eta^s_{\TrPlus{s}{z}};\ApPlus{s}{\varepsilon^s_z}}{\StI{s}{z}}} \\ 
&\equiv \StE{s}{N}{z}{\StI{s}{z}} \\ 
&\equiv N
\end{align*}
using the other.
\mvrnote{TODO: check fusion}
\end{proof}

\begin{lemma}
The $\mathsf{F}$-style rules are derivable from the $\mathsf{U}$-style rules.
\end{lemma}
\begin{proof}
\begin{align*}
\StI{s}{M} :\equiv \UStI{s}{\rewrite{\varepsilon^s_\mu}{M}} \\
\end{align*}
\mvrnote{TODO: all the rest}
\end{proof}

\begin{lemma}
The rewrite rule pushes into the $\mathsf{U}$-style rules by
\begin{mathpar}
\rewrite{t}{\UStI{s}{M}} \equiv \UStI{s}{\rewrite{\ap{s^\circ}{t}}{M}} \and \rewrite{\ap{s^\circ}{t}}{\UnSt{s}{N}} \equiv \UnSt{s}{\rewrite{t}{N}}
\end{mathpar}
\end{lemma}
\begin{proof}
The first:
\begin{align*}
\rewrite{t}{\UStI{s}{M}}
&\equiv \rewrite{t}{\rewrite{\eta^s_\mu}{\StI{s}{M}}} \\
&\equiv \rewrite{t;\eta^s_\mu}{\StI{s}{M}} \\
&\equiv \rewrite{\eta^s_{\mu'};\ApPlus{s}{\ApCirc{s}{t}}}{\StI{s}{M}} \\
&\equiv \rewrite{\eta^s_{\mu'}}{\StI{s}{\rewrite{\ApCirc{s}{t}}{M}}} \\
&\equiv \UStI{s}{\rewrite{\ApCirc{s}{t}}{M}} \\
\end{align*}
The second:
\begin{align*}
\UnSt{s}{\rewrite{t}{N}} 
&\equiv \StE{s}{\rewrite{t}{N}}{x}{\rewrite{\varepsilon^s_x}{x}} \\
&\equiv \rewrite{\ApCirc{s}{t}}{\StE{s}{N}{x}{\rewrite{\varepsilon^s_x}{x}}} \\
&\equiv \rewrite{\ApCirc{s}{t}}{\UnSt{s}{N}}
\end{align*}
\end{proof}

\begin{lemma}
The $\mathsf{F}$- and $\mathsf{U}$-style rules can be mixed-and-matched by:
\begin{mathpar}
\UnSt{s}{\StI{s}{M}} \equiv \rewrite{\varepsilon^s_\mu}{M} \and \StE{s}{\UStI{s}{M}}{z}{N} \equiv \rewrite{\ap{\nu'}{\eta^s_\mu/y}}{N} \\
\rewrite{\eta^s_{\mu}}{\StI{s}{\UnSt{s}{N}}} \equiv N \and \text{\mvrnote{one more}}
\end{mathpar}
\end{lemma}
\begin{proof}
\mvrnote{easy?}

Here's the third one:
\begin{align*}
\rewrite{\eta^s_{\mu}}{\StI{s}{\UnSt{s}{N}}} 
&\equiv \rewrite{\eta^s_{\mu}}{\StI{s}{\StE{s}{N}{x}{\rewrite{\varepsilon^s_x}{x}}}} \\
&\equiv \StE{s}{N}{x'}{(\rewrite{\eta^s_{\TrPlus{s}{x'}}}{\StI{s}{\StE{s}{\StI{s}{x'}}{x}{\rewrite{\varepsilon^s_x}{x}}}})} \\
&\equiv \StE{s}{N}{x'}{(\rewrite{\eta^s_{\TrPlus{s}{x'}}}{\StI{s}{\rewrite{\varepsilon^s_{x'}}{x'}}})} \\
&\equiv \StE{s}{N}{x'}{(\rewrite{\eta^s_{\TrPlus{s}{x'}}}{\rewrite{\ApPlus{s}{\varepsilon^s_{x'}}}{\StI{s}{x'}}})} \\
&\equiv \StE{s}{N}{x'}{(\rewrite{\eta^s_{\TrPlus{s}{x'}};\ApPlus{s}{\varepsilon^s_{x'}}}{\StI{s}{x'}})} \\
&\equiv \StE{s}{N}{x'}{\StI{s}{x'}} \\
&\equiv N
\end{align*}
\mvrnote{This also uses definitional eta for $s$-types, looks like we need it}
\end{proof}

\begin{lemma}
\textsc{F-elim} commutes with \textsc{s-elim}.
\end{lemma}
\begin{proof}
Using eta for $s$-types:
\begin{align*}
&\FE{(\StE{s}{M}{x'}{N'})}{x}{N} \\
&\equiv (\FE{(\StE{s}{z}{x'}{N'})}{x}{N})[M/z] \\
&\equiv \StE{s}{M}{z'}{((\FE{(\StE{s}{z}{x'}{N'})}{x}{N})[\StI{s}{z'}/z])} \\
&\equiv \StE{s}{M}{z'}{((\FE{(\StE{s}{\StI{s}{z'}}{x'}{N'})}{x}{N}))} \\
&\equiv \StE{s}{M}{z'}{(\FE{N'[z'/x']}{x}{N})} \\
&\equiv \StE{s}{M}{x'}{(\FE{N'}{x}{N})}
\end{align*}
\end{proof}

\begin{lemma}
\textsc{F-elim} fuses with \textsc{s-intro}.
\end{lemma}
\begin{proof}
\begin{align*}
&\FEs{\TrPlus{s}{\mu}}{\StI{s}{M}}{x}{N} \\
&\equiv \StE{s}{\StI{s}{M}}{y}{(\FEs{\mu}{y}{x}{N})} \\
&\equiv \FEs{\mu}{M}{x}{N}
\end{align*}
and
\begin{align*}
& \FEs{\mu[\TrPlus{s}{x}/x]}{M}{x}{N[\StI{s}{x}/x]} \\
&\equiv \FEs{\mu}{M}{y}{(\StE{s}{y}{x}{N[\StI{s}{x}/x]})}  \\
&\equiv \FEs{\mu}{M}{y}{N[y/x]} \\
&\equiv \FEs{\mu}{M}{x}{N}
\end{align*}
\end{proof}

\begin{lemma}
Any context $\Gamma$ can be tupled into a $\Sigma$ type $\Sigma \Gamma$, so that substitutions $\Gamma \yields \Theta : \Delta$ correspond bijectively to terms $\Gamma \yields \Sigma \Theta : \Sigma \Delta$. \mvrnote{Generalising to telescopes seems doable} 
\mvrnote{I have been pretty inconsistent with the notation for telescope types through this whole document}
\begin{mathpar}
\inferrule*{\yields_\gamma \Gamma}
             {\cdot \yields_{\Sigma \gamma} \Sigma \Gamma \TYPE}
\and
\inferrule*{~}
             {\sigma : \Sigma \Gamma \yields_{\fan{\gamma}} \fan{\Gamma} : \Gamma}
\and
\inferrule*{\Gamma \yields_\theta \Theta : \Delta}
             {\Gamma \yields_{\Sigma \theta} \Sigma \Theta : \Sigma \Delta}
\and
\inferrule*{\Gamma \yields\Theta : \Delta}
             {\Gamma \yields \Theta \equiv \fan{\Delta}[\Sigma \Theta / \sigma]}
\end{mathpar}
\drlnote{Other round-trip}
\end{lemma}
\begin{proof}
$\Sigma \Gamma$ is defined inductively by
\begin{align*}
\Sigma (\cdot) &:\equiv 1 \\
\Sigma (\Gamma, x : A) &:\equiv \sum_{\sigma : \Sigma \Gamma} A[\fan{\Gamma}] \\
\fan{(\cdot)} &:\equiv \cdot \\
\fan{\Gamma, x : A} &:\equiv (\fan\Gamma[\fst{\sigma}/\sigma]), \snd{\sigma}
\end{align*}
with each definition lying over the identical one downstairs. For $\Sigma \Theta$ we simultaneously verify the equation $\Theta \equiv \fan{\Delta}[\Sigma \Theta / \sigma]$, as we need it to hold for $(\Sigma \Theta, M)$ to be well typed.
\begin{align*}
\Sigma(\cdot) &:\equiv \mt : 1\\
\Sigma(\Theta, M : A) &:\equiv (\Sigma \Theta, M) : \sum_{\sigma : \Sigma \Delta} A[\fan{\Delta}] \\
(\cdot)[()/\sigma]  &\equiv (\cdot) \\
\fan{\Delta, x : A}[\Sigma(\Theta, M : A)/\sigma] &\equiv ((\fan{\Delta}[\fst{\sigma}/\sigma]), \snd{\sigma})[(\Sigma \Theta, M)/\sigma] \\
&\equiv (\fan{\Delta}[\Sigma \Theta/\sigma]), M \\
&\equiv \Theta, M
\end{align*}
\end{proof}

\begin{lemma}
Tupling respects substitution: for $\gamma \yields \theta : \delta$ and $\delta \yields \kappa : \lambda$, we have:
\begin{mathpar}
\Sigma(\kappa[\theta]) \equiv (\Sigma \kappa)[\theta]
\end{mathpar}
\end{lemma}
\begin{proof}
By induction on the length of $\lambda$:
\begin{align*}
\Sigma((\cdot)[\theta]) 
&\equiv \Sigma(\cdot) \\
&\equiv (\Sigma (\cdot))[\theta] \\
\Sigma((\kappa, M)[\theta])
&\equiv \Sigma(\kappa[\theta], M[\theta]) \\
&\equiv \Sigma(\kappa[\theta]), M[\theta] \\
&\equiv (\Sigma\kappa)[\theta], M[\theta] \\
&\equiv (\Sigma\kappa, M)[\theta]
\end{align*}
\end{proof}

\begin{definition}
A 2-cell between mode substitutions $\gamma\yields t : (\theta \vDash \theta') : \delta$ is given by a mode term 2-cell \[\gamma \yields \Sigma t : (\Sigma \theta \vDash_{\Sigma \delta} \Sigma \theta')\].
\end{definition}

\drlnote{Maybe write $\gamma\yields t : \theta \vDash_\delta \theta'$ ?
In the rules, we're writing things like $\gamma \mid \mu \vDash s :
\mu'$; we should be consistent about that versus this notation for where
the $s$ goes, and change one or the other.  I find things like $\Gamma
\vdash s : \mu \vDash_p \nu$ with two turnstiles hard to parse.
}

\begin{lemma}
N-ary ap and rewrite are admissible:
\begin{mathpar}
\inferrule*{\delta \vdash {q} \type \\
            \gamma \yields t : (\theta \vDash \theta') : \delta
           } 
           {\TypeTwo{\gamma}{\ap {q} {t}}{q[\theta]}{q[\theta']}}
\and
\inferrule*{\delta \yields {\nu} : {q} \\
            \gamma\yields t : (\theta \vDash \theta') : \delta
           } 
           {\TermTwoT{\gamma}{\ap \nu {t}}{\nu[\theta]}{\TrPlus{\ap{q}{t}}{\nu[\theta]}}{q[\theta]}} \\
 \inferrule*[Left = rewrite]{
   \Gamma \yields_{\theta'} \Theta : \Delta \and 
   \gamma \yields t : (\theta \vDash \theta') : \delta
  }
  {\Gamma \yields_{\theta} \rewrite{t}{\Theta} : \Delta}
\end{mathpar}
\end{lemma}
\begin{proof}
These are
\begin{align*}
\ap {q} {t} &:\equiv \ap{q[\fan{\delta}]}{\Sigma t/\sigma} \\
\ap {\nu} {t} &:\equiv \ap{\nu[\fan{\delta}]}{\Sigma t/\sigma} \\
\rewrite{t}{\Theta} &:\equiv \fan{\Delta}[\rewrite{\Sigma t}{\Sigma \Theta}/\sigma]
\end{align*}
which are well-typed by the equation $\theta \equiv \fan{\delta}[\Sigma \theta / \sigma]$.
\end{proof}

In particular, we have the following rules for building and using 2-cells between substitutions.
\begin{mathpar}
\inferrule{\gamma \yields t : \theta \vDash \theta' : \delta \and \gamma \yields s : (\mu[\theta] \vDash \TrPlus{\ap{p}{t}}{\mu'[\theta']})}
{ \gamma \yields (s, t) : (\theta, \mu) \vDash (\theta', \mu') : (\delta,x:p)} \\
%
\inferrule{\gamma \yields t : ((\theta, \mu) \vDash (\theta', \mu')) : (\delta, x : p)}
{\gamma \yields \ap{\fst}{t} : \theta \vDash \theta' } \and
%
\inferrule{\gamma \yields t : ((\theta, \mu) \vDash (\theta', \mu')) : (\delta, x : p)}
{\gamma \yields \ap{\snd}{t} : (\mu[\theta] \vDash \TrPlus{\ap{p}{\ap{\fst}{t}}}{\mu'[\theta']})}
\end{mathpar}%

\begin{lemma}
N-ary ap of a 2-cell on a substitution is admissible
\begin{mathpar}
\inferrule{\gamma \yields t : \theta \vDash \theta' : \delta \and \delta \yields \kappa : \lambda}
{\gamma \yields \ap{\kappa}{t} : \kappa[\theta] \vDash \kappa[\theta'] : \lambda}
\end{mathpar} 
\end{lemma}
\begin{proof}
Due to the equation $\Sigma(\kappa[\theta]) \equiv (\Sigma \kappa)[\theta]$ we can just define $\Sigma(\ap{\kappa}{t}) :\equiv \ap{(\Sigma \kappa)}{t}$.
\end{proof}

\begin{lemma}
N-ary associativity/interchange/etc. holds
\begin{align*}
\ap {(\nu[\theta])} {t} &\equiv \ap \nu {\ap \theta {t}} \\
s[\theta];\ap{\nu'}{t} &\equiv \ap{\nu}{t};\ap{(\TrPlus{\ap{q}{t}}{y})}{s[\theta']/y}
\end{align*}
\end{lemma}
\begin{proof}
\mvrnote{todo}
\end{proof}

\begin{lemma}
A N-ary versions of the equations concerning rewrites hold:
\begin{align*}
\St{(\ap{q}{t})}{B[\Theta]} &\equiv B[\rewrite{t}{\Theta}] \\
\rewrite{\ap{\nu}{t}}{\StI{\ap{q}{t}}{N[\Theta]}} &\equiv N[\rewrite{t}{\Theta}] \\
\rewrite{\ap{\kappa}{t}}{\Theta;\kappa} &\equiv \rewrite{t}{\Theta};\kappa
\end{align*}
\end{lemma}
\begin{proof}
\begin{align*}
B[\rewrite{t}{\Theta}] 
&\equiv B[\fan{\Delta}[\rewrite{\Sigma t}{\Sigma \Theta}/\sigma]] \\
&\equiv B[\fan{\Delta}][\rewrite{\Sigma t}{\Sigma \Theta}/\sigma] \\
&\equiv \St{\ap{q[\fan{\delta}]}{\Sigma t / \sigma}}{B[\fan{\Delta}][\Sigma \Theta/\sigma]} \\
&\equiv \St{\ap{q}{t}}{B[\Theta]}
\end{align*}
And:
\begin{align*}
N[\rewrite{t}{\Theta}]
&\equiv N[\fan{\Delta}[\rewrite{\Sigma t}{\Sigma \Theta}/\sigma]] \\
&\equiv N[\fan{\Delta}][\rewrite{\Sigma t}{\Sigma \Theta}/\sigma] \\
&\equiv \rewrite{\ap{\nu[\fan{\delta}]}{\Sigma t/\sigma}}{\StI{\ap{q[\fan{\delta}]}{\Sigma t/\sigma}}{N[\fan{\Delta}][\Sigma \Theta/\sigma]}} \\
&\equiv \rewrite{\ap{\nu}{t}}{\StI{\ap{q}{t}}{N[\Theta]}} \\
\end{align*}
And:
\begin{align*}
\rewrite{\ap{\kappa}{t}}{\Theta;\kappa}
&\equiv \fan{\Lambda}[\rewrite{\Sigma(\ap{\kappa}{t})}{\Sigma (\Theta;\kappa)}/\sigma] \\
&\equiv \fan{\Lambda}[\rewrite{\ap{(\Sigma \kappa)}{t}}{(\Sigma \kappa)[\Theta]}/\sigma] \\
&\equiv \fan{\Lambda}[(\Sigma \kappa)[\rewrite{t}{\Theta}]/\sigma] \\
&\equiv \fan{\Lambda}[(\Sigma \kappa)/\sigma][\rewrite{t}{\Theta}] \\
&\equiv \kappa[\rewrite{t}{\Theta}] \\
&\equiv \rewrite{t}{\Theta};\kappa
\end{align*}
using the previous equation.
\end{proof}

\begin{lemma}
Rewriting by a tuple is a tuple of rewritings:
\begin{align*}
\rewrite{(t, s/x)}{\Theta, M/x} \equiv (\rewrite{t}{\Theta}, \rewrite{s}{\StI{\ap{p}{t}}{M}})
\end{align*}
\end{lemma}
\begin{proof}
Unwinding definitions:
\begin{align*}
\rewrite{(t, s/x)}{\Theta, M/x}
&\equiv \fan{\Delta, x : A}[\rewrite{\Sigma (t, s/x)}{\Sigma (\Theta, M/x)}/\sigma] \\
&\equiv (\fan\Delta[\fst{\sigma}/\sigma], \snd{\sigma})[\rewrite{(\Sigma t, s)}{\Sigma\Theta, M}/\sigma] \\
&\equiv (\fan\Delta[\fst{\sigma}/\sigma], \snd{\sigma})[(\rewrite{\Sigma t}{\Sigma\Theta}, \rewrite{s}{\StI{\ap{p[\fan{\delta}]}{\Sigma t/\sigma}}{N}})/\sigma] \\
&\equiv (\fan\Delta[\rewrite{\Sigma t}{\Sigma\Theta}/\sigma], \rewrite{s}{\StI{\ap{p[\fan{\delta}]}{\Sigma t/\sigma}}{N}}) \\
&\equiv (\rewrite{t}{\Theta}, \rewrite{s}{\StI{\ap{p}{t}}{M}})
\end{align*}
\end{proof}

As a special case, note that we have
\begin{align*}
\rewrite{(\id_\Theta, s/x)}{\Theta, M/x} \equiv (\Theta, \rewrite{s}{M}/x)
\end{align*}

\subsection{Examples}

\begin{itemize}
\item 
The previous two-argument \F{\mu}{x:A,y:B} (for $x :p, y:q \vdash \mu :
r$) is now \F{z.\mu[\fst z/x,\snd z/y]}{\telety{x}{A}{B}}, using the
upstairs $\Sigma$-type ${\telety{x}{A}{B}}$, which has mode
$\sigmacl{x}{p}{q}$.  Iterating $\telety{x}{A}{B}$ plays the role of a
longer telescope.  
\end{itemize}

\section{Mode Theories}

\subsection{First-order Logic}

The mode theory for first-order logic consists of:
\begin{itemize}
\item a mode $(\ii,\times,\top)$ with a cartesian product; write
  $\pi^\alpha_x : \alpha \times x \Yields \alpha$.  $\pi$ should be
  natural in the sense that for $s : \beta \Yields \alpha$,
  $\pi^\beta_x;s \equiv (s \times \id_x);\pi^\alpha_x$.  
\item a dependent mode $\alpha : \ii \yields \PP{\alpha} \type$
\item whatever structure you want in each fiber, e.g. for each $\alpha$
  a cartesian product
  \begin{mathpar}
   \alpha : \ii \vdash \top^1 : \PP{\alpha} \and 
   \alpha : \ii, x : \PP{\alpha}, y : \PP{\alpha} \vdash x \times^1 y : \PP{\alpha}
  \end{mathpar}
\item then the idea is that $\TrCirc{\ApP{\pi^\alpha_x}}{-} \dashv
  \TrPlus{\ApP{\pi^\alpha_x}}{-}$ gives an adjunction in the mode
  theory, which we know gives a triple adjunction upstairs, which will be
  $\exists \dashv \pi \dashv \forall$.  So 
  $\exists$ is the $F$-type for 
  \begin{mathpar}
    \alpha : \ii, x : \ii, y : \PP{\alpha \times x} \vdash \TrCirc{\ApP{\pi^\alpha_x}}{y} : \PP{\alpha}
  \end{mathpar}
  and $\forall$ is the $U$ type for 
  \begin{mathpar}
    \alpha : \ii, x : \ii, y : \PP{\alpha} \vdash \TrPlus{\ApP{\pi^\alpha_x}}{y} : \PP{\alpha \times x}
  \end{mathpar}

  Momentarily write $\exists^\alpha_x(y)$ for
  $\TrCirc{\ApP{\pi^\alpha_x}}{y}$
  and $y[\pi^\alpha_x]$ for $\TrPlus{\ApP{\pi^\alpha_x}}{y}$, and more
  generally, for $s : \beta \yields \alpha$, write $\exists_s y$ for
  $\TrCirc{\ApP{s}}{y}$
  and $y[s]$ for
  $\TrPlus{\ApP{s}}{y}$.  This is probably a bad pun in general but it
  helps to see these in a more familiar notation: the unit and counit
  are
  \begin{mathpar}
    y \Yields_{(\alpha \times x)} (\exists^\alpha_x y)[\pi^\alpha_x]
    \and
    (\exists^\alpha_x (y[\pi^\alpha_x])) \Yields_{(\alpha)} y 
  \end{mathpar}

\item Suppose we have $\alpha,\beta : \ii, x : \ii$, $s : \beta \Yields
  \alpha$.  There are four possible ``interactions'' that we could have
  equations for.  
  \begin{mathpar}
    y : \PP{\alpha \times x} \vdash (\exists^\alpha_x y)[s] \equiv \exists^\beta_x (y[s \times \id])\\
    y : \PP{\beta \times x} \vdash \exists_s (\exists^\beta_x y) \equiv \exists^\alpha_x (\exists_{s \times \id}(y))\\
    y : \PP{\alpha} \vdash y[\pi^\alpha_x][s \times \id] \equiv y[s][\pi^\beta_x]\\
    y : \PP{\beta} \vdash \exists_{s \times \id}(y[\pi^\alpha_x]) \equiv (\exists_s {y})[\pi^\alpha_x]
  \end{mathpar}
  The second and third follow from naturality of $\pi$ and the fusion
  laws for $\TrCirc{s}{\TrCirc{t}{\mu}}$ and
  $\TrPlus{s}{\TrPlus{t}{\mu}}$.
  The first and fourth are what we need to assert for the upstairs
  $\exists$ and $\forall$ to be ``stable under structural rules''.

\item Given the above equations, for the unit and counit of
  $\pi^\alpha_x$, it type checks to equate
  \begin{mathpar}
   y : \PP{\alpha \times x} \vdash \eta_y[s \times \id] \equiv \eta_{y[s \times \id]}: y[s \times \id] \Yields_{(\beta \times x)} (\exists^\alpha_x y)[\pi^\alpha_x][s \times \id]
  \equiv (\exists^\beta_x (y[s \times \id]))[\pi^\beta_x]\\
  
  y : \PP{\alpha} \vdash \epsilon_y[s] \equiv \epsilon_{y[s]} : (\exists^\alpha_x (y[\pi^\alpha_x]))[s]
  \equiv \exists^\beta_x (y[\pi^\alpha_x][s \times \id]) \equiv \exists^\beta_x (y[s][\pi^\beta_x])  \Yields_{(\beta)} y[s]

  y : \PP{\beta \times x} \vdash \exists_{[s \times \id]}{\eta_y} \equiv
  \eta_{\exists_{s \times \id} y}
  :
  \exists_{s \times \id}(y) \Yields_{(\alpha \times x)} \exists_{s \times \id} (\exists^\alpha_x y)[\pi^\alpha_x]
  \equiv
  (\exists_{s} (\exists^\alpha_x y))[\pi^\beta_x]
  \equiv
  (\exists^\beta_x(\exists_{s \times \id}(y)))[\pi^\beta_x]\\
  
  y : \PP{\beta} \vdash \exists_s{\epsilon_y} \equiv \epsilon_{\exists_s(y)} : 
  \exists_{s}{(\exists^\beta_x (y[\pi^\beta_x]))} \equiv \exists^\alpha_x{\exists_{s \times \id} (y[\pi^\beta_x])} \equiv \exists^\alpha_x((\exists_{s}(y))[\pi^\alpha_x]) \Yields_{(\alpha)} \exists_{s}{y} 
  \end{mathpar}
  
  %% \and
  %%   (\exists^\alpha_x (y[\pi^\alpha_x])) \vdash_{(\alpha)} y 
\item \msnote{Presumably if $\delta_x : x \Yields x\times x $ is the cartesian diagonal, then the $F$-type for $\TrCirc{\ApP{\delta_x}}{-}$ is Lawvere equality?}
\end{itemize}

\subsection{Linear Logic with Cartesian First-order Quantifiers}

As above, except have a symmetric monoidal product $(\otimes^1,1^1)$ in
each fiber instead of a cartesian product.  

\subsection{Morphisms of Bifibrations}

Any dependent type $x : p \vdash A(x) \type$ is a bifibration in the
sense that for $s : \beta \Yields_p \alpha$ we have both $\ap{A}{s/x}^+
: A[\alpha/x] \to A[\beta/x]$ and $\ap{A}{s/x}^\circ : A[\beta/x] \to
A[\alpha/x]$.

\begin{definition}
Suppose (in any context $\gamma$) a type, with two dependent types
over it:
\begin{mathpar}
p \type \and x : p \vdash A(x) \type \and x : p \vdash B(x) \type 
\end{mathpar}
A \emph{morphism of bifibrations} from $A$ to $B$ consists of a term
\begin{mathpar}
x : p, z:A(x) \vdash f_1(x,z) : B(x)
\end{mathpar}
such that for for any $\alpha : p$, $s : \beta \Yields_p \alpha$, $\mu : A[\alpha/x]$, $\nu : A[\beta/x]$, the two maps
\begin{align}
\label{mor-fib-subst}
l_f(s, \mu) &: f_1(\beta,\TrPlus{\ap{A}{s/x}}{\mu}) \vDash_{B(\beta)} \TrPlus{\ap{B}{s/x}}{f_1(\alpha,\mu)}  \\
l_f(s, \mu) &:\equiv \ap{f_1(x,z)}{s/x, \id_{\TrPlus{\ap{A}{s}}{\mu}}/z} \nonumber \\
\label{mor-opfib-subst}
r_f(s, \nu) &: \TrCirc{\ap{B}{s}}{f_1(\beta,\nu)} \vDash_{B(\alpha)} f_1(\alpha,\TrCirc{\ap{A}{s}}{\nu}) \\
r_f(s, \nu) &:\equiv \ApCirc{\ap{B}{s}}{\ap{f_1(x,z)}{s/x, \eta^{\ap{A}{s}}_{\nu}/z}};\varepsilon^{\ap{B}{s}}_{f_1(\alpha,\TrCirc{\ap{A}{s}}{\nu})} \nonumber
\end{align}
are identities. \mvrnote{TODO: pick a better name for these maps?} \mvrnote{The reason the maps are defined so differently is that our mode theory is `$+$-biased'}
\end{definition}

The first equation says that $f_1$ is a ``morphism of fibrations'', in
the sense that it commutes with ``substitution'', in the sense of the
contravariant action of a mode type morphism.  The second says that it
is a ``morphism of opfibrations''.  

\begin{lemma}
For \emph{any} term $f_1(x,z)$ of the above shape, the following equations hold:
\begin{align*}
\ap{f_1(\beta,z)}{\eta^{\ap{A}{s}}_\nu/z} ; l_f(s, \TrCirc{\ap{A}{s}}{\nu}) &\equiv \eta^{\ap{B}{s}}_{f_1(\beta, \nu)} ; \ApPlus{\ap{B}{s}}{r_f(s, \nu)} \\
r_f(s, \TrPlus{\ap{B}{s}}{\mu}) ; \ap{f_1(\alpha,z)}{\varepsilon^{\ap{B}{s}}_\mu/z} &\equiv \ApCirc{\ap{A}{s}}{l_f(s,\mu)};\varepsilon^{\ap{A}{s}}_{f_1(\alpha, \mu)}
\end{align*}
\end{lemma}
\begin{proof}
The first:
\begin{align*}
&\eta^{\ap{B}{s}}_{f_1(\alpha, \nu)} ; \ApPlus{\ap{B}{s}}{r_f(s, \nu)} \\
&\equiv \eta^{\ap{B}{s}}_{f_1(\alpha, \nu)} ; \ApPlus{\ap{B}{s}}{\ApCirc{\ap{B}{s}}{\ap{f_1(x,z)}{s/x, \eta^{\ap{A}{s}}_{\nu}/z}};\varepsilon^{\ap{B}{s}}_{f_1(\alpha,\TrCirc{\ap{A}{s}}{\nu})}} \\
&\equiv \eta^{\ap{B}{s}}_{f_1(\alpha, \nu)} ; \ApPlus{\ap{B}{s}}{\ApCirc{\ap{B}{s}}{\ap{f_1(x,z)}{s/x, \eta^{\ap{A}{s}}_{\nu}/z}}};\ApPlus{\ap{B}{s}}{\varepsilon^{\ap{B}{s}}_{f_1(\alpha,\TrCirc{\ap{A}{s}}{\nu})}} \\
&\equiv \ap{f_1(x,z)}{s/x, \eta^{\ap{A}{s}}_{\nu}/z} ; \eta^{\ap{B}{s}}_{\TrPlus{\ap{B}{s}}{f_1(\alpha,\TrCirc{\ap{A}{s}}{\nu})}} ; \ApPlus{\ap{B}{s}}{\varepsilon^{\ap{B}{s}}_{f_1(\alpha,\TrCirc{\ap{A}{s}}{\nu})}} \\
&\equiv \ap{f_1(x,z)}{s/x, \eta^{\ap{A}{s}}_{\nu}/z} \\
&\equiv \ap{f_1(\alpha,z)}{\eta^{\ap{A}{s}}_\mu/z} ; l_f(s, \TrCirc{\ap{A}{s}}{\mu})
\end{align*}
The other equation is similar.
\end{proof}

\begin{corollary}
For $f_1$ a morphism of bifibrations, we have:
\begin{align}
\label{mor-fib-unit}
\ap{f_1(\beta,z)}{\eta^{\ap{A}{s/x}}_\nu/z} \equiv \eta^{{\ap{B}{s/x}}}_{f_1(\beta,\nu)} \\
\label{mor-fib-counit}
\ap{f_1(\alpha,z)}{\varepsilon^{\ap{A}{s/x}}_\mu/z} \equiv
\varepsilon^{{\ap{B}{s/x}}}_{f_1(\alpha,\mu)}
\end{align}
\end{corollary}

%The third and fourth say that $f_1$
%preserves the unit and counit of the $s^\circ \dashv s^+$ adjunctions.
%\drlnote{This is part of morphism of bifibrations because...}
%To type check \eqref{mor-fib-unit}, we have
%\begin{mathpar}
%\eta^{\ap{S}{s/x}}_\nu : \nu \Yields_{S[\beta/x]} \TrPlus{\ap{S}{s/x}}{\TrCirc{\ap{S}{s/x}}{\nu}}\\
%\ap{f_1(\beta,z)}{\eta^{\ap{S}{s/x}}_\nu/z} : f_1(\beta,\nu) \Yields_{S[\beta/x]} f_1(\beta,\TrPlus{\ap{S}{s/x}}{\TrCirc{\ap{S}{s/x}}{\nu}})
%\end{mathpar}
%But
%\begin{align*}
%  f_1(\beta,\TrPlus{\ap{S}{s/x}}{\TrCirc{\ap{S}{s/x}}{\nu}})
%  & \equiv
%\TrPlus{\ap{T}{s/x}}{f_1(\alpha,{\TrCirc{\ap{S}{s/x}}{\nu}})} \\
%& \equiv
%\TrPlus{\ap{T}{s/x}}{\TrCirc{\ap{T}{s/x}}{f_1(\beta,\nu)}}
%\end{align*}
%
%To type check \eqref{mor-fib-counit}, we have
%\begin{mathpar}
%\varepsilon^{\ap{S}{s/x}}_\mu : \TrCirc{\ap{S}{s/x}}{\TrPlus{\ap{S}{s/x}}{\mu}} \Yields_{S[\alpha/x]} \mu\\
%\ap{f_1(\alpha,z)}{\varepsilon^{\ap{S}{s/x}}_\mu/z} : f_1(\alpha,\TrCirc{\ap{S}{s/x}}{\TrPlus{\ap{S}{s/x}}{\mu}}) \Yields_{S[\alpha/x]} f_1(\alpha,\mu)\\
%f_1(\alpha,\TrCirc{\ap{S}{s/x}}{\TrPlus{\ap{S}{s/x}}{\mu}})
%\equiv
%\TrCirc{\ap{T}{s/x}}{\TrPlus{\ap{T}{s/x}}{f_1(\alpha,\mu)}}
%\end{mathpar}

%% Often, it will be the case that $f_1(x,z) := \TrCirc{t}{z}$ for some mode
%% type morphism $\TypeTwo{x : p}{t}{S}{T[f_0(x)/y]}$.  In this case, equation
%% \eqref{mor-opfib-subst} is automatic by fusion and naturality:
%% \begin{mathpar}
%% \TrCirc{t[\alpha/x]}{\TrCirc{\ap{S}{s/x}}{\nu}} \equiv \TrCirc{\ap{T[f_0(x)/y]}{s/x}}{\TrCirc{t[\beta/x]}{\nu}}\\
%% \end{mathpar}
%% In such circumstances, asserting that $(f_0,f_1)$ is a morphism of
%% bifibrations from $(p,S)$ to $(q,T)$ means asserting equations
%% \eqref{mor-fib-subst} \eqref{mor-fib-unit} \eqref{mor-fib-counit}.

\subsection{Terminal Objects}

\begin{definition}
For a mode $x : p$, a terminal object is specified by
\begin{mathpar}
\vdash \emptyset : p \and
\TermTwoT{x : p}{!_x}{x}{\emptyset}{p}
\end{mathpar}
such that $t \equiv \bang_x$ for all $\TermTwoT{\gamma}{t}{\mu}{\emptyset}{p}$.
\end{definition}

\begin{definition}
For a dependent mode $x : p \vdash S(x) \type$, a \emph{fibred terminal object} term is specified by:
\begin{mathpar}
x : p \vdash 1_x : S(x) \and
\TermTwoT{x : p, \mu : S(x)}{!_\mu}{\mu}{1_x}{S(x)}
\end{mathpar}
such that
\begin{align}
\label{bang-unique}
t & \equiv \bang_\mu && \text{where } \TermTwoT{\gamma}{t}{\mu}{1_\alpha}{S(\alpha)}\\
\label{s-plus-one-strict}
\TrPlus{\ap{S}{s}}{1_\alpha} &\equiv 1_\beta && \text{where } \TermTwoT{\gamma}{s}{\beta}{\alpha}{p}
\end{align}
\mvrnote{We may only actually need $\TrPlus{\ap{S}{s}}{1_\alpha} \cong 1_\beta$}
\end{definition}

\subsection{Comprehension Object (from a mode type morphism)}

\begin{definition}[Comprehension Object]\label{def:comprehension-object}
  A \emph{comprehension object} is specified by the following
  constants:
  \begin{mathpar}
    p \type \and 
    \emptyset : p \and
    \TermTwoT{\alpha : p}{\bang_p}{\alpha}{\emptyset}{p}
    \\
    \alpha : p \yields \El{p}{\alpha} \type \and
    \TypeTwo{\cdot}{\chi}{p}{\sigmacl{\alpha}{p}{\El{p}{\alpha}}}
    \\
    %% \alpha : p \yields 1_\alpha : \El{p}{\alpha} \and
    \TermTwoT{\alpha : p, \mu : \El{p}{\alpha}}{!_\mu}{\mu}{1_\alpha}{\El{p}{\alpha}}
  \end{mathpar}
  such that (where $\gamma \yields \alpha : p$ and $\gamma \yields \mu : \El{p}{\alpha}$)
\begin{align}
\label{empty-terminal} 
(\emptyset, \bang_p) &\text{ is a terminal object of } p \\
\label{chi-section}
\fst{\TrCirc{\chi}{\alpha}} &\equiv \alpha \\
\label{one-terminal} 
(1_\alpha, !_\mu) &\text{ is a fibred terminal object of } \El{p}{\alpha} 
\end{align}
  \noindent where 
 the terminal object of $\El{p}{\alpha}$ is given by 
  \begin{mathpar}
  \alpha : p \yields 1_\alpha : \El{p}{\alpha} \and 1_\alpha :\equiv \snd{\TrCirc{\chi}{\alpha}}
  \end{mathpar}
  This is well typed, as $\El{p}{\fst{\TrCirc{\chi}{\alpha}}} \equiv \El{p}{\alpha}$ by equation \eqref{chi-section}.
\end{definition}

\begin{definition}
Any comprehension object supports the following derived forms (where $\gamma \yields \alpha : p$
and $\gamma \yields \beta : p$ and
$\TermTwoT{\gamma}{s}{\beta}{\alpha}{p}$ and $\gamma \yields \mu :
\alpha$ and $\gamma \yields \nu : \beta$):
  \begin{itemize}
  \item Comprehension is given by $\chi^+$:
  \begin{mathpar}
  \alpha : p, x : \El{p}{\alpha} \yields \alpha.x : p \and \alpha.x :\equiv \TrPlus{\chi}{(\alpha, x)}
  \end{mathpar}
%  \item Pairing for the comprehension object is given by ap of
%  $.$ on the pairing for $\Sigma$-modes:
%  \begin{mathpar}
%  \inferrule{\TermTwoT{\gamma}{s}{\alpha}{\beta}{p} \and
%             %% \and \gamma \yields \mu : \alpha \and \gamma \yields \nu : \beta \and
%             \TermTwoT{\gamma}{m}{\mu}{\ApEl{p}{s}^+(\nu)}{\El{p}{\alpha}}}
%            {\TermTwoT{\gamma}{s \bdot m}{\alpha.\mu}{\beta.\nu}{p}} \and
%  s \bdot m :\equiv \ap{(\fst z \bdot \snd z)}{(s,t)/ (z:\sigmacl{\alpha}{p}{\El{p}{\alpha}})}
%  \end{mathpar}
  \item $\pi^\alpha_\mu$ and $\var{\mu}$ are defined via the counit of the adjunction $\chi^\circ \dashv \chi^+$.
  \begin{mathpar}
  {\TermTwoT{\alpha:p,x:\El{p}{\alpha}}{\pi^\alpha_x}{\alpha.x}{\alpha}{p}}
  \and
  \pi^\alpha_x :\equiv \ap \fst {\varepsilon^\chi_{(\alpha, x)}} \\
  {\TermTwoT{\alpha:p,x:\El{p}{\alpha}}{\var{x}}{1_{\alpha.x}}{\TrPlus{\ApEl{p}{\pi^\alpha_x}}{x}}{\El{p}{\alpha.x}}} 
    \and
    \mathsf{var}_x :\equiv \ap \snd {\varepsilon^\chi_{(\alpha, x)}}
  \end{mathpar}
  \item Pairing for the comprehension object is given by ap of
  $.$ on the pairing for $\Sigma$-modes:
  \begin{mathpar}
  \inferrule{\TermTwoT{\gamma}{s}{\alpha}{\beta}{p} \and
             %% \and \gamma \yields \mu : \alpha \and \gamma \yields \nu : \beta \and
             \TermTwoT{\gamma}{m}{\mu}{\TrPlus{\ApEl{p}{s}}{\nu}}{\El{p}{\alpha}}}
            {\TermTwoT{\gamma}{s \bdot m}{\alpha.\mu}{\beta.\nu}{p}} \and
  s \bdot m :\equiv \ApPlus{\chi}{(s, m)}
  \end{mathpar}
  \end{itemize}
\end{definition}

\noindent The triangle equalities for $\chi^\circ \dashv \chi^+$ take the following form:
\begin{align*}
%\eta_{\TrPlus{\chi}{(\alpha, x)}};\ap{(\TrPlus{\chi}{z})}{\varepsilon_{(\alpha, x)}/z} \equiv \id_{\TrPlus{\chi}{(\alpha, x)}} 
\eta_{\alpha.x};(\pi_x^\alpha \bdot \var{x}) &\equiv \id_{\alpha.x} \\
%\ap{(\TrCirc{\chi}{z})}{\eta_\alpha/z};\varepsilon_{\TrCirc{\chi}{\alpha}} \equiv \id_{\TrCirc{\chi}{\alpha}}
(\eta_\alpha ; \pi^\alpha_{1_\alpha}, \ap{1_z}{\eta_\alpha/z} ; \ApPlus{\ApEl{p}{\eta_\alpha}}{\var{1_\alpha}}) &\equiv \id_{(\alpha, 1_\alpha)}
\end{align*}
because $1_\alpha$ is terminal, only the first component of the latter equation has content, it says that $\eta_\alpha ; \pi^\alpha_{1_\alpha} = \id_\alpha$.

%The second triangle equation is
%\begin{mathpar}
%\ap{(\TrCirc{\chi}{z})}{\eta_\alpha/z};\varepsilon_{\TrCirc{\chi}{\alpha}} \equiv \id_{\TrCirc{\chi}{\alpha}}
%\end{mathpar}
%On the left this is:
%\begin{align*}
%\ap{(\TrCirc{\chi}{z})}{\eta_\alpha/z};\varepsilon_{\TrCirc{\chi}{\alpha}}
%&\equiv \ap{(z, 1_z)}{\eta_\alpha/z};\varepsilon_{(\alpha, 1_\alpha)} \\
%&\equiv (\eta_\alpha, \ap{1_z}{\eta_\alpha/z});(\pi^\alpha_{1_\alpha}, \var{1_\alpha}) \\
%&\equiv (\eta_\alpha ; \pi^\alpha_{1_\alpha}, \ap{1_z}{\eta_\alpha/z} ; \ap{\ApEl{p}{\eta_\alpha}^+}{\var{1_\alpha}})
%\end{align*}
%So componentwise the triangle equation says
%\begin{align*}
%\eta_\alpha ; \pi_{1_\alpha}^\alpha &\equiv \id_\alpha \\
%\ap{1_z}{\eta_\alpha/z} ; \ap{\ApEl{p}{\eta_\alpha}^+}{\var{1_\alpha}} &\equiv \id_{1_\alpha}
%\end{align*}

Some other derivable equations:
\begin{itemize}
\item Fusion for $.$
\begin{align}
\label{dot-fusion}
    (s \bdot m);(s' \bdot m') \equiv ((s;s') \bdot (m;\ApPlus{\ApEl{p}{s}} {m'}))
\end{align}
follows by fusing the ap's and the corresponding fusion rule for morphisms in $\Sigma$ modes:
\begin{align*}
(s \bdot m);(s' \bdot m') &\equiv \ApPlus{\chi}{(s, m)} ; \ApPlus{\chi}{(s', m')} \\
&\equiv \ApPlus{\chi}{(s, m);(s', m')} \\
&\equiv ((s;s') \bdot (m;\ApPlus{\ApEl{p}{s}} {m'}))
\end{align*}

\item $\pi^\alpha_\mu$ is natural in $\mu$:
  \begin{align}
  \label{pi-naturality}
  (s \bdot m); \pi^\alpha_\mu &\equiv \pi^\beta_\nu;s && \text{where } \TermTwoT{\gamma}{m}{\mu}{\TrPlus{\ApEl{p}{s}}{\nu}}{\El{p}{\alpha}}
  \end{align}
  by
  \begin{align*}
  (s \bdot m); \pi^\alpha_\mu 
  &\equiv \ApPlus{\chi}{(s, m)} ; \ap \fst {\varepsilon^\chi_{(\alpha, \mu)}} \\  
  &\equiv \ap{\fst}{\ApCirc{\chi}{\ApPlus{\chi}{(s, m)}}} ; \ap \fst {\varepsilon^\chi_{(\alpha, \mu)}} \\
  &\equiv \ap{\fst}{\ApCirc{\chi}{\ApPlus{\chi}{(s, m)}} ; \varepsilon^\chi_{(\alpha, \mu)}}  \\
  &\equiv \ap{\fst}{\varepsilon^\chi_{(\beta, \nu)}; (s, m) } \\
  &\equiv \ap{\fst}{\varepsilon^\chi_{(\beta, \nu)}} ; s\\
  &\equiv \pi^\beta_\nu ; s
  \end{align*}

%\item $\var{\mu}$ is natural in $\mu$:
%\begin{align}
%?
%\end{align}
%by
%  \begin{align*}
%  &\equiv \ap{\snd}{\ApCirc{\chi}{\ApPlus{\chi}{(s, m)}} ; \varepsilon^\chi_{(\alpha, \mu)}}  \\
%  &\equiv \ap{\snd}{\varepsilon^\chi_{(\beta, \nu)}; (s, m) } \\
%  &\equiv \ap{\snd}{(\ap{\fst}{\varepsilon^\chi_{(\beta, \nu)}}, \ap{\snd}{\varepsilon^\chi_{(\beta, \nu)}}); (s, m) } \\
%  &\equiv \ap{\snd}{(\ap{\fst}{\varepsilon^\chi_{(\beta, \nu)}};s, \ap{\snd}{\varepsilon^\chi_{(\beta, \nu)}};\ApPlus{\El{p}{\ap{\snd}{\varepsilon^\chi_{(\beta, \nu)}}}}{m})} \\
%  &\equiv \ap{\snd}{\varepsilon^\chi_{(\beta, \nu)}};\ApPlus{\El{p}{\ap{\snd}{\varepsilon^\chi_{(\beta, \nu)}}}}{m} \\
%  \end{align*}
\item Beta reduction for first projection:
  \begin{align}
\label{beta-pi}
\eta_\beta;(s \bdot m);\pi^\alpha_\mu &\equiv s && \text{where } \TermTwoT{\gamma}{m}{1_\alpha}{\TrPlus{\ApEl{p}{s}}{\mu}}{\alpha}
  \end{align}
follows from naturality and the second triangle equation by:
\begin{align*}
\eta_\beta;(s \bdot m);\pi^\alpha_\mu
&\equiv \eta_\beta;\pi^\beta_{1_\beta};s \\
&\equiv s
\end{align*}

\item Beta reduction for var:
\begin{align}
\label{beta-var}
\ApPlus{\ApEl{p}{(s \bdot m)}}{\var{\mu}} &\equiv \var{\nu};\ApPlus{\ApEl{p}{\pi^\beta_\nu}}{m}  && \text{where } \TermTwoT{\gamma}{m}{\nu}{\TrPlus{\ApEl{p}{s}}{\mu}}{\El{p}{\beta}}
\end{align}
is derivable by:
\begin{align*}
\ApPlus{\ApEl{p}{(s \bdot m)}}{\var{\mu}} 
&\equiv \ApPlus{\ApEl{p}{\ApPlus{\chi}{(s, m)}}}{\ap \snd {\varepsilon^\chi_{(\alpha, \mu)}}} \\
&\equiv \ap{1_z}{(s, m)/z};\ApPlus{\ApEl{p}{\ApPlus{\chi}{(s, m)}}}{\ap \snd {\varepsilon^\chi_{(\alpha, \mu)}}} \\
&\equiv \ap \snd {((s \bdot m), \ap{1_z}{(s, m)/z});\varepsilon^\chi_{(\alpha, \mu)}} \\
&\equiv \ap \snd {\ap{\TrCirc{\chi}{\TrPlus{\chi}{z}}}{(s, m)/z};\varepsilon^\chi_{(\alpha, \mu)}} \\
&\equiv \ap \snd {\varepsilon^\chi_{(\beta, \nu)};(s, m)} \\
&\equiv \var{\nu}; \ApPlus{\ApEl{p}{\pi^\beta_{\nu}}}{m} \\
\end{align*}

\item The eta principle for pairing:
\begin{align}
\label{eta-pi-var}
t &\equiv \eta_\beta;((t;\pi^\alpha_\mu) \bdot \ApPlus{\ApEl{p}{t}}{\var{\mu}}) && \text{where } \TermTwoT{\gamma}{t}{\beta}{\alpha.\mu}{p}
\end{align}
is derived by the first triangle equation followed by naturality of $\eta$:
\begin{align*}
t &\equiv t;\eta_{\alpha.\mu};(\pi_\mu^\alpha \bdot \var{\mu}) \\
&\equiv \eta_\beta;\ap{\TrPlus{\chi}{\TrCirc{\chi}{z}}}{t/z};(\pi_\mu^\alpha \bdot \var{\mu}) \\
&\equiv \eta_\beta;\ap{(z \bdot 1_z)}{t/z};(\pi_\mu^\alpha \bdot \var{\mu}) \\
&\equiv \eta_\beta;(t \bdot \ap{1_z}{t/z});(\pi_\mu^\alpha \bdot \var{\mu}) \\
&\equiv \eta_\beta;((t;\pi_\mu^\alpha) \bdot (\ap{1_z}{t/z}; \ApPlus{\ApEl{p}{t}}{\var{\mu}})) \\
&\equiv \eta_\beta;((t;\pi_\mu^\alpha) \bdot \ApPlus{\ApEl{p}{t}}{\var{\mu}})
\end{align*}
(We know that $\ap{1_z}{t/z} \equiv \id_{1_\beta}$ because $1_\beta$ is terminal.)

\item Naturality of $\eta^\chi_\beta$ takes the following form:
\begin{align*}
s;\eta^\chi_\mu \equiv \eta^\chi_{\mu'} ; (s \bdot \ap{1_x}{s/x})
\end{align*}

%\item Ap into $\pi^\alpha_x$: for $s : \mu \vDash_{\alpha} \nu$
%\begin{align}
%\ap{\TrCirc{\pi^\alpha_x}{y}}{s/x} \equiv \ApCirc{\pi^{\alpha}_{\nu}}{\varepsilon^{(\id_\alpha \bdot s)}_{y}}
%\end{align}
%by
%\begin{align*}
%&\ap{\TrCirc{\pi^\alpha_x}{y}}{s/x} \\
%&\equiv \ap{\TrCirc{\ap{\fst}{\varepsilon^\chi_{(\alpha, x)}}}{y}}{s/x} \\
%\end{align*}
\end{itemize}

We think of a term of mode $p$ as a ``context'', a mode term morphism of
mode $p$ as a ``substitution'', a term of mode $\El{p}{\alpha}$ as a
``dependent type'', and a mode term morphism $1_\alpha
\Yields_{\El{p}{\alpha}} \mu$ as a ``term'' of ``type'' $\mu$.  For the
equations: $\TrPlus{\ApEl{p}{s}}{-}$ is supposed to act like
substitution; equation \eqref{s-plus-one-strict} says that substitution
into the unit type gives the unit type in a different ``context''.

Equation \eqref{beta-var} says that ``substituting'' into a ``variable'' is second projection on the ``substitution''.  Equation \eqref{eta-pi-var} is the usual $\eta$ principle for subsitutions.

\begin{remark}
This axiomatization was inspired by the definition of comprehension
category with unit in \cite{ahman+16fibered}:
\msnote{I believe this definition is actually originally due to Ehrhard, and was reformulated later by Jacobs, before being picked up by AGP.  See \url{https://ncatlab.org/nlab/show/axiom+of+separation\#LawvereDefinition}.}
\begin{itemize}
\item A fibration $p : \mathcal{E} \to \mathcal{B}$
\item A functor $1 : \mathcal{B} \to \mathcal{E}$ that picks out the terminal object of each fiber,
\item A right adjoint $\{-\} : \mathcal{E} \to \mathcal{B}$ to the functor $1$.
\end{itemize}
In our notation:
\begin{itemize}
\item $\mathcal{B}$ corresponds to the mode $p$ and $\mathcal{E}$ to $\sigmacl{\alpha}{p}{\El{p}{\alpha}}$, with the morphisms in both categories given by the mode-term-2-cells in each.

\item The projection $p : \mathcal{E} \to \mathcal{B}$ is the function $\fst : \sigmacl{\alpha}{p}{\El{p}{\alpha}} \to p$. 

\item The functor $1$ is given by $\chi^\circ$ and $\{-\}$ is given by $\chi^+$, which are automatically adjoint.
\end{itemize}
\end{remark}

\begin{lemma}
For each $\alpha : p$, there is a (metatheoretic) adjunction with $F : p/\alpha \to T(\alpha)$ and $U : \El{p}{\alpha} \to p/\alpha$ given on objects by
\begin{align*}
F(s : \beta \vDash \alpha) &:= \TrCirc{\ApEl{p}{s}}{1_\beta} &&: \El{p}{\alpha} \\
U(x) &:= \pi^\alpha_x &&: \alpha.x \vDash_p \alpha
\end{align*}
with unit and counit
\begin{align*}
H(s) &= \eta^\chi_\beta ; (s \bdot \eta^{\ApEl{p}{s}}_{1_\beta}) &&: \beta \vDash_p \alpha.\TrCirc{\ApEl{p}{s}}{1_\beta} && \text{(as a map $s \to \pi^\alpha_{\TrCirc{\ApEl{p}{s}}{1_\beta}}$ of 2-cells over $\alpha$)} \\
E(x) &= \ap{\ApEl{p}{\pi^\alpha_x}^\circ}{\var{x}} ; \varepsilon^{\ApEl{p}{\pi^\alpha_x}}_x &&: \TrCirc{\ApEl{p}{\pi^\alpha_x}}{1_{\alpha.x}} \vDash_{\El{p}{\alpha}} x
\end{align*}
\end{lemma}
Note that the latter map is the transpose of $\var{x}$ across the $\ApEl{p}{\pi^\alpha_x}^\circ \dashv \ApEl{p}{\pi^\alpha_x}^+$ adjunction.
\begin{proof}
First we should spell out what the actions of $F$ and $U$ on morphisms are. For a morphism $t : \beta \vDash \beta'$ of 2-cells $s$ and $s'$ over $\alpha$, $F(t) : \TrCirc{\ApEl{p}{s}}{1_\beta} \vDash_{\El{p}{\alpha}} \TrCirc{\ApEl{p}{s'}}{1_{\beta'}}$ is the composite:
\begin{align*}
\TrCirc{\ApEl{p}{s}}{1_\beta} \equiv \TrCirc{\ApEl{p}{t;s'}}{1_\beta} \equiv \TrCirc{\ApEl{p}{s'}}{\TrCirc{\ApEl{p}{t}}{\TrPlus{\ApEl{p}{t}}{1_{\beta'}}}} \vDash \TrCirc{\ApEl{p}{s'}}{1_{\beta'}}
\end{align*}
i.e. $F(t) :\equiv \ap{(\ApEl{p}{s'})^\circ}{\varepsilon^{\ApEl{p}{t}}_{1_{\beta'}}}$.

And for a 2-cell $s : x \vDash_{\El{p}{\alpha}} y$, the morphism $U(s) : \pi^\alpha_x \vDash \pi^\alpha_y$ (as a 2-cell over $\alpha$) is given by $U(s) :\equiv (\id_\alpha \bdot s)$. This is indeed a 2-cell over $\alpha$ by naturality of $\pi$.

Now we can check the triangle identities. The following identity is needed:
\begin{align*}
&\varepsilon^{{H(s)}}_{1_{\alpha.\TrCirc{{s}}{1_\beta}}}; \var{\TrCirc{{s}}{1_\beta}} \\
&\equiv \ApCirc{H(s)}{\ApPlus{H(s)}{\var{\TrCirc{{s}}{1_\beta}}}} ; \varepsilon^{H(s)}_{\TrPlus{\pi^\alpha_{\TrCirc{s}{1_\beta}}}{\TrCirc{s}{1_\beta}}} 
&&\text{(Naturality of $\varepsilon$)} \\
&\equiv \ApCirc{H(s)}{\ApPlus{(\eta^\chi_\beta ; (s \bdot \eta^{s}_{1_\beta}))}{\var{\TrCirc{{s}}{1_\beta}}}} ; \varepsilon^{H(s)}_{\TrPlus{\pi^\alpha_{\TrCirc{s}{1_\beta}}}{\TrCirc{s}{1_\beta}}}
&&\text{(Definition of $H(s)$)} \\
&\equiv \ApCirc{H(s)}{\ApPlus{\eta^\chi_\beta}{\ApPlus{(s \bdot \eta^{s}_{1_\beta})}{\var{\TrCirc{{s}}{1_\beta}}}}} ; \varepsilon^{H(s)}_{\TrPlus{\pi^\alpha_{\TrCirc{s}{1_\beta}}}{\TrCirc{s}{1_\beta}}} 
&&\text{(Unfuse the transport)} \\
&\equiv \ApCirc{H(s)}{\ApPlus{\eta^\chi_\beta}{\ApPlus{\pi^\beta_{1_\beta}}{\eta^{s}_{1_\beta}}}} ; \varepsilon^{H(s)}_{\TrPlus{\pi^\alpha_{\TrCirc{s}{1_\beta}}}{\TrCirc{s}{1_\beta}}}
&&\text{(Beta reduction for $\var{}$)} \\
&\equiv \ApCirc{H(s)}{\eta^{s}_{1_\beta}} ; \varepsilon^{H(s)}_{\TrPlus{\pi^\alpha_{\TrCirc{s}{1_\beta}}}{\TrCirc{s}{1_\beta}}}
&&\text{(Triangle identity for $\chi$)} \\
&\equiv \ApCirc{H(s)}{\eta^{H(s);\pi^\alpha_{\TrCirc{s}{1_\beta}}}_{1_\beta}} ; \varepsilon^{H(s)}_{\TrPlus{\pi^\alpha_{\TrCirc{s}{1_\beta}}}{\TrCirc{s}{1_\beta}}}
&&\text{(Beta unreduction for $\pi$)} \\
&\equiv \ApCirc{H(s)}{\eta^{H(s)}_{1_\beta};\ApPlus{H(s)}{\eta^{\pi^\alpha_{\TrCirc{s}{1_\beta}}}_{\TrCirc{H(s)}{1_\beta}}}} ; \varepsilon^{H(s)}_{\TrPlus{\pi^\alpha_{\TrCirc{s}{1_\beta}}}{\TrCirc{s}{1_\beta}}}
&&\text{(Unfuse $\eta$ for a composite)} \\
&\equiv \ApCirc{H(s)}{\eta^{H(s)}_{1_\beta}};\ApCirc{H(s)}{\ApPlus{H(s)}{\eta^{\pi^\alpha_{\TrCirc{s}{1_\beta}}}_{\TrCirc{H(s)}{1_\beta}}}} ; \varepsilon^{H(s)}_{\TrPlus{\pi^\alpha_{\TrCirc{s}{1_\beta}}}{\TrCirc{s}{1_\beta}}}
&&\text{(Unfuse ap on a composite)} \\
&\equiv \ApCirc{H(s)}{\eta^{H(s)}_{1_\beta}} ; \varepsilon^{H(s)}_{\TrCirc{H(s)}{1_\beta}} ; \eta^{\pi^\alpha_{\TrCirc{s}{1_\beta}}}_{\TrCirc{H(s)}{1_\beta}}
&&\text{(Naturality of $\varepsilon$)} \\
&\equiv \eta^{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}_{\TrCirc{{H(s)}}{1_\beta}}
&&\text{(Triangle equation for $H(s)$)}
\end{align*}
Suppose we have $s : \beta \vDash \alpha$. Then:
\begin{align*}
&F(H(s)) ; E(F(s)) \\
&\equiv \ap{({\pi^\alpha_{\TrCirc{{s}}{1_\beta}}})^\circ}{\varepsilon^{{H(s)}}_{1_{\alpha.\TrCirc{{s}}{1_\beta}}}} ; E(\TrCirc{{s}}{1_\beta}) && \text{(Definition of $F$)} \\
&\equiv \ap{({\pi^\alpha_{\TrCirc{{s}}{1_\beta}}})^\circ}{\varepsilon^{{H(s)}}_{1_{\alpha.\TrCirc{{s}}{1_\beta}}}} ; \ap{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}^\circ}{\var{\TrCirc{{s}}{1_\beta}}};\varepsilon^{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}_{\TrCirc{{s}}{1_\beta}} && \text{(Definition of $E$)} \\
&\equiv \ap{({\pi^\alpha_{\TrCirc{{s}}{1_\beta}}})^\circ}{\varepsilon^{{H(s)}}_{1_{\alpha.\TrCirc{{s}}{1_\beta}}}; \var{\TrCirc{{s}}{1_\beta}}} ;\varepsilon^{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}_{\TrCirc{{s}}{1_\beta}} && \text{(Fuse ap)} \\
&\equiv \ap{(\TrCirc{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}{z})}{\eta^{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}_{\TrCirc{{H(s)}}{1_\beta}}/z};\varepsilon^{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}_{\TrCirc{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}{\TrCirc{{H(s)}}{1_\beta}}} && \text{(Above equation)} \\
&\equiv \id_{\TrCirc{{\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}{\TrCirc{{H(s)}}{1_\beta}}} && \text{(Triangle equation for $\pi$)} \\
&\equiv \id_{\TrCirc{{H(s);\pi^\alpha_{\TrCirc{{s}}{1_\beta}}}}{1_\beta}} && \text{(Fuse transports)} \\
&\equiv \id_{\TrCirc{{s}}{1_\beta}} && \text{(Beta reduction for $\pi$)} \\
&\equiv \id_{F(s)}
\end{align*}

Mercifully the other one is easier:
\begin{align*}
H(U(x)); U(E(x))
&\equiv H(\pi^\alpha_x) ; (\id_\alpha, E(x)) \\
&\equiv \eta^\chi_{\alpha.x} ; (\pi^\alpha_x \bdot \eta^{{\pi^\alpha_x}}_{1_{\alpha.x}}) ; (\id_\alpha, (\ap{{\pi^\alpha_x}^\circ}{\var{x}} ; \varepsilon^{{\pi^\alpha_x}}_x)) \\
& \text{(Fusion for $\bdot$)} \\
&\equiv \eta^\chi_{\alpha.x} ; (\pi^\alpha_x \bdot \eta^{{\pi^\alpha_x}}_{1_{\alpha.x}} ; \ApPlus{{\pi^\alpha_x}}{\ap{{\pi^\alpha_x}^\circ}{\var{x}} ; \varepsilon^{{\pi^\alpha_x}}_x}) \\
& \text{(Fusion for ap)} \\
&\equiv \eta^\chi_{\alpha.x} ; (\pi^\alpha_x \bdot \eta^{{\pi^\alpha_x}}_{1_{\alpha.x}} ; \ApPlus{{\pi^\alpha_x}}{\ap{{\pi^\alpha_x}^\circ}{\var{x}}} ; \ApPlus{{\pi^\alpha_x}}{\varepsilon^{{\pi^\alpha_x}}_x}) \\
& \text{(Naturality of $\eta$)} \\
&\equiv \eta^\chi_{\alpha.x} ; (\pi^\alpha_x \bdot \var{x} ; \eta^{{\pi^\alpha_x}}_{\ApPlus{{\pi^\alpha_x}}{x}} ; \ApPlus{{\pi^\alpha_x}}{\varepsilon^{{\pi^\alpha_x}}_x}) \\
&\text{(Triangle identity for ${\pi^\alpha_x}$)} \\
&\equiv \eta^\chi_{\alpha.x} ; (\pi^\alpha_x \bdot \var{x}) \\
&\text{(Triangle identity for $\chi$)} \\
&\equiv \id_{\alpha.x}
\end{align*}
\end{proof}

For future use, some identities involving $H$: \mvrnote{Surely these can be expressed/simplified using the $F$ and $U$ functors from above?}

\begin{lemma}\label{lemma:h-on-composite}
For $\gamma \yields s : \beta \vDash_p \alpha$ and $\gamma \yields t : \alpha \vDash_p \lambda$
\begin{align*}
H(s;t) &\equiv H(s) ; (t \bdot \eta^{\ApEl{p}{t}}_{\TrCirc{\ApEl{p}{s}}{1_\beta}}) \\
H(s ; t) ; (\id_\lambda \bdot \ap{t^\circ}{\varepsilon^{s}_{1_{\alpha}}}) &\equiv s ; H(t) \\
H(s) ; \pi^\alpha_{\TrCirc{s}{1_\beta}} &\equiv s
\end{align*}
\end{lemma}
\begin{proof}
\begin{align*}
H(s;t)
&\equiv \eta^\chi_\beta ; ((s;t) \bdot \eta^{\ApEl{p}{s;t}}_{1_\beta}) \\
&\equiv \eta^\chi_\beta ; ((s;t) \bdot (\eta^{\ApEl{p}{s}}_{1_\beta} ; (\ApPlus{\ApEl{p}{s}}{\eta^{\ApEl{p}{t}}_{\TrCirc{\ApEl{p}{s}}{1_\beta}}})) \\
&\equiv \eta^\chi_\beta ; (s \bdot \eta^{\ApEl{p}{s}}_{1_\beta}) ; (t \bdot \eta^{\ApEl{p}{t}}_{\TrCirc{\ApEl{p}{s}}{1_\beta}}) \\
&\equiv H(s) ; (t \bdot \eta^{\ApEl{p}{t}}_{\TrCirc{\ApEl{p}{s}}{1_\beta}}) \\
\end{align*}
And
\begin{align*}
H(s ; t) ; (\id_\lambda \bdot \ap{t^\circ}{\varepsilon^{s}_{1_{\alpha}}})
&\equiv \eta^\chi_\beta ; ((s;t) \bdot \eta^{s;t}_{1_\beta}) ; (\id_\lambda \bdot \ap{t^\circ}{\varepsilon^{s}_{1_{\alpha}}}) \\
&\equiv \eta^\chi_\beta ; ((s;t) \bdot (\eta^{s;t}_{1_\beta} ; \ApPlus{(s;t)}{\ap{t^\circ}{\varepsilon^{s}_{1_{\alpha}}}})) \\
&\equiv \eta^\chi_\beta ; ((s;t) \bdot (\eta^s_{1_\beta} ; (\ApPlus{s}{\eta^{t}_{\TrCirc{s}{1_\beta}}} ; \ApPlus{(s;t)}{\ap{t^\circ}{\varepsilon^{s}_{1_{\alpha}}}})) \\
&\equiv \eta^\chi_\beta ; ((s;t) \bdot (\eta^s_{1_\beta} ; (\ApPlus{s}{\eta^{t}_{\TrCirc{s}{1_\beta}}} ; \ApPlus{s}{\ApPlus{t}{\ap{t^\circ}{\varepsilon^{s}_{1_{\alpha}}}}})) \\
&\equiv \eta^\chi_\beta ; ((s;t) \bdot (\eta^s_{1_\beta} ; (\ApPlus{s}{\varepsilon^{s}_{1_{\alpha}} ; \eta^{t}_{\TrCirc{s}{1_\beta}}} )) \\
&\equiv \eta^\chi_\beta ; ((s;t) \bdot (\eta^s_{\ApPlus{s}{1_\alpha}} ; \ap{s^+}{\varepsilon^{s}_{1_{\alpha}}} ; \ApPlus{s}{\eta^{t}_{\TrCirc{s}{1_\beta}}} )) \\
&\equiv \eta^\chi_\beta ; ((s;t) \bdot \ApPlus{s}{\eta^{t}_{\TrCirc{s}{1_\beta}}}) \\
&\equiv \eta^\chi_\beta ; (s \bdot \ap{1_x}{s/x}) ; (t \bdot \eta^{t}_{\TrCirc{s}{1_\beta}}) \\
&\equiv s ; \eta^\chi_\alpha ; (t \bdot \eta^{t}_{\TrCirc{s}{1_\beta}}) \\
&\equiv s ; H(t)
\end{align*}
The third equation is exactly beta-reduction for $\pi$.
\end{proof}

If the adjunction is an equivalence for every $\alpha$ \mvrnote{Do we need any extra compatibility?}, then the $T(\alpha)$ bifibration is equivalent to the codomain bifibration and $(p,\El{p}{-},\chi_p)$ is describing a category with finite limits. 

\begin{definition}
  A comprehension object is an \emph{object with finite limits} if the unit and counit described above are isomorphisms, so there exist inverses:
  \begin{align*}
  H^{-1}(s) : \alpha.\TrCirc{\ApEl{p}{s}}{1_\beta} \vDash_p \beta && \text{(as a map $\pi^\alpha_{\TrCirc{\ApEl{p}{s}}{1_\beta}} \to s$ of 2-cells over $\alpha$)} \\
  E^{-1}(x) : x \vDash_{\El{p}{\alpha}} \TrCirc{\ApEl{p}{\pi^\alpha_x}}{1_{\alpha.x}}
  \end{align*}
  For completeness, being inverses means that:
  \begin{align*}
  \eta^\chi_\beta ; (s \bdot \eta^{\ApEl{p}{s}}_{1_\beta}) ; H^{-1}(s) &\equiv \id_\beta \\
   H^{-1}(s) ; \eta^\chi_\beta ; (s \bdot \eta^{\ApEl{p}{s}}_{1_\beta}) &\equiv \id_{\alpha.\TrCirc{\ApEl{p}{s}}{1_\beta}} \\
   H^{-1}(s) ; s &\equiv \pi^\alpha_{\TrCirc{\ApEl{p}{s}}{1_\beta}} \\
   \ap{\ApEl{p}{\pi^\alpha_x}^\circ}{\var{x}} ; \varepsilon^{\ApEl{p}{\pi^\alpha_x}}_x ; E^{-1}(x) &\equiv \id_{\TrCirc{\ApEl{p}{\pi^\alpha_x}}{1_{\alpha.x}}} \\
   E^{-1}(x) ; \ap{\ApEl{p}{\pi^\alpha_x}^\circ}{\var{x}} ; \varepsilon^{\ApEl{p}{\pi^\alpha_x}}_x &\equiv \id_x  
  \end{align*}
\end{definition}

Naturality of these inverses ought to follow from naturality of $H$ and $E$.

It may be more convenient to demand the unit and counit are identities, not just isomorphisms:

\begin{definition}
  A comprehension object is an \emph{very strict object with finite limits} if the following equations hold:
  \begin{align}
\label{circ-one}
\ApEl{p}{\pi^\alpha_\mu}^\circ(1_{\alpha.\mu}) &\equiv \mu \\
\label{counit-identity}
\ap{\ApEl{p}{\pi^\alpha_x}^\circ}{\var{x}} ; \varepsilon^{\ApEl{p}{\pi^\alpha_x}}_x &\equiv \id_x \\
\label{dot-circ-one}
\alpha.(\ApEl{p}{s}^\circ(1_\beta)) &\equiv \beta \\
\label{pi-dot-circ-one}
\pi^\alpha_{\ApEl{p}{s}^\circ(1_\beta)} &\equiv s \\
\label{unit-identity}
\eta^\chi_\beta ; (s \bdot \eta^{\ApEl{p}{s}}_{1_\beta}) &\equiv \id_\beta
  \end{align}
\end{definition}
Equations \eqref{circ-one} and \eqref{counit-identity} express that the counit of the adjunction between $p/\alpha$ and $T(\alpha)$ is the identity, and equations \eqref{dot-circ-one}, \eqref{pi-dot-circ-one} and \eqref{unit-identity} express that the unit is the identity.

Consequences of this:
\begin{itemize}
\item More general version of equation  \eqref{dot-circ-one}:
\begin{align}
\tag{\ref{dot-circ-one}'} \label{dot-circ}
\alpha. (\ApEl{p}{s}^\circ(\nu)) &\equiv \beta.\nu
\end{align}
By:
\begin{align*}
\alpha.(\ApEl{p}{s}^\circ(\nu))
&\equiv\alpha.(\ApEl{p}{s}^\circ \ApEl{p}{\pi^\beta_\nu}^\circ(1_{\beta.\nu})) \\
&\equiv\alpha.(\ApEl{p}{\pi^\beta_\nu;s}^\circ(1_{\beta.\nu})) \\
&\equiv \beta.\nu
\end{align*}
\item Corresponding more general version of equation \eqref{pi-dot-circ-one}:
\begin{align}
\tag{\ref{pi-dot-circ-one}'} \label{pi-dot-circ}
\pi^\alpha_{\ApEl{p}{s}^\circ(\nu)} &\equiv \pi^\beta_\nu;s
\end{align}
By:
\begin{align*}
\pi^\alpha_{\ApEl{p}{s}^\circ(\nu)}
&\equiv \pi^\alpha_{\ApEl{p}{s}^\circ(\ApEl{p}{\pi^\beta_\nu}^\circ(1_{\beta.\nu}))} \\
&\equiv \pi^\alpha_{\ApEl{p}{\pi^\beta_\nu;s}^\circ(1_{\beta.\nu})} \\
&\equiv \pi^\beta_\nu;s 
\end{align*}
\item Two terms $\mu, \nu : \El{p}{\alpha}$ are equal iff their comprehensions and projections are equal:
\begin{align}
\inferrule{\alpha.\mu \equiv \alpha.\nu \and \pi^\alpha_\mu \equiv \pi^\alpha_\nu}{\mu \equiv \nu}
\end{align}
Follows by:
\begin{align*}
\mu 
&\equiv \TrCirc{\ApEl{p}{\pi^\alpha_\mu}}{1_{\alpha.\mu}} \\
&\equiv \TrCirc{\ApEl{p}{\pi^\alpha_\nu}}{1_{\alpha.\nu}} \\
&\equiv \nu
\end{align*}
\item The old definition of $\var{x}$ is equal to the new one obtained directly from $\chi$.
\begin{align}
\var{x} \equiv \eta^{\ApEl{p}{\pi^\alpha_x}}_{1_{\alpha.x}}
\end{align}
Specialising equation \eqref{unit-identity} to $s \equiv \pi^\alpha_x$, we have
\begin{align*}
\eta^\chi_{\alpha.x} ; (\pi^\alpha_x \bdot \eta^{\ApEl{p}{\pi^\alpha_x}}_{1_{\alpha.x}}) \equiv \id_{\alpha.x}
\end{align*}
but the first triangle equation for $\chi$ claims that already
\begin{align*}
\eta^\chi_{\alpha.x};(\pi_x^\alpha \bdot \var{x}) &\equiv \id_{\alpha.x}
\end{align*}
so $(\pi_x^\alpha \bdot \var{x}) \equiv (\pi^\alpha_x \bdot \eta^{\ApEl{p}{\pi^\alpha_x}}_{1_{\alpha.x}})$ and the result follows.
\end{itemize}
Equation \eqref{circ-one} is an $\eta$ principle that a term of mode
$\El{p}{\alpha}$ (i.e. a ``dependent type'') is determined by its
comprehension and projection. Equation \eqref{dot-circ} says
that the comprehension of $s^\circ(\mu)$ is the same as the
comprehension of $\mu$, while equation \eqref{pi-dot-circ} says that the
projection is determined by $s$ and the projection from $\beta$ (which
type checks using \eqref{dot-circ}).

%An automatic consequence of $1_\alpha$ being terminal is that $\eta_\alpha$ is an isomorphism. We might prefer it to be an identity:
%
%\begin{definition}
%  A comprehension object is \mvrnote{super cool} if:
%\begin{align}
%\label{dot-one-strict}
%\alpha.1_{\alpha} &\equiv \alpha\\
%\label{chi-unit-identity}
%\eta^\chi_\alpha &\equiv \id_\alpha
%\end{align}
%\end{definition}
%Consequences of being \mvrnote{super cool}:
%\begin{itemize}
%\item Projecting away $1_\alpha$ is the identity:
%\begin{align}
%\label{pi-one-strict}
%\pi^\alpha_{1_\alpha} \equiv \id_\alpha 
%\end{align}
%\item Pairing with $\id_{1_\alpha}$ is the identity:
%\begin{align}
%\label{pair-s-bang}
%(s \bdot \id_{1_\alpha}) \equiv s
%\end{align}
%By
%\begin{align*}
%(s \bdot \id_{1_\alpha}) 
%&\equiv (s \bdot \id_{1_\alpha}); \pi^\alpha_{1_\alpha} \\
%&\equiv \pi^\alpha_{1_\alpha};s \\
%&\equiv s
%\end{align*}
%\end{itemize}

\begin{definition}\label{def:supports-weak-sigmas}
  A comprehension object \emph{supports weak $\Sigma$s} if
\[
  z:\sigmacl{\alpha}{p}{\El{p}{\alpha}}, y : \El{p}{\fst z \bdot \snd z}
  \vdash \TrCirc{(\pi^{\fst z}_{\snd{z}})}{y} : \El{p}{\fst z} 
\]
is a morphism of bifibrations from $\El{p}{\fst z \bdot \snd z}$ to $\El{p}{\fst z}$ over $z : \sigmacl{\alpha}{p}{\El{p}{\alpha}}$.
\end{definition}
Expanding the definition, this is asking that for any 
\begin{align*}
\alpha, \beta &: p \\
\mu &: \El{p}{\beta} \\
\nu &: \El{p}{\alpha} \\
s &: \beta\Yields_p \alpha \\
m &: \mu \Yields_{\El{p}{\beta}} \TrPlus{s}{\nu} \\
z &: \El{p}{\alpha.\mu} \\
z' &: \El{p}{\beta.\nu}
\end{align*}
the morphisms
\begin{align*}
l_f(s \bdot m, z) &:\TrCirc{\pi^{\beta}_\mu}{\TrPlus{(s . m)}{z}} \vDash_\beta \TrPlus{s}{\TrCirc{\pi^{\alpha}_\nu}{z}} \\
l_f(s \bdot m, z) &:\equiv \ap{\TrCirc{\pi^a_x}{z}}{s/a, m/x,\id_{\TrPlus{(s . m)}{z}}/z} \\
r_f(s \bdot m, z') &: \TrCirc{s}{\TrCirc{\pi^{\beta}_{x}}{z'}} \vDash_\beta \TrCirc{\pi^{\alpha}_y}{\TrCirc{(s . m)}{z'}} \\
r_f(s \bdot m, z') &:\equiv \ApCirc{s}{\ap{\TrCirc{\pi^a_x}{z'}}{s/a, m/x,\eta^{(s \bdot m)}_{z'}/{z'}}};\varepsilon^{s}_{\TrCirc{\pi^{\alpha}_\nu}{\TrCirc{(s . m)}{z'}}}
\end{align*}
are identities.

\begin{definition}\label{def:supports-strong-sigmas}
A comprehension object \emph{supports strong $\Sigma$s} if, additionally,
\begin{align*}
\mathtt{pair}(\alpha,x,y) :\equiv (\pi^\alpha_x \bdot \eta^{\pi^\alpha_x}_y) : \alpha.x.y \vDash \alpha.\TrCirc{\pi^\alpha_x}{y}
\end{align*}
is an isomorphism.
\end{definition}

\begin{definition}\label{def:supports-pis}
  A comprehension object \emph{supports $\Pi$s} if
\[
  z:\sigmacl{\alpha}{p}{\El{p}{\alpha}}, y : \El{p}{\fst z}
  \vdash \TrPlus{(\pi^{\fst z}_{\snd{z}})}{y} : \El{p}{\fst z \bdot \snd z} 
\]
is a morphism of bifibrations from $\El{p}{\fst z}$ to $\El{p}{\fst z \bdot \snd z}$ over $z : \sigmacl{\alpha}{p}{\El{p}{\alpha}}$.
\end{definition}
This is asking that for any $\alpha, \beta, x, y, s, m$ as above, and
\begin{align*}
w &: \El{p}{\alpha} \\
w' &: \El{p}{\beta}
\end{align*}
we have
\begin{align*}
l_f(s \bdot m, w) &: \TrPlus{\pi^{\beta}_\mu}{\TrPlus{s}{w}} \vDash_{\beta.\mu} \TrPlus{(s . m)}{\TrPlus{\pi^{\alpha}_{\nu}}{w}} \\
l_f(s \bdot m, w) &:\equiv \ap{\TrCirc{\pi^a_x}{z}}{s/a, m/x,\id_{\TrPlus{s}{w}}/w} \\
r_f(s \bdot m, w') &: \TrCirc{(s \bdot m)}{\TrPlus{\pi^{\beta}_{\mu}}{w'}} \vDash_{\beta.\mu} \TrPlus{\pi^{\alpha}_\nu}{\TrCirc{s}{w'}} \\
r_f(s \bdot m, w') &:\equiv \ApCirc{(s\bdot m)}{\ap{\TrPlus{\pi^a_x}{w'}}{s/a, m/x,\eta^{s}_{w'}/{w'}}};\varepsilon^{s}_{\TrPlus{\pi^{\alpha}_\nu}{\TrCirc{s}{w'}}}
\end{align*}

%We are also hoping that $\TrCirc{\ApEl{p}{\pi^\alpha_\mu}}{1_{\alpha.\mu}}$ is isomorphic to $\mu$. We have a map $\TrCirc{\ApEl{p}{\pi^\alpha_\mu}}{1_{\alpha.\mu}} \vDash \mu$ as the transpose of $\var{\mu}$. Is there a map in the other direction?

%\begin{theorem}
%If $p$ supports stable $\Pi$s and $\Sigma$s, then $H(s)$ and $E(x)$ are isomorphisms, or they sometime are.
%\end{theorem}
%\begin{proof}
%We have already seen that $H(\pi^\alpha_x) ; (\id_\alpha, E(x)) \equiv \id_{\alpha.x}$. Also:
%\begin{align*}
%(\id_\alpha, E(x)) ; H(\pi^\alpha_x) 
%&\equiv (\id_\alpha, E(x)) ; \eta^\chi_{\alpha.x} ; (\pi^\alpha_x \bdot \eta^{\ApEl{p}{\pi^\alpha_x}}_{1_{\alpha.x}}) \\
%&\equiv \eta^\chi_{\alpha.\TrCirc{\pi^\alpha_x}{1_{\alpha.x}}} ; ((\id_\alpha, E(x)) \bdot \ap{1_x}{(\id_\alpha, E(x))/x}) ; (\pi^\alpha_x \bdot \eta^{\ApEl{p}{\pi^\alpha_x}}_{1_{\alpha.x}}) \\
%&\equiv \eta^\chi_{\alpha.\TrCirc{\pi^\alpha_x}{1_{\alpha.x}}} ; ((\id_\alpha \bdot E(x));\pi^\alpha_x \bdot \ap{1_x}{(\id_\alpha, E(x))/x} ; \TrPlus{(\id_\alpha, E(x))}{\eta^{\ApEl{p}{\pi^\alpha_x}}_{1_{\alpha.x}}}) \\
%&\equiv \eta^\chi_{\alpha.\TrCirc{\pi^\alpha_x}{1_{\alpha.x}}} ; (\pi^\alpha_{\TrCirc{\pi^\alpha_x}{1_{\alpha.x}}} \bdot \ap{1_x}{(\id_\alpha, E(x))/x} ; \TrPlus{(\id_\alpha, E(x))}{\eta^{\ApEl{p}{\pi^\alpha_x}}_{1_{\alpha.x}}})
%\end{align*}
%This is the identity if we can show that
%\begin{align*}
%\ap{1_x}{(\id_\alpha, E(x))/x} ; \TrPlus{(\id_\alpha, E(x))}{\eta^{\ApEl{p}{\pi^\alpha_x}}_{1_{\alpha.x}}} \equiv \var{\TrCirc{\pi^\alpha_x}{1_{\alpha.x}}}
%\end{align*}
%
%So how about $E(x)$? The codomain is
%\begin{align*}
%?
%\end{align*}
%\end{proof}

\subsubsection{Yet-to-be checked}

\begin{definition}
A comprehension object is \emph{full} if $U(x)$ is fully faithful. \mvrnote{Is this enough? The usual definition is for commutative squares, not triangles.}
\end{definition}

\begin{lemma}
\mvrnote{Maybe?} $\mathtt{pair}$ is an isomorphism iff $H(s)$ is an isomorphism for $s$ a composite of $\pi$'s.
\end{lemma}

\begin{lemma}
\mvrnote{Maybe?} If $p$ supports $\Pi$-types and strong $\Sigma$-types then both $H$ and $E$ are isomorphisms.
\end{lemma}

\begin{lemma}
\mvrnote{Maybe?} One of the morphism of bifibrations conditions for each of $\Pi$'s and $\Sigma$'s is already true.
\end{lemma}

%\subsection{Morphism of Comprehension Objects}
%
%\mvrnote{This is out of date}
%
%Let $(p,\El{p}{-},\chi_p)$ and $(q,\El{q}{-},\chi_q)$ be two comprehension objects.
%
%\begin{definition}[Lifting to dependent types]
%  For a mode term ${\alpha : p \yields f_0(\alpha) : q}$,
%  its \emph{lifting to dependent types} is
%\begin{mathpar}
%  {\alpha : p, x : \El{p}{\alpha} \yields f_1(\alpha,x) : \El{p}{f_0(\alpha)}}
%  \and
%  f_1(\alpha,x) :\equiv \TrCirc{\ap{\El{p}{f_0(-)}}{\pi^\alpha_x}}{1_{f_0(\alpha.x)}}
%\end{mathpar}
%\end{definition}
%\noindent We use the convention that, for a mode term $f_0$, $f_1$ is
%its lifting to dependent types.
%
%The most basic form of modality is specified in the mode theory by a
%morphism of comprehension objects between $p$ and $q$.  
%\begin{definition}[\drlnote{Fiberwise?} morphism of comprehension objects]
%  A morphism of comprehension objects between $p$ and $q$ is specified by
%  a mode term
%  \begin{mathpar}
%    {\alpha : p \yields f_0(\alpha) : q}
%  \end{mathpar}
%  such that
%  \begin{align}
%  f_0(\emptyset_p) &\equiv \emptyset_q 
%  \end{align}
%\begin{center}
%  $f_1$ is a morphism of bifibrations from $\El{p}{-}$ to $\El{q}{f_0(-)}$ over $z : p$, so equations \eqref{mor-fib-subst}, \eqref{mor-fib-unit} and \eqref{mor-fib-counit} are satisfied.
%\end{center}
%\end{definition}
%
%Observe that equation \eqref{mor-opfib-subst} of being a morphism of
%bifibrations is always true for the lifting of an $f_0$:
%\begin{mathpar}
%  \TrCirc{\ap{\El{p}{f_0(-)}}{\pi^\alpha_{\TrCirc{\ApEl{p}{s}}{\nu}}}}{1_{f_0(\alpha.\TrCirc{\ApEl{p}{s}}{\nu})}}
%  \equiv
%  \TrCirc{\ap{\El{p}{f_0(-)}}{s}}{\TrCirc{\ap{\El{p}{f_0(-)}}{\pi^\beta_\nu}}{1_{f_0(\beta.\nu)}}}
%\end{mathpar}
%using equations \eqref{dot-circ} \eqref{pi-dot-circ} and fusion.
%
%We often treat $\alpha$ as an implicit argument to $f_1$.  \mvrnote{Out of date, need to re-check these work:} We can show
%that $f$ preserves the rest of the structure of a comprehension object:
%\begin{align}
%\label{mor-one}
%f_1(1_\alpha) &\equiv 1_{f_0(\alpha)} \\
%\label{mor-dot}
%f_0(\alpha.\mu) &\equiv f_0(\alpha).f_1(\mu) \\
%\label{mor-pi}
%\ap{f_0}{\pi^\alpha_\mu} &\equiv \pi^{f_0(\alpha)}_{f_1(\mu)} \\
%\label{mor-var}
%\ap{f_1(\alpha,-)}{\mathsf{var}_\mu} &\equiv \mathsf{var}_{f_1(\mu)}
%\end{align}
  
\subsection{MLTT via Explicit Substitutions}
\newcommand{\qyields}{\Vdash}
\newcommand{\varsof}[1]{{#1}^\dagger}
\newcommand{\upstairs}[1]{\overline{#1}}
\newcommand{\downstairs}[1]{\underline{#1}}
\newcommand{\asdep}[1]{{#1}_p}

In this section we interpret all the rules and equations of the presentation of type theory given in \cite{altenkirchkaposi16qit} via QITs. 

For consistency we switch from the Agda-style syntax used in the paper to ordinary inference rules. To distinguish judgements in this type theory from the ones in the framework I will use $\qyields$ as the turnstile. \mvrnote{Or some other symbol...} We have the following judgements:
\begin{mathpar}
\qyields \Gamma \CTX \and \Gamma \qyields A \TYPE \and \Gamma \qyields a : A \and \Gamma \qyields \Theta : \Delta 
\end{mathpar}
with the inference rules given in Figure~\ref{fig:qit-rules}. Note that some equations require earlier equations to hold in order to typecheck.

\begin{figure}
\begin{mathpar}
\inferrule*[left=ctx-empty]{~}{\cdot \CTX} \and
\inferrule*[left=ctx-ext]{\qyields \Gamma \CTX \and \Gamma \qyields A \TYPE}{\qyields \Gamma, A \CTX} \\
\inferrule*[left=type-sub]{\Delta \qyields A \TYPE \and \Gamma \qyields \Theta : \Delta}{\Gamma \qyields A[\Theta] \TYPE} \and
\inferrule*[left=term-sub]{\Delta \qyields a : A  \and \Gamma \qyields \Theta : \Delta}{\Gamma \qyields a[\Theta] : A[\Theta]} 
\\
\inferrule*[left=sub-empty]{~}{\Gamma \qyields \epsilon : \cdot} \and
\inferrule*[left=sub-ext]{\Gamma \qyields \Theta : \Delta \and \Gamma \qyields a : A[\Theta]}{\Gamma \qyields (\Theta, a) : \Delta, A} \\
\inferrule*[left=sub-id]{~}{\Gamma \qyields \id_\Gamma : \Gamma} \and
\inferrule*[left=sub-comp]{\Gamma \qyields \Theta : \Delta \and \Delta \qyields \kappa : \Lambda}{\Gamma \qyields \Theta ; \kappa : \Lambda} \\
\inferrule*[left=sub-proj]{~}{\Gamma, A \qyields \proj{\Gamma,A} : \Gamma} \and 
\inferrule*[left=sub-var]{~}{\Gamma, A \qyields \var{\Gamma,A} : A[\proj{\Gamma,A}]} 
\end{mathpar}

\begin{align}
A[\id] &\equiv A \\
A[\Theta ; \kappa] &\equiv A[\kappa][\Theta] \\
\nonumber\\
a[\id] &\equiv a \\
a[\Theta ; \kappa] &\equiv a[\kappa][\Theta] \\
\nonumber\\
\id ; \Theta &\equiv \Theta \\
\Theta ; \id &\equiv \Theta \\
(\Theta; \kappa) ; \rho &\equiv \Theta ; (\kappa ; \rho) \\
\nonumber\\
\Theta ; (\kappa , a) &\equiv (\Theta ; \kappa) , a[\Theta] \\ 
(\Theta, a);\proj{\Gamma,A} &\equiv \Theta \\
\var{\Delta,A}[\Theta, a] &\equiv a \\
(\proj{\Gamma,A}, \var{\Gamma,A}) &\equiv \id_{\Gamma, A} \\
\Theta &\equiv \epsilon && \text{for } \Gamma \qyields \Theta : \cdot
\end{align}
\caption{Rules of MLTT via Explicit Substitutions}\label{fig:qit-rules}
\end{figure}

We can derive some useful operations that we will use later when defining $\Pi$ and $\Sigma$ types.
\begin{mathpar}
\inferrule*[left=derivable]{\Gamma \qyields \Theta : \Delta \and \Delta \qyields A \TYPE}{\Gamma, A[\Theta] \qyields \Theta \uparrow A : \Delta, A} \and
\inferrule*[left=derivable]{\Gamma \qyields a : A}{\Gamma \qyields \hat{a} : \Gamma, A}
\end{mathpar}
defined by:
\begin{align*}
\Theta \uparrow A &:\equiv (\proj{\Gamma, A[\Theta]}; \Theta) , \var{\Gamma, A[\Theta]} \\
\hat{a} &:\equiv \id_{\Gamma} , a
\end{align*}

Our goal is to interpret these rules in the framework. The mode theory will contain a comprehension object $p$, and the basic idea for representing the judgements of MLTT is as follows:
\begin{itemize}
\item For each object-language context $\Gamma$, there is a corresponding upstairs framework context $\upstairs{\Gamma}$ living over the downstairs framework context $\downstairs{\Gamma}$. There is also an mode term $\downstairs{\Gamma} \yields \asdep{\Gamma} : p$, meant to represent a dependency descriptor for using every variable in $\Gamma$ exactly once.

\item A type $\Gamma \qyields A \TYPE$ is represented by $\upstairs{\Gamma} \yields_{\asdep{\Gamma}} \upstairs{A} \TYPE$.
  
\item A term $\Gamma \qyields a : A$ is represented by $\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \upstairs{a} : \upstairs{A}$.

\item A substitution $\Gamma \qyields \Theta : \Delta$ has a corresponding framework substitution $\upstairs{\Gamma} \yields \upstairs{\Theta} : \upstairs{\Delta}$ living over $\downstairs{\Gamma} \yields \downstairs{\Theta} : \downstairs{\Delta}$, together with a mode morphism $\downstairs{\Gamma} \yields s_\Theta : \asdep{\Gamma} \vDash_p \asdep{\Delta}[\downstairs{\Theta}]$ that we use to correct the mismatch between object-level and framework substitution.

Such pairs $\{ \Theta \mid s \}$ are considered up to the following relation:
\begin{align*}
\{ \rewrite{t}{\Theta} \mid s \} \sim \{ \Theta \mid s ; \ap{\asdep{\Delta}}{t} \}
\end{align*}
This is to account for the different possible placements of the structural rules. We will show that any two substitutions so related act the same on types and terms in the image of the translation.
\end{itemize}

These will be defined inductively, and the general idea is that for $\Gamma$ of the form $x_1 : A_1, \ldots , x_n : A_n$, the framework context $\upstairs{\Gamma}$ will live over the mode context $\downstairs{\Gamma}$ that looks like:
  \[x_1 : \El{p}{\emptyset}, x_2 : \El{p}{\emptyset.x_1}, \ldots, x_{i+1} : \El{p}{\emptyset.x_1.x_2.\ldots.x_i},\ldots
  \]
  The mode term $\asdep{\Gamma} : p$ will be $\emptyset.x_1.x_2.\ldots.x_n$ when $\Gamma$ is $x_1 : A_1, \ldots , x_n : A_n$.

\drlnote{Does $\sim$ make sense in the following generality?  (Doesn't
  mention the translation at all)}

  First, the pairs we consider are $\{ \Theta \mid s \}$ where (for fixed
  $\Gamma_\gamma$ and $\Delta_\delta$ and $\cdot \yields p \type$ and
  $\gamma \yields \mu : p$ and $\delta \yields \nu : p$), $\Gamma
  \yields_\theta \Theta : \Delta$ and
  $\TermTwoT{\gamma}{s}{\mu}{\nu[\theta]}{p}$.

  The quotient relation says that for any
  $\Gamma
  \yields_\theta \Theta : \Delta$ and
  $\TermTwoT{\gamma}{t}{\theta'}{\theta}{\delta}$
  and 
  $\TermTwoT{\gamma}{s}{\mu}{\nu[\theta']}{p}$, the pairs
  \[
  \{ \Gamma \yields_{\theta'} \rewrite{t}{\Theta} : \Delta \mid
  \TermTwoT{\gamma}{s}{\mu}{\nu[\theta']}{p}
  \}
  \]
  and
  \[
  \{ \Gamma \yields_{\theta} {\Theta} : \Delta \mid
  \TermTwoT{\gamma}{s;\ap{\nu}{t}}{\mu}{\nu[\theta]}{p}
  \}
  \]
  are equal.

  Generalize further to
    $\delta \yields p \type$ and
    $\gamma \yields \mu : p[\theta]$ and $\delta \yields \nu : p$, and
    $\TermTwoT{\gamma}{s}{\mu}{\nu[\theta]}{p[\theta]}$?
    Then $\mu$ needs to change between the two sides, something like
    $\{ \mu, \rewrite{t}{\Theta}, s \}$
    vs
    $\{ \TrCirc{\ap{p}{t}}{\mu}, \Theta,
    \ap{\TrCirc{\ap{p}{t}}{-}}{s};\ap{\nu}{t} \}$ ?
    
\subsubsection{Structural Rules}

\begin{theorem}
The judgements and structural rules of MLTT can be interpreted in any comprehension object (Definition \ref{def:comprehension-object})
\end{theorem}

\begin{enumerate}
\item[\textsc{ctx-empty}] The empty context $\cdot$ is interpreted of course as the empty context in the framework, and we define $\asdep{(\cdot)} :\equiv \emptyset : p$.

\item[\textsc{ctx-ext}] We are provided with an upstairs context $\upstairs{\Gamma}$ over $\downstairs{\Gamma}$, and a type $\upstairs{\Gamma} \yields_{\asdep{\Gamma}} \upstairs{A} \TYPE$.
We can then define
\begin{align*}
\upstairs{\Gamma, x : A} &:\equiv \upstairs{\Gamma}, x : \upstairs{A} \\
\downstairs{\Gamma, x : A} &:\equiv \downstairs{\Gamma}, x : \El{p}{\asdep{\Gamma}} \\
\asdep{(\Gamma, x : A)} &:\equiv (\asdep{\Gamma}).x
\end{align*}

\item[\textsc{type-sub}] Choose a representative of the translation of $\Theta$, say $\{ \Theta, s \}$ where:
\begin{align*}
\upstairs{\Delta} &\yields_{\asdep{\Delta}} \upstairs{A} \TYPE \\
\upstairs{\Gamma} &\yields_\theta \Theta : \upstairs{\Delta} \\
\downstairs{\Gamma} &\yields s : \asdep{\Gamma} \vDash \asdep{\Delta}[\theta]
\end{align*}
The translation of $A[\Theta]$ is then:
\begin{mathpar}
  \inferrule*[Left=s-form] {
\inferrule*[Left=Sub]{
  \upstairs{\Delta} \yields_{\asdep{\Delta}} \upstairs{A} \TYPE \and 
  \upstairs{\Gamma}\yields_\theta \Theta : \upstairs{\Delta}
  }{
  \upstairs{\Gamma} \yields_{\asdep{\Delta}[\theta]} \upstairs{A}[\Theta] \TYPE
  } \and   
  \downstairs{\Gamma} \yields s : \asdep{\Gamma} \vDash \asdep{\Delta}[\theta]
  }{
    \upstairs{\Gamma} \yields_{\asdep{\Gamma}} \St{s}{\upstairs{A}[\Theta]} \TYPE
  }
\end{mathpar}
We must show that this resulting type respects the relation on pairs $\{ \Theta, s \}$:
\begin{align*}
\St{s}{\upstairs{A}[\rewrite{t}{\Theta}]} 
&\equiv \St{s}{\St{\ap{\asdep{\Delta}}{t}}{\upstairs{A}[\Theta]}}  \\
&\equiv \St{(s;\ap{\asdep{\Delta}}{t})}{\upstairs{A}[\Theta]}
\end{align*}

\item[\textsc{term-sub}] Again choose a representative of the translation of the substitution, $\{ \Theta \mid s \}$. We have:
\begin{align*}
\upstairs{\Delta} &\yields_{1_{\asdep{\Delta}}} \upstairs{a} : \upstairs{A} \TYPE \\
\upstairs{\Gamma} &\yields_\theta \Theta : \upstairs{\Delta} \\
\downstairs{\Gamma} &\yields s : \asdep{\Gamma} \vDash \asdep{\Delta}[\theta]
\end{align*}
So use the derivation
\begin{mathpar}
  \inferrule*[Left=s-intro] {
\inferrule*[Left=Sub]{
 \upstairs{\Delta} \yields_{1_{\asdep{\Delta}}} \upstairs{a} : \upstairs{A} \and 
  \upstairs{\Gamma}\yields_\theta \Theta : \upstairs{\Delta}
  }{
  \upstairs{\Gamma} \yields_{1_{\asdep{\Delta}[\theta]}} \upstairs{a}[\Theta] : \upstairs{A}[\Theta] 
  } \and   
  \downstairs{\Gamma} \yields s : \asdep{\Gamma} \vDash \asdep{\Delta}[\Theta]
  }{
    \upstairs{\Gamma} \yields_{\TrPlus{s}{1_{\asdep{\Delta}[\theta]}}} \StI{s}{\upstairs{a}[\Theta]} : \St{s}{\upstairs{A}[\Theta]}
  }
\end{mathpar}
And by Equation~\eqref{s-plus-one-strict}, we know that $\TrPlus{s}{1_{\asdep{\Delta}[\theta]}} \equiv 1_{\asdep{\Gamma}}$.

This again respects the relation on pairs $\{ \Theta \mid s \}$:
\begin{align*}
\StI{s}{\upstairs{a}[\rewrite{t}{\Theta}]}
&\equiv \StI{s}{\rewrite{\ap{1_{\asdep{\Delta}}}{t}}{\StI{\ap{\asdep{\Delta}}{t}}{\upstairs{a}[\Theta]}} } \\
&\equiv \StI{s}{\StI{\ap{\asdep{\Delta}}{t}}{\upstairs{a}[\Theta]} } \\
&\equiv \StI{s;\ap{\asdep{\Delta}}{t}}{\upstairs{a}[\Theta]} \\
\end{align*}
Where $\ap{1_{\asdep{\Delta}}}{t} : 1_{\asdep{\Delta}[\theta]} \vDash \TrPlus{\ap{\asdep{\Delta}}{t}}{1_{\asdep{\Delta}[\theta']}}$ disappears as it must be the identity. \mvrnote{Does this still work if $s^+$ doesn't preserve the terminal object strictly?}

\item[\textsc{sub-empty}] This is interpreted as the empty framework substitution. We also define $\downstairs{\Gamma} \yields s_\epsilon : \asdep{\Gamma} \vDash \asdep{(\cdot)}[]$ to be the unique mode-morphism $! : \asdep{\Gamma} \vDash \emptyset$.

\item[\textsc{sub-ext}] We are given
\begin{align*}
\upstairs{\Gamma} &\yields_{\theta} \Theta : \upstairs{\Delta} \\
\downstairs{\Gamma} &\yields s : \asdep{\Gamma} \vDash \asdep{\Delta}[\theta] \\
\upstairs{\Gamma} &\yields_{1_{\asdep{\Gamma}}} \upstairs{a} : s^*(\upstairs{A}[\Theta])
\end{align*}
From the term, we get another term $\upstairs{\Gamma}\yields_{\TrCirc{s}{1_{\asdep{\Gamma}}}} \UnSt{s}{\upstairs{a}} : \upstairs{A}[\Theta]$, using \textsc{s-elim-2}. We can now pair this with $\Theta$ to get a framework substitution \[\upstairs{\Gamma} \yields_{\theta, \TrCirc{s}{1_{\asdep{\Gamma}}}} (\Theta, \UnSt{s}{\upstairs{a}}) : \upstairs{\Delta}, \upstairs{A}\]
so define
\begin{align*}
\upstairs{\Theta, a/x} &:\equiv \Theta, \UnSt{s}{\upstairs{a}}/x \\
\downstairs{\Theta, a/x} &:\equiv \theta, \TrCirc{s}{1_{\asdep{\Gamma}}}/x
\end{align*}
We still need to specify a 2-cell 
\[
\downstairs{\Gamma} \yields s_{\Theta, a/x} : \asdep{\Gamma} \vDash \asdep{(\Delta, x : A)}[\downstairs{\Theta, a/x}]
\]
The codomain here is
\begin{align*}
(\asdep{\Delta}.x)[\theta, \TrCirc{s_{\Theta}}{1_{\asdep{\Gamma}}}/x] 
&\equiv \asdep{\Delta}[\theta, \TrCirc{s}{1_{\asdep{\Gamma}}}/x].x[\theta, \TrCirc{s}{1_{\asdep{\Gamma}}}/x] \\
&\equiv \asdep{\Delta}[\theta].\TrCirc{s}{1_{\asdep{\Gamma}}}
\end{align*}
because $x$ does not occur in $\asdep{\Delta}$. Define:
\begin{align*}
s_{\Theta, a} &:\equiv \eta^\chi_{\asdep{\Gamma}}; (s \bdot \eta_{1_{\asdep{\Gamma}}}^{s})
\end{align*}
This is exactly the unit morphism $H(s)$ given earlier for the $p/\alpha \to \El{p}{\alpha}$ adjunction.

To show this is well defined, we have to verify that:
\begin{align*}
\left\{ (\rewrite{t}{\Theta}, \UnSt{s}{\upstairs{a}}/x) \mid H(s) \right\} \sim \left\{ (\Theta, \UnSt{s;\ap{\asdep{\Delta}}{t}}{\upstairs{a}}/x) \mid H(s;\ap{\asdep{\Delta}}{t}) \right\} 
\end{align*}
Trying this
\begin{align*}
\left\{ \Theta, \UnSt{s;\ap{\asdep{\Delta}}{t}}{\upstairs{a}}/x \mid H(s;\ap{\asdep{\Delta}}{t}) \right\} 
&\equiv \left\{ \Theta, \UnSt{\ap{\asdep{\Delta}}{t}}{\UnSt{s}{\upstairs{a}}}/x \mid H(s) ; (\ap{\asdep{\Delta}}{t} \bdot \eta^{\ApEl{p}{\ap{\asdep{\Delta}}{t}}}_{\TrCirc{\ApEl{p}{s}}{1_{\asdep{\Gamma}}}})\right\} \\
&\equiv \left\{ \Theta, \UnSt{\ap{\asdep{\Delta}}{t}}{\UnSt{s}{\upstairs{a}}}/x \mid H(s) ; \ap{(d.x)}{\ap{\asdep{\Delta}}{t}/d, \eta^{\ApEl{p}{\ap{\asdep{\Delta}}{t}}}_{\TrCirc{\ApEl{p}{s}}{1_{\asdep{\Gamma}}}}/x} \right\} \\
&\equiv \left\{ \Theta, \UnSt{\ap{\asdep{\Delta}}{t}}{\UnSt{s}{\upstairs{a}}}/x \mid H(s) ; \ap{\asdep{\Delta}.x}{t,\eta^{\ApEl{p}{\ap{\asdep{\Delta}}{t}}}_{\TrCirc{\ApEl{p}{s}}{1_{\asdep{\Gamma}}}}/x} \right\} \\
&\sim \left\{ \rewrite{(t,\eta^{\ApEl{p}{\ap{\asdep{\Delta}}{t}}}_{\TrCirc{\ApEl{p}{s}}{1_{\asdep{\Gamma}}}}/x)}{\Theta, \UnSt{\ap{\asdep{\Delta}}{t}}{\UnSt{s}{\upstairs{a}}}/x} \mid H(s) \right\} \\
&\equiv \left\{ \rewrite{t}{\Theta}, \rewrite{\eta^{\ApEl{p}{\ap{\asdep{\Delta}}{t}}}_{\TrCirc{\ApEl{p}{s}}{1_{\asdep{\Gamma}}}}}{\StI{\ap{\asdep{\Delta}}{t}}{\UnSt{\ap{\asdep{\Delta}}{t}}{\UnSt{s}{\upstairs{a}}}}}/x \mid H(s) \right\} \\
&\equiv \left\{ \rewrite{t}{\Theta}, \UnSt{s}{\upstairs{a}}/x \mid  H(s) \right\}
\end{align*}

\item[\textsc{sub-id}] This is translated to be the identity framework substitution on $\upstairs{\Gamma}$, with $s_{\id_\Gamma} :\equiv \id_{\asdep{\Gamma}}$.

\item[\textsc{sub-comp}] This is composition of framework substitutions, with $s_{(\Theta;\kappa)} :\equiv s_\Theta; (s_\kappa[\downstairs{\Theta}])$. 
First we show that this is well defined with respect to $\Theta$, i.e.:
\begin{align*}
\{ \rewrite{t}{\Theta};\kappa \mid s_\Theta; (s_\kappa[\theta]) \} \sim \{ \Theta;\kappa \mid (s_\Theta ; \ap{\asdep{\Delta}}{t} ; s_\kappa[\theta']) \}
\end{align*}
We have:
\begin{align*}
\{ \Theta;\kappa \mid (s_\Theta ; \ap{\asdep{\Delta}}{t} ; s_\kappa[\theta']) \}
&\equiv \{ \Theta;\kappa \mid (s_\Theta ; s_\kappa[\theta] ; \ap{\asdep{\Lambda}[\kappa]}{t}) \} \\
&\equiv \{ \Theta;\kappa \mid (s_\Theta ; s_\kappa[\theta] ; \ap{\asdep{\Lambda}}{\ap{\kappa}{t}}) \} \\
&\sim \{ \rewrite{\ap{\kappa}{t}}{\Theta;\kappa} \mid (s_\Theta ; s_\kappa[\theta]) \} \\
&\equiv \{ \rewrite{t}{\Theta};\kappa \mid (s_\Theta; s_\kappa[\theta]) \} \\
\end{align*}
as required. Second, we check it is well defined with respect to the choice of representative of $\kappa$, i.e.:
\begin{align*}
\{ \Theta;\rewrite{t}{\kappa} \mid s_\Theta; (s_\kappa[\theta]) \} \sim \{ \Theta;\kappa \mid s_\Theta ; (s_\kappa;\ap{\asdep{\Lambda}}{t})[\theta'] \}
\end{align*}
Checking this:
\begin{align*}
\{ \Theta;\kappa \mid (s_\Theta ; (s_\kappa;\ap{\asdep{\Lambda}}{t})[\theta]) \}
&\equiv \{ \Theta;\kappa \mid s_\Theta ; s_\kappa[\theta];\ap{\asdep{\Lambda}}{t}[\theta] \} \\
&\equiv \{ \Theta;\kappa \mid s_\Theta ; s_\kappa[\theta];\ap{\asdep{\Lambda}[\theta]}{t[\theta]} \} \\
&\sim \{ \rewrite{t[\theta]}{\Theta;\kappa} \mid s_\Theta ; s_\kappa[\theta] \} \\
&\equiv \{ \Theta;\rewrite{t}{\kappa} \mid s_\Theta ; s_\kappa[\theta] \}
\end{align*}

\item[\textsc{sub-proj}] This is translated to the framework substitution with the last term forgotten, i.e. $\mathsf{proj}$ in the framework. Define 
\begin{align*}
\downstairs{\Gamma, A} \yields s_{\proj{\Gamma, A}} : \asdep{(\Gamma, A)} \vDash_p \asdep{\Gamma}[\downstairs{\proj{\Gamma, A}}]
\end{align*}
to be $s_{\proj{\Gamma, A}} :\equiv \pi^{\asdep{\Gamma}}_x$.This makes sense, as substituting $\upstairs{\proj{\Gamma, A}}$ into a framework term or type corresponds to a framework weakening.

\item[\textsc{sub-var}] Our goal is to produce a framework term 
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A} \yields_{1_{\asdep{(\Gamma, A)}}} \var{\Gamma, A} : \St{s_{\proj{\Gamma, A}}}{\upstairs{A}[\upstairs{\proj{\Gamma, A}}]}
\end{align*}
For this use the derivation:
\begin{mathpar}
\inferrule*[Left=rewrite] {
\inferrule*[Left=s-intro] {
 \upstairs{\Gamma}, x : \upstairs{A} \yields_x x : \upstairs{A}[\upstairs{\proj{\Gamma, A}}]
 }{
 \upstairs{\Gamma}, x : \upstairs{A} \yields_{\TrPlus{\pi^{\asdep{\Gamma}}_x}{x}} \StI{\pi^{\asdep{\Gamma}}_x}{x} :\St{\pi^{\asdep{\Gamma}}_x}{\upstairs{A}}
}}{
 \upstairs{\Gamma}, x : \upstairs{A} \yields_{1_{\asdep{\Gamma}.x}} \rewrite{\var{x}}{\StI{\pi^{\asdep{\Gamma}}_x}{x}} :\St{\pi^{\asdep{\Gamma}}_x}{\upstairs{A}}
}
\end{mathpar}
Or equivalently:
\begin{mathpar}
\inferrule*[Left=s-intro-2] {
\inferrule*[Left=rewrite] {
 \upstairs{\Gamma}, x : \upstairs{A} \yields_x x : \upstairs{A}[\upstairs{\proj{\Gamma, A}}] \and E(x) : \TrCirc{\pi^{\asdep{\Gamma}}_x}{1_{\asdep{\Gamma}.x}} \vDash_{\El{p}{\asdep{\Gamma}}} x
 }{
 \upstairs{\Gamma}, x : \upstairs{A} \yields_{\TrCirc{\pi^{\asdep{\Gamma}}_x}{1_{\asdep{\Gamma}.x}}} \rewrite{E(x)}{x} : \upstairs{A}
}}{
\upstairs{\Gamma}, x : \upstairs{A} \yields_{1_{\asdep{\Gamma}.x}} \UStI{\pi^{\asdep{\Gamma}}_x}{\rewrite{E(x)}{x}} : \St{\pi^{\asdep{\Gamma}}_x}{\upstairs{A}}
}
\end{mathpar}
Where $E(x) :\equiv \ap{\ApEl{p}{\pi^\alpha_x}^\circ}{\var{x}} ; \varepsilon^{\ApEl{p}{\pi^\alpha_x}}_x$ is the counit of the $p/\alpha \to \El{p}{\alpha}$ adjunction.
\end{enumerate}

Now we check that these translations satisfy the required equations. The first three blocks of equations follow quickly from the analogous properties in the framework, together with the equations for surprisingly strict $s$-types. Here are the equations we might be worried about:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$A[\Theta ; \kappa] \equiv A[\kappa][\Theta]$}] 
\begin{align*}
\upstairs{A[\kappa][\Theta]}
&\equiv \St{s_{\Theta}}{\upstairs{A[\kappa]}[\upstairs{\Theta}]} \\
&\equiv \St{s_{\Theta}}{(\St{s_{\kappa}}{\upstairs{A}[\upstairs{\kappa}]})[\upstairs{\Theta}]} \\
&\equiv \St{s_\Theta}{\St{s_\kappa[\downstairs{\Theta}]}{\upstairs{A}[ \upstairs{\kappa}][\upstairs{\Theta}]}} \\
&\equiv \St{(s_\Theta; (s_\kappa[\downstairs{\Theta}]))}{\upstairs{A}[\upstairs{\Theta} ; \upstairs{\kappa}]} \\
&\equiv \St{s_{\Theta ; \kappa}}{\upstairs{A}[\upstairs{\Theta ; \kappa}]} \\
&\equiv \upstairs{A[\Theta ; \kappa]}
\end{align*}

\item[{$a[\Theta ; \kappa] \equiv a[\kappa][\Theta]$}] 
\begin{align*}
\upstairs{a[\kappa][\Theta]}
&\equiv \StI{s_\Theta}{\upstairs{a[\kappa]}[\upstairs{\Theta}]} \\
&\equiv \StI{s_\Theta}{\StI{s_\kappa}{\upstairs{a}[\upstairs{\kappa}]}[\upstairs{\Theta}]} \\
&\equiv \StI{s_\Theta}{\StI{s_\kappa[\upstairs{\Theta}]}{\upstairs{a}[\upstairs{\kappa}][\upstairs{\Theta}]}} \\
&\equiv \StI{s_{\Theta;\kappa}}{\upstairs{a}[\upstairs{\Theta};\upstairs{\kappa}]} \\
&\equiv \upstairs{a[\Theta ; \kappa]}
\end{align*}

\item[{$\Theta ; (\kappa , a) \equiv (\Theta ; \kappa) , a[\Theta]$}] These are only equal up to the relation: 
\begin{align*}
\{\upstairs{\Theta ; (\kappa , a) } \mid s_{\Theta ; (\kappa , a)}  \}
&\equiv \{\upstairs{\Theta} ; \upstairs{(\kappa , a)} \mid s_\Theta ; (s_{(\kappa , a)}[\downstairs{\Theta}])  \} \\
&\equiv \{ \upstairs{\Theta} ; (\upstairs{\kappa}, \UnSt{s_{\kappa}}{\upstairs{a}}) \mid s_\Theta ; (H(s_\kappa)[\downstairs{\Theta}])\} \\
&\equiv \{ (\upstairs{\Theta} ; \upstairs{\kappa}) , \UnSt{s_{\kappa}}{\upstairs{a}}[\upstairs{\Theta}] \mid s_\Theta ; (H(s_\kappa)[\downstairs{\Theta}]) \} \\
&\equiv \{ (\upstairs{\Theta} ; \upstairs{\kappa}) , \UnSt{s_{\kappa}[\downstairs{\Theta}]}{\upstairs{a}[\upstairs{\Theta}]} \mid s_\Theta ; (H(s_\kappa)[\downstairs{\Theta}]) \} \\
&\equiv \{ (\upstairs{\Theta} ; \upstairs{\kappa}) , \UnSt{s_{\kappa}[\downstairs{\Theta}]}{\upstairs{a}[\upstairs{\Theta}]} \mid H(s_\Theta ; (s_\kappa[\downstairs{\Theta}])) ; \ap{\asdep{(\Lambda.x)}}{\id, \ap{(s_\kappa[\downstairs{\Theta}])^\circ}{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\downstairs{\Theta}]}}}} \} \\
&\sim \{ (\upstairs{\Theta} ; \upstairs{\kappa}) , \rewrite{\ap{(s_\kappa[\downstairs{\Theta}])^\circ}{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\downstairs{\Theta}]}}}}{\UnSt{s_{\kappa}[\downstairs{\Theta}]}{\upstairs{a}[\upstairs{\Theta}]}}  \mid H(s_\Theta ; (s_\kappa[\downstairs{\Theta}])) \} \\
&\equiv \{ (\upstairs{\Theta} ; \upstairs{\kappa}) , \UnSt{s_{\kappa}[\downstairs{\Theta}]}{\rewrite{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\downstairs{\Theta}]}}}{\upstairs{a}[\upstairs{\Theta}]}}  \mid H(s_\Theta ; (s_\kappa[\downstairs{\Theta}])) \} \\
&\equiv \{ (\upstairs{\Theta} ; \upstairs{\kappa}) , \UnSt{s_{\kappa}[\downstairs{\Theta}]}{\UnSt{s_\Theta}{\StI{s_{\Theta}}{\upstairs{a}[\upstairs{\Theta}]}}}  \mid H(s_\Theta ; (s_\kappa[\downstairs{\Theta}])) \} \\
&\equiv \{(\upstairs{\Theta} ; \upstairs{\kappa}) , \UnSt{s_\Theta ; (s_{\kappa}[\downstairs{\Theta}])}{\StI{s_{\Theta}}{\upstairs{a}[\upstairs{\Theta}]}} \mid H(s_\Theta ; (s_\kappa[\downstairs{\Theta}])) \} \\
&\equiv \{ (\upstairs{\Theta} ; \upstairs{\kappa}) , \UnSt{s_{\Theta;\kappa}}{\StI{s_{\Theta}}{\upstairs{a}[\upstairs{\Theta}]}} \mid H(s_\Theta ; (s_\kappa[\downstairs{\Theta}]))\}\\
&\equiv \{ \upstairs{(\Theta ; \kappa)} , \UnSt{s_{\Theta;\kappa}}{\upstairs{a[\Theta]}} \mid H(s_{\Theta;\kappa})\} \\
&\equiv \{ \upstairs{(\Theta ; \kappa) , a[\Theta]} \mid s_{(\Theta ; \kappa) , a[\Theta]} \}
\end{align*}
What's left in the middle there is to check that
\begin{align*}
s_\Theta ; (H(s_\kappa)[\downstairs{\Theta}]) \equiv H(s_\Theta ; (s_\kappa[\downstairs{\Theta}])) ; \ap{\asdep{(\Lambda.x)}}{\id, \ap{(s_\kappa[\downstairs{\Theta}])^\circ}{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\downstairs{\Theta}]}}}}
\end{align*}
This is exactly the second equation of Lemma~\ref{lemma:h-on-composite}.

\item[{$(\Theta, a);\proj{\Gamma,A} \equiv \Theta$}] We calculate:
\begin{align*}
\{ \upstairs{(\Theta, a);\proj{\Gamma,A}} \mid s_{(\Theta, a);\proj{\Gamma,A}} \}
&\equiv \{ \upstairs{(\Theta, a)};\proj{\Gamma,A} \mid s_{(\Theta, a)};s_{\proj{\Gamma,A}}[\downstairs{\Theta, a}] \} \\
&\equiv \{ (\upstairs{\Theta}, \UnSt{s_\Theta}{\upstairs{a}});\proj{\Gamma,A} \mid H(s_\Theta);s_{\proj{\Gamma,A}}[\downstairs{\Theta}, \TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}] \} \\
&\equiv \{ \upstairs{\Theta} \mid H(s_\Theta); \pi^{\asdep{\Gamma}[\downstairs{\Theta}]}_{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}} \} \\
&\equiv \{ \upstairs{\Theta} \mid s_\Theta \}
\end{align*}

\item[{$\var{\Delta,A}[\Theta, a] \equiv a$}] Calculate:
\begin{align*}
\upstairs{\var{\Delta,A}[\Theta, a]}
&\equiv \StI{s_{\Theta, a}}{\upstairs{\var{\Delta, A}}[\upstairs{\Theta, a}]} \\
&\equiv \StI{H(s_\Theta)}{\rewrite{\var{x}}{\StI{\pi^{\asdep{\Gamma}}_x}{x}}[\upstairs{\Theta}, \UnSt{s_\Theta}{\upstairs{a}}]} \\
&\equiv \StI{H(s_\Theta)}{\rewrite{\var{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}{\StI{\pi^{\asdep{\Gamma}[\upstairs{\Theta}]}_{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}{\UnSt{s_\Theta}{\upstairs{a}}}}} \\
&\equiv \rewrite{\ApPlus{H(s_\Theta)}{\var{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}}{\StI{H(s_\Theta)}{\StI{\pi^{\asdep{\Gamma}[\upstairs{\Theta}]}_{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}{\UnSt{s_\Theta}{\upstairs{a}}}}} \\
&\equiv \rewrite{\ApPlus{H(s_\Theta)}{\var{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}}{\StI{H(s_\Theta);\pi^{\asdep{\Gamma}[\upstairs{\Theta}]}_{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}{\UnSt{s_\Theta}{\upstairs{a}}}} \\
&\equiv \rewrite{\ap{H(s_\Theta)^+}{\var{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}}{\StI{s_\Theta}{\UnSt{s_\Theta}{\upstairs{a}}}}
\end{align*}
Pause to calculate the rewrite:
\begin{align*}
\ap{H(s_\Theta)^+}{\var{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}
&\equiv \ap{(\eta^\chi_{\asdep{\Gamma}}; (s_\Theta \bdot \eta_{1_{\asdep{\Gamma}}}^{s_\Theta}))^+}{\var{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}} \\
&\equiv \ap{(\eta^\chi_{\asdep{\Gamma}})^+}{\ap{(s_\Theta \bdot \eta_{1_{\asdep{\Gamma}}}^{s_\Theta})^+}{\var{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}} \\
&\equiv \ap{(\eta^\chi_{\asdep{\Gamma}})^+}{\ap{(\pi^{\asdep{\Gamma}}_{1_{\asdep{\Gamma}}})^+}{\eta_{1_{\asdep{\Gamma}}}^{s_\Theta}}} \\
&\equiv \ap{(\eta^\chi_{\asdep{\Gamma}};\pi^{\asdep{\Gamma}}_{1_{\asdep{\Gamma}}})^+}{\eta_{1_{\asdep{\Gamma}}}^{s_\Theta}} \\
&\equiv \eta_{1_{\asdep{\Gamma}}}^{s_\Theta}
\end{align*}
Using beta-reduction for $\var{}$ and the triangle identity for $\chi$. So returning to the upstairs term:
\begin{align*}
\upstairs{\var{\Delta,A}[\Theta, a]}
&\equiv \rewrite{\ap{H(s_\Theta)^+}{\var{\TrCirc{s_\Theta}{1_{\asdep{\Gamma}}}}}}{\StI{s_\Theta}{\UnSt{s_\Theta}{\upstairs{a}}}} \\
&\equiv \rewrite{\eta_{1_{\asdep{\Gamma}}}^{s_\Theta}}{\StI{s_\Theta}{\UnSt{s_\Theta}{\upstairs{a}}}} \\
&\equiv \upstairs{a}
\end{align*}

\item[{$(\proj{\Gamma,A}, \var{\Gamma,A}) \equiv \id_{\Gamma, A}$}]  Again this is true only up to the relation:
\begin{align*}
\{ \upstairs{(\proj{\Gamma,A}, \var{\Gamma,A})} \mid s_{(\proj{\Gamma,A}, \var{\Gamma,A})} \}
&\equiv \{ \upstairs{\proj{\Gamma, A}} , \UnSt{s_{\proj{\Gamma, A}}}{\upstairs{\var{\Gamma, A}}} \mid H(s_{\proj{\Gamma,A}}) \} \\
&\equiv \{ \upstairs{\proj{\Gamma, A}} , \UnSt{s_{\proj{\Gamma, A}}}{\UStI{\pi^{\asdep{\Gamma}}_x}{\rewrite{E(x)}{x}}} \mid H(s_{\proj{\Gamma,A}}) \} \\
&\equiv \{ \upstairs{\proj{\Gamma, A}} , \rewrite{E(x)}{x} / x \mid H(\pi^{\asdep{\Gamma}}_x) \} \\
&\sim \{ \upstairs{\proj{\Gamma, A}} , x / x \mid H(\pi^{\asdep{\Gamma}}_x) ; \ap{\asdep{(\Gamma, A)}}{\id_{\downstairs{\proj{\Gamma, A}} }, E(x)} \} \\
&\equiv \{ \upstairs{\proj{\Gamma, A}} , x / x \mid H(\pi^{\asdep{\Gamma}}_x) ; \ap{\asdep{\Gamma}.x}{E(x)/x} \} \\
&\equiv \{ \upstairs{\proj{\Gamma, A}} , x / x \mid \id_{\asdep{\Gamma}.x} \} \\
&\equiv \upstairs{\id_{\Gamma, A}}
\end{align*}
Using the triangle identity for the slice/comprehension adjunction.
\end{enumerate}

Some observations:
\begin{lemma}\label{lemma:uparrow-translation}
The derived substitution $\Theta \uparrow A$ is translated to (nearly) its framework equivalent: \[\upstairs{\Gamma, x : A[\Theta]} \yields (\upstairs{\Theta}, \UnSt{ s_{\Theta}}{x}/x) : \upstairs{\Delta, x : A},\]
with associated 2-cell \[s_{\Theta \uparrow A} \equiv (s_\Theta \bdot \eta^{s_\Theta}_x)\]
\end{lemma}
\begin{proof}
\begin{align*}
\{ \upstairs{\Theta \uparrow A} \mid s_{\Theta \uparrow A} \}
&\equiv \{\upstairs{(\proj{\Gamma, A[\Theta]}; \Theta) , \var{\Gamma, A[\Theta]}} \mid s_{(\proj{\Gamma, A[\Theta]}; \Theta) , \var{\Gamma, A[\Theta]}} \}\\
&\equiv \{ \upstairs{(\proj{\Gamma, A[\Theta]}; \Theta)} , \UnSt{s_{\proj{\Gamma, A[\Theta]}; \Theta}}{\upstairs{\var{\Gamma, A[\Theta]}}} \mid H(s_{\proj{\Gamma, A[\Theta]}; \Theta}) \} \\
&\equiv \{ (\proj{\Gamma, A[\Theta]};  \upstairs{\Theta}) , \UnSt{s_{\proj{\Gamma, A[\Theta]}} ; s_{\Theta}[\downstairs{\mathsf{proj}}]}{\UStI{\pi^{\asdep{\Gamma}}_x}{\rewrite{E(x)}{x}}} \mid H(s_{\proj{\Gamma, A[\Theta]}};s_\Theta[\downstairs{\mathsf{proj}}]) \}\\
&\equiv \{ (\proj{\Gamma, A[\Theta]};  \upstairs{\Theta}) , \UnSt{ s_{\Theta}[\downstairs{\mathsf{proj}}]}{\rewrite{E(x)}{x}} \mid H(s_{\proj{\Gamma, A[\Theta]}};s_\Theta[\downstairs{\mathsf{proj}}]) \}\\
&\equiv \{ (\proj{\Gamma, A[\Theta]};  \upstairs{\Theta}) , \rewrite{\TrCirc{s_\Theta}{E(x)}}{\UnSt{ s_{\Theta}[\downstairs{\mathsf{proj}}]}{x}} \mid H(s_{\proj{\Gamma, A[\Theta]}};s_\Theta[\downstairs{\mathsf{proj}}]) \}\\
&\sim \{ (\proj{\Gamma, A[\Theta]};  \upstairs{\Theta}) , \UnSt{ s_{\Theta}[\downstairs{\mathsf{proj}}]}{x} \mid H(s_{\proj{\Gamma, A[\Theta]}};s_\Theta[\downstairs{\mathsf{proj}}]) ; \ap{\asdep{\Delta}.x}{\TrCirc{s_\Theta}{E(x)}/x} \}
\end{align*}
This last 2-cell is:
\begin{align*}
H(s_{\proj{\Gamma, A[\Theta]}};s_\Theta[\downstairs{\mathsf{proj}}]) ; \ap{\asdep{\Delta}.x}{\TrCirc{s_\Theta}{E(x)}/x} 
&\equiv \eta^\chi_{\asdep{\Gamma}.x} ; ((\pi^{\asdep{\Gamma}}_x;s_\Theta) \bdot \eta^{\pi^{\asdep{\Gamma}}_x;s_\Theta}_{1_{\asdep{\Gamma}.x}}) ; (\id \bdot \TrCirc{s_\Theta}{\ap{{\pi^{\asdep{\Gamma}}_x}^\circ}{\var{x}}}) ; (\id \bdot \ap{s_\Theta^\circ}{\varepsilon^{\pi^{\asdep{\Gamma}}_x}_x}) \\
&\equiv \eta^\chi_{\asdep{\Gamma}.x} ; ((\pi^{\asdep{\Gamma}}_x;s_\Theta) \bdot \eta^{\pi^{\asdep{\Gamma}}_x;s_\Theta}_{1_{\asdep{\Gamma}.x}}) ; (\id \bdot \ap{{(\pi^{\asdep{\Gamma}}_x;s_\Theta)}^\circ}{\var{x}}) ; (\id \bdot \ap{s_\Theta^\circ}{\varepsilon^{\pi^{\asdep{\Gamma}}_x}_x}) \\
&\equiv \eta^\chi_{\asdep{\Gamma}.x} ; ((\pi^{\asdep{\Gamma}}_x;s_\Theta) \bdot \eta^{\pi^{\asdep{\Gamma}}_x;s_\Theta}_{1_{\asdep{\Gamma}.x}} ; \ap{{(\pi^{\asdep{\Gamma}}_x;s_\Theta)}^+}{\ap{{(\pi^{\asdep{\Gamma}}_x;s_\Theta)}^\circ}{\var{x}}})  ; (\id \bdot \ap{s_\Theta^\circ}{\varepsilon^{\pi^{\asdep{\Gamma}}_x}_x}) \\
&\equiv \eta^\chi_{\asdep{\Gamma}.x} ; ((\pi^{\asdep{\Gamma}}_x;s_\Theta) \bdot \var{x};\eta^{\pi^{\asdep{\Gamma}}_x;s_\Theta}_{\TrPlus{\pi}{1_{\asdep{\Gamma}}}})  ; (\id \bdot \ap{s_\Theta^\circ}{\varepsilon^{\pi^{\asdep{\Gamma}}_x}_x}) \\
&\equiv \eta^\chi_{\asdep{\Gamma}.x} ; ((\pi^{\asdep{\Gamma}}_x;s_\Theta) \bdot \var{x};\eta^{\pi^{\asdep{\Gamma}}_x;s_\Theta}_{\TrPlus{\pi}{1_{\asdep{\Gamma}}}};\ap{(\pi^{\asdep{\Gamma}}_x;s_\Theta)^+}{\ap{s_\Theta^\circ}{\varepsilon^{\pi^{\asdep{\Gamma}}_x}_x}}) \\
&\equiv \eta^\chi_{\asdep{\Gamma}.x} ; ((\pi^{\asdep{\Gamma}}_x;s_\Theta) \bdot \var{x};\ap{{\pi^{\asdep{\Gamma}}_x}^+}{\eta^{s_\Theta}_x}) \\
&\equiv \eta^\chi_{\asdep{\Gamma}.x} ; (\pi^{\asdep{\Gamma}}_x \bdot \var{x}) ; (s_\Theta \bdot \eta^{s_\Theta}_x) \\
&\equiv (s_\Theta \bdot \eta^{s_\Theta}_x)
\end{align*}
\mvrnote{This is very similar to the triangle equation for $H/E$, does it follow neatly from naturality/functoriality or something?}
\end{proof}

This can be iterated:
\begin{align*}
& \{ \upstairs{\Theta \uparrow A \uparrow B} \mid s_{\Theta \uparrow A \uparrow B} \} \\
&\sim \{ \upstairs{\Theta \uparrow A}, \UnSt{s_{\Theta \uparrow A}}{y}/y \mid (s_{\Theta \uparrow A} \bdot \eta^{s_{\Theta \uparrow A}}_y) \} \\
&\sim \{ \upstairs{\Theta}, \UnSt{s_{\Theta}}{x}/x, \UnSt{s_{\Theta \uparrow A}}{y}/y \mid ((s_{\Theta} \bdot \eta^{s_{\Theta}}_x) \bdot \eta^{s_{\Theta \uparrow A}}_y) \}
\end{align*}

%\begin{lemma}
%Applying this substitution to $\var{}$ gives $\var{}$:
%\begin{align*}
%\end{align*}
%\end{lemma}
%\begin{proof}
%\begin{align*}
%&\TrPlus{s_{\Theta \uparrow A}}{\var{\TrCirc{s_\Theta}{x}}} \\
%&\equiv \TrPlus{(s_{\Theta} \bdot \eta^{s_{\Theta}}_x)}{\var{\TrCirc{s_\Theta}{x}}} \\
%&\equiv \var{x};\TrPlus{\pi^{\asdep{\Gamma}}_{x}}{\eta^{s_{\Theta}}_x}
%\end{align*}
%\end{proof}

\begin{lemma}
The derived substitution $\hat{a}$ is also translated to its framework equivalent: \[\upstairs{\Gamma} \yields (\upstairs{\Gamma}/\upstairs{\Gamma}, \upstairs{a}/x) : \upstairs{\Gamma, A} \]
with associated 2-cell \[s_{\hat{a}} \equiv \eta^\chi_{\asdep{\Gamma}} \]
\end{lemma}
\begin{proof}
\begin{align*}
\{ \hat{a} \mid s_{\hat{a}} \}
&\equiv \{ \upstairs{\id_\Gamma, a} \mid s_{\upstairs{\id_\Gamma, a}} \} \\
&\equiv \{ \upstairs{\id_\Gamma}, \UnSt{s_{\id_\Gamma}}{\upstairs{a}} \mid H(s_{\id_\Gamma})\} \\
&\equiv \{ \upstairs{\id_\Gamma}, \UnSt{\id_{\asdep\Gamma}}{\upstairs{a}} \mid H(\id_{\asdep\Gamma}) \} \\
&\equiv \{ \upstairs{\Gamma}/\upstairs{\Gamma}, \upstairs{a}/x \mid \eta^\chi_{\asdep{\Gamma}}; (\id_{\asdep\Gamma} \bdot \eta_{1_{\asdep{\Gamma}}}^{\id_{\asdep\Gamma}}) \} \\
&\equiv \{ \upstairs{\Gamma}/\upstairs{\Gamma}, \upstairs{a}/x \mid \eta^\chi_{\asdep{\Gamma}} \}
\end{align*}
\end{proof}

\subsubsection{Rules for $\Pi$-types}


The rules for $\Pi$ types are given in Figure~\ref{fig:qit-pi-rules}. Note that substitution into $\mathsf{app}$ is derivable:
\begin{align*}
\mathsf{app}(f[\Theta])
&\equiv \mathsf{app}(\mathsf{lam}(\mathsf{app}(f))[\Theta]) \\
&\equiv \mathsf{app}(\mathsf{lam}(\mathsf{app}(f)[\Theta \uparrow A])) \\
&\equiv \mathsf{app}(f)[\Theta \uparrow A]
\end{align*}

\begin{figure}
\begin{mathpar}
\inferrule*[left=$\Pi$-form]{\Gamma \qyields A \TYPE \and \Gamma, A \qyields B \TYPE}{\Gamma \qyields \Pi_A B \TYPE} \\
\inferrule*[left=$\Pi$-app]{\Gamma \qyields f : \Pi_A B}{\Gamma, A \qyields \mathsf{app}(f) : B} \and 
\inferrule*[left=$\Pi$-lam]{\Gamma, A \qyields b : B}{\Gamma \qyields \mathsf{lam}(b) : \Pi_A B}
\end{mathpar}
\begin{align}
(\Pi_A B)[\Theta] &\equiv \Pi_{A[\Theta]} B[\Theta \uparrow A] \\
\nonumber\\
\mathsf{app}(\mathsf{lam}(b)) &\equiv b \\
\mathsf{lam}(\mathsf{app}(f)) &\equiv f \\
\mathsf{lam}(b)[\Theta] &\equiv \mathsf{lam}(b[\Theta \uparrow A])
\end{align}
\mvrnote{TODO: replace $\mathsf{app}$ with the rule:}
\begin{mathpar}
\inferrule*[left=$\Pi$-app]{~}{\Gamma, A, (\Pi_A B)[\proj{}] \qyields \mathsf{app}_{A, B} : B[\proj{}]} \and 
\end{mathpar}
\caption{Rules for $\Pi$-types in  MLTT via Explicit Substitutions}\label{fig:qit-pi-rules}
\end{figure}

\begin{theorem}
The rules for $\Pi$-types can be interpreted in any comprehension object that supports $\Pi$-types (Definition \ref{def:supports-pis}).
\end{theorem}

In the framework, $\Pi$-types are the $\mathsf{U}$-types for the mode term
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, c : \El{p}{\alpha} \yields \Pi_1(\alpha,x,c) :\equiv \TrPlus{\ApEl{p}{\pi^\alpha_x}}{c} : \El{p}{\alpha.x}
\end{align*}

\begin{enumerate}
%\item[\textsc{a}]
\item[\textsc{$\Pi$-form}] We have two types
\begin{align*}
\upstairs{\Gamma} &\yields_{\asdep{\Gamma}} \upstairs{A} \TYPE \\
\upstairs{\Gamma}, x : \El{p}{\asdep{\Gamma}} &\yields_{\asdep{\Gamma}.x} \upstairs{B} \TYPE
\end{align*}
These are exactly of the right shape to apply \textsc{U-form}.
\begin{mathpar}
\inferrule{
  \upstairs{\Gamma} \yields_{\asdep{\Gamma}} \upstairs{A} \TYPE \and
  \upstairs{\Gamma}, x : \El{p}{\asdep{\Gamma}} \yields_{\asdep{\Gamma}.x} \upstairs{B} \TYPE \\\\
  \downstairs{\Gamma}, x : \El{p}{\asdep{\Gamma}}, c : \El{p}{\asdep{\Gamma}} \yields \Pi_1(\asdep{\Gamma},x,c) : \El{p}{\asdep{\Gamma}.x}
}
            { \overline{\Gamma} \yields_{\El{p}{\asdep{\Gamma}}} \upstairs{\Pi_A B} :\equiv \U{c.\Pi_1(\asdep{\Gamma},x,c)}{x : \upstairs{A}}{\upstairs{B}} \TYPE }
\end{mathpar}

\item[\textsc{$\Pi$-app}] We are given 
\begin{align*}
\upstairs{\Gamma} &\yields_{1_{\asdep{\Gamma}}} \upstairs{f} : \U{c.\Pi_1(\asdep{\Gamma},x,c)}{x : \upstairs{A}}{\upstairs{B}}
\intertext{and we want} 
\upstairs{\Gamma}, x : \upstairs{A} &\yields_{1_{\asdep{\Gamma}.x}} \upstairs{\mathsf{app}(f)} : \upstairs{B}
\end{align*}
This is an application of \textsc{U-elim}.
\begin{mathpar}
\inferrule*[Left=U-elim]{
\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \upstairs{f} : \U{c.\Pi_1(\asdep{\Gamma},x,c)}{x : \upstairs{A}}{\upstairs{B}} \and
\upstairs{\Gamma}, x : \upstairs{A} \yields_x x : \upstairs{A}
}{
\upstairs{\Gamma}, x : \upstairs{A} \yields_{\Pi_1(\asdep{\Gamma},x,1_{\asdep{\Gamma}})} \upstairs{f}(x) : \upstairs{B}
}
\end{mathpar}
and
\begin{align*}
\Pi_1(\asdep{\Gamma},x,1_{\asdep{\Gamma}})
&\equiv \TrPlus{\ApEl{p}{\pi^{\asdep{\Gamma}}_x}}{1_{\asdep{\Gamma}}} \\
&\equiv 1_{\asdep{\Gamma}.x}
\end{align*}
again by Equation~\eqref{s-plus-one-strict}.

\item[\textsc{$\Pi$-lam}] The inverse of the above, we are given:
\begin{align*}
\upstairs{\Gamma}, x : \upstairs{A} &\yields_{1_{\asdep{\Gamma}.x}} \upstairs{b} : \upstairs{B}
\intertext{and we want} 
\upstairs{\Gamma} &\yields_{1_{\asdep{\Gamma}}} \upstairs{\mathsf{lam}(b)} : \U{c.\Pi_1(\asdep{\Gamma},x,c)}{x : \upstairs{A}}{\upstairs{B}}
\end{align*}
Rewrite $1_{\asdep{\Gamma}.x} \equiv \Pi_1(\asdep{\Gamma},x,1_{\asdep{\Gamma}}) \equiv \Pi_1(\asdep{\Gamma},x,c)[1_{\asdep{\Gamma}}/c]$ then apply \textsc{U-intro}:
\begin{mathpar}
  \inferrule*[Left = U-intro]{
    \upstairs{\Gamma}, x : \upstairs{A} \yields_{\Pi_1(\asdep{\Gamma},x,c)[1_{\asdep{\Gamma}}/c]} \upstairs{b} : \upstairs{B}
  }
  {\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \lambda x.\upstairs{b} : \U{c.\Pi_1(\asdep{\Gamma},x,c)}{x : \upstairs{A}}{\upstairs{B}}
  }
\end{mathpar}
\end{enumerate}
So far we have not used that $p$ satisfies the Beck-Chevalley conditions for $\Pi$s. This ought to come up in the equations now:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$(\Pi_A B)[\Theta] \equiv \Pi_{A[\Theta]} B[\Theta \uparrow A] $}:] We calculate:
\begin{align*}
\upstairs{(\Pi_A B)[\Theta]} 
&\equiv \St{s_{\Theta}}{\upstairs{\Pi_A B}[\upstairs{\Theta}]} \\
&\equiv \St{s_{\Theta}}{\U{c.\Pi_1(\asdep{\Delta},x,c)}{x : \upstairs{A}}{\upstairs{B}}[\upstairs{\Theta}]} \\
&\equiv \St{s_{\Theta}}{\U{c.\Pi_1(\asdep{\Delta},x,c)[\downstairs{\Theta}]}{x : \upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x/x]}} \\
&\equiv \U{c.\Pi_1(\asdep{\Delta}[\downstairs{\Theta}],x,\TrCirc{s_{\Theta}}{c})}{x : \upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta},x/x]} \\
&\equiv \U{c.\TrCirc{(s_{\Theta} . \id_{\TrPlus{s_\Theta}{x}})}{\Pi_1(\asdep{\Gamma},\TrPlus{s_\Theta}{x},c)}}{x : \upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x/x]} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},\TrPlus{s_\Theta}{x},c)}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta} . \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, x/x]}} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},\TrPlus{s_\Theta}{x},c)}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta} . \eta^{s_\Theta}_{\TrPlus{s_\Theta}{x}})}{\St{(\id \bdot \varepsilon^{s_\Theta}_x)}{\upstairs{B}[\upstairs{\Theta}, x/x]}}} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},\TrPlus{s_\Theta}{x},c)}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta} . \eta^{s_\Theta}_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, \rewrite{\varepsilon^{s_\Theta}_x}{x}/x]}} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},\TrPlus{s_\Theta}{x},c)}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{((s_{\Theta} . \eta^{s_\Theta}_x)[\TrPlus{s_\Theta}{x}/x])}{\upstairs{B}[\upstairs{\Theta}, \UnSt{s_\Theta}{x}/x][\StI{s_\Theta}{x}/x]}} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},\TrPlus{s_\Theta}{x},c)}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta \uparrow A}[\TrPlus{s_\Theta}{x}/x])}{\upstairs{B}[\upstairs{\Theta \uparrow A}][\StI{s_\Theta}{x}/x]}} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},\TrPlus{s_\Theta}{x},c)}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{s_{\Theta \uparrow A}}{\upstairs{B}[\upstairs{\Theta \uparrow A}]}[\StI{s_\Theta}{x}/x]} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},x,c)}{x : \St{s_\Theta}{\upstairs{A}[\upstairs{\Theta}]}}{\St{s_{\Theta \uparrow A}}{\upstairs{B}[\upstairs{\Theta \uparrow A}]}} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},x,c)}{x : \St{s_\Theta}{\upstairs{A}[\upstairs{\Theta}]}}{\St{s_{\Theta \uparrow A}}{\upstairs{B}[\upstairs{\Theta \uparrow A}]}} \\
&\equiv \U{c.\Pi_1(\asdep{\Gamma},x,c)}{x : \upstairs{A[\Theta]}}{\upstairs{B[\Theta \uparrow A]}} \\
&\equiv \upstairs{\Pi_{A[\Theta]} B[\Theta \uparrow A]}
\end{align*}
where in the middle we verify, using Beck-Chevalley, 
\begin{align*}
\Pi_1(\asdep{\Delta}[\downstairs{\Theta}],x,\TrCirc{s_{\Theta}}{c})
&:\equiv \TrPlus{\pi^{\asdep{\Delta}[\downstairs{\Theta}]}_x}{\TrCirc{s_{\Theta}}{c}} \\
&\equiv \TrCirc{(s_{\Theta} . \id_{\TrPlus{s_\Theta}{x}})}{\TrPlus{\pi^{\asdep{\Gamma}}_{\TrPlus{s_\Theta}{x}}}{c}} \\
&\equiv \TrCirc{(s_{\Theta} . \id_{\TrPlus{s_\Theta}{x}})}{\Pi_1(\asdep{\Gamma},\TrPlus{s_\Theta}{x},c}
\end{align*}

\item[{$\mathsf{app}(\mathsf{lam}(b)) \equiv b$}:] Follows immediately from beta-reduction for $\mathsf{U}$-types.
%\begin{align*}
%\upstairs{\mathsf{app}(\mathsf{lam}(b))}
%&\equiv \UE{\upstairs{\mathsf{lam}(b)}}{x} \\
%&\equiv \UE{(\UI{x}{\upstairs{b}})}{x} \\
%&\equiv \upstairs{b}
%\end{align*}
\item[{$\mathsf{lam}(\mathsf{app}(f)) \equiv f$}:] Follows immediately from eta-expansion for $\mathsf{U}$-types.

\item[{$\mathsf{lam}(b)[\Theta] \equiv \mathsf{lam}(b[\Theta \uparrow A])$}:] This equation holds over the one for $\Pi$-types above. It is a little difficult to follow, so we simultaneously show how the type is being transformed.

\begin{align*}
&\upstairs{\mathsf{lam}(b)[\Theta]} && : \upstairs{(\Pi_A B)[\Theta]} \\
&\equiv \StI{s_\Theta}{\upstairs{\mathsf{lam}(b)}[\upstairs{\Theta}]} && : \St{s_{\Theta}}{\upstairs{\Pi_A B}[\upstairs{\Theta}]} \\
&\equiv \StI{s_\Theta}{(\UI{x}{\upstairs{b}})[\upstairs{\Theta}]} && :  \St{s_{\Theta}}{\U{-}{x : \upstairs{A}}{\upstairs{B}}[\upstairs{\Theta}]} \\
&\equiv \StI{s_\Theta}{\UI{x}{\upstairs{b}[\upstairs{\Theta}, x / x]}} && :  \St{s_{\Theta}}{\U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x / x]}} \\
&\equiv \UStI{s_\Theta}{\rewrite{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\Theta]}}}{\UI{x}{\upstairs{b}[\upstairs{\Theta}, x/x]}}} && : \St{s_{\Theta}}{\U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x / x]}} \\
&\equiv \UStI{s_\Theta}{\UI{x}{\rewrite{\ap{\Pi_1(\asdep{\Delta}[\Theta],x,c)}{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\Theta]}}/c}}{\upstairs{b}[\upstairs{\Theta}, x/x]}}} && : \St{s_{\Theta}}{\U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x / x]}} \\
&\equiv \UStI{s_\Theta}{\UI{x}{\rewrite{\varepsilon^{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}_{1_{\asdep{\Delta}[\Theta].x}}}{\upstairs{b}[\upstairs{\Theta}, x/x]}}} && :   \St{s_{\Theta}}{\U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x / x]}} \\
&\equiv \UI{x}{\rewrite{\varepsilon^{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}_{1_{\asdep{\Delta}[\Theta].x}}}{\upstairs{b}[\upstairs{\Theta}, x/x]}} && :  \U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x / x]} \\
&\equiv \UI{x}{\UStI{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}{\rewrite{\varepsilon^{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}_{1_{\asdep{\Delta}[\Theta].x}}}{\upstairs{b}[\upstairs{\Theta}, x/x]}}} && : \U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, x/x]}} \\
&\equiv \UI{x}{\StI{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{b}[\upstairs{\Theta}, x/x]}} && : \U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, x/x]}} \\
&\equiv \UI{x}{\StI{(s_{\Theta} \bdot \eta^{s_\Theta}_{\TrPlus{s_\Theta}{x}})}{\StI{(\id \bdot \varepsilon^{s_\Theta}_x)}{\upstairs{b}[\upstairs{\Theta}, x/x]}}} && : \U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta} \bdot \eta^{s_\Theta}_{\TrPlus{s_\Theta}{x}})}{\St{(\id \bdot \varepsilon^{s_\Theta}_x)}{\upstairs{B}[\upstairs{\Theta}, x/x]}}} \\
&\equiv \UI{x}{\StI{(s_{\Theta} \bdot \eta^{s_\Theta}_{\TrPlus{s_\Theta}{x}})}{\upstairs{b}[\upstairs{\Theta}, \rewrite{\varepsilon^{s_\Theta}_x}{x}/x]}} && : \U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta} \bdot \eta^{s_\Theta}_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, \rewrite{\varepsilon^{s_\Theta}_x}{x}/x]}} \\
&\equiv \UI{x}{\StI{s_{\Theta \uparrow A}[\TrPlus{s_\Theta}{x}/x]}{\upstairs{b}[\upstairs{\Theta}, \rewrite{\varepsilon^{s_\Theta}_x}{x}/x]}} && : \U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta \uparrow A}[\TrPlus{s_\Theta}{x}/x])}{\upstairs{B}[\upstairs{\Theta}, \rewrite{\varepsilon^{s_\Theta}_x}{x}/x]}} \\
&\equiv \UI{x}{\StI{s_{\Theta \uparrow A}[\TrPlus{s_\Theta}{x}/x]}{\upstairs{b}[\upstairs{\Theta \uparrow A}][\StI{s_\Theta}{x}/x]}} && : \U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{(s_{\Theta \uparrow A}[\TrPlus{s_\Theta}{x}/x])}{\upstairs{B}[\upstairs{\Theta \uparrow A}][\StI{s_\Theta}{x}/x]}} \\
&\equiv \UI{x}{\StI{s_{\Theta \uparrow A}}{\upstairs{b}[\upstairs{\Theta \uparrow A}]}[\StI{s_\Theta}{x}/x]} && : \U{-}{x : \upstairs{A}[\upstairs{\Theta}]}{\St{s_{\Theta \uparrow A}}{\upstairs{B}[\upstairs{\Theta \uparrow A}]}[\StI{s_\Theta}{x}/x]} \\
&\equiv \UI{x}{\StI{s_{\Theta \uparrow A}}{\upstairs{b}[\upstairs{\Theta \uparrow A}]}} && : \U{-}{x : \St{s_\Theta}{\upstairs{A}[\upstairs{\Theta}]}}{\St{s_{\Theta \uparrow A}}{\upstairs{B}[\upstairs{\Theta \uparrow A}]}} \\
&\equiv \UI{x}{\upstairs{b[\Theta \uparrow A]}} && : \U{-}{x : \upstairs{A[\Theta]}}{\upstairs{B[\Theta \uparrow A]}} \\
&\equiv \upstairs{\mathsf{lam}(b[\Theta \uparrow A])} && : \upstairs{\Pi_{A[\Theta]} B[\Theta \uparrow A]}
\end{align*}

In the middle we use the identity
\begin{align*}
\ap{\Pi_1(\asdep{\Delta}[\Theta],x,c)}{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\Theta]}}/c} \equiv \varepsilon^{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}_{1_{\asdep{\Delta}[\Theta].x}} && (\equiv \varepsilon^{(s_{\Theta} \bdot \id_{\TrPlus{s_\Theta}{x}})}_{\Pi_1(\asdep{\Delta}[\Theta],x,1_{\asdep{\Delta}[\Theta]})})
\end{align*}
which is a special case of the Beck condition.
\end{enumerate}

\subsubsection{Rules for $\Sigma$-types}

The rules for $\Sigma$-types are given in Figure~\ref{fig:qit-sigma-rules}. There are two versions of the eliminator; a weak and strong version. The choice of one or the other yields \emph{weak} $\Sigma$-types or \emph{strong} $\Sigma$-types.

\begin{figure}
\begin{mathpar}
\inferrule*[left=$\Sigma$-form]{\Gamma \qyields A \TYPE \and \Gamma, A \qyields B \TYPE}{\Gamma \qyields \Sigma_A B \TYPE} \\
\inferrule*[left=$\Sigma$-pair]{~}{\Gamma, A, B \qyields \mathsf{pair}_{A, B} : (\Sigma_A B)[\proj{\Gamma, A, B};\proj{\Gamma, A}]} \and
\inferrule*[left=$\Sigma$-split-strong]{\Gamma, A, B \qyields c : C[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}]}{\Gamma, \Sigma_A B \qyields \mathsf{split}_{A, B}(c) : C}
%\inferrule*[left=$\Sigma$-pair]{\Gamma \qyields a : A \and \Gamma \qyields b : B[\hat{a}]}{\Gamma \qyields (a, b) : \Sigma_A B} \and
%\inferrule*[left=$\Sigma$-$\pi_1$]{\Gamma \qyields p : \Sigma_A B}{\Gamma \qyields \pi_1(p) : A} \and
%\inferrule*[left=$\Sigma$-$\pi_2$]{\Gamma \qyields p : \Sigma_A B}{\Gamma \qyields \pi_2(p) : B[\widehat{\pi_1(p)}]} \and
\end{mathpar}
\begin{align}
(\Sigma_A B)[\Theta] &\equiv \Sigma_{A[\Theta]} B[\Theta \uparrow A] \\
\mathsf{pair}_{A, B}[\Theta \uparrow A \uparrow B] &\equiv \mathsf{pair}_{A[\Theta], B[\Theta \uparrow A]} \\
\mathsf{split}_{A,B}(c)[\Theta \uparrow \Sigma_A B] &\equiv \mathsf{split}_{A[\Theta],B[\Theta \uparrow A]}(c[\Theta \uparrow A \uparrow B])  \\
\nonumber \\
\mathsf{split}_{A,B}(c)[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}] &\equiv c
\intertext{(If framework $\mathsf{F}$-types have eta:)}
\mathsf{split}_{A,B}(\mathsf{pair}_{A,B}) &\equiv \var{\Gamma, \Sigma_A B}
\end{align}
\mvrnote{that eta is not general enough}
\vspace{1cm}
\begin{mathpar}
\inferrule*[left=$\Sigma$-split-weak]{\Gamma, A, B \qyields c : C[\proj{\Gamma, A, B};\proj{\Gamma, A}]}{\Gamma, \Sigma_A B \qyields \mathsf{wsplit}_{A, B}(c) : C[\proj{\Gamma, \Sigma_A B}]}
\end{mathpar}
\begin{align}
\mathsf{wsplit}_{A,B}(\mathsf{pair}_{A,B}) &\equiv \var{\Gamma, \Sigma_A B} \\
\mathsf{wsplit}_{A,B}(c)[\Theta \uparrow \Sigma_A B] &\equiv \mathsf{wsplit}_{A[\Theta],B[\Theta \uparrow A]}(c[\Theta \uparrow A \uparrow B]) \\
\end{align}
%\begin{align}
%%\pi_1(a, b) &\equiv a \\
%%\pi_2(a, b) &\equiv b \\
%%(\pi_1(p), \pi_2(p)) &\equiv p \\
%%(a, b)[\Theta] &\equiv (a[\Theta], b[\Theta])
%\end{align}
\caption{Rules for $\Sigma$-types in MLTT via Explicit Substitutions}\label{fig:qit-sigma-rules}
\end{figure}

\begin{theorem}
The rules for strong $\Sigma$-types can be interpreted in any comprehension object that supports strong $\Sigma$-types (Definition \ref{def:supports-strong-sigmas}).
\end{theorem}

In the framework, $\Sigma$-types are the $\mathsf{F}$-types for the mode term
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, y : \El{p}{\alpha.x} \yields \Sigma_1(\alpha,x,y) :\equiv \TrCirc{\ApEl{p}{\pi^\alpha_x}}{y} : \El{p}{\alpha}
\end{align*}

Let 
\begin{align*}
\mathtt{split}(\alpha,x,y) : \alpha.\Sigma_1(\alpha,x,y) \vDash\alpha.x.y
\end{align*}
be the inverse of 
\begin{align*}
\mathtt{pair}(\alpha,x,y) :\equiv (\pi^{\asdep{\Gamma}}_x \bdot \eta^{\pi^{\asdep{\Gamma}}_x}_y) : \alpha.x.y \vDash \alpha.\Sigma_1(\alpha,x,y)
\end{align*}

\begin{lemma}
The $\mathtt{pair}$ 2-cell is natural at the mode-theory level:
\begin{align*}
s_{\Theta \uparrow A \uparrow B};\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y}) &\equiv \mathtt{pair}(\asdep{\Gamma},x,y);s_{\Theta \uparrow \Sigma_A B} \\
((s_\Theta \bdot \id) \bdot \id);\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}], x, y) &\equiv \mathtt{pair}(\asdep{\Gamma},\TrPlus{s_\Theta}{x},\TrPlus{(s_\Theta, \id)}{y});(s_\Theta \bdot \id)
\end{align*}
\mvrnote{todo: put in missing subscripts in the second one}
\end{lemma}
\begin{proof}
\begin{align*}
&s_{\Theta \uparrow A \uparrow B};\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y}) \\
&\equiv (s_{\Theta \uparrow A} \bdot \eta^{s_{\Theta \uparrow A}}_y);(\pi^{\asdep{\Delta}[\downstairs{\Theta}]}_{\TrCirc{s_\Theta}{x}} \bdot \eta^{\pi^{\asdep{\Delta}[\downstairs{\Theta}]}_{\TrCirc{s_\Theta}{x}}}_{\TrCirc{s_{\Theta \uparrow A}}{y}}) \\
&\equiv ((s_{\Theta \uparrow A} ; \pi^{\asdep{\Delta}[\downstairs{\Theta}]}_{\TrCirc{s_\Theta}{x}}) \bdot (\eta^{s_{\Theta \uparrow A}}_y ; \ApPlus{s_{\Theta \uparrow A}}{\eta^{\pi^{\asdep{\Delta}[\downstairs{\Theta}]}_{\TrCirc{s_\Theta}{x}}}_{\TrCirc{s_{\Theta \uparrow A}}{y}}})) \\
&\equiv ((\pi^{\asdep{\Gamma}}_x ; s_\Theta) \bdot (\eta^{s_{\Theta \uparrow A};\pi^{\asdep{\Delta}[\downstairs{\Theta}]}_{\TrCirc{s_\Theta}{x}}}_y)) \\
&\equiv ((\pi^{\asdep{\Gamma}}_x ; s_\Theta) \bdot (\eta^{\pi^{\asdep{\Gamma}}_x;s_{\Theta}}_y)) \\
&\equiv ((\pi^{\asdep{\Gamma}}_x ; s_\Theta) \bdot (\eta^{\pi^{\asdep{\Gamma}}_x}_y ; \ApPlus{\pi^{\asdep{\Gamma}}_x}{\eta^{s_\Theta}_{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}}})) \\
&\equiv (\pi^{\asdep{\Gamma}}_x \bdot \eta^{\pi^{\asdep{\Gamma}}_x}_y);(s_\Theta \bdot \eta^{s_\Theta}_{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}}) \\
&\equiv \mathtt{pair}(\asdep{\Gamma},x,y);s_{\Theta \uparrow \Sigma_A B}
\end{align*}
The other is similar.
\end{proof}

\begin{lemma}
The following special cases of the Beck-Chevalley equation on terms are true:
\begin{align*}
\eta^{s_{\Theta}}_{\Sigma_1(\asdep{\Gamma},x,y)} &\equiv \ap{\Sigma_1(\asdep{\Gamma},\fst z, \snd z)}{(\eta^{s_\Theta}_x, \eta^{s_{\Theta \uparrow A}}_y)/z} \\
\varepsilon^{s_{\Theta}}_{\Sigma_1(\asdep{\Delta}[\Theta],x,y)} &\equiv \ap{\Sigma_1(\asdep{\Delta}[\Theta], \fst z, \snd z)}{(\varepsilon^{s_\Theta}_{x}, \varepsilon^{s_{\Theta \uparrow A}}_{\TrPlus{\ap{\asdep{\Delta}[\Theta].x}{\varepsilon^{s_\Theta}_{x}/x}}{y}})/z}
\end{align*}
\end{lemma}
\begin{proof}
\mvrnote{Todo}
\end{proof}

We now translate all the rules:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[\textsc{$\Sigma$-form}] Because framework $\mathsf{F}$-types are unary, we first use a framework $\Sigma$-type to pair the provided types together.

\begin{mathpar}
\inferrule*[Left=F-form]{
\inferrule*[Left={$(,)$-form}]
{\upstairs{\Gamma} \yields_{\asdep{\Gamma}} \upstairs{A} \TYPE \and \upstairs{\Gamma}, x : \upstairs{A} \yields_{\asdep{\Gamma}.x} \upstairs{B} \TYPE}
{\upstairs{\Gamma} \yields_{\sigmacl{x}{\asdep{\Gamma}}{\asdep{\Gamma}.x}} \telety{x}{\upstairs{A}}{\upstairs{B}} \TYPE}
}
{\upstairs{\Gamma} \yields_{\asdep{\Gamma}} \upstairs{\Sigma_A B} :\equiv \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}} \TYPE}
\end{mathpar}

\item[\textsc{$\Sigma$-pair}] We are constructing a term of type:
\begin{align*}
\upstairs{(\Sigma_A B)[\proj{\Gamma, A, B};\proj{\Gamma, A}]}
&\equiv \St{s_{\proj{\Gamma, A, B};\proj{\Gamma, A}}}{\upstairs{\Sigma_A B}[\upstairs{\proj{\Gamma, A, B};\proj{\Gamma, A}}]} \\
&\equiv \St{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\upstairs{\Sigma_A B}} \\
&\equiv \St{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{ \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}}
\end{align*}
And for this use:
\begin{mathpar}
\inferrule*[Left=rewrite]{
\inferrule*[Left=s-intro]{
\inferrule*[Left={F-intro}]{
\inferrule*[Left={$(,)$-intro}]{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_x x : \upstairs{A} \and \upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_y y : \upstairs{B}}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{(x, y)} (x, y) : \telety{x}{\upstairs{A}}{\upstairs{B}}}}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\Sigma_1(\asdep{\Gamma}, x, y)} \FI{(x, y)} : \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}}}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{\TrPlus{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\Sigma_1(\asdep{\Gamma}, x, y)}} \StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(x, y)}} : \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}}}
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{1_{\asdep{\Gamma}.x.y}} \rewrite{\ApPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(x, y)}}} : \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}}
\end{mathpar}

\item[\textsc{$\Sigma$-split-strong}] We will save ourselves some trouble if we first simplify the translation of the substitution $(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}$:
\begin{align*}
&\{ \upstairs{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}} \mid s_{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}} \} \\
&\equiv \{ \UnSt{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\upstairs{\mathsf{pair}_{A,B}}}/z \mid H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) \}  \\
&\equiv \{ \UnSt{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\rewrite{\var{y};\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(x, y)}}}}/z \mid H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) \}  \\
&\equiv \{ \rewrite{\ApCirc{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\var{y};\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}}}{\UnSt{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(x, y)}}}}/z \mid H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) \}  \\
&\equiv \{ \rewrite{\ApCirc{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\var{y};\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}}}{\rewrite{\varepsilon^{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}}}{\FI{(x, y)}}}/z \mid H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) \}  \\
&\equiv \{ \rewrite{\ApCirc{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\var{y};\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}};\varepsilon^{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}}}{\FI{(x, y)}}/z \mid H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) \} 
\end{align*}
Now let's simplify the 2-cell in that rewrite.
\begin{align*}
&\ApCirc{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\var{y};\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}};\varepsilon^{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}} \\
&\equiv \ApCirc{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\var{y};\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}};\ApCirc{\pi^{\asdep{\Gamma}}_x}{\varepsilon^{\pi^{\asdep{\Gamma}.x}_y}_{\TrPlus{\pi^{\asdep{\Gamma}}_x}{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}}}};\varepsilon^{\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\ApEl{p}{\pi^\alpha_x}}{y}} \\
&\equiv \ApCirc{\pi^{\asdep{\Gamma}}_x}{\ApCirc{\pi^{\asdep{\Gamma}.x}_y}{\var{y};\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}}};\ApCirc{\pi^{\asdep{\Gamma}}_x}{\varepsilon^{\pi^{\asdep{\Gamma}.x}_y}_{\TrPlus{\pi^{\asdep{\Gamma}}_x}{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}}}};\varepsilon^{\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\ApEl{p}{\pi^\alpha_x}}{y}} \\
&\equiv \ApCirc{\pi^{\asdep{\Gamma}}_x}{\ApCirc{\pi^{\asdep{\Gamma}.x}_y}{\var{y}};\ApCirc{\pi^{\asdep{\Gamma}.x}_y}{\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}};\varepsilon^{\pi^{\asdep{\Gamma}.x}_y}_{\TrPlus{\pi^{\asdep{\Gamma}}_x}{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}}}};\varepsilon^{\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\ApEl{p}{\pi^\alpha_x}}{y}} \\
&\equiv \ApCirc{\pi^{\asdep{\Gamma}}_x}{\ApCirc{\pi^{\asdep{\Gamma}.x}_y}{\var{y}};\varepsilon^{\pi^{\asdep{\Gamma}.x}_y}_y;\eta^{\pi^{\asdep{\Gamma}}_x}_y};\varepsilon^{\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\ApEl{p}{\pi^\alpha_x}}{y}} \\
&\equiv \ApCirc{\pi^{\asdep{\Gamma}}_x}{\ApCirc{\pi^{\asdep{\Gamma}.x}_y}{\var{y}};\varepsilon^{\pi^{\asdep{\Gamma}.x}_y}_y}; \ApCirc{\pi^{\asdep{\Gamma}}_x}{\eta^{\pi^{\asdep{\Gamma}}_x}_y};\varepsilon^{\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\ApEl{p}{\pi^\alpha_x}}{y}} \\
&\equiv \ApCirc{\pi^{\asdep{\Gamma}}_x}{\ApCirc{\pi^{\asdep{\Gamma}.x}_y}{\var{y}};\varepsilon^{\pi^{\asdep{\Gamma}.x}_y}_y} \\
&\equiv \ApCirc{\pi^{\asdep{\Gamma}}_x}{E(y)}
\end{align*}
\mvrnote{There may have been an easier path through all this...}
So the substitution is equivalent to:
\begin{align*}
&\{ \upstairs{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}} \mid s_{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}} \} \\
&\equiv \{ \rewrite{\ApCirc{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\var{y};\ApPlus{\pi^{\asdep{\Gamma}.x}_y}{\eta^{\pi^{\asdep{\Gamma}}_x}_y}};\varepsilon^{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}_{\TrCirc{\pi^{\asdep{\Gamma}}_x}{y}}}{\FI{(x, y)}}/z \mid H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) \} \\
&\equiv \{ \rewrite{\ApCirc{\pi^{\asdep{\Gamma}}_x}{E(y)}}{\FI{(x, y)}}/z \mid H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) \} \\
&\equiv \{ \FI{(x, y)}/z \mid H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) ; (\id_{\asdep{\Gamma}} \bdot \ApCirc{\pi^{\asdep{\Gamma}}_x}{E(y)}) \} \\
&\equiv \{ \FI{(x, y)}/z \mid (\pi^{\asdep{\Gamma}}_x \bdot \eta^{\pi^{\asdep{\Gamma}}_x}_y) \} \\
&\equiv \{ \FI{(x, y)}/z \mid \mathtt{pair}(\asdep{\Gamma},x,y) \}
\end{align*}
where $H(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x) ; (\id_{\asdep{\Gamma}} \bdot \ApCirc{\pi^{\asdep{\Gamma}}_x}{E(y)}) = (\pi^{\asdep{\Gamma}}_x \bdot \eta^{\pi^{\asdep{\Gamma}}_x}_y)$ by exactly the same reasoning as used in Lemma~\ref{lemma:uparrow-translation}.

So we are handed an element $\upstairs{c}$ of $\upstairs{C[\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}]}$, i.e. of:
\begin{align*}
\St{s_{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}}}{\upstairs{C}[\upstairs{(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}}]}
&\equiv \St{\mathtt{pair}(\asdep{\Gamma},x,y)}{\upstairs{C}[\FI{(x, y)}/z]}
\end{align*}
and we want an element of $\upstairs{C}$. So use:
\begin{align*}
\inferrule*[Left=F-elim]{
\inferrule*[left=cut]{
\inferrule*[Left=s-elim]{
\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{1_{\asdep{\Gamma}.x.y}} \upstairs{c} : \St{\mathtt{pair}(\asdep{\Gamma},x,y)}{\upstairs{C}[\FI{(x, y)}/z]}} 
{\upstairs{\Gamma}, x : \upstairs{A}, y : \upstairs{B} \yields_{1_{\asdep{\Gamma}.\Sigma_1(x,y)}} \StI{\mathtt{split}(\asdep{\Gamma},x,y)}{\upstairs{c}} : \upstairs{C}[\FI{(x, y)}/z]}}
{\upstairs{\Gamma}, w : \telety{x}{\upstairs{A}}{\upstairs{B}} \yields_{1_{\asdep{\Gamma}.\Sigma_1(\fst w,\snd w)}} \StI{\mathtt{split}(\asdep{\Gamma},\fst w,\snd w)}{\upstairs{c}[\fst w / x, \snd w / y]} : \upstairs{C}[\FI{w}/z]}
}
{\upstairs{\Gamma}, z : \upstairs{\Sigma_A B} \yields_{1_{\asdep{\Gamma}.z}} \FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\fst w,\snd w)}{\upstairs{c}[\fst w / x, \snd w / y]}} : \upstairs{C}} 
\end{align*}
\end{enumerate}

%The following computation will show up a few times:
%\begin{align*}
%&\StI{s}{\FI{(x, y)}} &&: \St{s}{\F{z.\Sigma_1(\alpha, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}} \\
%&\equiv \FI{(x, y)} &&: \F{z.\TrPlus{s}{\Sigma_1(\alpha, \fst z, \snd z)}}{\telety{x}{\upstairs{A}}{\upstairs{B}}} \\
%&\equiv \FI{(x, y)} &&: \F{z.\Sigma_1(\beta, \TrPlus{s}{\fst z}, \TrPlus{(s \bdot \id_{\TrPlus{s}{\fst z}})}{\snd z})}{\telety{x}{\upstairs{A}}{\upstairs{B}}} \\
%&\equiv \FI{(x, y)} &&: \F{z.\Sigma_1(\beta, \fst z, \snd z)[\TrPlus{(s, (s \bdot \id_{\TrPlus{s}{x}}))}{z}/z]}{\telety{x}{\upstairs{A}}{\upstairs{B}}} \\
%&\equiv \FI{\StI{(s, (s \bdot \id_{\TrPlus{s}{x}}))}{(x, y)}} &&: \F{z.\Sigma_1(\beta, \fst z, \snd z)}{\St{(s, (s \bdot \id_{\TrPlus{s}{x}}))}{\telety{x}{\upstairs{A}}{\upstairs{B}}}} \\
%&\equiv \FI{(\StI{s}{x}, \StI{(s \bdot \id_{\TrPlus{s}{\TrCirc{s}{x}}})}{y})} &&: \F{z.\Sigma_1(\beta,\fst z,\snd z)}{\telety{x'}{\St{s}{\upstairs{A}}}{\StE{s}{x'}{x}{\St{(s \bdot \id_{\TrPlus{s}{x}})}{\upstairs{B}}}}} \\
%&\equiv \FI{(\StI{s}{x}, \StI{(s \bdot \id_{\TrPlus{s}{\TrCirc{s}{x}}})}{y})} &&: \F{z.\Sigma_1(\beta,\fst z,\snd z)}{\telety{x'}{\St{s}{\upstairs{A}}}{\StE{s}{\rewrite{\eta^{s}_{x'}}{\StI{s}{\UnSt{s}{x'}}}}{x}{\St{(s \bdot \id_{\TrPlus{s}{x}})}{\upstairs{B}}}}} \\
%&\equiv \dots \\
%&\equiv \FI{(\StI{s}{x}, \StI{(s \bdot \id_{\TrPlus{s}{\TrCirc{s}{x}}})}{y})} &&: \F{z.\Sigma_1(\beta,\fst z,\snd z)}{\telety{x'}{\St{s}{\upstairs{A}}}{\St{(s \bdot \eta^s_{x'})}{\upstairs{B}[\UnSt{s}{x'}/x]}}} \\
%\end{align*}

Now the equations:
\begin{enumerate}[style = multiline, labelwidth = 80pt]
\item[{$(\Sigma_A B)[\Theta] \equiv \Sigma_{A[\Theta]} B[\Theta \uparrow A]$}:] Calculate:
\begin{align*}
\upstairs{(\Sigma_A B)[\Theta]}
&\equiv \St{s_\Theta}{\upstairs{\Sigma_A B}[\upstairs{\Theta}]} \\
&\equiv \St{s_\Theta}{\F{z.\Sigma_1(\asdep{\Delta}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}[\upstairs{\Theta}]} \\
&\equiv \St{s_\Theta}{\F{z.\Sigma_1(\asdep{\Delta}, \fst z, \snd z)[\downstairs{\Theta}]}{\telety{x}{\upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x/x]}}} \\
&\equiv \F{z.\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\downstairs{\Theta}], \fst z, \snd z)}}{\telety{x}{\upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x/x]}} \\
&\equiv \F{z.\Sigma_1(\asdep{\Gamma},\fst z,\snd z)[\TrPlus{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{z}/z]}{\telety{x}{\upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x/x]}} \\
&\equiv \F{z.\Sigma_1(\asdep{\Gamma},\fst z,\snd z)}{\St{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{\telety{x}{\upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x/x]}}} \\
&\equiv \F{z.\Sigma_1(\asdep{\Gamma},\fst z,\snd z)}{\telety{x'}{\St{s_\Theta}{\upstairs{A}[\upstairs{\Theta}]}}{\StE{s_\Theta}{x'}{x}{\St{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, x/x]}}}}
\end{align*}
Where by Beck-Chevalley, we know
\begin{align*}
\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\downstairs{\Theta}], \fst z, \snd z)}
&:\equiv \TrPlus{s_\Theta}{\TrCirc{\pi^{\asdep{\Delta}[\downstairs{\Theta}]}_{\fst z}}{\snd z}} \\
&\equiv \TrCirc{\pi^{\asdep{\Gamma}}_{\TrPlus{s_\Theta}{\fst z}}}{\TrPlus{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\fst z}})}{\snd z}} \\
&\equiv \Sigma_1(\asdep{\Gamma},\TrPlus{s_\Theta}{\fst z},\TrPlus{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\fst z}})}{\snd z}) \\
&\equiv \Sigma_1(\asdep{\Gamma},\fst z,\snd z)[\TrPlus{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{z}/z]
\end{align*}
So it's just left to show
\begin{align*}
&\StE{s_\Theta}{x'}{x}{\St{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, x/x]}} \\
&\equiv \StE{s_\Theta}{\rewrite{\eta^{s_\Theta}_{x'}}{\StI{s_\Theta}{\UnSt{s_\Theta}{x'}}}}{x}{\St{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, x/x]}} \\
&\equiv \StE{s_\Theta}{\StI{s_\Theta}{\UnSt{s_\Theta}{x'}}}{x}{\St{\ap{\asdep{\Gamma}.y}{\eta^{s_\Theta}_{x'}/y}}{\St{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, x/x]}}} \\
&\equiv \St{\ap{\asdep{\Gamma}.y}{\eta^{s_\Theta}_{x'}/y}}{\St{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}})}{\upstairs{B}[\upstairs{\Theta}, x/x]}}[\UnSt{s_\Theta}{x'}/x] \\
&\equiv \St{\ap{\asdep{\Gamma}.y}{\eta^{s_\Theta}_{x'}/y}}{\St{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\TrCirc{s_\Theta}{x'}}})}{\upstairs{B}[\upstairs{\Theta}, \UnSt{s_\Theta}{x'}/x]}} \\
&\equiv \St{(\ap{\asdep{\Gamma}.y}{\eta^{s_\Theta}_{x'}/y};(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\TrCirc{s_\Theta}{x'}}}))}{\upstairs{B}[\upstairs{\Theta}, \UnSt{s_\Theta}{x'}/x]} \\
&\equiv \St{(s_\Theta \bdot \eta^{s_\Theta}_{x'})}{\upstairs{B}[\upstairs{\Theta}, \UnSt{s_\Theta}{x'}/x]} \\
&\equiv \upstairs{B[\Theta \uparrow A]}
\end{align*}
And this finishes the proof that $(\Sigma_A B)[\Theta] \equiv \Sigma_{A[\Theta]} B[\Theta \uparrow A]$.

\item[{$\mathsf{split}_{A,B}(c)\allowbreak[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \allowbreak\mathsf{pair}_{A,B}] \equiv c$}:] Happily, we already simplified the translation of the substitution $(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}$ when we defined the translation of $\mathsf{split}$.
\begin{align*}
&\upstairs{\mathsf{split}_{A,B}(c)[(\proj{\Gamma, A, B};\proj{\Gamma, A}), \mathsf{pair}_{A,B}]} \\
&\equiv \StI{\mathtt{pair}(\asdep{\Gamma},x,y)}{\upstairs{\mathsf{split}_{A,B}(c)}[\FI{(x, y)}/z]} \\
&\equiv \StI{\mathtt{pair}(\asdep{\Gamma},x,y)}{\FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\fst w,\snd w)}{\upstairs{c}[\fst w / x, \snd w / y]}}[\FI{(x, y)}/z]} \\
&\equiv \StI{\mathtt{pair}(\asdep{\Gamma},x,y)}{\FE{\FI{(x, y)}}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\fst w,\snd w)}{\upstairs{c}[\fst w / x, \snd w / y]}}} \\
&\equiv \StI{\mathtt{pair}(\asdep{\Gamma},x,y)}{\StI{\mathtt{split}(\asdep{\Gamma},\fst w,\snd w)}{\upstairs{c}[\fst w / x, \snd w / y]}[(x,y)/w]} \\
&\equiv \StI{\mathtt{pair}(\asdep{\Gamma},x,y)}{\StI{\mathtt{split}(\asdep{\Gamma},x,y)}{\upstairs{c}}} \\
&\equiv \upstairs{c} \\
\end{align*}

\item[{$\mathsf{pair}_{A, B}[\Theta \uparrow A \uparrow B] \equiv \mathsf{pair}_{A[\Theta], B[\Theta \uparrow A]}$}:]

\begin{align*}
&\upstairs{\mathsf{pair}_{A, B}[\Theta \uparrow A \uparrow B]} \\
&\equiv \StI{s_{\Theta \uparrow A \uparrow B}}{\upstairs{\mathsf{pair}_{A, B}}[\upstairs{\Theta \uparrow A \uparrow B}]} \\
&\equiv \StI{s_{\Theta \uparrow A \uparrow B}}{\rewrite{\mathtt{pair}(\asdep{\Delta},x,y)}{\StI{\pi^{\asdep{\Delta}.x}_y;\pi^{\asdep{\Delta}}_x}{\FI{(x, y)}}}[\upstairs{\Theta}, \UnSt{s_{\Theta}}{x}/x, \UnSt{s_{\Theta \uparrow A}}{y}/y]} \\ 
&\equiv \StI{s_{\Theta \uparrow A \uparrow B}}{\rewrite{\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}{\StI{\pi^{\asdep{\Delta}[\Theta].\TrCirc{s_\Theta}{x}}_{\TrCirc{s_{\Theta \uparrow A}}{y}};\pi^{\asdep{\Delta}[\Theta]}_{\TrCirc{s_\Theta}{x}}}{\FI{(\UnSt{s_{\Theta}}{x}, \UnSt{s_{\Theta \uparrow A}}{y})}}}} \\
&\equiv \rewrite{\ApPlus{s_{\Theta \uparrow A \uparrow B}}{\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}}{\StI{s_{\Theta \uparrow A \uparrow B}}{\StI{\pi^{\asdep{\Delta}[\Theta].\TrCirc{s_\Theta}{x}}_{\TrCirc{s_{\Theta \uparrow A}}{y}};\pi^{\asdep{\Delta}[\Theta]}_{\TrCirc{s_\Theta}{x}}}{\FI{(\UnSt{s_{\Theta}}{x}, \UnSt{s_{\Theta \uparrow A}}{y})}}}} \\
&\equiv \rewrite{\ApPlus{s_{\Theta \uparrow A \uparrow B}}{\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}}{\StI{s_{\Theta \uparrow A \uparrow B} ; \pi^{\asdep{\Delta}[\Theta].\TrCirc{s_\Theta}{x}}_{\TrCirc{s_{\Theta \uparrow A}}{y}};\pi^{\asdep{\Delta}[\Theta]}_{\TrCirc{s_\Theta}{x}}}{\FI{(\UnSt{s_{\Theta}}{x}, \UnSt{s_{\Theta \uparrow A}}{y})}}} \\
&\equiv \rewrite{\ApPlus{s_{\Theta \uparrow A \uparrow B}}{\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\StI{s_{\Theta}}{\FI{(\UnSt{s_{\Theta}}{x}, \UnSt{s_{\Theta \uparrow A}}{y})}}}} \\
\end{align*}
Let us focus on the term inside the rewrite:
\begin{align*}
&\StI{s_{\Theta}}{\FI{(\UnSt{s_{\Theta}}{x}, \UnSt{s_{\Theta \uparrow A}}{y})}} : \St{s_\Theta}{\F{z.\Sigma_1(\asdep{\Delta}, \fst z, \snd z)[\downstairs{\Theta}]}{\telety{x'}{\upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta},x'/x]}}} \\
&\equiv \FI{(\UnSt{s_{\Theta}}{x}, \UnSt{s_{\Theta \uparrow A}}{y})} : \F{z.\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}, \fst z, \snd z)[\downstairs{\Theta}]}}{\telety{x'}{\upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta},x'/x]}} \\
&\equiv \FI{(\UnSt{s_{\Theta}}{x}, \UnSt{s_{\Theta \uparrow A}}{y})} : \F{z.\Sigma_1(\asdep{\Gamma},\fst z,\snd z)[\TrPlus{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{z}/z]}{\telety{x'}{\upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta},x'/x]}} \\
&\equiv \FI{\StI{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{(\UnSt{s_{\Theta}}{x}, \UnSt{s_{\Theta \uparrow A}}{y})}} : \F{z.\Sigma_1(\asdep{\Gamma},\fst z,\snd z)}{\St{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{\telety{x'}{\upstairs{A}[\upstairs{\Theta}]}{\upstairs{B}[\upstairs{\Theta}, x'/x]}}} \\
&\equiv \FI{(\StI{s_\Theta}{\UnSt{s_{\Theta}}{x}}, \StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\TrCirc{s_\Theta}{x}}})}{\UnSt{s_{\Theta \uparrow A}}{y})}} : \F{z.\Sigma_1(\asdep{\Gamma},\fst z,\snd z)}{\telety{x'}{\St{s_\Theta}{\upstairs{A}[\upstairs{\Theta}]}}{\St{(s_\Theta \bdot \eta^{s_\Theta}_{x'})}{\upstairs{B}[\upstairs{\Theta}, \UnSt{s_\Theta}{x'}/x]}}} \\
\end{align*}
And the rewrite itself:
\begin{align*}
&\ApPlus{s_{\Theta \uparrow A \uparrow B}}{\ApPlus{\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}{\var{\Sigma_1(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}}} \\
&\equiv \ApPlus{(s_{\Theta \uparrow A \uparrow B};\mathtt{pair}(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y}))}{\var{\Sigma_1(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}} \\
&\equiv \ApPlus{(\mathtt{pair}(\asdep{\Gamma},x,y);s_{\Theta \uparrow \Sigma_A B})}{\var{\Sigma_1(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}} \\
&\equiv \ApPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\ApPlus{s_{\Theta \uparrow \Sigma_A B}}{\var{\Sigma_1(\asdep{\Delta}[\downstairs{\Theta}],\TrCirc{s_\Theta}{x},\TrCirc{s_{\Theta \uparrow A}}{y})}}} \\
&\equiv \ApPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\ApPlus{s_{\Theta \uparrow \Sigma_A B}}{\var{\TrCirc{s_\Theta}{\Sigma_1(\asdep{\Gamma},x,y)}}}} \\
&\equiv \ApPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)};\TrPlus{\pi^{\asdep{\Gamma}}_{\Sigma_1(\asdep{\Gamma},x,y)}}{\eta^{s_{\Theta}}_{\Sigma_1(\asdep{\Gamma},x,y)}}} \\
&\equiv \ApPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}};\ApPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\TrPlus{\pi^{\asdep{\Gamma}}_{\Sigma_1(\asdep{\Gamma},x,y)}}{\eta^{s_{\Theta}}_{\Sigma_1(\asdep{\Gamma},x,y)}}} \\
&\equiv \TrPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}};\TrPlus{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\eta^{s_{\Theta}}_{\Sigma_1(\asdep{\Gamma},x,y)}} \\
&\equiv \TrPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}};\TrPlus{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\ap{\Sigma_1(\asdep{\Gamma},\fst z, \snd z)}{(\eta^{s_\Theta}_x, \eta^{s_{\Theta \uparrow A}}_y)/z}}
\end{align*}
So finally:
\begin{align*}
&\equiv \rewrite{\TrPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}};\TrPlus{(\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x)}{\ap{\Sigma_1(\asdep{\Gamma},\fst z, \snd z)}{(\eta^{s_\Theta}_x, \eta^{s_{\Theta \uparrow A}}_y)/z}}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(\StI{s_\Theta}{\UnSt{s_\Theta}{x}}, \StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\TrCirc{s_\Theta}{x'}}})}{\UnSt{s_{\Theta \uparrow A}}{y}})}}} \\
&\equiv \rewrite{\TrPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\rewrite{\ap{\Sigma_1(\asdep{\Gamma},\fst z, \snd z)}{(\eta^{s_\Theta}_x, \eta^{s_{\Theta \uparrow A}}_y)/z}}{\FI{(\StI{s_\Theta}{\UnSt{s_\Theta}{x}}, \StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\TrCirc{s_\Theta}{x'}}})}{\UnSt{s_{\Theta \uparrow A}}{y}})}}}} \\
&\equiv \rewrite{\TrPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{\rewrite{(\eta^{s_\Theta}_x, \eta^{s_{\Theta \uparrow A}}_y)}{(\StI{s_\Theta}{\UnSt{s_\Theta}{x}}, \StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\TrCirc{s_\Theta}{x'}}})}{\UnSt{s_{\Theta \uparrow A}}{y}})}}}} \\
&\equiv \rewrite{\TrPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(\rewrite{\eta^{s_\Theta}_x}{\StI{s_\Theta}{\UnSt{s_\Theta}{x}}}, \rewrite{\eta^{s_{\Theta \uparrow A}}_y}{\StI{\ap{\asdep{\Gamma}.y}{\eta^{s_\Theta}_{x'}/y}}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\TrCirc{s_\Theta}{x'}}})}{\UnSt{s_{\Theta \uparrow A}}{y}}}})}}} \\
&\equiv \rewrite{\TrPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(\rewrite{\eta^{s_\Theta}_x}{\StI{s_\Theta}{\UnSt{s_\Theta}{x}}}, \rewrite{\eta^{s_{\Theta \uparrow A}}_y}{\StI{s_{\Theta \uparrow A}}{\UnSt{s_{\Theta \uparrow A}}{y}}})}}} \\
&\equiv \rewrite{\TrPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(x, y)}}} \\
&\equiv \upstairs{\mathsf{pair}_{A[\Theta], B[\Theta \uparrow A]}}
\end{align*}

\item[{$\mathsf{split}_{A,B}(c)[\Theta \uparrow \Sigma_A B] \equiv \mathsf{split}_{A[\Theta],B[\Theta \uparrow A]}(c[\Theta \uparrow A \uparrow B])$}:] Expanding the definitions:
\begin{align*}
&\upstairs{\mathsf{split}_{A,B}(c)[\Theta \uparrow \Sigma_A B]} \\
&\equiv \StI{s_{\Theta \uparrow \Sigma_A B}}{\upstairs{\mathsf{split}_{A,B}(c)}[\upstairs{\Theta \uparrow \Sigma_A B}]} \\ 
&\equiv \StI{(s_\Theta \bdot \eta_z^{s_\Theta})}{\upstairs{\mathsf{split}_{A,B}(c)}[\upstairs{\Theta}, \UnSt{s_\Theta}{z}/z]} \\
&\equiv \StI{(s_\Theta \bdot \eta_z^{s_\Theta})}{\FEs{w.\Sigma_1(\asdep{\Delta}, \fst w, \snd w)}{z}{w}{\StI{\mathtt{split}(\asdep{\Delta},\fst w,\snd w)}{\upstairs{c}[\fst w / x, \snd w / y]}}[\upstairs{\Theta}, \UnSt{s_\Theta}{z}/z]} \\
&\equiv \StI{(s_\Theta \bdot \eta_z^{s_\Theta})}{\FEs{w.\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}{\UnSt{s_\Theta}{z}}{w}{\StI{\mathtt{split}(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}{\upstairs{c}[\upstairs{\Theta}, \fst w / x, \snd w / y]}}} \\
&\equiv \FE{z}{w}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}})}{\StI{\mathtt{split}(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}{\upstairs{c}[\upstairs{\Theta}, \fst w / x, \snd w / y]}}} \\
&\equiv \FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\TrPlus{s_\Theta}{\fst w},\TrPlus{(s_\Theta, \id)}{\snd w})}{\StI{((s_\Theta \bdot \id) \bdot \id)}{\upstairs{c}[\upstairs{\Theta}, \fst w / x, \snd w / y]}}} \\
&\equiv \FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\TrPlus{s_\Theta}{\fst w},\TrPlus{(s_\Theta, \id)}{\snd w})}{\StI{s_{\Theta \uparrow A \uparrow B}}{\StI{((\id \bdot \varepsilon) \bdot \varepsilon)}{\upstairs{c}[\upstairs{\Theta}, \fst w / x, \snd w / y]}}}} \\
&\equiv \FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\TrPlus{s_\Theta}{\fst w},\TrPlus{(s_\Theta, \id)}{\snd w})}{\StI{s_{\Theta \uparrow A \uparrow B}}{\upstairs{c}[\upstairs{\Theta}, \fst w / x, \snd w / y][\rewrite{(\varepsilon^{s_\Theta}_{\fst w} \bdot \varepsilon^{s_{\Theta \uparrow A}}_{\TrPlus{\ap{\asdep{\Delta}[\Theta].x}{\varepsilon^{s_\Theta}_{\fst w}/x}}{\snd w}})}{w}/w]}}} \\
&\equiv \FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\TrPlus{s_\Theta}{\fst w},\TrPlus{(s_\Theta, \id)}{\snd w})}{\StI{s_{\Theta \uparrow A \uparrow B}}{\upstairs{c}[\upstairs{\Theta}, \UnSt{s_\Theta}{\fst w} / x, \UnSt{s_{\Theta \uparrow A}}{\snd w} / y][\StI{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{w}/w]}}} \\
&\equiv \FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\fst w,\snd w)}{\StI{s_{\Theta \uparrow A \uparrow B}}{\upstairs{c}[\upstairs{\Theta}, \UnSt{s_\Theta}{\fst w} / x, \UnSt{s_{\Theta \uparrow A}}{\snd w} / y]}}[\StI{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{w}/w]} \\
&\equiv \FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\fst w,\snd w)}{\StI{s_{\Theta \uparrow A \uparrow B}}{\upstairs{c}[\upstairs{\Theta}, \UnSt{s_\Theta}{\fst w} / x, \UnSt{s_{\Theta \uparrow A}}{\snd w} / y]}}} \\
&\equiv \FE{z}{w}{\StI{\mathtt{split}(\asdep{\Gamma},\fst w,\snd w)}{\upstairs{c[\Theta \uparrow A \uparrow B]}[\fst w / x, \snd w / y]}} \\
&\equiv \upstairs{\mathsf{split}_{A[\Theta],B[\Theta \uparrow A]}(c[\Theta \uparrow A \uparrow B])}
\end{align*}
\mvrnote{Annotate the subscript on the $F$}
We use the following identities. First,
\begin{align*}
&\StI{(s_\Theta \bdot \eta_z^{s_\Theta})}{\FEs{w.\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}{\UnSt{s_\Theta}{z}}{w}{\dots}} \\ 
&\equiv \FE{z}{w}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}})}{\dots}}
\end{align*}
by:
\begin{align*}
&\StI{(s_\Theta \bdot \eta_z^{s_\Theta})}{\FEs{w.\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}{\UnSt{s_\Theta}{z}}{w}{\dots}} \\
&\equiv \StI{(\id_{\asdep{\Gamma}} \bdot \eta_z^{s_\Theta})}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\TrCirc{s_\Theta}{z}}})}{\FEs{w.\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}{\UnSt{s_\Theta}{z}}{w}{\dots}}} \\
&\equiv \StI{(\id_{\asdep{\Gamma}} \bdot \eta_z^{s_\Theta})}{\FEs{w.\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}{\UnSt{s_\Theta}{z}}{w}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}})}{\dots}}} \\
&\equiv \rewrite{\ap{1_{\asdep{\Gamma}.k}}{\eta^{s_\Theta}_z}}{\StI{\ap{\asdep{\Gamma}.k}{\eta^{s_\Theta}_z}}{\FEs{w.\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}{\UnSt{s_\Theta}{z}}{w}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}})}{\dots}}}} \\
&\equiv \rewrite{\ap{1_{\asdep{\Gamma}.k}}{\eta^{s_\Theta}_z}}{\StI{\ap{\asdep{\Gamma}.k}{\eta^{s_\Theta}_z}}{\FEs{w.\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}}{\StI{s_\Theta}{\UnSt{s_\Theta}{z}}}{w}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}})}{\dots}}}} \\
&\equiv \FEs{w.\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}}{\rewrite{\eta^{s_\Theta}_z}{\StI{s_\Theta}{\UnSt{s_\Theta}{z}}}}{w}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}})}{\dots}} \\
&\equiv \FEs{w.\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\Theta], \fst w, \snd w)}}{z}{w}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{\Sigma_1(\asdep{\Delta}[\upstairs{\Theta}],\fst w,\snd w)}})}{\dots}}
\end{align*}

And secondly, for any $w : \telety{x}{A}{B}$ \mvrnote{of appropriate types}, we have
\begin{align*}
&\rewrite{(\varepsilon^{s_\Theta}_{\fst w} \bdot \varepsilon^{s_{\Theta \uparrow A}}_{\TrPlus{\ap{\asdep{\Delta}[\Theta].x}{\varepsilon^{s_\Theta}_{\fst w}/x}}{\snd w}})}{w}\\
&\equiv (\UnSt{s_\Theta}{\fst w}, \UnSt{s_{\Theta \uparrow A}}{\snd w})[\StI{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{w}/w]
\end{align*}
by:
\begin{align*}
&\rewrite{(\varepsilon^{s_\Theta}_{\fst w} \bdot \varepsilon^{s_{\Theta \uparrow A}}_{\TrPlus{\ap{\asdep{\Delta}[\Theta].x}{\varepsilon^{s_\Theta}_{\fst w}/x}}{\snd w}})}{w}\\
&\equiv (\rewrite{\varepsilon^{s_\Theta}_{\fst w}}{\fst w}, \rewrite{\varepsilon^{s_{\Theta \uparrow A}}_{\TrPlus{\ap{\asdep{\Delta}[\Theta].x}{\varepsilon^{s_\Theta}_{\fst w}/x}}{\snd w}}}{\StI{\ap{\asdep{\Delta}[\Theta].x}{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\Theta]}}/x}}{\snd w}}) \\
&\equiv (\UnSt{s_\Theta}{\StI{s_\Theta}{\fst w}}, \UnSt{s_{\Theta\uparrow A}}{\StI{s_{\Theta\uparrow A}}{\StI{\ap{\asdep{\Delta}[\Theta].x}{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\Theta]}}/x}}{\snd w}}} \\
&\equiv (\UnSt{s_\Theta}{\StI{s_\Theta}{\fst w}}, \UnSt{s_{\Theta\uparrow A}}{\StI{s_{\Theta\uparrow A};\ap{\asdep{\Delta}[\Theta].x}{\varepsilon^{s_\Theta}_{1_{\asdep{\Delta}[\Theta]}}/x}}{\snd w}} \\
&\equiv (\UnSt{s_\Theta}{\StI{s_\Theta}{\fst w}}, \UnSt{s_{\Theta\uparrow A}}{\StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{1_{\asdep{\Delta}[\Theta]}}})}{\snd w}} \\
&\equiv (\UnSt{s_\Theta}{\fst w}, \UnSt{s_{\Theta \uparrow A}}{\snd w})[(\StI{s_\Theta}{\fst w}, \StI{(s_\Theta \bdot \id_{\TrPlus{s_\Theta}{1_{\asdep{\Delta}[\Theta]}}})}{\snd w}/w] \\
&\equiv (\UnSt{s_\Theta}{\fst w}, \UnSt{s_{\Theta \uparrow A}}{\snd w})[\StI{(s_\Theta, (s_\Theta \bdot \id_{\TrPlus{s_\Theta}{x}}))}{w}/w] \\
\end{align*}

%\item[{$\mathsf{split}_{A,B}(\mathsf{pair}_{A,B}) \equiv \var{\Gamma, \Sigma_A B}$}:] Expanding the definitions:
%\begin{align*}
%&\upstairs{\mathsf{split}_{A,B}(\mathsf{pair}_{A,B})} \\
%&\equiv \FE{z}{w}{\rewrite{\ApCirc{\mathtt{pair}(\asdep{\Gamma},x,y)}{\varepsilon^{\mathtt{split}(\asdep{\Gamma},x,y)}_{1_{\asdep{\Gamma}.{\fst w}.{\snd w}}}}}{\UnSt{\mathtt{pair}(\asdep{\Gamma},x,y)}{\upstairs{\mathsf{pair}_{A,B}}}}} \\
%&\equiv \FE{z}{w}{\rewrite{\ApCirc{\mathtt{pair}(\asdep{\Gamma},x,y)}{\varepsilon^{\mathtt{split}(\asdep{\Gamma},x,y)}_{1_{\asdep{\Gamma}.{\fst w}.{\snd w}}}}}{\UnSt{\mathtt{pair}(\asdep{\Gamma},x,y)}{\rewrite{\ApPlus{\mathtt{pair}(\asdep{\Gamma},x,y)}{\var{\Sigma_1(\asdep{\Gamma},x,y)}}}{\StI{\pi^{\asdep{\Gamma}.x}_y;\pi^{\asdep{\Gamma}}_x}{\FI{(x, y)}}}}}} \\
%\end{align*}
%\mvrnote{todo: rest of eta?}
\end{enumerate}


%If $p$ only supports weak $\Sigma$-types, we can still translate the weak elimination rule.
%
%\begin{enumerate}[style = multiline, labelwidth = 80pt]
%\item[\textsc{$\Sigma$-split-weak}] \mvrnote{TODO}
%\end{enumerate}
%\mvrnote{And equations}

%%% pi1 and pi2 style
%\item[\textsc{$\Sigma$-pair}] We have $\Gamma \qyields a : A$ and $\Gamma \qyields b : B[\hat{a}]$, i.e.:
%\begin{align*}
%\upstairs{\Gamma} &\yields_{1_{\asdep{\Gamma}}} \upstairs{a} : \upstairs{A} \\
%\upstairs{\Gamma} &\yields_{1_{\asdep{\Gamma}}} \upstairs{b} : \St{(\eta^\chi_{\asdep{\Gamma}})}{\upstairs{B}[\upstairs{a}/x]} \\
%\end{align*}
%So define $\upstairs{(a, b)} : \upstairs{\Sigma_A B}$ to be the framework term:
%\begin{mathpar}
%\inferrule*[Left=F-intro]{
%\inferrule*[Left={$(,)$-pair}] {
%\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \upstairs{a} : \upstairs{A} \and
%\inferrule*[left=s-elim-2]{
%\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \upstairs{b} : \St{(\eta^\chi_{\asdep{\Gamma}})}{\upstairs{B}[\upstairs{a}/x]}
%}{\upstairs{\Gamma} \yields_{\TrCirc{\eta^\chi_{\asdep{\Gamma}}}{1_{\asdep{\Gamma}}}} \UnSt{\eta^\chi_{\asdep{\Gamma}}}{\upstairs{b}} : {\upstairs{B}[\upstairs{a}/x]}
%}}
%{\upstairs{\Gamma} \yields_{(1_{\asdep{\Gamma}}, \TrCirc{\eta^\chi_{\asdep{\Gamma}}}{1_{\asdep{\Gamma}}})} (\upstairs{a}, \UnSt{\eta^\chi_{\asdep{\Gamma}}}{\upstairs{b}}) : \telety{x}{\upstairs{A}}{\upstairs{B}}}}
%{
%\upstairs{\Gamma} \yields_{
%\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)[(1_{\asdep{\Gamma}}, \TrCirc{\eta^\chi_{\asdep{\Gamma}}}{1_{\asdep{\Gamma}}})/z]
%} \FI{(\upstairs{a}, \UnSt{\eta^\chi_{\asdep{\Gamma}}}{\upstairs{b}})} : \upstairs{\Sigma_A B}
%}
%\end{mathpar}
%The mode of this term is:
%\begin{align*}
%&\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)[(1_{\asdep{\Gamma}}, \TrCirc{\eta^\chi_{\asdep{\Gamma}}}{1_{\asdep{\Gamma}}})/z] \\
%&\equiv \Sigma_1(\asdep{\Gamma}, 1_{\asdep{\Gamma}}, \TrCirc{\eta^\chi_{\asdep{\Gamma}}}{1_{\asdep{\Gamma}}}) \\
%&\equiv \TrCirc{\pi^{\asdep{\Gamma}}_{1_{\asdep{\Gamma}}}}{\TrCirc{\eta^\chi_{\asdep{\Gamma}}}{1_{\asdep{\Gamma}}}} \\
%&\equiv \TrCirc{(\eta^\chi_{\asdep{\Gamma}};\pi^{\asdep{\Gamma}}_{1_{\asdep{\Gamma}}})}{1_{\asdep{\Gamma}}} \\
%&\equiv 1_{\asdep{\Gamma}}
%\end{align*}
%as required.

%\item[\textsc{$\Sigma$-$\pi_1$}] We are handed $\Gamma \qyields p : \Sigma_A B$, i.e. 
%\begin{align*}
%\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \upstairs{p} : \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}
%\end{align*}
%Then $\upstairs{\pi_1(p)}$ is:
%\begin{mathpar}
%\inferrule*[Left=F-elim]{\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \upstairs{p} : \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}
%\and
%\inferrule*[left=rewrite]{\upstairs{\Gamma}, z : \telety{x}{\upstairs{A}}{\upstairs{B}} \yields_{\fst z} \fst z : \upstairs{A}}
%{\upstairs{\Gamma}, z : \telety{x}{\upstairs{A}}{\upstairs{B}} \yields_{\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)} \rewrite{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)}{\fst z} : \upstairs{A}}
%}
%{\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \FE{\upstairs{p}}{z}{\rewrite{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)}{\fst z}} : \upstairs{A}
%}
%\end{mathpar}
%
%\item[\textsc{$\Sigma$-$\pi_2$}] Again we have $\Gamma \qyields p : \Sigma_A B$, so
%\begin{align*}
%\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \upstairs{p} : \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}
%\end{align*}
%and we are are trying to get
%\begin{align*}
%\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \St{\eta^\chi_{\asdep\Gamma}}{\upstairs{B}[\upstairs{\pi_1(p)}/x]}
%\end{align*}
%To apply $\mathsf{F}$-elim, we need to produce an appropriate term of:
%\begin{align*}
%\upstairs{\Gamma}, z : \telety{x}{\upstairs{A}}{\upstairs{B}} \yields &\upstairs{B}[\upstairs{\pi_1(y)}/x][\FI{z}/y] \TYPE \\
%&\equiv \upstairs{B}[\FE{y}{z}{\rewrite{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)}{\fst z}}/x][\FI{z}/y] \\
%&\equiv \upstairs{B}[\FE{\FI{z}}{z}{\rewrite{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)}{\fst z}}/x] \\
%&\equiv \upstairs{B}[\rewrite{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)}{\fst z}/x] \\
%&\equiv \St{(\ap{\asdep{\Gamma}.x}{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)/x})}{\upstairs{B}[\fst z/x]}
%\end{align*}
%There is an `obvious' term that fits: use
%\begin{align*}
%\upstairs{\Gamma}, z : \telety{x}{\upstairs{A}}{\upstairs{B}} \yields \StI{\ap{\asdep{\Gamma}.x}{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)/x}}{\snd z} : \St{(\ap{\asdep{\Gamma}.x}{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)/x})}{\upstairs{B}[\fst z/x]}
%\end{align*}
%Define $\upstairs{\pi_2(p)}$ to be:
%\begin{mathpar}
%\inferrule*[Left=s-intro]{
%\inferrule*[Left=F-elim]{\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \upstairs{p} : \F{z.\Sigma_1(\asdep{\Gamma}, \fst z, \snd z)}{\telety{x}{\upstairs{A}}{\upstairs{B}}}
%\\
%\upstairs{\Gamma}, z : \telety{x}{\upstairs{A}}{\upstairs{B}} \yields \StI{\ap{\asdep{\Gamma}.x}{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)/x}}{\snd z} : \St{(\ap{\asdep{\Gamma}.x}{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)/x})}{\upstairs{B}[\fst z/x]}
%}
%{\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}.1}} \FE{\upstairs{p}}{z}{\StI{\ap{\asdep{\Gamma}.x}{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)/x}}{\snd z}} : \upstairs{B}[\upstairs{\pi_1(p)}/x]
%}}
%{
%\upstairs{\Gamma} \yields_{1_{\asdep{\Gamma}}} \StI{\eta^\chi_{\asdep\Gamma}}{\FE{\upstairs{p}}{z}{\StI{\ap{\asdep{\Gamma}.x}{\ApCirc{\pi^{\asdep{\Gamma}}_{\fst z}}{!_{\snd z}};E(\fst z)/x}}{\snd z}}} : \St{\eta^\chi_{\asdep\Gamma}}{\upstairs{B}[\upstairs{\pi_1(p)}/x]}
%}
%\end{mathpar}

\bibliographystyle{abbrv}
\bibliography{../drl-common/cs}

\end{document}

\subsection{Upstairs Types}
\mvrnote{Outdated stuff:}

The mode terms for upstairs $\Sigma$ and $\Pi$ types are
\begin{align*}
\alpha : p, x : \El{p}{\alpha}, y : \El{p}{\alpha.x} \yields \Sigma_1(\alpha,x,y) :\equiv \TrCirc{\ApEl{p}{\pi^\alpha_x}}{y}  : \El{p}{\alpha}\\
\alpha : p, x : \El{p}{\alpha}, y : \El{p}{\alpha} \yields \Pi_1(\alpha,x,y) :\equiv \TrPlus{\ApEl{p}{\pi^\alpha_x}}{y} : \El{p}{\alpha.x}
\end{align*}
The equations that $z.\TrCirc{(\pi^{\fst z}_{\snd{z}})}{y}$ is part of a
morphism of fibrations says that $\Sigma$-types are stable under
substitution (and preserve the adjunctions).

Using equation \eqref{circ-one}, these terms are:
\begin{align*}
\ApEl{p}{\pi}^\circ(y) \equiv \ApEl{p}{\pi^\alpha_x}^\circ(\ApEl{p}{\pi^{\alpha.x}_y}^\circ(1_{\alpha.x.y})) \equiv \ApEl{p}{\pi;\pi}^\circ(1_{\alpha.x.y}) \\
\ApEl{p}{\pi^\alpha_x}^+(y) \equiv \ApEl{p}{\pi^{\alpha.x}_{\ApEl{p}{\pi^\alpha_x}^+(y)}}^\circ(1_{\alpha.x.\ApEl{p}{\pi}^+(y)})
\end{align*}
which is like what we were writing in the profunctor mode theory.  

This could be made more formal by giving an inductive encoding, but the
basic idea for representing a standard dependent type theory (which we
will refer to as the ``object language'') is as follows:
\begin{itemize}
\item An object-language context $x_1 : A_1, \ldots , x_n : A_n$
  determines a mode context
  \[x_1 : \El{p}{\emptyset}, x_2 : \El{p}{\emptyset.x_1}, \ldots, x_{i+1} : \El{p}{\emptyset.x_1.x_2.\ldots.x_i},\ldots
  \]
  and an upstairs context
  \[x_1 : A_1, x_2 : A_2, \ldots, x_{i+1}:A_{i+1},\ldots
  \]
  over it.  We write $\underline{\Gamma}$ for
  $\emptyset.x_1.x_2.\ldots.x_n$ when $\Gamma$ is
  $x_1 : A_1, \ldots , x_n : A_n$.

\item A judgement $\Gamma \yields A \TYPE$ is represented by
  $\Gamma \yields_{\underline{\Gamma}} A \TYPE$.

\item A judgement $\Gamma \yields a : A$ is represented by
  $\Gamma \yields_{1_{\underline{\Gamma}}} a : A$.

\item $\Sigma$ types are represented by
  \begin{mathpar}
    \inferrule{ \inferrule{\Gamma \yields_{\El{p}{\underline{\Gamma}}} A \TYPE \and
                            \Gamma,x:A \yields_{\El{p}{\underline{\Gamma,x:A}}} B \TYPE}
                          {\Gamma \yields_{\sigmacl{x}{\El{p}{\underline{\Gamma}}}{\El{p}{\underline{\Gamma}.x}}} {\telety{x}{A}{B}} \TYPE }}
            { \Gamma \yields_{\El{p}{\underline{\Gamma}}} \sigmacl{x}{A}{B} := \F{p.\Sigma_1(\underline{\Gamma},\fst p,\snd p)}{\telety{x}{A}{B}} \TYPE }
  \end{mathpar}
\drlnote{Write out what happens when you weaken/substitute.}
  
Pairing is derived as follows:
\begin{mathpar}  
    \inferrule{
    \inferrule{
      \inferrule{\Gamma \yields_{1_{\El{p}{\underline{\Gamma}}}} a : A \and
                 \inferrule{\Gamma \yields_{1_{\El{p}{\underline{\Gamma}.1_{\underline{\Gamma}}}}} B[a/x] \TYPE}
                           {\Gamma \yields_{1_{\El{p}{\underline{\Gamma}}}} b : B[a/x]}
                }
                {\Gamma \yields_{(1_{\underline{\Gamma}},1_{\underline{\Gamma}})} (a,b) : \telety{x}{A}{B}}
    }
    {\Gamma \yields_{\Sigma_1({\El{p}{\underline{\Gamma}}},{1_{\El{p}{\underline{\Gamma}}}},{1_{\El{p}{\underline{\Gamma}}}})} \FI{a,b} : \sigmacl{x}{A}{B}}}
    {\Gamma \yields_{1_{\Gamma}} : \FI{a,b} : \sigmacl{x}{A}{B}}
\end{mathpar}
This uses the equation
$\underline{\Gamma}.1_{\underline{\Gamma}} \equiv \underline{\Gamma}$
(which is a form of contraction) in various places: it's why $B[a/x]$ lives over $1_{\underline{\Gamma}}$
and why $(1_{\underline{\Gamma}},1_{\underline{\Gamma}})$ makes sense
as an element of $\sigmacl{x}{\El{p}{\underline{\Gamma}}}{\El{p}{\underline{\Gamma}.x}}$.
For the final step, we use \eqref{pi-one-strict}:
\begin{mathpar}
{\Sigma_1({\El{p}{\underline{\Gamma}}},{1_{\El{p}{\underline{\Gamma}}}},{1_{\El{p}{\underline{\Gamma}}}})}  
\equiv
\TrCirc{\ApEl{p}{\pi^{\underline{\Gamma}}_{1_{\El{p}{\underline{\Gamma}}}}}}{{1_{\El{p}{\underline{\Gamma}}}}}
\equiv
\TrCirc{\ApEl{p}{\id}}{{1_{\El{p}{\underline{\Gamma}}}}}
\equiv
{{1_{\El{p}{\underline{\Gamma}}}}}
\end{mathpar}

\drlnote{Do split}

\item \drlnote{$\Pi$ types}

\item \drlnote{Variable rule}
  
\end{itemize}


Observe that this lands in a fragment of the framework where each piece
of the judgement depends once on all previous variables, and where the
term $a$ depends on exactly the same variables as the type $A$.



\subsection{Morphism of Comprehension Objects}

Let $(p,\El{p}{-},\chi_p)$ and $(q,\El{q}{-},\chi_q)$ be two comprehension objects.

\mvrnote{FIXME: below is out of date}

\begin{definition}[Lifting to dependent types]
  For a mode term ${\alpha : p \yields f_0(\alpha) : q}$,
  its \emph{lifting to dependent types} is
\begin{mathpar}
  {\alpha : p, x : \El{p}{\alpha} \yields f_1(\alpha,x) : \El{p}{f_0(\alpha)}}
  \and
  f_1(\alpha,x) :\equiv \TrCirc{\ap{\El{p}{f_0(-)}}{\pi^\alpha_x}}{1_{f_0(\alpha.x)}}
\end{mathpar}
\end{definition}
\noindent We use the convention that, for a mode term $f_0$, $f_1$ is
its lifting to dependent types.

Observe that equation \eqref{mor-opfib-subst} of being a morphism of
bifibrations is always true for the lifting of an $f_0$:
\begin{mathpar}
  \TrCirc{\ap{\El{p}{f_0(-)}}{\pi^\alpha_{\TrCirc{\ApEl{p}{s}}{\nu}}}}{1_{f_0(\alpha.\TrCirc{\ApEl{p}{s}}{\nu})}}
  \equiv
  \TrCirc{\ap{\El{p}{f_0(-)}}{s}}{\TrCirc{\ap{\El{p}{f_0(-)}}{\pi^\beta_\nu}}{1_{f_0(\beta.\nu)}}}
\end{mathpar}
using equations \eqref{dot-circ} \eqref{pi-dot-circ} and fusion.

The most basic form of modality is specified in the mode theory by a
morphism of comprehension objects between $p$ and $q$.  
\begin{definition}[\drlnote{Fiberwise?} morphism of comprehension objects]
  A morphism of comprehension objects between $p$ and $q$ is specified by
  a mode term
  \begin{mathpar}
    {\alpha : p \yields f_0(\alpha) : q}
  \end{mathpar}
  such that
  \begin{align}
  f_0(\emptyset_p) &\equiv \emptyset_q 
  \end{align}
\begin{center}
  $(f_0, f_1)$ is a morphism of bifibrations from $(p,\El{p}{-})$ to $(q,\El{q}{-})$
equations  \eqref{mor-fib-subst} \eqref{mor-fib-unit} \eqref{mor-fib-counit}.
\end{center}
\end{definition}

We often treat $\alpha$ as an implicit argument to $f_1$.  We can show
that $f$ preserves the rest of the structure of a comprehension object:
\begin{align}
\label{mor-one}
f_1(1_\alpha) &\equiv 1_{f_0(\alpha)} \\
\label{mor-dot}
f_0(\alpha.\mu) &\equiv f_0(\alpha).f_1(\mu) \\
\label{mor-pi}
\ap{f_0}{\pi^\alpha_\mu} &\equiv \pi^{f_0(\alpha)}_{f_1(\mu)} \\
\label{mor-var}
\ap{f_1(\alpha,-)}{\mathsf{var}_\mu} &\equiv \mathsf{var}_{f_1(\mu)}
\end{align}

\drlnote{Upstairs, a morphism of comprehension objects gives rise to an
  adjoint pair of functors on contexts, which interact with dependent
  types as follows\ldots}

\subsection{Spatial Type Theory}
\newcommand\flatE[3]{\ensuremath{\mathsf{let} \, #2^\flat \, := \, {#1} \, \mathsf{in} \, #3}}

Let
\begin{mathpar}
    {\alpha : p \yields f_0(\alpha) : p}
\end{mathpar}
be a morphism of comprehension objects, together with a mode term 2-cell 
\begin{mathpar}
    {\alpha : p \mid f_0(\alpha) \vDash_p c_\alpha : \alpha}
\end{mathpar}
and equations
\begin{align*}
f_0(f_0(\alpha)) &\equiv f_0(\alpha) \\
\ap{f_0}{c_\alpha} &\equiv \id_{f_0(\alpha)} \\
c_{f_0(\alpha)} &\equiv \id_{f_0(\alpha)}
\end{align*}
making $f_0$ into an idempotent comonad on $p$.

An operation
\begin{mathpar}
  {\alpha : p, x : \El{p}{f_0(\alpha)} \yields \flat_1(\alpha,x) : \El{p}{f_0(\alpha)}}
\end{mathpar}
can be defined in two equivalent ways: either \[\flat_1(\alpha,x) :\equiv f_1(f_0(\alpha),x)\] which typechecks due to idempotence, or \[ \flat_1(\alpha,x) :\equiv  f_1(\alpha,\ApEl{p}{c}^\circ(x)) \]
which is equivalent via:
\begin{align*}
f_1(\alpha,\ApEl{p}{c}^\circ(x)) 
&\equiv \TrCirc{\ap{\El{p}{f_0(-)}}{\pi^\alpha_{\ApEl{p}{c}^\circ(x)}}}{1_{f_0(\alpha.\ApEl{p}{c}^\circ(x))}} && \text{(Def of $f_1$)} \\
&\equiv \TrCirc{\ap{\El{p}{f_0(-)}}{\pi^{f_0(\alpha)}_x;c}}{1_{f_0(f_0(\alpha).x)}} && \text{(By equations \eqref{dot-circ} and \eqref{pi-dot-circ})} \\
&\equiv \TrCirc{\ap{\El{p}{f_0(-)}}{c}}{\TrCirc{\ap{\El{p}{f_0(-)}}{\pi^{f_0(\alpha)}_x}}{1_{f_0(f_0(\alpha).x)}}} && \text{(Fusion)} \\
&\equiv \TrCirc{\ap{\El{p}{f_0(-)}}{\pi^{f_0(\alpha)}_x}}{1_{f_0(f_0(\alpha).x)}} && \text{($\ap{f_0}{c_\alpha} \equiv \id_{f_0(\alpha)}$)} \\
&\equiv f_1(f_0(\alpha),x)
\end{align*}

A general useful principle is that any $\alpha$ ending with a $\flat_1$ is equal to $f_0$ of itself:
\begin{align*}
f_0(\alpha).\flat_1(x)
&\equiv f_0(\alpha.x) && \text{equation \eqref{mor-dot}} \\
&\equiv f_0(f_0(\alpha.x)) && \text{idempotence of $f_0$} \\
&\equiv f_0(f_0(\alpha).\flat_1(x)) && \text{equation \eqref{mor-dot} again} \\
\end{align*} 
This shows that $\flat_1$ is idempotent:
\begin{align*}
f_0(\alpha).\flat_1(\flat_1(x)) 
&\equiv f_0(f_0(\alpha)).\flat_1(\flat_1(x)) && \text{idempotence of $f_0$} \\
&\equiv f_0(f_0(\alpha).\flat_1(x)) && \text{equation \eqref{mor-dot}}  \\
&\equiv f_0(\alpha).\flat_1(x) && \text{equation above} 
\end{align*}

This time, an object-language context $\Delta; \Gamma \equiv x_1 : A_1, \ldots , x_n : A_n \mid y_1 : B_1, \ldots , y_m : B_m$
  determines a mode context $(\Delta; \Gamma)^\dagger$ where all the $x$'s are marked with $\flat_1$:
  \begin{align*}
  x_1 &: \El{p}{\emptyset}, \\ 
  x_2 &: \El{p}{\emptyset.\flat_1(x_1)}, \\ 
  &\ldots, \\
  x_{n} &: \El{p}{\emptyset.\flat_1(x_1).\ldots.\flat_1(x_{n-1})}, \\
  y_1 &: \El{p}{\emptyset.\flat_1(x_1).\ldots.\flat_1(x_{n-1}).\flat_1(x_{n})}, \\
  y_2 &: \El{p}{\emptyset.\flat_1(x_1).\ldots.\flat_1(x_{n-1}).\flat_1(x_{n}).y_1}, \\
   y_3 &: \El{p}{\emptyset.\flat_1(x_1).\ldots.\flat_1(x_{n-1}).\flat_1(x_{n}).y_1.y_2}, \\
  &\ldots
\end{align*}
  and an upstairs context
  \[x_1 : A_1, \ldots , x_n : A_n, y_1 : B_1, \ldots , y_m : B_m
  \]
  over it.  We write $\underline{(\Delta ; \Gamma)}$ for
  $\emptyset.\flat_1(x_1).\flat_1(x_2).\ldots.\flat_1(x_n).y_1.\dots.y_m$. This is equal to $f_0(\dots  f_0(f_0(\emptyset.x_1).x_2) \dots).y_1.\dots.y_m$, but \emph{not} the same as $f_0(x_1.\dots.x_n).y_1.\dots.y_m$.

These are defined inductively by
\begin{align*}
(\cdot; \cdot)^\dagger &\equiv \cdot \\
(\Delta, x :: A; \cdot)^\dagger &\equiv (\Delta, \cdot)^\dagger, x : \El{p}{\underline{\Delta, \cdot}} \\
(\Delta ; \Gamma, x : A)^\dagger &\equiv (\Delta, \Gamma)^\dagger, x : \El{p}{\underline{\Delta, \Gamma}} \\
\underline{\cdot ; \cdot} &\equiv \emptyset : p \\
\underline{\Delta, x :: A; \cdot} &\equiv (\underline{\Delta, \cdot}).\flat_1(x) : p\\
\underline{\Delta; \Gamma, x : A} &\equiv (\underline{\Delta, \Gamma}).x : p
\end{align*}

Note that \[f_0(\underline{\Delta ; \Gamma}) \equiv (\underline{\Delta, \Gamma ; \cdot})\]

If we have a context $\Delta; \Gamma, \Gamma'$, we can use $\Sigma_1$ to tuple the suffix $\Gamma'$ into a single element of $\El{p}{\underline{\Delta; \Gamma}}$:
\begin{align*}
\underline{\Delta ; \Gamma}. \underline{\cdot} &:\equiv \underline{\Delta ; \Gamma}.1_{\underline{\Delta ; \Gamma}}  \\
\underline{\Delta ; \Gamma}. \underline{\Gamma', x : A} &:\equiv \underline{\Delta ; \Gamma}.\Sigma_1(\underline{\Delta ; \Gamma}, \underline{\Gamma'}, x)
\end{align*}
The equations \eqref{dot-circ} and \eqref{pi-dot-circ} used repeatedly show that $(\underline{\Delta ; \Gamma}).\underline{\Gamma'} \equiv \underline{\Delta ; \Gamma, \Gamma'}$. Let $\pi_{\Gamma'}$ denote the term 2-cell
\begin{align*}
 \TermTwo{(\Delta ; \Gamma, \Gamma')^\dagger}{\pi_{\Gamma'}}{\underline{(\Delta ; \Gamma)}.\underline{\Gamma'}}{\underline{(\Delta ; \Gamma)}}
\end{align*}
The same equations can be used to show this is equal to a composite of $\pi$s.

Object-level judgements live over the mode theory as in MLTT:
\begin{align*}
&\yields \Delta;\Gamma & (\Delta, \Gamma)^\dagger &\yields \underline{(\Delta;\Gamma)} : p \\
\Delta ;\Gamma &\yields A \TYPE & (\Delta, \Gamma)^\dagger &\yields \El{p}{\underline{\Delta;\Gamma}} \type \\
\Delta;\Gamma &\yields M : A & (\Delta, \Gamma)^\dagger &\yields 1_{(\underline{\Delta;\Gamma})} : \El{p}{\underline{\Delta;\Gamma}}
\end{align*}

We can now reconstruct (approximations of) the spacial type theory rules as instances of the framework rules. The key is that in the framework whenever a $f_0(\alpha)$ is required, this can only arise in the object language as $(\underline{\Delta ; \cdot})$.

\begin{itemize}

\item \begin{mathpar}
\inferrule*[vcenter, Right = weaken]{\Delta ; \Gamma\yields M : A} 
{\Delta ; \Gamma, \Gamma' \yields M : A} 
\end{mathpar}
We use framework weakening combined with a structural rule:
\begin{mathpar}
\inferrule*[Right=s-intro]{
\inferrule*[Right = weaken]
{(\Delta ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta ; \Gamma)}}} M : A}
{(\Delta ; \Gamma, \Gamma')^\dagger \yields_{1_{\underline{(\Delta ; \Gamma)}}} M : A}}
{(\Delta ; \Gamma, \Gamma')^\dagger \yields_{1_{\underline{(\Delta ; \Gamma, \Gamma')}}} \StI{\pi}{M} : \pi^*_{\Gamma'}(A)}
\end{mathpar}

\item \begin{mathpar}
\inferrule*[vcenter, Right = crisp-weaken-suffix]{\Delta ; \cdot \yields M : A} 
{\Delta, \Delta' ; \cdot \yields M : A} 
\end{mathpar}
This is derived the same way.
The cases of weakening in the middle of the context will be trickier.

\item \begin{mathpar}
\inferrule*[vcenter, Right = var]{~}
{\Delta ; \Gamma, x : A \yields x : A} 
\end{mathpar}
The framework \textsc{var} rule lives over $x$, not $1_{\underline{(\Delta ; \Gamma, x : A)}}$, so we use structural rules to correct it:
\begin{mathpar}
\inferrule*[Right = rewrite]{
\inferrule*[Right = S-intro]{
\inferrule*[Right = var]{~}
  {(\Delta ; \Gamma, x : A)^\dagger \yields_{x} x : A}}
  {(\Delta ; \Gamma, x : A)^\dagger \yields_{\pi^+(x)} \StI{\pi}{x} : \pi^*(A)} \and ~ \and
    \TermTwo{(\Delta ; \Gamma, x : A)^\dagger }{\mathsf{var}_x}{1_{\underline{(\Delta ; \Gamma)}.x}}{\pi^+(x)}}
  {(\Delta ; \Gamma, x : A)^\dagger \yields_{1_{\underline{(\Delta ; \Gamma)}.x}} \mathsf{var}_x(\StI{\pi}{x}) : \pi^*(A)} \\
\end{mathpar}
And $1_{\underline{(\Delta ; \Gamma)}.x} \equiv 1_{\underline{(\Delta ; \Gamma, x : A)}}$ by definition.

\item \begin{mathpar}
\inferrule*[vcenter, Right = crisp-var]{~}
{\Delta, x :: A  ; \cdot \yields x : A} 
\end{mathpar}
Using the same derivation as in the cohesive \textsc{var} rule, we have 
\[(\Delta, x : A ; \cdot )^\dagger \yields_{1_{\underline{(\Delta ; \cdot)}.x}} \mathsf{var}_x(\StI{\pi}{x}) : \pi^*(A)\]
but we want a term over $1_{\underline{(\Delta ; \cdot)}.\flat_1(x)}$. So pull back along the 2-cell
\begin{mathpar}
    {\alpha : p \mid f_0(f_0(\underline{\Delta ; \cdot}).x) \vDash_p c_{f_0(\underline{\Delta ; \cdot}).x} : f_0(\underline{\Delta ; \cdot}).x}
\end{mathpar}
Where the domain is 
\begin{align*}
f_0(f_0(\underline{\Delta ; \cdot}).x)
\equiv f_0(f_0(\underline{\Delta ; \cdot})).\flat_1(x)
\equiv f_0(\underline{\Delta ; \cdot}).\flat_1(x)
\equiv (\underline{\Delta ; \cdot}).\flat_1(x)
\end{align*}
and the codomain is 
\begin{align*}
f_0(\underline{\Delta ; \cdot}).x \equiv (\underline{\Delta ; \cdot}).x
\end{align*}
as required.

\item \begin{mathpar}
\inferrule*[Right = subst]{\Gamma \yields M : A \and \Delta ; \Gamma, x : A \yields N : B}
{\Delta ; \Gamma \yields N[M/x] : B[M/x]} 
\end{mathpar}
Use framework substitution:
\begin{mathpar}
\inferrule*[Right= subst]{(\Delta ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta, \Gamma )}}} M : A \and (\Delta ; \Gamma, x : A)^\dagger \yields_{1_{\underline{(\Delta, \Gamma)}.x}} N : B}
{(\Delta ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta, \Gamma)}.1_{\underline{(\Delta, \Gamma )}}}} N[M/x] : B[M/x]}
\end{mathpar}
Then $1_{\underline{(\Delta, \Gamma)}.1_{\underline{(\Delta, \Gamma )}}} \equiv 1_{\underline{(\Delta, \Gamma)}}$ by equation \eqref{dot-one-strict}.

\item \begin{mathpar}
\inferrule*[Right = crisp-subst]{\Delta ; \cdot \yields M : A \and \Delta, x :: A ; \Gamma \yields N : B}
{\Delta ; \Gamma \yields N[M/x] : B[M/x]} 
\end{mathpar}
The structure of the rule means that none of the types in $\Gamma$ can depend on $x$, so \mvrnote{somehow} we can consider $N : B$ as lying over $1_{\underline{(\Delta, \cdot )}.\flat_1(x).\pi^+\underline{\Gamma}}$. \mvrnote{There is some lying about how $\dagger$ works, for this to make sense.} Then apply substitution as before:
\begin{mathpar}
\inferrule*[Right= subst]{(\Delta ; \cdot)^\dagger\yields_{1_{\underline{(\Delta, \cdot )}}} M : A \and (\Delta, x : A ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta, \cdot)}.\flat_1(x).\pi^+\underline{\Gamma}}} N : B}
{(\Delta ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta, \cdot)}.\flat_1(1_{\underline{(\Delta, \cdot )}}).\pi^+\underline{\Gamma}}} N[M/x] : B[M/x]}
\end{mathpar}
That subscript is what we want:
\begin{align*}
1_{\underline{(\Delta, \cdot)}.\flat_1(1_{\underline{(\Delta, \cdot )}}).\pi^+\underline{\Gamma}}
&\equiv 1_{\underline{(\Delta, \cdot)}.1_{\underline{(\Delta, \cdot )}}.\pi^+\underline{\Gamma}} && \text{equation \eqref{mor-one}} \\
&\equiv 1_{\underline{(\Delta, \cdot)}.\underline{\Gamma}} && \text{equations \eqref{dot-one-strict} and \eqref{pi-one-strict}} \\
&\equiv 1_{\underline{(\Delta, \Gamma)}} && \text{definition of $\underline{\Gamma}$}
\end{align*}

\item \begin{mathpar}
\inferrule*[Right = $\flat$-form]{\Delta ; \cdot \yields A \TYPE}
{\Delta ; \Gamma \yields \flat A \TYPE} 
\end{mathpar}
Apply the framework F-form rule for $\flat_1$:
\begin{mathpar}
\inferrule*[Right = F-form]{
    \Delta^\dagger \yields_{\El{p}{f_0(\underline{\Delta, \cdot})}} A \TYPE\\\\
    \gamma, x : {\El{p}{f_0(\underline{\Delta, \cdot})}} \yields \flat_1(\underline{\Delta, \cdot},x) : \El{p}{f_0(\underline{\Delta, \cdot})}
  }
  {\Delta^\dagger \yields_{\underline{(\Delta, \cdot)}} \F{x.\flat_1(\underline{\Delta, \cdot},x)}{A} \TYPE}
\end{mathpar}
The key is that $\underline{(\Delta, \cdot)}$ ends with a $\flat_1$, so $\underline{(\Delta, \cdot)} \equiv f_0(\underline{\Delta, \cdot})$. If $\Gamma$ is nonempty, there is no way to re-write $\underline{(\Delta, \Gamma)}$ into the form $f_0(-)$, explaining the restriction on the formation rule.

We can then weaken the result with $\Gamma$ to get the spatial type theory rule.

\item \begin{mathpar}
\inferrule*[Right = $\flat$-intro]{\Delta ; \cdot \yields M : A}
{\Delta ; \Gamma \yields M^\flat : \flat A}
\end{mathpar}
Again use that $(\underline{\Delta, \cdot}) \equiv f_0(\underline{\Delta, \cdot})$ and apply F-intro:
\begin{mathpar}
\inferrule*[vcenter, Right = F-intro]{
    \Delta^\dagger \yields_{1_{f_0(\underline{\Delta, \cdot})}} M : A
  }
  {\Delta^\dagger \yields_{\flat_1(\underline{\Delta, \cdot},x)[1/x]} \FI{M} : \F{x.\flat_1(\underline{\Delta, \cdot},x)}{A}}
\end{mathpar}
Equations \eqref{mor-one} means that $\flat_1(\underline{\Delta, \cdot},x)[1/x] \equiv 1_{\underline{\Delta, \cdot}}$. Finally, weaken with $\Gamma$.

\item \begin{mathpar}
\inferrule*[Right=crisp-$\flat$-elim]{
    \Delta, x :: \flat A ; \cdot \yields C \TYPE \\\\
    \Delta ; \cdot \yields M : \flat A \\\\
    \Delta, u :: A ; \Gamma \yields N : C[u^\flat / x]}
  {\Delta ; \Gamma \yields (\flatE{M}{u}{N}) : C[M / x]}
\end{mathpar}
As in crisp substitution, no types in $\Gamma$ may depend on $u$, so $N$ lives over 
\[ 1_{\underline{(\Delta ; \cdot)}.\flat_1(u).\pi^+(\underline{\Gamma})}\]
And we can use idempotence of $\flat_1$ to rewrite this into the form
\[ 1_{\underline{(\Delta ; \cdot)}.\flat_1(x).\pi^+(\underline{\Gamma})}[\flat_1(u) / x] \]
needed to apply F-elim:
\begin{mathpar}
 \inferrule*[Right = F-elim]{
    \Delta^\dagger , x : \F{c.\flat_1(\alpha,c)}{A} \yields_{\underline{(\Delta ; \cdot )}.\flat_1(x)} C \TYPE \\\\
     \Delta^\dagger \yields_{1_{\underline{(\Delta ; \cdot )}}} M : \F{c.\flat_1(\alpha,c)}{A} \\\\
    (\Delta, u :: A ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta ; \cdot)}.\flat_1(x).\pi^+(\underline{\Gamma})}[\flat_1(u) / x]} N : C [\FI{u}/x]}
  {(\Delta ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta ; \cdot)}.\flat_1(x).\pi^+(\underline{\Gamma})}[1_{\underline{(\Delta ; \cdot )}} / x]} (\FE{M}{u}{N}) : C[M/x]} \\
\end{mathpar}
This subscript is equal to $1_{\underline{(\Delta ; \Gamma )}}$ using equation \eqref{mor-one}, followed by \eqref{dot-one-strict} and \eqref{pi-one-strict}.

\item \begin{mathpar}
\inferrule*[Right=$\flat$-elim]{
    \Delta ; \Gamma, x : \flat A \yields C \TYPE \\\\
    \Delta ; \Gamma \yields M : \flat A \\\\
    \Delta, u :: A ; \Gamma \yields N : C[u^\flat / x]}
  {\Delta ; \Gamma \yields (\flatE{M}{u}{N}) : C[M / x]}
\end{mathpar}
In this rule, for $\flat A$ to be well typed it can only depend on $\Delta$. The type of $x$ in the framework is then
\[ \pi_\Gamma^\star(\F{c.\flat_1(\alpha,c)}{A}) \equiv \F{c.\pi_\Gamma^+(\flat_1(\alpha,c))}{A}\]
by. 

Like in crisp-$\flat$-elim, $\Gamma$ does not depend on $u$. The term $N$ lives over $1_{\underline{(\Delta, u :: A; \Gamma)}}$, which we rewrite into 
\[ 1_{\underline{(\Delta ; \Gamma )}.x}[\pi_\Gamma^+(\flat_1(\alpha,u)) / x] \]
\mvrnote{In $1_{\underline{(\Delta, u :: A; \Gamma)}}$ we have implicitly weakened all the types underlying $\Gamma$ with $u$. And we need something to do with $\pi$'s commuting with each other in some situations?}
Apply F-elim:
\begin{mathpar}
\inferrule*[Right = F-elim]{
    (\Delta ; \Gamma)^\dagger, x : \F{c.\pi_\Gamma^+(\flat_1(\alpha,c))}{A} \yields_{\underline{(\Delta ; \Gamma, x : \flat A)}} C \TYPE \\\\
    (\Delta ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta ; \Gamma )}}} M : \F{c.\pi_\Gamma^+(\flat_1(\alpha,c))}{A} \\\\
    (\Delta, u :: A ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta ; \Gamma )}.x}[\pi_\Gamma^+(\flat_1(\alpha,u)) / x]} N : C [\FI{x}/y]}
  {(\Delta ; \Gamma)^\dagger \yields_{1_{\underline{(\Delta ; \Gamma )}.x}[1_{\underline{(\Delta ; \Gamma )}}/x]} \FE{M}{u}{N} : C[M/x]}
\end{mathpar}
and $1_{\underline{(\Delta ; \Gamma )}.x}[1_{\underline{(\Delta ; \Gamma )}}/x] \equiv 1_{\underline{(\Delta ; \Gamma)}}$.

\item \begin{mathpar}
\inferrule*[Right = $\sharp$-form]{\Delta, \Gamma ; \cdot \yields A \TYPE}
{\Delta ; \Gamma \yields \sharp A \TYPE} 
\end{mathpar}
We use that $f_0(\underline{\Delta ; \Gamma}) \equiv (\underline{\Delta, \Gamma ; \cdot})$
\begin{mathpar}
\inferrule*[vcenter, Right = U-form]{
    (\Delta , \Gamma ; \cdot)^\dagger \yields_{\El{p}{f_0(\underline{\Delta ; \Gamma})}} A \TYPE \\\\
    \and \gamma, c : {\El{p}{\underline{\Delta ; \Gamma}}} \yields f_1(\underline{\Delta ; \Gamma},c) : \El{p}{f_0(\underline{\Delta ; \Gamma})}
  }{(\Delta ; \Gamma)^\dagger \yields_{\underline{(\Delta ; \Gamma)}} \U{c.f_1(\underline{\Delta ; \Gamma},c)}{\cdot}{A} \TYPE}
\end{mathpar}
\mvrnote{Wait, something screwy is happening here. We can't just replace $(\Delta , \Gamma ; \cdot)^\dagger$ by $(\Delta ; \Gamma)^\dagger$, we need to correct all the variables from $\Delta$ that appear in $\Gamma$ somehow.}

\item \begin{mathpar}
\inferrule*[Right = $\sharp$-intro]{\Delta, \Gamma ; \cdot \yields M : A}
{\Delta ; \Gamma \yields M^\sharp : \sharp A} 
\end{mathpar}
Again, $(\underline{\Delta , \Gamma ; \cdot}) \equiv f_0(\underline{\Delta ; \Gamma})$  so rewrite $1_{f_0(\underline{\Delta ; \Gamma})}$ into $f_1(\underline{\Delta ; \Gamma},c)[1_{(\underline{\Delta ; \Gamma})}/c]$ by equation \eqref{mor-one} and apply U-intro:
\begin{mathpar}
\inferrule*[vcenter, Right = U-intro]{
    (\Delta , \Gamma; \cdot )^\dagger \yields_{f_1(\underline{\Delta ; \Gamma},c)[1_{(\underline{\Delta ; \Gamma})}/c]}  M : A
  }
  {(\Delta ; \Gamma)^\dagger \yields_{1_{(\underline{\Delta ; \Gamma})}} \lambda{M} : \U{c.f_1(\underline{\Delta ; \Gamma},c)}{\cdot}{A}
  } 
\end{mathpar}

\item \begin{mathpar}
\inferrule*[Right = $\sharp$-elim]{\Delta ; \cdot \yields M : \sharp A}
{\Delta ; \Gamma \yields M_\sharp : A} 
\end{mathpar}
First apply U-elim:
\begin{mathpar}
\inferrule*[Right = U-elim]{
    \Delta^\dagger \yields_{1_{(\underline{\Delta ; \cdot})}} N : \U{c.f_1(\alpha,c)}{\cdot}{A}
  }{
    \Delta^\dagger \yields_{f_1(\alpha,c)[1_{(\underline{\Delta ; \cdot})}/c]} \UE{N}{\cdot} : A
  }
\end{mathpar}
Where $f_1(\alpha,c)[1_{(\underline{\Delta ; \cdot})}/c] \equiv 1_{f_0(\underline{\Delta ; \cdot})} \equiv 1_{(\underline{\Delta ; \cdot})}$. Then weaken with $\Gamma$.
\end{itemize}

\mvrnote{So what does the F-type for plain $f_0$ look like?}




\subsection{Modalities}

Start with a functor $f : p \to q$. Add:
\begin{mathpar}
  \inferrule{\gamma \yields \alpha : p}
            {\gamma \yields f_0(\alpha) : q}
\end{mathpar}
Now we can \emph{define}:
\begin{mathpar}
  \inferrule{\gamma \yields \mu : \El{p}{\alpha}}
            {\gamma \yields f_1(\mu) : \El{p}{f_0(\alpha)}}
\end{mathpar}
by:
\begin{align*}
f_1(\mu) :\equiv \El{p}{\mathsf{ap}(f_0)(\pi^\alpha_\mu)}^\circ(1_{f_0(\alpha.\mu)})
\end{align*}
Together with equations:
\begin{align}
f_0(\emptyset_p) &\equiv \emptyset_q \\
\El{p}{\mathsf{ap}(f_0)(s)}^+(f_1(\mu)) &\equiv f_1(\ApEl{p}{s}^+(\mu)) \\
\mathsf{ap}(f_1)(\eta_s(\mu)) &\equiv \eta_{\mathsf{ap}(f_0)(s)}(f_1(\mu)) \\
\mathsf{ap}(f_1)(\varepsilon_s(\mu)) &\equiv \varepsilon_{\mathsf{ap}(f_0)(s)}(f_1(\mu)) 
\end{align}
where $\eta_s$ and $\varepsilon_s$ are the unit and counit for the adjunction $\ApEl{p}{s}^\circ \dashv \ApEl{p}{s}^+$. 

The following desirable equations are already true, unwinding the definitions:
\begin{align*}
f_1(1_\alpha) &\equiv 1_{f_0(\alpha)} \\
f_0(\alpha.\mu) &\equiv f_0(\alpha).f_1(\mu) \\
\mathsf{ap}(f_0)(\pi^\alpha_\mu) &\equiv \pi^{f_0(\alpha)}_{f_1(\mu)} \\
\mathsf{ap}(f_1)(\mathsf{var}_\mu) &\equiv \mathsf{var}_{f_1(\mu)}
\end{align*}


\subsection{Profunctory Internal-Comprehension-Category Mode Theory}

The basic idea is that a type is a list of variable dependencies, with some information attached to each dependency saying how it relates to the previously specified dependencies in the same type.

We use an auxilliary judgement $\gamma \mid \beta \yields \sigma : \alpha$ that places the type $\beta$ in a place we can treat it as a minicontext: we have been calling these `substitutions' but I think I will call them renamings in what follows. These are renamings/variable-for-variables substitutions between the lists that constitute $\alpha$ and $\beta$.

Weakening and exchange in the context and weakening the minicontext should be straightforwardly admissible. Exchange in the minicontext should also be admissible (wherever it makes sense), and to properly match the semantics, we should probably be identifying such rearrangements.

\begin{mathpar}
  \inferrule*[]{~}
  {\gamma \yields \emptyset \type  } \and 
  \inferrule*[]{ \gamma \yields \beta \type \and \gamma \mid \beta \yields \sigma : \alpha \and (x : \alpha) \in \gamma}
  {\gamma \yields (\beta, i : x[\sigma]) \type  } \\

  \inferrule*[]{ \gamma \yields \beta \type}
  {\gamma \mid \beta \yields () : \emptyset  } \and
  \inferrule*[]{ \gamma \mid \beta \yields \sigma : \alpha \and  \gamma \mid \alpha \yields \tau : \delta \and (j : x[\tau[\sigma]]) \in \beta}
  {\gamma \mid \beta \yields (\sigma, j/i) : (\alpha, i : x[\tau])} \\
  
  \inferrule*[]{\gamma \mid \beta \yields \sigma : \alpha}
  {\gamma \yields (\beta \mid \sigma)
   : \alpha} \\
\end{mathpar}

Where $\tau[\sigma]$ is an admissible substitution rule for renamings, defined below.

\subsubsection{Substitution}

It will take a bit of work to show that substitution is admissible. A substitution $\alpha[(\beta \mid \sigma) / x_0]$ (roughly) expands out to calculating the `pushout' of two natural transformations between types in terms of cell gluing. (Although it looks like an operation on two maps \emph{into} $\alpha$ using the substitution notation.) Intuitively is gluing the list $\beta$ into $\alpha$ everywhere that $x_0$ is used, identifying things as specified by $\sigma$.

This is not too hard to do by hand in simple cases, here are some examples. To reduce the clutter we will denote the unique renaming into $\emptyset$ by $\cdot$, and when it is used to attach a dependency, omit entirely.

Working in the context $x : \emptyset, y : \emptyset, z : \emptyset$ we have things like:
\begin{align*}
(i : x)[(j : y, k : y \mid\, \cdot)/x] &= (j : y, k : y) \\
(i : x, m : z)[(j : y, k : y \mid\, \cdot)/x] &= (j : y, k : y, m : z)
\end{align*}
In context $x : \emptyset, y : \emptyset, z : (i : y)$ we can do:
\begin{align*}
(i : y, j : z[i/i])[(i_1 : x, i_2 : x \mid\, \cdot)/ y] = (i_1 : x, i_2 : x, j : z[i_1/i_1, i_2/i_2])
\end{align*}
as the type of $z$ is now $(i_1 : x, i_2 : x)$. And as an example of some actual gluing, take the context $x : \emptyset, y : (i : x), z : (i : x)$, we can do
\begin{align*}
(i : x, j : y[i/i])[(i : x k : z[i/i] \mid i/i ) / y] = (i : x, k : z[i/i])
\end{align*}

To prove substitution is admissible, the main steps would be:
\begin{enumerate}
\item Composition for renamings:
\begin{mathpar}
\inferrule*[]{\gamma \mid \beta \yields \sigma : \alpha \and \gamma \mid \delta \yields \tau : \beta}{\gamma \mid \delta \yields \sigma[\tau] : \alpha}
\end{mathpar}
\item An identity renaming: $\gamma \mid \alpha \yields \id : \alpha$.
\item A `pushout' operation: 
\begin{mathpar}
\inferrule*[]{\gamma \mid \beta \yields \sigma : \alpha \and \gamma \mid \beta' \yields \sigma' : \alpha}{\gamma \yields \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'}\type}
\end{mathpar}
with associated $\gamma \mid \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'} \yields \inl : \beta$ and $\gamma \mid \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'} \yields \inr : \beta'$, so that $\sigma[\inl] = \sigma'[\inr]$.
\item The following Lemma, which looks morally like a more complicated version of $\inl$, (to be proven simultaneously with substitution I suppose)
\begin{mathpar}
\inferrule*[]{\gamma, x_0 : \alpha_0 \mid \alpha \yields \tau : \alpha_0 \and (i : x_0[\tau]) \in \alpha \and \gamma \mid \beta \yields \sigma : \alpha_0}{\gamma \mid \alpha[(\beta \mid \sigma) / x_0] \yields \sigma' : \beta}
\end{mathpar}
such that $\sigma[\sigma'] = \tau[(\beta \mid \sigma)/x_0]$
\item Substitution itself, for types, terms, renamings.
\end{enumerate}

So here we go:

\begin{lemma}
Weakening and exchange are admissible for the minicontext in renamings.
\end{lemma}

\begin{lemma}
Renamings actually work: 
\begin{mathpar}
\inferrule*[]{(i : x[\sigma]) \in \alpha \and \gamma \mid \beta \yields \tau : \alpha}{(j : x[\sigma[\tau]]) \in \beta}
\end{mathpar}
\end{lemma}
\begin{proof}
Note that in the judgement $(i : x[\sigma]) \in \alpha$, the $\sigma$ is being implicitly weakened from some prefix of $\alpha$.
\end{proof}

\begin{lemma}
Composition for renamings is admissible, and this composition is associative.
\begin{mathpar}
\inferrule*[]{\gamma \mid \beta \yields \sigma : \alpha \and \gamma \mid \delta \yields \tau : \beta}{\gamma \mid \delta \yields \sigma[\tau] : \alpha}
\end{mathpar}
\end{lemma}
\begin{proof}
Induction on $\alpha$. When $\alpha = \emptyset$, we have the empty renaming $()$. 

If instead $\alpha = (\alpha', i : x[\theta])$, where $\gamma \mid \alpha' \yields \theta : \kappa$, we must have obtained $\gamma \mid \beta \yields \sigma : (\alpha', i : x[\theta])$ via the renaming-extension rule applied to $\gamma \mid \beta \yields \sigma' : \alpha'$ and $(j : x[\theta[\sigma']]) \in \beta$.

Now inductively we have $\gamma \mid \delta \yields \sigma'[\tau] : \alpha'$, and we reapply the renaming-extension rule with $(j : x[\theta [\sigma'][\tau]]) \in \delta$ (using associativity).

\mvrnote{todo associativity}
\end{proof}

\begin{lemma}
For any type there is an identity renaming $\gamma \mid \alpha \yields \id_\alpha : \alpha$, and $\sigma[\id] = \sigma = \id[\sigma]$.
\end{lemma}
\begin{proof}
When $\alpha = \emptyset$, use the empty renaming.

When $\alpha = (\alpha', i : x[\tau])$, inductively form $\id_{\alpha'}$, weaken the minicontext with $i : x[\tau]$, and apply the renaming-extension rule with $(i : x[\tau[\id_{\alpha'}]]) \in (\alpha', i : x[\tau]) $

\mvrnote{todo the properties}
\end{proof}

\begin{lemma}
Given $(i : x[\tau]) \in \alpha$ and $(i' : x[\tau]) \in \alpha$, there is a type $\alpha_{i=i'}$ where the two variables have been identified. This comes with a renaming $\gamma \mid \alpha_{i=i'} \yields \nabla_{i=i'} : \alpha$, and if $\gamma \mid \beta \yields \sigma : \alpha$ identifies $i$ and $i'$, then it factors through $\nabla_{i=i'}$, let us write this factorisation $\sigma = \nabla_{i=i'}[\sigma_{i=i'}]$.
\end{lemma}
\begin{proof}
Without loss of generality $\alpha$ is of the form $\alpha = (\alpha_1, i : x[\tau], \alpha_2, i' : x[\tau], \alpha_3)$. Set 
\begin{align*}
\alpha_{i=i'} &:= (\alpha_1, i : x[\tau], \alpha_2, \alpha_3[i/i']) \\
\nabla_{i=i'} &:= [\alpha_1/\alpha_1, i / i, \alpha_2/\alpha_2, i / i', \alpha_3/\alpha_3]
\end{align*}

\mvrnote{The factorisation thing seems clear to me but annoying to write down}
\end{proof}

\begin{lemma}
We can construct pushouts of renamings:
\begin{mathpar}
\inferrule*[]{\gamma \mid \beta \yields \sigma : \alpha \and \gamma \mid \beta' \yields \sigma' : \alpha}{\gamma \yields \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'}\type}
\end{mathpar}
with associated $\gamma \mid \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'} \yields \inl : \beta$ and $\gamma \mid \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'} \yields \inr : \beta'$, so that $\sigma[\inl] = \sigma'[\inr]$.
\end{lemma}
\begin{proof}
Again induction on $\alpha$. If $\alpha = \emptyset$, then we must have $\sigma = \tau = ()$. We define $\Pushout{\beta}{\emptyset}{\beta'}{()}{()}$ to be just $\beta$ and $\beta'$ concatenated. There are evident $\inl$ and $\inr$ renamings that pick out the $\beta$ or $\beta'$ part, and $\sigma[\inl] = \sigma'[\inr]$ is vacuously true as these are renamings into $\emptyset$.

For the inductive case, suppose:
\begin{align*}
\alpha &= (\alpha, i : x[\tau]) \\
\sigma &= (\sigma, j/i) && \text{where } (j : x [\tau[\sigma]]) \in \beta \\
\sigma' &= (\sigma', j'/i) && \text{where } (j' : x [\tau[\sigma']]) \in \beta'
\end{align*}
Inductively we have $\Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'}$ and the corresponding $\inl/\inr$. Pushing $j$ and $j'$ forward along $\inl$ and $\inr$, and using associativity of renamings, we have 
\begin{align*}
(j[\inl] : x[\tau[\sigma[\inl]]]) &\in \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'} \\
(j'[\inr] : x[\tau[\sigma'[\inr]]]) &\in \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'}
\end{align*}
Because $\sigma[\inl] = \sigma'[\inr]$, these variables are a pair that can be identified, and so we do:
\begin{align*}
\Pushout{\beta}{(\alpha, i : x[\tau])}{\beta'}{(\sigma, j/i)}{(\sigma', j'/i)} := (\Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'})_{j[\inl] = j'[\inr]}
\end{align*}

Now to define $\inl$, we compose the inductively given $\gamma \mid \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'} \yields \inl : \beta$ with the contraction substitution $\gamma \mid (\Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'})_{j[\inl] = j'[\inr]} \yields \nabla : \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'}$. Define $\inr$ similarly.

Checking the equation amounts to verifying $\sigma[\inl[\nabla]] = \sigma'[\inr[\nabla]]$, but this is clear by associativity and the inductive hypothesis.
\end{proof}

\begin{lemma}
Universal property for pushout, i.e.:
\begin{mathpar}
\inferrule*[]{\gamma \mid \beta \yields \sigma : \alpha \and \gamma \mid \beta' \yields \sigma' : \alpha \\\\ 
\gamma \mid \delta \yields \theta : \beta \and \gamma \mid \delta \yields \theta' : \beta' \\\\ 
\sigma[\theta] = \sigma'[\theta']}
{\gamma \mid \delta \yields \case^{\sigma, \sigma'}_\alpha(\theta, \theta') : \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'}}
\end{mathpar}
\end{lemma}
\begin{proof}
If $\alpha = \emptyset$, then the pushout is $(\beta, \beta')$, and we have the renaming $\gamma \mid \delta \yields (\theta / \beta, \theta' / \beta') : (\beta, \beta')$.

If $\alpha = (\alpha, i : x[\tau])$, we inductively have $\case(\theta, \theta') : \Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'}$. To get the renaming into $(\Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'})_{j[\inl] = j'[\inr]}$, we just have to show that $\case(\theta, \theta')$ identifies $j[\inl]$ and $j'[\inr]$. This follows from the equation $\sigma[\theta] = \sigma'[\theta']$, as $j$ and $j'$ are $i$ pushed forward along $\sigma$ and $\sigma'$. \mvrnote{This is sketchy}. We then have an induced renaming $\case(\theta, \theta')_{j[\inl] = j'[\inr]}$.

Note: it appears we only need existence, not uniqueness.
\end{proof}

The following three lemmas all refer to each other so will be proven by mutual induction. In what follows, if $\gamma \yields \mu : \alpha$ is a term, let $\gamma \mid \bar \mu \yields \mu : \alpha$ be its underlying renaming.

\begin{lemma}\label{inl-sub}
$\inr$ for substitution:
\begin{mathpar}
\inferrule*[]{\gamma, x_0 : \alpha_0, \gamma' \mid \alpha \yields \tau : \alpha_0 \and (i_0 : x_0[\tau]) \in \alpha \and \gamma \yields \mu_0 : \alpha_0}{\gamma, \gamma'[\mu_0 / x_0] \mid \alpha[\mu_0 / x_0] \yields \ini_{i_0 \in \alpha}(\mu_0) : \bar \mu_0}
\end{mathpar}
such that $\mu_0[\ini_{i_0}(\mu_0)] = \tau[\mu_0/x_0]$
\end{lemma}
\begin{proof}

Note that because $\tau$ is a substitution for $\alpha_0$, and $x_0$ is not used in $\alpha_0$, $\tau$ can't use any variable in $x_0 : \alpha_0, \gamma'$. This premise could be replaced by something like $\gamma \mid \alpha' \yields \tau : \alpha_0$ where $\alpha'$ the subset of $\alpha$ only containing variables from $\gamma$.

Induction on $\alpha$. We cannot have $\alpha = \emptyset$, as we have assumed $(i_0 : x_0[\tau]) \in \alpha$.

If $\alpha = (\alpha, i : x[\tau])$ with $i \neq i_0$, then $i_0$ must appear earlier in $\alpha$ somewhere and inductively we know $\gamma, \gamma'[\mu_0 / x_0] \mid \alpha[\mu_0 / x_0] \yields \ini_{i_0 \in \alpha}(\mu_0) : \bar \mu_0$, and we can just weaken the minicontext to $(\alpha[\mu_0 / x_0], i : x[\tau[\mu_0 / x_0]])$. Inductively the equation holds, and weakening doesn't change this.

If instead $\alpha = (\alpha, i_0 : x[\tau])$, then by definition $(\alpha, i_0 : x[\tau])[\mu_0/x_0] = \Pushout{\alpha[\mu_0/x_0]}{\alpha_0}{\bar \mu_0}{\tau[\mu_0/x_0]}{\mu_0}$ and we can use $\inr$. \mvrnote{todo equation}
\end{proof}

\begin{lemma}
Substitution into types:
\begin{mathpar}
\inferrule*[]{\gamma, x_0 : \alpha_0, \gamma' \yields \beta \type \and \gamma \yields \mu_0 : \alpha_0}{\gamma, \gamma'[\mu_0/x_0] \yields \beta[\mu_0/x_0] \type}
\end{mathpar}
\end{lemma}
\begin{proof}
Induction on $\beta$. If $\beta = \emptyset$ there is nothing to do. \mvrnote{except deal with $\gamma'$}

If $\beta = (\beta, i : x[\sigma])$ for $x \neq x_0$, by the inductive step we have $\gamma, \gamma'[\mu_0/x_0] \yields \beta[\mu_0/x_0] \type$. We can then find $(x : \alpha[\mu_0/x_0]) \in \gamma, \gamma'[\mu_0/x_0]$ and reapply the rule.

If $\beta = (\beta, i : x_0[\sigma])$, then $\sigma$ here is $\gamma, x_0 : \alpha_0, \gamma'\mid \beta \yields \sigma : \alpha_0$. Again we inductively have $\gamma, \gamma'[\mu_0/x_0] \yields \beta[\mu_0/x_0] \type$ and $\gamma, \gamma'[\mu_0/x_0] \mid \beta[\mu_0/x_0] \yields \sigma[\mu_0/x_0] : \alpha_0[\mu_0/x_0]$. Note here that $\alpha_0[\mu_0/x_0] = \alpha_0$ because $x_0$ does not occur in $\alpha_0$. 

We then form the pushout of this $\sigma[\mu_0/x_0]$ along the renaming underlying $\mu_0$, yielding the type \[\Pushout{\beta[\mu_0/x_0]}{\alpha_0}{\bar \mu_0}{\sigma[\mu_0/x_0]}{\mu_0}\] as our answer.
\end{proof}

\begin{lemma}
Substitution into renamings:
\begin{mathpar}
\inferrule*[]{\gamma, x_0 : \alpha_0, \gamma' \mid \beta \yields \sigma : \alpha \and \gamma \yields \mu_0 : \alpha_0}{\gamma, \gamma'[\mu_0/x_0] \mid \beta[\mu_0/x_0] \yields \sigma[\mu_0/x_0] : \alpha[\mu_0/x_0]}
\end{mathpar}
\end{lemma}
\begin{proof}
Induction on $\sigma$. If $\sigma$ is the empty renaming there is nothing to do.

So suppose we have just applied the renaming-extension rule to get $\gamma, x_0 : \alpha_0, \gamma' \mid \beta \yields (\sigma, j/i) : (\alpha, i : x[\tau])$, where $(j : x[\tau[\sigma]]) \in \beta$. Inductively we have $\gamma, \gamma'[\mu_0/x_0] \mid \beta[\mu_0/x_0] \yields \sigma[\mu_0/x_0] : \alpha[\mu_0/x_0]$. 

Again there are two cases. If $x \neq x_0$, we can reapply the rule with $(j : x[\tau[\mu_0/x_0][\sigma[\mu_0/x_0]]]) \in \beta[\mu_0/x_0]$. (Here we have to use an interchange rule for renamings and substitution: $\tau[\mu_0/x_0][\sigma[\mu_0/x_0]]] = \tau[\sigma][\mu_0/x_0]$)

If $x = x_0$, our goal is a renaming into $(\alpha, i : x_0[\tau])[\mu_0/x_0]$, which is $\Pushout{\alpha[\mu_0/x_0]}{\alpha_0}{\bar \mu_0}{\tau[\mu_0/x_0]}{\mu_0}$. For this we use the universal property of pushouts, applied to the following diagram (where confusingly the arrows go the opposite direction of renamings):
\[
\begin{tikzcd}
\alpha_0 \ar[r, "{\tau[\mu_0/x_0]}"] \ar[d, "\mu_0" swap] & \alpha[\mu_0/x_0] \ar[d] \ar[ddr, bend left, "{\sigma[\mu_0/x_0]}"] & \\
\bar \mu_0 \ar[r] \ar[drr, bend right, "\ini_j(\mu_0)" swap]& \Pushout{\alpha[\mu_0/x_0]}{\alpha_0}{\bar \mu_0}{\tau[\mu_0/x_0]}{\mu_0} \ar[dr, dashed] & \\
& & \beta[\mu_0/x_0]
\end{tikzcd}
\]
\end{proof}

In summary:
\begin{align*}
\Pushout{\beta}{\emptyset}{\beta'}{()}{()} &:= (\beta, \beta') \\
\Pushout{\beta}{(\alpha, i : x[\tau])}{\beta'}{(\sigma, j/i)}{(\sigma, j'/i)} &:= (\Pushout{\beta}{\alpha}{\beta'}{\sigma}{\sigma'})_{j[\inl] = j'[\inr]} \\
\inl^{(), ()}_\emptyset(\beta, \beta') &:= [\beta/\beta] \\
\inl^{(\sigma, j/i), (\sigma', j'/i)}_{(\alpha, i:x[\tau])} (\beta, \beta') &:= \inl^{\sigma, \sigma'}_\alpha (\beta, \beta') [\nabla_{j, j'}] \\
\inr^{(), ()}_\emptyset(\beta, \beta') &:= [\beta'/\beta'] \\
\inr^{(\sigma, j/i), (\sigma', j'/i)}_{(\alpha, i:x[\tau])} (\beta, \beta') &:= \inr^{\sigma, \sigma'}_\alpha (\beta, \beta') [\nabla_{j, j'}] \\
\case^{(),()}_\emptyset(\theta, \theta') &:= (\theta / \beta, \theta' / \beta') \\
\case^{(\sigma,j/i),(\sigma', j'/i)}_{(\alpha,i:x[\tau])}(\theta, \theta') &:= \case^{\sigma, \sigma'}_{\alpha}(\theta, \theta')_{j[\inl]=j'[\inr]} \\
\ini_{i_0 \in (\alpha, i : x[\sigma])}(\mu_0) &:= \ini_{i_0 \in \alpha}(\mu_0)\\
\ini_{i_0 \in (\alpha, i_0 : x[\sigma])}(\mu_0) &:= \inr^{\sigma[\mu_0/x_0],\mu_0}_{\alpha_0}(\alpha[\mu_0/x_0], \bar \mu_0) \\
\\
\emptyset[\mu_0/x_0] &:= \emptyset \\
(\beta, i : x[\sigma])[\mu_0/x_0] &:= (\beta[\mu_0/x_0], i : x[\sigma[\mu_0/x_0]]) \\
(\beta, i : x_0[\sigma])[\mu_0/x_0] &:= \Pushout{\beta[\mu_0/x_0]}{\alpha_0}{\bar \mu_0}{\sigma[\mu_0/x_0]}{\mu_0} \\
\\
()[\mu_0/x_0] &:= () \\
(\sigma, j/i)[\mu_0/x_0] &:= (\sigma[\mu_0/x_0], j[\mu_0/x_0]/i) && \text{where } (j : x[\tau[\sigma]]) \in \beta, x \neq x_0 \\
(\sigma, j/i)[\mu_0/x_0] &:= \case(\sigma[\mu_0/x_0], \ini_j(\mu_0)) && \text{where } (j : x_0[\tau[\sigma]]) \in \beta \\
\\
\end{align*}

\subsubsection{The Variable Rule}
This isn't built in, but we can define it:
\begin{lemma}
Variable rule:
\begin{mathpar}
\inferrule*[]{~}{\gamma, x : \alpha, \gamma' \yields x : \alpha}
\end{mathpar}
\end{lemma}
\begin{proof}
This term is built as a renaming into $\alpha$. For this use \[\gamma, x : \alpha, \gamma' \mid \alpha, i : x[\alpha/\alpha]\yields (\alpha/\alpha) : \alpha\]
\end{proof}
Note that this is a projection, so whatever term rule we have must allow projections.

\subsubsection{Defining $\TrPlus{s}{-}$ and $\TrCirc{s}{-}$}
Continue to use the convention that $\bar \mu$ denotes the type underlying a term $\mu : \alpha$. As suggested by their names, type 2-cells $\TypeTwo{\gamma}{s}{\alpha}{\beta}$ act in the mode theory as follows:
\begin{lemma}
\begin{mathpar}
\inferrule*
    {\gamma \yields \mu : \beta \\
     \TypeTwo{\gamma}{s}{\alpha}{\beta}
    }
    {\gamma \yields \TrPlus{s}{\mu} : \alpha}

\inferrule*
    {\gamma \yields \mu : \alpha \\
     \TypeTwo{\gamma}{s}{\alpha}{\beta}
    }
    {\gamma \yields \TrCirc{s}{\mu} : \beta}
\end{mathpar}
\end{lemma}
\begin{proof}
For $s^+$, construct the pushout $\Pushout{\bar \mu}{\beta}{\alpha}{\mu}{s}$. The renaming $\gamma \mid \Pushout{\bar \mu}{\beta}{\alpha}{\mu}{s} \yields \inr : \alpha$ is the desired term. 

For $s^\circ$, we compose the renaming $s$ with $\mu$, so: $\gamma \mid \bar \mu \yields s[\mu] : \beta$.
\end{proof}

And we build the unit and counit:
\begin{lemma}
\begin{mathpar}
\inferrule*
    {\TypeTwo{\gamma}{s}{\alpha}{\beta} \and (x : \beta \in \gamma)
    }
    {\TermTwo{\gamma}{\varepsilon}{\TrCirc{s}{\TrPlus{s}{x}}}{x}}

\inferrule*
    {\TypeTwo{\gamma}{s}{\alpha}{\beta} \and (y : \alpha \in \gamma)
    }
    {\TermTwo{\gamma}{\eta}{y}{\TrPlus{s}{\TrCirc{s}{y}}}}
\end{mathpar}
\end{lemma}
\begin{proof}
The counit is the upper right triangle in the following pushout diagram (written in natural transformation direction):
\[
\begin{tikzcd}[column sep={2cm,between origins},row sep={2cm,between origins}]
\beta \ar[r, "x"] \ar[d, "s" swap]  \ar[dr, "\TrCirc{s}{\TrPlus{s}{x}}" near start] & \bar x \ar[d, "\inl"] \\
\alpha \ar[r, "\TrPlus{s}{x}" swap] & \overline{\TrPlus{s}{x}} \\
\end{tikzcd}
\]

The unit is the triangle on the right:
\[
\begin{tikzcd}
\beta \ar[d, "s" swap] \ar[r, "s"]& \alpha \ar[dd, "\TrPlus{s}{\TrCirc{s}{x}}"] \ar[dddr, bend left = 40, "x"] &  \\
\alpha \ar[d, "x" swap] & & \\
\bar x \ar[r, "\inl" swap]  \ar[drr, "\id" swap, bend right] & \overline{\TrPlus{s}{\TrCirc{s}{x}}} \ar[dr, dashed]& \\
& & \bar x
\end{tikzcd}
\]
\end{proof}

\subsubsection{$\Sigma$ and $\Pi$}

$\Sigma$ ought to be the $F$ type for \[\gamma, x : \alpha, y : (\alpha, i : x[\id_\alpha]) \yields (\alpha, i : x[\id_\alpha], j : y[\id_{(\alpha, x)}] \mid \alpha / \alpha) : \alpha\]

Let's call this $\sigma_x(y)$, or something. As a sanity check, we can test this with a simple case of $F$-left.
\begin{mathpar}
\inferrule*[Left=F-left]{\Gamma, x : A, y : B(x) \yields_{\id_{(\alpha, z)}[\sigma_x(y)/z]} c[\FI{x,y}/z] : C[\FI{x,y}/z]}{\Gamma, z : F_{\sigma_x(y)}(x:A, y : B(x)) \yields_{\id_{(\alpha, z)}} c : C}
\end{mathpar}
And presumably $\id_{(\alpha, z)}[\sigma_x(y)/z] = \id_{(\alpha, x, y)}$, as the pushout would identify $x$ and $y$'s dependence on an $\alpha$ with the existing $\alpha$ in $(\alpha, z)$.

And the $F$-intro rule 
\begin{mathpar}
\inferrule*[Left=F-right$^*$]{~}{\Gamma, x : A, y: B(x) \yields_{\sigma_x(y)} \mathsf{pair}(x,y) : F_{\sigma_x(y)}(x:A, y : B(x))}
\end{mathpar}
could be read as saying that the term $\mathsf{pair}(x,y) := \FI{x,y}$ uses exactly what the type $A$ does, plus one usage of $x$ and one usage of $y$.

$\Pi$ ought to be the $U$ type for \[\gamma, x : \alpha, y : \alpha \yields (\alpha, i : x[\id_\alpha], j : y[\id_{\alpha}] \mid \alpha / \alpha, i / i) : (\alpha, i : x[\id_\alpha])\]
If we call this $\pi_x(y)$, we can try the $U$-right rule in a simple case:
\begin{mathpar}
  \inferrule*[Left = U-right]{\Gamma, x : A \yields_{\pi_x(y)[(\alpha \mid \id_\alpha) / y]} N : B}
  {\Gamma \yields_{(\alpha \mid \id_\alpha)} \UI x N : U_{y.\pi_x(y)}(A \vert B)} \\
\end{mathpar}
And then $\pi_x(y)[(\id_\alpha\vert \alpha)/y] = (\alpha, i : x[\id_\alpha] \mid \id) : (\alpha, i : x[\id_\alpha])$, as the $\alpha$ from the $y$ has been glued to the existing one.

\subsubsection{Structurality}

We can change what structural rules are available by changing which renamings we are permitted to promote to 2-cells.

\begin{enumerate}
\item The term rule controls how the dependencies of a term relate to the dependencies of its type. By construction, the dependencies of a term bound the dependencies of the type, but we could restrict this further: Allowing only `relevant' renamings here would say that terms can't use variables that their types didn't.

We could choose to not consider types `up to ordering', so that the order of dependencies mattes. Then, allowing only identity renamings in the term rule would demand that terms have have the same dependencies as their types, in the same order. (Whatever this means!)

\item The type 2-cells control the structural rules in the types
\item The term 2-cells control the structural rules in the terms
\end{enumerate}

E.g., for full structurality, we would use:

\begin{mathpar}
  \inferrule*[]{\gamma \mid \beta \yields \sigma : \alpha}
  {\TypeTwo{\gamma}{\sigma}{\beta}{\alpha}}  \and   \inferrule*[]{\gamma \mid \beta \yields \sigma : \alpha \and \gamma \mid \beta' \yields \tau : \beta}
  {
  \TermTwo{\gamma}{s}{(\beta \mid \sigma)}{(\beta' \mid \sigma[\tau])}}
\end{mathpar}

These choices cannot be totally arbitrary: 
\begin{enumerate}
\item The variable rule requires that the term rule at least permits projections. Also, we need a type 2-cell $\TypeTwo{\gamma}{s}{\alpha} {\beta}$ to act on terms via $\TrCirc{s}{-}$ and $\TrPlus{s}{-}$. This means, terms must be closed under composition with and pushout along type 2-cells.
\item We need term 2-cells $\TermTwo{\gamma}{s}{\mu}{\mu'}$ to induce type 2-cells via substitution: $\TypeTwo{\gamma}{s}{\alpha[\mu/x]}{\alpha[\mu'/x]}$. \mvrnote{What exactly is required for this? Enough that term 2-cells are included in type 2-cells?}
\item For each type 2-cell $\TypeTwo{\gamma}{s}{\alpha} {\beta}$, the corresponding unit and counit term 2-cells must exist.
\end{enumerate}

As an example, it appears these choices could allow a type system where the types behave fully structurally and the terms behave linearly, but not vis versa.

\subsection{Modal Type Theories}
\newcommand{\Modes}{\mathcal{M}}

Now let's try to match the idea where we have a small 2-category $\Modes$, and we want a dependent type theory that uses $\Modes$ as the modes. It seems that we want to annotate
\begin{itemize}
\item Types with a mode $p \in \ob \Modes$ so $\gamma \yields \alpha \type_p$
\item Dependencies in a type with a morphism $f : p \to q$, so $\gamma \mid \beta \yields_f \sigma : \alpha$.
\item Variable usages in a renaming with a 2-cell $s : f \Rightarrow g$.
\end{itemize}

A first naive attempt, that doesn't work, is:

\begin{mathpar}
  \inferrule*[]{p \in \ob \Modes}
  {\gamma \yields \emptyset_p \type_p  } \and 
  \inferrule*[]{ \gamma \yields \beta \type_p \and \gamma \yields \alpha \type_q \and f : p \to q \in \Modes \and \gamma \mid \beta \yields_f \sigma : \alpha \and (x : \alpha) \in \gamma }
  {\gamma \yields (\beta, i : x_f[\sigma]) \type_p  } \\

  \inferrule*[]{ \gamma \yields \beta \type_p \and f : p \to q \in \Modes}
  {\gamma \mid \beta \yields_f () : \emptyset_q  } \and
  \inferrule*[]{ \gamma \mid \beta \yields_f \sigma : \alpha \and  \gamma \mid \alpha \yields_g \tau : \delta \and (j : x_h[\tau[\sigma]]) \in \beta \and s : gf \Rightarrow h \in \Modes}
  {\gamma \mid \beta \yields_f (\sigma, j_s/i) : (\alpha, i : x_g[\tau])} \\
\end{mathpar}
But above, saying $x_h[\tau[\sigma]]$ doesn't make sense, as presumably $\tau[\sigma]$ is a renaming that is mapped to $gf$. I think we may need an inductively defined way to extend the $s : f \Rightarrow g$ 2-cells in $\Modes$ to a kind of 2-cell between renamings. 

\subsection{Bunchy Type Theories}

\bibliographystyle{abbrv}
\bibliography{../cs.bib}

\end{document}

